openapi: 3.0.3
info:
  title: PhytoOracle API
  version: 1.0.0
  description: |
    花卉疾病诊断系统API

    ## 功能概述
    - 基于视觉大模型（VLM）的疾病诊断
    - 知识库管理与查询
    - 诊断历史追踪
    - 管理后台认证

    ## 诊断流程
    1. 上传花卉图片（JPG/PNG/HEIC格式）
    2. 系统通过VLM提取特征（Q0-Q6问诊序列）
    3. 匹配知识库进行诊断（三层渐进诊断）
    4. 返回确诊/疑似/未知结果

  contact:
    name: PhytoOracle Team
    email: support@phytooracle.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000/api/v1
    description: 开发环境
  - url: https://api.phytooracle.com/api/v1
    description: 生产环境

tags:
  - name: Diagnosis
    description: 疾病诊断相关接口
  - name: Knowledge
    description: 知识库查询接口
  - name: Admin
    description: 管理后台接口
  - name: Auth
    description: 认证授权接口

paths:
  /diagnose:
    post:
      summary: 执行疾病诊断
      description: |
        上传花卉图片进行疾病诊断。系统通过VLM提取特征并匹配知识库。

        **支持的花卉种属**：
        - Rosa（玫瑰/月季）
        - Prunus（樱花/李属）
        - Tulipa（郁金香）
        - Dianthus（康乃馨）
        - Paeonia（牡丹）

        **诊断结果类型**：
        - confirmed（确诊）：置信度 ≥ 0.85
        - suspected（疑似）：置信度 0.60-0.85，返回Top 2-3候选疾病
        - unlikely（未知）：置信度 < 0.60，VLM兜底描述

      operationId: diagnose
      tags:
        - Diagnosis
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - image
              properties:
                image:
                  type: string
                  format: binary
                  description: 图片文件（支持JPG/PNG/HEIC格式，最大10MB）
                flower_genus:
                  type: string
                  description: 花卉种属（可选，提供后可提高诊断准确率）
                  enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
                  example: Rosa
      responses:
        '200':
          description: 诊断成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosisResponse'
              example:
                diagnosis_id: "diag_20250111_001"
                timestamp: "2025-01-11T14:30:00Z"
                status: "confirmed"
                confirmed_disease:
                  disease_id: "rose_black_spot"
                  disease_name: "玫瑰黑斑病"
                  common_name_en: "Black Spot"
                  pathogen: "Diplocarpon rosae"
                  confidence: 0.92
                feature_vector:
                  content_type: "plant"
                  plant_category: "flower"
                  flower_genus: "Rosa"
                  organ: "leaf"
                  completeness: "intact"
                  has_abnormality: "yes"
                  symptom_type: "spot"
                  colors: ["black", "brown"]
                  location: "leaf_surface"
                  size: "medium"
                  distribution: "scattered"
                scores:
                  total_score: 92
                  major_features: {"spot_color": 30, "spot_shape": 25}
                  minor_features: {"leaf_yellowing": 15}
                  optional_features: {"stem_affected": 5}
                reasoning:
                  - "检测到叶片表面黑色斑点（主要特征匹配）"
                  - "斑点呈圆形，边缘清晰（形态匹配）"
                  - "叶片周围伴有轻微黄化（次要特征）"
                vlm_provider: "qwen_vl"
                execution_time_ms: 2340
        '400':
          description: 请求错误（图片格式不支持、文件过大、参数错误等）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "invalid_image_format"
                detail: "图片格式不支持，仅支持JPG/PNG/HEIC格式"
                timestamp: "2025-01-11T14:30:00Z"
        '401':
          description: 未授权（API Key无效或缺失）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "unauthorized"
                detail: "API Key无效或已过期"
                timestamp: "2025-01-11T14:30:00Z"
        '500':
          description: 服务器错误（VLM调用失败、知识库加载失败等）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "vlm_service_error"
                detail: "VLM服务暂时不可用，请稍后重试"
                timestamp: "2025-01-11T14:30:00Z"

  /diseases:
    get:
      summary: 获取疾病列表
      description: |
        查询知识库中的疾病信息。可按花卉种属过滤。

        **当前支持的疾病数量**：18-24种
        - Rosa：4-6种疾病
        - Prunus：3-5种疾病
        - Tulipa：3-5种疾病
        - Dianthus：3-4种疾病
        - Paeonia：3-4种疾病

      operationId: listDiseases
      tags:
        - Knowledge
      parameters:
        - name: genus
          in: query
          required: false
          schema:
            type: string
            enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
          description: 按花卉属过滤疾病列表
          example: Rosa
        - name: pathogen_type
          in: query
          required: false
          schema:
            type: string
            enum: [fungal, bacterial, viral, pest]
          description: 按病原体类型过滤（真菌/细菌/病毒/虫害）
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
          description: 返回结果数量限制
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          description: 分页偏移量
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: 总疾病数量
                  diseases:
                    type: array
                    items:
                      $ref: '#/components/schemas/Disease'
              example:
                total: 5
                diseases:
                  - disease_id: "rose_black_spot"
                    disease_name: "玫瑰黑斑病"
                    common_name_en: "Black Spot"
                    pathogen: "Diplocarpon rosae"
                    pathogen_type: "fungal"
                    affected_plants: ["Rosa"]
                    typical_symptoms:
                      - "叶片出现黑色圆形斑点"
                      - "斑点周围伴有黄化"
                      - "严重时叶片脱落"
                  - disease_id: "rose_powdery_mildew"
                    disease_name: "玫瑰白粉病"
                    common_name_en: "Powdery Mildew"
                    pathogen: "Podosphaera pannosa"
                    pathogen_type: "fungal"
                    affected_plants: ["Rosa"]
                    typical_symptoms:
                      - "叶片、茎秆出现白色粉状物"
                      - "叶片卷曲变形"
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /admin/reload:
    post:
      summary: 重载知识库
      description: |
        重新加载知识库数据（疾病本体、特征向量、鉴别规则）。

        **触发时机**：
        - 管理员通过Streamlit后台添加新疾病
        - 知识库文件更新后需要热加载
        - 系统启动时自动调用

        **注意事项**：
        - 重载期间（约1-3秒）诊断服务不可用
        - 重载失败会保留旧版本知识库

      operationId: reloadKnowledge
      tags:
        - Admin
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: 重载成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - message
                  - version
                  - disease_count
                  - reload_time_ms
                properties:
                  message:
                    type: string
                    description: 成功消息
                    example: "知识库重载成功"
                  version:
                    type: string
                    description: 知识库版本号（时间戳）
                    example: "v20250111_143000"
                  disease_count:
                    type: integer
                    description: 加载的疾病数量
                    example: 22
                  genus_coverage:
                    type: array
                    description: 覆盖的花卉种属列表
                    items:
                      type: string
                    example: ["Rosa", "Prunus", "Tulipa", "Dianthus", "Paeonia"]
                  reload_time_ms:
                    type: integer
                    description: 重载耗时（毫秒）
                    example: 1250
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 重载失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "knowledge_base_load_error"
                detail: "知识库文件损坏或格式错误，已回滚到旧版本"
                timestamp: "2025-01-11T14:30:00Z"

  /auth/login:
    post:
      summary: 管理员登录
      description: |
        管理后台登录认证，返回JWT Token。

        **默认管理员账户**：
        - 用户名：admin
        - 密码：通过环境变量配置（ADMIN_PASSWORD）

        **Token有效期**：24小时

      operationId: login
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  description: 管理员用户名
                  example: "admin"
                password:
                  type: string
                  format: password
                  description: 管理员密码
                  example: "your_secure_password"
      responses:
        '200':
          description: 登录成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - access_token
                  - token_type
                  - expires_in
                properties:
                  access_token:
                    type: string
                    description: JWT访问令牌
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  token_type:
                    type: string
                    description: 令牌类型（固定为bearer）
                    default: "bearer"
                    example: "bearer"
                  expires_in:
                    type: integer
                    description: 令牌过期时间（秒）
                    example: 86400
                  user_info:
                    type: object
                    description: 用户基本信息
                    properties:
                      username:
                        type: string
                        example: "admin"
                      role:
                        type: string
                        example: "administrator"
        '401':
          description: 认证失败（用户名或密码错误）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "authentication_failed"
                detail: "用户名或密码错误"
                timestamp: "2025-01-11T14:30:00Z"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /history:
    get:
      summary: 查询诊断历史
      description: |
        查询历史诊断记录，支持多维度筛选。

        **数据存储**：
        - 诊断记录存储在PostgreSQL（结构化数据）
        - 图片存储在本地文件系统（backend/storage/images/）
        - 数据保留周期：1年

      operationId: getDiagnosisHistory
      tags:
        - Diagnosis
      security:
        - ApiKeyAuth: []
      parameters:
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: 起始日期（ISO 8601格式）
          example: "2025-01-01"
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: 结束日期（ISO 8601格式）
          example: "2025-01-31"
        - name: plant_genus
          in: query
          required: false
          schema:
            type: string
            enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
          description: 按花卉种属过滤
        - name: confidence_level
          in: query
          required: false
          schema:
            type: string
            enum: [confirmed, suspected, unlikely]
          description: 按置信度级别过滤
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: 返回结果数量限制
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          description: 分页偏移量
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: 符合条件的总记录数
                  records:
                    type: array
                    items:
                      $ref: '#/components/schemas/DiagnosisHistory'
              example:
                total: 150
                records:
                  - diagnosis_id: "diag_20250111_001"
                    timestamp: "2025-01-11T14:30:00Z"
                    plant_genus: "Rosa"
                    status: "confirmed"
                    disease_name: "玫瑰黑斑病"
                    confidence: 0.92
                    image_url: "/storage/images/unlabeled/diag_20250111_001.jpg"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /diagnose/batch:
    post:
      summary: 批量诊断
      description: |
        批量上传多张花卉图片进行疾病诊断。

        **限制**：
        - 单次最多上传20张图片
        - 每张图片不超过10MB
        - 支持JPG/PNG/HEIC格式

        **处理方式**：
        - 异步处理，返回batch_id用于查询进度
        - 使用WebSocket或轮询方式获取实时进度

      operationId: diagnoseBatch
      tags:
        - Diagnosis
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - images
              properties:
                images:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: 图片文件数组（最多20张）
                  minItems: 1
                  maxItems: 20
                flower_genus:
                  type: string
                  description: 花卉种属（可选，提供后可提高诊断准确率）
                  enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
                  example: Rosa
      responses:
        '200':
          description: 批量诊断任务创建成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - batch_id
                  - timestamp
                  - total
                  - status
                properties:
                  batch_id:
                    type: string
                    description: 批量诊断任务ID
                    example: "batch_20250116_001"
                  timestamp:
                    type: string
                    format: date-time
                    description: 任务创建时间
                    example: "2025-01-16T10:00:00Z"
                  total:
                    type: integer
                    description: 待诊断图片总数
                    example: 10
                  completed:
                    type: integer
                    description: 已完成诊断数量
                    example: 0
                  status:
                    type: string
                    enum: [pending, processing, completed, failed]
                    description: 批量任务状态
                    example: "processing"
                  results:
                    type: array
                    description: 已完成的诊断结果列表
                    items:
                      $ref: '#/components/schemas/DiagnosisResponse'
              example:
                batch_id: "batch_20250116_001"
                timestamp: "2025-01-16T10:00:00Z"
                total: 10
                completed: 0
                status: "processing"
                results: []
        '400':
          description: 请求错误（图片数量超限、格式不支持等）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "too_many_images"
                detail: "单次批量诊断最多支持20张图片"
                timestamp: "2025-01-16T10:00:00Z"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /diagnosis/result/{diagnosisId}:
    get:
      summary: 获取诊断结果详情
      description: |
        通过诊断ID查询单次诊断的详细结果。

      operationId: getDiagnosisResult
      tags:
        - Diagnosis
      parameters:
        - name: diagnosisId
          in: path
          required: true
          schema:
            type: string
          description: 诊断ID
          example: "diag_20250111_001"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosisResponse'
        '404':
          description: 诊断记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "diagnosis_not_found"
                detail: "未找到指定的诊断记录"
                timestamp: "2025-01-16T10:00:00Z"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /diseases/{diseaseId}:
    get:
      summary: 获取单个疾病详情
      description: |
        通过疾病ID查询该疾病的详细信息。

      operationId: getDiseaseDetail
      tags:
        - Knowledge
      parameters:
        - name: diseaseId
          in: path
          required: true
          schema:
            type: string
          description: 疾病ID
          example: "rose_black_spot"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Disease'
        '404':
          description: 疾病不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "disease_not_found"
                detail: "未找到指定的疾病"
                timestamp: "2025-01-16T10:00:00Z"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /diagnosis/{diagnosisId}/feedback:
    post:
      summary: 提交用户反馈
      description: |
        用户对诊断结果进行反馈标注（正确/错误）。

        **用途**：
        - 收集用户反馈改进模型
        - 标注数据用于模型训练
        - 诊断准确率统计

      operationId: submitFeedback
      tags:
        - Diagnosis
      parameters:
        - name: diagnosisId
          in: path
          required: true
          schema:
            type: string
          description: 诊断ID
          example: "diag_20250111_001"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - feedback
              properties:
                feedback:
                  type: string
                  enum: [correct, incorrect]
                  description: 反馈类型
                  example: "correct"
                comment:
                  type: string
                  description: 用户备注（可选）
                  example: "诊断非常准确"
      responses:
        '200':
          description: 反馈提交成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "感谢您的反馈"
        '404':
          description: 诊断记录不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /diagnosis/export:
    get:
      summary: 导出诊断结果
      description: |
        导出指定诊断记录为Excel文件。

        **支持格式**：
        - excel（.xlsx）

      operationId: exportDiagnosis
      tags:
        - Diagnosis
      parameters:
        - name: diagnosis_ids
          in: query
          required: true
          schema:
            type: string
          description: 诊断ID列表（逗号分隔）
          example: "diag_20250111_001,diag_20250111_002"
        - name: format
          in: query
          required: false
          schema:
            type: string
            enum: [excel]
            default: excel
          description: 导出格式
      responses:
        '200':
          description: 导出成功
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/tree:
    get:
      summary: 获取知识库目录树
      description: |
        获取知识库的层级目录结构，按花卉种属组织疾病列表。

        **返回结构**：
        ```
        Rosa (玫瑰)
          ├─ 玫瑰黑斑病
          ├─ 玫瑰白粉病
          └─ ...
        Prunus (樱花)
          ├─ 樱花褐斑病
          └─ ...
        ```

      operationId: getKnowledgeTree
      tags:
        - Knowledge
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  tree:
                    type: object
                    description: 知识库树结构（按genus组织）
                    additionalProperties:
                      type: object
                      properties:
                        genus_name_zh:
                          type: string
                          description: 种属中文名
                        diseases:
                          type: array
                          items:
                            type: object
                            properties:
                              disease_id:
                                type: string
                              disease_name:
                                type: string
                              last_updated:
                                type: string
                                format: date-time
                  total_diseases:
                    type: integer
                    description: 总疾病数量
                  version:
                    type: string
                    description: 知识库版本号
              example:
                tree:
                  Rosa:
                    genus_name_zh: "玫瑰/月季"
                    diseases:
                      - disease_id: "rose_black_spot"
                        disease_name: "玫瑰黑斑病"
                        last_updated: "2025-01-10T12:00:00Z"
                      - disease_id: "rose_powdery_mildew"
                        disease_name: "玫瑰白粉病"
                        last_updated: "2025-01-10T12:00:00Z"
                  Prunus:
                    genus_name_zh: "樱花/李属"
                    diseases:
                      - disease_id: "prunus_brown_spot"
                        disease_name: "樱花褐斑病"
                        last_updated: "2025-01-10T12:00:00Z"
                total_diseases: 22
                version: "v20250111_143000"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/disease/{diseaseId}:
    get:
      summary: 获取疾病知识详情
      description: |
        获取指定疾病的完整知识信息，包括VLM描述、特征向量、治疗方案等。

      operationId: getDiseaseKnowledge
      tags:
        - Knowledge
      parameters:
        - name: diseaseId
          in: path
          required: true
          schema:
            type: string
          description: 疾病ID
          example: "rose_black_spot"
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                required:
                  - disease_id
                  - disease_name
                  - pathogen
                  - feature_vector
                properties:
                  disease_id:
                    type: string
                    example: "rose_black_spot"
                  disease_name:
                    type: string
                    example: "玫瑰黑斑病"
                  common_name_en:
                    type: string
                    example: "Black Spot"
                  pathogen:
                    type: object
                    properties:
                      name:
                        type: string
                        example: "Diplocarpon rosae"
                      type:
                        type: string
                        enum: [fungal, bacterial, viral, pest]
                        example: "fungal"
                  affected_plants:
                    type: array
                    items:
                      type: string
                    example: ["Rosa"]
                  feature_vector:
                    $ref: '#/components/schemas/FeatureVector'
                  vlm_descriptions:
                    type: array
                    description: VLM多轮描述（Q0-Q6）
                    items:
                      type: object
                      properties:
                        question_id:
                          type: string
                          example: "Q1"
                        question_text:
                          type: string
                          example: "What type of symptom is visible?"
                        expected_answer:
                          type: string
                          example: "spot"
                  major_features:
                    type: array
                    description: 主要特征（30分权重）
                    items:
                      type: object
                      properties:
                        feature_name:
                          type: string
                        feature_value:
                          type: string
                  minor_features:
                    type: array
                    description: 次要特征（15分权重）
                    items:
                      type: object
                      properties:
                        feature_name:
                          type: string
                        feature_value:
                          type: string
                  optional_features:
                    type: array
                    description: 可选特征（5分权重）
                    items:
                      type: object
                      properties:
                        feature_name:
                          type: string
                        feature_value:
                          type: string
                  treatment_recommendations:
                    type: array
                    description: 治疗建议
                    items:
                      type: string
                  last_updated:
                    type: string
                    format: date-time
                    example: "2025-01-10T12:00:00Z"
        '404':
          description: 疾病不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: 保存疾病知识修改
      description: |
        保存对疾病知识的修改（VLM描述、特征向量、治疗方案等）。

        **权限要求**: 需要管理员认证

      operationId: saveDiseaseKnowledge
      tags:
        - Knowledge
      security:
        - ApiKeyAuth: []
      parameters:
        - name: diseaseId
          in: path
          required: true
          schema:
            type: string
          description: 疾病ID
          example: "rose_black_spot"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                disease_name:
                  type: string
                  description: 疾病中文名
                common_name_en:
                  type: string
                  description: 疾病英文名
                pathogen:
                  type: object
                  description: 病原体信息
                feature_vector:
                  $ref: '#/components/schemas/FeatureVector'
                vlm_descriptions:
                  type: array
                  description: VLM描述列表
                  items:
                    type: object
                major_features:
                  type: array
                  description: 主要特征
                  items:
                    type: object
                minor_features:
                  type: array
                  description: 次要特征
                  items:
                    type: object
                treatment_recommendations:
                  type: array
                  description: 治疗建议
                  items:
                    type: string
      responses:
        '200':
          description: 保存成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "疾病知识保存成功"
                  updated_at:
                    type: string
                    format: date-time
                    example: "2025-01-16T10:00:00Z"
        '400':
          description: 数据验证失败
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "validation_failed"
                detail: "特征向量缺少必填字段 symptom_type"
                timestamp: "2025-01-16T10:00:00Z"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 疾病不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/validate:
    post:
      summary: 验证疾病知识数据
      description: |
        验证疾病知识数据的完整性和正确性，返回验证结果。

        **验证项**：
        - 必填字段检查
        - 特征向量格式验证
        - VLM描述完整性检查
        - 枚举值范围验证

      operationId: validateKnowledge
      tags:
        - Knowledge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: 待验证的疾病知识数据
      responses:
        '200':
          description: 验证完成
          content:
            application/json:
              schema:
                type: object
                required:
                  - valid
                  - errors
                  - warnings
                properties:
                  valid:
                    type: boolean
                    description: 是否验证通过
                    example: false
                  errors:
                    type: array
                    description: 错误列表（阻塞性问题）
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                          example: "feature_vector.symptom_type"
                        message:
                          type: string
                          example: "必填字段缺失"
                  warnings:
                    type: array
                    description: 警告列表（非阻塞性问题）
                    items:
                      type: object
                      properties:
                        field:
                          type: string
                        message:
                          type: string
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/snapshot:
    post:
      summary: 创建知识库快照
      description: |
        创建当前知识库的版本快照，用于版本管理和回滚。

        **权限要求**: 需要管理员认证

      operationId: createSnapshot
      tags:
        - Knowledge
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - version
                - description
              properties:
                version:
                  type: string
                  description: 版本号（建议格式：vYYYYMMDD）
                  example: "v20250116"
                description:
                  type: string
                  description: 修改说明
                  example: "新增5种玫瑰疾病"
      responses:
        '200':
          description: 快照创建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  snapshot_id:
                    type: string
                    example: "snap_20250116_001"
                  version:
                    type: string
                    example: "v20250116"
                  created_at:
                    type: string
                    format: date-time
                    example: "2025-01-16T10:00:00Z"
                  disease_count:
                    type: integer
                    example: 27
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/snapshots:
    get:
      summary: 获取快照历史列表
      description: |
        查询知识库的所有历史快照。

        **权限要求**: 需要管理员认证

      operationId: getSnapshots
      tags:
        - Knowledge
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    snapshot_id:
                      type: string
                      example: "snap_20250116_001"
                    version:
                      type: string
                      example: "v20250116"
                    description:
                      type: string
                      example: "新增5种玫瑰疾病"
                    created_at:
                      type: string
                      format: date-time
                    disease_count:
                      type: integer
                    created_by:
                      type: string
                      example: "admin"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/restore/{snapshotId}:
    post:
      summary: 恢复历史快照
      description: |
        将知识库回滚到指定的历史快照版本。

        **权限要求**: 需要管理员认证
        **注意**: 此操作会覆盖当前知识库，建议先创建当前快照

      operationId: restoreSnapshot
      tags:
        - Knowledge
      security:
        - ApiKeyAuth: []
      parameters:
        - name: snapshotId
          in: path
          required: true
          schema:
            type: string
          description: 快照ID
          example: "snap_20250116_001"
      responses:
        '200':
          description: 恢复成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "知识库已恢复到版本 v20250116"
                  restored_version:
                    type: string
                    example: "v20250116"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 快照不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /knowledge/test-diagnosis:
    post:
      summary: 测试诊断（使用新知识）
      description: |
        使用修改后的疾病知识进行诊断测试，不保存结果。

        **用途**：在保存新知识前测试其诊断效果

      operationId: testDiagnosis
      tags:
        - Knowledge
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - image
                - disease_id
              properties:
                image:
                  type: string
                  format: binary
                  description: 测试图片
                disease_id:
                  type: string
                  description: 待测试的疾病ID
                  example: "rose_black_spot"
      responses:
        '200':
          description: 测试完成
          content:
            application/json:
              schema:
                type: object
                properties:
                  matched:
                    type: boolean
                    description: 是否匹配到指定疾病
                    example: true
                  confidence:
                    type: number
                    format: float
                    description: 置信度
                    example: 0.92
                  score:
                    type: number
                    description: 匹配得分
                    example: 92.5
                  feature_vector:
                    $ref: '#/components/schemas/FeatureVector'
                  reasoning:
                    type: array
                    items:
                      type: string
        '400':
          description: 请求错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: 疾病不存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ontology/features:
    get:
      summary: 获取特征本体
      description: |
        获取特征本体的完整定义，包括所有特征维度和枚举值。

        **特征本体包含**：
        - Q0-Q6 问诊序列的所有特征维度
        - 每个维度的允许值（枚举）
        - 特征的类型和描述

      operationId: getFeatureOntology
      tags:
        - Knowledge
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: 特征总数
                    example: 45
                  features:
                    type: array
                    items:
                      type: object
                      required:
                        - feature_id
                        - feature_name
                        - feature_type
                      properties:
                        feature_id:
                          type: string
                          description: 特征ID（英文）
                          example: "symptom_type"
                        feature_name:
                          type: string
                          description: 特征名称（中文）
                          example: "症状类型"
                        feature_type:
                          type: string
                          enum: [enum, string, number, boolean]
                          description: 特征值类型
                          example: "enum"
                        feature_category:
                          type: string
                          description: 特征分类
                          example: "symptom"
                        allowed_values:
                          type: array
                          description: 允许的枚举值（仅enum类型）
                          items:
                            type: string
                          example: ["spot", "wilting", "discoloration", "deformation"]
                        description:
                          type: string
                          description: 特征说明
                          example: "病症的主要类型"
                        question_id:
                          type: string
                          description: 对应的问诊序列ID
                          example: "Q1"
                  version:
                    type: string
                    description: 本体版本号
                    example: "1.0.0"
              example:
                total: 45
                features:
                  - feature_id: "symptom_type"
                    feature_name: "症状类型"
                    feature_type: "enum"
                    feature_category: "symptom"
                    allowed_values: ["spot", "wilting", "discoloration", "deformation", "pest", "mold", "other"]
                    description: "病症的主要类型"
                    question_id: "Q1"
                  - feature_id: "colors"
                    feature_name: "病症颜色"
                    feature_type: "enum"
                    feature_category: "symptom"
                    allowed_values: ["black", "brown", "yellow", "white", "red", "orange"]
                    description: "病症呈现的颜色"
                    question_id: "Q2"
                version: "1.0.0"
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ontology/disease:
    get:
      summary: 获取疾病Schema
      description: |
        获取疾病本体Schema定义，包括必填字段和可选字段。

      operationId: getDiseaseSchema
      tags:
        - Knowledge
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema_id:
                    type: string
                    example: "disease_schema"
                  version:
                    type: string
                    example: "1.0.0"
                  required_fields:
                    type: array
                    items:
                      type: object
                      properties:
                        field_name:
                          type: string
                        display_name:
                          type: string
                        type:
                          type: string
                        required:
                          type: boolean
                        description:
                          type: string
                  optional_fields:
                    type: array
                    items:
                      type: object
                      properties:
                        field_name:
                          type: string
                        display_name:
                          type: string
                        type:
                          type: string
                        required:
                          type: boolean
                        description:
                          type: string
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ontology/host:
    get:
      summary: 获取宿主Schema
      description: |
        获取宿主（植物）本体Schema定义。

      operationId: getHostSchema
      tags:
        - Knowledge
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema_id:
                    type: string
                    example: "host_schema"
                  version:
                    type: string
                    example: "1.0.0"
                  fields:
                    type: array
                    items:
                      type: object
                      properties:
                        field_name:
                          type: string
                        display_name:
                          type: string
                        type:
                          type: string
                        required:
                          type: boolean
                        description:
                          type: string
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /ontology/treatment:
    get:
      summary: 获取治疗Schema
      description: |
        获取治疗方案本体Schema定义。

      operationId: getTreatmentSchema
      tags:
        - Knowledge
      responses:
        '200':
          description: 查询成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema_id:
                    type: string
                    example: "treatment_schema"
                  version:
                    type: string
                    example: "0.1.0"
                  fields:
                    type: array
                    items:
                      type: object
                      properties:
                        field_name:
                          type: string
                        display_name:
                          type: string
                        type:
                          type: string
                        required:
                          type: boolean
                        description:
                          type: string
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/logout:
    post:
      summary: 管理员登出
      description: |
        管理员登出，使当前Token失效。

      operationId: logout
      tags:
        - Auth
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: 登出成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "登出成功"
        '401':
          description: 未授权
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API密钥认证（未来实现）

        目前仅用于管理接口（/admin/reload）和历史查询（/history），
        诊断接口（/diagnose）暂不启用认证。

  schemas:
    DiagnosisResponse:
      type: object
      required:
        - diagnosis_id
        - timestamp
        - status
        - feature_vector
        - vlm_provider
        - execution_time_ms
      properties:
        diagnosis_id:
          type: string
          description: 诊断唯一标识符（格式：diag_YYYYMMDD_序号）
          example: "diag_20250111_001"
        timestamp:
          type: string
          format: date-time
          description: 诊断时间戳（ISO 8601格式）
          example: "2025-01-11T14:30:00Z"
        status:
          type: string
          enum: [confirmed, suspected, unlikely]
          description: |
            诊断状态：
            - confirmed：确诊（置信度 ≥ 0.85）
            - suspected：疑似（置信度 0.60-0.85）
            - unlikely：未知（置信度 < 0.60）
          example: "confirmed"
        confirmed_disease:
          $ref: '#/components/schemas/DiagnosedDisease'
          description: 确诊疾病信息（status=confirmed时存在）
        suspected_diseases:
          type: array
          description: 疑似疾病列表（status=suspected时存在，Top 2-3候选）
          items:
            $ref: '#/components/schemas/DiagnosedDisease'
        feature_vector:
          $ref: '#/components/schemas/FeatureVector'
          description: VLM提取的特征向量（Q0-Q6问诊结果）
        scores:
          type: object
          description: 特征匹配得分详情
          required:
            - total_score
            - major_features
            - minor_features
            - optional_features
          properties:
            total_score:
              type: number
              format: float
              description: 总分（0-100）
              example: 92.5
            major_features:
              type: object
              description: 主要特征得分（30分权重 × N个）
              additionalProperties:
                type: number
              example:
                spot_color: 30
                spot_shape: 25
            minor_features:
              type: object
              description: 次要特征得分（15分权重 × N个）
              additionalProperties:
                type: number
              example:
                leaf_yellowing: 15
            optional_features:
              type: object
              description: 可选特征得分（5分权重 × N个）
              additionalProperties:
                type: number
              example:
                stem_affected: 5
        reasoning:
          type: array
          description: 诊断推理过程（人类可读的逻辑链）
          items:
            type: string
          example:
            - "检测到叶片表面黑色斑点（主要特征匹配）"
            - "斑点呈圆形，边缘清晰（形态匹配）"
            - "叶片周围伴有轻微黄化（次要特征）"
        candidates:
          type: array
          description: 所有候选疾病及其分数（调试用）
          items:
            type: object
            properties:
              disease_name:
                type: string
              score:
                type: number
              confidence:
                type: number
          example:
            - disease_name: "玫瑰黑斑病"
              score: 92.5
              confidence: 0.92
            - disease_name: "玫瑰褐斑病"
              score: 65.0
              confidence: 0.65
        vlm_provider:
          type: string
          description: 使用的VLM服务提供商
          enum: [qwen_vl, gemini, doubao, glm_4v, grok_vision]
          example: "qwen_vl"
        execution_time_ms:
          type: integer
          description: 诊断总耗时（毫秒，包括VLM调用和知识库匹配）
          example: 2340

    DiagnosedDisease:
      type: object
      required:
        - disease_id
        - disease_name
        - confidence
      properties:
        disease_id:
          type: string
          description: 疾病唯一标识符
          example: "rose_black_spot"
        disease_name:
          type: string
          description: 疾病中文名
          example: "玫瑰黑斑病"
        common_name_en:
          type: string
          description: 疾病英文名
          example: "Black Spot"
        pathogen:
          type: string
          description: 病原体名称
          example: "Diplocarpon rosae"
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
          description: 诊断置信度（0-1）
          example: 0.92

    FeatureVector:
      type: object
      description: |
        VLM提取的特征向量（Q0-Q6问诊序列结果）

        **Q0: 逐级过滤**
        - Q0.0: content_type（内容类型识别）
        - Q0.1: plant_category（植物类别识别）
        - Q0.2: flower_genus（花卉种属识别）
        - Q0.3: organ（器官识别）
        - Q0.4: completeness（完整性检查）
        - Q0.5: has_abnormality（异常判断）

        **Q1-Q6: 症状特征提取**
        - Q1: symptom_type（症状类型）
        - Q2: colors（颜色特征）
        - Q3: location（位置特征）
        - Q4: size（大小特征）
        - Q5: distribution（分布特征）
        - Q6: （预留扩展）

      required:
        - content_type
        - plant_category
        - has_abnormality
      properties:
        content_type:
          type: string
          enum: [plant, non_plant, unclear]
          description: 内容类型（Q0.0）
          example: "plant"
        plant_category:
          type: string
          enum: [flower, tree, grass, vegetable, other, unclear]
          description: 植物类别（Q0.1）
          example: "flower"
        flower_genus:
          type: string
          description: 花卉种属（Q0.2，Genus级别）
          example: "Rosa"
        organ:
          type: string
          enum: [leaf, flower, stem, root, multiple, unclear]
          description: 植物器官（Q0.3）
          example: "leaf"
        completeness:
          type: string
          enum: [intact, partial, unclear]
          description: 完整性（Q0.4）
          example: "intact"
        has_abnormality:
          type: string
          enum: ["yes", "no", "unclear"]
          description: 是否有异常（Q0.5）
          example: "yes"
        symptom_type:
          type: string
          enum: [spot, wilting, discoloration, deformation, pest, mold, other]
          description: 症状类型（Q1）
          example: "spot"
        colors:
          type: array
          description: 病症颜色（Q2，多值）
          items:
            type: string
          example: ["black", "brown"]
        location:
          type: string
          description: 病症位置（Q3）
          example: "leaf_surface"
        size:
          type: string
          enum: [small, medium, large, unclear]
          description: 病症大小（Q4）
          example: "medium"
        distribution:
          type: string
          enum: [scattered, clustered, edge, center, uniform, unclear]
          description: 病症分布（Q5）
          example: "scattered"

    Disease:
      type: object
      required:
        - disease_id
        - disease_name
        - pathogen
        - affected_plants
      properties:
        disease_id:
          type: string
          description: 疾病唯一标识符（格式：<genus>_<disease_name_en>）
          example: "rose_black_spot"
        disease_name:
          type: string
          description: 疾病中文名
          example: "玫瑰黑斑病"
        common_name_en:
          type: string
          description: 疾病英文名
          example: "Black Spot"
        pathogen:
          type: string
          description: 病原体名称（拉丁学名）
          example: "Diplocarpon rosae"
        pathogen_type:
          type: string
          enum: [fungal, bacterial, viral, pest]
          description: 病原体类型
          example: "fungal"
        affected_plants:
          type: array
          description: 受影响的植物属（Genus级别）
          items:
            type: string
          example: ["Rosa"]
        typical_symptoms:
          type: array
          description: 典型症状描述列表
          items:
            type: string
          example:
            - "叶片出现黑色圆形斑点"
            - "斑点周围伴有黄化"
            - "严重时叶片脱落"
        major_features:
          type: array
          description: 主要特征列表（诊断用，30分权重）
          items:
            type: object
            properties:
              feature_name:
                type: string
              feature_value:
                type: string
          example:
            - feature_name: "spot_color"
              feature_value: "black"
            - feature_name: "spot_shape"
              feature_value: "circular"
        minor_features:
          type: array
          description: 次要特征列表（诊断用，15分权重）
          items:
            type: object
            properties:
              feature_name:
                type: string
              feature_value:
                type: string
        optional_features:
          type: array
          description: 可选特征列表（诊断用，5分权重）
          items:
            type: object
            properties:
              feature_name:
                type: string
              feature_value:
                type: string

    DiagnosisHistory:
      type: object
      description: 诊断历史记录
      required:
        - diagnosis_id
        - timestamp
        - status
      properties:
        diagnosis_id:
          type: string
          description: 诊断唯一标识符
          example: "diag_20250111_001"
        timestamp:
          type: string
          format: date-time
          description: 诊断时间戳
          example: "2025-01-11T14:30:00Z"
        plant_genus:
          type: string
          description: 花卉种属
          example: "Rosa"
        status:
          type: string
          enum: [confirmed, suspected, unlikely]
          description: 诊断状态
          example: "confirmed"
        disease_name:
          type: string
          description: 疾病名称（confirmed时为确诊疾病，suspected时为Top1候选）
          example: "玫瑰黑斑病"
        confidence:
          type: number
          format: float
          description: 置信度
          example: 0.92
        image_url:
          type: string
          format: uri
          description: 图片访问路径（相对路径）
          example: "/storage/images/unlabeled/diag_20250111_001.jpg"
        user_feedback:
          type: string
          enum: [correct, incorrect, null]
          description: 用户反馈（通过Streamlit后台标注）
          example: "correct"

    ErrorResponse:
      type: object
      required:
        - error
        - detail
        - timestamp
      properties:
        error:
          type: string
          description: 错误类型代码（machine-readable）
          example: "invalid_image_format"
        detail:
          type: string
          description: 错误详细信息（human-readable）
          example: "图片格式不支持，仅支持JPG/PNG/HEIC格式"
        timestamp:
          type: string
          format: date-time
          description: 错误发生时间戳
          example: "2025-01-11T14:30:00Z"
        request_id:
          type: string
          description: 请求追踪ID（可选，用于日志关联）
          example: "req_abc123xyz"
