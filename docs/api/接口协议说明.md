# PhytoOracle API æ¥å£åè®®è¯´æ˜

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-12
**APIç‰ˆæœ¬**: v1.0.0

---

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [è®¤è¯æ–¹å¼](#è®¤è¯æ–¹å¼)
3. [æ ¸å¿ƒæ¥å£](#æ ¸å¿ƒæ¥å£)
   - [è¯Šæ–­æ¥å£](#1-è¯Šæ–­æ¥å£)
   - [ç–¾ç—…æŸ¥è¯¢æ¥å£](#2-ç–¾ç—…æŸ¥è¯¢æ¥å£)
   - [çŸ¥è¯†åº“é‡è½½æ¥å£](#3-çŸ¥è¯†åº“é‡è½½æ¥å£)
   - [ç®¡ç†å‘˜ç™»å½•æ¥å£](#4-ç®¡ç†å‘˜ç™»å½•æ¥å£)
   - [è¯Šæ–­å†å²æŸ¥è¯¢æ¥å£](#5-è¯Šæ–­å†å²æŸ¥è¯¢æ¥å£)
4. [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
5. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä¿¡æ¯

**å¼€å‘ç¯å¢ƒ**:
```
Base URL: http://localhost:8000/api/v1
```

**ç”Ÿäº§ç¯å¢ƒ**:
```
Base URL: https://api.phytooracle.com/api/v1
```

### æ”¯æŒçš„èŠ±å‰ç§å±

å½“å‰ç‰ˆæœ¬æ”¯æŒä»¥ä¸‹5ç§èŠ±å‰çš„ç–¾ç—…è¯Šæ–­ï¼š

| ç§å±ï¼ˆGenusï¼‰ | ä¸­æ–‡å | æ”¯æŒç–¾ç—…æ•° |
|--------------|--------|-----------|
| Rosa | ç«ç‘°/æœˆå­£ | 4-6ç§ |
| Prunus | æ¨±èŠ±/æå± | 3-5ç§ |
| Tulipa | éƒé‡‘é¦™ | 3-5ç§ |
| Dianthus | åº·ä¹ƒé¦¨ | 3-4ç§ |
| Paeonia | ç‰¡ä¸¹ | 3-4ç§ |

**æ€»ç–¾ç—…æ•°**: 18-24ç§

### è¯Šæ–­æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
    â†“
Q0: é€çº§è¿‡æ»¤ï¼ˆå†…å®¹ç±»å‹â†’æ¤ç‰©ç±»åˆ«â†’èŠ±å‰ç§å±â†’å™¨å®˜â†’å®Œæ•´æ€§â†’å¼‚å¸¸åˆ¤æ–­ï¼‰
    â†“
Q1-Q6: ç‰¹å¾æå–ï¼ˆç—‡çŠ¶ç±»å‹ã€é¢œè‰²ã€ä½ç½®ã€å¤§å°ã€åˆ†å¸ƒï¼‰
    â†“
çŸ¥è¯†åº“åŒ¹é…ï¼ˆç‰¹å¾å‘é‡åŒ¹é…ç–¾ç—…æœ¬ä½“ï¼‰
    â†“
ä¸‰å±‚æ¸è¿›è¯Šæ–­
    â”œâ”€ ç¡®è¯Šï¼ˆConfirmedï¼‰ï¼šç½®ä¿¡åº¦ â‰¥ 0.85
    â”œâ”€ ç–‘ä¼¼ï¼ˆSuspectedï¼‰ï¼šç½®ä¿¡åº¦ 0.60-0.85ï¼ˆè¿”å›Top 2-3å€™é€‰ï¼‰
    â””â”€ æœªçŸ¥ï¼ˆUnlikelyï¼‰ï¼šç½®ä¿¡åº¦ < 0.60ï¼ˆVLMå…œåº•æè¿°ï¼‰
```

---

## è®¤è¯æ–¹å¼

### API Key è®¤è¯ï¼ˆæœªæ¥å®ç°ï¼‰

ç›®å‰ä»…ç®¡ç†æ¥å£éœ€è¦è®¤è¯ï¼Œé€šè¿‡HTTP Headerä¼ é€’ï¼š

```http
X-API-Key: your_api_key_here
```

**é€‚ç”¨æ¥å£**:
- `POST /admin/reload` - çŸ¥è¯†åº“é‡è½½
- `GET /history` - è¯Šæ–­å†å²æŸ¥è¯¢

**ä¸éœ€è¦è®¤è¯**:
- `POST /diagnose` - è¯Šæ–­æ¥å£ï¼ˆå…¬å¼€è®¿é—®ï¼‰
- `GET /diseases` - ç–¾ç—…æŸ¥è¯¢ï¼ˆå…¬å¼€è®¿é—®ï¼‰

### JWT Token è®¤è¯

ç®¡ç†å‘˜ç™»å½•åè·å¾—JWT Tokenï¼Œç”¨äºç®¡ç†åå°æ“ä½œï¼š

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Tokenæœ‰æ•ˆæœŸ**: 24å°æ—¶

---

## æ ¸å¿ƒæ¥å£

### 1. è¯Šæ–­æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v1/diagnose`

**åŠŸèƒ½æè¿°**: ä¸Šä¼ èŠ±å‰å›¾ç‰‡è¿›è¡Œç–¾ç—…è¯Šæ–­ï¼Œç³»ç»Ÿé€šè¿‡VLMæå–ç‰¹å¾å¹¶åŒ¹é…çŸ¥è¯†åº“ã€‚

#### è¯·æ±‚å‚æ•°

**Content-Type**: `multipart/form-data`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| image | File | æ˜¯ | å›¾ç‰‡æ–‡ä»¶ï¼ˆJPG/PNG/HEICï¼Œæœ€å¤§10MBï¼‰ |
| flower_genus | String | å¦ | èŠ±å‰ç§å±ï¼ˆæä¾›åå¯æé«˜å‡†ç¡®ç‡ï¼‰<br>å¯é€‰å€¼ï¼šRosa, Prunus, Tulipa, Dianthus, Paeonia |

#### è¯·æ±‚ç¤ºä¾‹

**ä½¿ç”¨ cURL**:
```bash
curl -X POST http://localhost:8000/api/v1/diagnose \
  -F "image=@/path/to/rose_leaf.jpg" \
  -F "flower_genus=Rosa"
```

**ä½¿ç”¨ Python (requests)**:
```python
import requests

url = "http://localhost:8000/api/v1/diagnose"
files = {
    'image': open('/path/to/rose_leaf.jpg', 'rb')
}
data = {
    'flower_genus': 'Rosa'
}

response = requests.post(url, files=files, data=data)
result = response.json()
print(result)
```

**ä½¿ç”¨ JavaScript (fetch)**:
```javascript
const formData = new FormData();
formData.append('image', fileInput.files[0]);
formData.append('flower_genus', 'Rosa');

fetch('http://localhost:8000/api/v1/diagnose', {
  method: 'POST',
  body: formData
})
.then(response => response.json())
.then(data => console.log(data));
```

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”ï¼ˆç¡®è¯Šï¼‰** - HTTP 200:
```json
{
  "diagnosis_id": "diag_20250111_001",
  "timestamp": "2025-01-11T14:30:00Z",
  "status": "confirmed",
  "confirmed_disease": {
    "disease_id": "rose_black_spot",
    "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
    "common_name_en": "Black Spot",
    "pathogen": "Diplocarpon rosae",
    "confidence": 0.92
  },
  "feature_vector": {
    "content_type": "plant",
    "plant_category": "flower",
    "flower_genus": "Rosa",
    "organ": "leaf",
    "completeness": "intact",
    "has_abnormality": "yes",
    "symptom_type": "spot",
    "colors": ["black", "brown"],
    "location": "leaf_surface",
    "size": "medium",
    "distribution": "scattered"
  },
  "scores": {
    "total_score": 92.5,
    "major_features": {
      "spot_color": 30,
      "spot_shape": 25
    },
    "minor_features": {
      "leaf_yellowing": 15
    },
    "optional_features": {
      "stem_affected": 5
    }
  },
  "reasoning": [
    "æ£€æµ‹åˆ°å¶ç‰‡è¡¨é¢é»‘è‰²æ–‘ç‚¹ï¼ˆä¸»è¦ç‰¹å¾åŒ¹é…ï¼‰",
    "æ–‘ç‚¹å‘ˆåœ†å½¢ï¼Œè¾¹ç¼˜æ¸…æ™°ï¼ˆå½¢æ€åŒ¹é…ï¼‰",
    "å¶ç‰‡å‘¨å›´ä¼´æœ‰è½»å¾®é»„åŒ–ï¼ˆæ¬¡è¦ç‰¹å¾ï¼‰"
  ],
  "candidates": [
    {
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "score": 92.5,
      "confidence": 0.92
    },
    {
      "disease_name": "ç«ç‘°è¤æ–‘ç—…",
      "score": 65.0,
      "confidence": 0.65
    }
  ],
  "vlm_provider": "qwen_vl",
  "execution_time_ms": 2340
}
```

**æˆåŠŸå“åº”ï¼ˆç–‘ä¼¼ï¼‰** - HTTP 200:
```json
{
  "diagnosis_id": "diag_20250111_002",
  "timestamp": "2025-01-11T14:35:00Z",
  "status": "suspected",
  "suspected_diseases": [
    {
      "disease_id": "rose_black_spot",
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "confidence": 0.75
    },
    {
      "disease_id": "rose_brown_spot",
      "disease_name": "ç«ç‘°è¤æ–‘ç—…",
      "confidence": 0.68
    }
  ],
  "feature_vector": { ... },
  "scores": { ... },
  "reasoning": [
    "æ£€æµ‹åˆ°å¶ç‰‡æ–‘ç‚¹ç—‡çŠ¶",
    "é¢œè‰²ç‰¹å¾ä¸å¤Ÿæ˜æ˜¾ï¼Œéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤",
    "å»ºè®®æä¾›æ›´å¤šè§’åº¦çš„å›¾ç‰‡"
  ],
  "vlm_provider": "qwen_vl",
  "execution_time_ms": 2150
}
```

**é”™è¯¯å“åº”ï¼ˆè¯·æ±‚é”™è¯¯ï¼‰** - HTTP 400:
```json
{
  "error": "invalid_image_format",
  "detail": "å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œä»…æ”¯æŒJPG/PNG/HEICæ ¼å¼",
  "timestamp": "2025-01-11T14:30:00Z"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| diagnosis_id | String | è¯Šæ–­å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæ ¼å¼ï¼šdiag_YYYYMMDD_åºå·ï¼‰ |
| timestamp | String | è¯Šæ–­æ—¶é—´æˆ³ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| status | String | è¯Šæ–­çŠ¶æ€ï¼šconfirmedï¼ˆç¡®è¯Šï¼‰/ suspectedï¼ˆç–‘ä¼¼ï¼‰/ unlikelyï¼ˆæœªçŸ¥ï¼‰ |
| confirmed_disease | Object | ç¡®è¯Šç–¾ç—…ä¿¡æ¯ï¼ˆstatus=confirmedæ—¶å­˜åœ¨ï¼‰ |
| suspected_diseases | Array | ç–‘ä¼¼ç–¾ç—…åˆ—è¡¨ï¼ˆstatus=suspectedæ—¶å­˜åœ¨ï¼‰ |
| feature_vector | Object | VLMæå–çš„ç‰¹å¾å‘é‡ï¼ˆQ0-Q6é—®è¯Šç»“æœï¼‰ |
| scores | Object | ç‰¹å¾åŒ¹é…å¾—åˆ†è¯¦æƒ… |
| reasoning | Array | è¯Šæ–­æ¨ç†è¿‡ç¨‹ï¼ˆäººç±»å¯è¯»ï¼‰ |
| candidates | Array | æ‰€æœ‰å€™é€‰ç–¾ç—…åŠåˆ†æ•°ï¼ˆè°ƒè¯•ç”¨ï¼‰ |
| vlm_provider | String | ä½¿ç”¨çš„VLMæœåŠ¡æä¾›å•† |
| execution_time_ms | Integer | è¯Šæ–­æ€»è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ |

#### é”™è¯¯ç 

| HTTPçŠ¶æ€ç  | errorå­—æ®µ | è¯´æ˜ |
|-----------|-----------|------|
| 400 | invalid_image_format | å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ |
| 400 | file_too_large | æ–‡ä»¶å¤§å°è¶…è¿‡10MB |
| 400 | invalid_genus | flower_genuså‚æ•°å€¼æ— æ•ˆ |
| 401 | unauthorized | API Keyæ— æ•ˆæˆ–ç¼ºå¤± |
| 500 | vlm_service_error | VLMæœåŠ¡è°ƒç”¨å¤±è´¥ |
| 500 | knowledge_base_error | çŸ¥è¯†åº“åŠ è½½å¤±è´¥ |

---

### 2. ç–¾ç—…æŸ¥è¯¢æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v1/diseases`

**åŠŸèƒ½æè¿°**: æŸ¥è¯¢çŸ¥è¯†åº“ä¸­çš„ç–¾ç—…ä¿¡æ¯ï¼Œæ”¯æŒæŒ‰èŠ±å‰ç§å±å’Œç—…åŸä½“ç±»å‹è¿‡æ»¤ã€‚

#### è¯·æ±‚å‚æ•°

**Content-Type**: `application/json`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| genus | String | å¦ | æŒ‰èŠ±å‰å±è¿‡æ»¤<br>å¯é€‰å€¼ï¼šRosa, Prunus, Tulipa, Dianthus, Paeonia |
| pathogen_type | String | å¦ | æŒ‰ç—…åŸä½“ç±»å‹è¿‡æ»¤<br>å¯é€‰å€¼ï¼šfungal, bacterial, viral, pest |
| limit | Integer | å¦ | è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼ˆé»˜è®¤50ï¼Œæœ€å¤§100ï¼‰ |
| offset | Integer | å¦ | åˆ†é¡µåç§»é‡ï¼ˆé»˜è®¤0ï¼‰ |

#### è¯·æ±‚ç¤ºä¾‹

**æŸ¥è¯¢æ‰€æœ‰ç–¾ç—…**:
```bash
curl -X GET "http://localhost:8000/api/v1/diseases"
```

**æŸ¥è¯¢ç«ç‘°çš„çœŸèŒæ€§ç–¾ç—…**:
```bash
curl -X GET "http://localhost:8000/api/v1/diseases?genus=Rosa&pathogen_type=fungal"
```

**åˆ†é¡µæŸ¥è¯¢**:
```bash
curl -X GET "http://localhost:8000/api/v1/diseases?limit=10&offset=0"
```

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”** - HTTP 200:
```json
{
  "total": 5,
  "diseases": [
    {
      "disease_id": "rose_black_spot",
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "common_name_en": "Black Spot",
      "pathogen": "Diplocarpon rosae",
      "pathogen_type": "fungal",
      "affected_plants": ["Rosa"],
      "typical_symptoms": [
        "å¶ç‰‡å‡ºç°é»‘è‰²åœ†å½¢æ–‘ç‚¹",
        "æ–‘ç‚¹å‘¨å›´ä¼´æœ‰é»„åŒ–",
        "ä¸¥é‡æ—¶å¶ç‰‡è„±è½"
      ],
      "major_features": [
        {
          "feature_name": "spot_color",
          "feature_value": "black"
        },
        {
          "feature_name": "spot_shape",
          "feature_value": "circular"
        }
      ],
      "minor_features": [
        {
          "feature_name": "leaf_yellowing",
          "feature_value": "yes"
        }
      ],
      "optional_features": []
    },
    {
      "disease_id": "rose_powdery_mildew",
      "disease_name": "ç«ç‘°ç™½ç²‰ç—…",
      "common_name_en": "Powdery Mildew",
      "pathogen": "Podosphaera pannosa",
      "pathogen_type": "fungal",
      "affected_plants": ["Rosa"],
      "typical_symptoms": [
        "å¶ç‰‡ã€èŒç§†å‡ºç°ç™½è‰²ç²‰çŠ¶ç‰©",
        "å¶ç‰‡å·æ›²å˜å½¢"
      ]
    }
  ]
}
```

---

### 3. çŸ¥è¯†åº“é‡è½½æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v1/admin/reload`

**åŠŸèƒ½æè¿°**: é‡æ–°åŠ è½½çŸ¥è¯†åº“æ•°æ®ï¼ˆç–¾ç—…æœ¬ä½“ã€ç‰¹å¾å‘é‡ã€é‰´åˆ«è§„åˆ™ï¼‰ã€‚

**è®¤è¯è¦æ±‚**: éœ€è¦ API Key

#### è¯·æ±‚å‚æ•°

æ— è¯·æ±‚ä½“ã€‚

#### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X POST http://localhost:8000/api/v1/admin/reload \
  -H "X-API-Key: your_api_key_here"
```

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”** - HTTP 200:
```json
{
  "message": "çŸ¥è¯†åº“é‡è½½æˆåŠŸ",
  "version": "v20250111_143000",
  "disease_count": 22,
  "genus_coverage": ["Rosa", "Prunus", "Tulipa", "Dianthus", "Paeonia"],
  "reload_time_ms": 1250
}
```

**é”™è¯¯å“åº”ï¼ˆé‡è½½å¤±è´¥ï¼‰** - HTTP 500:
```json
{
  "error": "knowledge_base_load_error",
  "detail": "çŸ¥è¯†åº“æ–‡ä»¶æŸåæˆ–æ ¼å¼é”™è¯¯ï¼Œå·²å›æ»šåˆ°æ—§ç‰ˆæœ¬",
  "timestamp": "2025-01-11T14:30:00Z"
}
```

#### æ³¨æ„äº‹é¡¹

1. **é‡è½½æœŸé—´æœåŠ¡ä¸å¯ç”¨**: é‡è½½è¿‡ç¨‹çº¦1-3ç§’ï¼ŒæœŸé—´è¯Šæ–­æœåŠ¡æš‚åœã€‚
2. **å¤±è´¥è‡ªåŠ¨å›æ»š**: é‡è½½å¤±è´¥ä¼šä¿ç•™æ—§ç‰ˆæœ¬çŸ¥è¯†åº“ã€‚
3. **è§¦å‘æ—¶æœº**:
   - ç®¡ç†å‘˜é€šè¿‡Streamlitåå°æ·»åŠ æ–°ç–¾ç—…å
   - çŸ¥è¯†åº“æ–‡ä»¶æ›´æ–°åéœ€è¦çƒ­åŠ è½½
   - ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨

---

### 4. ç®¡ç†å‘˜ç™»å½•æ¥å£

**æ¥å£è·¯å¾„**: `POST /api/v1/auth/login`

**åŠŸèƒ½æè¿°**: ç®¡ç†åå°ç™»å½•è®¤è¯ï¼Œè¿”å›JWT Tokenã€‚

#### è¯·æ±‚å‚æ•°

**Content-Type**: `application/json`

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| username | String | æ˜¯ | ç®¡ç†å‘˜ç”¨æˆ·å |
| password | String | æ˜¯ | ç®¡ç†å‘˜å¯†ç  |

#### è¯·æ±‚ç¤ºä¾‹

```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_secure_password"
  }'
```

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”** - HTTP 200:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 86400,
  "user_info": {
    "username": "admin",
    "role": "administrator"
  }
}
```

**é”™è¯¯å“åº”ï¼ˆè®¤è¯å¤±è´¥ï¼‰** - HTTP 401:
```json
{
  "error": "authentication_failed",
  "detail": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
  "timestamp": "2025-01-11T14:30:00Z"
}
```

#### ä½¿ç”¨Tokenè®¿é—®å—ä¿æŠ¤æ¥å£

```bash
curl -X POST http://localhost:8000/api/v1/admin/reload \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

---

### 5. è¯Šæ–­å†å²æŸ¥è¯¢æ¥å£

**æ¥å£è·¯å¾„**: `GET /api/v1/history`

**åŠŸèƒ½æè¿°**: æŸ¥è¯¢å†å²è¯Šæ–­è®°å½•ï¼Œæ”¯æŒå¤šç»´åº¦ç­›é€‰ã€‚

**è®¤è¯è¦æ±‚**: éœ€è¦ API Key

#### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| start_date | String | å¦ | èµ·å§‹æ—¥æœŸï¼ˆISO 8601æ ¼å¼ï¼šYYYY-MM-DDï¼‰ |
| end_date | String | å¦ | ç»“æŸæ—¥æœŸï¼ˆISO 8601æ ¼å¼ï¼šYYYY-MM-DDï¼‰ |
| plant_genus | String | å¦ | æŒ‰èŠ±å‰ç§å±è¿‡æ»¤ |
| confidence_level | String | å¦ | æŒ‰ç½®ä¿¡åº¦çº§åˆ«è¿‡æ»¤ï¼šconfirmed/suspected/unlikely |
| limit | Integer | å¦ | è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼ˆé»˜è®¤20ï¼Œæœ€å¤§100ï¼‰ |
| offset | Integer | å¦ | åˆ†é¡µåç§»é‡ï¼ˆé»˜è®¤0ï¼‰ |

#### è¯·æ±‚ç¤ºä¾‹

**æŸ¥è¯¢2025å¹´1æœˆçš„æ‰€æœ‰è¯Šæ–­**:
```bash
curl -X GET "http://localhost:8000/api/v1/history?start_date=2025-01-01&end_date=2025-01-31" \
  -H "X-API-Key: your_api_key_here"
```

**æŸ¥è¯¢ç«ç‘°çš„ç¡®è¯Šè®°å½•**:
```bash
curl -X GET "http://localhost:8000/api/v1/history?plant_genus=Rosa&confidence_level=confirmed" \
  -H "X-API-Key: your_api_key_here"
```

#### å“åº”ç¤ºä¾‹

**æˆåŠŸå“åº”** - HTTP 200:
```json
{
  "total": 150,
  "records": [
    {
      "diagnosis_id": "diag_20250111_001",
      "timestamp": "2025-01-11T14:30:00Z",
      "plant_genus": "Rosa",
      "status": "confirmed",
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "confidence": 0.92,
      "image_url": "/storage/images/unlabeled/diag_20250111_001.jpg",
      "user_feedback": "correct"
    },
    {
      "diagnosis_id": "diag_20250111_002",
      "timestamp": "2025-01-11T14:35:00Z",
      "plant_genus": "Rosa",
      "status": "suspected",
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "confidence": 0.75,
      "image_url": "/storage/images/unlabeled/diag_20250111_002.jpg",
      "user_feedback": null
    }
  ]
}
```

---

## æ•°æ®æ¨¡å‹

### FeatureVectorï¼ˆç‰¹å¾å‘é‡ï¼‰

VLMé€šè¿‡Q0-Q6é—®è¯Šåºåˆ—æå–çš„ç‰¹å¾ï¼š

```json
{
  "content_type": "plant",           // Q0.0: å†…å®¹ç±»å‹ï¼ˆplant/non_plant/unclearï¼‰
  "plant_category": "flower",        // Q0.1: æ¤ç‰©ç±»åˆ«ï¼ˆflower/tree/grass/vegetable/otherï¼‰
  "flower_genus": "Rosa",            // Q0.2: èŠ±å‰ç§å±ï¼ˆGenusçº§åˆ«ï¼‰
  "organ": "leaf",                   // Q0.3: æ¤ç‰©å™¨å®˜ï¼ˆleaf/flower/stem/rootï¼‰
  "completeness": "intact",          // Q0.4: å®Œæ•´æ€§ï¼ˆintact/partial/unclearï¼‰
  "has_abnormality": "yes",          // Q0.5: æ˜¯å¦æœ‰å¼‚å¸¸ï¼ˆyes/no/unclearï¼‰
  "symptom_type": "spot",            // Q1: ç—‡çŠ¶ç±»å‹ï¼ˆspot/wilting/discolorationç­‰ï¼‰
  "colors": ["black", "brown"],      // Q2: ç—…ç—‡é¢œè‰²ï¼ˆæ•°ç»„ï¼‰
  "location": "leaf_surface",        // Q3: ç—…ç—‡ä½ç½®
  "size": "medium",                  // Q4: ç—…ç—‡å¤§å°ï¼ˆsmall/medium/largeï¼‰
  "distribution": "scattered"        // Q5: ç—…ç—‡åˆ†å¸ƒï¼ˆscattered/clusteredç­‰ï¼‰
}
```

### ç‰¹å¾åŒ¹é…å¾—åˆ†ï¼ˆScoresï¼‰

çŸ¥è¯†åº“åŒ¹é…ç®—æ³•çš„å¾—åˆ†è¯¦æƒ…ï¼š

```json
{
  "total_score": 92.5,              // æ€»åˆ†ï¼ˆ0-100ï¼‰
  "major_features": {               // ä¸»è¦ç‰¹å¾å¾—åˆ†ï¼ˆ30åˆ†æƒé‡ Ã— Nä¸ªï¼‰
    "spot_color": 30,
    "spot_shape": 25
  },
  "minor_features": {               // æ¬¡è¦ç‰¹å¾å¾—åˆ†ï¼ˆ15åˆ†æƒé‡ Ã— Nä¸ªï¼‰
    "leaf_yellowing": 15
  },
  "optional_features": {            // å¯é€‰ç‰¹å¾å¾—åˆ†ï¼ˆ5åˆ†æƒé‡ Ã— Nä¸ªï¼‰
    "stem_affected": 5
  }
}
```

### è¯Šæ–­ç»“æœçŠ¶æ€

| çŠ¶æ€ | ç½®ä¿¡åº¦é˜ˆå€¼ | è¯´æ˜ |
|------|-----------|------|
| confirmed | â‰¥ 0.85 | ç¡®è¯Šï¼Œè¿”å›å•ä¸€ç–¾ç—… |
| suspected | 0.60-0.85 | ç–‘ä¼¼ï¼Œè¿”å›Top 2-3å€™é€‰ç–¾ç—… |
| unlikely | < 0.60 | æœªçŸ¥ï¼ŒVLMå…œåº•æè¿° |

---

## é”™è¯¯å¤„ç†

### æ ‡å‡†é”™è¯¯å“åº”æ ¼å¼

```json
{
  "error": "error_code",           // é”™è¯¯ç±»å‹ä»£ç ï¼ˆmachine-readableï¼‰
  "detail": "è¯¦ç»†é”™è¯¯ä¿¡æ¯",         // äººç±»å¯è¯»çš„é”™è¯¯æè¿°
  "timestamp": "2025-01-11T14:30:00Z",
  "request_id": "req_abc123xyz"   // è¯·æ±‚è¿½è¸ªIDï¼ˆå¯é€‰ï¼‰
}
```

### å¸¸è§é”™è¯¯ç 

#### 400 Bad Request

| errorå­—æ®µ | è¯´æ˜ | è§£å†³æ–¹æ³• |
|-----------|------|---------|
| invalid_image_format | å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ | ä½¿ç”¨JPG/PNG/HEICæ ¼å¼ |
| file_too_large | æ–‡ä»¶å¤§å°è¶…è¿‡10MB | å‹ç¼©å›¾ç‰‡åé‡è¯• |
| invalid_genus | flower_genuså‚æ•°æ— æ•ˆ | æ£€æŸ¥å‚æ•°å€¼æ˜¯å¦åœ¨æšä¸¾èŒƒå›´å†… |
| missing_required_field | ç¼ºå°‘å¿…å¡«å‚æ•° | æ£€æŸ¥è¯·æ±‚ä½“æ˜¯å¦å®Œæ•´ |

#### 401 Unauthorized

| errorå­—æ®µ | è¯´æ˜ | è§£å†³æ–¹æ³• |
|-----------|------|---------|
| unauthorized | API Keyæ— æ•ˆæˆ–ç¼ºå¤± | æ£€æŸ¥X-API-Keyè¯·æ±‚å¤´ |
| token_expired | JWT Tokenå·²è¿‡æœŸ | é‡æ–°ç™»å½•è·å–æ–°Token |
| authentication_failed | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ | æ£€æŸ¥ç™»å½•å‡­æ® |

#### 500 Internal Server Error

| errorå­—æ®µ | è¯´æ˜ | è§£å†³æ–¹æ³• |
|-----------|------|---------|
| vlm_service_error | VLMæœåŠ¡è°ƒç”¨å¤±è´¥ | ç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ |
| knowledge_base_error | çŸ¥è¯†åº“åŠ è½½å¤±è´¥ | è”ç³»ç®¡ç†å‘˜æ£€æŸ¥çŸ¥è¯†åº“æ–‡ä»¶ |
| database_error | æ•°æ®åº“è¿æ¥å¤±è´¥ | è”ç³»æŠ€æœ¯æ”¯æŒ |

---

## æœ€ä½³å®è·µ

### 1. å›¾ç‰‡è´¨é‡è¦æ±‚

**æ¨è**:
- âœ… æ¸…æ™°åº¦é«˜ï¼ˆåˆ†è¾¨ç‡ â‰¥ 1024x1024ï¼‰
- âœ… å…‰çº¿å……è¶³ï¼Œæ— ä¸¥é‡è¿‡æ›/æ¬ æ›
- âœ… ç—…ç—‡éƒ¨ä½å±…ä¸­ï¼Œå æ¯” > 30%
- âœ… èšç„¦å‡†ç¡®ï¼Œæ— ä¸¥é‡æ¨¡ç³Š

**é¿å…**:
- âŒ åˆ†è¾¨ç‡è¿‡ä½ï¼ˆ< 512x512ï¼‰
- âŒ ä¸¥é‡å¤±ç„¦æˆ–è¿åŠ¨æ¨¡ç³Š
- âŒ ç—…ç—‡éƒ¨ä½å æ¯”è¿‡å°ï¼ˆ< 10%ï¼‰
- âŒ å›¾ç‰‡åŒ…å«å¤šä¸ªå™¨å®˜ï¼ˆå¦‚åŒæ—¶æ‹æ‘„å¶+èŠ±ï¼‰

### 2. æä¾›flower_genuså‚æ•°

**åœºæ™¯**: ç”¨æˆ·å·²çŸ¥èŠ±å‰ç§å±æ—¶ï¼ŒåŠ¡å¿…æä¾›`flower_genus`å‚æ•°ã€‚

**ä¼˜åŠ¿**:
- æé«˜è¯Šæ–­å‡†ç¡®ç‡ï¼ˆå€™é€‰ç–¾ç—…èŒƒå›´ç¼©å°ï¼‰
- å‡å°‘VLMè°ƒç”¨æ¬¡æ•°ï¼ˆè·³è¿‡Q0.2ç§å±è¯†åˆ«ï¼‰
- é™ä½è¯Šæ–­è€—æ—¶ï¼ˆçº¦å‡å°‘300-500msï¼‰

**ç¤ºä¾‹**:
```bash
# ä¸æä¾›genusï¼ˆç³»ç»Ÿéœ€è¦VLMè¯†åˆ«ï¼‰
curl -F "image=@rose.jpg" http://localhost:8000/api/v1/diagnose

# æä¾›genusï¼ˆè·³è¿‡è¯†åˆ«ï¼Œç›´æ¥è¯Šæ–­ï¼‰
curl -F "image=@rose.jpg" -F "flower_genus=Rosa" http://localhost:8000/api/v1/diagnose
```

### 3. é”™è¯¯é‡è¯•ç­–ç•¥

**VLMæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼ˆHTTP 500ï¼‰**:
```python
import time
import requests

def diagnose_with_retry(image_path, max_retries=3):
    for attempt in range(max_retries):
        try:
            response = requests.post(
                "http://localhost:8000/api/v1/diagnose",
                files={'image': open(image_path, 'rb')}
            )
            if response.status_code == 200:
                return response.json()
            elif response.status_code == 500:
                # æœåŠ¡å™¨é”™è¯¯ï¼Œç­‰å¾…åé‡è¯•
                time.sleep(2 ** attempt)  # æŒ‡æ•°é€€é¿ï¼š2s, 4s, 8s
            else:
                # å®¢æˆ·ç«¯é”™è¯¯ï¼Œä¸é‡è¯•
                return response.json()
        except requests.RequestException as e:
            time.sleep(2 ** attempt)

    raise Exception("è¯Šæ–­å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°")
```

### 4. è¯Šæ–­ç»“æœå¤„ç†

**æ ¹æ®statuså­—æ®µåŒºåˆ†å¤„ç†é€»è¾‘**:

```python
def handle_diagnosis_result(result):
    if result['status'] == 'confirmed':
        # ç¡®è¯Šï¼šæ˜¾ç¤ºå•ä¸€ç–¾ç—…
        disease = result['confirmed_disease']
        print(f"ç¡®è¯Šï¼š{disease['disease_name']} (ç½®ä¿¡åº¦: {disease['confidence']:.2%})")
        print(f"ç—…åŸä½“ï¼š{disease['pathogen']}")

    elif result['status'] == 'suspected':
        # ç–‘ä¼¼ï¼šæ˜¾ç¤ºå¤šä¸ªå€™é€‰ç–¾ç—…
        print("ç–‘ä¼¼ç–¾ç—…ï¼ˆéœ€è¦è¿›ä¸€æ­¥ç¡®è®¤ï¼‰ï¼š")
        for disease in result['suspected_diseases']:
            print(f"- {disease['disease_name']} (ç½®ä¿¡åº¦: {disease['confidence']:.2%})")
        print("\nå»ºè®®ï¼š")
        print("1. æä¾›æ›´æ¸…æ™°çš„å›¾ç‰‡")
        print("2. æ‹æ‘„ç—…ç—‡ç‰¹å†™")
        print("3. æä¾›å¤šä¸ªè§’åº¦çš„å›¾ç‰‡")

    elif result['status'] == 'unlikely':
        # æœªçŸ¥ï¼šæ˜¾ç¤ºVLMå…œåº•æè¿°
        print("æ— æ³•ç¡®å®šç–¾ç—…ç±»å‹")
        print("å¯èƒ½åŸå› ï¼š")
        print("- ç–¾ç—…ä¸åœ¨çŸ¥è¯†åº“èŒƒå›´å†…")
        print("- å›¾ç‰‡è´¨é‡ä¸è¶³")
        print("- éç–¾ç—…ç—‡çŠ¶ï¼ˆå¦‚æ­£å¸¸ç”Ÿç†ç°è±¡ï¼‰")
```

### 5. æ€§èƒ½ä¼˜åŒ–

**æ‰¹é‡æŸ¥è¯¢ç–¾ç—…ä¿¡æ¯**:
```python
# ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç«ç‘°ç–¾ç—…ï¼ˆé¿å…å¤šæ¬¡è¯·æ±‚ï¼‰
response = requests.get(
    "http://localhost:8000/api/v1/diseases",
    params={'genus': 'Rosa', 'limit': 100}
)
diseases = response.json()['diseases']

# æœ¬åœ°ç¼“å­˜ï¼Œä¾›å‰ç«¯å±•ç¤ºä½¿ç”¨
```

**ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢å†å²**:
```python
# æ¯é¡µ20æ¡ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®
page = 1
limit = 20
offset = (page - 1) * limit

response = requests.get(
    "http://localhost:8000/api/v1/history",
    params={'limit': limit, 'offset': offset},
    headers={'X-API-Key': 'your_api_key'}
)
```

### 6. è¯Šæ–­æ¨ç†å¯è§†åŒ–

**åˆ©ç”¨reasoningå­—æ®µå‘ç”¨æˆ·è§£é‡Šè¯Šæ–­ä¾æ®**:

```python
result = response.json()

# æ˜¾ç¤ºæ¨ç†è¿‡ç¨‹
print("\nè¯Šæ–­ä¾æ®ï¼š")
for i, reason in enumerate(result['reasoning'], 1):
    print(f"{i}. {reason}")

# æ˜¾ç¤ºç‰¹å¾åŒ¹é…è¯¦æƒ…
print("\nç‰¹å¾åŒ¹é…å¾—åˆ†ï¼š")
scores = result['scores']
print(f"æ€»åˆ†ï¼š{scores['total_score']:.1f}/100")
print("\nä¸»è¦ç‰¹å¾ï¼š")
for feature, score in scores['major_features'].items():
    print(f"  - {feature}: {score}åˆ†")
```

---

## é™„å½•

### A. æ”¯æŒçš„å›¾ç‰‡æ ¼å¼

| æ ¼å¼ | MIME Type | è¯´æ˜ |
|------|-----------|------|
| JPEG | image/jpeg | æ¨èï¼Œå‹ç¼©ç‡é«˜ |
| PNG | image/png | æ— æŸæ ¼å¼ï¼Œæ”¯æŒé€æ˜ |
| HEIC | image/heic | iPhoneé»˜è®¤æ ¼å¼ |

### B. VLM Provider åˆ—è¡¨

| Provider | åç§° | è´¹ç”¨ | å…è´¹é¢åº¦ |
|----------|------|------|---------|
| qwen_vl | é€šä¹‰åƒé—® VL Plus | å…è´¹ | 1000æ¬¡/å¤© |
| gemini | Google Gemini 2.0 Flash | å…è´¹ | 1500æ¬¡/å¤© |
| doubao | è±†åŒ…è§†è§‰ç‰ˆ | ä»˜è´¹ | - |
| glm_4v | æ™ºè°±AI GLM-4V | å…è´¹ | 10000æ¬¡/å¤© |
| grok_vision | xAI Grok Vision | å…è´¹ | - |

**Fallbacké¡ºåº**: gemini â†’ qwen_vl â†’ doubaoï¼ˆå½“ä¸»Providerå¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢ï¼‰

### C. æ•°æ®å­˜å‚¨ä½ç½®

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | ä¿ç•™å‘¨æœŸ |
|---------|---------|---------|
| è¯Šæ–­è®°å½• | PostgreSQLï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰ | 1å¹´ |
| åŸå§‹å›¾ç‰‡ | backend/storage/images/unlabeled/ | 1å¹´ |
| æ ‡æ³¨å›¾ç‰‡ï¼ˆæ­£ç¡®ï¼‰ | backend/storage/images/correct/ | æ°¸ä¹… |
| æ ‡æ³¨å›¾ç‰‡ï¼ˆé”™è¯¯ï¼‰ | backend/storage/images/incorrect/ | æ°¸ä¹… |
| çŸ¥è¯†åº“æ•°æ® | backend/knowledge_base/ | æ°¸ä¹…ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰ |

### D. çŸ¥è¯†åº“ç‰ˆæœ¬ç®¡ç†

**ç‰ˆæœ¬å·æ ¼å¼**: `vYYYYMMDD_HHMMSS`

**ç¤ºä¾‹**: `v20250111_143000`

**æŸ¥è¯¢å½“å‰ç‰ˆæœ¬**:
```bash
curl -X POST http://localhost:8000/api/v1/admin/reload \
  -H "X-API-Key: your_api_key"
```

**ç‰ˆæœ¬å›æ»š**:
- çŸ¥è¯†åº“é‡è½½å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ç¨³å®šç‰ˆæœ¬
- ç®¡ç†å‘˜å¯é€šè¿‡Streamlitåå°æ‰‹åŠ¨å›æ»š

---

**æ–‡æ¡£ç»´æŠ¤**: PhytoOracle Team
**æŠ€æœ¯æ”¯æŒ**: support@phytooracle.com
**é—®é¢˜åé¦ˆ**: https://github.com/phytooracle/phytooracle/issues
