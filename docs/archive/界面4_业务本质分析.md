# 界面4 - 知识库管理界面：业务本质深度分析

## 文档目的

本文档不提供界面设计方案，而是从业务本质出发，深入分析**花（宿主）、疾病、治疗**三类知识在诊断系统中的业务角色、使用场景和管理需求，为后续界面设计奠定正确的业务基础。

---

## 一、业务流程回顾：知识在诊断中的作用

### 1.1 真实诊断流程（基于MVP试验）

从FlowerSpecialist的多个版本试验中，诊断流程如下：

```
步骤1：图片过滤（Q0系列）
├─ Q0.0：图片内容识别 → 是否是植物？
├─ Q0.1：图片类别 → 叶部/花部/果实/茎干？
├─ Q0.2：花卉属识别 → Rosa/Prunus/Tulipa？【使用花知识】
├─ Q0.3：器官类型 → 叶片/花瓣/果实？
├─ Q0.4：完整性 → 是否完整可见？
└─ Q0.5：异常检测 → 是否存在异常？
    ├─ 无异常 → 结束（健康）
    └─ 有异常 → 进入步骤2

步骤2：特征提取（Q1-Q6）
├─ Q1：症状类型 → necrosis_spot/powdery_coating...
├─ Q2：中心颜色 → black/white/brown...
├─ Q3：边缘颜色 → halo_yellow/no_special...
├─ Q4：发病位置 → lamina/vein/petiole...
├─ Q5：斑点大小 → small/medium/large...
└─ Q6：分布模式 → scattered/clustered/along_vein...

步骤3：候选疾病剪枝
├─ 输入：Q0.2识别的花卉属（如Rosa）
├─ 查询：host_disease/associations.json
└─ 输出：该属的所有可能疾病列表（如[rose_black_spot, rose_powdery_mildew...]）

步骤4：疾病匹配
├─ 对于每个候选疾病：
│   ├─ 读取疾病知识（如diseases/rose_black_spot.json）
│   ├─ 对比VLM提取的特征 vs 疾病期望特征
│   ├─ 计算加权匹配分数（major_features权重0.8）
│   └─ 应用诊断规则（确诊/疑似/不太可能）
└─ 输出：匹配度最高的疾病 + 置信度

步骤5：治疗方案推荐
├─ 输入：诊断结果（如rose_black_spot）
├─ 查询：treatments.json（未实现）
└─ 输出：推荐的化学防治/生物防治/物理防治措施
```

### 1.2 知识的调用关系

```
诊断流程对知识的依赖：

Q0.2（花卉属识别）
    └─→ 需要：花属的特征描述（叶形、花形、科属信息）
          └─→ 数据源：【花知识】（当前未明确定义）

候选疾病剪枝
    └─→ 需要：宿主-疾病关联关系
          └─→ 数据源：host_disease/associations.json

疾病匹配
    └─→ 需要：疾病的特征向量、特征重要性、诊断规则
          └─→ 数据源：diseases/{disease_id}.json

治疗推荐
    └─→ 需要：疾病对应的防治措施
          └─→ 数据源：treatments.json（规划中）
```

---

## 二、三类知识的业务本质分析

### 2.1 花（宿主）知识

#### 业务角色
- **作用阶段**：诊断流程的**最前端**（Q0.2）
- **核心功能**：**快速过滤**，确定"这是什么植物"，缩小后续疾病搜索范围
- **类比**：医院的**科室分诊** —— 先确定患者去皮肤科还是心内科

#### 知识内容特点
1. **描述性信息**：
   - 叶片形态（单叶/复叶、叶缘锯齿、叶脉类型）
   - 花朵形态（花瓣数量、颜色、排列方式）
   - 分类学信息（科、属、常见种）

2. **稳定性**：**极高**
   - 植物的科属分类基本固定（百年不变）
   - 形态特征（如玫瑰的复叶、羽状脉）是物种的固有属性
   - **不会像疾病特征那样因病程/环境变化**

3. **用户修改场景**：**极少**
   - 场景1：添加新花卉属（如扩展到Dianthus石竹属）
   - 场景2：完善已有花卉的描述（如增加Rosa的视觉识别提示词）
   - 场景3：修正分类学错误（罕见）

#### 数据结构特点
- **层级关系**：科 → 属 → 种（典型的分类学树状结构）
- **关联关系**：一个属可能对应多个疾病（1对多）
- **扩展方向**：横向扩展（添加新属），纵向深化（增加识别细节）

#### 当前状态
- **未独立建立**：花知识散落在`host_disease/associations.json`中
- **信息不完整**：只有属名、科名，缺少形态描述
- **VLM识别依赖prompt**：Q0.2的花卉识别靠VLM自身知识，而非系统知识库

---

### 2.2 疾病知识

#### 业务角色
- **作用阶段**：诊断流程的**核心环节**（步骤4）
- **核心功能**：**特征匹配引擎** —— 将VLM观察到的症状与已知疾病模式比对
- **类比**：医生的**疾病诊断手册** —— 列出每种病的典型症状、化验指标、诊断标准

#### 知识内容特点
1. **结构化特征向量**：
   ```json
   "feature_vector": {
     "symptom_type": "necrosis_spot",
     "color_center": ["black", "brown"],
     "color_border": ["yellow", "light_yellow"],
     "location": ["lamina", "petiole"],
     "size": "medium",
     "distribution": "scattered"
   }
   ```

2. **加权重要性**：
   ```json
   "feature_importance": {
     "major_features": {
       "_weight": 0.8,
       "features": [
         {"dimension": "symptom_type", "weight": 0.5},
         {"dimension": "color_border", "weight": 0.3}
       ]
     }
   }
   ```

3. **诊断规则**：
   ```json
   "diagnosis_rules": {
     "confirmed": [{
       "rule_id": "R1",
       "logic": "major_features >= 2/2",
       "confidence": 0.95
     }]
   }
   ```

4. **视觉描述**（辅助VLM识别）：
   ```json
   "visual_descriptions": {
     "color_border": "像月亮周围的黄色光晕",
     "symptom_type": "像被香烟烫过留下的焦痕"
   }
   ```

#### 知识复杂度
- **最高的结构化程度**：特征向量、权重配置、规则引擎
- **动态演化**：
  - Rose Black Spot v10试验发现：color_center应包含"brown"（早期症状）
  - Cherry Powdery Mildew v11试验：调整symptom_type的视觉描述
  - **疾病知识是在试验中不断迭代优化的**

#### 用户修改场景
1. **频繁场景**（试验驱动）：
   - 试验发现VLM观察到的brown是合理的 → 修改color_center: ["black", "brown"]
   - 试验发现黄色晕圈识别率从100%降到58% → 优化visual_descriptions
   - 试验发现size系统性偏小 → 调整size期望值从medium到small

2. **新疾病添加**：
   - 添加rose_rust.json
   - 需定义完整的feature_vector、feature_importance、diagnosis_rules

3. **规则调优**：
   - 修改confirmed的置信度阈值
   - 调整major_features的权重分配

#### 数据结构特点
- **自包含性强**：一个疾病JSON包含诊断所需的所有信息
- **关联关系**：
  - 与宿主关联：通过host_plants字段
  - 与治疗关联：通过disease_id（未来）
- **扩展方向**：
  - 横向：添加新疾病
  - 纵向：优化已有疾病的特征描述、权重、规则

---

### 2.3 治疗知识

#### 业务角色
- **作用阶段**：诊断流程的**最后环节**（步骤5）
- **核心功能**：**方案推荐** —— 根据诊断结果给出防治建议
- **类比**：医生的**处方** —— 确诊后的用药指导

#### 知识内容特点（推测，基于农业实践）
1. **防治措施分类**：
   - 化学防治：农药名称、使用浓度、施用时机
   - 生物防治：生物制剂、天敌释放
   - 物理防治：修剪、隔离、环境控制
   - 预防措施：种植密度、通风、水分管理

2. **施用条件**：
   - 病害阶段：早期/中期/晚期
   - 环境限制：温度、湿度、降雨
   - 安全间隔期：采收前多久停药

3. **关联关系**：
   - 一个疾病可能对应多种治疗方案（1对多）
   - 一种治疗可能适用于多个疾病（多对多）
   - 例如：铜制剂可能同时治疗黑斑病、霜霉病

#### 用户修改场景
1. **频繁场景**：
   - 新农药上市 → 添加新的化学防治方案
   - 农药禁用 → 删除或标记过期方案
   - 试验验证效果 → 更新方案的推荐等级

2. **地区差异**：
   - 不同地区可用农药不同（法规限制）
   - 可能需要支持多版本治疗库

#### 数据结构特点
- **方案集合**：一个疾病对应多个treatment方案
- **可能的关联**：
  - 与疾病关联：disease_id
  - 与产品关联：product_name（农药商品名）
- **扩展方向**：
  - 横向：添加新方案
  - 纵向：细化方案的适用条件、效果评价

#### 当前状态
- **未实现**：treatments.json不存在
- **优先级**：低于疾病知识（先诊断准确，再考虑治疗）

---

## 三、三类知识的对比矩阵

| 维度 | 花（宿主）知识 | 疾病知识 | 治疗知识 |
|------|---------------|----------|----------|
| **业务阶段** | 诊断前端（分诊） | 诊断核心（匹配） | 诊断后端（推荐） |
| **数据稳定性** | 极高（百年不变） | 中（试验迭代） | 低（产品更新） |
| **结构复杂度** | 低（描述+分类） | 高（向量+权重+规则） | 中（方案+条件） |
| **修改频率** | 极低（添加新属） | 高（试验优化） | 中（方案更新） |
| **修改驱动力** | 知识库扩展 | VLM试验反馈 | 农业实践/法规 |
| **关联关系** | 1对多（属→疾病） | 多对1（多症状→1病） | 多对多（病↔方案） |
| **用户关注点** | "这是什么花" | "症状匹配度如何" | "怎么治" |
| **编辑操作** | 添加新条目为主 | 调整参数为主 | 增删方案为主 |
| **验证方式** | 分类学文献 | VLM试验数据 | 田间试验 |

---

## 四、关键业务发现

### 4.1 花知识的独特性

1. **当前误区**：将花知识混在`host_disease/associations.json`中
2. **问题**：
   - 花的形态描述缺失，Q0.2识别完全靠VLM自身知识
   - 无法为VLM提供花卉识别的视觉提示
3. **应该做什么**：
   - **独立建立花知识库**：`hosts/rosa.json`, `hosts/prunus.json`
   - **内容**：形态特征、分类信息、VLM识别提示词
   - **用途**：
     - Q0.2时，将花特征描述注入VLM prompt
     - 与疾病解耦，花知识独立维护

### 4.2 疾病知识的核心地位

1. **最复杂的知识**：
   - 多层次结构：feature_vector + feature_importance + diagnosis_rules + visual_descriptions
   - 动态演化：每次试验都可能调整

2. **用户操作的重点**：
   - 查看试验报告（如v10_rose_black_spot_FINAL_test_report.md）
   - 发现问题（color_border识别率58%）
   - 修改知识库（优化visual_descriptions）
   - 重新试验验证

3. **界面需求**：
   - **不是简单的CRUD**，而是**迭代优化工具**
   - 需要展示：当前配置 ↔ 试验结果 ↔ 调整建议

### 4.3 治疗知识的独立性

1. **与诊断解耦**：
   - 诊断不依赖治疗
   - 治疗完全依赖诊断结果

2. **生命周期独立**：
   - 疾病知识可能几个月不变
   - 治疗方案可能每季度更新（新农药/新法规）

3. **用户群体不同**：
   - 疾病知识：研究人员、植物病理学家
   - 治疗知识：农技推广人员、农资销售

---

## 五、"统一结构" vs "独立结构"的思考

### 5.1 为什么不应该统一？

#### 理由1：业务生命周期完全不同
- **花知识**：百年稳定，极少修改
- **疾病知识**：月度迭代，频繁调整
- **治疗知识**：季度更新，产品驱动

**统一结构意味着**：
- 用同一套界面管理生命周期完全不同的知识
- 界面要么过于复杂（兼顾三者），要么过于简化（无法满足疾病知识的复杂编辑需求）

#### 理由2：编辑操作完全不同
- **花知识**：添加新属 → 填写表单（分类、形态）
- **疾病知识**：调整特征权重 → 拖动滑块、切换选项、对比试验结果
- **治疗知识**：管理方案集合 → 增删改方案卡片

**统一结构意味着**：
- 无法针对性优化交互（如疾病知识需要"权重调节器"，花知识不需要）

#### 理由3：用户心智模型不同
- **花知识**：用户想的是"我要添加郁金香属"
- **疾病知识**：用户想的是"为什么黄色晕圈识别率下降了？我要调整color_border的描述"
- **治疗知识**：用户想的是"这个农药禁用了，我要替换方案"

**统一结构意味着**：
- 强迫用户用同一种方式思考三种完全不同的知识管理任务

### 5.2 应该统一什么？

#### 统一1：视觉设计语言
- 配色方案、字体、按钮样式、卡片布局
- 目的：保持界面一致性，降低学习成本

#### 统一2：导航结构
- 顶部Tab：花知识 | 疾病知识 | 治疗知识（未来）
- 侧边栏：列表 ↔ 详情编辑
- 目的：用户知道在哪里找什么

#### 统一3：基础操作
- 搜索、筛选、排序、导入导出
- 目的：通用功能保持一致

### 5.3 应该独立什么？

#### 独立1：详情编辑区的内容结构
- **花知识**：表单式编辑（分类、形态特征）
- **疾病知识**：多面板式编辑（特征向量 | 权重配置 | 诊断规则 | 视觉描述 | 试验对比）
- **治疗知识**：方案集合编辑（卡片+条件）

#### 独立2：辅助功能
- **花知识**：分类学验证（科属关系检查）
- **疾病知识**：试验结果对比、权重优化建议
- **治疗知识**：法规合规检查（农药是否禁用）

#### 独立3：数据展示
- **花知识**：树状结构（科→属→种）
- **疾病知识**：特征矩阵+权重热力图
- **治疗知识**：方案时间线（上市/禁用）

---

## 六、用户真实使用场景还原

### 场景1：研究人员发现疾病识别问题

**背景**：v10试验发现Rose Black Spot的color_border识别率从100%降到58%

**操作流程**：
1. 打开疾病知识管理界面
2. 搜索并打开"rose_black_spot"
3. 查看当前的visual_descriptions配置
4. 发现color_border只写了"黄色晕圈"，没有视觉隐喻
5. 对比v10试验报告中的失败案例分析
6. 修改visual_descriptions，添加：
   ```json
   "color_border": "像月亮周围的黄色光晕，像手电筒照射时周围的黄色光圈"
   ```
7. 保存，触发新一轮试验
8. 查看试验结果，确认识别率提升

**界面需求**：
- 左侧：疾病列表（可搜索、筛选"试验失败>5次"）
- 中间：详情编辑区（特征配置、视觉描述）
- 右侧：试验历史（v10报告、v11报告，可对比）

### 场景2：添加新疾病

**背景**：需要添加"郁金香灰霉病"

**操作流程**：
1. 打开疾病知识管理界面
2. 点击"添加新疾病"
3. 填写基本信息：disease_id, disease_name, pathogen
4. 定义feature_vector（从feature_ontology中选择）
5. 配置feature_importance（拖动滑块调整权重）
6. 设置diagnosis_rules（选择模板或自定义）
7. 编写visual_descriptions（参考已有疾病）
8. 关联宿主（选择Tulipa）
9. 保存，自动验证JSON Schema
10. 启动首次试验

**界面需求**：
- 向导式流程（步骤1/5 → 步骤2/5 → ...）
- 每一步有示例参考
- 实时预览生成的JSON
- 保存前验证（Schema + 逻辑检查）

### 场景3：添加新花卉属（假设花知识独立后）

**背景**：扩展到石竹属（Dianthus）

**操作流程**：
1. 打开花知识管理界面
2. 点击"添加新花卉属"
3. 填写分类信息：genus, family, 中英文名
4. 描述形态特征（叶型、花型、习性）
5. 添加VLM识别提示词（如"花瓣具流苏状缺刻"）
6. 保存
7. 系统自动在host_disease/associations.json中创建条目（等待添加疾病）

**界面需求**：
- 简洁的表单
- 分类学参考（Rosaceae科包括哪些属）
- 形态特征模板（可选）

---

## 七、开放问题（需用户确认）

### Q1：花知识是否独立建库？
**现状**：花知识散落在associations.json中，没有独立的hosts/*.json
**建议**：独立建立，理由见4.1节
**需确认**：
- 是否认同独立建立花知识库？
- 花知识应包含哪些字段？（形态、分类、识别提示词？）
- Q0.2是否需要注入花知识到VLM prompt？

### Q2：疾病知识编辑的重点是什么？
**观察**：v10/v11试验中大量修改visual_descriptions、调整权重
**需确认**：
- 用户最频繁修改的是哪些字段？（visual_descriptions > 权重 > 规则？）
- 是否需要"试验对比"功能？（当前配置 vs 历史配置 vs 试验结果）
- 是否需要"优化建议"功能？（如"color_border识别率低，建议增强描述"）

### Q3：治疗知识的优先级？
**现状**：未实现
**需确认**：
- 是否在界面4中预留治疗知识管理入口？
- 还是先聚焦花+疾病，治疗知识后续单独设计？

### Q4：知识修改的权限控制？
**场景**：
- 试验研究人员：可修改疾病知识
- 农技人员：只读疾病知识，可修改治疗知识
- 管理员：全部权限
**需确认**：
- 是否需要权限分级？
- 还是MVP阶段不考虑？

### Q5：知识版本管理？
**场景**：v10试验用的是rose_black_spot v4.0，v11用的是v4.1
**需确认**：
- 是否需要版本控制功能？（Git式的diff/rollback）
- 还是手动管理JSON文件？

---

## 八、初步界面组织原则（非设计，是思路）

### 原则1：按业务阶段分Tab
```
┌─────────────────────────────────────┐
│ [花知识] [疾病知识] [治疗知识(未来)] │
└─────────────────────────────────────┘
```
- 理由：用户心智模型是"诊断流程"，从花→疾病→治疗
- 不是按"统一结构"分Tab，而是按业务阶段

### 原则2：疾病知识界面最复杂，其他简洁
- **花知识**：列表+表单（简洁）
- **疾病知识**：列表+多面板详情+试验对比（复杂）
- **治疗知识**：列表+方案卡片（中等）

### 原则3：疾病知识以"迭代优化"为核心
- 不是"增删改查"，而是"查问题→改配置→看结果"
- 界面要支持：
  - 查看当前配置
  - 查看试验历史
  - 对比配置差异
  - 修改并验证
  - 触发新试验

### 原则4：花知识以"扩展"为核心
- 主要操作：添加新属
- 界面要支持：
  - 快速添加（向导）
  - 分类学参考
  - 模板复用

---

## 九、下一步

本文档不提供具体界面设计，而是为设计奠定业务基础。

**建议下一步**：
1. 用户阅读本文档
2. 确认或修正业务分析
3. 回答"开放问题"中的5个问题
4. 基于确认的业务逻辑，再讨论具体界面设计

**避免的误区**：
- 不要从"技术统一"出发（统一JSON结构）
- 不要从"界面美观"出发（先考虑好看的布局）
- 而是从"用户真实操作场景"出发（研究人员如何优化疾病知识）

---

**文档版本**：v1.0
**生成时间**：2025-11-14
**状态**：等待用户反馈
