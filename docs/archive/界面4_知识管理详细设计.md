# 界面4：知识管理详细设计

**文档版本**: v1.0
**创建日期**: 2025-11-14
**作者**: AI Product Manager
**依据**: FlowerSpecialist MVP试验数据 + PhytoOracle现有知识库分析

---

## 执行摘要

本文档基于对FlowerSpecialist MVP试验数据和PhytoOracle现有知识库的深入分析，重新设计界面4（知识管理页）。

**核心发现**：
1. 当前系统有4类本体（特征、疾病、宿主、治疗），但它们的结构高度相关
2. **花本体**和**疾病本体**是影响VLM研判的核心本体，变化最频繁
3. 知识管理的本质是管理"本体维度"和"本体实例"的映射关系

**设计原则**：
- **统一结构**：所有本体共享"元数据 + 维度定义 + 实例集合"结构
- **分层展示**：从上到下：特征本体 → 宿主本体 → 疾病本体 → 治疗本体
- **重点突出**：特征本体和疾病本体提供快速编辑入口（影响VLM研判）
- **简洁实用**：不过度设计，关键是把该展示的信息清晰展示出来

---

## 第1部分：深度分析结果

### 1.1 本体类型梳理

基于对现有数据的分析，PhytoOracle系统需要以下本体类型：

#### 核心本体（影响VLM研判）

| 本体类型 | 英文名 | 变化频率 | 作用 | 当前状态 |
|---------|--------|---------|------|---------|
| **特征本体** | Feature Ontology | ⚡⚡⚡ 极高 | 定义VLM可观察的视觉特征维度（Q1-Q6） | ✅ 已完成 |
| **疾病本体** | Disease Ontology | ⚡⚡⚡ 极高 | 定义疾病的特征向量、重要性权重、诊断规则 | ✅ 2种完整 |

**为什么变化频率高？**
- 特征本体：VLM提示词优化需要调整特征维度定义、视觉线索描述
- 疾病本体：根据试验反馈调整特征期望值、权重配置、模糊匹配规则

#### 辅助本体（支持知识关联）

| 本体类型 | 英文名 | 变化频率 | 作用 | 当前状态 |
|---------|--------|---------|------|---------|
| **宿主本体** | Host/Plant Ontology | ⚡ 低 | 定义花卉种属特征，支持Q0.2识别和候选疾病剪枝 | ✅ 已完成 |
| **治疗本体** | Treatment Ontology | ⚡ 低 | 定义治疗方案与疾病的对应关系 | ⚠️ 未实现 |

#### 还缺哪些本体？

根据FlowerSpecialist方法论和试验数据分析，当前本体已足够。未来可扩展：

| 本体类型 | 优先级 | 用途 | 实现时机 |
|---------|-------|------|---------|
| **环境本体** | 中 | 定义气候、季节、地理环境因素（影响疾病流行度） | v1.2+ |
| **传播本体** | 低 | 定义传播途径、媒介、传播速度 | v1.3+ |
| **发展阶段本体** | 低 | 定义疾病的早期、中期、晚期症状演化 | v1.3+ |

**结论**：当前4类本体已足够支持MVP诊断，不需要新增本体类型。

---

### 1.2 本体维度框架设计

#### 1.2.1 特征本体维度框架

基于`feature_ontology.json`分析，特征本体包含**8个维度**（dimensions）：

```json
{
  "dimensions": {
    "symptom_type": {
      "type": "enum",
      "description": "症状类型（基于植物病理学分类）",
      "values": ["necrosis_spot", "necrosis_blotch", "chlorosis",
                 "powdery_coating", "downy_coating", "rust_pustule", "bacterial_spot"],
      "value_definitions": {
        "necrosis_spot": {
          "cn_term": "坏死斑点",
          "pathology": "细胞死亡形成的局部病斑",
          "vlm_description": "小型圆形或近圆形的褐色或黑色斑点，组织干燥、皱缩或塌陷",
          "visual_metaphors": ["像被香烟烫过留下的焦痕", "像纸张被火星烧出的小洞边缘"]
        }
        // ... 其他取值定义
      }
    },
    "color_center": {...},  // 症状中心颜色（10个取值）
    "color_border": {...},  // 症状边缘颜色（6个取值）
    "location": {...},      // 症状发生的解剖位置（4个取值）
    "size": {...},          // 单个病斑大小（6个取值）
    "distribution": {...},  // 症状的空间分布模式（5个取值）
    "coverage": {...}       // 症状覆盖度（4个取值）
  },

  "fuzzy_matching": {
    "color_aliases": {...},      // 颜色别名映射
    "size_tolerance": {...},     // 大小容差
    "synonym_mapping": {...}     // 症状同义词映射
  }
}
```

**维度框架总结**：
- **维度数量**：8个（symptom_type, color_center, color_border, location, size, distribution, coverage, texture）
- **维度类型**：全部为枚举类型（enum），取值范围严格定义
- **维度定义**：每个取值包含中英文术语、病理学解释、VLM描述、视觉隐喻
- **模糊匹配**：颜色别名、大小容差、症状同义词

**是否合理？** ✅ 非常合理
- 维度设计基于植物病理学专业知识
- 每个维度对应VLM可观察的视觉特征
- 维度粒度适中（不过粗也不过细）
- 模糊匹配规则考虑了VLM识别的不确定性

**需要改进的地方**：
1. **缺少维度间的依赖关系**：例如symptom_type=powdery_coating时，color_center应限制为white/grayish_white
2. **缺少维度的重要性标记**：哪些维度是核心维度（必须提取），哪些是可选维度

---

#### 1.2.2 宿主本体维度框架

基于`associations.json`分析，宿主本体包含**3个维度**：

```json
{
  "host_genus": "Rosa",
  "genus_name": "蔷薇属",
  "family": "Rosaceae",
  "diseases": [
    {
      "disease_id": "rose_black_spot",
      "prevalence": "common",     // 流行度
      "specificity": "genus"      // 专一性（genus/species/family）
    }
  ]
}
```

**维度框架总结**：
- **基本信息**：种属名（genus）、中文名、英文名、科（family）
- **植物学特征**：叶片形态、茎特征、花朵特征（用于Q0.2识别）
- **关联疾病**：疾病列表、流行度、专一性

**是否合理？** ✅ 基本合理，但可扩展
- 当前仅用于Q0.2识别和候选疾病剪枝，功能单一
- 未来可扩展：生长习性、栽培难度、适宜环境

---

#### 1.2.3 疾病本体维度框架

基于`rose_black_spot.json`和`cherry_powdery_mildew.json`分析，疾病本体包含**6大部分**：

```json
{
  "version": "4.1",
  "disease_id": "rose_black_spot",
  "disease_name": "玫瑰黑斑病",
  "pathogen": "Diplocarpon rosae（真菌）",

  "feature_vector": {
    "symptom_type": "necrosis_spot",
    "color_center": ["black", "brown", "dark_brown"],  // 允许多个值
    "color_border": ["yellow", "light_yellow"],
    "location": ["lamina", "petiole"],
    "size": "medium",
    "distribution": "scattered"
  },

  "feature_importance": {
    "major_features": {
      "_weight": 0.8,
      "features": [
        {
          "dimension": "symptom_type",
          "expected_values": ["necrosis_spot"],
          "weight": 0.5,
          "description": "坏死性斑点是黑斑病的核心症状类型"
        },
        {
          "dimension": "color_border",
          "expected_values": ["yellow", "light_yellow", "halo_yellow"],
          "weight": 0.3,
          "description": "黄色晕圈是Rose Black Spot的KEY诊断特征"
        }
      ]
    },
    "minor_features": {...},
    "optional_features": {...}
  },

  "diagnosis_rules": {
    "confirmed": [
      {
        "rule_id": "R1",
        "logic": "major_features >= 2/2",
        "confidence": 0.95
      }
    ],
    "suspected": [...]
  },

  "visual_descriptions": {
    "overall": "叶片上有黑色或深褐色的圆形坏死斑点，【关键特征】每个斑点外围通常有明显的黄色晕圈",
    "color_border": "观察斑点边缘，寻找像煎蛋蛋白环绕蛋黄的黄色晕圈",
    "early_stage": "小的褐色斑点（针尖大小），可能无明显晕圈",
    "middle_stage": "斑点扩大至中等大小，黄色晕圈明显",
    "late_stage": "斑点融合成大片坏死区域，可能导致叶片脱落"
  },

  "host_plants": ["Rosa"],

  "typical_symptoms": [
    "叶片出现圆形或近圆形的黑色坏死斑点",
    "斑点外围有明显的黄色晕圈（KEY特征）"
  ]
}
```

**维度框架总结**：
1. **元数据**：版本号、疾病ID、名称、病原体
2. **特征向量**：对应特征本体的8个维度，定义该疾病的期望特征值
3. **特征重要性**：分主要/次要/可选三级，每个特征有权重和描述
4. **诊断规则**：confirmed和suspected两级规则，基于特征匹配度
5. **视觉描述**：供人类理解和VLM参考的自然语言描述
6. **宿主植物**：关联的花卉种属

**是否合理？** ✅ 非常合理
- 特征向量与特征本体严格对应
- 特征重要性分级符合医学诊断逻辑（主要症状、次要症状）
- 诊断规则清晰量化（置信度阈值）
- 视觉描述提供人类可理解的补充说明

**需要改进的地方**：
1. **缺少疾病发展阶段**：early/middle/late应该有独立的特征向量
2. **缺少鉴别诊断**：与相似疾病的区别特征应单独定义

---

#### 1.2.4 治疗本体维度框架（未实现，提出建议）

基于疾病诊断系统的完整性，治疗本体应包含：

```json
{
  "treatment_id": "copper_fungicide_spray",
  "treatment_name": "铜制剂喷雾",
  "treatment_type": "chemical",  // chemical/biological/physical/cultural

  "applicable_diseases": [
    {
      "disease_id": "rose_black_spot",
      "effectiveness": "high",      // high/medium/low
      "timing": "preventive",       // preventive/curative/both
      "stage": ["early", "middle"]  // 适用疾病阶段
    }
  ],

  "active_ingredients": [
    {
      "name": "氢氧化铜",
      "concentration": "77%",
      "mode_of_action": "接触性杀菌"
    }
  ],

  "application": {
    "dosage": "1:1000稀释",
    "frequency": "每7-10天",
    "method": "叶面喷雾",
    "precautions": ["避免在强光下施药", "避免与碱性农药混用"]
  },

  "safety": {
    "toxicity_level": "low",
    "withdrawal_period": "7天",
    "environmental_impact": "轻度"
  }
}
```

**建议实现优先级**：P4阶段（前端开发时）

---

### 1.3 诊断逻辑深度理解

#### 1.3.1 VLM如何使用本体进行研判？

基于对提示词框架和试验数据的分析，诊断流程如下：

```
阶段1：前置过滤（Q0.0 - Q0.5）
┌─────────────────────────────────────────────────────────┐
│ Q0.0: 内容类型识别                                       │
│   Input: 原始图片                                       │
│   Prompt: "Is this image a plant/animal/person/object?"│
│   Output: "plant" (✓ 通过) / "animal" (✗ 终止)        │
│   本体依赖: 无（固定选项）                               │
├─────────────────────────────────────────────────────────┤
│ Q0.1: 植物类别识别                                       │
│   Input: 通过Q0.0的图片                                 │
│   Prompt: "Is this flower/vegetable/tree/grass?"      │
│   Output: "flower" (✓ 通过) / "tree" (✗ 终止)         │
│   本体依赖: 无（固定选项）                               │
├─────────────────────────────────────────────────────────┤
│ Q0.2: 花卉种属识别 ⚡ 核心步骤                           │
│   Input: 通过Q0.1的花卉图片                             │
│   Prompt: 基于 宿主本体 生成的复合特征描述              │
│     "Rosa: Compound leaves with 5-7 leaflets, thorny  │
│      stems, layered petals in spiral pattern"        │
│   Output: "Rosa" / "Prunus" / "unknown"               │
│   本体依赖: 宿主本体 (Host Ontology)                    │
│   作用: 候选疾病剪枝（Rosa → 只匹配rose_*疾病）          │
├─────────────────────────────────────────────────────────┤
│ Q0.3: 器官识别                                           │
│   Output: "leaf" / "flower" / "both"                  │
│   本体依赖: 无（固定选项，但未来可扩展器官本体）          │
├─────────────────────────────────────────────────────────┤
│ Q0.4: 完整性检查                                         │
│   Output: "complete" / "partial" / "close_up"         │
│   本体依赖: 无                                          │
├─────────────────────────────────────────────────────────┤
│ Q0.5: 异常判断 ⚡ 核心步骤                               │
│   Input: 通过Q0.2-Q0.4的图片                           │
│   Prompt: "Does this organ show abnormality/disease?" │
│   Output: "abnormal" (✓ 进入Q1-Q6) / "healthy" (✗ 终止)│
│   本体依赖: 无（但应基于疾病本体的典型症状描述）          │
└─────────────────────────────────────────────────────────┘

阶段2：特征提取（Q1 - Q6）⚡⚡⚡ 核心阶段
┌─────────────────────────────────────────────────────────┐
│ Q1: 症状类型识别 (symptom_type)                          │
│   Input: 通过Q0.5的异常图片                             │
│   Prompt: 基于 特征本体.dimensions.symptom_type 生成    │
│     Visual Clues:                                      │
│       - necrosis_spot: "Dark spots with dead tissue   │
│         (black/brown), clearly defined borders"       │
│       - powdery_coating: "White/gray powdery substance│
│         covering surface, looks like powder/flour"    │
│     Visual Metaphors (from feature_ontology.json):    │
│       - necrosis_spot: "像被香烟烫过留下的焦痕"         │
│   Output: "necrosis_spot" / "powdery_coating" / ...   │
│   本体依赖: 特征本体.dimensions.symptom_type            │
├─────────────────────────────────────────────────────────┤
│ Q2-Q6: 其他特征维度提取                                  │
│   Q2: color_center (症状中心颜色)                       │
│   Q3: color_border (症状边缘颜色) ⚡ Rose Black Spot KEY│
│   Q4: size (症状尺寸)                                   │
│   Q5: location (症状位置)                               │
│   Q6: distribution (分布模式)                           │
│                                                         │
│   每个维度的Prompt都从 特征本体.dimensions[维度名] 生成  │
│   包含：视觉线索、视觉隐喻、选项定义                      │
└─────────────────────────────────────────────────────────┘

阶段3：特征匹配与加权评分 ⚡⚡⚡ 核心阶段
┌─────────────────────────────────────────────────────────┐
│ Layer 1: 宿主过滤                                        │
│   根据Q0.2识别的种属（如Rosa），从 宿主-疾病关联本体     │
│   获取候选疾病列表                                       │
│   Rosa → [rose_black_spot, rose_powdery_mildew, ...]  │
├─────────────────────────────────────────────────────────┤
│ Layer 2: 特征匹配                                        │
│   对每个候选疾病：                                       │
│     1. 从 疾病本体.feature_vector 读取期望特征值         │
│     2. 与VLM提取的特征值进行匹配                         │
│     3. 完全匹配 ✓ / 模糊匹配 ~ / 未匹配 ✗               │
│                                                         │
│   模糊匹配规则从 特征本体.fuzzy_matching 读取：          │
│     - color_aliases: {"dark_color": ["black", "brown"]}│
│     - size_tolerance: ±1级别                           │
│     - synonym_mapping: {"spot": ["necrosis_spot"]}    │
├─────────────────────────────────────────────────────────┤
│ Layer 3: 加权评分                                        │
│   从 疾病本体.feature_importance 读取权重配置：          │
│     - major_features: 权重80% (symptom_type=50%, ...)  │
│     - minor_features: 权重15%                          │
│     - optional_features: 权重5%                        │
│                                                         │
│   计算总分 = Σ(匹配得分 × 特征权重)                      │
│                                                         │
│   根据 疾病本体.diagnosis_rules 判定置信度：             │
│     - confirmed: major_features >= 2/2 → 95%置信度     │
│     - suspected: major_features >= 1/2 → 60%置信度     │
└─────────────────────────────────────────────────────────┘

阶段4：诊断结果输出
┌─────────────────────────────────────────────────────────┐
│ 输出内容：                                               │
│   - 疾病名称（从 疾病本体.disease_name）                 │
│   - 置信度（Layer 3计算）                                │
│   - 推理依据（匹配成功的特征列表）                        │
│   - 视觉描述（从 疾病本体.visual_descriptions）          │
│   - 治疗建议（从 治疗本体，待实现）                       │
└─────────────────────────────────────────────────────────┘
```

**关键发现**：
1. **特征本体是VLM提示词的唯一数据源**（Q1-Q6的Prompt完全基于特征本体生成）
2. **疾病本体是诊断逻辑的核心**（特征向量、权重、规则都在这里定义）
3. **宿主本体用于候选疾病剪枝**（提高匹配效率，减少误判）
4. **模糊匹配规则在特征本体定义**（但疾病本体可覆盖默认规则）

---

#### 1.3.2 试验数据反映的问题

基于`v10_rose_black_spot_FINAL_test_report.md`的分析：

**成功案例**：
- Location维度：83.3%准确率 ✅（TermMapper bug修复后正常工作）
- Symptom_type维度：75.0%准确率 ✅（VLM能够识别大部分坏死斑点）

**失败案例及改进方向**：

| 维度 | 准确率 | 主要问题 | 改进方向 | 涉及本体 |
|------|-------|---------|---------|---------|
| **color_border** | 58.3% | VLM对"黄色晕圈"识别不稳定，5次误判为"no_special" | 优化Prompt中的视觉隐喻："像月亮周围的黄色光晕" | 特征本体 |
| **color_center** | 41.7% | VLM观察到brown（合理），但知识库只有black | 疾病本体应允许["black", "brown"] | 疾病本体 |
| **size** | 8.3% | VLM系统性偏小估计 | 调整size维度的视觉线索描述 | 特征本体 |

**这些问题都需要在知识管理界面中快速修改本体配置！**

---

#### 1.3.3 需要给客户展示的信息

基于诊断逻辑和用户需求，界面1（单图诊断展示页）应展示：

```
┌─ 诊断结果 ──────────────────────────────────────┐
│ 疾病名称：玫瑰黑斑病                             │
│ 置信度：95%                                     │
│ 病原体：Diplocarpon rosae                       │
│                                                 │
│ 推理依据：                                       │
│ • 症状类型：坏死斑点 ✓                          │
│ • 边缘颜色：黄色晕圈 ✓ (KEY特征)               │
│ • 中心颜色：黑色 ✓                              │
│ • 发病位置：叶片 ✓                              │
├─────────────────────────────────────────────────┤
│ 治疗建议：                                       │
│ • 清除病叶，减少侵染源                           │
│ • 喷施铜制剂（氢氧化铜1:1000稀释）               │
│ • 每7-10天喷施一次，连续3-4次                   │
│ • 注意事项：避免在强光下施药                     │
└─────────────────────────────────────────────────┘
```

**信息来源**：
- 疾病名称、病原体：疾病本体
- 置信度：加权评分器计算
- 推理依据：特征匹配器结果
- 治疗建议：治疗本体（待实现）

**知识管理界面需要支持编辑这些信息的来源！**

---

### 1.4 统一知识管理结构设计

#### 1.4.1 问题分析

当前4类本体（特征、宿主、疾病、治疗）的共性和差异：

**共性**：
1. 都有元数据（版本、ID、名称、描述）
2. 都有维度定义（dimensions/fields）
3. 都有实例集合（values/entries/diseases/treatments）
4. 都有关系映射（与其他本体的关联）

**差异**：
1. **粒度不同**：
   - 特征本体：定义维度（如symptom_type），每个维度有多个取值
   - 疾病本体：定义实例（如rose_black_spot），每个实例有特征向量
2. **用途不同**：
   - 特征本体：供VLM提示词生成
   - 疾病本体：供诊断匹配引擎
3. **变化性不同**：
   - 特征本体：维度定义稳定，取值可能增加
   - 疾病本体：实例频繁增加，权重需要调优

#### 1.4.2 统一结构模板

基于上述分析，设计统一的知识管理结构：

```typescript
// 统一知识结构模板
interface OntologyEntity {
  // 第1层：元数据（所有本体共有）
  metadata: {
    id: string;                    // 唯一标识
    name: string;                  // 显示名称
    name_en?: string;              // 英文名称
    type: "feature" | "host" | "disease" | "treatment";  // 本体类型
    version: string;               // 版本号
    last_updated: string;          // 最后更新时间
    description: string;           // 描述
    tags?: string[];               // 标签（如"叶部病害"、"真菌病害"）
  };

  // 第2层：维度定义（特征本体）或字段定义（其他本体）
  schema: {
    dimensions?: Dimension[];      // 特征本体的维度定义
    fields?: Field[];              // 疾病/宿主/治疗本体的字段定义
  };

  // 第3层：实例数据
  instances: {
    // 特征本体：维度的取值定义
    values?: {
      [dimensionName: string]: ValueDefinition[];
    };

    // 疾病/宿主/治疗本体：实体实例
    entries?: Entity[];
  };

  // 第4层：关系映射
  relations: {
    // 与其他本体的关系
    dependencies?: string[];       // 依赖的本体ID
    associations?: Association[];  // 关联关系
  };

  // 第5层：配置规则
  rules?: {
    fuzzy_matching?: FuzzyRule[];  // 模糊匹配规则
    validation?: ValidationRule[]; // 验证规则
    constraints?: Constraint[];    // 约束条件
  };
}
```

**统一结构的优势**：
1. **一致的编辑体验**：所有本体使用相同的界面组件
2. **统一的验证逻辑**：Schema验证、关系完整性检查
3. **易于扩展**：新增本体类型只需实现接口
4. **便于版本控制**：统一的JSON结构，Git diff清晰

---

#### 1.4.3 不同本体如何适配统一结构

**特征本体适配示例**：

```json
{
  "metadata": {
    "id": "feature_ontology",
    "name": "特征本体",
    "type": "feature",
    "version": "1.0",
    "description": "定义VLM可观察的视觉特征维度"
  },

  "schema": {
    "dimensions": [
      {
        "name": "symptom_type",
        "type": "enum",
        "description": "症状类型（基于植物病理学分类）",
        "required": true,
        "used_in": ["Q1提示词生成", "疾病特征向量"]
      },
      {
        "name": "color_border",
        "type": "enum",
        "description": "症状边缘颜色特征",
        "required": false,
        "used_in": ["Q3提示词生成", "疾病特征向量"]
      }
    ]
  },

  "instances": {
    "values": {
      "symptom_type": [
        {
          "value": "necrosis_spot",
          "cn_term": "坏死斑点",
          "en_term": "Necrotic spot",
          "pathology": "细胞死亡形成的局部病斑",
          "vlm_description": "小型圆形或近圆形的褐色或黑色斑点",
          "visual_metaphors": ["像被香烟烫过留下的焦痕"]
        }
      ]
    }
  },

  "rules": {
    "fuzzy_matching": [
      {
        "type": "color_alias",
        "mapping": {"dark_color": ["black", "dark_brown", "brown"]}
      }
    ]
  }
}
```

**疾病本体适配示例**：

```json
{
  "metadata": {
    "id": "rose_black_spot",
    "name": "玫瑰黑斑病",
    "name_en": "Rose Black Spot",
    "type": "disease",
    "version": "4.1",
    "description": "由Diplocarpon rosae引起的真菌病害",
    "tags": ["叶部病害", "真菌病害", "玫瑰"]
  },

  "schema": {
    "fields": [
      {"name": "pathogen", "type": "string", "description": "病原体学名"},
      {"name": "feature_vector", "type": "object", "description": "特征向量"},
      {"name": "feature_importance", "type": "object", "description": "特征重要性"}
    ]
  },

  "instances": {
    "entries": [
      {
        "pathogen": "Diplocarpon rosae（真菌）",
        "feature_vector": {
          "symptom_type": "necrosis_spot",
          "color_border": ["yellow", "light_yellow"]
        },
        "feature_importance": {
          "major_features": [
            {
              "dimension": "color_border",
              "weight": 0.3,
              "description": "黄色晕圈是KEY诊断特征"
            }
          ]
        }
      }
    ]
  },

  "relations": {
    "dependencies": ["feature_ontology"],  // 依赖特征本体
    "associations": [
      {"type": "host", "target": "Rosa", "specificity": "genus"}
    ]
  }
}
```

**宿主本体适配示例**：

```json
{
  "metadata": {
    "id": "host_rosa",
    "name": "蔷薇属",
    "name_en": "Rosa",
    "type": "host",
    "version": "1.0"
  },

  "schema": {
    "fields": [
      {"name": "family", "type": "string", "description": "科"},
      {"name": "morphology", "type": "object", "description": "形态特征"}
    ]
  },

  "instances": {
    "entries": [
      {
        "family": "Rosaceae",
        "morphology": {
          "leaf": "Compound leaves with 5-7 leaflets",
          "stem": "Thorny/prickly stems",
          "flower": "Layered petals in spiral pattern"
        }
      }
    ]
  },

  "relations": {
    "associations": [
      {"type": "disease", "target": "rose_black_spot", "prevalence": "common"}
    ]
  }
}
```

---

## 第2部分：界面4新布局设计

### 2.1 设计原则

1. **分层展示**：从上到下依次展示特征本体 → 宿主本体 → 疾病本体 → 治疗本体
2. **突出重点**：特征本体和疾病本体提供快速编辑入口（大按钮、快捷键）
3. **统一操作**：所有本体使用相同的"查看/编辑/验证/保存"流程
4. **关系可视**：点击某个疾病，高亮显示其依赖的特征维度和宿主

### 2.2 界面布局（ASCII图）

```
┌─────────────────────────────────────────────────────────────────────┐
│  PhytoOracle - 知识管理                [新建本体] [导入] [导出全部]  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 📊 本体总览                                                      ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 特征本体: 8维度 ✅   宿主本体: 5种属 ✅                          ││
│  │ 疾病本体: 2疾病 ⚠️   治疗本体: 未实现 ❌                         ││
│  │                                                                  ││
│  │ 最后更新: 2025-11-12  |  待验证: 3项  |  待同步: 0项             ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 🔬 特征本体 (Feature Ontology)           ⚡ 影响VLM研判 (极高频) ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 版本: 1.0  |  最后更新: 2025-11-12  |  依赖: 无                 ││
│  │ 描述: 定义VLM可观察的视觉特征维度（Q1-Q6提示词数据源）          ││
│  │                                                                  ││
│  │ 维度总览 (8个维度):                                              ││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ symptom_type (症状类型) ⚡ 主要特征                          │││
│  │ │ 取值: 7个 | 类型: enum | 用于: Q1提示词                      │││
│  │ │ ├─ necrosis_spot (坏死斑点) - "像被香烟烫过的焦痕"           │││
│  │ │ ├─ powdery_coating (白粉覆盖) - "像撒了面粉"                 │││
│  │ │ ├─ chlorosis (失绿/黄化)                                    │││
│  │ │ └─ ... [展开全部]                        [编辑] [添加取值]   │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ color_border (边缘颜色) ⚡ 主要特征                          │││
│  │ │ 取值: 6个 | 类型: enum | 用于: Q3提示词                      │││
│  │ │ ├─ halo_yellow (黄色晕圈) - "像月亮周围的黄色光晕" ⚠️ 待优化  │││
│  │ │ ├─ no_special (无特殊边缘)                                   │││
│  │ │ └─ ... [折叠]                            [编辑] [添加取值]   │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ color_center, location, size, distribution, coverage (6个)   │││
│  │ │ [点击展开查看详情]                                            │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ 模糊匹配规则 (3类):                                              ││
│  │ • 颜色别名: dark_color→[black, brown]                            ││
│  │ • 大小容差: ±1级别                                               ││
│  │ • 症状同义词: spot→[necrosis_spot, bacterial_spot]              ││
│  │                                                    [编辑规则]    ││
│  │                                                                  ││
│  │ [快速编辑症状类型] [快速编辑边缘颜色] [批量导出] [验证完整性]   ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 🌸 宿主本体 (Host/Plant Ontology)                        (低频)  ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 版本: 1.0  |  最后更新: 2025-11-12  |  依赖: 无                 ││
│  │ 描述: 定义花卉种属特征，用于Q0.2识别和候选疾病剪枝               ││
│  │                                                                  ││
│  │ 宿主总览 (5种属):                                                ││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ Rosa (蔷薇属) | 科: Rosaceae | 关联疾病: 4种                 │││
│  │ │ 形态特征: 复叶5-7小叶、茎有刺、花瓣层叠螺旋排列               │││
│  │ │ 关联疾病: rose_black_spot (常见) ✓, rose_powdery_mildew ✓   │││
│  │ │           [查看详情] [编辑] [查看关联疾病]                    │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ Prunus, Tulipa, Dianthus, Paeonia (4种属)                   │││
│  │ │ [点击展开查看详情]                                            │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ [添加新宿主] [批量导入] [导出宿主-疾病关联图]                    ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 🦠 疾病本体 (Disease Ontology)           ⚡ 影响VLM研判 (极高频) ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 版本: 4.1  |  最后更新: 2025-11-12  |  依赖: 特征本体           ││
│  │ 描述: 定义疾病的特征向量、重要性权重、诊断规则                   ││
│  │                                                                  ││
│  │ 疾病总览 (2种疾病 / 目标18-24种):                                ││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ rose_black_spot (玫瑰黑斑病) | 宿主: Rosa | 类型: 真菌       │││
│  │ │ 病原体: Diplocarpon rosae                                    │││
│  │ │                                                               │││
│  │ │ 特征向量 (6维度):                                             │││
│  │ │   symptom_type: necrosis_spot ✓                              │││
│  │ │   color_center: [black, brown] ⚠️ 试验发现需增加brown         │││
│  │ │   color_border: [yellow, light_yellow] (主要特征 50%)        │││
│  │ │   location: [lamina, petiole]                                │││
│  │ │   size: medium                                                │││
│  │ │   distribution: scattered                                     │││
│  │ │                                                               │││
│  │ │ 特征重要性 (3级):                                             │││
│  │ │   ⚡ 主要特征 (80%): symptom_type(50%), color_border(30%)     │││
│  │ │   ○ 次要特征 (15%): color_center(10%), location(5%)          │││
│  │ │   · 可选特征 (5%): size(3%), distribution(2%)                │││
│  │ │                                                               │││
│  │ │ 诊断规则:                                                     │││
│  │ │   ✓ 确诊 (≥95%): 主要特征 >= 2/2                             │││
│  │ │   ~ 疑似 (≥60%): 主要特征 >= 1/2                             │││
│  │ │                                                               │││
│  │ │ [查看视觉描述] [编辑特征向量] [调整权重] [测试诊断规则]       │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ ┌──────────────────────────────────────────────────────────────┐││
│  │ │ cherry_powdery_mildew (樱桃白粉病)                           │││
│  │ │ [点击展开查看详情]                                            │││
│  │ └──────────────────────────────────────────────────────────────┘││
│  │                                                                  ││
│  │ [添加新疾病] [从模板创建] [批量导入] [导出权重配置]              ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 💊 治疗本体 (Treatment Ontology)                         (低频)  ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 状态: 未实现 ❌                                                  ││
│  │ 说明: 定义治疗方案与疾病的对应关系、用药方法、注意事项           ││
│  │                                                                  ││
│  │ [创建治疗本体] [从模板开始] [查看设计文档]                       ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ 🔗 关系视图                                             [切换到关系图] ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │ 当前选中: rose_black_spot                                        ││
│  │                                                                  ││
│  │ 依赖关系:                                                        ││
│  │   特征本体 → symptom_type.necrosis_spot (使用)                   ││
│  │            → color_border.halo_yellow (使用，权重30%)            ││
│  │   宿主本体 → Rosa (关联，常见病害)                               ││
│  │                                                                  ││
│  │ 关联的治疗方案: (待实现)                                         ││
│  │   治疗本体 → copper_fungicide_spray (推荐，有效性高)             ││
│  │                                                                  ││
│  │ [查看完整关系图] [验证依赖完整性]                                ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
```

### 2.3 布局说明

#### 2.3.1 顶部总览区

- **功能**：快速展示4类本体的健康状态
- **指标**：
  - 特征本体：维度数量（目标8个）
  - 宿主本体：种属数量（当前5个）
  - 疾病本体：疾病数量（当前2个，目标18-24个）
  - 治疗本体：实现状态
- **状态标识**：
  - ✅ 完成且验证通过
  - ⚠️ 完成但有待优化项
  - ❌ 未实现

#### 2.3.2 特征本体区（第1部分）

**为什么放在最上面？**
- 特征本体是VLM提示词的唯一数据源
- 变化频率最高（根据试验反馈优化视觉线索、隐喻）
- 影响所有疾病的诊断准确率

**展示内容**：
1. **维度列表**（可折叠）
   - 维度名称、中文名、取值数量
   - 用途说明（用于哪个Q问题）
   - 重要性标记（⚡ 主要特征维度）
2. **维度详情**（点击展开）
   - 所有取值的定义（中英文术语、病理学解释、VLM描述、视觉隐喻）
   - 待优化标记（⚠️ 如color_border的halo_yellow描述不够清晰）
3. **模糊匹配规则**
   - 颜色别名、大小容差、症状同义词
4. **快速操作**
   - [快速编辑症状类型]：直接跳转到symptom_type编辑器
   - [快速编辑边缘颜色]：直接跳转到color_border编辑器（高频修改）
   - [批量导出]：导出提示词配置JSON
   - [验证完整性]：检查所有维度的取值定义是否完整

#### 2.3.3 宿主本体区（第2部分）

**为什么放在第二？**
- 宿主本体影响Q0.2识别和候选疾病剪枝
- 变化频率低（新增花卉种属不频繁）
- 但需要展示与疾病本体的关联关系

**展示内容**：
1. **宿主列表**（可折叠）
   - 种属名称、科、关联疾病数量
   - 形态特征摘要
2. **宿主详情**（点击展开）
   - 完整的形态特征描述（用于Q0.2提示词）
   - 关联疾病列表（disease_id + prevalence）
3. **快速操作**
   - [添加新宿主]：从模板创建新宿主
   - [批量导入]：批量导入宿主-疾病关联
   - [导出宿主-疾病关联图]：可视化关系图

#### 2.3.4 疾病本体区（第3部分）

**为什么放在第三？**
- 疾病本体是诊断逻辑的核心
- 变化频率极高（新增疾病、调整权重、优化特征向量）
- 需要清晰展示特征向量和权重配置

**展示内容**：
1. **疾病列表**（可折叠）
   - 疾病名称、宿主、病原体类型
   - 进度标记（当前2种 / 目标18-24种）
2. **疾病详情**（点击展开）
   - **特征向量**：6个维度的期望值
     - 高亮显示与特征本体的对应关系
     - 标记待优化项（⚠️ 如color_center需增加brown）
   - **特征重要性**：主要/次要/可选三级分类
     - 每个特征的权重百分比
     - 权重配置的合理性提示
   - **诊断规则**：确诊和疑似规则
     - 规则逻辑（如"major_features >= 2/2"）
     - 置信度阈值
3. **快速操作**
   - [编辑特征向量]：表单式编辑（下拉框选择特征值）
   - [调整权重]：滑块调整权重（实时预览总分）
   - [测试诊断规则]：上传测试图片，验证诊断逻辑
   - [从模板创建]：基于现有疾病创建新疾病

#### 2.3.5 治疗本体区（第4部分）

**为什么放在最后？**
- 治疗本体是诊断结果的补充（不影响诊断逻辑）
- 当前未实现，优先级低
- 需要预留扩展空间

**展示内容**：
- 未实现状态说明
- 提供创建入口和设计文档链接

#### 2.3.6 底部关系视图区

**功能**：
- 当点击某个疾病时，底部展示其依赖的本体关系
- 可视化关系图（疾病 → 特征维度 → 宿主 → 治疗）
- 验证依赖完整性（如疾病引用的特征值是否在特征本体中定义）

---

## 第3部分：功能详细说明

### 3.1 核心功能

#### 3.1.1 本体查看

**功能描述**：
- 按类型浏览本体（特征/宿主/疾病/治疗）
- 查看本体的元数据、维度/字段定义、实例数据
- 查看本体间的关系映射

**交互流程**：
1. 用户进入知识管理页，默认显示4类本体的总览
2. 用户点击某个本体区域（如"特征本体"），展开详情
3. 用户点击某个维度（如"symptom_type"），展开取值列表
4. 用户查看取值定义（中英文术语、VLM描述、视觉隐喻）

**技术实现**：
- 前端：手风琴组件（Accordion），点击展开/折叠
- 后端API：`GET /api/knowledge/ontology/{type}`

---

#### 3.1.2 本体编辑

**功能描述**：
- 编辑本体的元数据（版本号、描述）
- 编辑维度定义（特征本体）
- 编辑实例数据（疾病/宿主/治疗本体）
- 编辑模糊匹配规则和验证规则

**交互流程（以疾病本体为例）**：
1. 用户点击某个疾病的"编辑特征向量"按钮
2. 系统弹出表单编辑器，显示6个特征维度的下拉框
3. 用户修改color_center的期望值：从["black"]改为["black", "brown"]
4. 系统实时验证（brown是否在特征本体的color_center.values中定义）
5. 验证通过后，用户点击"保存"
6. 系统保存JSON文件，更新版本号，记录变更日志

**技术实现**：
- 前端：动态表单组件（基于JSON Schema生成表单）
- 后端API：`PUT /api/knowledge/ontology/{type}/{id}`
- 验证逻辑：
  - JSON Schema验证（格式正确性）
  - 引用完整性验证（如疾病引用的特征值必须在特征本体中存在）
  - 业务规则验证（如权重总和必须为1.0）

---

#### 3.1.3 快速编辑（高频修改优化）

**功能描述**：
- 针对高频修改的维度，提供快捷编辑入口
- 特征本体：symptom_type、color_border（根据试验反馈优化）
- 疾病本体：feature_vector、feature_importance

**交互流程（以color_border为例）**：
1. 用户点击特征本体区的"快速编辑边缘颜色"按钮
2. 系统打开侧边栏编辑器，显示color_border的所有取值
3. 用户点击"halo_yellow"取值，修改VLM描述：
   - 原描述："病斑周围有黄色晕染区域"
   - 新描述："病斑周围有黄色晕圈，像月亮周围的光晕，或煎蛋蛋白环绕蛋黄"
4. 用户添加新的视觉隐喻："像手电筒照射时周围的黄色光圈"
5. 用户点击"保存并生成提示词"
6. 系统保存feature_ontology.json，重新生成Q3提示词，显示预览

**技术实现**：
- 前端：侧边栏编辑器（Drawer组件）
- 实时预览：调用提示词生成器，显示新Prompt
- 后端API：`PUT /api/knowledge/feature-ontology/dimension/{name}/value/{value}`

---

#### 3.1.4 本体验证

**功能描述**：
- 验证本体的完整性、一致性、正确性
- 检查引用完整性（如疾病引用的特征值必须存在）
- 检查业务规则（如权重总和、置信度范围）

**验证规则**：

| 验证类型 | 检查项 | 示例 |
|---------|-------|------|
| **格式验证** | JSON格式正确 | 括号匹配、逗号正确 |
| **Schema验证** | 符合JSON Schema定义 | 必填字段存在、类型正确 |
| **引用完整性** | 疾病引用的特征值在特征本体中存在 | rose_black_spot.feature_vector.symptom_type="necrosis_spot"必须在feature_ontology.dimensions.symptom_type.values中定义 |
| **权重一致性** | 权重总和为1.0 | major(0.8) + minor(0.15) + optional(0.05) = 1.0 |
| **置信度范围** | 置信度在0-1之间 | diagnosis_rules.confirmed.confidence=0.95 ✓ |
| **循环依赖检查** | 本体间无循环依赖 | 特征本体 ← 疾病本体（允许），疾病本体 ← 特征本体（禁止） |

**交互流程**：
1. 用户点击"验证完整性"按钮
2. 系统执行所有验证规则，显示进度条
3. 验证完成后，显示结果：
   - ✅ 通过：所有检查项通过
   - ⚠️ 警告：非致命问题（如权重总和1.001，存在微小误差）
   - ❌ 错误：致命问题（如引用的特征值不存在）
4. 用户点击错误项，跳转到对应位置修复

**技术实现**：
- 前端：验证结果面板（按类型分组显示）
- 后端API：`POST /api/knowledge/validate`
- 验证引擎：基于JSON Schema + 自定义规则引擎

---

#### 3.1.5 本体关系可视化

**功能描述**：
- 可视化本体间的依赖关系和关联关系
- 高亮显示某个实例的所有相关本体
- 检测关系完整性（如孤立的疾病、未关联宿主的疾病）

**可视化类型**：

1. **依赖关系图**（树状图）
```
特征本体 (根节点)
  ↓ 被引用
疾病本体
  ├─ rose_black_spot
  │    ↓ 使用 symptom_type.necrosis_spot
  │    ↓ 使用 color_border.halo_yellow (权重30%)
  └─ cherry_powdery_mildew
       ↓ 使用 symptom_type.powdery_coating
```

2. **关联关系图**（网状图）
```
      Rosa (宿主)
        ↓ has_disease (common)
rose_black_spot (疾病)
        ↓ treated_by (high effectiveness)
copper_fungicide (治疗)
```

**交互流程**：
1. 用户点击底部"切换到关系图"按钮
2. 系统展示完整的本体关系图（使用D3.js或vis.js）
3. 用户点击某个疾病节点（如rose_black_spot）
4. 系统高亮显示：
   - 该疾病依赖的特征维度（symptom_type, color_border）
   - 该疾病关联的宿主（Rosa）
   - 该疾病对应的治疗方案（copper_fungicide）
5. 用户悬停某个特征维度，显示tooltip：
   - 被哪些疾病引用
   - 权重配置
   - 取值定义

**技术实现**：
- 前端：图可视化库（D3.js / vis.js / Cytoscape.js）
- 数据格式：节点（nodes）和边（edges）
- 后端API：`GET /api/knowledge/relations`

---

### 3.2 辅助功能

#### 3.2.1 批量导入/导出

**功能描述**：
- 批量导入JSON文件（支持拖拽上传）
- 批量导出本体配置（支持ZIP打包）
- 支持模板下载（新用户快速创建本体）

**导入流程**：
1. 用户点击"批量导入"按钮
2. 系统弹出文件上传对话框，支持拖拽多个JSON文件
3. 系统验证每个文件的格式和Schema
4. 显示验证结果列表（通过/失败）
5. 用户确认导入，系统保存文件并更新索引

**导出流程**：
1. 用户点击"导出全部"按钮
2. 系统打包所有本体JSON文件为ZIP
3. 包含manifest.json（版本号、导出时间、文件清单）
4. 用户下载ZIP文件

**技术实现**：
- 前端：文件上传组件（react-dropzone / vue-dropzone）
- 后端API：
  - `POST /api/knowledge/import` (multipart/form-data)
  - `GET /api/knowledge/export` (返回ZIP文件)

---

#### 3.2.2 版本控制

**功能描述**：
- 记录本体的每次修改（变更日志）
- 查看历史版本
- 回滚到指定版本
- 对比两个版本的差异

**数据结构**：
```json
{
  "version": "4.2",
  "last_updated": "2025-11-14T10:30:00Z",
  "changelog": {
    "v4.2": {
      "date": "2025-11-14",
      "author": "user@example.com",
      "changes": [
        "修改color_center期望值：增加brown",
        "优化color_border的VLM描述：增加视觉隐喻"
      ]
    },
    "v4.1": {
      "date": "2025-11-12",
      "changes": ["初始版本"]
    }
  }
}
```

**交互流程**：
1. 用户点击疾病本体的"查看历史"按钮
2. 系统显示版本时间线（v4.2 → v4.1 → v4.0）
3. 用户点击v4.1，查看该版本的完整JSON
4. 用户点击"对比v4.1和v4.2"，系统高亮显示差异
5. 用户点击"回滚到v4.1"，系统确认后恢复

**技术实现**：
- 后端：Git集成（自动提交本体JSON到Git仓库）
- 差异对比：使用diff算法（如google-diff-match-patch）
- 前端：版本时间线组件 + JSON差异高亮显示

---

#### 3.2.3 搜索与过滤

**功能描述**：
- 全局搜索（搜索所有本体的内容）
- 按类型过滤（只显示特定类型的本体）
- 按标签过滤（如"叶部病害"、"真菌病害"）
- 按依赖关系过滤（如"查找所有依赖symptom_type的疾病"）

**搜索示例**：
- 搜索"黄色晕圈"：找到特征本体的color_border.halo_yellow + 所有使用该特征的疾病
- 搜索"Rosa"：找到宿主本体的Rosa + 所有关联的疾病
- 搜索"真菌"：找到所有tags包含"真菌病害"的疾病

**技术实现**：
- 前端：搜索框 + 过滤器组件
- 后端API：`GET /api/knowledge/search?q={query}&type={type}&tags={tags}`
- 搜索引擎：全文搜索（Elasticsearch / PostgreSQL Full-Text Search）

---

## 第4部分：使用流程

### 4.1 典型使用场景

#### 场景1：根据试验反馈优化特征本体

**背景**：v10试验发现color_border的halo_yellow识别准确率仅58.3%，需要优化VLM描述。

**操作流程**：
1. 用户进入知识管理页，定位到"特征本体"区域
2. 点击"快速编辑边缘颜色"按钮
3. 在侧边栏编辑器中，点击"halo_yellow"取值
4. 修改VLM描述，增加视觉隐喻：
   - 添加："像月亮周围的黄色光晕"
   - 添加："像煎蛋蛋白环绕蛋黄的黄色环"
5. 点击"保存并生成提示词"
6. 查看Q3提示词预览，确认描述更清晰
7. 点击"验证完整性"，确保无错误
8. 点击"提交更改"，系统保存并记录变更日志
9. 重新运行试验，验证优化效果

**涉及本体**：特征本体
**修改文件**：`backend/knowledge_base/features/feature_ontology.json`
**变更日志**：v1.1 - 优化color_border.halo_yellow的VLM描述

---

#### 场景2：添加新疾病到知识库

**背景**：需要添加"玫瑰白粉病"（rose_powdery_mildew）到知识库。

**操作流程**：
1. 用户进入知识管理页，定位到"疾病本体"区域
2. 点击"从模板创建"按钮
3. 系统弹出模板选择对话框，用户选择"Powdery Mildew模板"
4. 系统基于cherry_powdery_mildew.json生成新模板
5. 用户填写表单：
   - disease_id: `rose_powdery_mildew`
   - disease_name: `玫瑰白粉病`
   - pathogen: `Podosphaera pannosa`
   - host_plants: `Rosa`（从宿主本体下拉选择）
6. 用户定义特征向量：
   - symptom_type: `powdery_coating`（从特征本体下拉选择）
   - color_center: `["white", "grayish_white"]`
   - color_border: `["no_special"]`
   - location: `["lamina", "shoot"]`
7. 用户配置特征重要性：
   - 主要特征：symptom_type(50%), color_center(30%)
   - 系统实时显示权重总和（80%），提示还需配置20%
   - 次要特征：location(15%)
   - 可选特征：coverage(5%)
8. 用户定义诊断规则（使用规则生成器）：
   - 确诊：主要特征 >= 2/2，置信度95%
   - 疑似：主要特征 >= 1/2，置信度70%
9. 用户输入视觉描述（自然语言）
10. 点击"验证"，系统检查：
    - ✅ 所有引用的特征值存在于特征本体
    - ✅ 权重总和为1.0
    - ✅ disease_id唯一（不与现有疾病冲突）
11. 验证通过，点击"保存"
12. 系统保存`backend/knowledge_base/diseases/rose_powdery_mildew.json`
13. 系统自动更新`host_disease/associations.json`（添加Rosa与rose_powdery_mildew的关联）
14. 系统更新疾病索引，提示"疾病已添加，现在可以诊断"

**涉及本体**：疾病本体、宿主本体、特征本体
**新增文件**：`backend/knowledge_base/diseases/rose_powdery_mildew.json`
**修改文件**：`backend/knowledge_base/host_disease/associations.json`

---

#### 场景3：调整疾病的特征权重

**背景**：试验发现rose_black_spot的color_center准确率仅41.7%，需要降低该特征的权重。

**操作流程**：
1. 用户进入知识管理页，定位到"疾病本体"区域
2. 点击"rose_black_spot"展开详情
3. 点击"调整权重"按钮
4. 系统显示权重滑块编辑器：
   - 主要特征区：
     - symptom_type: 50% （固定，KEY特征）
     - color_border: 30% （固定，KEY特征）
   - 次要特征区：
     - color_center: 10% → 调整为 5%（拖动滑块）
     - location: 5% → 调整为 10%（拖动滑块）
   - 系统实时显示总权重：major(80%) + minor(15%) ✓
5. 用户点击"测试诊断规则"
6. 系统上传测试图片，模拟诊断过程：
   - 显示新权重下的匹配得分
   - 对比旧权重的得分
   - 显示置信度变化
7. 用户确认权重调整合理，点击"保存"
8. 系统更新rose_black_spot.json的feature_importance配置
9. 系统记录变更日志：v4.2 - 降低color_center权重（10%→5%），提高location权重（5%→10%）

**涉及本体**：疾病本体
**修改文件**：`backend/knowledge_base/diseases/rose_black_spot.json`

---

#### 场景4：验证知识库完整性

**背景**：新增多个疾病后，需要验证整个知识库的一致性。

**操作流程**：
1. 用户点击顶部"验证全部"按钮
2. 系统执行全面验证：
   - 特征本体验证：
     - ✅ 所有维度的取值定义完整
     - ✅ 模糊匹配规则引用的值都存在
   - 疾病本体验证：
     - ✅ 所有疾病的特征向量引用的值存在于特征本体
     - ⚠️ rose_black_spot.feature_vector.color_center包含"brown"，但在试验中准确率低，建议复核
     - ❌ rose_rust.feature_vector.symptom_type="rust_pustule_new"不存在于特征本体（错误）
   - 宿主本体验证：
     - ✅ 所有宿主关联的疾病都存在于疾病本体
   - 关系完整性验证：
     - ⚠️ 疾病"tulip_fire"未关联任何宿主（孤立实例）
3. 系统显示验证报告，按严重性分组：
   - ❌ 错误（1项）：必须修复
   - ⚠️ 警告（2项）：建议修复
   - ✅ 通过（15项）
4. 用户点击错误项"rose_rust.symptom_type引用不存在"
5. 系统跳转到rose_rust的编辑器，高亮显示错误字段
6. 用户修改：symptom_type从"rust_pustule_new"改为"rust_pustule"
7. 用户重新验证，所有错误修复 ✅

**涉及本体**：全部本体
**验证结果**：生成验证报告（HTML/PDF）

---

## 第5部分：设计思考与理由

### 5.1 为什么采用"统一结构"而非"多样化设计"？

**决策**：所有本体共享"元数据 + 维度定义 + 实例集合"的统一结构。

**理由**：
1. **一致的用户体验**：用户只需学习一次操作流程，适用于所有本体类型
2. **统一的验证逻辑**：Schema验证、引用完整性检查、权重一致性验证可复用
3. **易于扩展**：新增本体类型（如环境本体）只需实现统一接口
4. **降低开发成本**：前端组件复用率高，后端API统一

**权衡**：
- 统一结构可能牺牲某些本体的特殊需求（如治疗本体需要复杂的用药时间表）
- 解决方案：在统一结构基础上，允许自定义字段（custom_fields）

---

### 5.2 为什么按"特征 → 宿主 → 疾病 → 治疗"顺序展示？

**决策**：从上到下依次展示特征本体、宿主本体、疾病本体、治疗本体。

**理由**：
1. **依赖关系顺序**：
   - 疾病本体依赖特征本体（特征向量引用特征维度）
   - 疾病本体依赖宿主本体（宿主过滤）
   - 治疗本体依赖疾病本体（治疗方案关联疾病）
2. **变化频率顺序**：
   - 特征本体变化最频繁（根据试验优化）
   - 疾病本体变化频繁（新增疾病、调整权重）
   - 宿主本体变化少（新增花卉种属不频繁）
   - 治疗本体变化少（治疗方案相对稳定）
3. **符合用户心智模型**：
   - 用户思考疾病诊断时，首先关注"VLM能看到什么特征"（特征本体）
   - 然后关注"这个疾病影响哪种花"（宿主本体）
   - 最后关注"诊断后如何治疗"（治疗本体）

**权衡**：
- 部分用户可能更关心疾病本体（直接管理疾病）
- 解决方案：提供"快速导航"按钮，允许用户自定义顺序

---

### 5.3 为什么强调"快速编辑"功能？

**决策**：为symptom_type、color_border等高频修改的维度提供快捷编辑入口。

**理由**：
1. **试验驱动的迭代优化**：
   - FlowerSpecialist方法论强调"试验-反馈-优化"循环
   - v10试验发现color_border准确率仅58.3%，需要快速优化VLM描述
   - 传统流程：打开文件 → 找到维度 → 编辑 → 保存 → 重新生成提示词（5步）
   - 快速编辑：点击按钮 → 编辑 → 保存并生成（2步）
2. **降低操作成本**：
   - 研究人员可能每天需要优化多次提示词
   - 快速编辑可节省80%的操作时间
3. **减少错误**：
   - 快速编辑提供实时预览（修改后立即看到新Prompt）
   - 避免手动编辑JSON时的格式错误

**权衡**：
- 快速编辑可能隐藏完整的数据结构，导致用户不了解全局
- 解决方案：快速编辑器提供"查看完整JSON"按钮

---

### 5.4 为什么需要"关系可视化"？

**决策**：底部提供关系视图，可视化本体间的依赖和关联关系。

**理由**：
1. **理解诊断逻辑**：
   - 诊断逻辑涉及多个本体的协作（特征提取 → 候选剪枝 → 特征匹配）
   - 可视化帮助用户理解"为什么这个疾病被诊断出来"
2. **检测知识库问题**：
   - 孤立的疾病（未关联宿主）
   - 未使用的特征维度（所有疾病都不引用）
   - 循环依赖（A依赖B，B依赖A）
3. **优化知识库结构**：
   - 发现高耦合的维度（如color_border被90%的疾病引用，是核心特征）
   - 发现低价值的维度（如texture仅被1个疾病引用，可能冗余）

**权衡**：
- 关系图可能复杂（18-24种疾病 × 8个特征维度 = 大量连线）
- 解决方案：提供过滤器，只显示选中实例的关系

---

### 5.5 为什么不实现"在线编辑器"而是"表单编辑"？

**决策**：界面4提供两种编辑模式：
1. **表单视图**（推荐）：结构化表单，下拉框选择特征值
2. **源码视图**：JSON文本编辑器，支持语法高亮

**理由**：
1. **降低学习成本**：
   - 表单视图不需要了解JSON格式
   - 下拉框限制输入范围，避免拼写错误
2. **实时验证**：
   - 表单提交前验证所有字段
   - 避免保存无效数据
3. **兼顾专家用户**：
   - 源码视图满足高级用户的需求
   - 支持批量修改（如替换所有color_center的值）

**权衡**：
- 表单视图可能不支持复杂的JSON结构（如嵌套对象）
- 解决方案：复杂结构使用子表单（如feature_importance的major_features列表）

---

### 5.6 为什么需要"版本控制"？

**决策**：每次修改本体时，自动记录变更日志，支持回滚。

**理由**：
1. **试验的可重现性**：
   - v10试验使用feature_ontology v1.0，v11试验使用v1.1
   - 必须记录每个版本的完整配置，才能重现试验结果
2. **错误恢复**：
   - 用户误删除重要配置，可快速回滚
   - 避免"改坏了不知道怎么改回来"的问题
3. **团队协作**：
   - 多人同时编辑知识库时，版本控制防止冲突
   - 变更日志记录"谁在何时改了什么"

**实现方案**：
- 基于Git集成（自动提交到Git仓库）
- 或基于数据库审计日志（存储每次修改的before/after快照）

---

## 第6部分：实现优先级

### 6.1 P4阶段（前端开发）必须实现

| 功能模块 | 优先级 | 理由 |
|---------|-------|------|
| 本体查看 | ⚡⚡⚡ | 核心功能，查看现有知识库 |
| 本体编辑（表单视图） | ⚡⚡⚡ | 核心功能，修改疾病和特征本体 |
| 本体验证 | ⚡⚡⚡ | 确保知识库一致性 |
| 快速编辑（特征本体） | ⚡⚡ | 提高试验迭代效率 |
| 批量导入/导出 | ⚡⚡ | 备份和迁移知识库 |

### 6.2 P5阶段（管理后台）扩展实现

| 功能模块 | 优先级 | 理由 |
|---------|-------|------|
| 关系可视化 | ⚡⚡ | 理解诊断逻辑，优化知识库结构 |
| 版本控制 | ⚡⚡ | 试验可重现性 |
| 源码视图编辑 | ⚡ | 高级用户需求 |
| 搜索与过滤 | ⚡ | 知识库规模扩大后需要 |

### 6.3 未来扩展（v1.2+）

| 功能模块 | 优先级 | 理由 |
|---------|-------|------|
| 协作编辑 | ⚡ | 多人同时编辑知识库 |
| 权限管理 | ⚡ | 不同用户有不同编辑权限 |
| 知识库对比 | ⚡ | 对比不同版本的知识库差异 |
| 知识库合并 | ⚡ | 合并多个分支的知识库 |

---

## 第7部分：与界面需求文档v2的差异

### 7.1 原界面4设计（界面需求文档v2）

**原设计要点**：
- 类似资源管理器的布局（左侧目录树，右侧编辑器）
- 两种编辑模式：源码视图 + 表单视图
- JSON Schema验证
- 支持新建、导入、验证功能

**不足之处**：
1. **未区分本体的优先级**：所有本体平铺展示，未突出高频修改的特征本体和疾病本体
2. **未体现本体间的关系**：用户难以理解"为什么修改feature_ontology会影响所有疾病诊断"
3. **未提供快速编辑入口**：每次优化都需要完整的"打开文件→编辑→保存"流程
4. **未说明如何支持试验驱动的迭代优化**：FlowerSpecialist方法论的核心是"试验-反馈-优化"，原设计未体现

### 7.2 新界面4设计的改进

| 改进点 | 原设计 | 新设计 | 价值 |
|-------|-------|-------|------|
| **优先级展示** | 平铺所有本体 | 分层展示，标记"⚡影响VLM研判" | 用户快速定位高频修改的本体 |
| **关系可视化** | 无 | 底部关系视图 | 理解诊断逻辑，检测知识库问题 |
| **快速编辑** | 无 | 为高频维度提供快捷入口 | 节省80%操作时间 |
| **试验反馈集成** | 无 | 标记待优化项（⚠️） | 直接从试验报告跳转到编辑器 |
| **统一结构** | 未定义 | 明确定义OntologyEntity接口 | 易于扩展新本体类型 |
| **验证增强** | 基本JSON验证 | 引用完整性+权重一致性+循环依赖检查 | 确保知识库质量 |

---

## 第8部分：技术实现建议

### 8.1 前端技术栈

```
React 18 + TypeScript
  ├─ UI组件库: Ant Design / Material-UI
  ├─ 表单管理: React Hook Form + Yup (Schema验证)
  ├─ 状态管理: Zustand / Redux Toolkit
  ├─ 图可视化: D3.js / Cytoscape.js
  ├─ JSON编辑器: Monaco Editor (VS Code编辑器内核)
  └─ 差异对比: react-diff-viewer
```

### 8.2 后端API设计

```
GET    /api/knowledge/ontologies              # 获取所有本体总览
GET    /api/knowledge/ontology/{type}         # 获取指定类型本体
GET    /api/knowledge/ontology/{type}/{id}    # 获取指定本体实例
PUT    /api/knowledge/ontology/{type}/{id}    # 更新本体实例
POST   /api/knowledge/validate                # 验证知识库完整性
GET    /api/knowledge/relations                # 获取关系图数据
POST   /api/knowledge/import                  # 批量导入
GET    /api/knowledge/export                  # 批量导出
GET    /api/knowledge/search                  # 搜索
```

### 8.3 数据库设计（可选，JSON文件为主）

```sql
-- 本体元数据表（用于索引和搜索）
CREATE TABLE ontology_metadata (
    id UUID PRIMARY KEY,
    type VARCHAR(50) NOT NULL,  -- feature/host/disease/treatment
    name VARCHAR(200) NOT NULL,
    version VARCHAR(20) NOT NULL,
    last_updated TIMESTAMP NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    tags TEXT[],
    created_at TIMESTAMP DEFAULT NOW()
);

-- 本体关系表
CREATE TABLE ontology_relations (
    id UUID PRIMARY KEY,
    source_id UUID REFERENCES ontology_metadata(id),
    target_id UUID REFERENCES ontology_metadata(id),
    relation_type VARCHAR(50) NOT NULL,  -- depends_on/associates_with/treated_by
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 变更日志表
CREATE TABLE changelog (
    id UUID PRIMARY KEY,
    ontology_id UUID REFERENCES ontology_metadata(id),
    version VARCHAR(20) NOT NULL,
    author VARCHAR(200),
    changes TEXT[],
    diff JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 附录A：术语表

| 术语 | 英文 | 定义 |
|-----|------|------|
| 本体 | Ontology | 知识的形式化表示，定义概念、属性、关系 |
| 维度 | Dimension | 特征本体中的一个可观察特征类别（如symptom_type） |
| 实例 | Instance | 本体中的一个具体条目（如rose_black_spot是疾病本体的一个实例） |
| 特征向量 | Feature Vector | 疾病本体中定义的期望特征值集合 |
| 特征重要性 | Feature Importance | 不同特征在诊断中的权重配置（主要/次要/可选） |
| 诊断规则 | Diagnosis Rules | 基于特征匹配度判定置信度的逻辑规则 |
| 模糊匹配 | Fuzzy Matching | 允许特征值的近似匹配（如brown≈black） |
| 宿主过滤 | Host Filtering | 根据花卉种属筛选候选疾病的过程 |
| 候选疾病剪枝 | Candidate Pruning | 减少需要匹配的疾病数量（如Rosa只匹配rose_*疾病） |
| VLM | Vision Language Model | 视觉-语言多模态模型（如Qwen VL Plus） |

---

## 附录B：示例JSON结构

### 特征本体示例（简化版）

```json
{
  "metadata": {
    "id": "feature_ontology",
    "type": "feature",
    "version": "1.1",
    "last_updated": "2025-11-14"
  },
  "schema": {
    "dimensions": [
      {
        "name": "symptom_type",
        "type": "enum",
        "required": true,
        "used_in": ["Q1", "疾病特征向量"]
      }
    ]
  },
  "instances": {
    "values": {
      "symptom_type": [
        {
          "value": "necrosis_spot",
          "cn_term": "坏死斑点",
          "vlm_description": "小型圆形或近圆形的褐色或黑色斑点",
          "visual_metaphors": ["像被香烟烫过留下的焦痕"]
        }
      ]
    }
  },
  "rules": {
    "fuzzy_matching": [
      {"type": "color_alias", "mapping": {"dark_color": ["black", "brown"]}}
    ]
  }
}
```

### 疾病本体示例（简化版）

```json
{
  "metadata": {
    "id": "rose_black_spot",
    "type": "disease",
    "version": "4.2",
    "tags": ["叶部病害", "真菌病害"]
  },
  "schema": {
    "fields": [
      {"name": "pathogen", "type": "string"},
      {"name": "feature_vector", "type": "object"}
    ]
  },
  "instances": {
    "entries": [
      {
        "pathogen": "Diplocarpon rosae",
        "feature_vector": {
          "symptom_type": "necrosis_spot",
          "color_border": ["yellow", "light_yellow"]
        },
        "feature_importance": {
          "major_features": [
            {"dimension": "color_border", "weight": 0.3}
          ]
        }
      }
    ]
  },
  "relations": {
    "dependencies": ["feature_ontology"],
    "associations": [
      {"type": "host", "target": "Rosa"}
    ]
  }
}
```

---

## 结语

本设计文档基于FlowerSpecialist MVP试验数据和PhytoOracle现有知识库的深入分析，重新设计了界面4（知识管理页）。设计遵循"简洁实用"原则，突出高频修改的本体（特征本体、疾病本体），提供快速编辑和关系可视化功能，支持试验驱动的迭代优化。

**关键创新点**：
1. **统一知识结构**：所有本体共享一致的元数据、维度、实例、关系模型
2. **分层展示**：按依赖关系和变化频率排序（特征 → 宿主 → 疾病 → 治疗）
3. **快速编辑**：为高频修改的维度提供快捷入口，节省80%操作时间
4. **关系可视化**：理解诊断逻辑，检测知识库问题
5. **试验反馈集成**：标记待优化项（⚠️），直接从试验报告跳转到编辑器

**下一步**：
- P4阶段：实现前端界面（React + Ant Design）
- P5阶段：扩展管理后台功能（版本控制、协作编辑）
- 持续优化：根据用户反馈和试验数据迭代设计

---

**文档审核**：
- [ ] 产品经理审核
- [ ] 技术架构师审核
- [ ] UI/UX设计师审核
- [ ] 前端开发负责人审核

**更新历史**：
- v1.0 (2025-11-14): 初始版本，基于MVP试验数据和现有知识库分析