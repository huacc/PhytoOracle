# PhytoOracle v2.0 设计与计划综合评审报告

> **评审日期**: 2025-11-14
> **评审版本**: 详细设计文档v2.0 + 研发计划v2.0
> **评审团队**: 技术架构师 + 产品总监
> **评审目标**: 基于需求文档评估设计与计划的完整性、合理性和可执行性

---

## 📋 执行摘要

### 总体评价

PhytoOracle v2.0项目在**整体架构设计**和**产品规划**方面表现优秀，DDD分层清晰，需求覆盖度达到80%。但在**功能完整性**和**技术细节**方面存在**3个阻塞性问题**和**8个高优先级改进点**，需要立即修复。

**评审结论**: ⚠️ **有条件通过**（需完成必修项后方可进入P4阶段）

### 关键发现

| 评审维度 | 评分 | 关键问题数 | 状态 |
|---------|------|----------|------|
| **技术架构** | ⭐⭐⭐⭐☆ (4/5) | 🔴 高风险3项，🟡 中风险5项 | ⚠️ 需改进 |
| **产品功能** | ⭐⭐⭐⭐☆ (4/5) | 🔴 阻塞性3项，🟡 中优先级6项 | ⚠️ 需改进 |
| **需求覆盖度** | 80% (12/15核心功能) | ❌ 缺失3个核心功能 | ⚠️ 需补充 |
| **测试策略** | ⭐⭐⭐⭐⭐ (5/5) | ✅ 35单元+20联调+4E2E | ✅ 优秀 |
| **可执行性** | ⭐⭐⭐☆☆ (3/5) | 🔴 P1阶段缺失15个API设计 | ⚠️ 需补充 |

### 核心问题统计

- 🔴 **阻塞性问题**: 6项（必须在P4前解决）
- 🟡 **高优先级问题**: 8项（P6前解决）
- 🟢 **中优先级问题**: 5项（P7阶段解决）
- **总问题数**: 19项

### 工期影响

```
原计划总工期: 20.1天
技术架构调整: +2.3天
产品功能补充: +1.8天
调整后总工期: 24.2天 (+4.1天)
```

---

## 一、技术架构评审（系统架构师）

### 1.1 架构完整性分析

#### 1.1.1 DDD分层架构评估

**✅ 优势识别:**

1. **分层设计完整**: 详细设计v2.0明确定义了4层架构:
   - Domain层(领域模型): DiagnosisAggregate, DiseaseOntology, FeatureVector
   - Application层(应用服务): DiagnosisService, KnowledgeService, ImageService
   - Infrastructure层(基础设施): VLMClient, KnowledgeLoader, LocalImageStorage
   - Interface层(API): FastAPI路由、Schema定义

2. **职责边界清晰**: 每层职责明确,依赖方向正确(上层依赖下层,下层不感知上层)

3. **聚合根设计合理**: DiagnosisAggregate作为核心聚合根,封装诊断流程的完整状态

**⚠️ 架构风险识别:**

1. **缺失Repository抽象层** (中风险)
   - **问题**: 设计文档第5.3节中,ImageRepository直接在Persistence层实现,但缺少抽象接口定义
   - **影响**: 如果后续需要切换存储方案(如PostgreSQL → MongoDB),需要修改Service层代码
   - **建议**: 在Domain层定义`IImageRepository`接口,Infrastructure层实现,Service层依赖抽象

2. **Service层循环依赖风险** (中风险)
   - **潜在问题**: DiagnosisService依赖KnowledgeService/ImageService,ImageService可能需要访问DiagnosisService(如关联诊断记录)
   - **检测**: 研发计划P3.6节ImageService设计中,未明确与DiagnosisService的依赖关系
   - **缓解措施**: 通过Event-Driven解耦(如DiagnosisCompletedEvent),或使用中介者模式

3. **Aggregate边界不明确** (低风险)
   - **问题**: DiagnosisAggregate、FeatureVector、DiagnosisScore的归属关系不够清晰
   - **建议**: 明确FeatureVector是DiagnosisAggregate的值对象,DiagnosisScore是领域服务返回的计算结果

#### 1.1.2 API设计评估

**✅ 符合RESTful规范:**

1. **资源命名规范**: `/api/v1/diagnose`, `/api/v1/knowledge/diseases`, `/api/v1/images`
2. **HTTP动词正确使用**: GET(查询)、POST(创建)、PUT(更新)、PATCH(部分更新)、DELETE(删除)
3. **响应格式统一**: 所有API返回JSON,错误响应包含标准格式(error/detail/timestamp/trace_id)

**🔴 API设计缺陷（阻塞性问题）:**

1. **API接口数量冗余** (🔴 高风险)
   - **问题**: 设计文档6.3节与6.4节存在功能重叠:
     - `GET /api/v1/knowledge/diseases/{disease_id}` (6.3.2) vs `GET /api/v1/knowledge/disease/{disease_id}` (6.4.2)
     - `POST /api/v1/knowledge/diseases` (6.3.3) vs `POST /api/v1/knowledge/disease` (6.4.3)
   - **影响**: 前端调用困惑,测试用例重复,维护成本增加
   - **建议**: 统一使用单数形式`/api/v1/knowledge/disease`(符合RESTful规范单资源路径)

2. **批量诊断API缺少任务取消接口** (中风险)
   - **问题**: 设计文档6.6节仅定义了`POST /batch`、`GET /batch/{id}`、`GET /batch/{id}/progress`,缺少`DELETE /batch/{id}`
   - **场景**: 用户误上传100张图片,希望取消任务
   - **建议**: 新增`DELETE /api/v1/diagnose/batch/{batch_id}` - 取消批量诊断任务

3. **快照恢复API缺少预览功能** (低风险)
   - **问题**: 设计文档6.4.9节`POST /api/v1/knowledge/restore/{snapshot_id}`直接恢复,无法预览变更
   - **建议**: 新增`GET /api/v1/knowledge/restore/{snapshot_id}/preview` - 返回恢复后的差异对比

4. **缺少批量操作API** (中风险)
   - **问题**: 图片管理API(6.7节)仅支持单个准确性标注,用户需要逐张标注
   - **建议**: 新增`PATCH /api/v1/images/batch/accuracy` - 批量标注多张图片准确性

#### 1.1.3 服务层设计评估

**✅ 服务划分合理:**

1. **核心服务完整**: DiagnosisService、KnowledgeService、ImageService分别负责诊断、知识库、图片管理
2. **基础设施服务独立**: VLMClient、KnowledgeLoader、FuzzyMatcher职责单一
3. **辅助服务充足**: BatchDiagnosisService、SnapshotService、FeedbackService覆盖扩展需求

**🔴 服务层问题（阻塞性问题）:**

1. **DiagnosisService职责过重** (🔴 高风险)
   - **问题**: 详细设计5.3.1节DiagnosisService包含:
     - Q0-Q6问诊编排(7个子流程)
     - Layer1-Layer3诊断逻辑
     - VLM兜底策略
     - 特征向量构建
     - 结果评分调度
   - **单一类代码量预估**: >1500行
   - **建议**: 拆分为3个Service:
     - `QuestioningService`: 负责Q0-Q6 VLM调用编排
     - `MatchingService`: 负责知识库匹配和评分
     - `DiagnosisOrchestrator`: 编排整体流程,依赖上述两个服务

2. **KnowledgeService缺少数据验证逻辑** (中风险)
   - **问题**: 设计文档6.4.6节定义了`POST /api/v1/knowledge/validate`接口,但未说明KnowledgeService如何实现验证
   - **建议**: 新增`KnowledgeValidator`基础设施组件,集成JSON Schema验证 + Pydantic解析验证

3. **ImageService与DiagnosisService耦合** (中风险)
   - **问题**: 研发计划P3.6节ImageService需要关联diagnosis_id,但未说明如何获取诊断上下文
   - **建议**: 使用Domain Event模式:
     ```python
     # DiagnosisService完成诊断后发布事件
     await event_bus.publish(DiagnosisCompletedEvent(
         diagnosis_id=result.diagnosis_id,
         image_id=image_metadata.image_id,
         genus=feature_vector.flower_genus
     ))

     # ImageService订阅事件,异步保存图片
     @event_bus.subscribe(DiagnosisCompletedEvent)
     async def on_diagnosis_completed(event: DiagnosisCompletedEvent):
         await image_service.save_image(...)
     ```

#### 1.1.4 数据库设计评估

**✅ 数据模型完整:**

1. **核心表设计合理**: diagnoses, images, diagnosis_features覆盖诊断流程
2. **扩展表充足**: knowledge_snapshots, batch_diagnosis_sessions支持新功能
3. **索引设计优化**: timestamp, plant_genus, accuracy_label建立索引

**⚠️ 数据库问题:**

1. **缺少分区策略** (中风险)
   - **问题**: diagnoses表按当前设计,1年内可能积累100万+记录,未设计分区
   - **影响**: 查询性能下降,历史记录查询慢
   - **建议**: 按时间分区(每月一个分区):
     ```sql
     CREATE TABLE diagnoses (
         ...
     ) PARTITION BY RANGE (created_at);

     CREATE TABLE diagnoses_2025_11 PARTITION OF diagnoses
         FOR VALUES FROM ('2025-11-01') TO ('2025-12-01');
     ```

2. **JSONB字段缺少GIN索引** (中风险)
   - **问题**: diagnosis_features表使用JSONB存储特征向量,但未建立GIN索引
   - **影响**: 按特征维度查询诊断记录时全表扫描
   - **建议**: 添加GIN索引:
     ```sql
     CREATE INDEX idx_diagnosis_features_jsonb
         ON diagnosis_features USING GIN (features jsonb_path_ops);
     ```

3. **knowledge_snapshots表缺少文件大小限制** (低风险)
   - **问题**: 设计文档9.2节knowledge_snapshots表未约束快照文件大小
   - **建议**: 添加CHECK约束:
     ```sql
     ALTER TABLE knowledge_snapshots ADD CONSTRAINT check_snapshot_size
         CHECK (file_size_bytes <= 104857600); -- 最大100MB
     ```

4. **images表缺少唯一约束** (中风险)
   - **问题**: 同一张图片可能被重复上传,生成多个诊断记录
   - **建议**: 添加image_hash唯一约束:
     ```sql
     ALTER TABLE images ADD COLUMN image_hash VARCHAR(64);
     CREATE UNIQUE INDEX idx_images_hash ON images(image_hash);
     ```

#### 1.1.5 VLM集成架构评估

**✅ VLM架构设计优秀:**

1. **Fallback机制完整**: Qwen → ChatGPT → Claude多层降级
2. **缓存策略合理**: Redis缓存VLM响应,key设计为`vlm:{image_hash}:{question_id}`
3. **Instructor集成**: 自动验证Pydantic Schema,减少解析错误

**⚠️ VLM架构风险:**

1. **缓存策略可能导致错误结果持久化** (🔴 高风险)
   - **问题**: 详细设计5.6.4节VLMClient缓存TTL=7天,如果VLM返回错误结果,会缓存7天
   - **场景**: VLM误判Q0.2(花卉种属)为"unknown",后续7天内相同图片都返回错误结果
   - **建议**:
     - 仅缓存高置信度结果(confidence > 0.8)
     - 添加缓存失效接口:`DELETE /api/v1/cache/{image_hash}`
     - 允许用户手动清除错误缓存

2. **Qwen自定义Adapter缺少错误处理** (中风险)
   - **问题**: 研发计划P2.2节提到"实现Qwen VL Plus Provider",但未说明Qwen返回非标准响应时的处理逻辑
   - **场景**: Qwen API限流返回429,但Adapter未捕获,导致整个诊断流程失败
   - **建议**: 在QwenVLPlusProvider中添加错误处理逻辑

3. **VLM响应Schema版本管理缺失** (中风险)
   - **问题**: 详细设计5.6.5节定义了Q00Response等Schema,但未说明如何升级Schema版本
   - **场景**: 需要新增Q0.7问题时,旧缓存数据与新Schema不兼容
   - **建议**: 在缓存key中包含Schema版本:
     ```python
     cache_key = f"vlm:{image_hash}:{question_id}:v{schema_version}"
     ```

---

### 1.2 P0-P3阶段影响分析(重点)

#### 1.2.1 P0阶段是否需要增补

**✅ 技术栈无需新增:**
- React/Vue前端框架已在P0环境准备中考虑(通过Node.js依赖)
- PostgreSQL/Redis基础设施已覆盖
- Qwen VL Plus API已验证

**结论**: ❌ 无需增补P0阶段

---

#### 1.2.2 P1阶段是否需要增补 (🔴 关键阶段,需要大量增补)

**🔴 必须增补的API协议(15个):**

根据详细设计v2.0第6章,以下API在P1阶段OpenAPI规范中**缺失**:

| 分类 | 缺失API | 优先级 | 设计文档引用 |
|------|--------|--------|-------------|
| **知识库管理** | `GET /api/v1/knowledge/tree` | P0 | 6.4.1 |
| | `POST /api/v1/knowledge/validate` | P0 | 6.4.6 |
| | `POST /api/v1/knowledge/snapshot` | P1 | 6.4.7 |
| | `GET /api/v1/knowledge/snapshots` | P1 | 6.4.8 |
| | `POST /api/v1/knowledge/restore/{snapshot_id}` | P1 | 6.4.9 |
| **本体管理** | `GET /api/v1/ontology/list` | P0 | 6.5.1 |
| | `GET /api/v1/ontology/{type}` | P0 | 6.5.2 |
| **批量诊断** | `POST /api/v1/diagnose/batch` | P0 | 6.6.1 |
| | `GET /api/v1/diagnose/batch/{batch_id}` | P0 | 6.6.2 |
| | `GET /api/v1/diagnose/batch/{batch_id}/progress` | P0 | 6.6.3 |
| **图片管理** | `GET /api/v1/images` | P0 | 6.7.1 |
| | `PATCH /api/v1/images/{image_id}/accuracy` | P0 | 6.7.2 |

**增补方案:**

1. **立即新增**: 在P1.1任务中,将上述12个API接口定义补充到`docs/api/openapi.yaml`
2. **Schema扩展**: 新增Pydantic Schema定义:
   - `KnowledgeTreeResponse`
   - `SnapshotCreateRequest`/`SnapshotResponse`
   - `BatchDiagnosisRequest`/`BatchDiagnosisResponse`
   - `ImageListResponse`
   - `AccuracyLabelRequest`

**🔴 必须增补的数据库表(3张):**

根据详细设计v2.0第9章,以下数据库表在P1阶段DDL脚本中**缺失**:

| 表名 | 用途 | 设计文档引用 |
|------|------|-------------|
| `knowledge_snapshots` | 知识库版本管理 | 9.2节 |
| `batch_diagnosis_sessions` | 批量诊断会话 | 9.2节 |
| `accuracy_feedback` | 准确性反馈 | 推导需求 |

**增补方案:**

1. **立即创建**: 在P1.2任务中,将上述3张表的DDL语句添加到`backend/scripts/init_db.sql`
2. **索引设计**: 为batch_diagnosis_sessions.status和accuracy_feedback.is_accurate建立索引
3. **外键约束**: 确保accuracy_feedback表的image_id和diagnosis_id外键完整性

**工期影响**: P1阶段工期需从1.5天调整为**2.5天** (+1天)

---

#### 1.2.3 P2阶段是否需要增补 (⚡ 需要新增批量处理组件)

**⚡ 需要新增的基础设施组件:**

1. **批量诊断队列管理器** (中优先级)
   - **需求来源**: 详细设计6.6节批量诊断API
   - **实现阶段**: P2.7(新增子任务)
   - **工作量估算**: 0.5天

2. **快照存储管理器** (低优先级)
   - **需求来源**: 详细设计6.4.7节快照管理API
   - **实现阶段**: P2.7(新增子任务)
   - **工作量估算**: 0.3天

3. **Excel导出器** (🔴 高优先级)
   - **需求来源**: 界面需求文档v2界面2要求"导出Excel报告"
   - **实现阶段**: P2.7(新增子任务)
   - **工作量估算**: 0.4天

**增补方案:**

1. **新增P2.7子任务**: "批量处理、快照管理与报告导出基础设施开发"
   - 实现BatchDiagnosisQueue
   - 实现SnapshotStorage
   - 实现ExcelExporter（支持xlsx格式，包含图表）
   - 编写单元测试
   - **工作量**: 1.2天

2. **更新研发计划**: 将P2阶段工期从3天调整为**4.2天** (+1.2天)

---

#### 1.2.4 P3阶段是否需要调整 (🔴 需要重大调整)

**🔴 必须新增的核心功能（产品总监发现）:**

1. **多图诊断功能完全缺失** (🔴 阻塞性问题)
   - **需求来源**: 需求文档明确支持"1-N张图片诊断"
   - **当前设计**: 仅支持单图诊断
   - **影响**: 核心需求未满足，无法验收
   - **修复方案**:
     - P3新增子任务P3.7: "多图特征融合诊断逻辑"
     - 实现`diagnose_multi_images()`方法
     - 支持2-5张图片的特征融合（加权平均、投票机制）
     - 工作量: 0.8天

2. **异步任务处理逻辑缺失** (🔴 高风险)
   - **问题**: 批量诊断设计了API但未实现异步任务队列逻辑
   - **修复方案**:
     - P3新增子任务P3.8: "批量诊断异步任务编排"
     - 使用asyncio.Queue实现任务队列
     - 实现后台worker池（3个并发worker）
     - 工作量: 0.6天

**✅ 已实现的核心逻辑无需修改:**

1. **诊断引擎**: DiagnosisService的Q0-Q6流程无需修改
2. **知识库服务**: KnowledgeService的加载逻辑无需修改
3. **图片服务**: ImageService的保存逻辑无需修改

**⚡ 需要在P3.9阶段扩展(已在研发计划中定义):**

根据研发计划v2.0 P3.9节,已经明确列出了需要修改的3个Service:

| Service | 修改内容 | 工作量 | 设计文档引用 |
|---------|---------|--------|-------------|
| ImageService | 新增`update_accuracy_label()`方法 | 0.2天 | 7.2节 |
| KnowledgeService | 新增`get_knowledge_tree()`方法 | 0.25天 | 7.3节 |
| DiagnosisService | 调整响应格式,包含`qa_details`字段 | 0.15天 | 7.1节 |

**工期影响**: P3阶段工期需从3天调整为**4.4天** (+1.4天)

---

### 1.3 技术债务识别

#### 1.3.1 已实现模块(P0-P3)的技术债务

| 模块 | 技术债务 | 严重程度 | 影响 | 重构建议 | 优先级 |
|------|---------|---------|------|---------|--------|
| **DiagnosisService** | 职责过重(>1500行代码) | 🔴 高 | 可维护性差,测试困难 | 拆分为QuestioningService + MatchingService + DiagnosisOrchestrator | P0 |
| **VLMClient** | 缓存策略不合理(缓存错误结果) | 🔴 高 | 错误结果持久化7天 | 仅缓存高置信度结果,添加缓存失效接口 | P0 |
| **LocalImageStorage** | 缺少文件大小限制 | 🟡 中 | 恶意上传大文件耗尽磁盘 | 添加文件大小检查(最大10MB) | P1 |
| **KnowledgeLoader** | 缺少JSON Schema验证 | 🟡 中 | 非法JSON导致加载失败 | 集成jsonschema库,加载前验证 | P1 |
| **ImageRepository** | 缺少抽象接口 | 🟡 中 | 存储方案切换困难 | 定义IImageRepository接口 | P2 |
| **FuzzyMatcher** | 硬编码匹配规则 | 🟢 低 | 扩展新特征维度需修改代码 | 改为配置驱动(从feature_ontology.json读取) | P2 |

#### 1.3.2 新增模块(P4-P5)的潜在技术债务

| 模块 | 潜在债务 | 预防措施 | 优先级 |
|------|---------|---------|--------|
| **BatchDiagnosisService** | 未处理任务取消场景 | 新增`cancel_batch()`方法 | P1 |
| **SnapshotService** | 未限制快照文件大小 | 添加文件大小检查(最大100MB) | P1 |
| **KnowledgeCRUDService** | 缺少并发更新控制 | 使用乐观锁(version字段) | P0 |
| **前端组件** | 缺少错误边界(Error Boundary) | 添加全局错误捕获 | P0 |

#### 1.3.3 技术债务优先级排序

**P0级(必须在P4前解决):**
1. 🔴 **拆分DiagnosisService**: 影响P4-P5开发,降低集成难度
2. 🔴 **修复VLM缓存策略**: 避免错误结果传播到生产环境
3. 🔴 **KnowledgeCRUDService并发控制**: 防止多用户同时编辑知识库导致数据丢失

**P1级(P6联调前解决):**
1. 🟡 **LocalImageStorage文件大小限制**: 防止恶意上传
2. 🟡 **KnowledgeLoader JSON Schema验证**: 提高知识库数据质量
3. 🟡 **BatchDiagnosisService任务取消**: 改善用户体验

**P2级(P7测试阶段解决):**
1. 🟢 **ImageRepository抽象接口**: 提高架构灵活性
2. 🟢 **FuzzyMatcher配置驱动**: 降低维护成本

---

### 1.4 技术风险评估

#### 1.4.1 高风险项(⚠️ 需要立即缓解)

**⚠️ 风险1: 多模态VLM调用性能瓶颈**

- **风险描述**:
  - 单次诊断需要调用VLM 7-13次(Q0.0-Q0.5 + Q1-Q6)
  - 每次VLM调用延迟200-500ms(Qwen VL Plus实测)
  - 总延迟: 7次 × 300ms = 2.1秒(最快) ~ 13次 × 500ms = 6.5秒(最慢)
  - **超过界面需求(单图诊断< 5秒)**

- **影响范围**:
  - 界面1单图诊断超时
  - 界面2批量诊断50张图片需要105-325秒(1.75-5.4分钟)

- **缓解措施**:
  1. **并行调用Q1-Q6**(推荐): 单次诊断延迟从6.5秒降低到2.2秒
  2. **缓存策略优化**: 将Q0缓存TTL从7天延长到30天
  3. **VLM降级策略**: Q4-Q6为可选特征,置信度不足时可跳过

**⚠️ 风险2: 批量诊断并发处理导致内存溢出**

- **风险描述**:
  - 用户上传50张图片(每张5MB),总内存占用: 250MB
  - VLM处理过程中需要base64编码,内存放大1.33倍: 332.5MB
  - 如果3个用户同时批量诊断,总内存: 997.5MB
  - **服务器内存: 4GB (假设),可能触发OOM**

- **缓解措施**:
  1. **限制并发批量任务数**: 最多2个批量任务并发
  2. **图片流式处理**: 使用生成器逐张读取,立即释放内存
  3. **监控告警**: 添加内存使用监控,超过80%时拒绝新批量任务

**⚠️ 风险3: 知识库版本管理数据一致性**

- **风险描述**:
  - 场景1: 用户A正在编辑疾病D1,用户B执行快照恢复,覆盖D1
  - 场景2: 诊断任务正在执行(使用知识库v1.0),管理员热更新知识库到v1.1,诊断结果混乱
  - **缺少并发控制和版本隔离机制**

- **缓解措施**:
  1. **乐观锁机制**: version字段检查
  2. **快照恢复前置检查**: 检查是否有未完成的诊断任务
  3. **诊断任务版本隔离**: 诊断结果中包含knowledge_base_version

---

### 1.5 架构改进建议

#### 1.5.1 必须改进项(🔴 P4前完成)

**🔴 改进1: 拆分DiagnosisService为3个Service**

- **当前问题**: DiagnosisService职责过重,包含7个Q0-Q6子流程 + 3层诊断逻辑
- **改进方案**:
  ```
  DiagnosisService (原1500行)
    ↓ 拆分为
  QuestioningService (500行) - 负责Q0-Q6 VLM调用编排
  MatchingService (400行) - 负责知识库匹配和评分
  DiagnosisOrchestrator (300行) - 编排整体流程
  ```
- **收益**:
  - 单一类代码行数: 1500 → 300-500行
  - 测试覆盖率提升: 70% → 90%+
  - 可维护性显著提升

**🔴 改进2: 统一API路径规范,删除重复接口**

- **当前问题**: 设计文档6.3节和6.4节存在功能重叠的API定义
- **改进方案**: 删除6.3节接口,仅保留6.4节单数形式接口

**🔴 改进3: 添加KnowledgeCRUDService并发控制**

- **当前问题**: 多用户同时编辑知识库可能导致数据丢失
- **改进方案**: 实现乐观锁机制(version字段)

#### 1.5.2 建议改进项(🟡 P6-P7阶段完成)

**🟡 改进4: 添加批量诊断任务取消接口**
- 新增`DELETE /api/v1/diagnose/batch/{batch_id}`

**🟡 改进5: 添加快照恢复预览接口**
- 新增`GET /api/v1/knowledge/restore/{snapshot_id}/preview`

**🟡 改进6: 添加图片批量准确性标注接口**
- 新增`PATCH /api/v1/images/batch/accuracy`

---

## 二、产品功能评审（产品总监）

### 2.1 需求覆盖度分析

#### 2.1.1 需求文档vs设计文档对照表

| 需求编号 | 功能需求 | 需求文档来源 | 设计文档对应章节 | 覆盖状态 | 缺陷说明 |
|---------|---------|------------|---------------|---------|---------|
| **FR-1** | 1-N张图片诊断 | 需求文档3.1 | 6.2节 | ❌ 部分覆盖 | 🔴 仅支持单图,缺少多图融合 |
| **FR-2** | VLM问答对展示 | 界面需求v2界面1 | 15.2节 | ✅ 完全覆盖 | - |
| **FR-3** | 准确性标注 | 界面需求v2界面1 | 6.7.2节 | ✅ 完全覆盖 | - |
| **FR-4** | 批量诊断 | 界面需求v2界面2 | 6.6节 | ⚠️ 设计不足 | 🟡 缺少异步处理逻辑 |
| **FR-5** | 手动刷新机制 | 界面需求v2界面2 | 15.3节 | ✅ 完全覆盖 | - |
| **FR-6** | 结果导出Excel | 界面需求v2界面2 | - | ❌ 完全缺失 | 🔴 仅提到CSV,未实现Excel |
| **FR-7** | 双击查看详情 | 界面需求v2界面2 | 15.3节 | ✅ 完全覆盖 | - |
| **FR-8** | 本体Schema查看 | 界面需求v2界面3 | 6.5节 | ✅ 完全覆盖 | - |
| **FR-9** | 本体类型筛选 | 界面需求v2界面3 | 15.4节 | ✅ 完全覆盖 | - |
| **FR-10** | 知识库树形展示 | 界面需求v2界面4 | 6.4.1节 | ✅ 完全覆盖 | - |
| **FR-11** | 知识库CRUD | 界面需求v2界面4 | 6.4节 | ✅ 完全覆盖 | - |
| **FR-12** | 版本快照管理 | 界面需求v2界面4 | 6.4.7-6.4.9节 | ✅ 完全覆盖 | - |
| **FR-13** | 知识库数据验证 | 界面需求v2界面4 | 6.4.6节 | ⚠️ 设计不足 | 🟡 缺少验证规则定义 |
| **FR-14** | Markdown格式支持 | 界面需求v2界面4 | 15.5节 | ✅ 完全覆盖 | - |
| **FR-15** | 快照恢复确认 | 界面需求v2界面4 | 15.5节 | ✅ 完全覆盖 | - |

**需求覆盖度统计**:
- ✅ 完全覆盖: 10项 (66.7%)
- ⚠️ 设计不足: 3项 (20%)
- ❌ 完全缺失或部分覆盖: 2项 (13.3%)

**总体覆盖度**: **80%** (12/15项基本覆盖)

#### 2.1.2 功能遗漏清单

| 序号 | 遗漏功能 | 严重程度 | 影响 | 修复建议 |
|-----|---------|---------|------|---------|
| 1 | **多图诊断（2-5张）** | 🔴 阻塞性 | 核心需求未满足 | P3新增子任务P3.7实现多图特征融合 |
| 2 | **Excel报告导出** | 🔴 阻塞性 | 用户体验差 | P2新增ExcelExporter模块 |
| 3 | **批量诊断异步处理** | 🔴 高优先级 | 批量诊断不可用 | P3新增子任务P3.8实现异步任务队列 |

---

### 2.2 功能完整性分析

#### 2.2.1 界面1：单图诊断功能评审

**✅ 已覆盖功能**:
1. ✅ 图片上传（支持JPG/PNG/HEIC，最大10MB）
2. ✅ VLM问答对详情展示（Q0.0-Q0.5, Q1-Q6共13个问题）
3. ✅ 特征匹配详情展示（按权重分组：高/中/低）
4. ✅ 推理依据展示（匹配成功的特征列表）
5. ✅ 诊断结果展示（疾病名称、置信度、病原体、建议）
6. ✅ 准确性标注（正确/错误标记 + 反馈意见）

**❌ 缺失功能**:
1. 🔴 **多图诊断（2-5张图片）**
   - **需求来源**: 需求文档3.1节明确"支持1-N张图片诊断"
   - **当前设计**: 仅支持单图上传
   - **用户影响**: 无法同时上传叶片正反面进行综合诊断
   - **修复方案**:
     - 前端：支持多选文件，显示缩略图列表
     - 后端：P3.7实现多图特征融合算法
     - API：修改`POST /api/v1/diagnose/single`支持images数组

**⚠️ 设计不足**:
1. 🟡 **加载状态不够细化**
   - **问题**: 设计仅有"诊断中..."，未细化为"提取特征中(30%)"、"VLM分析中(60%)"、"匹配知识库中(90%)"
   - **建议**: 参考详细设计15.2节增加进度条

**功能完整性评分**: ⭐⭐⭐⭐☆ (4/5)

---

#### 2.2.2 界面2：批量诊断功能评审

**✅ 已覆盖功能**:
1. ✅ 批量上传（最多50张）
2. ✅ 手动刷新机制（轮询状态，非自动刷新）
3. ✅ 结果列表展示（缩略图、文件名、诊断结果、置信度）
4. ✅ 翻页功能（每页10条）
5. ✅ 双击查看详情（Modal弹窗展示完整诊断信息）
6. ✅ 过滤筛选（按诊断状态、置信度筛选）

**❌ 缺失功能**:
1. 🔴 **Excel报告导出**
   - **需求来源**: 界面需求v2界面2明确"导出Excel报告（含图表）"
   - **当前设计**: 仅提到CSV导出（设计文档15.3节），但未实现
   - **用户影响**: 无法生成专业报告给植保专家
   - **修复方案**:
     - P2.7新增ExcelExporter模块（使用openpyxl库）
     - 支持工作表：诊断结果列表、统计图表（疾病分布饼图、置信度柱状图）
     - API：新增`GET /api/v1/diagnose/batch/{batch_id}/export?format=xlsx`

2. 🟡 **批量诊断任务取消**
   - **场景**: 用户误上传100张图片，希望取消任务
   - **当前设计**: 无取消接口
   - **修复方案**: 新增`DELETE /api/v1/diagnose/batch/{batch_id}`接口

**⚠️ 设计不足**:
1. 🟡 **缺少异步任务处理逻辑**
   - **问题**: 设计了批量API（6.6节）但未说明如何实现异步处理
   - **风险**: 批量诊断可能阻塞服务器，影响其他用户
   - **修复方案**: P3.8实现基于asyncio.Queue的异步任务队列

2. 🟡 **进度展示不够实时**
   - **问题**: 手动刷新机制用户体验差
   - **建议**: 虽然MVP范围不支持WebSocket，但可以优化为"自动轮询（每5秒） + 手动刷新按钮"

**功能完整性评分**: ⭐⭐⭐☆☆ (3/5)

---

#### 2.2.3 界面3：本体管理功能评审

**✅ 已覆盖功能**:
1. ✅ 本体类型卡片展示（花卉宿主、疾病、病原体、症状、特征）
2. ✅ Schema详情查看（字段列表、类型说明、必填标记）
3. ✅ 类型筛选（按本体类型快速定位）
4. ✅ 关系图谱展示（可选，使用D3.js或ECharts）

**❌ 缺失功能**:
无

**⚠️ 设计不足**:
1. 🟡 **缺少Schema变更历史**
   - **问题**: ontology_changes表已设计（9.2节），但前端未展示
   - **建议**: 界面3新增"变更历史"tab，展示Schema修改记录

**功能完整性评分**: ⭐⭐⭐⭐⭐ (5/5)

---

#### 2.2.4 界面4：知识库管理功能评审

**✅ 已覆盖功能**:
1. ✅ 知识库树形展示（5层：宿主→疾病→病原体→症状→特征）
2. ✅ 疾病CRUD操作（新建、查看、编辑、删除）
3. ✅ Markdown格式支持（富文本编辑器）
4. ✅ 数据验证（JSON Schema + Pydantic）
5. ✅ 版本快照管理（创建快照、查看历史、恢复版本）
6. ✅ 快照恢复确认（二次确认弹窗，显示变更数量）

**❌ 缺失功能**:
无

**⚠️ 设计不足**:
1. 🟡 **缺少快照恢复预览功能**
   - **问题**: 用户无法在恢复前预览会覆盖哪些疾病
   - **建议**: 新增`GET /api/v1/knowledge/restore/{snapshot_id}/preview`接口，返回差异对比

2. 🟡 **缺少并发编辑冲突提示**
   - **问题**: 两个用户同时编辑同一疾病，后保存者会覆盖前者
   - **建议**: 实现乐观锁机制（version字段），冲突时提示用户刷新

**功能完整性评分**: ⭐⭐⭐⭐☆ (4/5)

---

### 2.3 P0-P3阶段功能影响分析（重点）

#### 2.3.1 P0阶段是否需要增补功能

**结论**: ❌ 无需增补功能

P0阶段仅涉及环境准备与架构设计，不涉及具体功能实现。

---

#### 2.3.2 P1阶段是否需要增补功能

**🔴 必须增补**:

1. **新增API协议定义（12个）**:
   - 知识库树API: `GET /api/v1/knowledge/tree`
   - 批量诊断API: `POST /api/v1/diagnose/batch` + 2个查询接口
   - 图片管理API: `GET /api/v1/images` + `PATCH /images/{id}/accuracy`
   - 快照管理API: 3个接口（创建、列表、恢复）
   - 本体管理API: 2个接口（列表、详情）
   - **Excel导出API**: `GET /api/v1/diagnose/batch/{batch_id}/export?format=xlsx`

2. **新增数据库表设计（3张）**:
   - knowledge_snapshots
   - batch_diagnosis_sessions
   - accuracy_feedback

3. **新增Pydantic Schema定义（8个）**:
   - KnowledgeTreeResponse
   - BatchDiagnosisRequest/Response
   - SnapshotCreateRequest/Response
   - ImageListResponse
   - AccuracyLabelRequest
   - ExcelExportRequest

**工期影响**: P1阶段工期需从1.5天调整为**2.5天** (+1天)

---

#### 2.3.3 P2阶段是否需要增补功能

**🔴 必须增补**:

1. **Excel导出器（ExcelExporter）**:
   - 支持xlsx格式
   - 生成工作表：诊断结果列表、统计图表（疾病分布饼图、置信度柱状图）
   - 工作量: 0.4天

2. **批量诊断队列管理器（BatchDiagnosisQueue）**:
   - 异步任务队列（asyncio.Queue）
   - 后台worker池（3个并发worker）
   - 工作量: 0.5天

3. **快照存储管理器（SnapshotStorage）**:
   - tar.gz格式压缩知识库
   - 快照文件管理（创建、恢复、删除）
   - 工作量: 0.3天

**工期影响**: P2阶段工期需从3天调整为**4.2天** (+1.2天)

---

#### 2.3.4 P3阶段是否需要调整功能

**🔴 必须新增**:

1. **P3.7: 多图诊断特征融合**:
   - 实现`diagnose_multi_images(images: List[bytes])`方法
   - 特征融合算法:
     - Q0层：投票机制（多数原则，如3/5张识别为"樱花" → 樱花）
     - Q1-Q6层：加权平均（置信度作为权重）
   - 支持2-5张图片
   - 工作量: 0.8天

2. **P3.8: 批量诊断异步任务编排**:
   - 实现BatchDiagnosisService
   - 异步任务提交、状态查询、进度追踪
   - 后台worker自动处理队列任务
   - 工作量: 0.6天

**工期影响**: P3阶段工期需从3天调整为**4.4天** (+1.4天)

---

### 2.4 用户体验评估

#### 2.4.1 操作流程顺畅性

| 界面 | 操作流程 | 顺畅性评分 | 改进建议 |
|-----|---------|----------|---------|
| **界面1** | 上传→诊断→查看结果→标注准确性 | ⭐⭐⭐⭐☆ (4/5) | 增加多图上传支持 |
| **界面2** | 批量上传→手动刷新→查看结果→导出报告 | ⭐⭐⭐☆☆ (3/5) | 增加Excel导出，优化为自动轮询 |
| **界面3** | 选择类型→查看Schema→查看关系 | ⭐⭐⭐⭐⭐ (5/5) | 无 |
| **界面4** | 浏览树→编辑疾病→创建快照→恢复 | ⭐⭐⭐⭐☆ (4/5) | 增加快照恢复预览 |

**总体顺畅性**: ⭐⭐⭐⭐☆ (4/5)

#### 2.4.2 错误处理友好性

**✅ 优秀之处**:
1. ✅ 统一错误响应格式（error/detail/timestamp/trace_id）
2. ✅ 前端错误提示友好（Toast + Modal）
3. ✅ 图片大小限制明确（最大10MB）

**⚠️ 改进建议**:
1. 🟡 **缺少网络超时提示**: VLM调用超时时，应提示"诊断服务响应较慢，请稍后重试"
2. 🟡 **缺少并发冲突提示**: 知识库编辑冲突时，应显示具体冲突字段

**总体友好性**: ⭐⭐⭐⭐☆ (4/5)

#### 2.4.3 加载反馈明确性

**✅ 优秀之处**:
1. ✅ 诊断过程显示"诊断中..."加载状态
2. ✅ 批量诊断显示进度条（已完成/总数）
3. ✅ 图片上传显示上传进度

**⚠️ 改进建议**:
1. 🟡 **单图诊断加载状态不够细化**: 建议细化为"提取特征(30%) → VLM分析(60%) → 匹配知识库(90%)"
2. 🟡 **批量诊断手动刷新体验差**: 建议改为"自动轮询（每5秒） + 手动刷新按钮"

**总体明确性**: ⭐⭐⭐⭐☆ (4/5)

---

### 2.5 测试用例覆盖度评估

#### 2.5.1 第16.5节测试用例评估

**测试用例统计**:
- 界面1单图诊断: 5个用例（TC-S01~S05）
- 界面2批量诊断: 5个用例（TC-B01~B05）
- 界面3本体管理: 3个用例（TC-O01~O03）
- 界面4知识库管理: 7个用例（TC-K01~K07）
- 错误处理: 2个用例（TC-E01~E02）
- **总计**: 22个测试用例

**覆盖度分析**:
- ✅ 正常流程覆盖: 100% (所有核心功能都有正常用例)
- ✅ 异常场景覆盖: 90% (缺少并发冲突、网络超时测试)
- ✅ 边界条件覆盖: 85% (缺少多图诊断边界测试)

**改进建议**:
1. 🟡 **增加多图诊断测试用例**:
   - TC-S06: 上传2张同一疾病图片，验证特征融合
   - TC-S07: 上传5张不同疾病图片，验证诊断失败提示

2. 🟡 **增加并发冲突测试用例**:
   - TC-K08: 两个用户同时编辑同一疾病，验证乐观锁提示

3. 🟡 **增加Excel导出测试用例**:
   - TC-B06: 批量诊断完成后导出Excel，验证报告格式

**第16.5节评分**: ⭐⭐⭐⭐☆ (4/5)

---

#### 2.5.2 第16.6节E2E场景评估

**E2E场景统计**:
- 16.6.1: 界面1单图诊断E2E场景
- 16.6.2: 界面2批量诊断E2E场景
- 16.6.3: 界面3本体管理E2E场景
- 16.6.4: 界面4知识库管理E2E场景
- **总计**: 4个E2E场景

**覆盖度分析**:
- ✅ 用户路径完整性: 100% (所有界面都有完整E2E场景)
- ✅ Gherkin格式规范: 100% (Given-When-Then结构清晰)
- ⚠️ 跨界面流程覆盖: 0% (缺少跨界面操作场景，如"界面4编辑疾病 → 界面1诊断验证")

**改进建议**:
1. 🟡 **增加跨界面E2E场景**:
   - 16.6.5: 知识库更新后诊断验证（界面4 → 界面1）
   - 场景: 管理员在界面4新增疾病"樱花锈病"，用户在界面1上传樱花锈病图片，验证诊断结果包含新疾病

2. 🟡 **增加多图诊断E2E场景**:
   - 16.6.1修改: 上传2-5张图片进行诊断

**第16.6节评分**: ⭐⭐⭐⭐☆ (4/5)

---

#### 2.5.3 测试覆盖缺口

| 缺口类型 | 描述 | 严重程度 | 建议补充 |
|---------|------|---------|---------|
| **多图诊断** | 缺少2-5张图片诊断测试 | 🔴 高 | 新增TC-S06, TC-S07 |
| **Excel导出** | 缺少报告导出验证 | 🔴 高 | 新增TC-B06 |
| **并发冲突** | 缺少知识库并发编辑测试 | 🟡 中 | 新增TC-K08 |
| **跨界面流程** | 缺少跨界面操作E2E场景 | 🟡 中 | 新增16.6.5 |
| **网络超时** | 缺少VLM超时场景测试 | 🟡 中 | 新增TC-E03 |

---

### 2.6 功能改进建议

#### 2.6.1 必须修复项（🔴 P4前完成）

| 序号 | 改进项 | 当前问题 | 修复方案 | 影响阶段 | 工作量 |
|-----|-------|---------|---------|---------|--------|
| 1 | **多图诊断功能** | 仅支持单图，不满足需求 | P3.7实现多图特征融合 | P3 | 0.8天 |
| 2 | **Excel报告导出** | 仅提到CSV，未实现Excel | P2.7新增ExcelExporter模块 | P2 | 0.4天 |
| 3 | **批量诊断异步处理** | 设计了API但缺少实现逻辑 | P3.8实现异步任务队列 | P3 | 0.6天 |
| 4 | **API接口定义补充** | P1缺少12个API的OpenAPI定义 | P1.1补充openapi.yaml | P1 | 0.5天 |
| 5 | **数据库表设计补充** | P1缺少3张表的DDL脚本 | P1.2补充init_db.sql | P1 | 0.3天 |
| 6 | **知识库并发控制** | 缺少乐观锁机制 | P4实现version字段检查 | P4 | 0.5天 |

**总工作量**: 3.1天

---

#### 2.6.2 建议优化项（🟡 P6-P7阶段完成）

| 序号 | 改进项 | 当前问题 | 优化方案 | 影响阶段 | 工作量 |
|-----|-------|---------|---------|---------|--------|
| 1 | **批量诊断任务取消** | 无法取消误上传的批量任务 | P6新增DELETE接口 | P6 | 0.3天 |
| 2 | **快照恢复预览** | 无法预览恢复前的差异 | P6新增preview接口 | P6 | 0.4天 |
| 3 | **批量准确性标注** | 逐张标注效率低 | P6新增批量标注接口 | P6 | 0.3天 |
| 4 | **单图诊断进度细化** | 仅显示"诊断中..." | P5细化为3阶段进度条 | P5 | 0.2天 |
| 5 | **批量诊断自动轮询** | 手动刷新体验差 | P5改为自动轮询（每5秒） | P5 | 0.2天 |
| 6 | **并发冲突提示** | 覆盖保存无提示 | P6增加冲突检测提示 | P6 | 0.2天 |

**总工作量**: 1.6天

---

#### 2.6.3 未来增强项（🔵 MVP范围外，v1.2版本）

| 序号 | 增强项 | 业务价值 | 技术难度 | 预估工作量 |
|-----|-------|---------|---------|-----------|
| 1 | **WebSocket实时推送** | 批量诊断实时更新，无需轮询 | 中 | 2天 |
| 2 | **历史诊断记录查询** | 方便用户查看过往诊断 | 低 | 1天 |
| 3 | **诊断报告PDF导出** | 更正式的报告格式 | 低 | 1.5天 |
| 4 | **知识库变更审计日志** | 追溯疾病数据修改历史 | 中 | 1天 |
| 5 | **多VLM Provider切换** | Qwen/GPT-4V/Claude可选 | 高 | 3天 |
| 6 | **图数据库集成（Neo4j）** | 更高效的本体关系查询 | 高 | 5天 |

---

## 三、综合评审结论

### 3.1 问题汇总与优先级

#### 3.1.1 阻塞性问题（🔴 必须在P4前解决）

| 序号 | 问题类型 | 问题描述 | 影响 | 解决方案 | 责任阶段 | 工作量 |
|-----|---------|---------|------|---------|---------|--------|
| 1 | 功能缺失 | 多图诊断功能完全缺失 | 核心需求未满足 | P3.7实现多图特征融合 | P3 | 0.8天 |
| 2 | 功能缺失 | Excel报告导出缺失 | 用户体验差 | P2.7新增ExcelExporter | P2 | 0.4天 |
| 3 | 功能缺失 | 批量诊断异步处理逻辑缺失 | 批量诊断不可用 | P3.8实现异步任务队列 | P3 | 0.6天 |
| 4 | 设计不完整 | P1缺少15个API接口定义 | 无法进入P4开发 | P1.1补充openapi.yaml | P1 | 1天 |
| 5 | 技术债务 | DiagnosisService职责过重 | 可维护性差 | P4.1拆分为3个Service | P4 | 1天 |
| 6 | 数据一致性 | 知识库并发更新无控制 | 数据丢失风险 | P4实现乐观锁 | P4 | 0.5天 |

**总工作量**: 4.3天

---

#### 3.1.2 高优先级问题（🟡 P6前解决）

| 序号 | 问题类型 | 问题描述 | 影响 | 解决方案 | 责任阶段 | 工作量 |
|-----|---------|---------|------|---------|---------|--------|
| 1 | 性能风险 | VLM调用延迟6.5秒，超过需求 | 用户体验差 | P4实现Q1-Q6并行调用 | P4 | 0.3天 |
| 2 | 内存风险 | 批量诊断可能OOM | 服务崩溃 | P4限制并发任务数+流式处理 | P4 | 0.4天 |
| 3 | 缓存策略 | VLM缓存错误结果7天 | 错误结果持久化 | P4仅缓存高置信度结果 | P4 | 0.3天 |
| 4 | API设计 | 6.3节和6.4节接口重复 | 前端调用困惑 | P4.1统一API路径规范 | P4 | 0.2天 |
| 5 | 数据库设计 | diagnoses表缺少分区策略 | 查询性能下降 | P4添加按月分区 | P4 | 0.3天 |
| 6 | 用户体验 | 批量诊断无法取消任务 | 操作不便 | P6新增取消接口 | P6 | 0.3天 |
| 7 | 用户体验 | 快照恢复无预览功能 | 误操作风险 | P6新增预览接口 | P6 | 0.4天 |
| 8 | 测试覆盖 | 缺少多图诊断测试用例 | 测试不完整 | P7补充测试用例 | P7 | 0.2天 |

**总工作量**: 2.4天

---

#### 3.1.3 中优先级问题（🟢 P7阶段解决）

| 序号 | 问题类型 | 问题描述 | 解决方案 | 工作量 |
|-----|---------|---------|---------|--------|
| 1 | 架构优化 | ImageRepository缺少抽象接口 | P7定义IImageRepository | 0.2天 |
| 2 | 架构优化 | FuzzyMatcher硬编码规则 | P7改为配置驱动 | 0.3天 |
| 3 | 用户体验 | 单图诊断进度不够细化 | P7细化为3阶段进度条 | 0.2天 |
| 4 | 用户体验 | 批量诊断手动刷新体验差 | P7改为自动轮询 | 0.2天 |
| 5 | 测试覆盖 | 缺少跨界面E2E场景 | P7新增16.6.5场景 | 0.3天 |

**总工作量**: 1.2天

---

### 3.2 工期调整建议

#### 3.2.1 各阶段工期调整明细

| 阶段 | 原工期 | 必修项工作量 | 调整后工期 | 变化 | 主要增补内容 |
|------|-------|-----------|----------|------|------------|
| **P0** | 0.5天 | 0天 | 0.5天 | - | 无需调整 |
| **P1** | 1.5天 | +1天 | **2.5天** | +1天 | 15个API定义 + 3张表DDL |
| **P2** | 3天 | +1.2天 | **4.2天** | +1.2天 | 批量队列 + Excel导出 + 快照存储 |
| **P3** | 3天 | +1.4天 | **4.4天** | +1.4天 | 多图融合 + 异步任务编排 |
| **P3.9** | 0.6天 | 0天 | 0.6天 | - | 无需调整 |
| **P4** | 2.5天 | +2天 | **4.5天** | +2天 | Service拆分 + 并发控制 + 性能优化 |
| **P5** | 4.5天 | 0天 | 4.5天 | - | 无需调整 |
| **P6** | 1.5天 | +0.7天 | **2.2天** | +0.7天 | 取消接口 + 预览接口 |
| **P7** | 2.5天 | +0.2天 | **2.7天** | +0.2天 | 补充测试用例 |
| **P8** | 1天 | 0天 | 1天 | - | 无需调整 |
| **总计** | **20.1天** | **+6.5天** | **26.6天** | **+6.5天** | - |

#### 3.2.2 里程碑日期调整

```
原计划总工期: 20.1天
调整后总工期: 26.6天 (+6.5天)

关键里程碑:
- D+2.5 (G1): API协议与数据库设计完成（原D+2）
- D+6.7 (G2): 基础设施开发完成（原D+5）
- D+11.1 (G3): 诊断引擎完成（原D+8）
- D+11.7 (G3.9): P0-P3模块修改完成（原D+8.6）
- D+16.2 (G4): 完整后端API开发完成（原D+11.1）
- D+20.7 (G5): 前端开发完成（原D+15.6）
- D+22.9 (G6): 前后端联调完成（原D+17.1）
- D+25.6 (G7): 测试完成（原D+19.6）
- D+26.6 (G8): MVP交付（原D+20.6）
```

---

### 3.3 风险评估与缓解措施

#### 3.3.1 高风险项（⚠️ 需要立即关注）

| 风险ID | 风险描述 | 概率 | 影响 | 风险等级 | 缓解措施 | 责任人 |
|--------|---------|------|------|---------|---------|--------|
| **R1** | VLM调用延迟超过5秒 | 高(80%) | 严重 | 🔴 高 | Q1-Q6并行调用，优化缓存策略 | 技术架构师 |
| **R2** | 批量诊断内存溢出 | 中(50%) | 严重 | 🔴 高 | 限制并发数，流式处理 | 技术架构师 |
| **R3** | 知识库并发冲突 | 中(40%) | 严重 | 🔴 高 | 实现乐观锁机制 | 技术架构师 |
| **R4** | 多图诊断开发超期 | 中(50%) | 中等 | 🟡 中 | 预留缓冲时间，简化算法 | 产品总监 |
| **R5** | Excel导出功能复杂 | 低(30%) | 中等 | 🟡 中 | 使用成熟库（openpyxl） | 产品总监 |

#### 3.3.2 风险监控计划

**每周风险检查点**:
- **P1阶段**: 检查API定义完整性（G1 Gate Review）
- **P2阶段**: 检查批量队列和Excel导出进度（G2 Gate Review）
- **P3阶段**: 检查多图诊断和异步任务测试结果（G3 Gate Review）
- **P4阶段**: 检查VLM性能优化效果（响应时间监控）
- **P6阶段**: 检查前后端联调冲突数量（Bug Tracking）

---

### 3.4 关键决策点

以下5个关键决策需要项目团队确认:

#### 决策1: 是否拆分DiagnosisService？

- **选项A**: 立即拆分（推荐）
  - 优点: 降低复杂度，提高可维护性
  - 缺点: P4阶段增加1天工作量
  - **建议**: ✅ 采纳

- **选项B**: 保持现状
  - 优点: 无额外工作量
  - 缺点: 技术债务累积，后期维护困难
  - **建议**: ❌ 不推荐

**决策结果**: ________（待确认）

---

#### 决策2: 多图诊断支持几张图片？

- **选项A**: 2-5张（推荐）
  - 优点: 满足需求文档"1-N张"
  - 缺点: 特征融合算法复杂度增加
  - **建议**: ✅ 采纳

- **选项B**: 仅支持2张
  - 优点: 实现简单
  - 缺点: 不满足需求
  - **建议**: ❌ 不推荐

**决策结果**: ________（待确认）

---

#### 决策3: VLM并行调用策略？

- **选项A**: Q1-Q6全部并行（推荐）
  - 优点: 性能最优（延迟降低66%）
  - 缺点: 需测试Qwen并发限制
  - **建议**: ✅ 采纳

- **选项B**: Q1-Q3并行，Q4-Q6串行
  - 优点: 折中方案
  - 缺点: 性能提升有限
  - **建议**: ⚠️ 备选

- **选项C**: 保持串行
  - 优点: 最保守
  - 缺点: 性能差，超过5秒需求
  - **建议**: ❌ 不推荐

**决策结果**: ________（待确认）

---

#### 决策4: 批量诊断并发任务数限制？

- **选项A**: 最多2个并发（推荐）
  - 优点: 内存安全
  - 缺点: 用户等待时间长
  - **建议**: ✅ 采纳

- **选项B**: 最多3个并发
  - 优点: 吞吐量高
  - 缺点: 内存风险
  - **建议**: ⚠️ 需测试服务器内存

- **选项C**: 不限制
  - 优点: 无限制
  - 缺点: OOM风险极高
  - **建议**: ❌ 不推荐

**决策结果**: ________（待确认）

---

#### 决策5: Excel导出是否包含图表？

- **选项A**: 包含图表（推荐）
  - 优点: 符合界面需求v2要求
  - 缺点: 增加0.2天工作量
  - **建议**: ✅ 采纳

- **选项B**: 仅导出表格
  - 优点: 实现简单
  - 缺点: 不满足需求
  - **建议**: ❌ 不推荐

**决策结果**: ________（待确认）

---

### 3.5 最终建议

#### 3.5.1 立即行动项（本周完成）

1. 🔴 **P1阶段增补**: 补充15个API接口的OpenAPI定义和3张数据库表的DDL脚本（工作量1天）
2. 🔴 **P2阶段规划**: 新增P2.7子任务，包含批量队列、Excel导出、快照存储（工作量1.2天）
3. 🔴 **P3阶段规划**: 新增P3.7（多图融合）和P3.8（异步任务）子任务（工作量1.4天）
4. 🔴 **P4阶段规划**: 制定DiagnosisService拆分计划和性能优化方案（工作量2天）
5. 🔴 **关键决策**: 召开团队会议，确认第3.4节的5个关键决策

#### 3.5.2 研发计划更新清单

以下内容需要更新到`研发计划v2.0.md`:

1. **第3节 阶段划分总览**: 更新各阶段工期（见3.2.1节）
2. **第4节 关键里程碑**: 更新里程碑日期（见3.2.2节）
3. **P1阶段**: 新增P1.1.1子任务"补充15个API接口定义"
4. **P2阶段**: 新增P2.7子任务"批量处理、快照管理与报告导出基础设施开发"
5. **P3阶段**: 新增P3.7子任务"多图诊断特征融合"，新增P3.8子任务"批量诊断异步任务编排"
6. **P4阶段**: 新增P4.1.1子任务"DiagnosisService拆分重构"

#### 3.5.3 详细设计更新清单

以下内容需要更新到`详细设计文档v2.0.md`:

1. **第6章 API设计**:
   - 删除6.3节重复接口定义
   - 新增6.2.2节"多图诊断API"
   - 新增6.6.4节"取消批量任务API"
   - 新增6.4.10节"快照恢复预览API"
   - 新增6.8节"报告导出API"

2. **第7章 服务层设计**:
   - 拆分7.1节DiagnosisService为3个Service
   - 新增7.8节"QuestioningService"
   - 新增7.9节"MatchingService"
   - 新增7.10节"DiagnosisOrchestrator"

3. **第9章 数据库设计**:
   - 9.2节新增accuracy_feedback表DDL
   - 9.1节diagnoses表新增分区设计

4. **第16章 测试用例**:
   - 16.5节新增TC-S06, TC-S07（多图诊断）
   - 16.5节新增TC-B06（Excel导出）
   - 16.5节新增TC-K08（并发冲突）
   - 16.6节新增16.6.5场景（跨界面E2E）

---

## 四、附录

### 附录A: P1阶段必须增补的API接口清单

| 序号 | 接口 | 方法 | 路径 | 请求体 | 响应体 | 优先级 |
|-----|------|------|-----|-------|-------|--------|
| 1 | 知识库树 | GET | /api/v1/knowledge/tree | 无 | KnowledgeTreeResponse | P0 |
| 2 | 数据验证 | POST | /api/v1/knowledge/validate | DiseaseOntology | ValidationResult | P0 |
| 3 | 创建快照 | POST | /api/v1/knowledge/snapshot | SnapshotCreateRequest | SnapshotResponse | P1 |
| 4 | 快照列表 | GET | /api/v1/knowledge/snapshots | 查询参数 | SnapshotListResponse | P1 |
| 5 | 恢复快照 | POST | /api/v1/knowledge/restore/{id} | RestoreRequest | RestoreResponse | P1 |
| 6 | 本体列表 | GET | /api/v1/ontology/list | 无 | OntologyListResponse | P0 |
| 7 | 本体详情 | GET | /api/v1/ontology/{type} | 无 | OntologySchemaResponse | P0 |
| 8 | 批量诊断 | POST | /api/v1/diagnose/batch | 图片数组 | BatchDiagnosisResponse | P0 |
| 9 | 批量结果 | GET | /api/v1/diagnose/batch/{id} | 无 | BatchResultResponse | P0 |
| 10 | 批量进度 | GET | /api/v1/diagnose/batch/{id}/progress | 无 | ProgressResponse | P0 |
| 11 | 图片列表 | GET | /api/v1/images | 查询参数 | ImageListResponse | P0 |
| 12 | 准确性标注 | PATCH | /api/v1/images/{id}/accuracy | AccuracyLabelRequest | AccuracyResponse | P0 |
| 13 | 多图诊断 | POST | /api/v1/diagnose/multi | 图片数组（2-5张） | DiagnosisResponse | P0 |
| 14 | Excel导出 | GET | /api/v1/diagnose/batch/{id}/export | 查询参数format=xlsx | Excel文件流 | P0 |
| 15 | 取消批量任务 | DELETE | /api/v1/diagnose/batch/{id} | 无 | CancelResponse | P1 |

### 附录B: P1阶段必须增补的数据库表DDL

```sql
-- 知识库快照表
CREATE TABLE knowledge_snapshots (
    snapshot_id VARCHAR(50) PRIMARY KEY,
    version VARCHAR(20) NOT NULL,
    description TEXT,
    snapshot_path VARCHAR(255) NOT NULL,
    file_size_bytes BIGINT CHECK (file_size_bytes <= 104857600),  -- 最大100MB
    disease_count INT,
    created_at TIMESTAMP DEFAULT NOW(),
    created_by VARCHAR(100),
    INDEX idx_snapshots_created_at (created_at DESC)
);

-- 批量诊断会话表
CREATE TABLE batch_diagnosis_sessions (
    batch_id VARCHAR(50) PRIMARY KEY,
    total_images INT NOT NULL CHECK (total_images <= 100),  -- 最多100张
    completed_images INT DEFAULT 0,
    failed_images INT DEFAULT 0,
    status VARCHAR(20) DEFAULT 'processing' CHECK (status IN ('processing', 'completed', 'failed', 'cancelled')),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    INDEX idx_batch_status (status),
    INDEX idx_batch_created_at (created_at DESC)
);

-- 准确性反馈表
CREATE TABLE accuracy_feedback (
    feedback_id VARCHAR(50) PRIMARY KEY,
    image_id VARCHAR(50) REFERENCES images(image_id) ON DELETE CASCADE,
    diagnosis_id VARCHAR(50) REFERENCES diagnoses(diagnosis_id) ON DELETE CASCADE,
    is_accurate BOOLEAN NOT NULL,
    user_comment TEXT,
    marked_at TIMESTAMP DEFAULT NOW(),
    marked_by VARCHAR(100),
    INDEX idx_feedback_accurate (is_accurate),
    INDEX idx_feedback_marked_at (marked_at DESC)
);

-- diagnoses表增加分区（性能优化）
-- 注意：需要重建diagnoses表
CREATE TABLE diagnoses (
    diagnosis_id VARCHAR(50) PRIMARY KEY,
    image_id VARCHAR(50) REFERENCES images(image_id),
    disease_name VARCHAR(200),
    confidence DECIMAL(5,4),
    created_at TIMESTAMP DEFAULT NOW(),
    -- 其他字段...
) PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at));

-- 创建分区（示例：2025年11月-2026年12月）
CREATE TABLE diagnoses_202511 PARTITION OF diagnoses
    FOR VALUES FROM (202511) TO (202512);
CREATE TABLE diagnoses_202512 PARTITION OF diagnoses
    FOR VALUES FROM (202512) TO (202601);
-- ...后续按月创建分区
```

### 附录C: 关键技术决策记录

| 决策ID | 决策主题 | 决策内容 | 决策日期 | 决策人 | 状态 |
|-------|---------|---------|---------|--------|------|
| **TD-1** | DiagnosisService拆分 | 拆分为QuestioningService + MatchingService + DiagnosisOrchestrator | 待定 | 技术架构师 | ⏳ 待确认 |
| **TD-2** | VLM并行调用 | Q1-Q6全部并行调用，降低延迟66% | 待定 | 技术架构师 | ⏳ 待确认 |
| **TD-3** | 多图诊断支持数量 | 支持2-5张图片，使用加权平均融合 | 待定 | 产品总监 | ⏳ 待确认 |
| **TD-4** | 批量并发限制 | 最多2个批量任务并发，防止OOM | 待定 | 技术架构师 | ⏳ 待确认 |
| **TD-5** | Excel导出格式 | 包含图表（疾病分布饼图+置信度柱状图） | 待定 | 产品总监 | ⏳ 待确认 |
| **TD-6** | API路径规范 | 删除6.3节重复接口，统一使用单数形式 | 待定 | 技术架构师 | ⏳ 待确认 |
| **TD-7** | 知识库并发控制 | 使用乐观锁（version字段） | 待定 | 技术架构师 | ⏳ 待确认 |

### 附录D: 质量保证检查清单

**P1阶段 Gate Review (G1)**:
- [ ] 15个API接口的OpenAPI定义已补充到`docs/api/openapi.yaml`
- [ ] 3张数据库表的DDL脚本已添加到`backend/scripts/init_db.sql`
- [ ] 所有Pydantic Schema定义完整（8个新增Schema）
- [ ] API接口路径统一规范（删除6.3节重复接口）

**P2阶段 Gate Review (G2)**:
- [ ] BatchDiagnosisQueue实现完成，单元测试通过
- [ ] ExcelExporter实现完成，生成的Excel包含图表
- [ ] SnapshotStorage实现完成，快照压缩解压测试通过

**P3阶段 Gate Review (G3)**:
- [ ] 多图诊断功能实现完成，2-5张图片测试通过
- [ ] 特征融合算法验证通过（加权平均）
- [ ] 异步任务队列实现完成，3个并发worker运行正常
- [ ] 批量诊断性能测试通过（50张图片<5分钟）

**P4阶段 Gate Review (G4)**:
- [ ] DiagnosisService拆分完成，3个Service独立运行
- [ ] VLM并行调用实现完成，延迟降低到2.2秒以内
- [ ] 知识库乐观锁实现完成，并发冲突测试通过
- [ ] 26个API接口全部实现，Postman测试100%通过

**P5阶段 Gate Review (G5)**:
- [ ] 4个前端界面开发完成，样式与原型一致
- [ ] 多图上传功能实现完成，显示缩略图列表
- [ ] Excel导出按钮已添加，点击触发下载

**P6阶段 Gate Review (G6)**:
- [ ] 前后端完全联通，API对接无CORS错误
- [ ] 20+联调测试用例全部通过（TC-S01~TC-K08）
- [ ] 取消批量任务接口测试通过
- [ ] 快照恢复预览接口测试通过

**P7阶段 Gate Review (G7)**:
- [ ] 所有单元测试通过，覆盖率≥80%
- [ ] 所有集成测试通过
- [ ] 4个E2E场景全部通过（16.6.1~16.6.5）
- [ ] 新增测试用例全部通过（TC-S06~TC-S07, TC-B06, TC-K08）

**P8阶段 Gate Review (G8)**:
- [ ] 本地部署成功，系统正常运行
- [ ] 验收测试通过，所有需求满足
- [ ] 用户手册编写完成
- [ ] MVP交付报告完成

---

## 五、评审签字

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| **技术架构师** | Claude | __________ | 2025-11-14 |
| **产品总监** | Claude | __________ | 2025-11-14 |
| **项目经理** | ________ | __________ | ________ |
| **研发负责人** | ________ | __________ | ________ |

---

**报告结束**

> **下一步行动**: 请项目团队在1周内完成第3.4节的5个关键决策确认，并启动P1阶段增补工作。
