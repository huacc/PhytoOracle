# 研发计划 vs 详细设计对照分析

**生成时间**：2025-11-11 21:45:00
**对比版本**：
- 研发计划v1.0
- 详细设计文档v1.1（重构Section 5后）

---

## 一、核心架构对比

### 详细设计v1.1的架构分层

**3个应用服务（Application Services）**：
1. DiagnosisService（诊断服务）
2. KnowledgeService（知识库服务）
3. ImageService（图片服务）

**6个基础设施模块（Infrastructure Modules）**：
1. VLMClient（VLM客户端）
2. FuzzyMatcher（模糊匹配引擎）
3. DiagnosisScorer（加权诊断评分器）
4. KnowledgeLoader（知识库加载器）
5. PROOF Framework（提示词框架）
6. **LocalImageStorage（本地图片存储）** ← 新增明确模块

### 4层依赖结构（详细设计5.4节）

```
第1层（无依赖）：
  ├─ FuzzyMatcher（模糊匹配引擎）
  ├─ PROOF Framework（提示词框架）
  └─ LocalImageStorage（本地图片存储）  ← ⚠️ 关键：LocalImageStorage是Layer 1

第2层（依赖第1层）：
  ├─ VLMClient（依赖PROOF Framework）
  ├─ DiagnosisScorer（依赖FuzzyMatcher）
  └─ KnowledgeLoader（无依赖，可并行实现）

第3层（依赖第2层）：
  ├─ KnowledgeService（依赖KnowledgeLoader）
  └─ ImageService（依赖LocalImageStorage + ImageRepository）  ← ⚠️ ImageService在Layer 3

第4层（依赖第3层）：
  └─ DiagnosisService（依赖VLMClient + DiagnosisScorer + KnowledgeService + ImageService）
```

---

## 二、研发计划v1.0的结构

### P2阶段（核心基础设施开发）

- **P2.1**: PROOF Framework + Instructor ✅ (对应Layer 1)
- **P2.2**: VLMClient ✅ (对应Layer 2)
- **P2.3**: KnowledgeLoader ✅ (对应Layer 2)
- **P2.4**: FuzzyMatcher ✅ (对应Layer 1)
- **P2.5**: DiagnosisScorer ✅ (对应Layer 2)
- **❌ 缺失**: LocalImageStorage（应该在Layer 1，与PROOF Framework、FuzzyMatcher并列）

### P3阶段（诊断引擎核心逻辑）

- **P3.1**: Q0逐级过滤实现 ✅
- **P3.2**: Q1-Q6动态特征提取 ✅
- **P3.3**: 三层渐进诊断流程 ✅ (对应DiagnosisService - Layer 4)
- **P3.4**: VLM兜底策略 ✅
- **⚠️ 隐含问题**: P3实现DiagnosisService，但未明确实现KnowledgeService和ImageService（Layer 3服务）

### P4阶段（诊断API开发）

- **P4.1**: FastAPI基础框架 ✅
- **P4.2**: 诊断路由实现 ✅
- **P4.3**: 图片存储服务 ⚠️ **【架构错误】**
  - 当前P4.3同时实现ImageService + LocalImageStorage
  - 问题：LocalImageStorage应该在P2阶段实现（Layer 1），不应该延后到P4
- **P4.4**: 简单认证中间件 ✅

---

## 三、具体问题分析

### 问题1：LocalImageStorage缺失（P2阶段）

**当前研发计划**：P2阶段没有P2.6来实现LocalImageStorage

**详细设计要求**：
- LocalImageStorage是**Layer 1模块**（无依赖）
- 文件路径：`backend/infrastructure/storage/local_storage.py`
- 职责：本地文件系统图片存储、按准确率+花卉名+日期分类存储、文件路径生成

**影响**：
- P3实现DiagnosisService时，无法正确依赖ImageService（因为ImageService依赖LocalImageStorage）
- P4.3的实现顺序错误（将Layer 1模块延后到P4）

**建议修正**：
```
P2阶段新增：
P2.6 本地图片存储（LocalImageStorage）

任务清单：
1. 实现本地文件系统图片存储
2. 按准确率+花卉名+日期分类存储规则
   - 路径：storage/images/{accuracy_label}/{genus}/{year-month}/{day}/{diagnosis_id}.jpg
3. 文件路径生成规范化
4. 文件移动功能（准确性标注时）

产出物：
- backend/infrastructure/storage/local_storage.py

验收标准：
- LocalImageStorage类可成功实例化
- save()方法测试通过（生成正确路径）
- move()方法测试通过（移动文件到correct/incorrect文件夹）
- 单元测试覆盖率 ≥ 90%

上下文依赖：无（Layer 1模块）
```

---

### 问题2：KnowledgeService和ImageService未明确实现（P3阶段）

**当前研发计划**：
- P3主要实现DiagnosisService
- 未明确实现KnowledgeService和ImageService（Layer 3服务）

**详细设计要求**：
- **KnowledgeService**（`backend/services/knowledge_service.py`）：
  - 职责：知识库加载、重载、查询
  - 依赖：KnowledgeLoader
  - 关键接口：`initialize()`, `reload()`, `get_diseases_by_genus()`, `get_all_diseases()`

- **ImageService**（`backend/services/image_service.py`）：
  - 职责：图片保存、图片元数据管理、准确性标注
  - 依赖：LocalImageStorage + ImageRepository
  - 关键接口：`save_image()`, `update_accuracy_label()`, `query_images()`

**影响**：
- P3实现DiagnosisService时缺少KnowledgeService和ImageService依赖
- P4.3被迫同时实现ImageService + LocalImageStorage（违反分层原则）

**建议修正**：
```
在P3阶段新增子任务：

P3.5 知识库服务实现（KnowledgeService）

任务清单：
1. 实现KnowledgeService类（backend/services/knowledge_service.py）
2. 实现知识库初始化（initialize方法，调用KnowledgeLoader）
3. 实现知识库热更新（reload方法）
4. 实现候选疾病查询（get_diseases_by_genus方法，用于P3.3的候选疾病筛选）
5. 实现全部疾病查询（get_all_diseases方法）

产出物：
- backend/services/knowledge_service.py

验收标准：
- KnowledgeService可成功初始化（加载至少2种疾病）
- get_diseases_by_genus("Rosa")返回玫瑰属疾病列表
- reload()热更新测试通过
- 单元测试覆盖率 ≥ 90%

上下文依赖：P2.3（KnowledgeLoader）完成

---

P3.6 图片服务实现（ImageService）

任务清单：
1. 实现ImageService类（backend/services/image_service.py）
2. 实现图片保存（save_image方法，调用LocalImageStorage）
3. 实现准确性标注（update_accuracy_label方法，移动文件）
4. 实现图片查询（query_images方法，按花卉属、准确性、日期范围）
5. 实现图片元数据持久化（ImageRepository）

产出物：
- backend/services/image_service.py
- backend/infrastructure/persistence/repositories/image_repo.py

验收标准：
- ImageService可成功保存图片（文件存在于正确路径）
- 图片元数据保存到数据库（images表）
- update_accuracy_label()测试通过（文件移动成功）
- query_images()测试通过（按条件筛选）
- 单元测试覆盖率 ≥ 90%

上下文依赖：P2.6（LocalImageStorage）完成
```

---

### 问题3：P4.3的实现顺序错误

**当前P4.3描述**：
```
P4.3 图片存储服务

任务清单：
1. 实现图片本地存储（infrastructure/storage/local_storage.py）
2. 按准确率+花卉名+日期分类存储
3. 保存图片元数据到数据库（images 表）
4. 实现图片检索（按日期、花卉属、准确率标签）

产出物：
- backend/infrastructure/storage/local_storage.py  ← Layer 1模块，不应在P4实现
- backend/infrastructure/persistence/repositories/image_repo.py
- backend/services/image_service.py
```

**问题分析**：
- P4.3同时实现LocalImageStorage（Layer 1）和ImageService（Layer 3）
- 违反详细设计的4层依赖结构
- LocalImageStorage应该在P2.6实现（Layer 1，无依赖）
- ImageService应该在P3.6实现（Layer 3，依赖LocalImageStorage）

**建议修正**：
```
P4.3修改为：图片管理API

任务清单：
1. 实现图片查询API（GET /api/v1/images）
2. 实现准确性标注API（PATCH /api/v1/images/{image_id}/label）
3. 实现图片删除API（DELETE /api/v1/images/{image_id}）
4. 调用ImageService执行操作

产出物：
- backend/apps/api/routers/image.py
- backend/apps/api/schemas/image.py

验收标准：
- 图片查询API测试通过（按花卉属、准确性、日期范围筛选）
- 准确性标注API测试通过（移动文件到correct/incorrect文件夹）
- 图片删除API测试通过
- Postman测试通过

上下文依赖：P3.6（ImageService）完成
```

---

## 四、依赖关系梳理

### 当前研发计划的依赖链（存在问题）

```
P2: PROOF Framework, VLMClient, KnowledgeLoader, FuzzyMatcher, DiagnosisScorer
  ↓
P3: DiagnosisService（❌ 缺少KnowledgeService和ImageService依赖）
  ↓
P4.3: LocalImageStorage + ImageService（❌ LocalImageStorage应在P2，ImageService应在P3）
```

### 修正后的依赖链（符合详细设计）

```
P2: Layer 1 + Layer 2基础设施
  ├─ P2.1: PROOF Framework (Layer 1)
  ├─ P2.4: FuzzyMatcher (Layer 1)
  ├─ P2.6: LocalImageStorage (Layer 1)  ← 新增
  ├─ P2.2: VLMClient (Layer 2)
  ├─ P2.3: KnowledgeLoader (Layer 2)
  └─ P2.5: DiagnosisScorer (Layer 2)
    ↓
P3: Layer 3服务 + Layer 4服务
  ├─ P3.5: KnowledgeService (Layer 3)  ← 新增
  ├─ P3.6: ImageService (Layer 3)      ← 新增
  ├─ P3.1-P3.4: DiagnosisService (Layer 4)
    ↓
P4: API层
  ├─ P4.1: FastAPI基础框架
  ├─ P4.2: 诊断路由（调用DiagnosisService）
  ├─ P4.3: 图片管理API（调用ImageService）  ← 修改为纯API层
  └─ P4.4: 认证中间件
```

---

## 五、时间预估调整

### 新增任务时间预估

| 任务 | 预估时间 | 理由 |
|-----|---------|------|
| **P2.6 LocalImageStorage** | 0.5天（4小时） | 简单文件操作，无依赖 |
| **P3.5 KnowledgeService** | 0.5天（4小时） | 简单Service封装，主要是调用KnowledgeLoader |
| **P3.6 ImageService** | 0.5天（4小时） | 调用LocalImageStorage + Repository |

### P4.3调整后节省时间

- **原P4.3预估**：0.5天（包含LocalImageStorage + ImageService实现）
- **修正后P4.3**：0.25天（仅API路由，ImageService已在P3.6实现）
- **净增加时间**：0.5 + 0.5 + 0.5 - 0.25 = **1.25天**

---

## 六、修订建议

### 选项A：创建研发计划v1.1（推荐）

**优点**：
- 完整版本管理，保留v1.0作为历史记录
- 明确反映详细设计v1.1的架构调整
- 便于后续对比和回溯

**需要修改的内容**：
1. P2阶段新增P2.6（LocalImageStorage）
2. P3阶段新增P3.5（KnowledgeService）和P3.6（ImageService）
3. P4.3修改为纯API层（图片管理API）
4. 更新P2/P3/P4的时间预估
5. 更新总预估时间：14天 → 15.25天
6. 更新文档修订记录

### 选项B：创建增量修订文档

**优点**：
- 保持v1.0主体不变
- 通过"变更清单"方式补充
- 适合快速调整

**内容**：
- 创建 `研发计划v1.0_增量修订.md`
- 列出3个新增任务的完整规格
- 列出P4.3的修改内容

### 选项C：直接修改v1.0（不推荐）

**缺点**：
- 失去历史版本记录
- 无法对比架构变化

---

## 七、总结

### 关键问题

1. ❌ **LocalImageStorage缺失**：P2阶段缺少P2.6（Layer 1模块）
2. ❌ **KnowledgeService和ImageService未明确**：P3阶段未明确实现Layer 3服务
3. ❌ **P4.3实现顺序错误**：将Layer 1模块延后到P4，违反分层原则

### 影响范围

- 如果不修正，P3实现DiagnosisService时会缺少关键依赖
- P4.3的实现会违反架构分层原则
- 后续维护困难（模块依赖关系混乱）

### 推荐行动

**立即执行**（选项A）：
1. 创建 `研发计划v1.1.md`
2. 新增P2.6、P3.5、P3.6三个任务
3. 修正P4.3为纯API层
4. 更新时间预估：14天 → 15.25天
5. 更新文档修订记录

**后续验证**：
- 使用Mermaid图验证依赖关系（P2→P3→P4是否符合Layer 1→2→3→4）
- 确保每个阶段的Gate验收标准包含Layer验证

---

## 八、修订对照表

| 版本 | P2阶段 | P3阶段 | P4.3 | 总时间 |
|-----|-------|-------|------|--------|
| **v1.0（当前）** | 5个任务（无LocalImageStorage） | 4个任务（无KnowledgeService/ImageService） | LocalImageStorage + ImageService | 14天 |
| **v1.1（建议）** | 6个任务（新增P2.6 LocalImageStorage） | 6个任务（新增P3.5 KnowledgeService, P3.6 ImageService） | 纯API层（图片管理API） | 15.25天 |

**核心差异**：v1.1严格遵循详细设计v1.1的4层依赖结构，确保实现顺序正确。

---

**文档结束**
