# PhytoOracle MVP è¯¦ç»†è®¾è®¡æ–‡æ¡£ v2.0

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¶é—´**: 2025-11-14
**åŸºäºç‰ˆæœ¬**: v1.0
**ç¼–å†™è€…**: ç³»ç»Ÿæ¶æ„å¸ˆ
**çŠ¶æ€**: è¯„å®¡ä¸­

---

## ğŸ“‹ v2.0 ç‰ˆæœ¬è¯´æ˜

æœ¬æ–‡æ¡£åŸºäº `è¯¦ç»†è®¾è®¡æ–‡æ¡£.md` (v1.0) åˆ›å»ºï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç‹¬ç«‹æ–‡æ¡£ï¼Œä¸»è¦å˜æ›´å¦‚ä¸‹ï¼š

### ğŸ”„ æ ¸å¿ƒå˜æ›´
1. **åˆ é™¤å†…å®¹**: åˆ é™¤ç¬¬11ç« "å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡"ï¼ˆéœ€æ±‚ä¸­ä¸éœ€è¦ï¼‰
2. **APIè®¾è®¡æ‰©å±•** (ç¬¬6ç« ): æ‰©å±•è¯Šæ–­APIè¿”å›æ ¼å¼ï¼Œæ–°å¢çŸ¥è¯†åº“ç®¡ç†APIã€æœ¬ä½“ç®¡ç†API
3. **ç›®å½•ç»“æ„æ›´æ–°** (ç¬¬4ç« ): æ–°å¢å‰ç«¯ç›®å½•ç»“æ„ï¼ˆReact/Vueï¼‰
4. **å‰ç«¯æ¶æ„è®¾è®¡** (æ–°å¢ç¬¬15ç« ): React/Vueå‰ç«¯å®Œæ•´æ¶æ„è®¾è®¡
5. **å‰åç«¯è”è°ƒæŒ‡å—** (æ–°å¢ç¬¬16ç« ): APIå¯¹æ¥è°ƒè¯•å’ŒE2Eæµ‹è¯•æŒ‡å—

### ğŸ“ ç« èŠ‚ä¿®æ”¹æ ‡è®°
- âœ… **æ¥è‡ªv1.0**: å†…å®¹æ¥è‡ªv1.0ï¼Œä¿æŒä¸å˜æˆ–ç•¥æœ‰è°ƒæ•´
- ğŸ”„ **å·²ä¿®æ”¹**: å†…å®¹å·²æ›´æ–°æ‰©å±•
- âœ¨ **æ–°å¢**: v2.0æ–°å¢çš„å†…å®¹

---

## ç›®å½•ç´¢å¼•

- [1. æ¶æ„æ€»è§ˆ](#1-æ¶æ„æ€»è§ˆ) âœ…
  - [1.1 ç³»ç»Ÿæ¶æ„å›¾](#11-ç³»ç»Ÿæ¶æ„å›¾)
  - [1.2 éƒ¨ç½²æ¶æ„å›¾](#12-éƒ¨ç½²æ¶æ„å›¾)
  - [1.3 æ ¸å¿ƒç±»å›¾](#13-æ ¸å¿ƒç±»å›¾)
- [2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜](#2-é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜) âœ…
  - [2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)](#21-å•ä¸€èŒè´£åŸåˆ™-srp)
  - [2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)](#22-ä¾èµ–å€’ç½®åŸåˆ™-dip)
  - [2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)](#23-æ¥å£éš”ç¦»åŸåˆ™-isp)
  - [2.4 å±‚æ¬¡éš”ç¦»](#24-å±‚æ¬¡éš”ç¦»)
  - [2.5 å¾ªç¯ä¾èµ–æ£€æµ‹](#25-å¾ªç¯ä¾èµ–æ£€æµ‹)
- [3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰](#3-åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ddd-é£æ ¼) âœ…
  - [3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚](#31-é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚)
  - [3.2 èšåˆæ ¹è®¾è®¡](#32-èšåˆæ ¹è®¾è®¡)
  - [3.3 å€¼å¯¹è±¡è®¾è®¡](#33-å€¼å¯¹è±¡è®¾è®¡)
  - [3.4 é¢†åŸŸæœåŠ¡](#34-é¢†åŸŸæœåŠ¡)
- [4. å®Œæ•´ç›®å½•ç»“æ„](#4-å®Œæ•´ç›®å½•ç»“æ„) ğŸ”„
- [5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡](#5-æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡) âœ…
  - [5.1 æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ](#51-æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ)
  - [5.2 åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰](#52-åº”ç”¨æœåŠ¡application-services)
  - [5.3 åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰](#53-åŸºç¡€è®¾æ–½æ¨¡å—infrastructure-modules)
  - [5.4 æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº](#54-æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº)
  - [5.5 å…³é”®è®¾è®¡åŸåˆ™](#55-å…³é”®è®¾è®¡åŸåˆ™)
  - [5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰](#56-æç¤ºè¯å·¥ç¨‹æ¡†æ¶æ ¸å¿ƒåŸºç¡€è®¾æ–½)
- [6. API è®¾è®¡ï¼ˆOpenAPI è§„èŒƒç‰‡æ®µï¼‰](#6-api-è®¾è®¡openapi-è§„èŒƒç‰‡æ®µ) ğŸ”„
- [7. æ•°æ®æ¨¡å‹ï¼ˆPydantic V2 å®Œæ•´ä»£ç ï¼‰](#7-æ•°æ®æ¨¡å‹pydantic-v2-å®Œæ•´ä»£ç ) âœ…
- [8. çŸ¥è¯†æœ¬ä½“è®¾è®¡ï¼ˆJSON Schema + ç¤ºä¾‹ï¼‰](#8-çŸ¥è¯†æœ¬ä½“è®¾è®¡json-schema--ç¤ºä¾‹) âœ…
  - [8.1 Disease Ontology Schema](#81-disease-ontology-schema)
  - [8.2 Disease Ontology ç¤ºä¾‹](#82-disease-ontology-ç¤ºä¾‹)
  - [8.3 Feature Ontology Schema](#83-feature-ontology-schema)
  - [8.4 Host-Disease Ontology Schema](#84-host-disease-ontology-schema)
- [9. æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆPostgreSQL DDLï¼‰](#9-æ•°æ®åº“è¡¨è®¾è®¡postgresql-ddl) âœ…
  - [9.1 è¡¨ç»“æ„æ€»è§ˆ](#91-è¡¨ç»“æ„æ€»è§ˆ)
  - [9.2 å®Œæ•´DDLè¯­å¥](#92-å®Œæ•´ddlè¯­å¥)
  - [9.3 åˆå§‹åŒ–æ•°æ®è„šæœ¬](#93-åˆå§‹åŒ–æ•°æ®è„šæœ¬)
  - [9.4 æ•°æ®åº“è®¿é—®å±‚æ¥å£ï¼ˆRepositoryæ¨¡å¼ï¼‰](#94-æ•°æ®åº“è®¿é—®å±‚æ¥å£repositoryæ¨¡å¼)
  - [9.5 æ•°æ®åº“è¿æ¥æ± ç®¡ç†](#95-æ•°æ®åº“è¿æ¥æ± ç®¡ç†)
- [10. ç¼“å­˜ä¸ Rate Limit ç­–ç•¥](#10-ç¼“å­˜ä¸-rate-limit-ç­–ç•¥) âœ…
  - [10.1 ç¼“å­˜ç­–ç•¥ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰](#101-ç¼“å­˜ç­–ç•¥mvpç®€åŒ–ç‰ˆ)
  - [10.2 Rate Limitç­–ç•¥ï¼ˆMVPä¸å®ç°ï¼‰](#102-rate-limitç­–ç•¥mvpä¸å®ç°)
- [11. æµ‹è¯•ç­–ç•¥](#11-æµ‹è¯•ç­–ç•¥) âœ…
  - [11.1 å•å…ƒæµ‹è¯•ç­–ç•¥](#111-å•å…ƒæµ‹è¯•ç­–ç•¥)
  - [11.2 é›†æˆæµ‹è¯•ç­–ç•¥](#112-é›†æˆæµ‹è¯•ç­–ç•¥)
  - [11.3 E2Eæµ‹è¯•ç­–ç•¥](#113-e2eæµ‹è¯•ç­–ç•¥)
- [12. æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼](#12-æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼) âœ…
- [13. éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ](#13-éƒ¨ç½²ä¸-cicd-æ–¹æ¡ˆ) âœ…
  - [13.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²](#131-å¼€å‘ç¯å¢ƒéƒ¨ç½²)
  - [13.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#132-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
  - [13.3 CI/CDæ–¹æ¡ˆï¼ˆMVPæ‰‹å·¥éƒ¨ç½²ï¼‰](#133-cicdæ–¹æ¡ˆmvpæ‰‹å·¥éƒ¨ç½²)
- [14. æœªæ¥æ‰©å±•ç‚¹æ¸…å•](#14-æœªæ¥æ‰©å±•ç‚¹æ¸…å•) âœ…
  - [14.1 åŠŸèƒ½æ‰©å±•ï¼ˆv1.2ï¼‰](#141-åŠŸèƒ½æ‰©å±•v12)
  - [14.2 åŠŸèƒ½æ‰©å±•ï¼ˆv1.3+ï¼‰](#142-åŠŸèƒ½æ‰©å±•v13)
  - [14.3 æŠ€æœ¯å€ºåŠ¡æ¸…ç†](#143-æŠ€æœ¯å€ºåŠ¡æ¸…ç†)
  - [14.4 çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’](#144-çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’)
- [15. å‰ç«¯æ¶æ„è®¾è®¡](#15-å‰ç«¯æ¶æ„è®¾è®¡) âœ¨
- [16. å‰åç«¯è”è°ƒæŒ‡å—](#16-å‰åç«¯è”è°ƒæŒ‡å—) âœ¨
- [17. æ–‡æ¡£ä¿®è®¢è®°å½•](#17-æ–‡æ¡£ä¿®è®¢è®°å½•) âœ¨

---

## 1. æ¶æ„æ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    %% å‰ç«¯å±‚
    subgraph Frontend["å‰ç«¯å±‚ (Frontend Layer)"]
        Web["Webè¯Šæ–­ç•Œé¢<br/>(Next.js 15)"]
        Admin["ç®¡ç†åå°<br/>(Streamlit)"]
    end

    %% APIç½‘å…³å±‚
    subgraph Gateway["APIå±‚ (API Gateway)"]
        API["FastAPI Server"]
        Auth["è®¤è¯ä¸­é—´ä»¶<br/>(API Key)"]
    end

    %% ä¸šåŠ¡é€»è¾‘å±‚
    subgraph Business["ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)"]
        DiagService["è¯Šæ–­æœåŠ¡<br/>(Diagnosis Service)"]
        KnowledgeService["çŸ¥è¯†åº“æœåŠ¡<br/>(Knowledge Service)"]
        ImageService["å›¾ç‰‡æœåŠ¡<br/>(Image Service)"]
    end

    %% é¢†åŸŸæ¨¡å‹å±‚
    subgraph Domain["é¢†åŸŸæ¨¡å‹å±‚ (Domain Models)"]
        DM1["Disease Ontology"]
        DM2["Feature Ontology"]
        DM3["Plant Ontology"]
        DM4["Host-Disease Relations"]
    end

    %% åŸºç¡€è®¾æ–½å±‚
    subgraph Infra["åŸºç¡€è®¾æ–½å±‚ (Infrastructure)"]
        PromptFramework["æç¤ºè¯æ¡†æ¶<br/>(PROOF Framework)"]
        VLM["VLMå®¢æˆ·ç«¯<br/>(Instructor + Fallback)"]
        OntologyLoader["çŸ¥è¯†åº“åŠ è½½å™¨<br/>(JSON Loader)"]
        Matcher["æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        Scorer["åŠ æƒè¯„åˆ†å™¨"]
    end

    %% å¤–éƒ¨æœåŠ¡
    subgraph External["å¤–éƒ¨æœåŠ¡ (External Services)"]
        Qwen["Qwen VL Plus"]
        GPT["ChatGPT<br/>gpt-4o"]
        Grok["Grok Vision"]
        Claude["Claude Sonnet"]
    end

    %% æ•°æ®å­˜å‚¨
    subgraph Storage["æ•°æ®å­˜å‚¨ (Storage)"]
        PG[("PostgreSQL<br/>è¯Šæ–­è®°å½•")]
        Redis[("Redis<br/>ç¼“å­˜")]
        FS[("æ–‡ä»¶ç³»ç»Ÿ<br/>å›¾ç‰‡å­˜å‚¨")]
        Git[("Gitä»“åº“<br/>çŸ¥è¯†åº“JSON")]
    end

    %% è¿æ¥å…³ç³»
    Web --> API
    Admin --> API
    API --> Auth
    Auth --> DiagService
    Auth --> KnowledgeService
    Auth --> ImageService

    DiagService --> VLM
    DiagService --> Scorer
    DiagService --> Domain

    KnowledgeService --> OntologyLoader
    KnowledgeService --> Git

    ImageService --> FS

    VLM --> PromptFramework
    VLM --> Qwen
    VLM --> GPT
    VLM --> Grok
    VLM --> Claude

    Scorer --> Matcher
    OntologyLoader --> Git

    DiagService --> PG
    VLM --> Redis
    ImageService --> PG
```

### 1.2 éƒ¨ç½²æ¶æ„å›¾

```mermaid
graph LR
    subgraph Development["å¼€å‘ç¯å¢ƒ"]
        Dev1["åç«¯<br/>python main.py<br/>:8000"]
        Dev2["å‰ç«¯<br/>npm run dev<br/>:3000"]
        Dev3["ç®¡ç†åå°<br/>streamlit run<br/>:8501"]
        Dev4["PostgreSQL<br/>æœ¬åœ°å®‰è£…<br/>:5432"]
        Dev5["Redis<br/>æœ¬åœ°å®‰è£…<br/>:6379"]
    end

    subgraph Production["ç”Ÿäº§ç¯å¢ƒ(äº‘æœåŠ¡å™¨)"]
        Nginx["Nginx<br/>åå‘ä»£ç†<br/>:80/:443"]
        Uvicorn["Uvicorn<br/>å¤šè¿›ç¨‹<br/>:8000-8003"]
        Next["Next.js<br/>Production Build<br/>:3000"]
        StreamlitProd["Streamlit<br/>:8501"]
        PGProd["PostgreSQL<br/>:5432"]
        RedisProd["Redis<br/>:6379"]
    end

    subgraph Users["ç”¨æˆ·è®¿é—®"]
        U1["APIç”¨æˆ·"]
        U2["Webç”¨æˆ·"]
        U3["ç®¡ç†å‘˜"]
    end

    U1 -->|APIè¯·æ±‚| Nginx
    U2 -->|Webè®¿é—®| Nginx
    U3 -->|ç®¡ç†ç•Œé¢| Nginx

    Nginx -->|/api/*| Uvicorn
    Nginx -->|/*| Next
    Nginx -->|/admin/*| StreamlitProd

    Uvicorn --> PGProd
    Uvicorn --> RedisProd
```

### 1.3 æ ¸å¿ƒç±»å›¾

```mermaid
classDiagram
    %% æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
    class PROOFPrompt {
        +question_id: str
        +purpose: PromptPurpose
        +role: PromptRole
        +observation: PromptObservation
        +options: PromptOptions
        +format_spec: PromptFormat
        +version: str
        +render() str
        +to_dict() dict
    }

    class PromptPurpose {
        +task: str
        +context: str
        +why_important: str
    }

    class PromptRole {
        +role: str
        +expertise: List[str]
        +constraints: List[str]
    }

    class PromptObservation {
        +visual_method: str
        +visual_clues: Dict
        +focus_areas: List[str]
    }

    class PromptOptions {
        +choices: List[Choice]
        +allow_unknown: bool
        +allow_uncertain: bool
    }

    class PromptFormat {
        +response_schema: Type[BaseModel]
        +examples: List[Example]
        +constraints: List[str]
    }

    PROOFPrompt --> PromptPurpose
    PROOFPrompt --> PromptRole
    PROOFPrompt --> PromptObservation
    PROOFPrompt --> PromptOptions
    PROOFPrompt --> PromptFormat

    %% VLMæŠ½è±¡å±‚ + Instructoré›†æˆ
    class VLMProvider {
        <<interface>>
        +call(prompt: str, image: bytes) str
        +is_available() bool
        +get_quota() dict
    }

    class QwenProvider {
        +api_key: str
        +base_url: str
        +call(prompt: str, image: bytes) str
    }

    class ChatGPTProvider {
        +api_key: str
        +model: str
        +call(prompt: str, image: bytes) str
    }

    class VLMClient {
        -providers: List[VLMProvider]
        -cache: RedisCache
        +call_with_fallback(prompt: str, image: bytes, response_model: Type[BaseModel]) BaseModel
        +get_current_provider() str
    }

    class Instructor {
        <<library>>
        +from_openai() Client
        +from_anthropic() Client
        +auto_retry: bool
        +max_retries: int
    }

    VLMProvider <|-- QwenProvider
    VLMProvider <|-- ChatGPTProvider
    VLMClient --> VLMProvider
    VLMClient --> Instructor
    VLMClient --> PROOFPrompt

    %% è¯Šæ–­æœåŠ¡
    class DiagnosisService {
        -vlm_client: VLMClient
        -scorer: DiagnosisScorer
        -knowledge_base: KnowledgeBase
        +diagnose(image: bytes) DiagnosisResult
        -extract_features() FeatureVector
        -match_diseases() List[DiseaseMatch]
    }

    class DiagnosisScorer {
        -matcher: FuzzyMatcher
        +calculate_score(features: dict, disease: dict) float
        +apply_weights(scores: dict) float
    }

    class FuzzyMatcher {
        +COLOR_GROUPS: dict
        +SIZE_ORDER: list
        +match_color(observed: str, expected: str) bool
        +match_size(observed: str, expected: str) bool
    }

    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisScorer --> FuzzyMatcher

    %% é¢†åŸŸæ¨¡å‹
    class DiseaseOntology {
        +disease_id: str
        +disease_name: str
        +feature_vector: dict
        +feature_importance: dict
        +diagnosis_rules: dict
    }

    class FeatureVector {
        +content_type: str
        +plant_category: str
        +flower_genus: str
        +organ: str
        +completeness: str
        +has_abnormality: str
        +symptom_type: str
        +additional_features: dict
    }

    DiagnosisService --> DiseaseOntology
    DiagnosisService --> FeatureVector
```

---

## 2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜

### 2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)

æ¯ä¸ªæ¨¡å—ä¸¥æ ¼éµå¾ªå•ä¸€èŒè´£ï¼š

| æ¨¡å— | èŒè´£ | ä¸è´Ÿè´£ |
|-----|------|--------|
| **PromptFramework** | æç¤ºè¯ç»“æ„åŒ–ç¼–å†™ä¸ç‰ˆæœ¬æ§åˆ¶ | VLMè°ƒç”¨ã€å“åº”éªŒè¯ |
| **DiagnosisService** | åè°ƒè¯Šæ–­æµç¨‹ | VLMè°ƒç”¨ç»†èŠ‚ã€è¯„åˆ†ç®—æ³• |
| **VLMClient** | VLMè°ƒç”¨ä¸é™çº§ã€Instructoré›†æˆ | ä¸šåŠ¡é€»è¾‘ã€Promptç”Ÿæˆ |
| **FuzzyMatcher** | æ¨¡ç³ŠåŒ¹é…é€»è¾‘ | æƒé‡è®¡ç®—ã€è¯Šæ–­å†³ç­– |
| **DiagnosisScorer** | åŠ æƒè¯„åˆ†è®¡ç®— | ç‰¹å¾æå–ã€VLMäº¤äº’ |
| **KnowledgeLoader** | JSONåŠ è½½ä¸ç¼“å­˜ | ä¸šåŠ¡éªŒè¯ã€è¯Šæ–­é€»è¾‘ |
| **ImageService** | å›¾ç‰‡å­˜å‚¨ä¸æ£€ç´¢ | è¯Šæ–­é€»è¾‘ã€VLMè°ƒç”¨ |

### 2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

é€šè¿‡ProtocolæŠ½è±¡å®ç°ä¾èµ–å€’ç½®ï¼š

```python
from typing import Protocol

# æŠ½è±¡æ¥å£å®šä¹‰
class VLMProtocol(Protocol):
    async def call(self, prompt: str, image: bytes) -> str: ...
    def is_available(self) -> bool: ...

class CacheProtocol(Protocol):
    async def get(self, key: str) -> Optional[str]: ...
    async def set(self, key: str, value: str, ttl: int) -> None: ...

class RepositoryProtocol(Protocol):
    async def save(self, entity: Any) -> str: ...
    async def find_by_id(self, id: str) -> Optional[Any]: ...

# ä¸šåŠ¡å±‚ä¾èµ–æŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç°
class DiagnosisService:
    def __init__(
        self,
        vlm: VLMProtocol,  # ä¾èµ–æŠ½è±¡
        cache: CacheProtocol,  # ä¾èµ–æŠ½è±¡
        repo: RepositoryProtocol  # ä¾èµ–æŠ½è±¡
    ):
        self.vlm = vlm
        self.cache = cache
        self.repo = repo
```

### 2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)

ç»†ç²’åº¦æ¥å£è®¾è®¡ï¼Œé¿å…èƒ–æ¥å£ï¼š

```python
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šèƒ–æ¥å£
class KnowledgeService:
    def load_diseases(): ...
    def save_disease(): ...
    def delete_disease(): ...
    def load_plants(): ...
    def save_plant(): ...
    def validate_json(): ...
    def export_to_csv(): ...

# âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç»†ç²’åº¦æ¥å£
class DiseaseLoader(Protocol):
    def load_all() -> List[DiseaseOntology]: ...

class DiseaseEditor(Protocol):
    def save(disease: DiseaseOntology) -> None: ...
    def delete(disease_id: str) -> None: ...

class OntologyValidator(Protocol):
    def validate(json_data: dict) -> ValidationResult: ...
```

### 2.4 å±‚æ¬¡éš”ç¦»

ä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„ï¼Œç¦æ­¢è·¨å±‚è°ƒç”¨ï¼š

```
è¡¨ç°å±‚ (Routers)
    â†“ [ä»…é€šè¿‡Schemaä¼ é€’æ•°æ®]
åº”ç”¨å±‚ (Services)
    â†“ [ä»…é€šè¿‡Domain Modeläº¤äº’]
é¢†åŸŸå±‚ (Domain)
    â†“ [ä»…é€šè¿‡Protocolè°ƒç”¨]
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
```

### 2.5 å¾ªç¯ä¾èµ–æ£€æµ‹

ä½¿ç”¨mypyä¸¥æ ¼æ¨¡å¼æ£€æµ‹å¾ªç¯ä¾èµ–ï¼š

```bash
# pyproject.tomlé…ç½®
[tool.mypy]
strict = true
disallow_any_unimported = true
no_implicit_reexport = true
warn_return_any = true

# è¿è¡Œæ£€æµ‹
mypy --strict backend/
```

---

## 3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰

### 3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¡¨ç°å±‚ (Presentation)            â”‚
â”‚   FastAPI Routers / Streamlit UI        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         åº”ç”¨å±‚ (Application)            â”‚
â”‚   DiagnosisService / KnowledgeService   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é¢†åŸŸå±‚ (Domain)                â”‚
â”‚   å®ä½“ / å€¼å¯¹è±¡ / é¢†åŸŸæœåŠ¡ / èšåˆæ ¹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure)        â”‚
â”‚   VLM / Database / Cache / Storage      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 èšåˆæ ¹è®¾è®¡

**è¯Šæ–­èšåˆ (Diagnosis Aggregate)**ï¼š
```python
class DiagnosisAggregate:
    """è¯Šæ–­èšåˆæ ¹"""
    def __init__(self, diagnosis_id: str):
        self.diagnosis_id = diagnosis_id
        self.feature_vector: FeatureVector = None
        self.disease_matches: List[DiseaseMatch] = []
        self.final_diagnosis: DiagnosisResult = None
        self.images: List[ImageEntity] = []

    def add_image(self, image: ImageEntity) -> None:
        """æ·»åŠ è¯Šæ–­å›¾ç‰‡"""
        self.images.append(image)

    def extract_features(self, vlm_responses: dict) -> None:
        """æå–ç‰¹å¾å‘é‡"""
        self.feature_vector = FeatureVector.from_vlm_responses(vlm_responses)

    def match_diseases(self, candidates: List[DiseaseOntology]) -> None:
        """åŒ¹é…å€™é€‰ç–¾ç—…"""
        for disease in candidates:
            score = self._calculate_match_score(disease)
            self.disease_matches.append(DiseaseMatch(disease, score))

    def finalize_diagnosis(self) -> DiagnosisResult:
        """æœ€ç»ˆè¯Šæ–­å†³ç­–"""
        best_match = max(self.disease_matches, key=lambda x: x.score)
        confidence_level = self._determine_confidence_level(best_match.score)
        self.final_diagnosis = DiagnosisResult(
            disease=best_match.disease,
            confidence=best_match.score,
            level=confidence_level
        )
        return self.final_diagnosis
```

**çŸ¥è¯†åº“èšåˆ (KnowledgeBase Aggregate)**ï¼š
```python
class KnowledgeBaseAggregate:
    """çŸ¥è¯†åº“èšåˆæ ¹"""
    def __init__(self):
        self.diseases: Dict[str, DiseaseOntology] = {}
        self.plants: Dict[str, PlantOntology] = {}
        self.features: FeatureOntology = None
        self.host_disease_map: HostDiseaseMap = None
        self.version: str = None

    def load_from_json(self, base_path: str) -> None:
        """ä»JSONåŠ è½½çŸ¥è¯†åº“"""
        pass

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """æ ¹æ®èŠ±å‰å±è·å–å€™é€‰ç–¾ç—…"""
        disease_ids = self.host_disease_map.get_diseases_for_host(genus)
        return [self.diseases[id] for id in disease_ids if id in self.diseases]

    def reload(self) -> None:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“"""
        pass
```

### 3.3 å€¼å¯¹è±¡è®¾è®¡

```python
# å€¼å¯¹è±¡ï¼šä¸å¯å˜ï¼Œé€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰æ€§
@dataclass(frozen=True)
class FeatureVector:
    """ç‰¹å¾å‘é‡å€¼å¯¹è±¡"""
    content_type: str
    plant_category: str
    flower_genus: str
    organ: str
    completeness: str
    has_abnormality: str
    symptom_type: str
    color_center: Optional[str] = None
    location: Optional[str] = None
    size: Optional[str] = None
    distribution: Optional[str] = None

    def to_dict(self) -> dict:
        return asdict(self)

@dataclass(frozen=True)
class DiagnosisScore:
    """è¯Šæ–­åˆ†æ•°å€¼å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å«åŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰"""
    total_score: float
    major_features_score: float
    minor_features_score: float
    optional_features_score: float
    major_matched: int  # æ–°å¢ï¼šä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
    major_total: int    # æ–°å¢ï¼šä¸»è¦ç‰¹å¾æ€»æ•°

    @property
    def confidence_level(self) -> str:
        """
        è¯Šæ–­ç­‰çº§åˆ¤å®šï¼ˆä¸¥æ ¼éµå¾ªåŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰

        è§„åˆ™ï¼ˆéœ€æ±‚æ–‡æ¡£v1.3å®šä¹‰ï¼‰ï¼š
        - confirmed: total_score â‰¥ 0.85 ä¸” major_matched â‰¥ 2/2
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶å¿…é¡»å…¨éƒ¨åŒ¹é…æ‰èƒ½ç¡®è¯Š
        - suspected: 0.60 â‰¤ total_score < 0.85 ä¸” major_matched â‰¥ 1/2
          åŒ»å­¦åŸç†ï¼šè‡³å°‘ä¸€ä¸ªä¸»è¦ç—‡çŠ¶åŒ¹é… + æ¬¡è¦ç—‡çŠ¶æ”¯æŒ
        - unlikely: total_score < 0.60 æˆ– major_matched = 0
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶ä¸åŒ¹é…åˆ™æ’é™¤è¯Šæ–­
        """
        if self.total_score >= 0.85 and self.major_matched >= 2:
            return "confirmed"
        elif self.total_score >= 0.60 and self.major_matched >= 1:
            return "suspected"
        else:
            return "unlikely"

    @property
    def is_diagnosable(self) -> bool:
        """
        æ˜¯å¦å¯è¯Šæ–­ï¼ˆæ’é™¤"å¥åº·"æˆ–"çŸ¥è¯†åº“å¤–ç–¾ç—…"ï¼‰

        è§„åˆ™ï¼š
        - total_score < 0.30: è®¤ä¸ºæ— ç—…æˆ–çŸ¥è¯†åº“å¤–ç–¾ç—…
        - ç”¨äºè§¦å‘VLMå…œåº•ç­–ç•¥æˆ–è¿”å›"æ— æ³•è¯Šæ–­"
        """
        return self.total_score >= 0.30
```

### 3.4 é¢†åŸŸæœåŠ¡

```python
class DomainDiagnosisService:
    """é¢†åŸŸå±‚è¯Šæ–­æœåŠ¡"""

    @staticmethod
    def calculate_weighted_score(
        feature_vector: FeatureVector,
        disease: DiseaseOntology
    ) -> DiagnosisScore:
        """è®¡ç®—åŠ æƒè¯Šæ–­åˆ†æ•°ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰"""
        major_score = 0.0
        minor_score = 0.0
        optional_score = 0.0
        major_matched = 0  # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°
        major_total = 2    # ä¸»è¦ç‰¹å¾æ€»æ•°ï¼ˆsymptom_type + color_centerï¼‰

        # Major Features (æƒé‡0.8)
        if feature_vector.symptom_type == disease.expected_symptom_type:
            major_score += 0.5
            major_matched += 1
        if feature_vector.color_center in disease.expected_colors:
            major_score += 0.3
            major_matched += 1

        # Minor Features (æƒé‡0.15)
        if feature_vector.location == disease.expected_location:
            minor_score += 0.1
        # ... å…¶ä»–æ¬¡è¦ç‰¹å¾

        # Optional Features (æƒé‡0.05)
        # ... å¯é€‰ç‰¹å¾è®¡ç®—

        total = major_score * 0.8 + minor_score * 0.15 + optional_score * 0.05

        return DiagnosisScore(
            total_score=total,
            major_features_score=major_score,
            minor_features_score=minor_score,
            optional_features_score=optional_score,
            major_matched=major_matched,  # æ–°å¢
            major_total=major_total        # æ–°å¢
        )
```

---

## 4. å®Œæ•´ç›®å½•ç»“æ„ ğŸ”„

### 4.1 åç«¯ç›®å½•ç»“æ„ âœ…

```
PhytoOracle/
â”œâ”€â”€ backend/                                 # åç«¯æœåŠ¡ï¼ˆFastAPIï¼‰
â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”œâ”€â”€ api/                            # FastAPI ä¸»åº”ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£ï¼Œé…ç½®CORSã€ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ deps.py                     # ä¾èµ–æ³¨å…¥ï¼šDBè¿æ¥æ± ã€Redisã€VLM Client
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/                    # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # POST /diagnose - è¯Šæ–­æ¥å£
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # GET /diseases, /plants - çŸ¥è¯†åº“æŸ¥è¯¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.py                # POST /reload - çŸ¥è¯†åº“é‡è½½
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # POST /login, /api-keys - è®¤è¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/                    # Pydanticè¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # DiagnosisRequest/Response
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # DiseaseSchema, PlantSchema
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # LoginRequest, ApiKeyResponse
â”‚   â”‚   â”‚   â””â”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â””â”€â”€ auth.py                 # API KeyéªŒè¯ä¸­é—´ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ admin/                          # ç®¡ç†åå°ï¼ˆStreamlitï¼‰
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ app.py                      # Streamlitä¸»å…¥å£
â”‚   â”‚       â”œâ”€â”€ pages/                      # å¤šé¡µé¢åº”ç”¨
â”‚   â”‚       â”‚   â”œâ”€â”€ 1_ğŸŒ¸_ç–¾ç—…ç®¡ç†.py        # ç–¾ç—…CRUDç•Œé¢
â”‚   â”‚       â”‚   â”œâ”€â”€ 2_ğŸ”¬_è¯Šæ–­æµ‹è¯•.py        # ä¸Šä¼ å›¾ç‰‡æµ‹è¯•è¯Šæ–­
â”‚   â”‚       â”‚   â”œâ”€â”€ 3_ğŸ“Š_ç»Ÿè®¡åˆ†æ.py        # å‡†ç¡®ç‡ç»Ÿè®¡
â”‚   â”‚       â”‚   â””â”€â”€ 4_ğŸ”„_çŸ¥è¯†åº“ç‰ˆæœ¬.py      # ç‰ˆæœ¬ç®¡ç†ä¸å›æ»š
â”‚   â”‚       â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”‚           â””â”€â”€ auth.py                 # Streamlitè®¤è¯
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                               # æ ¸å¿ƒé…ç½®ä¸å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                       # Settingsç±»ï¼Œä».envåŠ è½½é…ç½®
â”‚   â”‚   â”œâ”€â”€ security.py                     # API Keyç”Ÿæˆ(secrets)ã€å¯†ç å“ˆå¸Œ(bcrypt)
â”‚   â”‚   â”œâ”€â”€ exceptions.py                   # è‡ªå®šä¹‰å¼‚å¸¸ï¼šDiagnosisError, VLMError
â”‚   â”‚   â””â”€â”€ cache.py                        # Redisç¼“å­˜å°è£…ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                             # DDDé¢†åŸŸæ¨¡å‹ï¼ˆPydantic V2ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis.py                    # DiagnosisAggregate, DiagnosisResult
â”‚   â”‚   â”œâ”€â”€ disease.py                      # DiseaseOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ feature.py                      # FeatureOntology, FeatureVector
â”‚   â”‚   â”œâ”€â”€ plant.py                        # PlantOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ treatment.py                    # TreatmentOntologyï¼ˆv1.3é¢„ç•™ï¼‰
â”‚   â”‚   â””â”€â”€ value_objects.py                # å€¼å¯¹è±¡ï¼šScore, Confidence
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/                     # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py                     # VLMProtocolæŠ½è±¡æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ client.py                   # VLMClientå®ç°Fallbackæœºåˆ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/                  # å…·ä½“Providerå®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ qwen.py                 # QwenVLPlusProvider
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chatgpt.py              # ChatGPTProvider (gpt-4o)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ grok.py                 # GrokVisionProvider
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ claude.py               # ClaudeProvider
â”‚   â”‚   â”‚   â”œâ”€â”€ prompts/                    # VLMæç¤ºè¯æ¨¡æ¿ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q0_screening.py         # Q0.0-Q0.5 è¿‡æ»¤é—®é¢˜æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 ç‰¹å¾æå–æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ fallback.py             # VLMå¼€æ”¾å¼è¯Šæ–­æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CHANGELOG.md            # æç¤ºè¯ç‰ˆæœ¬å˜æ›´è®°å½•
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ versions/               # å†å²ç‰ˆæœ¬å½’æ¡£ï¼ˆA/Bæµ‹è¯•ï¼‰
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ v1.0/
â”‚   â”‚   â”‚   â””â”€â”€ validators.py               # VLMå“åº”éªŒè¯å™¨ï¼ˆJSON Schemaï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ontology/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.py                   # JSONKnowledgeLoader - åŠ è½½JSONçŸ¥è¯†åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ matcher.py                  # FuzzyMatcher - æ¨¡ç³ŠåŒ¹é…COLOR_GROUPS/SIZE_ORDER
â”‚   â”‚   â”‚   â””â”€â”€ scorer.py                   # DiagnosisScorer - åŠ æƒè¯„åˆ†0.8/0.15/0.05
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py                 # create_pool() - asyncpgè¿æ¥æ± 
â”‚   â”‚   â”‚   â”œâ”€â”€ redis_client.py             # RedisCacheç±»å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ repositories/               # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ diagnosis_repo.py       # è¯Šæ–­è®°å½•CRUD (asyncpg)
â”‚   â”‚   â”‚       â”œâ”€â”€ image_repo.py           # å›¾ç‰‡å…ƒæ•°æ®CRUD
â”‚   â”‚   â”‚       â””â”€â”€ apikey_repo.py          # API Keyç®¡ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ storage/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ local_storage.py            # LocalImageStorage - æŒ‰åˆ†ç±»å­˜å‚¨å›¾ç‰‡
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                           # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåº”ç”¨æœåŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis_service.py            # æ ¸å¿ƒè¯Šæ–­æµç¨‹ç¼–æ’
â”‚   â”‚   â”œâ”€â”€ knowledge_service.py            # çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ image_service.py                # å›¾ç‰‡ä¿å­˜ã€åˆ†ç±»ã€å…ƒæ•°æ®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ tests/                              # æµ‹è¯•ç›®å½•
â”‚   â”‚   â”œâ”€â”€ conftest.py                     # Pytest fixtures
â”‚   â”‚   â”œâ”€â”€ unit/                           # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_matcher.py             # æµ‹è¯•COLOR_GROUPSæ¨¡ç³ŠåŒ¹é…
â”‚   â”‚   â”‚   â”œâ”€â”€ test_scorer.py              # æµ‹è¯•åŠ æƒè¯„åˆ†ç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ test_vlm_client.py          # æµ‹è¯•VLM Fallbackæœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ integration/                    # é›†æˆæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_diagnosis_api.py       # æµ‹è¯•å®Œæ•´è¯Šæ–­APIæµç¨‹
â”‚   â”‚   â”‚   â””â”€â”€ test_knowledge_reload.py    # æµ‹è¯•çŸ¥è¯†åº“çƒ­æ›´æ–°
â”‚   â”‚   â””â”€â”€ e2e/                            # ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆPlaywrightï¼‰
â”‚   â”‚       â””â”€â”€ test_diagnosis_flow.py      # æµ‹è¯•Webç•Œé¢å®Œæ•´æµç¨‹
â”‚   â”‚
â”‚   â”œâ”€â”€ knowledge_base/                     # çŸ¥è¯†åº“JSONæ–‡ä»¶ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ diseases/                       # ç–¾ç—…æœ¬ä½“JSON
â”‚   â”‚   â”‚   â”œâ”€â”€ rose_black_spot.json        # ç«ç‘°é»‘æ–‘ç—…
â”‚   â”‚   â”‚   â”œâ”€â”€ cherry_powdery_mildew.json  # æ¨±èŠ±ç™½ç²‰ç—…
â”‚   â”‚   â”‚   â””â”€â”€ ...                         # å…¶ä»–18-24ç§ç–¾ç—…
â”‚   â”‚   â”œâ”€â”€ features/                       # ç‰¹å¾æœ¬ä½“
â”‚   â”‚   â”‚   â””â”€â”€ feature_ontology.json       # ç‰¹å¾å®šä¹‰ä¸æ¨¡ç³ŠåŒ¹é…è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ plants/                         # æ¤ç‰©æœ¬ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ rosa.json                   # ç«ç‘°å±
â”‚   â”‚   â”‚   â”œâ”€â”€ prunus.json                 # æ¨±èŠ±å±
â”‚   â”‚   â”‚   â”œâ”€â”€ tulipa.json                 # éƒé‡‘é¦™å±
â”‚   â”‚   â”‚   â”œâ”€â”€ dianthus.json               # åº·ä¹ƒé¦¨å±
â”‚   â”‚   â”‚   â””â”€â”€ paeonia.json                # ç‰¡ä¸¹å±
â”‚   â”‚   â”œâ”€â”€ host_disease/                   # å®¿ä¸»-ç–¾ç—…å…³ç³»
â”‚   â”‚   â”‚   â””â”€â”€ associations.json           # èŠ±å‰ä¸ç–¾ç—…æ˜ å°„å…³ç³»
â”‚   â”‚   â””â”€â”€ treatments/                     # æ²»ç–—æ–¹æ¡ˆï¼ˆv1.3+é¢„ç•™ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                            # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ unlabeled/                  # æœªæ ‡æ³¨å›¾ç‰‡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rose/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ 2025-01/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cherry/
â”‚   â”‚   â”‚   â”œâ”€â”€ correct/                    # è¯Šæ–­æ­£ç¡®
â”‚   â”‚   â”‚   â””â”€â”€ incorrect/                  # è¯Šæ–­é”™è¯¯
â”‚   â”‚   â””â”€â”€ metadata/                       # å›¾ç‰‡å…ƒæ•°æ®JSONç¼“å­˜
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/                            # è¿ç»´è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ init_db.sql                     # åˆ›å»ºè¡¨ç»“æ„SQLè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ seed_apikeys.py                 # ç”Ÿæˆæµ‹è¯•ç”¨API Key
â”‚   â”‚   â””â”€â”€ validate_ontology.py            # JSON Schemaæ ¡éªŒè„šæœ¬
â”‚   â”‚
â”‚   â”œâ”€â”€ pyproject.toml                      # Poetryä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ .env.example                        # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â”œâ”€â”€ .gitignore
â”‚   â””â”€â”€ README.md                           # åç«¯éƒ¨ç½²è¯´æ˜
```

### 4.2 å‰ç«¯ç›®å½•ç»“æ„ âœ¨

**ğŸ†• v2.0æ–°å¢**: React/Vueå‰ç«¯é¡¹ç›®ç›®å½•ç»“æ„

```
frontend/
â”œâ”€â”€ public/                     # é™æ€èµ„æº
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ images/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    # APIå®¢æˆ·ç«¯å±‚
â”‚   â”‚   â”œâ”€â”€ client.ts           # Axiosé…ç½®ï¼Œç»Ÿä¸€è¯·æ±‚/å“åº”æ‹¦æˆª
â”‚   â”‚   â”‚   # - é…ç½®baseURL: process.env.VITE_API_BASE_URL
â”‚   â”‚   â”‚   # - é…ç½®è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆæ·»åŠ tokenï¼‰
â”‚   â”‚   â”‚   # - é…ç½®å“åº”æ‹¦æˆªå™¨ï¼ˆç»Ÿä¸€é”™è¯¯å¤„ç†ï¼‰
â”‚   â”‚   â”‚   # - é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆ10ç§’ï¼‰
â”‚   â”‚   â”œâ”€â”€ diagnosis.ts        # è¯Šæ–­APIå°è£…
â”‚   â”‚   â”‚   # - diagnoseSingle(image: File): Promise<DiagnosisResult>
â”‚   â”‚   â”‚   # - diagnoseBatch(images: File[]): Promise<BatchDiagnosisResult>
â”‚   â”‚   â”‚   # - getDiagnosisResult(id: string): Promise<DiagnosisResult>
â”‚   â”‚   â”œâ”€â”€ knowledge.ts        # çŸ¥è¯†åº“APIå°è£…
â”‚   â”‚   â”‚   # - getKnowledgeTree(): Promise<KnowledgeTree>
â”‚   â”‚   â”‚   # - getDiseaseDetail(diseaseId: string): Promise<DiseaseDetail>
â”‚   â”‚   â”‚   # - updateDisease(diseaseId: string, data: DiseaseUpdate): Promise<void>
â”‚   â”‚   â”‚   # - createDisease(data: DiseaseCreate): Promise<string>
â”‚   â”‚   â”‚   # - deleteDisease(diseaseId: string): Promise<void>
â”‚   â”‚   â””â”€â”€ ontology.ts         # æœ¬ä½“APIå°è£…
â”‚   â”‚       # - getOntologyList(): Promise<OntologyType[]>
â”‚   â”‚       # - getOntologySchema(type: string): Promise<OntologySchema>
â”‚   â”‚
â”‚   â”œâ”€â”€ assets/                 # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ icons/
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â”œâ”€â”€ global.css      # å…¨å±€æ ·å¼
â”‚   â”‚       â””â”€â”€ variables.css   # CSSå˜é‡
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # ç»„ä»¶å±‚
â”‚   â”‚   â”œâ”€â”€ common/             # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Header/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # å¯¼èˆªæ ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ Loading/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # åŠ è½½ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ Toast/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æç¤ºç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useToast.ts # Toast Hook
â”‚   â”‚   â”‚   â””â”€â”€ Modal/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # å¯¹è¯æ¡†ç»„ä»¶
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ diagnosis/          # è¯Šæ–­ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ UploadArea/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ä¸Šä¼ åŒºåŸŸï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ImagePreview/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # å›¾ç‰‡é¢„è§ˆ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ DiagnosisResult/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # è¯Šæ–­ç»“æœå¡ç‰‡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ QADetails/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # VLMé—®ç­”å¯¹è¯¦æƒ…ï¼ˆå¯å±•å¼€ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ FeatureMatchDetails/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # ç‰¹å¾åŒ¹é…è¯¦æƒ…
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ batch/              # æ‰¹é‡è¯Šæ–­ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ BatchUpload/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æ‰¹é‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ResultList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ç»“æœåˆ—è¡¨ï¼ˆç¿»é¡µæ§åˆ¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ResultCard/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ç»“æœå¡ç‰‡ï¼ˆåŒå‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ DetailModal/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # è¯¦æƒ…æ¨¡æ€æ¡†
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ontology/           # æœ¬ä½“ç®¡ç†ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ OntologyList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æœ¬ä½“ç±»å‹åˆ—è¡¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ OntologyDetail/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æœ¬ä½“è¯¦æƒ…å±•ç¤º
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ DimensionCard/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # ç»´åº¦å¡ç‰‡ï¼ˆå«æšä¸¾å€¼ï¼‰
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ knowledge/          # çŸ¥è¯†ç®¡ç†ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ KnowledgeTree/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # çŸ¥è¯†åº“ç›®å½•æ ‘ï¼ˆæŒ‰å®¿ä¸»å±åˆ†ç»„ï¼‰
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â”œâ”€â”€ DiseaseDetail/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # ç–¾ç—…è¯¦æƒ…å±•ç¤º
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â”œâ”€â”€ DimensionCard/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # ç»´åº¦å¡ç‰‡ï¼ˆå¸¦æœ¬ä½“æ ‡è¯†ï¼‰
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â””â”€â”€ VLMDescriptionEditor/
â”‚   â”‚           â”œâ”€â”€ index.tsx   # VLMæè¿°ç¼–è¾‘å™¨
â”‚   â”‚           â””â”€â”€ style.css
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/                  # é¡µé¢å±‚
â”‚   â”‚   â”œâ”€â”€ SingleDiagnosis/    # ç•Œé¢1ï¼šå•å›¾è¯Šæ–­
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx       # é¡µé¢ä¸»ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts        # è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”œâ”€â”€ BatchDiagnosis/     # ç•Œé¢2ï¼šæ‰¹é‡è¯Šæ–­
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”œâ”€â”€ OntologyManagement/ # ç•Œé¢3ï¼šæœ¬ä½“ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â””â”€â”€ KnowledgeManagement/# ç•Œé¢4ï¼šçŸ¥è¯†ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ index.tsx
â”‚   â”‚       â”œâ”€â”€ hooks.ts
â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚
â”‚   â”œâ”€â”€ store/                  # çŠ¶æ€ç®¡ç†å±‚ï¼ˆZustand/Piniaï¼‰
â”‚   â”‚   â”œâ”€â”€ diagnosisStore.ts   # è¯Šæ–­çŠ¶æ€
â”‚   â”‚   â”‚   # State: currentDiagnosis, batchDiagnoses, loading
â”‚   â”‚   â”‚   # Actions: setCurrentDiagnosis, addBatchDiagnosis, clearDiagnoses
â”‚   â”‚   â”œâ”€â”€ knowledgeStore.ts   # çŸ¥è¯†åº“çŠ¶æ€
â”‚   â”‚   â”‚   # State: knowledgeTree, currentDisease, editMode
â”‚   â”‚   â”‚   # Actions: setKnowledgeTree, updateDisease, toggleEditMode
â”‚   â”‚   â”œâ”€â”€ ontologyStore.ts    # æœ¬ä½“çŠ¶æ€
â”‚   â”‚   â”‚   # State: ontologyList, currentOntology
â”‚   â”‚   â”‚   # Actions: setOntologyList, selectOntology
â”‚   â”‚   â””â”€â”€ globalStore.ts      # å…¨å±€çŠ¶æ€
â”‚   â”‚       # State: user, loading, toast
â”‚   â”‚       # Actions: showToast, hideToast, setLoading
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                  # TypeScriptç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ diagnosis.ts        # è¯Šæ–­ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # DiagnosisResult, VLMQAResponse, FeatureMatch
â”‚   â”‚   â”œâ”€â”€ knowledge.ts        # çŸ¥è¯†åº“ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # KnowledgeTree, DiseaseDetail, DimensionInfo
â”‚   â”‚   â”œâ”€â”€ ontology.ts         # æœ¬ä½“ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # OntologyType, OntologySchema, DimensionDefinition
â”‚   â”‚   â””â”€â”€ api.ts              # APIå“åº”ç±»å‹
â”‚   â”‚       # ApiResponse, ApiError, PaginatedResponse
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ formatters.ts       # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â”‚   # formatDate, formatPercentage, formatFileSize
â”‚   â”‚   â”œâ”€â”€ validators.ts       # éªŒè¯å·¥å…·
â”‚   â”‚   â”‚   # validateImageFile, validateDiseaseData
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts     # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   # handleApiError, showErrorToast
â”‚   â”‚   â””â”€â”€ constants.ts        # å¸¸é‡å®šä¹‰
â”‚   â”‚       # MAX_FILE_SIZE, ALLOWED_FILE_TYPES
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                  # å…¨å±€è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”œâ”€â”€ useApi.ts           # APIè°ƒç”¨Hook
â”‚   â”‚   â”œâ”€â”€ useUpload.ts        # æ–‡ä»¶ä¸Šä¼ Hook
â”‚   â”‚   â””â”€â”€ useModal.ts         # Modalæ§åˆ¶Hook
â”‚   â”‚
â”‚   â”œâ”€â”€ App.tsx                 # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ main.tsx                # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ routes.tsx              # è·¯ç”±é…ç½®
â”‚       # Route: /diagnosis/single â†’ SingleDiagnosis
â”‚       # Route: /diagnosis/batch â†’ BatchDiagnosis
â”‚       # Route: /ontology â†’ OntologyManagement
â”‚       # Route: /knowledge â†’ KnowledgeManagement
â”‚
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   # VITE_API_BASE_URL=http://localhost:8000/api/v1
â”‚   # VITE_MAX_FILE_SIZE=10485760
â”‚
â”œâ”€â”€ .eslintrc.js                # ESLinté…ç½®
â”œâ”€â”€ .prettierrc                 # Prettieré…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts              # Viteé…ç½®ï¼ˆå«ä»£ç†ï¼‰
â””â”€â”€ README.md
```

**ç›®å½•ç»“æ„è®¾è®¡è¯´æ˜**ï¼š
1. **åˆ†å±‚æ¸…æ™°**: apiå±‚ã€componentå±‚ã€pageå±‚ã€storeå±‚èŒè´£æ˜ç¡®
2. **ç»„ä»¶åŒ–**: æ¯ä¸ªç»„ä»¶ç‹¬ç«‹ç›®å½•ï¼ŒåŒ…å«tsx + style.css
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
4. **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨Zustandæˆ–Piniaè¿›è¡ŒçŠ¶æ€ç®¡ç†
5. **å·¥å…·å‡½æ•°**: ç»Ÿä¸€çš„å·¥å…·å‡½æ•°å’Œå¸¸é‡å®šä¹‰

---

## 5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡ âœ…

> **âœ… æ¥è‡ªv1.0**: æœ¬ç« å†…å®¹æ¥è‡ªè¯¦ç»†è®¾è®¡æ–‡æ¡£v1.0ï¼Œä¿æŒä¸å˜ã€‚

> **è®¾è®¡è¯´æ˜**ï¼šæœ¬ç« æ˜ç¡®åŒºåˆ†**åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰**å’Œ**åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰**ï¼Œå¹¶é˜æ˜å½¼æ­¤çš„è°ƒç”¨å…³ç³»ã€‚ç²’åº¦å¯ç²—ä½†ä¸èƒ½ç¼ºã€‚

---

### 5.1 æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ

#### 5.1.1 åˆ†å±‚æ¶æ„å›¾

```mermaid
graph TB
    subgraph API["APIå±‚ (FastAPI)"]
        DiagnosisRouter["DiagnosisRouter<br/>è¯Šæ–­è·¯ç”±"]
        KnowledgeRouter["KnowledgeRouter<br/>çŸ¥è¯†åº“è·¯ç”±"]
    end

    subgraph Services["åº”ç”¨æœåŠ¡å±‚ (Application Services)"]
        DiagnosisService["DiagnosisService<br/>è¯Šæ–­æœåŠ¡"]
        KnowledgeService["KnowledgeService<br/>çŸ¥è¯†åº“æœåŠ¡"]
        ImageService["ImageService<br/>å›¾ç‰‡æœåŠ¡"]
    end

    subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ (Infrastructure Modules)"]
        VLMClient["VLMClient<br/>VLMå®¢æˆ·ç«¯"]
        KnowledgeLoader["KnowledgeLoader<br/>çŸ¥è¯†åº“åŠ è½½å™¨"]
        DiagnosisScorer["DiagnosisScorer<br/>åŠ æƒè¯Šæ–­è¯„åˆ†å™¨"]
        FuzzyMatcher["FuzzyMatcher<br/>æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        PROOFFramework["PROOF Framework<br/>æç¤ºè¯æ¡†æ¶"]
        LocalImageStorage["LocalImageStorage<br/>æœ¬åœ°å›¾ç‰‡å­˜å‚¨"]
    end

    subgraph Persistence["æŒä¹…åŒ–å±‚"]
        PostgreSQL["PostgreSQL<br/>æ•°æ®åº“"]
        Redis["Redis<br/>ç¼“å­˜"]
        FileSystem["FileSystem<br/>æ–‡ä»¶ç³»ç»Ÿ"]
    end

    %% APIè°ƒç”¨æœåŠ¡
    DiagnosisRouter --> DiagnosisService
    KnowledgeRouter --> KnowledgeService

    %% æœåŠ¡è°ƒç”¨æ¨¡å—
    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisService --> ImageService
    DiagnosisService --> KnowledgeService

    KnowledgeService --> KnowledgeLoader

    ImageService --> LocalImageStorage
    ImageService --> PostgreSQL

    %% æ¨¡å—é—´è°ƒç”¨
    VLMClient --> PROOFFramework
    VLMClient --> Redis
    DiagnosisScorer --> FuzzyMatcher
    KnowledgeLoader --> FileSystem
    LocalImageStorage --> FileSystem
```

#### 5.1.2 è°ƒç”¨å…³ç³»çŸ©é˜µ

| è°ƒç”¨è€… \ è¢«è°ƒç”¨è€… | DiagnosisService | VLMClient | DiagnosisScorer | KnowledgeLoader | FuzzyMatcher | PROOF Framework |
|-------------------|------------------|-----------|-----------------|-----------------|--------------|-----------------|
| **DiagnosisRouter** | âœ“ | - | - | - | - | - |
| **DiagnosisService** | - | âœ“ | âœ“ | - | - | - |
| **VLMClient** | - | - | - | - | - | âœ“ |
| **DiagnosisScorer** | - | - | - | - | âœ“ | - |

**è¯´æ˜**ï¼š
- âœ“ è¡¨ç¤ºè°ƒç”¨å…³ç³»
- åº”ç”¨æœåŠ¡å±‚ä¸èƒ½ç›´æ¥ä¾èµ–æŒä¹…åŒ–å±‚ï¼ˆå¿…é¡»é€šè¿‡Repositoryæ¨¡å¼ï¼‰
- åŸºç¡€è®¾æ–½æ¨¡å—ä¹‹é—´å¯ä»¥ç›¸äº’è°ƒç”¨ï¼ˆä½†è¦é¿å…å¾ªç¯ä¾èµ–ï¼‰

---

### 5.2 åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰

> **èŒè´£**ï¼šç¼–æ’ä¸šåŠ¡æµç¨‹ï¼Œè°ƒç”¨å¤šä¸ªåŸºç¡€è®¾æ–½æ¨¡å—ååŒå·¥ä½œï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œæµç¨‹æ§åˆ¶ã€‚

---

#### 5.2.1 DiagnosisServiceï¼ˆè¯Šæ–­æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/diagnosis_service.py`

**èŒè´£**ï¼š
- ç¼–æ’å®Œæ•´è¯Šæ–­æµç¨‹ï¼ˆQ0-Q6é—®è¯Šåºåˆ— + ä¸‰å±‚æ¸è¿›è¯Šæ–­ï¼‰
- åè°ƒVLMå®¢æˆ·ç«¯ã€çŸ¥è¯†åº“æœåŠ¡ã€è¯„åˆ†å™¨ã€å›¾ç‰‡æœåŠ¡
- å®ç°å…œåº•é€»è¾‘ï¼ˆçŸ¥è¯†åº“å¤–ç–¾ç—…ã€VLMå¤±è´¥ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `VLMClient`ï¼šè°ƒç”¨VLMè¿›è¡Œç‰¹å¾æå–
- `KnowledgeService`ï¼šè·å–å€™é€‰ç–¾ç—…åˆ—è¡¨
- `DiagnosisScorer`ï¼šè®¡ç®—è¯Šæ–­è¯„åˆ†
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡
- `DiagnosisRepository`ï¼šä¿å­˜è¯Šæ–­è®°å½•

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisRouter`ï¼ˆFastAPIè·¯ç”±ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisService:
    """æ ¸å¿ƒè¯Šæ–­æœåŠ¡ - ç¼–æ’è¯Šæ–­æµç¨‹"""

    def __init__(
        self,
        vlm_client: VLMClient,
        knowledge_service: KnowledgeService,
        scorer: DiagnosisScorer,
        diagnosis_repo: DiagnosisRepository,
        image_service: ImageService
    ):
        self.vlm_client = vlm_client
        self.knowledge_service = knowledge_service
        self.scorer = scorer
        self.diagnosis_repo = diagnosis_repo
        self.image_service = image_service

    async def diagnose(self, image_bytes: bytes, metadata: dict = None) -> DiagnosisResult:
        """
        æ‰§è¡Œå®Œæ•´è¯Šæ–­æµç¨‹

        æµç¨‹ï¼š
        1. ä¿å­˜å›¾ç‰‡
        2. Q0é€çº§è¿‡æ»¤ï¼ˆQ0.0-Q0.5ï¼‰
        3. Q1-Q6åŠ¨æ€ç‰¹å¾æå–
        4. æ„å»ºç‰¹å¾å‘é‡
        5. è·å–å€™é€‰ç–¾ç—…ï¼ˆåŸºäºç§å±ï¼‰
        6. ç–¾ç—…åŒ¹é…ä¸è¯„åˆ†
        7. ç½®ä¿¡åº¦åˆ†å±‚å†³ç­–ï¼ˆconfirmed/suspected/å…œåº•ï¼‰
        8. ä¿å­˜è¯Šæ–­è®°å½•
        """
        pass

    async def _execute_q0_sequence(self, image_bytes: bytes) -> dict:
        """æ‰§è¡ŒQ0é€çº§è¿‡æ»¤ï¼ˆè°ƒç”¨VLMClient 6æ¬¡ï¼‰"""
        pass

    async def _execute_q1_q6_sequence(self, image_bytes: bytes, symptom_type: str) -> dict:
        """æ‰§è¡ŒQ1-Q6åŠ¨æ€ç‰¹å¾æå–ï¼ˆæ ¹æ®symptom_typeåŠ¨æ€ç”Ÿæˆé—®é¢˜ï¼‰"""
        pass

    async def _vlm_open_ended_diagnosis(self, image_bytes: bytes) -> str:
        """VLMå¼€æ”¾å¼è¯Šæ–­ï¼ˆå…œåº•ç­–ç•¥ï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisRouter.diagnose()
  â†’ DiagnosisService.diagnose()
      â†’ ImageService.save_image()           # ä¿å­˜å›¾ç‰‡
      â†’ VLMClient.call_with_fallback()       # Q0.0å†…å®¹ç±»å‹è¯†åˆ«
      â†’ VLMClient.call_with_fallback()       # Q0.1æ¤ç‰©ç±»åˆ«è¯†åˆ«
      â†’ ...                                  # Q0.2-Q0.5
      â†’ VLMClient.call_with_fallback()       # Q1-Q6ç‰¹å¾æå–
      â†’ KnowledgeService.get_diseases_by_genus()  # è·å–å€™é€‰ç–¾ç—…
      â†’ DiagnosisScorer.calculate_score()    # è®¡ç®—è¯„åˆ†
      â†’ DiagnosisRepository.save()           # ä¿å­˜è¯Šæ–­è®°å½•
```

---

#### 5.2.2 KnowledgeServiceï¼ˆçŸ¥è¯†åº“æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/knowledge_service.py`

**èŒè´£**ï¼š
- çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
- æä¾›ç–¾ç—…åˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰èŠ±å‰å±ç­›é€‰ï¼‰
- ç®¡ç†çŸ¥è¯†åº“ç‰ˆæœ¬

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `KnowledgeLoader`ï¼šåŠ è½½JSONçŸ¥è¯†åº“

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šæŸ¥è¯¢å€™é€‰ç–¾ç—…
- `KnowledgeRouter`ï¼šç®¡ç†åå°æŸ¥è¯¢ç–¾ç—…åˆ—è¡¨

**å…³é”®æ¥å£**ï¼š

```python
class KnowledgeService:
    """çŸ¥è¯†åº“æœåŠ¡"""

    def __init__(self, loader: KnowledgeLoader):
        self.loader = loader
        self.knowledge_base: Optional[KnowledgeBaseAggregate] = None

    async def initialize(self):
        """ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½çŸ¥è¯†åº“"""
        self.knowledge_base = await self.loader.load_all()

    async def reload(self):
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆç®¡ç†åå°è°ƒç”¨ï¼‰"""
        self.knowledge_base = await self.loader.reload()

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """è·å–æŒ‡å®šèŠ±å‰å±çš„ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_all_diseases(self) -> List[DiseaseOntology]:
        """è·å–æ‰€æœ‰ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_disease_by_id(self, disease_id: str) -> Optional[DiseaseOntology]:
        """æ ¹æ®IDè·å–ç–¾ç—…è¯¦æƒ…"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeRouter.reload()
  â†’ KnowledgeService.reload()
      â†’ KnowledgeLoader.reload()  # é‡æ–°åŠ è½½JSONæ–‡ä»¶
```

---

#### 5.2.3 ImageServiceï¼ˆå›¾ç‰‡æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/image_service.py`

**èŒè´£**ï¼š
- å›¾ç‰‡ä¿å­˜ï¼ˆæŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»ï¼‰
- å›¾ç‰‡å…ƒæ•°æ®ç®¡ç†
- å‡†ç¡®æ€§æ ‡æ³¨

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `LocalImageStorage`ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨
- `ImageRepository`ï¼šå›¾ç‰‡å…ƒæ•°æ®æŒä¹…åŒ–

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šä¿å­˜è¯Šæ–­å›¾ç‰‡
- `AdminRouter`ï¼šå‡†ç¡®æ€§æ ‡æ³¨

**å…³é”®æ¥å£**ï¼š

```python
class ImageService:
    """å›¾ç‰‡æœåŠ¡"""

    def __init__(
        self,
        storage: LocalImageStorage,
        image_repo: ImageRepository
    ):
        self.storage = storage
        self.image_repo = image_repo

    async def save_image(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        organ: str
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„ï¼šstorage/images/unlabeled/{genus}/{year-month}/{day}/{diagnosis_id}_{disease_id}.jpg
        """
        pass

    async def update_accuracy_label(
        self,
        image_id: str,
        label: str  # "correct" / "incorrect"
    ):
        """æ›´æ–°å‡†ç¡®æ€§æ ‡ç­¾ï¼ˆç§»åŠ¨æ–‡ä»¶åˆ°correct/incorrectæ–‡ä»¶å¤¹ï¼‰"""
        pass

    async def query_images(
        self,
        genus: Optional[str] = None,
        accuracy_label: Optional[str] = None,
        date_range: Optional[tuple] = None
    ) -> List[ImageMetadata]:
        """æŸ¥è¯¢å›¾ç‰‡ï¼ˆæŒ‰èŠ±å‰å±ã€å‡†ç¡®æ€§ã€æ—¥æœŸèŒƒå›´ï¼‰"""
        pass
```

---

### 5.3 åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰

> **èŒè´£**ï¼šæä¾›æŠ€æœ¯èƒ½åŠ›ï¼ˆVLMè°ƒç”¨ã€æ•°æ®åº“è®¿é—®ã€ç®—æ³•å®ç°ï¼‰ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼Œå¯ç‹¬ç«‹æµ‹è¯•ã€‚

---

#### 5.3.1 VLMClientï¼ˆVLMå®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/client.py`

**èŒè´£**ï¼š
- VLM APIè°ƒç”¨ï¼ˆåŒ…è£…å¤šä¸ªProviderï¼‰
- Fallbackæœºåˆ¶ï¼ˆQwen â†’ ChatGPT â†’ Grok â†’ Claudeï¼‰
- ç¼“å­˜æœºåˆ¶ï¼ˆRedisï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
- é›†æˆInstructorï¼ˆè‡ªåŠ¨éªŒè¯Pydanticæ¨¡å‹ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `PROOFFramework`ï¼šè·å–æ¸²æŸ“åçš„æç¤ºè¯
- `RedisCache`ï¼šç¼“å­˜VLMå“åº”
- `VLM Providers`ï¼šå…·ä½“Providerå®ç°ï¼ˆQwenProvider, ChatGPTProviderç­‰ï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šQ0-Q6é—®è¯Šè°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class VLMClient:
    """VLMå®¢æˆ·ç«¯ - å®ç°Fallbackæœºåˆ¶ + Instructoré›†æˆ"""

    def __init__(self, providers: List[VLMProvider], cache: RedisCache):
        self.providers = providers  # æŒ‰ä¼˜å…ˆçº§æ’åºï¼šQwen, ChatGPT, Grok, Claude
        self.cache = cache

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],  # Pydanticæ¨¡å‹ï¼Œå¦‚Q00Response
        question_id: str = None
    ) -> BaseModel:
        """
        å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯

        æµç¨‹ï¼š
        1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº†question_idï¼‰
        2. ä¾æ¬¡å°è¯•å„Providerï¼ˆInstructorè‡ªåŠ¨éªŒè¯ + é‡è¯•3æ¬¡ï¼‰
        3. ç¼“å­˜ç»“æœï¼ˆttl=7å¤©ï¼‰
        4. æ‰€æœ‰Providerå¤±è´¥ â†’ æŠ›å‡ºVLMError
        """
        pass

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®ï¼švlm:{image_hash}:{question_id}"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService._execute_q0_sequence()
  â†’ VLMClient.call_with_fallback(prompt=Q0_0_PROMPT, response_model=Q00Response)
      â†’ RedisCache.get()                    # å°è¯•ç¼“å­˜
      â†’ QwenVLProvider.call()               # è°ƒç”¨Qwen VL Plus
          â†’ Instructor.chat.completions.create()  # Instructorè‡ªåŠ¨éªŒè¯
      â†’ RedisCache.set()                    # ç¼“å­˜ç»“æœ
```

---

#### 5.3.2 FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/matcher.py`

**èŒè´£**ï¼š
- é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆCOLOR_GROUPSåŒè‰²ç³»åŒ¹é…ï¼‰
- å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆSIZE_ORDERå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰
- ä½ç½®æ¨¡ç³ŠåŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼åŒ¹é…ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisScorer`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class FuzzyMatcher:
    """æ¨¡ç³ŠåŒ¹é…å¼•æ“ - å¤„ç†VLMè§‚å¯Ÿè¯¯å·®"""

    COLOR_GROUPS = {
        "é»‘è¤è‰²ç³»": ["black", "dark_brown", "brown", "dark"],
        "é»„è‰²ç³»": ["yellow", "light_yellow", "yellowish_green", "pale_yellow"],
        "ç™½è‰²ç³»": ["white", "gray_white", "off_white", "cream"],
        # ...
    }

    SIZE_ORDER = ["pinpoint", "small", "medium_small", "medium", "large"]

    def match_color(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆç²¾ç¡®åŒ¹é… + åŒè‰²ç³»åŒ¹é…ï¼‰"""
        pass

    def match_size(self, observed: str, expected: str) -> bool:
        """å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰"""
        pass

    def match_location(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """ä½ç½®åŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼ï¼‰"""
        pass
```

---

#### 5.3.3 DiagnosisScorerï¼ˆåŠ æƒè¯Šæ–­è¯„åˆ†å™¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/scorer.py`

**èŒè´£**ï¼š
- å®ç°åŠ æƒè¯Šæ–­è¯„åˆ†ç®—æ³•
- ä¸»è¦ç‰¹å¾æƒé‡0.8ï¼ˆsymptom_type: 0.5 + color_center: 0.3ï¼‰
- æ¬¡è¦ç‰¹å¾æƒé‡0.15ã€å¯é€‰ç‰¹å¾æƒé‡0.05
- å®Œæ•´æ€§ä¿®æ­£ç³»æ•°ï¼ˆcomplete: 1.0, partial: 0.8, close_up: 0.6ï¼‰
- è¯Šæ–­è§„åˆ™åˆ¤å®šï¼ˆconfirmed/suspected/unlikelyï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `FuzzyMatcher`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šç–¾ç—…åŒ¹é…ä¸è¯„åˆ†æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisScorer:
    """åŠ æƒè¯Šæ–­è¯„åˆ†å™¨ - æ ¸å¿ƒè¯Šæ–­ç®—æ³•"""

    def __init__(self, matcher: FuzzyMatcher):
        self.matcher = matcher

    def calculate_score(
        self,
        observed_features: dict,      # ç‰¹å¾å‘é‡ï¼ˆä»VLMæå–ï¼‰
        disease_definition: dict      # ç–¾ç—…å®šä¹‰ï¼ˆä»çŸ¥è¯†åº“ï¼‰
    ) -> DiagnosisScore:
        """
        è®¡ç®—è¯Šæ–­åˆ†æ•°

        æµç¨‹ï¼š
        1. è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†ï¼ˆè°ƒç”¨FuzzyMatcheråŒ¹é…ï¼‰
        2. è®¡ç®—æ¬¡è¦ç‰¹å¾å¾—åˆ†
        3. è®¡ç®—å¯é€‰ç‰¹å¾å¾—åˆ†
        4. åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
        5. ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰
        6. è¿”å›DiagnosisScoreå¯¹è±¡

        è¿”å›ï¼šDiagnosisScore(
            total_score,
            major_features_score,
            minor_features_score,
            optional_features_score,
            major_matched,   # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
            major_total      # ä¸»è¦ç‰¹å¾æ€»æ•°
        )
        """
        pass

    def _calculate_major_score(self, observed: dict, major_config: dict) -> float:
        """è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†"""
        pass

    def _count_major_matched(self, observed: dict, major_config: dict) -> int:
        """ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService.diagnose()
  â†’ DiagnosisScorer.calculate_score(feature_vector, disease)
      â†’ _calculate_major_score()
          â†’ FuzzyMatcher.match_color()     # é¢œè‰²åŒ¹é…
          â†’ FuzzyMatcher.match_size()      # å°ºå¯¸åŒ¹é…
      â†’ _calculate_minor_score()
      â†’ _calculate_optional_score()
      â†’ åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
      â†’ è¿”å›DiagnosisScore
```

---

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/loader.py`

**èŒè´£**ï¼š
- åŠ è½½JSONçŸ¥è¯†åº“æ–‡ä»¶ï¼ˆç–¾ç—…ã€æ¤ç‰©ã€ç‰¹å¾ã€å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼‰
- è§£æJSON â†’ Pydanticå¯¹è±¡ï¼ˆç±»å‹å®‰å…¨ï¼‰
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆreloadæ–¹æ³•ï¼‰
- è®°å½•çŸ¥è¯†åº“ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥è¯»å–æ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `KnowledgeService`ï¼šåˆå§‹åŒ–å’Œé‡è½½æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class JSONKnowledgeLoader:
    """JSONçŸ¥è¯†åº“åŠ è½½å™¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # knowledge_base/
        self._cache = {}

    async def load_all(self) -> KnowledgeBaseAggregate:
        """
        åŠ è½½å®Œæ•´çŸ¥è¯†åº“

        æµç¨‹ï¼š
        1. åŠ è½½ç–¾ç—…æœ¬ä½“ï¼ˆknowledge_base/diseases/*.jsonï¼‰
        2. åŠ è½½æ¤ç‰©æœ¬ä½“ï¼ˆknowledge_base/plants/*.jsonï¼‰
        3. åŠ è½½ç‰¹å¾æœ¬ä½“ï¼ˆknowledge_base/features/feature_ontology.jsonï¼‰
        4. åŠ è½½å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼ˆknowledge_base/host_disease/associations.jsonï¼‰
        5. è®°å½•ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰
        6. è¿”å›KnowledgeBaseAggregateå¯¹è±¡
        """
        pass

    async def reload(self) -> KnowledgeBaseAggregate:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆæ¸…é™¤ç¼“å­˜ + é‡æ–°åŠ è½½ï¼‰"""
        pass

    def _get_git_commit_hash(self) -> str:
        """è·å–å½“å‰Git commit hashä½œä¸ºç‰ˆæœ¬å·"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeService.initialize()
  â†’ KnowledgeLoader.load_all()
      â†’ è¯»å–knowledge_base/diseases/*.json
      â†’ JSONè§£æä¸ºDiseaseOntologyå¯¹è±¡
      â†’ è¯»å–knowledge_base/plants/*.json
      â†’ JSONè§£æä¸ºPlantOntologyå¯¹è±¡
      â†’ è¿”å›KnowledgeBaseAggregate
```

---

#### 5.3.5 PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/prompts/framework.py`

**èŒè´£**ï¼š
- æä¾›PROOFæ¡†æ¶ï¼ˆPurpose + Role + Observation + Options + Formatï¼‰
- ç»“æ„åŒ–æç¤ºè¯ç¼–å†™ï¼ˆç»Ÿä¸€5å¤§ç»„ä»¶ï¼‰
- æ”¯æŒå‚æ•°åŒ–å’ŒA/Bæµ‹è¯•
- å¯¼å‡ºJSONé…ç½®ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
- èå…¥æ–¹æ³•è®ºv5.0è§†è§‰åŒ–æ–¹æ³•

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `VLMClient`ï¼šæ¸²æŸ“æç¤ºè¯æ—¶è°ƒç”¨
- æç¤ºè¯å®šä¹‰æ–‡ä»¶ï¼ˆ`q0_0_content.py`, `q0_1_category.py`ç­‰ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        """
        åˆå§‹åŒ–PROOFæç¤ºè¯

        å‚æ•°ï¼š
        - question_id: é—®é¢˜IDï¼ˆå¦‚"Q0.0"ï¼‰
        - purpose: æç¤ºè¯ç›®çš„ï¼ˆtask + context + why_importantï¼‰
        - role: æç¤ºè¯è§’è‰²ï¼ˆrole + expertise + constraintsï¼‰
        - observation: è§‚å¯ŸæŒ‡å¯¼ï¼ˆvisual_method + visual_clues + focus_areasï¼‰
        - options: æç¤ºè¯é€‰é¡¹ï¼ˆchoices + allow_unknownï¼‰
        - format_spec: è¾“å‡ºæ ¼å¼ï¼ˆresponse_schema + examplesï¼‰
        - version: æç¤ºè¯ç‰ˆæœ¬å·
        """
        pass

    def render(self) -> str:
        """
        æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²

        æµç¨‹ï¼š
        1. æ¸²æŸ“Roleéƒ¨åˆ†
        2. æ¸²æŸ“Purposeéƒ¨åˆ†
        3. æ¸²æŸ“Observationéƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
        4. æ¸²æŸ“Optionséƒ¨åˆ†
        5. æ¸²æŸ“Formatéƒ¨åˆ†ï¼ˆFew-shotç¤ºä¾‹ + å“åº”æ ¼å¼ï¼‰
        6. æ¸²æŸ“Constraints
        7. è¿”å›å®Œæ•´æç¤ºè¯å­—ç¬¦ä¸²
        """
        pass

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        pass
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# infrastructure/llm/prompts/q0_2_genus.py
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            # ...
        }
    ),
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            # ...
        ],
        allow_unknown=True
    ),
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[...]
    ),
    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()
```

---

#### 5.3.6 LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/storage/local_storage.py`

**èŒè´£**ï¼š
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå›¾ç‰‡å­˜å‚¨
- æŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»å­˜å‚¨
- æ–‡ä»¶è·¯å¾„ç”Ÿæˆï¼ˆè§„èŒƒåŒ–ï¼‰
- æ–‡ä»¶ç§»åŠ¨ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡å’Œç§»åŠ¨æ–‡ä»¶æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class LocalImageStorage:
    """æœ¬åœ°å›¾ç‰‡å­˜å‚¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # storage/images/

    async def save(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str = "unlabeled"  # unlabeled / correct / incorrect
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„è§„èŒƒï¼š
        storage/images/{accuracy_label}/{genus}/{year-month}/{day}/{diagnosis_id}.jpg

        ç¤ºä¾‹ï¼š
        storage/images/unlabeled/rosa/2025-11/10/diag_20251110_001.jpg
        """
        pass

    async def move(
        self,
        old_path: str,
        new_accuracy_label: str  # correct / incorrect
    ) -> str:
        """ç§»åŠ¨æ–‡ä»¶ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰"""
        pass

    def get_path(
        self,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str
    ) -> str:
        """ç”Ÿæˆæ–‡ä»¶è·¯å¾„"""
        pass
```

---

### 5.4 æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº

æ ¹æ®ä¾èµ–å…³ç³»ï¼Œæ¨èä»¥ä¸‹å®ç°é¡ºåºï¼š

```
ç¬¬1å±‚ï¼ˆæ— ä¾èµ–ï¼‰ï¼š
  â”œâ”€ FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰
  â”œâ”€ PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰
  â””â”€ LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

ç¬¬2å±‚ï¼ˆä¾èµ–ç¬¬1å±‚ï¼‰ï¼š
  â”œâ”€ VLMClientï¼ˆä¾èµ–PROOF Frameworkï¼‰
  â”œâ”€ DiagnosisScorerï¼ˆä¾èµ–FuzzyMatcherï¼‰
  â””â”€ KnowledgeLoaderï¼ˆæ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå®ç°ï¼‰

ç¬¬3å±‚ï¼ˆä¾èµ–ç¬¬2å±‚ï¼‰ï¼š
  â”œâ”€ KnowledgeServiceï¼ˆä¾èµ–KnowledgeLoaderï¼‰
  â””â”€ ImageServiceï¼ˆä¾èµ–LocalImageStorage + ImageRepositoryï¼‰

ç¬¬4å±‚ï¼ˆä¾èµ–ç¬¬3å±‚ï¼‰ï¼š
  â””â”€ DiagnosisServiceï¼ˆä¾èµ–VLMClient + DiagnosisScorer + KnowledgeService + ImageServiceï¼‰
```

---

### 5.5 å…³é”®è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£
2. **ä¾èµ–å€’ç½®**ï¼šæœåŠ¡ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
3. **æ¥å£éš”ç¦»**ï¼šæ¨¡å—åªæš´éœ²å¿…è¦çš„å…¬å…±æ¥å£
4. **é¿å…å¾ªç¯ä¾èµ–**ï¼šä¸¥æ ¼æŒ‰ç…§åˆ†å±‚è°ƒç”¨ï¼ˆAPI â†’ Services â†’ Infrastructure â†’ Persistenceï¼‰

---

### 5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰

> **âš ï¸ æ¶æ„åœ°ä½è­¦ç¤º**ï¼šæç¤ºè¯æ¡†æ¶æ˜¯ PhytoOracle çš„**æ ¸å¿ƒåŸºç¡€è®¾æ–½**ï¼Œç±»ä¼¼äºæ•°æ®åº“ Schema æˆ– API å¥‘çº¦ã€‚ä¸€æ—¦å®šå‹åï¼Œä»»ä½•æ”¹åŠ¨éƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿï¼ˆVLM Providerã€è¯Šæ–­æœåŠ¡ã€æµ‹è¯•ç”¨ä¾‹ç­‰ï¼‰ã€‚è¯·æ…é‡è®¾è®¡å¹¶å……åˆ†æµ‹è¯•ã€‚

---

#### 5.6.1 é¡¹ç›®æœ¬è´¨å®šä½

**PhytoOracle çš„æ ¸å¿ƒæœ¬è´¨**ï¼š

```
PhytoOracle = æç¤ºè¯å·¥ç¨‹ (Prompt Engineering) + è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹ (Diagnostic Q&A System)
```

**ä¸¤å¤§æ ¸å¿ƒç»„ä»¶**ï¼š

1. **æç¤ºè¯å·¥ç¨‹**ï¼ˆæœ¬èŠ‚å†…å®¹ï¼‰
   - ç»“æ„åŒ–æç¤ºè¯è®¾è®¡ï¼ˆPROOF Frameworkï¼‰
   - VLM å“åº”æ ¼å¼ä¿éšœï¼ˆInstructorï¼‰
   - è§†è§‰åŒ–æ–¹æ³•èå…¥ï¼ˆæ–¹æ³•è®º v5.0ï¼‰
   - ç‰ˆæœ¬ç®¡ç†ä¸ A/B æµ‹è¯•

2. **è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹**ï¼ˆDiagnosisServiceï¼‰
   - Q0-Q6 é€çº§è¿‡æ»¤æµç¨‹
   - Layer1-Layer3 æ¸è¿›è¯Šæ–­
   - çŸ¥è¯†åº“åŒ¹é…ä¸è¯„åˆ†
   - å…œåº•é€»è¾‘è®¾è®¡

**å¯å¤ç”¨æ€§**ï¼š
- âœ… æœªæ¥ç±»ä¼¼é¡¹ç›®ï¼ˆå¦‚ä½œç‰©ç–¾ç—…è¯Šæ–­ã€åŠ¨ç‰©ç–¾ç—…è¯†åˆ«ï¼‰å¯ä»¥**ç›´æ¥å¤ç”¨**æç¤ºè¯æ¡†æ¶
- âœ… åªéœ€ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼ˆç–¾ç—…çŸ¥è¯†åº“ã€ç‰¹å¾å®šä¹‰ï¼‰
- âœ… æç¤ºè¯æ¡†æ¶ä¿æŒä¸å˜ï¼Œå¤§å¹…é™ä½å¼€å‘æˆæœ¬

---

#### 5.6.2 ä¸¤å±‚è§„èŒƒæ€§è®¾è®¡

**é—®é¢˜é™ˆè¿°**ï¼š
- **å±‚æ¬¡1**ï¼šå¦‚ä½•ç»“æ„åŒ–åœ°**ç¼–å†™**æç¤ºè¯ï¼Ÿï¼ˆç¼–å†™é˜¶æ®µè§„èŒƒæ€§ï¼‰
- **å±‚æ¬¡2**ï¼šå¦‚ä½•ç¡®ä¿ VLM **è¿”å›**çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Ÿï¼ˆè¿è¡Œæ—¶è§„èŒƒæ€§ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

| å±‚æ¬¡ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | è´£ä»»æ¨¡å— |
|------|------|---------|---------|
| **å±‚æ¬¡1** | æç¤ºè¯ç¼–å†™ä¸è§„èŒƒï¼Œéš¾ä»¥ç»´æŠ¤å’Œ A/B æµ‹è¯• | PROOF Framework | `PromptFramework` |
| **å±‚æ¬¡2** | VLM è¾“å‡ºæ ¼å¼ä¸å¯æ§ï¼Œéœ€è¦é‡è¯•å’Œå¼‚å¸¸å¤„ç† | Instructor | `VLMClient` + `Instructor` |

---

#### 5.6.3 PROOF Frameworkï¼ˆæç¤ºè¯è§„èŒƒæ€§ï¼‰

**PROOF** = **P**urpose + **R**ole + **O**bservation + **O**ptions + **F**ormat

**è®¾è®¡ç›®æ ‡**ï¼š
1. æ‰€æœ‰æç¤ºè¯éµå¾ªç»Ÿä¸€çš„ 5 å¤§ç»„ä»¶ç»“æ„
2. æ”¯æŒå‚æ•°åŒ–ï¼Œä¾¿äº A/B æµ‹è¯•
3. å¯¼å‡º JSON é…ç½®ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶
4. èå…¥æ–¹æ³•è®º v5.0 çš„è§†è§‰åŒ–æ–¹æ³•

**æ¡†æ¶åŸºç±»å®šä¹‰**ï¼š

```python
# infrastructure/llm/prompts/framework.py
from typing import List, Optional, Type, Dict
from pydantic import BaseModel
from dataclasses import dataclass
from datetime import datetime

@dataclass
class PromptPurpose:
    """æç¤ºè¯ç›®çš„"""
    task: str                          # ä»»åŠ¡æè¿°ï¼ˆä¸€å¥è¯ï¼‰
    context: Optional[str] = None      # å‰ç½®æ¡ä»¶
    why_important: Optional[str] = None  # ä¸ºä»€ä¹ˆé‡è¦ï¼ˆå¯é€‰ï¼‰

@dataclass
class PromptRole:
    """æç¤ºè¯è§’è‰²"""
    role: str                     # è§’è‰²åç§°
    expertise: List[str]          # ä¸“ä¸šçŸ¥è¯†é¢†åŸŸ
    constraints: List[str] = None # è§’è‰²é™åˆ¶

@dataclass
class PromptObservation:
    """è§‚å¯ŸæŒ‡å¯¼"""
    visual_method: Optional[str] = None      # è§†è§‰åŒ–æ–¹æ³•åç§°ï¼ˆå¦‚"Egg Yolk Metaphor"ï¼‰
    visual_clues: Optional[Dict[str, str]] = None  # è§†è§‰çº¿ç´¢
    focus_areas: Optional[List[str]] = None  # é‡ç‚¹å…³æ³¨åŒºåŸŸ

@dataclass
class Choice:
    """é€‰é¡¹"""
    label: str           # é€‰é¡¹æ ‡ç­¾
    description: str     # é€‰é¡¹æè¿°

@dataclass
class PromptOptions:
    """æç¤ºè¯é€‰é¡¹"""
    choices: List[Choice]           # é€‰é¡¹åˆ—è¡¨
    allow_unknown: bool = True      # æ˜¯å¦å…è®¸"unknown"
    allow_uncertain: bool = False   # æ˜¯å¦å…è®¸"unclear"

@dataclass
class Example:
    """Few-shot ç¤ºä¾‹"""
    input: str                      # è¾“å…¥æè¿°
    output: BaseModel               # è¾“å‡ºï¼ˆPydantic å¯¹è±¡ï¼‰

@dataclass
class PromptFormat:
    """è¾“å‡ºæ ¼å¼"""
    response_schema: Type[BaseModel]  # Pydantic å“åº”æ¨¡å‹
    examples: Optional[List[Example]] = None  # Few-shot ç¤ºä¾‹
    constraints: List[str] = None     # è¾“å‡ºçº¦æŸ

class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        self.question_id = question_id
        self.purpose = purpose
        self.role = role
        self.observation = observation
        self.options = options
        self.format_spec = format_spec
        self.version = version
        self.last_modified = datetime.now().isoformat()

    def render(self) -> str:
        """æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²"""
        sections = []

        # 1. Role
        sections.append(f"You are a {self.role.role}.")
        if self.role.expertise:
            sections.append(f"Your expertise: {', '.join(self.role.expertise)}.")
        sections.append("")

        # 2. Purpose
        sections.append(f"TASK: {self.purpose.task}")
        if self.purpose.context:
            sections.append(f"CONTEXT: {self.purpose.context}")
        sections.append("")

        # 3. Observationï¼ˆå¦‚æœæœ‰ï¼‰
        if self.observation.visual_method:
            sections.append(f"VISUAL METHOD ({self.observation.visual_method}):")

        if self.observation.visual_clues:
            sections.append("VISUAL CLUES:")
            for key, value in self.observation.visual_clues.items():
                sections.append(f"- {key}: {value}")
            sections.append("")

        # 4. Options
        sections.append("CHOICES:")
        for choice in self.options.choices:
            sections.append(f"- {choice.label}: {choice.description}")

        if self.options.allow_unknown:
            sections.append("- unknown (å¦‚æœä¸åœ¨ä»¥ä¸Šåˆ—è¡¨ä¸­)")
        sections.append("")

        # 5. Formatï¼ˆFew-shot ç¤ºä¾‹ï¼‰
        if self.format_spec.examples:
            sections.append("FEW-SHOT EXAMPLE:")
            for example in self.format_spec.examples:
                sections.append(f"Input: {example.input}")
                sections.append(f"Output: {example.output.model_dump_json(indent=2)}")
            sections.append("")

        # 6. Formatï¼ˆå“åº”æ ¼å¼ï¼‰
        sections.append("RESPONSE FORMAT (JSON only):")
        sections.append("```json")
        sections.append(self._generate_example_json())
        sections.append("```")
        sections.append("")

        # 7. Constraints
        sections.append("IMPORTANT: Only return JSON, no additional text.")

        return "\n".join(sections)

    def _generate_example_json(self) -> str:
        """æ ¹æ® response_schema ç”Ÿæˆç¤ºä¾‹ JSON"""
        import json
        schema = self.format_spec.response_schema.model_json_schema()
        properties = schema.get("properties", {})
        example = {}

        for key, prop in properties.items():
            if prop.get("type") == "string":
                example[key] = "example_value"
            elif prop.get("type") == "number":
                example[key] = 0.85

        return json.dumps(example, indent=2, ensure_ascii=False)

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        return {
            "question_id": self.question_id,
            "version": self.version,
            "last_modified": self.last_modified,
            "purpose": {
                "task": self.purpose.task,
                "context": self.purpose.context
            },
            "role": {
                "role": self.role.role,
                "expertise": self.role.expertise
            },
            "observation": {
                "visual_method": self.observation.visual_method,
                "visual_clues": self.observation.visual_clues
            },
            "options": {
                "choices": [{"label": c.label, "description": c.description} for c in self.options.choices],
                "allow_unknown": self.options.allow_unknown
            }
        }
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆQ0.2 èŠ±å‰ç§å±è¯†åˆ«ï¼‰**ï¼š

```python
# infrastructure/llm/prompts/q0_2_genus.py
from .framework import *
from ..response_schema import Q02Response

# å®šä¹‰æç¤ºè¯å‚æ•°
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",

    # P - Purpose
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),

    # R - Role
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),

    # O - Observation
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            "Tulipa": "Long narrow leaves, cup-shaped flowers, smooth stem",
            "Dianthus": "Narrow linear leaves, fringed petal edges, swollen stem nodes",
            "Paeonia": "Large compound leaves, large multi-layered flowers, thick stems"
        },
        focus_areas=["leaf shape", "stem texture", "petal arrangement"]
    ),

    # O - Options
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            Choice("Tulipa", "éƒé‡‘é¦™å±"),
            Choice("Dianthus", "åº·ä¹ƒé¦¨å±"),
            Choice("Paeonia", "ç‰¡ä¸¹å±")
        ],
        allow_unknown=True
    ),

    # F - Format
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[
            Example(
                input="Image shows a flower with compound leaves (5 leaflets), thorns on stem, pink layered petals",
                output=Q02Response(
                    choice="Rosa",
                    confidence=0.92,
                    reasoning="Compound leaves with 5 leaflets and thorny stems areå…¸å‹ç‰¹å¾ of Rosa genus"
                )
            )
        ]
    ),

    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()

# å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰
Q0_2_GENUS_CONFIG = q0_2_prompt.to_dict()
```

---

#### 5.6.4 Instructor é›†æˆï¼ˆè¾“å‡ºè§„èŒƒæ€§ï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹© Instructor**ï¼š

| å¯¹æ¯”ç»´åº¦ | è‡ªç ” ResponseValidator | Instructor | é€‰æ‹©åŸå›  |
|---------|---------------------|-----------|---------|
| **è‡ªåŠ¨é‡è¯•** | âŒ éœ€è¦æ‰‹å·¥å®ç° | âœ… å†…ç½®ï¼ˆæœ€å¤š3æ¬¡ï¼‰ | å‡å°‘ä»£ç é‡ |
| **å¤š Provider æ”¯æŒ** | âŒ éœ€è¦æ¯ä¸ª Provider é€‚é… | âœ… æ”¯æŒ 15+ Provider | è¦†ç›– Qwen/ChatGPT/Claude |
| **ç»´æŠ¤æˆæœ¬** | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ | âœ… ç¤¾åŒºç»´æŠ¤ | é™ä½æŠ€æœ¯å€º |
| **ä¾èµ–å¤§å°** | âœ… 0 | âœ… 25KB | å‡ ä¹æ— å½±å“ |
| **å­¦ä¹ æˆæœ¬** | ğŸŸ¡ éœ€è¦ç†è§£è‡ªç ”ä»£ç  | âœ… æ–‡æ¡£æ¸…æ™° | é™ä½ä¸Šæ‰‹æˆæœ¬ |

**Instructor é›†æˆæ–¹æ¡ˆ**ï¼š

```python
# infrastructure/llm/client.py
import instructor
from openai import OpenAI
from anthropic import Anthropic
from typing import Type, List
from pydantic import BaseModel

class VLMClient:
    """VLMå®¢æˆ·ç«¯ - é›†æˆ Instructor å®ç°ç»“æ„åŒ–è¾“å‡º"""

    def __init__(self):
        # åŒ…è£…å„Providerï¼ˆä½¿ç”¨ Instructorï¼‰
        self.providers = [
            instructor.from_openai(OpenAI(base_url="https://dashscope.aliyuncs.com/compatible-mode/v1")),  # Qwen
            instructor.from_openai(OpenAI()),                                                              # ChatGPT
            instructor.from_anthropic(Anthropic())                                                         # Claude
        ]
        self.current_provider_index = 0

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],
        question_id: str = None
    ) -> BaseModel:
        """å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯"""

        # 1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº† question_idï¼‰
        if question_id:
            cache_key = self._build_cache_key(image, question_id)
            cached = await self.cache.get(cache_key)
            if cached:
                return response_model.model_validate_json(cached)

        # 2. ä¾æ¬¡å°è¯•å„Provider
        last_error = None
        for provider in self.providers:
            try:
                # Instructor è‡ªåŠ¨éªŒè¯ + é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
                response = provider.chat.completions.create(
                    model="auto-detect",
                    response_model=response_model,  # è‡ªåŠ¨éªŒè¯ Pydantic æ¨¡å‹
                    messages=[
                        {"role": "system", "content": "You are a JSON API. Always respond with valid JSON."},
                        {"role": "user", "content": [
                            {"type": "image_url", "image_url": self._encode_image(image)},
                            {"type": "text", "text": prompt}
                        ]}
                    ],
                    max_retries=3  # Instructor è‡ªåŠ¨é‡è¯•
                )

                # ç¼“å­˜ç»“æœ
                if question_id:
                    await self.cache.set(cache_key, response.model_dump_json(), ttl=7*24*3600)

                return response  # å·²ç»æ˜¯ Pydantic å¯¹è±¡ï¼Œ100% ç¬¦åˆæ ¼å¼

            except Exception as e:
                logger.warning(f"Provider {provider} failed: {e}")
                last_error = str(e)
                continue

        # 3. æ‰€æœ‰Provideréƒ½å¤±è´¥
        raise VLMError(f"All VLM providers failed. Last error: {last_error}")

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®"""
        import hashlib
        image_hash = hashlib.md5(image).hexdigest()
        return f"vlm:{image_hash}:{question_id}"

    def _encode_image(self, image: bytes) -> str:
        """å°†å›¾ç‰‡ç¼–ç ä¸º base64"""
        import base64
        return f"data:image/jpeg;base64,{base64.b64encode(image).decode()}"
```

**DiagnosisService ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# application/services/diagnosis_service.py
class DiagnosisService:
    def __init__(self, vlm_client: VLMClient, knowledge_base: KnowledgeBase):
        self.vlm_client = vlm_client
        self.knowledge_base = knowledge_base

    async def diagnose(self, image: bytes) -> DiagnosisResult:
        # Layer1: Q0.0 å†…å®¹ç±»å‹è¯†åˆ«
        q0_0_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_0_CONTENT_TYPE_PROMPT.render(),
            image=image,
            response_model=Q00Response,  # Instructor è‡ªåŠ¨éªŒè¯
            question_id="Q0.0"
        )

        if q0_0_response.choice != "plant":
            return self._reject_non_plant(q0_0_response)

        # Layer1: Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«
        q0_1_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_1_PLANT_CATEGORY_PROMPT.render(),
            image=image,
            response_model=Q01Response,
            question_id="Q0.1"
        )

        if q0_1_response.choice != "flower":
            return self._reject_non_flower(q0_1_response)

        # Layer1: Q0.2 èŠ±å‰ç§å±è¯†åˆ«
        q0_2_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_2_GENUS_PROMPT.render(),
            image=image,
            response_model=Q02Response,
            question_id="Q0.2"
        )

        flower_genus = q0_2_response.choice
        if flower_genus == "unknown":
            return self._fallback_unknown_genus(q0_2_response)

        # ... Q0.3 - Q0.6 é€çº§è¿‡æ»¤
        # ... Layer2: çŸ¥è¯†åº“åŒ¹é…
        # ... Layer3: ç½®ä¿¡åº¦å†³ç­–
```

---

#### 5.6.5 VLM å“åº”æ ¼å¼åè®®ï¼ˆPydantic Modelsï¼‰

æ‰€æœ‰ VLM Provider å¿…é¡»è¿”å›ä¸¥æ ¼ç¬¦åˆæ­¤åè®®çš„ JSONï¼š

```python
# infrastructure/llm/response_schema.py
from typing import Literal, Optional, List
from pydantic import BaseModel, Field

class VLMResponse(BaseModel):
    """VLMå“åº”åŸºç±»"""
    choice: str = Field(..., description="é€‰æ‹©çš„é€‰é¡¹å€¼")
    confidence: float = Field(..., ge=0.0, le=1.0, description="VLMå¯¹æ­¤ç­”æ¡ˆçš„ç½®ä¿¡åº¦")
    reasoning: Optional[str] = Field(None, description="æ¨ç†è¿‡ç¨‹ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰")

# Q0ç³»åˆ—å“åº”æ ¼å¼
class Q00Response(VLMResponse):
    """Q0.0 å†…å®¹ç±»å‹è¯†åˆ«"""
    choice: Literal["plant", "animal", "person", "object", "landscape", "other"]

class Q01Response(VLMResponse):
    """Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«"""
    choice: Literal["flower", "vegetable", "tree", "crop", "grass", "other"]

class Q02Response(VLMResponse):
    """Q0.2 èŠ±å‰ç§å±è¯†åˆ«"""
    choice: Literal["Rosa", "Prunus", "Tulipa", "Dianthus", "Paeonia", "unknown"]

class Q03Response(VLMResponse):
    """Q0.3 å™¨å®˜è¯†åˆ«"""
    choice: Literal["flower", "leaf"]

class Q04Response(VLMResponse):
    """Q0.4 å®Œæ•´æ€§æ£€æŸ¥"""
    choice: Literal["complete", "partial", "close_up"]

class Q05Response(VLMResponse):
    """Q0.5 å¼‚å¸¸åˆ¤æ–­"""
    choice: Literal["healthy", "abnormal"]

# Q1-Q6åŠ¨æ€ç‰¹å¾æå–
class FeatureResponse(VLMResponse):
    """Q1-Q6ç‰¹å¾æå–å“åº”ï¼ˆåŠ¨æ€ï¼‰"""
    choice: str  # æ ¹æ®symptom_typeåŠ¨æ€å˜åŒ–
    alternatives: Optional[List[str]] = Field(None, description="å…¶ä»–å¯èƒ½çš„é€‰é¡¹ï¼ˆä¸ç¡®å®šæ—¶ï¼‰")
```

---

#### 5.6.6 æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**æ–‡ä»¶ç»„ç»‡**ï¼š
```
infrastructure/llm/prompts/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ framework.py            # PROOF Framework åŸºç±»
â”œâ”€â”€ q0_0_content.py         # Q0.0 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_1_category.py        # Q0.1 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_2_genus.py           # Q0.2 æç¤ºè¯å®šä¹‰ï¼ˆè§ä¸Šé¢ç¤ºä¾‹ï¼‰
â”œâ”€â”€ q0_3_organ.py           # Q0.3 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_4_completeness.py    # Q0.4 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_5_abnormality.py     # Q0.5 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 åŠ¨æ€æ¨¡æ¿
â”œâ”€â”€ configs/                # JSON é…ç½®æ–‡ä»¶ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”œâ”€â”€ q0_2_genus_v1.0.json
â”‚   â”œâ”€â”€ q0_2_genus_v1.1.json
â”‚   â””â”€â”€ ...
â””â”€â”€ CHANGELOG.md            # æç¤ºè¯å˜æ›´æ—¥å¿—
```

**ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ**ï¼š
1. æç¤ºè¯å‚æ•°ï¼ˆPROOFPrompt å¯¹è±¡ï¼‰çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶
2. æ¯æ¬¡ä¿®æ”¹æç¤ºè¯å¿…é¡»ï¼š
   - æ›´æ–° CHANGELOG.md
   - è¿è¡Œ A/B æµ‹è¯•éªŒè¯å‡†ç¡®ç‡
   - å‡†ç¡®ç‡ä¸‹é™ >5% åˆ™å›æ»š
3. æç¤ºè¯ç‰ˆæœ¬å·ä¸çŸ¥è¯†åº“ç‰ˆæœ¬å·ç‹¬ç«‹ç®¡ç†

**CHANGELOG.md ç¤ºä¾‹**ï¼š

```markdown
# Prompt Engineering CHANGELOG

## Q0.2 èŠ±å‰ç§å±è¯†åˆ«

### v1.1 (2025-11-15)
- **æ”¹åŠ¨**: æ›´æ–° Few-shot ç¤ºä¾‹ï¼ˆä» Rosa æ”¹ä¸º Prunusï¼‰
- **åŸå› **: æµ‹è¯•å‘ç° VLM å¯¹ Prunus çš„è¯†åˆ«å‡†ç¡®ç‡è¾ƒä½
- **A/B æµ‹è¯•ç»“æœ**: å‡†ç¡®ç‡ä» 82% æå‡åˆ° 88%
- **å®¡æ‰¹äºº**: @expert_botanist

### v1.0 (2025-11-11)
- åˆå§‹ç‰ˆæœ¬
- é‡‡ç”¨ Compound Feature Description è§†è§‰åŒ–æ–¹æ³•
```

**A/B æµ‹è¯•æµç¨‹**ï¼š

```python
# tests/prompt_ab_test.py
async def ab_test_prompt(
    test_images: List[bytes],
    variant_a: PROOFPrompt,
    variant_b: PROOFPrompt
) -> dict:
    """å¯¹æ¯”ä¸¤ä¸ªæç¤ºè¯å˜ä½“çš„å‡†ç¡®ç‡"""

    accuracy_a = await test_prompts(test_images, variant_a.render())
    accuracy_b = await test_prompts(test_images, variant_b.render())

    return {
        "variant_a": {
            "version": variant_a.version,
            "accuracy": accuracy_a
        },
        "variant_b": {
            "version": variant_b.version,
            "accuracy": accuracy_b
        },
        "improvement": accuracy_b - accuracy_a
    }
```

---

#### 5.6.7 å¯å¤ç”¨æ€§è®¾è®¡

**æœªæ¥æ‰©å±•åœºæ™¯**ï¼š

| æ–°é¡¹ç›® | éœ€è¦æ”¹åŠ¨ | ä¸éœ€è¦æ”¹åŠ¨ |
|--------|---------|----------|
| **ä½œç‰©ç–¾ç—…è¯Šæ–­** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.2 é€‰é¡¹ï¼ˆä½œç‰©ç§ç±»ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€ç‰ˆæœ¬ç®¡ç† |
| **åŠ¨ç‰©ç–¾ç—…è¯†åˆ«** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.0 é€‰é¡¹ï¼ˆåŠ¨ç‰©ç±»åˆ«ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€A/B æµ‹è¯•æµç¨‹ |
| **å·¥ä¸šç¼ºé™·æ£€æµ‹** | çŸ¥è¯†åº“ï¼ˆç¼ºé™·ç±»å‹ï¼‰ã€Q0 è¿‡æ»¤é€»è¾‘ï¼ˆäº§å“ç±»åˆ«ï¼‰ | PROOF Frameworkã€ç»“æ„åŒ–è¾“å‡ºæœºåˆ¶ |

**å¤ç”¨æµç¨‹**ï¼š

1. **ä¿ç•™æç¤ºè¯æ¡†æ¶**ï¼šPROOF Framework + Instructor
2. **ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡**ï¼š
   - ä¿®æ”¹ Q0.2 çš„ `choices`ï¼ˆé€‚é…æ–°çš„åˆ†ç±»ä½“ç³»ï¼‰
   - ä¿®æ”¹çŸ¥è¯†åº“ç»“æ„ï¼ˆDiseaseOntology â†’ DefectOntologyï¼‰
   - ä¿®æ”¹è¯Šæ–­è¯„åˆ†é€»è¾‘ï¼ˆDiagnosisScorerï¼‰
3. **å¤ç”¨åŸºç¡€è®¾æ–½**ï¼š
   - VLMClientï¼ˆFallback æœºåˆ¶ï¼‰
   - ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼ˆCHANGELOG.mdï¼‰
   - A/B æµ‹è¯•æµç¨‹

---

#### 5.6.8 å®æ–½è·¯çº¿å›¾

**Phase 1: PROOF Framework å®ç°ï¼ˆ1-2å¤©ï¼‰**

- [ ] å®ç° `framework.py` åŸºç±»ï¼ˆPROOFPromptã€PromptPurpose ç­‰ï¼‰
- [ ] è¿ç§» Q0.0 - Q0.5 åˆ° PROOF æ¡†æ¶
- [ ] å¯¼å‡º JSON é…ç½®åˆ° `configs/` ç›®å½•
- [ ] å»ºç«‹ CHANGELOG.md

**Phase 2: Instructor é›†æˆï¼ˆ1å¤©ï¼‰**

- [ ] å®‰è£… Instructorï¼š`pip install instructor`ï¼ˆä»… 25KBï¼‰
- [ ] åŒ…è£… VLMClient çš„å„ Providerï¼ˆQwen/ChatGPT/Claudeï¼‰
- [ ] ä¿®æ”¹ `call_with_fallback` æ–¹æ³•ï¼Œä¼ å…¥ `response_model`
- [ ] ç§»é™¤ç°æœ‰çš„ ResponseValidatorï¼ˆInstructor å·²æä¾›ï¼‰

**Phase 3: é›†æˆæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰**

- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆQ0-Q6 å®Œæ•´æµç¨‹ï¼‰
- [ ] å¯¹æ¯”è¿ç§»å‰åçš„å‡†ç¡®ç‡
- [ ] ç›‘æ§é‡è¯•æ¬¡æ•°å’Œå“åº”æ—¶é—´

---

#### 5.6.9 ä¾èµ–ç®¡ç†

**æ–°å¢ä¾èµ–**ï¼š

```toml
# pyproject.toml
[tool.poetry.dependencies]
instructor = "^1.7.0"  # å”¯ä¸€æ–°å¢ä¾èµ–ï¼ˆ25KBï¼Œæ— é¢å¤–ä¾èµ–ï¼‰

# å·²æœ‰ä¾èµ–
pydantic = "^2.0"
fastapi = "^0.100"
```

**ä¾èµ–å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æ–°å¢ä¾èµ– | ä¾èµ–å¤§å° | ç»´æŠ¤æˆæœ¬ |
|------|---------|---------|---------|
| è‡ªç ” ResponseValidator | æ—  | 0 | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ |
| Instructor | instructor | 25KB | âœ… ç¤¾åŒºç»´æŠ¤ |
| Outlines | outlines + torch | ~2GB | ğŸ”´ å¼€æºæ¨¡å‹ä¸“ç”¨ |
| LangChain | langchain + 70+ ä¾èµ– | ~500MB | ğŸ”´ è¿‡åº¦è®¾è®¡ |

**ç»“è®º**ï¼šInstructor æ˜¯æœ€è½»é‡ä¸”æœ€ç¬¦åˆéœ€æ±‚çš„é€‰æ‹©ã€‚

---
