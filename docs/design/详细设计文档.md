# é¡¹ç›®åç§°ï¼šPhytoOracle MVP

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2025-01-11
**ç¼–å†™è€…**: ç³»ç»Ÿæ¶æ„å¸ˆ
**çŠ¶æ€**: è¯„å®¡ä¸­

---

## ç›®å½•ç´¢å¼•

- [1. æ¶æ„æ€»è§ˆ](#1-æ¶æ„æ€»è§ˆ)
  - [1.1 ç³»ç»Ÿæ¶æ„å›¾](#11-ç³»ç»Ÿæ¶æ„å›¾)
  - [1.2 éƒ¨ç½²æ¶æ„å›¾](#12-éƒ¨ç½²æ¶æ„å›¾)
  - [1.3 æ ¸å¿ƒç±»å›¾](#13-æ ¸å¿ƒç±»å›¾)
- [2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜](#2-é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜)
  - [2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)](#21-å•ä¸€èŒè´£åŸåˆ™-srp)
  - [2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)](#22-ä¾èµ–å€’ç½®åŸåˆ™-dip)
  - [2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)](#23-æ¥å£éš”ç¦»åŸåˆ™-isp)
  - [2.4 å±‚æ¬¡éš”ç¦»](#24-å±‚æ¬¡éš”ç¦»)
  - [2.5 å¾ªç¯ä¾èµ–æ£€æµ‹](#25-å¾ªç¯ä¾èµ–æ£€æµ‹)
- [3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰](#3-åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ddd-é£æ ¼)
  - [3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚](#31-é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚)
  - [3.2 èšåˆæ ¹è®¾è®¡](#32-èšåˆæ ¹è®¾è®¡)
  - [3.3 å€¼å¯¹è±¡è®¾è®¡](#33-å€¼å¯¹è±¡è®¾è®¡)
  - [3.4 é¢†åŸŸæœåŠ¡](#34-é¢†åŸŸæœåŠ¡)
- [4. å®Œæ•´ç›®å½•ç»“æ„](#4-å®Œæ•´ç›®å½•ç»“æ„)
- [5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡](#5-æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡)
  - [5.1 è¯Šæ–­æœåŠ¡ (DiagnosisService)](#51-è¯Šæ–­æœåŠ¡-diagnosisservice)
  - [5.2 VLMå®¢æˆ·ç«¯ (VLMClient)](#52-vlmå®¢æˆ·ç«¯-vlmclient)
  - [5.3 æ¨¡ç³ŠåŒ¹é…å¼•æ“ (FuzzyMatcher)](#53-æ¨¡ç³ŠåŒ¹é…å¼•æ“-fuzzymatcher)
  - [5.4 åŠ æƒè¯Šæ–­è¯„åˆ†å™¨ (DiagnosisScorer)](#54-åŠ æƒè¯Šæ–­è¯„åˆ†å™¨-diagnosisscorer)
  - [5.5 çŸ¥è¯†åº“åŠ è½½å™¨ (KnowledgeLoader)](#55-çŸ¥è¯†åº“åŠ è½½å™¨-knowledgeloader)
  - [5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰](#56-æç¤ºè¯å·¥ç¨‹æ¡†æ¶æ ¸å¿ƒåŸºç¡€è®¾æ–½)
    - [5.6.1 é¡¹ç›®æœ¬è´¨å®šä½](#561-é¡¹ç›®æœ¬è´¨å®šä½)
    - [5.6.2 ä¸¤å±‚è§„èŒƒæ€§è®¾è®¡](#562-ä¸¤å±‚è§„èŒƒæ€§è®¾è®¡)
    - [5.6.3 PROOF Frameworkï¼ˆæç¤ºè¯è§„èŒƒæ€§ï¼‰](#563-proof-frameworkæç¤ºè¯è§„èŒƒæ€§)
    - [5.6.4 Instructor é›†æˆï¼ˆè¾“å‡ºè§„èŒƒæ€§ï¼‰](#564-instructor-é›†æˆè¾“å‡ºè§„èŒƒæ€§)
    - [5.6.5 VLM å“åº”æ ¼å¼åè®®ï¼ˆPydantic Modelsï¼‰](#565-vlm-å“åº”æ ¼å¼åè®®pydantic-models)
    - [5.6.6 æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ç­–ç•¥](#566-æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ç­–ç•¥)
    - [5.6.7 å¯å¤ç”¨æ€§è®¾è®¡](#567-å¯å¤ç”¨æ€§è®¾è®¡)
    - [5.6.8 å®æ–½è·¯çº¿å›¾](#568-å®æ–½è·¯çº¿å›¾)
    - [5.6.9 ä¾èµ–ç®¡ç†](#569-ä¾èµ–ç®¡ç†)
- [6. API è®¾è®¡ï¼ˆOpenAPI è§„èŒƒç‰‡æ®µï¼‰](#6-api-è®¾è®¡openapi-è§„èŒƒç‰‡æ®µ)
- [7. æ•°æ®æ¨¡å‹ï¼ˆPydantic V2 å®Œæ•´ä»£ç ï¼‰](#7-æ•°æ®æ¨¡å‹pydantic-v2-å®Œæ•´ä»£ç )
- [8. çŸ¥è¯†æœ¬ä½“è®¾è®¡ï¼ˆJSON Schema + ç¤ºä¾‹ï¼‰](#8-çŸ¥è¯†æœ¬ä½“è®¾è®¡json-schema--ç¤ºä¾‹)
  - [8.1 Disease Ontology Schema](#81-disease-ontology-schema)
  - [8.2 Disease Ontology ç¤ºä¾‹](#82-disease-ontology-ç¤ºä¾‹)
  - [8.3 Feature Ontology Schema](#83-feature-ontology-schema)
  - [8.4 Host-Disease Ontology Schema](#84-host-disease-ontology-schema)
- [9. æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆPostgreSQL DDLï¼‰](#9-æ•°æ®åº“è¡¨è®¾è®¡postgresql-ddl)
  - [9.1 è¡¨ç»“æ„æ€»è§ˆ](#91-è¡¨ç»“æ„æ€»è§ˆ)
  - [9.2 å®Œæ•´DDLè¯­å¥](#92-å®Œæ•´ddlè¯­å¥)
  - [9.3 åˆå§‹åŒ–æ•°æ®è„šæœ¬](#93-åˆå§‹åŒ–æ•°æ®è„šæœ¬)
  - [9.4 æ•°æ®åº“è®¿é—®å±‚æ¥å£ï¼ˆRepositoryæ¨¡å¼ï¼‰](#94-æ•°æ®åº“è®¿é—®å±‚æ¥å£repositoryæ¨¡å¼)
  - [9.5 æ•°æ®åº“è¿æ¥æ± ç®¡ç†](#95-æ•°æ®åº“è¿æ¥æ± ç®¡ç†)
- [10. ç¼“å­˜ä¸ Rate Limit ç­–ç•¥](#10-ç¼“å­˜ä¸-rate-limit-ç­–ç•¥)
  - [10.1 ç¼“å­˜ç­–ç•¥ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰](#101-ç¼“å­˜ç­–ç•¥mvpç®€åŒ–ç‰ˆ)
  - [10.2 Rate Limitç­–ç•¥ï¼ˆMVPä¸å®ç°ï¼‰](#102-rate-limitç­–ç•¥mvpä¸å®ç°)
- [11. å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡](#11-å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡)
  - [11.1 æƒé™æ¨¡å‹ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰](#111-æƒé™æ¨¡å‹mvpç®€åŒ–ç‰ˆ)
  - [11.2 è®¤è¯å®ç°](#112-è®¤è¯å®ç°)
  - [11.3 ç®¡ç†åå°è®¤è¯](#113-ç®¡ç†åå°è®¤è¯)
- [12. æµ‹è¯•ç­–ç•¥](#12-æµ‹è¯•ç­–ç•¥)
  - [12.1 å•å…ƒæµ‹è¯•ç­–ç•¥](#121-å•å…ƒæµ‹è¯•ç­–ç•¥)
  - [12.2 é›†æˆæµ‹è¯•ç­–ç•¥](#122-é›†æˆæµ‹è¯•ç­–ç•¥)
  - [12.3 E2Eæµ‹è¯•ç­–ç•¥](#123-e2eæµ‹è¯•ç­–ç•¥)
- [13. æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼](#13-æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼)
- [14. éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ](#14-éƒ¨ç½²ä¸-cicd-æ–¹æ¡ˆ)
  - [14.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²](#141-å¼€å‘ç¯å¢ƒéƒ¨ç½²)
  - [14.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#142-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
  - [14.3 CI/CDæ–¹æ¡ˆï¼ˆMVPæ‰‹å·¥éƒ¨ç½²ï¼‰](#143-cicdæ–¹æ¡ˆmvpæ‰‹å·¥éƒ¨ç½²)
- [15. æœªæ¥æ‰©å±•ç‚¹æ¸…å•](#15-æœªæ¥æ‰©å±•ç‚¹æ¸…å•)
  - [15.1 åŠŸèƒ½æ‰©å±•ï¼ˆv1.2ï¼‰](#151-åŠŸèƒ½æ‰©å±•v12)
  - [15.2 åŠŸèƒ½æ‰©å±•ï¼ˆv1.3+ï¼‰](#152-åŠŸèƒ½æ‰©å±•v13)
  - [15.3 æŠ€æœ¯å€ºåŠ¡æ¸…ç†](#153-æŠ€æœ¯å€ºåŠ¡æ¸…ç†)
  - [15.4 çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’](#154-çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’)

---

## 1. æ¶æ„æ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    %% å‰ç«¯å±‚
    subgraph Frontend["å‰ç«¯å±‚ (Frontend Layer)"]
        Web["Webè¯Šæ–­ç•Œé¢<br/>(Next.js 15)"]
        Admin["ç®¡ç†åå°<br/>(Streamlit)"]
    end

    %% APIç½‘å…³å±‚
    subgraph Gateway["APIå±‚ (API Gateway)"]
        API["FastAPI Server"]
        Auth["è®¤è¯ä¸­é—´ä»¶<br/>(API Key)"]
    end

    %% ä¸šåŠ¡é€»è¾‘å±‚
    subgraph Business["ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)"]
        DiagService["è¯Šæ–­æœåŠ¡<br/>(Diagnosis Service)"]
        KnowledgeService["çŸ¥è¯†åº“æœåŠ¡<br/>(Knowledge Service)"]
        ImageService["å›¾ç‰‡æœåŠ¡<br/>(Image Service)"]
    end

    %% é¢†åŸŸæ¨¡å‹å±‚
    subgraph Domain["é¢†åŸŸæ¨¡å‹å±‚ (Domain Models)"]
        DM1["Disease Ontology"]
        DM2["Feature Ontology"]
        DM3["Plant Ontology"]
        DM4["Host-Disease Relations"]
    end

    %% åŸºç¡€è®¾æ–½å±‚
    subgraph Infra["åŸºç¡€è®¾æ–½å±‚ (Infrastructure)"]
        PromptFramework["æç¤ºè¯æ¡†æ¶<br/>(PROOF Framework)"]
        VLM["VLMå®¢æˆ·ç«¯<br/>(Instructor + Fallback)"]
        OntologyLoader["çŸ¥è¯†åº“åŠ è½½å™¨<br/>(JSON Loader)"]
        Matcher["æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        Scorer["åŠ æƒè¯„åˆ†å™¨"]
    end

    %% å¤–éƒ¨æœåŠ¡
    subgraph External["å¤–éƒ¨æœåŠ¡ (External Services)"]
        Qwen["Qwen VL Plus"]
        GPT["ChatGPT<br/>gpt-4o"]
        Grok["Grok Vision"]
        Claude["Claude Sonnet"]
    end

    %% æ•°æ®å­˜å‚¨
    subgraph Storage["æ•°æ®å­˜å‚¨ (Storage)"]
        PG[("PostgreSQL<br/>è¯Šæ–­è®°å½•")]
        Redis[("Redis<br/>ç¼“å­˜")]
        FS[("æ–‡ä»¶ç³»ç»Ÿ<br/>å›¾ç‰‡å­˜å‚¨")]
        Git[("Gitä»“åº“<br/>çŸ¥è¯†åº“JSON")]
    end

    %% è¿æ¥å…³ç³»
    Web --> API
    Admin --> API
    API --> Auth
    Auth --> DiagService
    Auth --> KnowledgeService
    Auth --> ImageService

    DiagService --> VLM
    DiagService --> Scorer
    DiagService --> Domain

    KnowledgeService --> OntologyLoader
    KnowledgeService --> Git

    ImageService --> FS

    VLM --> PromptFramework
    VLM --> Qwen
    VLM --> GPT
    VLM --> Grok
    VLM --> Claude

    Scorer --> Matcher
    OntologyLoader --> Git

    DiagService --> PG
    VLM --> Redis
    ImageService --> PG
```

### 1.2 éƒ¨ç½²æ¶æ„å›¾

```mermaid
graph LR
    subgraph Development["å¼€å‘ç¯å¢ƒ"]
        Dev1["åç«¯<br/>python main.py<br/>:8000"]
        Dev2["å‰ç«¯<br/>npm run dev<br/>:3000"]
        Dev3["ç®¡ç†åå°<br/>streamlit run<br/>:8501"]
        Dev4["PostgreSQL<br/>æœ¬åœ°å®‰è£…<br/>:5432"]
        Dev5["Redis<br/>æœ¬åœ°å®‰è£…<br/>:6379"]
    end

    subgraph Production["ç”Ÿäº§ç¯å¢ƒ(äº‘æœåŠ¡å™¨)"]
        Nginx["Nginx<br/>åå‘ä»£ç†<br/>:80/:443"]
        Uvicorn["Uvicorn<br/>å¤šè¿›ç¨‹<br/>:8000-8003"]
        Next["Next.js<br/>Production Build<br/>:3000"]
        StreamlitProd["Streamlit<br/>:8501"]
        PGProd["PostgreSQL<br/>:5432"]
        RedisProd["Redis<br/>:6379"]
    end

    subgraph Users["ç”¨æˆ·è®¿é—®"]
        U1["APIç”¨æˆ·"]
        U2["Webç”¨æˆ·"]
        U3["ç®¡ç†å‘˜"]
    end

    U1 -->|APIè¯·æ±‚| Nginx
    U2 -->|Webè®¿é—®| Nginx
    U3 -->|ç®¡ç†ç•Œé¢| Nginx

    Nginx -->|/api/*| Uvicorn
    Nginx -->|/*| Next
    Nginx -->|/admin/*| StreamlitProd

    Uvicorn --> PGProd
    Uvicorn --> RedisProd
```

### 1.3 æ ¸å¿ƒç±»å›¾

```mermaid
classDiagram
    %% æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
    class PROOFPrompt {
        +question_id: str
        +purpose: PromptPurpose
        +role: PromptRole
        +observation: PromptObservation
        +options: PromptOptions
        +format_spec: PromptFormat
        +version: str
        +render() str
        +to_dict() dict
    }

    class PromptPurpose {
        +task: str
        +context: str
        +why_important: str
    }

    class PromptRole {
        +role: str
        +expertise: List[str]
        +constraints: List[str]
    }

    class PromptObservation {
        +visual_method: str
        +visual_clues: Dict
        +focus_areas: List[str]
    }

    class PromptOptions {
        +choices: List[Choice]
        +allow_unknown: bool
        +allow_uncertain: bool
    }

    class PromptFormat {
        +response_schema: Type[BaseModel]
        +examples: List[Example]
        +constraints: List[str]
    }

    PROOFPrompt --> PromptPurpose
    PROOFPrompt --> PromptRole
    PROOFPrompt --> PromptObservation
    PROOFPrompt --> PromptOptions
    PROOFPrompt --> PromptFormat

    %% VLMæŠ½è±¡å±‚ + Instructoré›†æˆ
    class VLMProvider {
        <<interface>>
        +call(prompt: str, image: bytes) str
        +is_available() bool
        +get_quota() dict
    }

    class QwenProvider {
        +api_key: str
        +base_url: str
        +call(prompt: str, image: bytes) str
    }

    class ChatGPTProvider {
        +api_key: str
        +model: str
        +call(prompt: str, image: bytes) str
    }

    class VLMClient {
        -providers: List[VLMProvider]
        -cache: RedisCache
        +call_with_fallback(prompt: str, image: bytes, response_model: Type[BaseModel]) BaseModel
        +get_current_provider() str
    }

    class Instructor {
        <<library>>
        +from_openai() Client
        +from_anthropic() Client
        +auto_retry: bool
        +max_retries: int
    }

    VLMProvider <|-- QwenProvider
    VLMProvider <|-- ChatGPTProvider
    VLMClient --> VLMProvider
    VLMClient --> Instructor
    VLMClient --> PROOFPrompt

    %% è¯Šæ–­æœåŠ¡
    class DiagnosisService {
        -vlm_client: VLMClient
        -scorer: DiagnosisScorer
        -knowledge_base: KnowledgeBase
        +diagnose(image: bytes) DiagnosisResult
        -extract_features() FeatureVector
        -match_diseases() List[DiseaseMatch]
    }

    class DiagnosisScorer {
        -matcher: FuzzyMatcher
        +calculate_score(features: dict, disease: dict) float
        +apply_weights(scores: dict) float
    }

    class FuzzyMatcher {
        +COLOR_GROUPS: dict
        +SIZE_ORDER: list
        +match_color(observed: str, expected: str) bool
        +match_size(observed: str, expected: str) bool
    }

    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisScorer --> FuzzyMatcher

    %% é¢†åŸŸæ¨¡å‹
    class DiseaseOntology {
        +disease_id: str
        +disease_name: str
        +feature_vector: dict
        +feature_importance: dict
        +diagnosis_rules: dict
    }

    class FeatureVector {
        +content_type: str
        +plant_category: str
        +flower_genus: str
        +organ: str
        +completeness: str
        +has_abnormality: str
        +symptom_type: str
        +additional_features: dict
    }

    DiagnosisService --> DiseaseOntology
    DiagnosisService --> FeatureVector
```

---

## 2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜

### 2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)

æ¯ä¸ªæ¨¡å—ä¸¥æ ¼éµå¾ªå•ä¸€èŒè´£ï¼š

| æ¨¡å— | èŒè´£ | ä¸è´Ÿè´£ |
|-----|------|--------|
| **PromptFramework** | æç¤ºè¯ç»“æ„åŒ–ç¼–å†™ä¸ç‰ˆæœ¬æ§åˆ¶ | VLMè°ƒç”¨ã€å“åº”éªŒè¯ |
| **DiagnosisService** | åè°ƒè¯Šæ–­æµç¨‹ | VLMè°ƒç”¨ç»†èŠ‚ã€è¯„åˆ†ç®—æ³• |
| **VLMClient** | VLMè°ƒç”¨ä¸é™çº§ã€Instructoré›†æˆ | ä¸šåŠ¡é€»è¾‘ã€Promptç”Ÿæˆ |
| **FuzzyMatcher** | æ¨¡ç³ŠåŒ¹é…é€»è¾‘ | æƒé‡è®¡ç®—ã€è¯Šæ–­å†³ç­– |
| **DiagnosisScorer** | åŠ æƒè¯„åˆ†è®¡ç®— | ç‰¹å¾æå–ã€VLMäº¤äº’ |
| **KnowledgeLoader** | JSONåŠ è½½ä¸ç¼“å­˜ | ä¸šåŠ¡éªŒè¯ã€è¯Šæ–­é€»è¾‘ |
| **ImageService** | å›¾ç‰‡å­˜å‚¨ä¸æ£€ç´¢ | è¯Šæ–­é€»è¾‘ã€VLMè°ƒç”¨ |

### 2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

é€šè¿‡ProtocolæŠ½è±¡å®ç°ä¾èµ–å€’ç½®ï¼š

```python
from typing import Protocol

# æŠ½è±¡æ¥å£å®šä¹‰
class VLMProtocol(Protocol):
    async def call(self, prompt: str, image: bytes) -> str: ...
    def is_available(self) -> bool: ...

class CacheProtocol(Protocol):
    async def get(self, key: str) -> Optional[str]: ...
    async def set(self, key: str, value: str, ttl: int) -> None: ...

class RepositoryProtocol(Protocol):
    async def save(self, entity: Any) -> str: ...
    async def find_by_id(self, id: str) -> Optional[Any]: ...

# ä¸šåŠ¡å±‚ä¾èµ–æŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç°
class DiagnosisService:
    def __init__(
        self,
        vlm: VLMProtocol,  # ä¾èµ–æŠ½è±¡
        cache: CacheProtocol,  # ä¾èµ–æŠ½è±¡
        repo: RepositoryProtocol  # ä¾èµ–æŠ½è±¡
    ):
        self.vlm = vlm
        self.cache = cache
        self.repo = repo
```

### 2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)

ç»†ç²’åº¦æ¥å£è®¾è®¡ï¼Œé¿å…èƒ–æ¥å£ï¼š

```python
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šèƒ–æ¥å£
class KnowledgeService:
    def load_diseases(): ...
    def save_disease(): ...
    def delete_disease(): ...
    def load_plants(): ...
    def save_plant(): ...
    def validate_json(): ...
    def export_to_csv(): ...

# âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç»†ç²’åº¦æ¥å£
class DiseaseLoader(Protocol):
    def load_all() -> List[DiseaseOntology]: ...

class DiseaseEditor(Protocol):
    def save(disease: DiseaseOntology) -> None: ...
    def delete(disease_id: str) -> None: ...

class OntologyValidator(Protocol):
    def validate(json_data: dict) -> ValidationResult: ...
```

### 2.4 å±‚æ¬¡éš”ç¦»

ä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„ï¼Œç¦æ­¢è·¨å±‚è°ƒç”¨ï¼š

```
è¡¨ç°å±‚ (Routers)
    â†“ [ä»…é€šè¿‡Schemaä¼ é€’æ•°æ®]
åº”ç”¨å±‚ (Services)
    â†“ [ä»…é€šè¿‡Domain Modeläº¤äº’]
é¢†åŸŸå±‚ (Domain)
    â†“ [ä»…é€šè¿‡Protocolè°ƒç”¨]
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
```

### 2.5 å¾ªç¯ä¾èµ–æ£€æµ‹

ä½¿ç”¨mypyä¸¥æ ¼æ¨¡å¼æ£€æµ‹å¾ªç¯ä¾èµ–ï¼š

```bash
# pyproject.tomlé…ç½®
[tool.mypy]
strict = true
disallow_any_unimported = true
no_implicit_reexport = true
warn_return_any = true

# è¿è¡Œæ£€æµ‹
mypy --strict backend/
```

---

## 3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰

### 3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¡¨ç°å±‚ (Presentation)            â”‚
â”‚   FastAPI Routers / Streamlit UI        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         åº”ç”¨å±‚ (Application)            â”‚
â”‚   DiagnosisService / KnowledgeService   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é¢†åŸŸå±‚ (Domain)                â”‚
â”‚   å®ä½“ / å€¼å¯¹è±¡ / é¢†åŸŸæœåŠ¡ / èšåˆæ ¹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure)        â”‚
â”‚   VLM / Database / Cache / Storage      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 èšåˆæ ¹è®¾è®¡

**è¯Šæ–­èšåˆ (Diagnosis Aggregate)**ï¼š
```python
class DiagnosisAggregate:
    """è¯Šæ–­èšåˆæ ¹"""
    def __init__(self, diagnosis_id: str):
        self.diagnosis_id = diagnosis_id
        self.feature_vector: FeatureVector = None
        self.disease_matches: List[DiseaseMatch] = []
        self.final_diagnosis: DiagnosisResult = None
        self.images: List[ImageEntity] = []

    def add_image(self, image: ImageEntity) -> None:
        """æ·»åŠ è¯Šæ–­å›¾ç‰‡"""
        self.images.append(image)

    def extract_features(self, vlm_responses: dict) -> None:
        """æå–ç‰¹å¾å‘é‡"""
        self.feature_vector = FeatureVector.from_vlm_responses(vlm_responses)

    def match_diseases(self, candidates: List[DiseaseOntology]) -> None:
        """åŒ¹é…å€™é€‰ç–¾ç—…"""
        for disease in candidates:
            score = self._calculate_match_score(disease)
            self.disease_matches.append(DiseaseMatch(disease, score))

    def finalize_diagnosis(self) -> DiagnosisResult:
        """æœ€ç»ˆè¯Šæ–­å†³ç­–"""
        best_match = max(self.disease_matches, key=lambda x: x.score)
        confidence_level = self._determine_confidence_level(best_match.score)
        self.final_diagnosis = DiagnosisResult(
            disease=best_match.disease,
            confidence=best_match.score,
            level=confidence_level
        )
        return self.final_diagnosis
```

**çŸ¥è¯†åº“èšåˆ (KnowledgeBase Aggregate)**ï¼š
```python
class KnowledgeBaseAggregate:
    """çŸ¥è¯†åº“èšåˆæ ¹"""
    def __init__(self):
        self.diseases: Dict[str, DiseaseOntology] = {}
        self.plants: Dict[str, PlantOntology] = {}
        self.features: FeatureOntology = None
        self.host_disease_map: HostDiseaseMap = None
        self.version: str = None

    def load_from_json(self, base_path: str) -> None:
        """ä»JSONåŠ è½½çŸ¥è¯†åº“"""
        pass

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """æ ¹æ®èŠ±å‰å±è·å–å€™é€‰ç–¾ç—…"""
        disease_ids = self.host_disease_map.get_diseases_for_host(genus)
        return [self.diseases[id] for id in disease_ids if id in self.diseases]

    def reload(self) -> None:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“"""
        pass
```

### 3.3 å€¼å¯¹è±¡è®¾è®¡

```python
# å€¼å¯¹è±¡ï¼šä¸å¯å˜ï¼Œé€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰æ€§
@dataclass(frozen=True)
class FeatureVector:
    """ç‰¹å¾å‘é‡å€¼å¯¹è±¡"""
    content_type: str
    plant_category: str
    flower_genus: str
    organ: str
    completeness: str
    has_abnormality: str
    symptom_type: str
    color_center: Optional[str] = None
    location: Optional[str] = None
    size: Optional[str] = None
    distribution: Optional[str] = None

    def to_dict(self) -> dict:
        return asdict(self)

@dataclass(frozen=True)
class DiagnosisScore:
    """è¯Šæ–­åˆ†æ•°å€¼å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å«åŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰"""
    total_score: float
    major_features_score: float
    minor_features_score: float
    optional_features_score: float
    major_matched: int  # æ–°å¢ï¼šä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
    major_total: int    # æ–°å¢ï¼šä¸»è¦ç‰¹å¾æ€»æ•°

    @property
    def confidence_level(self) -> str:
        """
        è¯Šæ–­ç­‰çº§åˆ¤å®šï¼ˆä¸¥æ ¼éµå¾ªåŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰

        è§„åˆ™ï¼ˆéœ€æ±‚æ–‡æ¡£v1.3å®šä¹‰ï¼‰ï¼š
        - confirmed: total_score â‰¥ 0.85 ä¸” major_matched â‰¥ 2/2
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶å¿…é¡»å…¨éƒ¨åŒ¹é…æ‰èƒ½ç¡®è¯Š
        - suspected: 0.60 â‰¤ total_score < 0.85 ä¸” major_matched â‰¥ 1/2
          åŒ»å­¦åŸç†ï¼šè‡³å°‘ä¸€ä¸ªä¸»è¦ç—‡çŠ¶åŒ¹é… + æ¬¡è¦ç—‡çŠ¶æ”¯æŒ
        - unlikely: total_score < 0.60 æˆ– major_matched = 0
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶ä¸åŒ¹é…åˆ™æ’é™¤è¯Šæ–­
        """
        if self.total_score >= 0.85 and self.major_matched >= 2:
            return "confirmed"
        elif self.total_score >= 0.60 and self.major_matched >= 1:
            return "suspected"
        else:
            return "unlikely"

    @property
    def is_diagnosable(self) -> bool:
        """
        æ˜¯å¦å¯è¯Šæ–­ï¼ˆæ’é™¤"å¥åº·"æˆ–"çŸ¥è¯†åº“å¤–ç–¾ç—…"ï¼‰

        è§„åˆ™ï¼š
        - total_score < 0.30: è®¤ä¸ºæ— ç—…æˆ–çŸ¥è¯†åº“å¤–ç–¾ç—…
        - ç”¨äºè§¦å‘VLMå…œåº•ç­–ç•¥æˆ–è¿”å›"æ— æ³•è¯Šæ–­"
        """
        return self.total_score >= 0.30
```

### 3.4 é¢†åŸŸæœåŠ¡

```python
class DomainDiagnosisService:
    """é¢†åŸŸå±‚è¯Šæ–­æœåŠ¡"""

    @staticmethod
    def calculate_weighted_score(
        feature_vector: FeatureVector,
        disease: DiseaseOntology
    ) -> DiagnosisScore:
        """è®¡ç®—åŠ æƒè¯Šæ–­åˆ†æ•°ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰"""
        major_score = 0.0
        minor_score = 0.0
        optional_score = 0.0
        major_matched = 0  # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°
        major_total = 2    # ä¸»è¦ç‰¹å¾æ€»æ•°ï¼ˆsymptom_type + color_centerï¼‰

        # Major Features (æƒé‡0.8)
        if feature_vector.symptom_type == disease.expected_symptom_type:
            major_score += 0.5
            major_matched += 1
        if feature_vector.color_center in disease.expected_colors:
            major_score += 0.3
            major_matched += 1

        # Minor Features (æƒé‡0.15)
        if feature_vector.location == disease.expected_location:
            minor_score += 0.1
        # ... å…¶ä»–æ¬¡è¦ç‰¹å¾

        # Optional Features (æƒé‡0.05)
        # ... å¯é€‰ç‰¹å¾è®¡ç®—

        total = major_score * 0.8 + minor_score * 0.15 + optional_score * 0.05

        return DiagnosisScore(
            total_score=total,
            major_features_score=major_score,
            minor_features_score=minor_score,
            optional_features_score=optional_score,
            major_matched=major_matched,  # æ–°å¢
            major_total=major_total        # æ–°å¢
        )
```

---

## 4. å®Œæ•´ç›®å½•ç»“æ„

```
PhytoOracle/
â”œâ”€â”€ backend/                                 # åç«¯æœåŠ¡ï¼ˆFastAPIï¼‰
â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”œâ”€â”€ api/                            # FastAPI ä¸»åº”ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£ï¼Œé…ç½®CORSã€ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ deps.py                     # ä¾èµ–æ³¨å…¥ï¼šDBè¿æ¥æ± ã€Redisã€VLM Client
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/                    # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # POST /diagnose - è¯Šæ–­æ¥å£
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # GET /diseases, /plants - çŸ¥è¯†åº“æŸ¥è¯¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.py                # POST /reload - çŸ¥è¯†åº“é‡è½½
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # POST /login, /api-keys - è®¤è¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/                    # Pydanticè¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # DiagnosisRequest/Response
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # DiseaseSchema, PlantSchema
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # LoginRequest, ApiKeyResponse
â”‚   â”‚   â”‚   â””â”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â””â”€â”€ auth.py                 # API KeyéªŒè¯ä¸­é—´ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ admin/                          # ç®¡ç†åå°ï¼ˆStreamlitï¼‰
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ app.py                      # Streamlitä¸»å…¥å£
â”‚   â”‚       â”œâ”€â”€ pages/                      # å¤šé¡µé¢åº”ç”¨
â”‚   â”‚       â”‚   â”œâ”€â”€ 1_ğŸŒ¸_ç–¾ç—…ç®¡ç†.py        # ç–¾ç—…CRUDç•Œé¢
â”‚   â”‚       â”‚   â”œâ”€â”€ 2_ğŸ”¬_è¯Šæ–­æµ‹è¯•.py        # ä¸Šä¼ å›¾ç‰‡æµ‹è¯•è¯Šæ–­
â”‚   â”‚       â”‚   â”œâ”€â”€ 3_ğŸ“Š_ç»Ÿè®¡åˆ†æ.py        # å‡†ç¡®ç‡ç»Ÿè®¡
â”‚   â”‚       â”‚   â””â”€â”€ 4_ğŸ”„_çŸ¥è¯†åº“ç‰ˆæœ¬.py      # ç‰ˆæœ¬ç®¡ç†ä¸å›æ»š
â”‚   â”‚       â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”‚           â””â”€â”€ auth.py                 # Streamlitè®¤è¯
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                               # æ ¸å¿ƒé…ç½®ä¸å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                       # Settingsç±»ï¼Œä».envåŠ è½½é…ç½®
â”‚   â”‚   â”œâ”€â”€ security.py                     # API Keyç”Ÿæˆ(secrets)ã€å¯†ç å“ˆå¸Œ(bcrypt)
â”‚   â”‚   â”œâ”€â”€ exceptions.py                   # è‡ªå®šä¹‰å¼‚å¸¸ï¼šDiagnosisError, VLMError
â”‚   â”‚   â””â”€â”€ cache.py                        # Redisç¼“å­˜å°è£…ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                             # DDDé¢†åŸŸæ¨¡å‹ï¼ˆPydantic V2ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis.py                    # DiagnosisAggregate, DiagnosisResult
â”‚   â”‚   â”œâ”€â”€ disease.py                      # DiseaseOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ feature.py                      # FeatureOntology, FeatureVector
â”‚   â”‚   â”œâ”€â”€ plant.py                        # PlantOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ treatment.py                    # TreatmentOntologyï¼ˆv1.3é¢„ç•™ï¼‰
â”‚   â”‚   â””â”€â”€ value_objects.py                # å€¼å¯¹è±¡ï¼šScore, Confidence
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/                     # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py                     # VLMProtocolæŠ½è±¡æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ client.py                   # VLMClientå®ç°Fallbackæœºåˆ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/                  # å…·ä½“Providerå®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ qwen.py                 # QwenVLPlusProvider
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chatgpt.py              # ChatGPTProvider (gpt-4o)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ grok.py                 # GrokVisionProvider
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ claude.py               # ClaudeProvider
â”‚   â”‚   â”‚   â”œâ”€â”€ prompts/                    # VLMæç¤ºè¯æ¨¡æ¿ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q0_screening.py         # Q0.0-Q0.5 è¿‡æ»¤é—®é¢˜æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 ç‰¹å¾æå–æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ fallback.py             # VLMå¼€æ”¾å¼è¯Šæ–­æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CHANGELOG.md            # æç¤ºè¯ç‰ˆæœ¬å˜æ›´è®°å½•
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ versions/               # å†å²ç‰ˆæœ¬å½’æ¡£ï¼ˆA/Bæµ‹è¯•ï¼‰
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ v1.0/
â”‚   â”‚   â”‚   â””â”€â”€ validators.py               # VLMå“åº”éªŒè¯å™¨ï¼ˆJSON Schemaï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ontology/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.py                   # JSONKnowledgeLoader - åŠ è½½JSONçŸ¥è¯†åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ matcher.py                  # FuzzyMatcher - æ¨¡ç³ŠåŒ¹é…COLOR_GROUPS/SIZE_ORDER
â”‚   â”‚   â”‚   â””â”€â”€ scorer.py                   # DiagnosisScorer - åŠ æƒè¯„åˆ†0.8/0.15/0.05
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py                 # create_pool() - asyncpgè¿æ¥æ± 
â”‚   â”‚   â”‚   â”œâ”€â”€ redis_client.py             # RedisCacheç±»å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ repositories/               # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ diagnosis_repo.py       # è¯Šæ–­è®°å½•CRUD (asyncpg)
â”‚   â”‚   â”‚       â”œâ”€â”€ image_repo.py           # å›¾ç‰‡å…ƒæ•°æ®CRUD
â”‚   â”‚   â”‚       â””â”€â”€ apikey_repo.py          # API Keyç®¡ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ storage/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ local_storage.py            # LocalImageStorage - æŒ‰åˆ†ç±»å­˜å‚¨å›¾ç‰‡
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                           # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåº”ç”¨æœåŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis_service.py            # æ ¸å¿ƒè¯Šæ–­æµç¨‹ç¼–æ’
â”‚   â”‚   â”œâ”€â”€ knowledge_service.py            # çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ image_service.py                # å›¾ç‰‡ä¿å­˜ã€åˆ†ç±»ã€å…ƒæ•°æ®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ tests/                              # æµ‹è¯•ç›®å½•
â”‚   â”‚   â”œâ”€â”€ conftest.py                     # Pytest fixtures
â”‚   â”‚   â”œâ”€â”€ unit/                           # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_matcher.py             # æµ‹è¯•COLOR_GROUPSæ¨¡ç³ŠåŒ¹é…
â”‚   â”‚   â”‚   â”œâ”€â”€ test_scorer.py              # æµ‹è¯•åŠ æƒè¯„åˆ†ç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ test_vlm_client.py          # æµ‹è¯•VLM Fallbackæœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ integration/                    # é›†æˆæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_diagnosis_api.py       # æµ‹è¯•å®Œæ•´è¯Šæ–­APIæµç¨‹
â”‚   â”‚   â”‚   â””â”€â”€ test_knowledge_reload.py    # æµ‹è¯•çŸ¥è¯†åº“çƒ­æ›´æ–°
â”‚   â”‚   â””â”€â”€ e2e/                            # ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆPlaywrightï¼‰
â”‚   â”‚       â””â”€â”€ test_diagnosis_flow.py      # æµ‹è¯•Webç•Œé¢å®Œæ•´æµç¨‹
â”‚   â”‚
â”‚   â”œâ”€â”€ knowledge_base/                     # çŸ¥è¯†åº“JSONæ–‡ä»¶ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ diseases/                       # ç–¾ç—…æœ¬ä½“JSON
â”‚   â”‚   â”‚   â”œâ”€â”€ rose_black_spot.json        # ç«ç‘°é»‘æ–‘ç—…
â”‚   â”‚   â”‚   â”œâ”€â”€ cherry_powdery_mildew.json  # æ¨±èŠ±ç™½ç²‰ç—…
â”‚   â”‚   â”‚   â””â”€â”€ ...                         # å…¶ä»–18-24ç§ç–¾ç—…
â”‚   â”‚   â”œâ”€â”€ features/                       # ç‰¹å¾æœ¬ä½“
â”‚   â”‚   â”‚   â””â”€â”€ feature_ontology.json       # ç‰¹å¾å®šä¹‰ä¸æ¨¡ç³ŠåŒ¹é…è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ plants/                         # æ¤ç‰©æœ¬ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ rosa.json                   # ç«ç‘°å±
â”‚   â”‚   â”‚   â”œâ”€â”€ prunus.json                 # æ¨±èŠ±å±
â”‚   â”‚   â”‚   â”œâ”€â”€ tulipa.json                 # éƒé‡‘é¦™å±
â”‚   â”‚   â”‚   â”œâ”€â”€ dianthus.json               # åº·ä¹ƒé¦¨å±
â”‚   â”‚   â”‚   â””â”€â”€ paeonia.json                # ç‰¡ä¸¹å±
â”‚   â”‚   â”œâ”€â”€ host_disease/                   # å®¿ä¸»-ç–¾ç—…å…³ç³»
â”‚   â”‚   â”‚   â””â”€â”€ associations.json           # èŠ±å‰ä¸ç–¾ç—…æ˜ å°„å…³ç³»
â”‚   â”‚   â””â”€â”€ treatments/                     # æ²»ç–—æ–¹æ¡ˆï¼ˆv1.3+é¢„ç•™ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                            # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ unlabeled/                  # æœªæ ‡æ³¨å›¾ç‰‡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rose/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ 2025-01/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cherry/
â”‚   â”‚   â”‚   â”œâ”€â”€ correct/                    # è¯Šæ–­æ­£ç¡®
â”‚   â”‚   â”‚   â””â”€â”€ incorrect/                  # è¯Šæ–­é”™è¯¯
â”‚   â”‚   â””â”€â”€ metadata/                       # å›¾ç‰‡å…ƒæ•°æ®JSONç¼“å­˜
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/                            # è¿ç»´è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ init_db.sql                     # åˆ›å»ºè¡¨ç»“æ„SQLè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ seed_apikeys.py                 # ç”Ÿæˆæµ‹è¯•ç”¨API Key
â”‚   â”‚   â””â”€â”€ validate_ontology.py            # JSON Schemaæ ¡éªŒè„šæœ¬
â”‚   â”‚
â”‚   â”œâ”€â”€ pyproject.toml                      # Poetryä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ .env.example                        # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â”œâ”€â”€ .gitignore
â”‚   â””â”€â”€ README.md                           # åç«¯éƒ¨ç½²è¯´æ˜
â”‚
â”œâ”€â”€ frontend/                               # å‰ç«¯ï¼ˆNext.js 15ï¼‰
â”‚   â”œâ”€â”€ app/                                # App Router
â”‚   â”‚   â”œâ”€â”€ layout.tsx                      # æ ¹å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ page.tsx                        # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ diagnose/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                    # è¯Šæ–­é¡µé¢
â”‚   â”‚   â”œâ”€â”€ history/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                    # å†å²è®°å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                    # ç™»å½•é¡µé¢
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â””â”€â”€ [...].ts                    # APIä»£ç†ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ components/                         # Reactç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/                             # Shadcn UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ImageUploader.tsx               # å›¾ç‰‡ä¸Šä¼ ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DiagnosisResult.tsx             # è¯Šæ–­ç»“æœå±•ç¤º
â”‚   â”‚   â””â”€â”€ FeatureDisplay.tsx              # ç‰¹å¾å‘é‡å¯è§†åŒ–
â”‚   â”œâ”€â”€ lib/                                # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ api.ts                          # APIè°ƒç”¨å°è£…
â”‚   â”‚   â””â”€â”€ utils.ts                        # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ public/                             # é™æ€èµ„æº
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ next.config.js
â”‚   â”œâ”€â”€ tailwind.config.js
â”‚   â””â”€â”€ tsconfig.json
â”‚
â””â”€â”€ docs/                                   # é¡¹ç›®æ–‡æ¡£
    â”œâ”€â”€ requirements/                       # éœ€æ±‚æ–‡æ¡£
    â”‚   â””â”€â”€ éœ€æ±‚æ–‡æ¡£.md
    â”œâ”€â”€ design/                             # è¯¦ç»†è®¾è®¡æ–‡æ¡£
    â”‚   â””â”€â”€ è¯¦ç»†è®¾è®¡æ–‡æ¡£.md                  # æœ¬æ–‡æ¡£
    â”œâ”€â”€ methodology/                        # æ–¹æ³•è®ºæ–‡æ¡£
    â”‚   â””â”€â”€ æ–¹æ³•è®ºv4.0å®Œæ•´æ–‡æ¡£.md
    â””â”€â”€ api/                                # APIæ–‡æ¡£
        â””â”€â”€ openapi.yaml                    # OpenAPI 3.0è§„èŒƒ
```

---

## 5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡

> **è®¾è®¡è¯´æ˜**ï¼šæœ¬ç« æ˜ç¡®åŒºåˆ†**åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰**å’Œ**åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰**ï¼Œå¹¶é˜æ˜å½¼æ­¤çš„è°ƒç”¨å…³ç³»ã€‚ç²’åº¦å¯ç²—ä½†ä¸èƒ½ç¼ºã€‚

---

### 5.1 æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ

#### 5.1.1 åˆ†å±‚æ¶æ„å›¾

```mermaid
graph TB
    subgraph API["APIå±‚ (FastAPI)"]
        DiagnosisRouter["DiagnosisRouter<br/>è¯Šæ–­è·¯ç”±"]
        KnowledgeRouter["KnowledgeRouter<br/>çŸ¥è¯†åº“è·¯ç”±"]
    end

    subgraph Services["åº”ç”¨æœåŠ¡å±‚ (Application Services)"]
        DiagnosisService["DiagnosisService<br/>è¯Šæ–­æœåŠ¡"]
        KnowledgeService["KnowledgeService<br/>çŸ¥è¯†åº“æœåŠ¡"]
        ImageService["ImageService<br/>å›¾ç‰‡æœåŠ¡"]
    end

    subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ (Infrastructure Modules)"]
        VLMClient["VLMClient<br/>VLMå®¢æˆ·ç«¯"]
        KnowledgeLoader["KnowledgeLoader<br/>çŸ¥è¯†åº“åŠ è½½å™¨"]
        DiagnosisScorer["DiagnosisScorer<br/>åŠ æƒè¯Šæ–­è¯„åˆ†å™¨"]
        FuzzyMatcher["FuzzyMatcher<br/>æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        PROOFFramework["PROOF Framework<br/>æç¤ºè¯æ¡†æ¶"]
        LocalImageStorage["LocalImageStorage<br/>æœ¬åœ°å›¾ç‰‡å­˜å‚¨"]
    end

    subgraph Persistence["æŒä¹…åŒ–å±‚"]
        PostgreSQL["PostgreSQL<br/>æ•°æ®åº“"]
        Redis["Redis<br/>ç¼“å­˜"]
        FileSystem["FileSystem<br/>æ–‡ä»¶ç³»ç»Ÿ"]
    end

    %% APIè°ƒç”¨æœåŠ¡
    DiagnosisRouter --> DiagnosisService
    KnowledgeRouter --> KnowledgeService

    %% æœåŠ¡è°ƒç”¨æ¨¡å—
    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisService --> ImageService
    DiagnosisService --> KnowledgeService

    KnowledgeService --> KnowledgeLoader

    ImageService --> LocalImageStorage
    ImageService --> PostgreSQL

    %% æ¨¡å—é—´è°ƒç”¨
    VLMClient --> PROOFFramework
    VLMClient --> Redis
    DiagnosisScorer --> FuzzyMatcher
    KnowledgeLoader --> FileSystem
    LocalImageStorage --> FileSystem
```

#### 5.1.2 è°ƒç”¨å…³ç³»çŸ©é˜µ

| è°ƒç”¨è€… \ è¢«è°ƒç”¨è€… | DiagnosisService | VLMClient | DiagnosisScorer | KnowledgeLoader | FuzzyMatcher | PROOF Framework |
|-------------------|------------------|-----------|-----------------|-----------------|--------------|-----------------|
| **DiagnosisRouter** | âœ“ | - | - | - | - | - |
| **DiagnosisService** | - | âœ“ | âœ“ | - | - | - |
| **VLMClient** | - | - | - | - | - | âœ“ |
| **DiagnosisScorer** | - | - | - | - | âœ“ | - |

**è¯´æ˜**ï¼š
- âœ“ è¡¨ç¤ºè°ƒç”¨å…³ç³»
- åº”ç”¨æœåŠ¡å±‚ä¸èƒ½ç›´æ¥ä¾èµ–æŒä¹…åŒ–å±‚ï¼ˆå¿…é¡»é€šè¿‡Repositoryæ¨¡å¼ï¼‰
- åŸºç¡€è®¾æ–½æ¨¡å—ä¹‹é—´å¯ä»¥ç›¸äº’è°ƒç”¨ï¼ˆä½†è¦é¿å…å¾ªç¯ä¾èµ–ï¼‰

---

### 5.2 åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰

> **èŒè´£**ï¼šç¼–æ’ä¸šåŠ¡æµç¨‹ï¼Œè°ƒç”¨å¤šä¸ªåŸºç¡€è®¾æ–½æ¨¡å—ååŒå·¥ä½œï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œæµç¨‹æ§åˆ¶ã€‚

---

#### 5.2.1 DiagnosisServiceï¼ˆè¯Šæ–­æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/diagnosis_service.py`

**èŒè´£**ï¼š
- ç¼–æ’å®Œæ•´è¯Šæ–­æµç¨‹ï¼ˆQ0-Q6é—®è¯Šåºåˆ— + ä¸‰å±‚æ¸è¿›è¯Šæ–­ï¼‰
- åè°ƒVLMå®¢æˆ·ç«¯ã€çŸ¥è¯†åº“æœåŠ¡ã€è¯„åˆ†å™¨ã€å›¾ç‰‡æœåŠ¡
- å®ç°å…œåº•é€»è¾‘ï¼ˆçŸ¥è¯†åº“å¤–ç–¾ç—…ã€VLMå¤±è´¥ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `VLMClient`ï¼šè°ƒç”¨VLMè¿›è¡Œç‰¹å¾æå–
- `KnowledgeService`ï¼šè·å–å€™é€‰ç–¾ç—…åˆ—è¡¨
- `DiagnosisScorer`ï¼šè®¡ç®—è¯Šæ–­è¯„åˆ†
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡
- `DiagnosisRepository`ï¼šä¿å­˜è¯Šæ–­è®°å½•

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisRouter`ï¼ˆFastAPIè·¯ç”±ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisService:
    """æ ¸å¿ƒè¯Šæ–­æœåŠ¡ - ç¼–æ’è¯Šæ–­æµç¨‹"""

    def __init__(
        self,
        vlm_client: VLMClient,
        knowledge_service: KnowledgeService,
        scorer: DiagnosisScorer,
        diagnosis_repo: DiagnosisRepository,
        image_service: ImageService
    ):
        self.vlm_client = vlm_client
        self.knowledge_service = knowledge_service
        self.scorer = scorer
        self.diagnosis_repo = diagnosis_repo
        self.image_service = image_service

    async def diagnose(self, image_bytes: bytes, metadata: dict = None) -> DiagnosisResult:
        """
        æ‰§è¡Œå®Œæ•´è¯Šæ–­æµç¨‹

        æµç¨‹ï¼š
        1. ä¿å­˜å›¾ç‰‡
        2. Q0é€çº§è¿‡æ»¤ï¼ˆQ0.0-Q0.5ï¼‰
        3. Q1-Q6åŠ¨æ€ç‰¹å¾æå–
        4. æ„å»ºç‰¹å¾å‘é‡
        5. è·å–å€™é€‰ç–¾ç—…ï¼ˆåŸºäºç§å±ï¼‰
        6. ç–¾ç—…åŒ¹é…ä¸è¯„åˆ†
        7. ç½®ä¿¡åº¦åˆ†å±‚å†³ç­–ï¼ˆconfirmed/suspected/å…œåº•ï¼‰
        8. ä¿å­˜è¯Šæ–­è®°å½•
        """
        pass

    async def _execute_q0_sequence(self, image_bytes: bytes) -> dict:
        """æ‰§è¡ŒQ0é€çº§è¿‡æ»¤ï¼ˆè°ƒç”¨VLMClient 6æ¬¡ï¼‰"""
        pass

    async def _execute_q1_q6_sequence(self, image_bytes: bytes, symptom_type: str) -> dict:
        """æ‰§è¡ŒQ1-Q6åŠ¨æ€ç‰¹å¾æå–ï¼ˆæ ¹æ®symptom_typeåŠ¨æ€ç”Ÿæˆé—®é¢˜ï¼‰"""
        pass

    async def _vlm_open_ended_diagnosis(self, image_bytes: bytes) -> str:
        """VLMå¼€æ”¾å¼è¯Šæ–­ï¼ˆå…œåº•ç­–ç•¥ï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisRouter.diagnose()
  â†’ DiagnosisService.diagnose()
      â†’ ImageService.save_image()           # ä¿å­˜å›¾ç‰‡
      â†’ VLMClient.call_with_fallback()       # Q0.0å†…å®¹ç±»å‹è¯†åˆ«
      â†’ VLMClient.call_with_fallback()       # Q0.1æ¤ç‰©ç±»åˆ«è¯†åˆ«
      â†’ ...                                  # Q0.2-Q0.5
      â†’ VLMClient.call_with_fallback()       # Q1-Q6ç‰¹å¾æå–
      â†’ KnowledgeService.get_diseases_by_genus()  # è·å–å€™é€‰ç–¾ç—…
      â†’ DiagnosisScorer.calculate_score()    # è®¡ç®—è¯„åˆ†
      â†’ DiagnosisRepository.save()           # ä¿å­˜è¯Šæ–­è®°å½•
```

---

#### 5.2.2 KnowledgeServiceï¼ˆçŸ¥è¯†åº“æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/knowledge_service.py`

**èŒè´£**ï¼š
- çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
- æä¾›ç–¾ç—…åˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰èŠ±å‰å±ç­›é€‰ï¼‰
- ç®¡ç†çŸ¥è¯†åº“ç‰ˆæœ¬

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `KnowledgeLoader`ï¼šåŠ è½½JSONçŸ¥è¯†åº“

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šæŸ¥è¯¢å€™é€‰ç–¾ç—…
- `KnowledgeRouter`ï¼šç®¡ç†åå°æŸ¥è¯¢ç–¾ç—…åˆ—è¡¨

**å…³é”®æ¥å£**ï¼š

```python
class KnowledgeService:
    """çŸ¥è¯†åº“æœåŠ¡"""

    def __init__(self, loader: KnowledgeLoader):
        self.loader = loader
        self.knowledge_base: Optional[KnowledgeBaseAggregate] = None

    async def initialize(self):
        """ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½çŸ¥è¯†åº“"""
        self.knowledge_base = await self.loader.load_all()

    async def reload(self):
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆç®¡ç†åå°è°ƒç”¨ï¼‰"""
        self.knowledge_base = await self.loader.reload()

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """è·å–æŒ‡å®šèŠ±å‰å±çš„ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_all_diseases(self) -> List[DiseaseOntology]:
        """è·å–æ‰€æœ‰ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_disease_by_id(self, disease_id: str) -> Optional[DiseaseOntology]:
        """æ ¹æ®IDè·å–ç–¾ç—…è¯¦æƒ…"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeRouter.reload()
  â†’ KnowledgeService.reload()
      â†’ KnowledgeLoader.reload()  # é‡æ–°åŠ è½½JSONæ–‡ä»¶
```

---

#### 5.2.3 ImageServiceï¼ˆå›¾ç‰‡æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/image_service.py`

**èŒè´£**ï¼š
- å›¾ç‰‡ä¿å­˜ï¼ˆæŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»ï¼‰
- å›¾ç‰‡å…ƒæ•°æ®ç®¡ç†
- å‡†ç¡®æ€§æ ‡æ³¨

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `LocalImageStorage`ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨
- `ImageRepository`ï¼šå›¾ç‰‡å…ƒæ•°æ®æŒä¹…åŒ–

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šä¿å­˜è¯Šæ–­å›¾ç‰‡
- `AdminRouter`ï¼šå‡†ç¡®æ€§æ ‡æ³¨

**å…³é”®æ¥å£**ï¼š

```python
class ImageService:
    """å›¾ç‰‡æœåŠ¡"""

    def __init__(
        self,
        storage: LocalImageStorage,
        image_repo: ImageRepository
    ):
        self.storage = storage
        self.image_repo = image_repo

    async def save_image(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        organ: str
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„ï¼šstorage/images/unlabeled/{genus}/{year-month}/{day}/{diagnosis_id}_{disease_id}.jpg
        """
        pass

    async def update_accuracy_label(
        self,
        image_id: str,
        label: str  # "correct" / "incorrect"
    ):
        """æ›´æ–°å‡†ç¡®æ€§æ ‡ç­¾ï¼ˆç§»åŠ¨æ–‡ä»¶åˆ°correct/incorrectæ–‡ä»¶å¤¹ï¼‰"""
        pass

    async def query_images(
        self,
        genus: Optional[str] = None,
        accuracy_label: Optional[str] = None,
        date_range: Optional[tuple] = None
    ) -> List[ImageMetadata]:
        """æŸ¥è¯¢å›¾ç‰‡ï¼ˆæŒ‰èŠ±å‰å±ã€å‡†ç¡®æ€§ã€æ—¥æœŸèŒƒå›´ï¼‰"""
        pass
```

---

### 5.3 åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰

> **èŒè´£**ï¼šæä¾›æŠ€æœ¯èƒ½åŠ›ï¼ˆVLMè°ƒç”¨ã€æ•°æ®åº“è®¿é—®ã€ç®—æ³•å®ç°ï¼‰ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼Œå¯ç‹¬ç«‹æµ‹è¯•ã€‚

---

#### 5.3.1 VLMClientï¼ˆVLMå®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/client.py`

**èŒè´£**ï¼š
- VLM APIè°ƒç”¨ï¼ˆåŒ…è£…å¤šä¸ªProviderï¼‰
- Fallbackæœºåˆ¶ï¼ˆQwen â†’ ChatGPT â†’ Grok â†’ Claudeï¼‰
- ç¼“å­˜æœºåˆ¶ï¼ˆRedisï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
- é›†æˆInstructorï¼ˆè‡ªåŠ¨éªŒè¯Pydanticæ¨¡å‹ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `PROOFFramework`ï¼šè·å–æ¸²æŸ“åçš„æç¤ºè¯
- `RedisCache`ï¼šç¼“å­˜VLMå“åº”
- `VLM Providers`ï¼šå…·ä½“Providerå®ç°ï¼ˆQwenProvider, ChatGPTProviderç­‰ï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šQ0-Q6é—®è¯Šè°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class VLMClient:
    """VLMå®¢æˆ·ç«¯ - å®ç°Fallbackæœºåˆ¶ + Instructoré›†æˆ"""

    def __init__(self, providers: List[VLMProvider], cache: RedisCache):
        self.providers = providers  # æŒ‰ä¼˜å…ˆçº§æ’åºï¼šQwen, ChatGPT, Grok, Claude
        self.cache = cache

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],  # Pydanticæ¨¡å‹ï¼Œå¦‚Q00Response
        question_id: str = None
    ) -> BaseModel:
        """
        å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯

        æµç¨‹ï¼š
        1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº†question_idï¼‰
        2. ä¾æ¬¡å°è¯•å„Providerï¼ˆInstructorè‡ªåŠ¨éªŒè¯ + é‡è¯•3æ¬¡ï¼‰
        3. ç¼“å­˜ç»“æœï¼ˆttl=7å¤©ï¼‰
        4. æ‰€æœ‰Providerå¤±è´¥ â†’ æŠ›å‡ºVLMError
        """
        pass

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®ï¼švlm:{image_hash}:{question_id}"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService._execute_q0_sequence()
  â†’ VLMClient.call_with_fallback(prompt=Q0_0_PROMPT, response_model=Q00Response)
      â†’ RedisCache.get()                    # å°è¯•ç¼“å­˜
      â†’ QwenVLProvider.call()               # è°ƒç”¨Qwen VL Plus
          â†’ Instructor.chat.completions.create()  # Instructorè‡ªåŠ¨éªŒè¯
      â†’ RedisCache.set()                    # ç¼“å­˜ç»“æœ
```

---

#### 5.3.2 FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/matcher.py`

**èŒè´£**ï¼š
- é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆCOLOR_GROUPSåŒè‰²ç³»åŒ¹é…ï¼‰
- å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆSIZE_ORDERå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰
- ä½ç½®æ¨¡ç³ŠåŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼åŒ¹é…ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisScorer`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class FuzzyMatcher:
    """æ¨¡ç³ŠåŒ¹é…å¼•æ“ - å¤„ç†VLMè§‚å¯Ÿè¯¯å·®"""

    COLOR_GROUPS = {
        "é»‘è¤è‰²ç³»": ["black", "dark_brown", "brown", "dark"],
        "é»„è‰²ç³»": ["yellow", "light_yellow", "yellowish_green", "pale_yellow"],
        "ç™½è‰²ç³»": ["white", "gray_white", "off_white", "cream"],
        # ...
    }

    SIZE_ORDER = ["pinpoint", "small", "medium_small", "medium", "large"]

    def match_color(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆç²¾ç¡®åŒ¹é… + åŒè‰²ç³»åŒ¹é…ï¼‰"""
        pass

    def match_size(self, observed: str, expected: str) -> bool:
        """å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰"""
        pass

    def match_location(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """ä½ç½®åŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼ï¼‰"""
        pass
```

---

#### 5.3.3 DiagnosisScorerï¼ˆåŠ æƒè¯Šæ–­è¯„åˆ†å™¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/scorer.py`

**èŒè´£**ï¼š
- å®ç°åŠ æƒè¯Šæ–­è¯„åˆ†ç®—æ³•
- ä¸»è¦ç‰¹å¾æƒé‡0.8ï¼ˆsymptom_type: 0.5 + color_center: 0.3ï¼‰
- æ¬¡è¦ç‰¹å¾æƒé‡0.15ã€å¯é€‰ç‰¹å¾æƒé‡0.05
- å®Œæ•´æ€§ä¿®æ­£ç³»æ•°ï¼ˆcomplete: 1.0, partial: 0.8, close_up: 0.6ï¼‰
- è¯Šæ–­è§„åˆ™åˆ¤å®šï¼ˆconfirmed/suspected/unlikelyï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `FuzzyMatcher`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šç–¾ç—…åŒ¹é…ä¸è¯„åˆ†æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisScorer:
    """åŠ æƒè¯Šæ–­è¯„åˆ†å™¨ - æ ¸å¿ƒè¯Šæ–­ç®—æ³•"""

    def __init__(self, matcher: FuzzyMatcher):
        self.matcher = matcher

    def calculate_score(
        self,
        observed_features: dict,      # ç‰¹å¾å‘é‡ï¼ˆä»VLMæå–ï¼‰
        disease_definition: dict      # ç–¾ç—…å®šä¹‰ï¼ˆä»çŸ¥è¯†åº“ï¼‰
    ) -> DiagnosisScore:
        """
        è®¡ç®—è¯Šæ–­åˆ†æ•°

        æµç¨‹ï¼š
        1. è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†ï¼ˆè°ƒç”¨FuzzyMatcheråŒ¹é…ï¼‰
        2. è®¡ç®—æ¬¡è¦ç‰¹å¾å¾—åˆ†
        3. è®¡ç®—å¯é€‰ç‰¹å¾å¾—åˆ†
        4. åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
        5. ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰
        6. è¿”å›DiagnosisScoreå¯¹è±¡

        è¿”å›ï¼šDiagnosisScore(
            total_score,
            major_features_score,
            minor_features_score,
            optional_features_score,
            major_matched,   # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
            major_total      # ä¸»è¦ç‰¹å¾æ€»æ•°
        )
        """
        pass

    def _calculate_major_score(self, observed: dict, major_config: dict) -> float:
        """è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†"""
        pass

    def _count_major_matched(self, observed: dict, major_config: dict) -> int:
        """ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService.diagnose()
  â†’ DiagnosisScorer.calculate_score(feature_vector, disease)
      â†’ _calculate_major_score()
          â†’ FuzzyMatcher.match_color()     # é¢œè‰²åŒ¹é…
          â†’ FuzzyMatcher.match_size()      # å°ºå¯¸åŒ¹é…
      â†’ _calculate_minor_score()
      â†’ _calculate_optional_score()
      â†’ åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
      â†’ è¿”å›DiagnosisScore
```

---

#### 5.3.4 KnowledgeLoaderï¼ˆçŸ¥è¯†åº“åŠ è½½å™¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/loader.py`

**èŒè´£**ï¼š
- åŠ è½½JSONçŸ¥è¯†åº“æ–‡ä»¶ï¼ˆç–¾ç—…ã€æ¤ç‰©ã€ç‰¹å¾ã€å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼‰
- è§£æJSON â†’ Pydanticå¯¹è±¡ï¼ˆç±»å‹å®‰å…¨ï¼‰
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆreloadæ–¹æ³•ï¼‰
- è®°å½•çŸ¥è¯†åº“ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥è¯»å–æ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `KnowledgeService`ï¼šåˆå§‹åŒ–å’Œé‡è½½æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class JSONKnowledgeLoader:
    """JSONçŸ¥è¯†åº“åŠ è½½å™¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # knowledge_base/
        self._cache = {}

    async def load_all(self) -> KnowledgeBaseAggregate:
        """
        åŠ è½½å®Œæ•´çŸ¥è¯†åº“

        æµç¨‹ï¼š
        1. åŠ è½½ç–¾ç—…æœ¬ä½“ï¼ˆknowledge_base/diseases/*.jsonï¼‰
        2. åŠ è½½æ¤ç‰©æœ¬ä½“ï¼ˆknowledge_base/plants/*.jsonï¼‰
        3. åŠ è½½ç‰¹å¾æœ¬ä½“ï¼ˆknowledge_base/features/feature_ontology.jsonï¼‰
        4. åŠ è½½å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼ˆknowledge_base/host_disease/associations.jsonï¼‰
        5. è®°å½•ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰
        6. è¿”å›KnowledgeBaseAggregateå¯¹è±¡
        """
        pass

    async def reload(self) -> KnowledgeBaseAggregate:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆæ¸…é™¤ç¼“å­˜ + é‡æ–°åŠ è½½ï¼‰"""
        pass

    def _get_git_commit_hash(self) -> str:
        """è·å–å½“å‰Git commit hashä½œä¸ºç‰ˆæœ¬å·"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeService.initialize()
  â†’ KnowledgeLoader.load_all()
      â†’ è¯»å–knowledge_base/diseases/*.json
      â†’ JSONè§£æä¸ºDiseaseOntologyå¯¹è±¡
      â†’ è¯»å–knowledge_base/plants/*.json
      â†’ JSONè§£æä¸ºPlantOntologyå¯¹è±¡
      â†’ è¿”å›KnowledgeBaseAggregate
```

---

#### 5.3.5 PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/prompts/framework.py`

**èŒè´£**ï¼š
- æä¾›PROOFæ¡†æ¶ï¼ˆPurpose + Role + Observation + Options + Formatï¼‰
- ç»“æ„åŒ–æç¤ºè¯ç¼–å†™ï¼ˆç»Ÿä¸€5å¤§ç»„ä»¶ï¼‰
- æ”¯æŒå‚æ•°åŒ–å’ŒA/Bæµ‹è¯•
- å¯¼å‡ºJSONé…ç½®ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
- èå…¥æ–¹æ³•è®ºv5.0è§†è§‰åŒ–æ–¹æ³•

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `VLMClient`ï¼šæ¸²æŸ“æç¤ºè¯æ—¶è°ƒç”¨
- æç¤ºè¯å®šä¹‰æ–‡ä»¶ï¼ˆ`q0_0_content.py`, `q0_1_category.py`ç­‰ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        """
        åˆå§‹åŒ–PROOFæç¤ºè¯

        å‚æ•°ï¼š
        - question_id: é—®é¢˜IDï¼ˆå¦‚"Q0.0"ï¼‰
        - purpose: æç¤ºè¯ç›®çš„ï¼ˆtask + context + why_importantï¼‰
        - role: æç¤ºè¯è§’è‰²ï¼ˆrole + expertise + constraintsï¼‰
        - observation: è§‚å¯ŸæŒ‡å¯¼ï¼ˆvisual_method + visual_clues + focus_areasï¼‰
        - options: æç¤ºè¯é€‰é¡¹ï¼ˆchoices + allow_unknownï¼‰
        - format_spec: è¾“å‡ºæ ¼å¼ï¼ˆresponse_schema + examplesï¼‰
        - version: æç¤ºè¯ç‰ˆæœ¬å·
        """
        pass

    def render(self) -> str:
        """
        æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²

        æµç¨‹ï¼š
        1. æ¸²æŸ“Roleéƒ¨åˆ†
        2. æ¸²æŸ“Purposeéƒ¨åˆ†
        3. æ¸²æŸ“Observationéƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
        4. æ¸²æŸ“Optionséƒ¨åˆ†
        5. æ¸²æŸ“Formatéƒ¨åˆ†ï¼ˆFew-shotç¤ºä¾‹ + å“åº”æ ¼å¼ï¼‰
        6. æ¸²æŸ“Constraints
        7. è¿”å›å®Œæ•´æç¤ºè¯å­—ç¬¦ä¸²
        """
        pass

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        pass
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# infrastructure/llm/prompts/q0_2_genus.py
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            # ...
        }
    ),
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            # ...
        ],
        allow_unknown=True
    ),
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[...]
    ),
    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()
```

---

#### 5.3.6 LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/storage/local_storage.py`

**èŒè´£**ï¼š
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå›¾ç‰‡å­˜å‚¨
- æŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»å­˜å‚¨
- æ–‡ä»¶è·¯å¾„ç”Ÿæˆï¼ˆè§„èŒƒåŒ–ï¼‰
- æ–‡ä»¶ç§»åŠ¨ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡å’Œç§»åŠ¨æ–‡ä»¶æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class LocalImageStorage:
    """æœ¬åœ°å›¾ç‰‡å­˜å‚¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # storage/images/

    async def save(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str = "unlabeled"  # unlabeled / correct / incorrect
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„è§„èŒƒï¼š
        storage/images/{accuracy_label}/{genus}/{year-month}/{day}/{diagnosis_id}.jpg

        ç¤ºä¾‹ï¼š
        storage/images/unlabeled/rosa/2025-11/10/diag_20251110_001.jpg
        """
        pass

    async def move(
        self,
        old_path: str,
        new_accuracy_label: str  # correct / incorrect
    ) -> str:
        """ç§»åŠ¨æ–‡ä»¶ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰"""
        pass

    def get_path(
        self,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str
    ) -> str:
        """ç”Ÿæˆæ–‡ä»¶è·¯å¾„"""
        pass
```

---

### 5.4 æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº

æ ¹æ®ä¾èµ–å…³ç³»ï¼Œæ¨èä»¥ä¸‹å®ç°é¡ºåºï¼š

```
ç¬¬1å±‚ï¼ˆæ— ä¾èµ–ï¼‰ï¼š
  â”œâ”€ FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰
  â”œâ”€ PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰
  â””â”€ LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

ç¬¬2å±‚ï¼ˆä¾èµ–ç¬¬1å±‚ï¼‰ï¼š
  â”œâ”€ VLMClientï¼ˆä¾èµ–PROOF Frameworkï¼‰
  â”œâ”€ DiagnosisScorerï¼ˆä¾èµ–FuzzyMatcherï¼‰
  â””â”€ KnowledgeLoaderï¼ˆæ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå®ç°ï¼‰

ç¬¬3å±‚ï¼ˆä¾èµ–ç¬¬2å±‚ï¼‰ï¼š
  â”œâ”€ KnowledgeServiceï¼ˆä¾èµ–KnowledgeLoaderï¼‰
  â””â”€ ImageServiceï¼ˆä¾èµ–LocalImageStorage + ImageRepositoryï¼‰

ç¬¬4å±‚ï¼ˆä¾èµ–ç¬¬3å±‚ï¼‰ï¼š
  â””â”€ DiagnosisServiceï¼ˆä¾èµ–VLMClient + DiagnosisScorer + KnowledgeService + ImageServiceï¼‰
```

---

### 5.5 å…³é”®è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£
2. **ä¾èµ–å€’ç½®**ï¼šæœåŠ¡ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
3. **æ¥å£éš”ç¦»**ï¼šæ¨¡å—åªæš´éœ²å¿…è¦çš„å…¬å…±æ¥å£
4. **é¿å…å¾ªç¯ä¾èµ–**ï¼šä¸¥æ ¼æŒ‰ç…§åˆ†å±‚è°ƒç”¨ï¼ˆAPI â†’ Services â†’ Infrastructure â†’ Persistenceï¼‰

---

### 5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰

> **âš ï¸ æ¶æ„åœ°ä½è­¦ç¤º**ï¼šæç¤ºè¯æ¡†æ¶æ˜¯ PhytoOracle çš„**æ ¸å¿ƒåŸºç¡€è®¾æ–½**ï¼Œç±»ä¼¼äºæ•°æ®åº“ Schema æˆ– API å¥‘çº¦ã€‚ä¸€æ—¦å®šå‹åï¼Œä»»ä½•æ”¹åŠ¨éƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿï¼ˆVLM Providerã€è¯Šæ–­æœåŠ¡ã€æµ‹è¯•ç”¨ä¾‹ç­‰ï¼‰ã€‚è¯·æ…é‡è®¾è®¡å¹¶å……åˆ†æµ‹è¯•ã€‚

---

#### 5.6.1 é¡¹ç›®æœ¬è´¨å®šä½

**PhytoOracle çš„æ ¸å¿ƒæœ¬è´¨**ï¼š

```
PhytoOracle = æç¤ºè¯å·¥ç¨‹ (Prompt Engineering) + è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹ (Diagnostic Q&A System)
```

**ä¸¤å¤§æ ¸å¿ƒç»„ä»¶**ï¼š

1. **æç¤ºè¯å·¥ç¨‹**ï¼ˆæœ¬èŠ‚å†…å®¹ï¼‰
   - ç»“æ„åŒ–æç¤ºè¯è®¾è®¡ï¼ˆPROOF Frameworkï¼‰
   - VLM å“åº”æ ¼å¼ä¿éšœï¼ˆInstructorï¼‰
   - è§†è§‰åŒ–æ–¹æ³•èå…¥ï¼ˆæ–¹æ³•è®º v5.0ï¼‰
   - ç‰ˆæœ¬ç®¡ç†ä¸ A/B æµ‹è¯•

2. **è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹**ï¼ˆDiagnosisServiceï¼‰
   - Q0-Q6 é€çº§è¿‡æ»¤æµç¨‹
   - Layer1-Layer3 æ¸è¿›è¯Šæ–­
   - çŸ¥è¯†åº“åŒ¹é…ä¸è¯„åˆ†
   - å…œåº•é€»è¾‘è®¾è®¡

**å¯å¤ç”¨æ€§**ï¼š
- âœ… æœªæ¥ç±»ä¼¼é¡¹ç›®ï¼ˆå¦‚ä½œç‰©ç–¾ç—…è¯Šæ–­ã€åŠ¨ç‰©ç–¾ç—…è¯†åˆ«ï¼‰å¯ä»¥**ç›´æ¥å¤ç”¨**æç¤ºè¯æ¡†æ¶
- âœ… åªéœ€ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼ˆç–¾ç—…çŸ¥è¯†åº“ã€ç‰¹å¾å®šä¹‰ï¼‰
- âœ… æç¤ºè¯æ¡†æ¶ä¿æŒä¸å˜ï¼Œå¤§å¹…é™ä½å¼€å‘æˆæœ¬

---

#### 5.6.2 ä¸¤å±‚è§„èŒƒæ€§è®¾è®¡

**é—®é¢˜é™ˆè¿°**ï¼š
- **å±‚æ¬¡1**ï¼šå¦‚ä½•ç»“æ„åŒ–åœ°**ç¼–å†™**æç¤ºè¯ï¼Ÿï¼ˆç¼–å†™é˜¶æ®µè§„èŒƒæ€§ï¼‰
- **å±‚æ¬¡2**ï¼šå¦‚ä½•ç¡®ä¿ VLM **è¿”å›**çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Ÿï¼ˆè¿è¡Œæ—¶è§„èŒƒæ€§ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

| å±‚æ¬¡ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | è´£ä»»æ¨¡å— |
|------|------|---------|---------|
| **å±‚æ¬¡1** | æç¤ºè¯ç¼–å†™ä¸è§„èŒƒï¼Œéš¾ä»¥ç»´æŠ¤å’Œ A/B æµ‹è¯• | PROOF Framework | `PromptFramework` |
| **å±‚æ¬¡2** | VLM è¾“å‡ºæ ¼å¼ä¸å¯æ§ï¼Œéœ€è¦é‡è¯•å’Œå¼‚å¸¸å¤„ç† | Instructor | `VLMClient` + `Instructor` |

---

#### 5.6.3 PROOF Frameworkï¼ˆæç¤ºè¯è§„èŒƒæ€§ï¼‰

**PROOF** = **P**urpose + **R**ole + **O**bservation + **O**ptions + **F**ormat

**è®¾è®¡ç›®æ ‡**ï¼š
1. æ‰€æœ‰æç¤ºè¯éµå¾ªç»Ÿä¸€çš„ 5 å¤§ç»„ä»¶ç»“æ„
2. æ”¯æŒå‚æ•°åŒ–ï¼Œä¾¿äº A/B æµ‹è¯•
3. å¯¼å‡º JSON é…ç½®ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶
4. èå…¥æ–¹æ³•è®º v5.0 çš„è§†è§‰åŒ–æ–¹æ³•

**æ¡†æ¶åŸºç±»å®šä¹‰**ï¼š

```python
# infrastructure/llm/prompts/framework.py
from typing import List, Optional, Type, Dict
from pydantic import BaseModel
from dataclasses import dataclass
from datetime import datetime

@dataclass
class PromptPurpose:
    """æç¤ºè¯ç›®çš„"""
    task: str                          # ä»»åŠ¡æè¿°ï¼ˆä¸€å¥è¯ï¼‰
    context: Optional[str] = None      # å‰ç½®æ¡ä»¶
    why_important: Optional[str] = None  # ä¸ºä»€ä¹ˆé‡è¦ï¼ˆå¯é€‰ï¼‰

@dataclass
class PromptRole:
    """æç¤ºè¯è§’è‰²"""
    role: str                     # è§’è‰²åç§°
    expertise: List[str]          # ä¸“ä¸šçŸ¥è¯†é¢†åŸŸ
    constraints: List[str] = None # è§’è‰²é™åˆ¶

@dataclass
class PromptObservation:
    """è§‚å¯ŸæŒ‡å¯¼"""
    visual_method: Optional[str] = None      # è§†è§‰åŒ–æ–¹æ³•åç§°ï¼ˆå¦‚"Egg Yolk Metaphor"ï¼‰
    visual_clues: Optional[Dict[str, str]] = None  # è§†è§‰çº¿ç´¢
    focus_areas: Optional[List[str]] = None  # é‡ç‚¹å…³æ³¨åŒºåŸŸ

@dataclass
class Choice:
    """é€‰é¡¹"""
    label: str           # é€‰é¡¹æ ‡ç­¾
    description: str     # é€‰é¡¹æè¿°

@dataclass
class PromptOptions:
    """æç¤ºè¯é€‰é¡¹"""
    choices: List[Choice]           # é€‰é¡¹åˆ—è¡¨
    allow_unknown: bool = True      # æ˜¯å¦å…è®¸"unknown"
    allow_uncertain: bool = False   # æ˜¯å¦å…è®¸"unclear"

@dataclass
class Example:
    """Few-shot ç¤ºä¾‹"""
    input: str                      # è¾“å…¥æè¿°
    output: BaseModel               # è¾“å‡ºï¼ˆPydantic å¯¹è±¡ï¼‰

@dataclass
class PromptFormat:
    """è¾“å‡ºæ ¼å¼"""
    response_schema: Type[BaseModel]  # Pydantic å“åº”æ¨¡å‹
    examples: Optional[List[Example]] = None  # Few-shot ç¤ºä¾‹
    constraints: List[str] = None     # è¾“å‡ºçº¦æŸ

class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        self.question_id = question_id
        self.purpose = purpose
        self.role = role
        self.observation = observation
        self.options = options
        self.format_spec = format_spec
        self.version = version
        self.last_modified = datetime.now().isoformat()

    def render(self) -> str:
        """æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²"""
        sections = []

        # 1. Role
        sections.append(f"You are a {self.role.role}.")
        if self.role.expertise:
            sections.append(f"Your expertise: {', '.join(self.role.expertise)}.")
        sections.append("")

        # 2. Purpose
        sections.append(f"TASK: {self.purpose.task}")
        if self.purpose.context:
            sections.append(f"CONTEXT: {self.purpose.context}")
        sections.append("")

        # 3. Observationï¼ˆå¦‚æœæœ‰ï¼‰
        if self.observation.visual_method:
            sections.append(f"VISUAL METHOD ({self.observation.visual_method}):")

        if self.observation.visual_clues:
            sections.append("VISUAL CLUES:")
            for key, value in self.observation.visual_clues.items():
                sections.append(f"- {key}: {value}")
            sections.append("")

        # 4. Options
        sections.append("CHOICES:")
        for choice in self.options.choices:
            sections.append(f"- {choice.label}: {choice.description}")

        if self.options.allow_unknown:
            sections.append("- unknown (å¦‚æœä¸åœ¨ä»¥ä¸Šåˆ—è¡¨ä¸­)")
        sections.append("")

        # 5. Formatï¼ˆFew-shot ç¤ºä¾‹ï¼‰
        if self.format_spec.examples:
            sections.append("FEW-SHOT EXAMPLE:")
            for example in self.format_spec.examples:
                sections.append(f"Input: {example.input}")
                sections.append(f"Output: {example.output.model_dump_json(indent=2)}")
            sections.append("")

        # 6. Formatï¼ˆå“åº”æ ¼å¼ï¼‰
        sections.append("RESPONSE FORMAT (JSON only):")
        sections.append("```json")
        sections.append(self._generate_example_json())
        sections.append("```")
        sections.append("")

        # 7. Constraints
        sections.append("IMPORTANT: Only return JSON, no additional text.")

        return "\n".join(sections)

    def _generate_example_json(self) -> str:
        """æ ¹æ® response_schema ç”Ÿæˆç¤ºä¾‹ JSON"""
        import json
        schema = self.format_spec.response_schema.model_json_schema()
        properties = schema.get("properties", {})
        example = {}

        for key, prop in properties.items():
            if prop.get("type") == "string":
                example[key] = "example_value"
            elif prop.get("type") == "number":
                example[key] = 0.85

        return json.dumps(example, indent=2, ensure_ascii=False)

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        return {
            "question_id": self.question_id,
            "version": self.version,
            "last_modified": self.last_modified,
            "purpose": {
                "task": self.purpose.task,
                "context": self.purpose.context
            },
            "role": {
                "role": self.role.role,
                "expertise": self.role.expertise
            },
            "observation": {
                "visual_method": self.observation.visual_method,
                "visual_clues": self.observation.visual_clues
            },
            "options": {
                "choices": [{"label": c.label, "description": c.description} for c in self.options.choices],
                "allow_unknown": self.options.allow_unknown
            }
        }
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆQ0.2 èŠ±å‰ç§å±è¯†åˆ«ï¼‰**ï¼š

```python
# infrastructure/llm/prompts/q0_2_genus.py
from .framework import *
from ..response_schema import Q02Response

# å®šä¹‰æç¤ºè¯å‚æ•°
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",

    # P - Purpose
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),

    # R - Role
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),

    # O - Observation
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            "Tulipa": "Long narrow leaves, cup-shaped flowers, smooth stem",
            "Dianthus": "Narrow linear leaves, fringed petal edges, swollen stem nodes",
            "Paeonia": "Large compound leaves, large multi-layered flowers, thick stems"
        },
        focus_areas=["leaf shape", "stem texture", "petal arrangement"]
    ),

    # O - Options
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            Choice("Tulipa", "éƒé‡‘é¦™å±"),
            Choice("Dianthus", "åº·ä¹ƒé¦¨å±"),
            Choice("Paeonia", "ç‰¡ä¸¹å±")
        ],
        allow_unknown=True
    ),

    # F - Format
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[
            Example(
                input="Image shows a flower with compound leaves (5 leaflets), thorns on stem, pink layered petals",
                output=Q02Response(
                    choice="Rosa",
                    confidence=0.92,
                    reasoning="Compound leaves with 5 leaflets and thorny stems areå…¸å‹ç‰¹å¾ of Rosa genus"
                )
            )
        ]
    ),

    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()

# å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰
Q0_2_GENUS_CONFIG = q0_2_prompt.to_dict()
```

---

#### 5.6.4 Instructor é›†æˆï¼ˆè¾“å‡ºè§„èŒƒæ€§ï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹© Instructor**ï¼š

| å¯¹æ¯”ç»´åº¦ | è‡ªç ” ResponseValidator | Instructor | é€‰æ‹©åŸå›  |
|---------|---------------------|-----------|---------|
| **è‡ªåŠ¨é‡è¯•** | âŒ éœ€è¦æ‰‹å·¥å®ç° | âœ… å†…ç½®ï¼ˆæœ€å¤š3æ¬¡ï¼‰ | å‡å°‘ä»£ç é‡ |
| **å¤š Provider æ”¯æŒ** | âŒ éœ€è¦æ¯ä¸ª Provider é€‚é… | âœ… æ”¯æŒ 15+ Provider | è¦†ç›– Qwen/ChatGPT/Claude |
| **ç»´æŠ¤æˆæœ¬** | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ | âœ… ç¤¾åŒºç»´æŠ¤ | é™ä½æŠ€æœ¯å€º |
| **ä¾èµ–å¤§å°** | âœ… 0 | âœ… 25KB | å‡ ä¹æ— å½±å“ |
| **å­¦ä¹ æˆæœ¬** | ğŸŸ¡ éœ€è¦ç†è§£è‡ªç ”ä»£ç  | âœ… æ–‡æ¡£æ¸…æ™° | é™ä½ä¸Šæ‰‹æˆæœ¬ |

**Instructor é›†æˆæ–¹æ¡ˆ**ï¼š

```python
# infrastructure/llm/client.py
import instructor
from openai import OpenAI
from anthropic import Anthropic
from typing import Type, List
from pydantic import BaseModel

class VLMClient:
    """VLMå®¢æˆ·ç«¯ - é›†æˆ Instructor å®ç°ç»“æ„åŒ–è¾“å‡º"""

    def __init__(self):
        # åŒ…è£…å„Providerï¼ˆä½¿ç”¨ Instructorï¼‰
        self.providers = [
            instructor.from_openai(OpenAI(base_url="https://dashscope.aliyuncs.com/compatible-mode/v1")),  # Qwen
            instructor.from_openai(OpenAI()),                                                              # ChatGPT
            instructor.from_anthropic(Anthropic())                                                         # Claude
        ]
        self.current_provider_index = 0

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],
        question_id: str = None
    ) -> BaseModel:
        """å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯"""

        # 1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº† question_idï¼‰
        if question_id:
            cache_key = self._build_cache_key(image, question_id)
            cached = await self.cache.get(cache_key)
            if cached:
                return response_model.model_validate_json(cached)

        # 2. ä¾æ¬¡å°è¯•å„Provider
        last_error = None
        for provider in self.providers:
            try:
                # Instructor è‡ªåŠ¨éªŒè¯ + é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
                response = provider.chat.completions.create(
                    model="auto-detect",
                    response_model=response_model,  # è‡ªåŠ¨éªŒè¯ Pydantic æ¨¡å‹
                    messages=[
                        {"role": "system", "content": "You are a JSON API. Always respond with valid JSON."},
                        {"role": "user", "content": [
                            {"type": "image_url", "image_url": self._encode_image(image)},
                            {"type": "text", "text": prompt}
                        ]}
                    ],
                    max_retries=3  # Instructor è‡ªåŠ¨é‡è¯•
                )

                # ç¼“å­˜ç»“æœ
                if question_id:
                    await self.cache.set(cache_key, response.model_dump_json(), ttl=7*24*3600)

                return response  # å·²ç»æ˜¯ Pydantic å¯¹è±¡ï¼Œ100% ç¬¦åˆæ ¼å¼

            except Exception as e:
                logger.warning(f"Provider {provider} failed: {e}")
                last_error = str(e)
                continue

        # 3. æ‰€æœ‰Provideréƒ½å¤±è´¥
        raise VLMError(f"All VLM providers failed. Last error: {last_error}")

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®"""
        import hashlib
        image_hash = hashlib.md5(image).hexdigest()
        return f"vlm:{image_hash}:{question_id}"

    def _encode_image(self, image: bytes) -> str:
        """å°†å›¾ç‰‡ç¼–ç ä¸º base64"""
        import base64
        return f"data:image/jpeg;base64,{base64.b64encode(image).decode()}"
```

**DiagnosisService ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# application/services/diagnosis_service.py
class DiagnosisService:
    def __init__(self, vlm_client: VLMClient, knowledge_base: KnowledgeBase):
        self.vlm_client = vlm_client
        self.knowledge_base = knowledge_base

    async def diagnose(self, image: bytes) -> DiagnosisResult:
        # Layer1: Q0.0 å†…å®¹ç±»å‹è¯†åˆ«
        q0_0_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_0_CONTENT_TYPE_PROMPT.render(),
            image=image,
            response_model=Q00Response,  # Instructor è‡ªåŠ¨éªŒè¯
            question_id="Q0.0"
        )

        if q0_0_response.choice != "plant":
            return self._reject_non_plant(q0_0_response)

        # Layer1: Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«
        q0_1_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_1_PLANT_CATEGORY_PROMPT.render(),
            image=image,
            response_model=Q01Response,
            question_id="Q0.1"
        )

        if q0_1_response.choice != "flower":
            return self._reject_non_flower(q0_1_response)

        # Layer1: Q0.2 èŠ±å‰ç§å±è¯†åˆ«
        q0_2_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_2_GENUS_PROMPT.render(),
            image=image,
            response_model=Q02Response,
            question_id="Q0.2"
        )

        flower_genus = q0_2_response.choice
        if flower_genus == "unknown":
            return self._fallback_unknown_genus(q0_2_response)

        # ... Q0.3 - Q0.6 é€çº§è¿‡æ»¤
        # ... Layer2: çŸ¥è¯†åº“åŒ¹é…
        # ... Layer3: ç½®ä¿¡åº¦å†³ç­–
```

---

#### 5.6.5 VLM å“åº”æ ¼å¼åè®®ï¼ˆPydantic Modelsï¼‰

æ‰€æœ‰ VLM Provider å¿…é¡»è¿”å›ä¸¥æ ¼ç¬¦åˆæ­¤åè®®çš„ JSONï¼š

```python
# infrastructure/llm/response_schema.py
from typing import Literal, Optional, List
from pydantic import BaseModel, Field

class VLMResponse(BaseModel):
    """VLMå“åº”åŸºç±»"""
    choice: str = Field(..., description="é€‰æ‹©çš„é€‰é¡¹å€¼")
    confidence: float = Field(..., ge=0.0, le=1.0, description="VLMå¯¹æ­¤ç­”æ¡ˆçš„ç½®ä¿¡åº¦")
    reasoning: Optional[str] = Field(None, description="æ¨ç†è¿‡ç¨‹ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰")

# Q0ç³»åˆ—å“åº”æ ¼å¼
class Q00Response(VLMResponse):
    """Q0.0 å†…å®¹ç±»å‹è¯†åˆ«"""
    choice: Literal["plant", "animal", "person", "object", "landscape", "other"]

class Q01Response(VLMResponse):
    """Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«"""
    choice: Literal["flower", "vegetable", "tree", "crop", "grass", "other"]

class Q02Response(VLMResponse):
    """Q0.2 èŠ±å‰ç§å±è¯†åˆ«"""
    choice: Literal["Rosa", "Prunus", "Tulipa", "Dianthus", "Paeonia", "unknown"]

class Q03Response(VLMResponse):
    """Q0.3 å™¨å®˜è¯†åˆ«"""
    choice: Literal["flower", "leaf"]

class Q04Response(VLMResponse):
    """Q0.4 å®Œæ•´æ€§æ£€æŸ¥"""
    choice: Literal["complete", "partial", "close_up"]

class Q05Response(VLMResponse):
    """Q0.5 å¼‚å¸¸åˆ¤æ–­"""
    choice: Literal["healthy", "abnormal"]

# Q1-Q6åŠ¨æ€ç‰¹å¾æå–
class FeatureResponse(VLMResponse):
    """Q1-Q6ç‰¹å¾æå–å“åº”ï¼ˆåŠ¨æ€ï¼‰"""
    choice: str  # æ ¹æ®symptom_typeåŠ¨æ€å˜åŒ–
    alternatives: Optional[List[str]] = Field(None, description="å…¶ä»–å¯èƒ½çš„é€‰é¡¹ï¼ˆä¸ç¡®å®šæ—¶ï¼‰")
```

---

#### 5.6.6 æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**æ–‡ä»¶ç»„ç»‡**ï¼š
```
infrastructure/llm/prompts/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ framework.py            # PROOF Framework åŸºç±»
â”œâ”€â”€ q0_0_content.py         # Q0.0 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_1_category.py        # Q0.1 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_2_genus.py           # Q0.2 æç¤ºè¯å®šä¹‰ï¼ˆè§ä¸Šé¢ç¤ºä¾‹ï¼‰
â”œâ”€â”€ q0_3_organ.py           # Q0.3 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_4_completeness.py    # Q0.4 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_5_abnormality.py     # Q0.5 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 åŠ¨æ€æ¨¡æ¿
â”œâ”€â”€ configs/                # JSON é…ç½®æ–‡ä»¶ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”œâ”€â”€ q0_2_genus_v1.0.json
â”‚   â”œâ”€â”€ q0_2_genus_v1.1.json
â”‚   â””â”€â”€ ...
â””â”€â”€ CHANGELOG.md            # æç¤ºè¯å˜æ›´æ—¥å¿—
```

**ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ**ï¼š
1. æç¤ºè¯å‚æ•°ï¼ˆPROOFPrompt å¯¹è±¡ï¼‰çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶
2. æ¯æ¬¡ä¿®æ”¹æç¤ºè¯å¿…é¡»ï¼š
   - æ›´æ–° CHANGELOG.md
   - è¿è¡Œ A/B æµ‹è¯•éªŒè¯å‡†ç¡®ç‡
   - å‡†ç¡®ç‡ä¸‹é™ >5% åˆ™å›æ»š
3. æç¤ºè¯ç‰ˆæœ¬å·ä¸çŸ¥è¯†åº“ç‰ˆæœ¬å·ç‹¬ç«‹ç®¡ç†

**CHANGELOG.md ç¤ºä¾‹**ï¼š

```markdown
# Prompt Engineering CHANGELOG

## Q0.2 èŠ±å‰ç§å±è¯†åˆ«

### v1.1 (2025-11-15)
- **æ”¹åŠ¨**: æ›´æ–° Few-shot ç¤ºä¾‹ï¼ˆä» Rosa æ”¹ä¸º Prunusï¼‰
- **åŸå› **: æµ‹è¯•å‘ç° VLM å¯¹ Prunus çš„è¯†åˆ«å‡†ç¡®ç‡è¾ƒä½
- **A/B æµ‹è¯•ç»“æœ**: å‡†ç¡®ç‡ä» 82% æå‡åˆ° 88%
- **å®¡æ‰¹äºº**: @expert_botanist

### v1.0 (2025-11-11)
- åˆå§‹ç‰ˆæœ¬
- é‡‡ç”¨ Compound Feature Description è§†è§‰åŒ–æ–¹æ³•
```

**A/B æµ‹è¯•æµç¨‹**ï¼š

```python
# tests/prompt_ab_test.py
async def ab_test_prompt(
    test_images: List[bytes],
    variant_a: PROOFPrompt,
    variant_b: PROOFPrompt
) -> dict:
    """å¯¹æ¯”ä¸¤ä¸ªæç¤ºè¯å˜ä½“çš„å‡†ç¡®ç‡"""

    accuracy_a = await test_prompts(test_images, variant_a.render())
    accuracy_b = await test_prompts(test_images, variant_b.render())

    return {
        "variant_a": {
            "version": variant_a.version,
            "accuracy": accuracy_a
        },
        "variant_b": {
            "version": variant_b.version,
            "accuracy": accuracy_b
        },
        "improvement": accuracy_b - accuracy_a
    }
```

---

#### 5.6.7 å¯å¤ç”¨æ€§è®¾è®¡

**æœªæ¥æ‰©å±•åœºæ™¯**ï¼š

| æ–°é¡¹ç›® | éœ€è¦æ”¹åŠ¨ | ä¸éœ€è¦æ”¹åŠ¨ |
|--------|---------|----------|
| **ä½œç‰©ç–¾ç—…è¯Šæ–­** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.2 é€‰é¡¹ï¼ˆä½œç‰©ç§ç±»ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€ç‰ˆæœ¬ç®¡ç† |
| **åŠ¨ç‰©ç–¾ç—…è¯†åˆ«** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.0 é€‰é¡¹ï¼ˆåŠ¨ç‰©ç±»åˆ«ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€A/B æµ‹è¯•æµç¨‹ |
| **å·¥ä¸šç¼ºé™·æ£€æµ‹** | çŸ¥è¯†åº“ï¼ˆç¼ºé™·ç±»å‹ï¼‰ã€Q0 è¿‡æ»¤é€»è¾‘ï¼ˆäº§å“ç±»åˆ«ï¼‰ | PROOF Frameworkã€ç»“æ„åŒ–è¾“å‡ºæœºåˆ¶ |

**å¤ç”¨æµç¨‹**ï¼š

1. **ä¿ç•™æç¤ºè¯æ¡†æ¶**ï¼šPROOF Framework + Instructor
2. **ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡**ï¼š
   - ä¿®æ”¹ Q0.2 çš„ `choices`ï¼ˆé€‚é…æ–°çš„åˆ†ç±»ä½“ç³»ï¼‰
   - ä¿®æ”¹çŸ¥è¯†åº“ç»“æ„ï¼ˆDiseaseOntology â†’ DefectOntologyï¼‰
   - ä¿®æ”¹è¯Šæ–­è¯„åˆ†é€»è¾‘ï¼ˆDiagnosisScorerï¼‰
3. **å¤ç”¨åŸºç¡€è®¾æ–½**ï¼š
   - VLMClientï¼ˆFallback æœºåˆ¶ï¼‰
   - ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼ˆCHANGELOG.mdï¼‰
   - A/B æµ‹è¯•æµç¨‹

---

#### 5.6.8 å®æ–½è·¯çº¿å›¾

**Phase 1: PROOF Framework å®ç°ï¼ˆ1-2å¤©ï¼‰**

- [ ] å®ç° `framework.py` åŸºç±»ï¼ˆPROOFPromptã€PromptPurpose ç­‰ï¼‰
- [ ] è¿ç§» Q0.0 - Q0.5 åˆ° PROOF æ¡†æ¶
- [ ] å¯¼å‡º JSON é…ç½®åˆ° `configs/` ç›®å½•
- [ ] å»ºç«‹ CHANGELOG.md

**Phase 2: Instructor é›†æˆï¼ˆ1å¤©ï¼‰**

- [ ] å®‰è£… Instructorï¼š`pip install instructor`ï¼ˆä»… 25KBï¼‰
- [ ] åŒ…è£… VLMClient çš„å„ Providerï¼ˆQwen/ChatGPT/Claudeï¼‰
- [ ] ä¿®æ”¹ `call_with_fallback` æ–¹æ³•ï¼Œä¼ å…¥ `response_model`
- [ ] ç§»é™¤ç°æœ‰çš„ ResponseValidatorï¼ˆInstructor å·²æä¾›ï¼‰

**Phase 3: é›†æˆæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰**

- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆQ0-Q6 å®Œæ•´æµç¨‹ï¼‰
- [ ] å¯¹æ¯”è¿ç§»å‰åçš„å‡†ç¡®ç‡
- [ ] ç›‘æ§é‡è¯•æ¬¡æ•°å’Œå“åº”æ—¶é—´

---

#### 5.6.9 ä¾èµ–ç®¡ç†

**æ–°å¢ä¾èµ–**ï¼š

```toml
# pyproject.toml
[tool.poetry.dependencies]
instructor = "^1.7.0"  # å”¯ä¸€æ–°å¢ä¾èµ–ï¼ˆ25KBï¼Œæ— é¢å¤–ä¾èµ–ï¼‰

# å·²æœ‰ä¾èµ–
pydantic = "^2.0"
fastapi = "^0.100"
```

**ä¾èµ–å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æ–°å¢ä¾èµ– | ä¾èµ–å¤§å° | ç»´æŠ¤æˆæœ¬ |
|------|---------|---------|---------|
| è‡ªç ” ResponseValidator | æ—  | 0 | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ |
| Instructor | instructor | 25KB | âœ… ç¤¾åŒºç»´æŠ¤ |
| Outlines | outlines + torch | ~2GB | ğŸ”´ å¼€æºæ¨¡å‹ä¸“ç”¨ |
| LangChain | langchain + 70+ ä¾èµ– | ~500MB | ğŸ”´ è¿‡åº¦è®¾è®¡ |

**ç»“è®º**ï¼šInstructor æ˜¯æœ€è½»é‡ä¸”æœ€ç¬¦åˆéœ€æ±‚çš„é€‰æ‹©ã€‚

---


## 6. API è®¾è®¡ï¼ˆOpenAPI è§„èŒƒç‰‡æ®µï¼‰

```yaml
openapi: 3.0.3
info:
  title: PhytoOracle API
  version: 1.0.0
  description: èŠ±å‰ç–¾ç—…è¯Šæ–­ç³»ç»ŸAPI

servers:
  - url: http://localhost:8000/api/v1
    description: å¼€å‘ç¯å¢ƒ
  - url: https://api.phytooracle.com/api/v1
    description: ç”Ÿäº§ç¯å¢ƒ

paths:
  /diagnose:
    post:
      summary: æ‰§è¡Œç–¾ç—…è¯Šæ–­
      operationId: diagnose
      tags: [Diagnosis]
      security:
        - ApiKeyAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  format: binary
                  description: å›¾ç‰‡æ–‡ä»¶(JPG/PNG/HEIC)
                flower_genus:
                  type: string
                  description: èŠ±å‰ç§å±(å¯é€‰ï¼Œæé«˜å‡†ç¡®ç‡)
                  enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
      responses:
        '200':
          description: è¯Šæ–­æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DiagnosisResponse'
        '400':
          description: è¯·æ±‚é”™è¯¯
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: æœªæˆæƒ
        '500':
          description: æœåŠ¡å™¨é”™è¯¯

  /diseases:
    get:
      summary: è·å–ç–¾ç—…åˆ—è¡¨
      operationId: listDiseases
      tags: [Knowledge]
      parameters:
        - name: genus
          in: query
          schema:
            type: string
          description: æŒ‰èŠ±å‰å±è¿‡æ»¤
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Disease'

  /admin/reload:
    post:
      summary: é‡è½½çŸ¥è¯†åº“
      operationId: reloadKnowledge
      tags: [Admin]
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: é‡è½½æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                  disease_count:
                    type: integer

  /auth/login:
    post:
      summary: ç®¡ç†å‘˜ç™»å½•
      operationId: login
      tags: [Auth]
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        '200':
          description: ç™»å½•æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    default: bearer

  /history:
    get:
      summary: æŸ¥è¯¢è¯Šæ–­å†å²
      operationId: getDiagnosisHistory
      tags: [Diagnosis]
      security:
        - ApiKeyAuth: []
      parameters:
        - name: start_date
          in: query
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          schema:
            type: string
            format: date
        - name: plant_genus
          in: query
          schema:
            type: string
        - name: confidence_level
          in: query
          schema:
            type: string
            enum: [confirmed, suspected, unlikely]
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DiagnosisHistory'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    DiagnosisResponse:
      type: object
      properties:
        diagnosis_id:
          type: string
          example: diag_20250111_001
        timestamp:
          type: string
          format: date-time
        diagnosis:
          type: object
          properties:
            disease_id:
              type: string
            disease_name:
              type: string
            common_name_en:
              type: string
            pathogen:
              type: string
            level:
              type: string
              enum: [confirmed, suspected, unlikely]
            confidence:
              type: number
              format: float
              minimum: 0
              maximum: 1
        feature_vector:
          $ref: '#/components/schemas/FeatureVector'
        scores:
          type: object
          properties:
            total_score:
              type: number
            major_features:
              type: object
            minor_features:
              type: object
            optional_features:
              type: object
        reasoning:
          type: array
          items:
            type: string
        candidates:
          type: array
          description: ç–‘ä¼¼è¯Šæ–­æ—¶çš„å€™é€‰ç–¾ç—…
          items:
            type: object
            properties:
              disease_name:
                type: string
              confidence:
                type: number
        vlm_provider:
          type: string
        execution_time_ms:
          type: integer

    FeatureVector:
      type: object
      properties:
        content_type:
          type: string
        plant_category:
          type: string
        flower_genus:
          type: string
        organ:
          type: string
        completeness:
          type: string
        has_abnormality:
          type: string
        symptom_type:
          type: string
        color_center:
          type: string
        location:
          type: string
        size:
          type: string
        distribution:
          type: string

    Disease:
      type: object
      properties:
        disease_id:
          type: string
        disease_name:
          type: string
        common_name_en:
          type: string
        pathogen:
          type: string
        affected_plants:
          type: array
          items:
            type: string
        typical_symptoms:
          type: array
          items:
            type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
        timestamp:
          type: string
          format: date-time
```

---

## 7. æ•°æ®æ¨¡å‹ï¼ˆPydantic V2 å®Œæ•´ä»£ç ï¼‰

```python
# domain/diagnosis.py
from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, List, Dict, Any
from datetime import datetime
from enum import Enum

class ContentType(str, Enum):
    """å›¾ç‰‡å†…å®¹ç±»å‹"""
    PLANT = "plant"
    ANIMAL = "animal"
    PERSON = "person"
    OBJECT = "object"
    LANDSCAPE = "landscape"
    OTHER = "other"

class PlantCategory(str, Enum):
    """æ¤ç‰©ç±»åˆ«"""
    FLOWER = "flower"
    VEGETABLE = "vegetable"
    TREE = "tree"
    CROP = "crop"
    GRASS = "grass"
    OTHER = "other"

class FlowerGenus(str, Enum):
    """èŠ±å‰ç§å±"""
    ROSA = "Rosa"
    PRUNUS = "Prunus"
    TULIPA = "Tulipa"
    DIANTHUS = "Dianthus"
    PAEONIA = "Paeonia"
    OTHER = "Other"

class OrganType(str, Enum):
    """å™¨å®˜ç±»å‹"""
    FLOWER = "flower"
    LEAF = "leaf"

class Completeness(str, Enum):
    """å®Œæ•´æ€§"""
    COMPLETE = "complete"
    PARTIAL = "partial"
    CLOSE_UP = "close_up"

class AbnormalityStatus(str, Enum):
    """å¼‚å¸¸çŠ¶æ€"""
    HEALTHY = "healthy"
    ABNORMAL = "abnormal"

class ConfidenceLevel(str, Enum):
    """ç½®ä¿¡åº¦çº§åˆ«ï¼ˆæ‰©å±•ç‰ˆï¼ŒåŒ…å«å…œåº•çŠ¶æ€ï¼‰"""
    CONFIRMED = "confirmed"          # ç¡®è¯Šï¼ˆscore â‰¥ 0.85 ä¸” major_matched â‰¥ 2ï¼‰
    SUSPECTED = "suspected"          # ç–‘ä¼¼ï¼ˆ0.60 â‰¤ score < 0.85 ä¸” major_matched â‰¥ 1ï¼‰
    UNLIKELY = "unlikely"            # ä¸å¤ªå¯èƒ½ï¼ˆscore < 0.60 æˆ– major_matched = 0ï¼‰
    UNKNOWN = "unknown"              # çŸ¥è¯†åº“æ— æ•°æ®ï¼ˆè¯¥èŠ±å‰æœªæ”¶å½•ï¼‰
    VLM_FALLBACK = "vlm_fallback"   # VLMå…œåº•è¯Šæ–­ï¼ˆçŸ¥è¯†åº“å¤–ç–¾ç—…ï¼‰
    SYSTEM_ERROR = "system_error"    # ç³»ç»Ÿé”™è¯¯ï¼ˆVLMå®Œå…¨å¤±è´¥ï¼‰

class FeatureVector(BaseModel):
    """ç‰¹å¾å‘é‡æ¨¡å‹"""
    model_config = ConfigDict(use_enum_values=True)

    # Q0ç‰¹å¾
    content_type: ContentType
    plant_category: PlantCategory
    flower_genus: FlowerGenus
    organ: OrganType
    completeness: Completeness
    has_abnormality: AbnormalityStatus

    # Q1-Q6ç‰¹å¾
    symptom_type: Optional[str] = None
    color_center: Optional[str] = None
    color_border: Optional[str] = None
    location: Optional[str] = None
    size: Optional[str] = None
    distribution: Optional[str] = None
    additional_features: Dict[str, Any] = Field(default_factory=dict)

class DiagnosisScore(BaseModel):
    """è¯Šæ–­åˆ†æ•°æ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼ŒåŒ…å«åŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰"""
    model_config = ConfigDict(frozen=True)

    total_score: float = Field(..., ge=0, le=1)
    major_features_score: float = Field(..., ge=0, le=1)
    minor_features_score: float = Field(..., ge=0, le=1)
    optional_features_score: float = Field(..., ge=0, le=1)

    # åŒ»å­¦è¯Šæ–­é€»è¾‘æ–°å¢å­—æ®µ
    major_matched: int = Field(..., ge=0)    # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
    major_total: int = Field(..., ge=0)      # ä¸»è¦ç‰¹å¾æ€»æ•°ï¼ˆé€šå¸¸ä¸º2ï¼‰

    @property
    def confidence_level(self) -> ConfidenceLevel:
        """
        è¯Šæ–­ç­‰çº§åˆ¤å®šï¼ˆä¸¥æ ¼éµå¾ªåŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰

        è§„åˆ™ï¼ˆéœ€æ±‚æ–‡æ¡£v1.3å®šä¹‰ï¼‰ï¼š
        - confirmed: total_score â‰¥ 0.85 ä¸” major_matched â‰¥ 2/2
        - suspected: 0.60 â‰¤ total_score < 0.85 ä¸” major_matched â‰¥ 1/2
        - unlikely: total_score < 0.60 æˆ– major_matched = 0
        """
        if self.total_score >= 0.85 and self.major_matched >= 2:
            return ConfidenceLevel.CONFIRMED
        elif self.total_score >= 0.60 and self.major_matched >= 1:
            return ConfidenceLevel.SUSPECTED
        return ConfidenceLevel.UNLIKELY

class DiagnosisResult(BaseModel):
    """è¯Šæ–­ç»“æœæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼Œæ”¯æŒå…œåº•é€»è¾‘ï¼‰"""
    diagnosis_id: str = Field(..., pattern=r"^diag_\d{8}_\d{3}$")
    timestamp: datetime

    # è¯Šæ–­ç»“æœ
    disease_id: Optional[str] = None
    disease_name: str
    common_name_en: Optional[str] = None
    pathogen: Optional[str] = None
    level: ConfidenceLevel
    confidence: float = Field(..., ge=0, le=1)

    # å…œåº•é€»è¾‘æ–°å¢å­—æ®µ
    message: Optional[str] = None            # å…œåº•åœºæ™¯çš„è¯´æ˜ä¿¡æ¯
    suggestion: Optional[str] = None         # ç»™ç”¨æˆ·çš„å»ºè®®
    vlm_suggestion: Optional[str] = None     # VLMå¼€æ”¾å¼è¯Šæ–­ç»“æœ

    # ç‰¹å¾å‘é‡ï¼ˆå…œåº•åœºæ™¯å¯èƒ½ä¸ºç©ºï¼‰
    feature_vector: Optional[FeatureVector] = None

    # è¯„åˆ†è¯¦æƒ…ï¼ˆå…œåº•åœºæ™¯å¯èƒ½ä¸ºç©ºï¼‰
    scores: Optional[DiagnosisScore] = None

    # æ¨ç†è¿‡ç¨‹
    reasoning: List[str] = Field(default_factory=list)
    matched_rule: Optional[str] = None

    # å€™é€‰ç–¾ç—…ï¼ˆç–‘ä¼¼è¯Šæ–­æ—¶ï¼‰
    candidates: Optional[List[Dict[str, Any]]] = None

    # æ‰§è¡Œä¿¡æ¯
    vlm_provider: str
    execution_time_ms: int

    # é”™è¯¯ä¿¡æ¯
    error: Optional[str] = None

# domain/disease.py
class DiseaseOntology(BaseModel):
    """ç–¾ç—…æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    version: str = "4.1"
    disease_id: str = Field(..., min_length=3, max_length=50)
    disease_name: str = Field(..., min_length=2, max_length=100)
    common_name_en: str
    pathogen: str

    # ç‰¹å¾å‘é‡
    feature_vector: Dict[str, Any]

    # ç‰¹å¾é‡è¦æ€§
    feature_importance: Dict[str, Dict] = Field(...)

    # è¯Šæ–­è§„åˆ™
    diagnosis_rules: Dict[str, List[Dict]] = Field(...)

    # è§†è§‰æè¿°
    visual_descriptions: Dict[str, str] = Field(default_factory=dict)

    # å®¿ä¸»æ¤ç‰©
    host_plants: List[str] = Field(default_factory=list)

    # å…¸å‹ç—‡çŠ¶æè¿°
    typical_symptoms: List[str] = Field(default_factory=list)

    def get_major_features(self) -> List[Dict]:
        """è·å–ä¸»è¦ç‰¹å¾"""
        return self.feature_importance.get("major_features", {}).get("features", [])

    def get_expected_values(self, dimension: str) -> List[str]:
        """è·å–æŸç»´åº¦çš„æœŸæœ›å€¼"""
        for feature_group in self.feature_importance.values():
            for feature in feature_group.get("features", []):
                if feature.get("dimension") == dimension:
                    return feature.get("expected_values", [])
        return []

# domain/plant.py
class PlantOntology(BaseModel):
    """æ¤ç‰©æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    # åˆ†ç±»å­¦ä¿¡æ¯
    kingdom: str = "Plantae"
    family: str
    genus: str
    species: List[str] = Field(default_factory=list)
    common_names: Dict[str, str] = Field(default_factory=dict)  # {"zh": "ç«ç‘°", "en": "Rose"}

    # å™¨å®˜è§£å‰–
    organ_anatomy: Dict[str, List[str]] = Field(default_factory=dict)

    # VLMè¯†åˆ«çº¿ç´¢
    visual_cues: Dict[str, str] = Field(default_factory=dict)

    # æ˜“æ„Ÿç–¾ç—…
    susceptible_diseases: List[str] = Field(default_factory=list)

# domain/feature.py
class FeatureOntology(BaseModel):
    """ç‰¹å¾æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    version: str = "1.0"

    # ç‰¹å¾ç»´åº¦å®šä¹‰
    dimensions: Dict[str, Dict] = Field(...)

    # æ¨¡ç³ŠåŒ¹é…è§„åˆ™
    fuzzy_matching: Dict[str, Any] = Field(...)

    # ç—‡çŠ¶ç±»å‹å®šä¹‰
    symptom_types: List[Dict[str, str]] = Field(default_factory=list)

    # é¢œè‰²å®šä¹‰
    colors: Dict[str, List[str]] = Field(default_factory=dict)

    # å°ºå¯¸å®šä¹‰
    sizes: List[str] = Field(default_factory=list)

    # åˆ†å¸ƒæ¨¡å¼å®šä¹‰
    distribution_patterns: List[str] = Field(default_factory=list)

# domain/value_objects.py
from dataclasses import dataclass

@dataclass(frozen=True)
class ImageHash:
    """å›¾ç‰‡å“ˆå¸Œå€¼å¯¹è±¡"""
    md5: str
    sha256: Optional[str] = None

    @classmethod
    def from_bytes(cls, image_bytes: bytes) -> "ImageHash":
        import hashlib
        return cls(
            md5=hashlib.md5(image_bytes).hexdigest(),
            sha256=hashlib.sha256(image_bytes).hexdigest()
        )

@dataclass(frozen=True)
class DiagnosisId:
    """è¯Šæ–­IDå€¼å¯¹è±¡"""
    value: str

    def __post_init__(self):
        import re
        if not re.match(r"^diag_\d{8}_\d{3}$", self.value):
            raise ValueError(f"Invalid diagnosis ID format: {self.value}")

    @classmethod
    def generate(cls) -> "DiagnosisId":
        from datetime import datetime
        import random
        date_str = datetime.now().strftime("%Y%m%d")
        seq = random.randint(1, 999)
        return cls(f"diag_{date_str}_{seq:03d}")
```

---

## 8. çŸ¥è¯†æœ¬ä½“è®¾è®¡ï¼ˆJSON Schema + ç¤ºä¾‹ï¼‰

### 8.1 Disease Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Disease Ontology Schema",
  "type": "object",
  "required": [
    "version",
    "disease_id",
    "disease_name",
    "feature_vector",
    "feature_importance",
    "diagnosis_rules"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "disease_id": {
      "type": "string",
      "minLength": 3,
      "maxLength": 50
    },
    "disease_name": {
      "type": "string",
      "minLength": 2,
      "maxLength": 100
    },
    "common_name_en": {
      "type": "string"
    },
    "pathogen": {
      "type": "string"
    },
    "feature_vector": {
      "type": "object",
      "properties": {
        "symptom_type": {"type": "string"},
        "color_center": {"type": ["string", "array"]},
        "color_border": {"type": ["string", "array"]},
        "location": {"type": ["string", "array"]},
        "size": {"type": "string"},
        "distribution": {"type": "string"}
      }
    },
    "feature_importance": {
      "type": "object",
      "properties": {
        "major_features": {
          "type": "object",
          "properties": {
            "_weight": {"type": "number"},
            "features": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["dimension", "expected_values", "weight"],
                "properties": {
                  "dimension": {"type": "string"},
                  "expected_values": {
                    "type": "array",
                    "items": {"type": "string"}
                  },
                  "weight": {"type": "number"},
                  "description": {"type": "string"}
                }
              }
            }
          }
        },
        "minor_features": {
          "type": "object"
        },
        "optional_features": {
          "type": "object"
        }
      }
    },
    "diagnosis_rules": {
      "type": "object"
    },
    "visual_descriptions": {
      "type": "object"
    }
  }
}
```

### 8.2 Disease Ontology ç¤ºä¾‹

```json
{
  "version": "4.1",
  "disease_id": "rose_black_spot",
  "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
  "common_name_en": "Rose Black Spot",
  "pathogen": "Diplocarpon rosae",

  "feature_vector": {
    "symptom_type": "necrosis_spot",
    "color_center": ["black", "dark_brown"],
    "color_border": ["yellow", "light_yellow"],
    "location": ["lamina", "petiole"],
    "size": "medium",
    "distribution": "random"
  },

  "feature_importance": {
    "major_features": {
      "_weight": 0.8,
      "features": [
        {
          "dimension": "symptom_type",
          "expected_values": ["necrosis_spot"],
          "weight": 0.5,
          "description": "åæ­»æ€§æ–‘ç‚¹æ˜¯é»‘æ–‘ç—…çš„å…³é”®ç‰¹å¾"
        },
        {
          "dimension": "color_center",
          "expected_values": ["black", "dark_brown", "brown"],
          "weight": 0.3,
          "description": "é»‘è‰²æˆ–æ·±è¤è‰²ä¸­å¿ƒæ˜¯å…¸å‹ç‰¹å¾"
        }
      ]
    },
    "minor_features": {
      "_weight": 0.15,
      "features": [
        {
          "dimension": "color_border",
          "expected_values": ["yellow", "light_yellow"],
          "weight": 0.1,
          "description": "é»„è‰²æ™•åœˆ"
        },
        {
          "dimension": "location",
          "expected_values": ["lamina", "petiole"],
          "weight": 0.05,
          "description": "ä¸»è¦å‘ç”Ÿåœ¨å¶ç‰‡å’Œå¶æŸ„"
        }
      ]
    },
    "optional_features": {
      "_weight": 0.05,
      "features": [
        {
          "dimension": "size",
          "expected_values": ["medium", "medium_small"],
          "weight": 0.03,
          "description": "æ–‘ç‚¹å¤§å°éšç—…ç¨‹å˜åŒ–"
        },
        {
          "dimension": "distribution",
          "expected_values": ["random", "scattered"],
          "weight": 0.02,
          "description": "éšæœºåˆ†å¸ƒ"
        }
      ]
    }
  },

  "diagnosis_rules": {
    "confirmed": {
      "criteria": [
        {
          "rule_id": "R1",
          "logic": "major_features >= 2/2 AND minor_features >= 1/2",
          "confidence": 0.95,
          "description": "ä¸»è¦ç‰¹å¾å…¨éƒ¨åŒ¹é…ä¸”è‡³å°‘ä¸€ä¸ªæ¬¡è¦ç‰¹å¾åŒ¹é…"
        }
      ]
    },
    "suspected": {
      "criteria": [
        {
          "rule_id": "R2",
          "logic": "major_features >= 1/2 AND minor_features >= 1/2",
          "confidence": 0.70,
          "description": "è‡³å°‘ä¸€ä¸ªä¸»è¦ç‰¹å¾å’Œä¸€ä¸ªæ¬¡è¦ç‰¹å¾åŒ¹é…"
        }
      ]
    }
  },

  "visual_descriptions": {
    "color_border": "è§‚å¯Ÿæ–‘ç‚¹è¾¹ç¼˜ï¼Œå¯»æ‰¾åƒç…è›‹è›‹ç™½ç¯ç»•è›‹é»„çš„é»„è‰²æ™•åœˆ",
    "symptom_appearance": "æ–‘ç‚¹çœ‹èµ·æ¥åƒè¢«é¦™çƒŸçƒ«è¿‡ç•™ä¸‹çš„ç„¦ç—•",
    "progression": "æ—©æœŸä¸ºå°é»‘ç‚¹ï¼ŒåæœŸæ‰©å¤§å¹¶èåˆï¼Œå¯å¯¼è‡´å¶ç‰‡è„±è½"
  }
}
```

### 8.3 Feature Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Feature Ontology Schema",
  "type": "object",
  "properties": {
    "version": {"type": "string"},
    "dimensions": {
      "type": "object",
      "properties": {
        "symptom_type": {
          "type": "object",
          "properties": {
            "values": {
              "type": "array",
              "items": {"type": "string"}
            },
            "descriptions": {
              "type": "object"
            }
          }
        },
        "color": {
          "type": "object",
          "properties": {
            "groups": {
              "type": "object",
              "additionalProperties": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        },
        "size": {
          "type": "object",
          "properties": {
            "order": {
              "type": "array",
              "items": {"type": "string"}
            },
            "visual_references": {
              "type": "object"
            }
          }
        }
      }
    },
    "fuzzy_matching": {
      "type": "object"
    }
  }
}
```

### 8.4 Host-Disease Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Host-Disease Associations Schema",
  "type": "object",
  "properties": {
    "version": {"type": "string"},
    "associations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["host_genus", "disease_id", "specificity"],
        "properties": {
          "host_genus": {"type": "string"},
          "disease_id": {"type": "string"},
          "specificity": {
            "type": "string",
            "enum": ["species", "genus", "family"]
          },
          "prevalence": {
            "type": "string",
            "enum": ["common", "occasional", "rare"]
          }
        }
      }
    }
  }
}
```

---

## 9. æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆPostgreSQL DDLï¼‰

### 9.1 è¡¨ç»“æ„æ€»è§ˆ

MVPç‰ˆæœ¬éœ€è¦5å¼ æ ¸å¿ƒè¡¨ï¼š
- `diagnoses`ï¼šè¯Šæ–­è®°å½•ï¼ˆå­˜å‚¨æ¯æ¬¡è¯Šæ–­çš„å®Œæ•´ä¿¡æ¯ï¼‰
- `images`ï¼šå›¾ç‰‡å…ƒæ•°æ®ï¼ˆå­˜å‚¨å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯å’Œå‡†ç¡®ç‡æ ‡ç­¾ï¼‰
- `api_keys`ï¼šAPIå¯†é’¥ï¼ˆå­˜å‚¨ç”¨æˆ·è®¤è¯å¯†é’¥ï¼‰
- `admin_users`ï¼šç®¡ç†å‘˜è´¦å·ï¼ˆå­˜å‚¨ç®¡ç†åå°ç™»å½•è´¦å·ï¼‰
- `knowledge_versions`ï¼šçŸ¥è¯†åº“ç‰ˆæœ¬ï¼ˆå­˜å‚¨çŸ¥è¯†åº“åŠ è½½å†å²ï¼‰

### 12.2 å®Œæ•´DDLè¯­å¥

```sql
-- 1. è¯Šæ–­è®°å½•è¡¨
CREATE TABLE diagnoses (
    diagnosis_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    image_path TEXT NOT NULL,

    -- ç‰¹å¾å‘é‡ï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«Q0-Q6æ‰€æœ‰é—®é¢˜çš„å›ç­”ï¼‰
    feature_vector JSONB NOT NULL,

    -- è¯Šæ–­ç»“æœï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«status/confirmed_disease/suspected_diseasesï¼‰
    diagnosis_result JSONB NOT NULL,

    -- è¯„åˆ†è¯¦æƒ…ï¼ˆJSONæ•°ç»„ï¼ŒåŒ…å«æ¯ä¸ªå€™é€‰ç–¾ç—…çš„å¾—åˆ†æ˜ç»†ï¼‰
    scores JSONB,

    -- æ¨ç†è¿‡ç¨‹ï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«Q1-Q6çš„VLMåŸå§‹å›ç­”ï¼‰
    reasoning JSONB,

    -- VLMæä¾›å•†ï¼ˆè®°å½•ä½¿ç”¨çš„æ¨¡å‹ï¼‰
    vlm_provider VARCHAR(50) NOT NULL,

    -- æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    execution_time_ms INTEGER,

    -- ç´¢å¼•
    CONSTRAINT valid_diagnosis_result CHECK (
        diagnosis_result ? 'status' AND
        diagnosis_result->>'status' IN ('confirmed', 'suspected', 'uncertain', 'rejected')
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_diagnoses_timestamp ON diagnoses(timestamp DESC);
CREATE INDEX idx_diagnoses_vlm_provider ON diagnoses(vlm_provider);
CREATE INDEX idx_diagnoses_result_status ON diagnoses((diagnosis_result->>'status'));
CREATE INDEX idx_diagnoses_feature_vector_genus ON diagnoses((feature_vector->>'flower_genus'));

-- 2. å›¾ç‰‡å…ƒæ•°æ®è¡¨
CREATE TABLE images (
    image_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    diagnosis_id UUID REFERENCES diagnoses(diagnosis_id) ON DELETE CASCADE,

    -- æ–‡ä»¶å­˜å‚¨è·¯å¾„
    file_path TEXT NOT NULL UNIQUE,

    -- ä¸Šä¼ æ—¶é—´
    upload_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- æ¤ç‰©ç§å±ï¼ˆä»è¯Šæ–­ç»“æœä¸­æå–ï¼‰
    plant_genus VARCHAR(100),

    -- å™¨å®˜ç±»å‹ï¼ˆleaf/flowerï¼‰
    organ VARCHAR(20),

    -- å‡†ç¡®ç‡æ ‡ç­¾ï¼ˆunlabeled/correct/incorrectï¼‰
    accuracy_label VARCHAR(20) DEFAULT 'unlabeled',

    -- å¤‡æ³¨ï¼ˆäººå·¥æ ‡æ³¨ï¼‰
    notes TEXT,

    CONSTRAINT valid_organ CHECK (organ IN ('leaf', 'flower', 'unknown')),
    CONSTRAINT valid_accuracy_label CHECK (
        accuracy_label IN ('unlabeled', 'correct', 'incorrect')
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_images_diagnosis_id ON images(diagnosis_id);
CREATE INDEX idx_images_upload_time ON images(upload_time DESC);
CREATE INDEX idx_images_plant_genus ON images(plant_genus);
CREATE INDEX idx_images_accuracy_label ON images(accuracy_label);

-- 3. APIå¯†é’¥è¡¨
CREATE TABLE api_keys (
    key_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- API Keyï¼ˆSHA256å“ˆå¸Œå­˜å‚¨ï¼ŒåŸå§‹å¯†é’¥åªåœ¨ç”Ÿæˆæ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼‰
    api_key_hash VARCHAR(64) NOT NULL UNIQUE,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼‰
    expires_at TIMESTAMPTZ,

    -- æ˜¯å¦æ¿€æ´»
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- æè¿°ï¼ˆç”¨äºæ ‡è¯†ç”¨é€”ï¼‰
    description TEXT,

    -- æœ€åä½¿ç”¨æ—¶é—´
    last_used_at TIMESTAMPTZ
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_api_keys_hash ON api_keys(api_key_hash) WHERE is_active = TRUE;
CREATE INDEX idx_api_keys_expires_at ON api_keys(expires_at) WHERE expires_at IS NOT NULL;

-- 4. ç®¡ç†å‘˜è´¦å·è¡¨
CREATE TABLE admin_users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
    username VARCHAR(50) NOT NULL UNIQUE,

    -- å¯†ç ï¼ˆbcryptå“ˆå¸Œå­˜å‚¨ï¼‰
    password_hash VARCHAR(255) NOT NULL,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- æœ€åç™»å½•æ—¶é—´
    last_login_at TIMESTAMPTZ,

    -- æ˜¯å¦æ¿€æ´»
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);

-- 5. çŸ¥è¯†åº“ç‰ˆæœ¬è¡¨
CREATE TABLE knowledge_versions (
    version_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Git Commit Hashï¼ˆå¯¹åº”çŸ¥è¯†åº“JSONçš„ç‰ˆæœ¬ï¼‰
    commit_hash VARCHAR(40) NOT NULL,

    -- åŠ è½½æ—¶é—´
    loaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- ç–¾ç—…æ•°é‡ï¼ˆç”¨äºå¿«é€ŸéªŒè¯çŸ¥è¯†åº“å®Œæ•´æ€§ï¼‰
    disease_count INTEGER NOT NULL,

    -- ç‰ˆæœ¬æè¿°
    description TEXT,

    -- æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»ç‰ˆæœ¬
    is_current BOOLEAN NOT NULL DEFAULT FALSE
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_knowledge_versions_loaded_at ON knowledge_versions(loaded_at DESC);
CREATE UNIQUE INDEX idx_knowledge_versions_current ON knowledge_versions(is_current) WHERE is_current = TRUE;
```

### 9.3 åˆå§‹åŒ–æ•°æ®è„šæœ¬

```sql
-- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼ˆå¯†ç ï¼šadmin123ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
-- bcrypt hash for 'admin123'
INSERT INTO admin_users (username, password_hash, is_active)
VALUES (
    'admin',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5ckM.Eq0J/7mO',
    TRUE
);

-- åˆ›å»ºåˆå§‹API Keyï¼ˆç¤ºä¾‹ï¼šphyto_dev_key_12345ï¼‰
-- SHA256 hash for 'phyto_dev_key_12345'
INSERT INTO api_keys (api_key_hash, description, is_active)
VALUES (
    'f8e3d6c7b2a1e4f5d8c9b0a7e6f5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e7',
    'Development API Key',
    TRUE
);

-- è®°å½•åˆå§‹çŸ¥è¯†åº“ç‰ˆæœ¬
INSERT INTO knowledge_versions (commit_hash, disease_count, description, is_current)
VALUES (
    'initial',
    20,
    'Initial knowledge base with 5 flowers and 20 diseases',
    TRUE
);
```

### 9.4 æ•°æ®åº“è®¿é—®å±‚æ¥å£ï¼ˆRepositoryæ¨¡å¼ï¼‰

```python
# infrastructure/persistence/repositories/diagnosis_repo.py
from typing import Optional, List
from uuid import UUID
from datetime import datetime
import asyncpg

class DiagnosisRepository:
    """è¯Šæ–­è®°å½•æ•°æ®è®¿é—®å±‚"""

    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool

    async def save(
        self,
        image_path: str,
        feature_vector: dict,
        diagnosis_result: dict,
        scores: Optional[dict],
        reasoning: dict,
        vlm_provider: str,
        execution_time_ms: int
    ) -> UUID:
        """ä¿å­˜è¯Šæ–­è®°å½•"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                INSERT INTO diagnoses (
                    image_path, feature_vector, diagnosis_result,
                    scores, reasoning, vlm_provider, execution_time_ms
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7)
                RETURNING diagnosis_id
                """,
                image_path,
                feature_vector,
                diagnosis_result,
                scores,
                reasoning,
                vlm_provider,
                execution_time_ms
            )
            return row['diagnosis_id']

    async def get_by_id(self, diagnosis_id: UUID) -> Optional[dict]:
        """æ ¹æ®IDæŸ¥è¯¢è¯Šæ–­è®°å½•"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                "SELECT * FROM diagnoses WHERE diagnosis_id = $1",
                diagnosis_id
            )
            return dict(row) if row else None

    async def list_by_date_range(
        self,
        start_date: datetime,
        end_date: datetime,
        limit: int = 100,
        offset: int = 0
    ) -> List[dict]:
        """æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢è¯Šæ–­å†å²"""
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(
                """
                SELECT * FROM diagnoses
                WHERE timestamp >= $1 AND timestamp < $2
                ORDER BY timestamp DESC
                LIMIT $3 OFFSET $4
                """,
                start_date, end_date, limit, offset
            )
            return [dict(row) for row in rows]

    async def list_by_genus(
        self,
        genus: str,
        limit: int = 100
    ) -> List[dict]:
        """æŒ‰æ¤ç‰©ç§å±æŸ¥è¯¢è¯Šæ–­å†å²"""
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(
                """
                SELECT * FROM diagnoses
                WHERE feature_vector->>'flower_genus' = $1
                ORDER BY timestamp DESC
                LIMIT $2
                """,
                genus, limit
            )
            return [dict(row) for row in rows]

    async def get_accuracy_stats(self) -> dict:
        """ç»Ÿè®¡å‡†ç¡®ç‡ï¼ˆåŸºäºäººå·¥æ ‡æ³¨ï¼‰"""
        async with self.pool.acquire() as conn:
            stats = await conn.fetchrow(
                """
                SELECT
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'correct') as correct_count,
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'incorrect') as incorrect_count,
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'unlabeled') as unlabeled_count,
                    COUNT(*) as total_count
                FROM diagnoses d
                LEFT JOIN images i ON d.diagnosis_id = i.diagnosis_id
                """
            )
            return dict(stats)

# infrastructure/persistence/repositories/apikey_repo.py
class ApiKeyRepository:
    """API Keyæ•°æ®è®¿é—®å±‚"""

    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool

    async def verify_key(self, api_key_hash: str) -> bool:
        """éªŒè¯API Keyæ˜¯å¦æœ‰æ•ˆ"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                SELECT key_id FROM api_keys
                WHERE api_key_hash = $1
                  AND is_active = TRUE
                  AND (expires_at IS NULL OR expires_at > NOW())
                """,
                api_key_hash
            )

            if row:
                # æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
                await conn.execute(
                    "UPDATE api_keys SET last_used_at = NOW() WHERE key_id = $1",
                    row['key_id']
                )
                return True
            return False

    async def create_key(
        self,
        api_key_hash: str,
        description: str,
        expires_at: Optional[datetime] = None
    ) -> UUID:
        """åˆ›å»ºæ–°çš„API Key"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                INSERT INTO api_keys (api_key_hash, description, expires_at)
                VALUES ($1, $2, $3)
                RETURNING key_id
                """,
                api_key_hash, description, expires_at
            )
            return row['key_id']
```

### 9.5 æ•°æ®åº“è¿æ¥æ± ç®¡ç†

```python
# infrastructure/persistence/database.py
import asyncpg
from typing import Optional

class Database:
    """æ•°æ®åº“è¿æ¥æ± ç®¡ç†"""

    def __init__(self):
        self.pool: Optional[asyncpg.Pool] = None

    async def connect(
        self,
        host: str,
        port: int,
        user: str,
        password: str,
        database: str,
        min_size: int = 5,
        max_size: int = 20
    ):
        """åˆ›å»ºè¿æ¥æ± """
        self.pool = await asyncpg.create_pool(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database,
            min_size=min_size,
            max_size=max_size,
            command_timeout=60
        )

    async def disconnect(self):
        """å…³é—­è¿æ¥æ± """
        if self.pool:
            await self.pool.close()

    async def execute_script(self, sql_file_path: str):
        """æ‰§è¡ŒSQLè„šæœ¬ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰"""
        with open(sql_file_path, 'r') as f:
            sql = f.read()

        async with self.pool.acquire() as conn:
            await conn.execute(sql)

# ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨FastAPIå¯åŠ¨æ—¶ï¼‰
db = Database()

@app.on_event("startup")
async def startup():
    await db.connect(
        host=settings.DB_HOST,
        port=settings.DB_PORT,
        user=settings.DB_USER,
        password=settings.DB_PASSWORD,
        database=settings.DB_NAME
    )

@app.on_event("shutdown")
async def shutdown():
    await db.disconnect()
```

---

## 10. ç¼“å­˜ä¸ Rate Limit ç­–ç•¥

### 12.1 ç¼“å­˜ç­–ç•¥ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰

**ä»…å®ç°VLMå“åº”ç¼“å­˜**ï¼š

```python
# core/cache.py
class RedisCache:
    """Redisç¼“å­˜å°è£…"""

    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)

    async def get_vlm_response(
        self,
        provider: str,
        image_hash: str,
        question_id: str
    ) -> Optional[str]:
        """è·å–VLMå“åº”ç¼“å­˜"""
        key = f"vlm:{provider}:{image_hash}:{question_id}"
        return await self.redis.get(key)

    async def set_vlm_response(
        self,
        provider: str,
        image_hash: str,
        question_id: str,
        response: str,
        ttl: int = 7 * 24 * 3600  # 7å¤©
    ) -> None:
        """ç¼“å­˜VLMå“åº”"""
        key = f"vlm:{provider}:{image_hash}:{question_id}"
        await self.redis.setex(key, ttl, response)

    async def invalidate_pattern(self, pattern: str) -> int:
        """æ‰¹é‡å¤±æ•ˆç¼“å­˜"""
        keys = await self.redis.keys(pattern)
        if keys:
            return await self.redis.delete(*keys)
        return 0
```

**ç¼“å­˜é”®è®¾è®¡**ï¼š

| ç¼“å­˜ç±»å‹ | é”®æ ¼å¼ | TTL | è¯´æ˜ |
|---------|--------|-----|------|
| VLMå“åº” | `vlm:{provider}:{image_hash}:{question_id}` | 7å¤© | ç¼“å­˜VLMé—®ç­”ç»“æœ |
| çŸ¥è¯†åº“ç‰ˆæœ¬ | `kb:version` | æ°¸ä¹… | å½“å‰çŸ¥è¯†åº“ç‰ˆæœ¬ |
| è¯Šæ–­ç»“æœ | `diag:{diagnosis_id}` | 30å¤© | ç¼“å­˜å®Œæ•´è¯Šæ–­ç»“æœ |

### 12.2 Rate Limitç­–ç•¥ï¼ˆMVPä¸å®ç°ï¼‰

MVPé˜¶æ®µä¿¡ä»»ç”¨æˆ·ï¼Œä¸å®ç°Rate Limitã€‚

æœªæ¥æ‰©å±•ï¼ˆv1.2+ï¼‰ï¼š
- åŸºäºAPI Keyçš„é™æµ
- ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•
- æ¯ä¸ªKeyæ¯åˆ†é’Ÿ20æ¬¡è¯·æ±‚

---

## 11. å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡

### 12.1 æƒé™æ¨¡å‹ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰

**å•ç§Ÿæˆ·æ¶æ„ï¼Œä¸¤çº§æƒé™**ï¼š

```python
# æƒé™çº§åˆ«
class UserRole(str, Enum):
    API_USER = "api_user"    # æ™®é€šç”¨æˆ·ï¼šè°ƒç”¨è¯Šæ–­API
    ADMIN = "admin"          # ç®¡ç†å‘˜ï¼šæ‰€æœ‰æƒé™

# æƒé™çŸ©é˜µ
PERMISSION_MATRIX = {
    UserRole.API_USER: [
        "diagnose:execute",
        "history:read_own"
    ],
    UserRole.ADMIN: [
        "diagnose:execute",
        "history:read_all",
        "knowledge:read",
        "knowledge:write",
        "knowledge:reload",
        "statistics:read",
        "apikey:manage"
    ]
}
```

### 12.2 è®¤è¯å®ç°

```python
# middleware/auth.py
class APIKeyMiddleware:
    """API KeyéªŒè¯ä¸­é—´ä»¶"""

    async def __call__(self, request: Request, call_next):
        # è·³è¿‡ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
        if request.url.path in ["/docs", "/openapi.json", "/health"]:
            return await call_next(request)

        # æ£€æŸ¥API Key
        api_key = request.headers.get("X-API-Key")
        if not api_key:
            return JSONResponse(
                status_code=401,
                content={"error": "Missing API Key"}
            )

        # éªŒè¯API Key
        key_info = await verify_api_key(api_key)
        if not key_info or not key_info.is_active:
            return JSONResponse(
                status_code=401,
                content={"error": "Invalid API Key"}
            )

        # æ³¨å…¥ç”¨æˆ·ä¿¡æ¯
        request.state.user = key_info

        return await call_next(request)
```

### 12.3 ç®¡ç†åå°è®¤è¯

```python
# admin/utils/auth.py
def check_admin_auth():
    """Streamlitç®¡ç†åå°è®¤è¯"""
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False

    if not st.session_state.authenticated:
        with st.form("login_form"):
            username = st.text_input("ç”¨æˆ·å")
            password = st.text_input("å¯†ç ", type="password")
            submitted = st.form_submit_button("ç™»å½•")

            if submitted:
                # éªŒè¯ç”¨æˆ·åå¯†ç 
                if verify_admin_credentials(username, password):
                    st.session_state.authenticated = True
                    st.session_state.username = username
                    st.rerun()
                else:
                    st.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
        return False

    return True
```

---

## 12. æµ‹è¯•ç­–ç•¥

### 12.1 å•å…ƒæµ‹è¯•ç­–ç•¥

**æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**ï¼šæ ¸å¿ƒæ¨¡å— â‰¥ 80%

**é‡ç‚¹æµ‹è¯•æ¨¡å—**ï¼š
- `FuzzyMatcher`: é¢œè‰²/å°ºå¯¸æ¨¡ç³ŠåŒ¹é…é€»è¾‘
- `DiagnosisScorer`: åŠ æƒè¯„åˆ†ç®—æ³•
- `VLMClient`: Fallbackæœºåˆ¶
- `FeatureVector`: æ•°æ®éªŒè¯

**æµ‹è¯•ç¤ºä¾‹**ï¼š

```python
# tests/unit/test_matcher.py
import pytest
from infrastructure.ontology.matcher import FuzzyMatcher

class TestFuzzyMatcher:
    @pytest.fixture
    def matcher(self):
        return FuzzyMatcher()

    def test_color_exact_match(self, matcher):
        """æµ‹è¯•é¢œè‰²ç²¾ç¡®åŒ¹é…"""
        assert matcher.match_color("black", "black") == True
        assert matcher.match_color("black", "white") == False

    def test_color_group_match(self, matcher):
        """æµ‹è¯•åŒè‰²ç³»åŒ¹é…"""
        assert matcher.match_color("black", "dark_brown") == True
        assert matcher.match_color("yellow", "light_yellow") == True
        assert matcher.match_color("black", "yellow") == False

    def test_size_fuzzy_match(self, matcher):
        """æµ‹è¯•å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆÂ±1çº§åˆ«ï¼‰"""
        assert matcher.match_size("medium", "medium") == True
        assert matcher.match_size("medium", "medium_small") == True
        assert matcher.match_size("medium", "large") == True
        assert matcher.match_size("small", "large") == False
```

### 12.2 é›†æˆæµ‹è¯•ç­–ç•¥

**æµ‹è¯•åœºæ™¯**ï¼š
- å®Œæ•´è¯Šæ–­æµç¨‹ï¼ˆå›¾ç‰‡ä¸Šä¼ â†’ç‰¹å¾æå–â†’ç–¾ç—…åŒ¹é…â†’ç»“æœè¿”å›ï¼‰
- çŸ¥è¯†åº“çƒ­æ›´æ–°ï¼ˆä¿®æ”¹JSONâ†’è§¦å‘é‡è½½â†’éªŒè¯ç”Ÿæ•ˆï¼‰
- VLMé™çº§æµç¨‹ï¼ˆä¸»Providerå¤±è´¥â†’è‡ªåŠ¨åˆ‡æ¢â†’è¿”å›ç»“æœï¼‰

```python
# tests/integration/test_diagnosis_api.py
@pytest.mark.asyncio
async def test_complete_diagnosis_flow():
    """æµ‹è¯•å®Œæ•´è¯Šæ–­æµç¨‹"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # å‡†å¤‡æµ‹è¯•å›¾ç‰‡
        with open("tests/fixtures/rose_black_spot.jpg", "rb") as f:
            files = {"image": ("test.jpg", f, "image/jpeg")}

        # å‘é€è¯Šæ–­è¯·æ±‚
        response = await client.post(
            "/api/v1/diagnose",
            files=files,
            headers={"X-API-Key": "test_key"}
        )

        # éªŒè¯å“åº”
        assert response.status_code == 200
        data = response.json()
        assert data["diagnosis"]["disease_id"] == "rose_black_spot"
        assert data["diagnosis"]["level"] == "confirmed"
        assert data["diagnosis"]["confidence"] >= 0.85
```

### 12.3 E2Eæµ‹è¯•ç­–ç•¥

ä½¿ç”¨Playwrightæµ‹è¯•Webç•Œé¢ï¼š

```python
# tests/e2e/test_diagnosis_flow.py
from playwright.async_api import async_playwright

async def test_web_diagnosis_flow():
    """æµ‹è¯•Webè¯Šæ–­å®Œæ•´æµç¨‹"""
    async with async_playwright() as p:
        browser = await p.chromium.launch()
        page = await browser.new_page()

        # è®¿é—®è¯Šæ–­é¡µé¢
        await page.goto("http://localhost:3000/diagnose")

        # ä¸Šä¼ å›¾ç‰‡
        await page.set_input_files(
            'input[type="file"]',
            "tests/fixtures/rose_black_spot.jpg"
        )

        # ç‚¹å‡»è¯Šæ–­æŒ‰é’®
        await page.click('button:has-text("å¼€å§‹è¯Šæ–­")')

        # ç­‰å¾…ç»“æœ
        await page.wait_for_selector(".diagnosis-result", timeout=30000)

        # éªŒè¯ç»“æœæ˜¾ç¤º
        result_text = await page.text_content(".disease-name")
        assert "ç«ç‘°é»‘æ–‘ç—…" in result_text

        await browser.close()
```

---

## 13. æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼

| ID | ç±»å‹ | æè¿° | å‰ç½®æ¡ä»¶ | è¾“å…¥ | é¢„æœŸè¾“å‡º | è¦†ç›–ç‚¹ |
|----|------|------|----------|------|----------|--------|
| TC01 | åŠŸèƒ½ | æ­£å¸¸è¯Šæ–­æµç¨‹ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | ç«ç‘°é»‘æ–‘ç—…å›¾ç‰‡ | è¿”å›confirmedè¯Šæ–­ï¼Œconfidenceâ‰¥0.85 | å®Œæ•´è¯Šæ–­æµç¨‹ |
| TC02 | è¾¹ç•Œ | Q0.0éæ¤ç‰©å›¾ç‰‡ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | åŠ¨ç‰©å›¾ç‰‡ | è¿”å›"ä¸æ”¯æŒçš„å›¾ç‰‡ç±»å‹" | Q0å†…å®¹ç±»å‹è¿‡æ»¤ |
| TC03 | è¾¹ç•Œ | Q0.1éèŠ±å‰æ¤ç‰© | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | è”¬èœå›¾ç‰‡ | è¿”å›"ä»…æ”¯æŒèŠ±å‰ç–¾ç—…è¯Šæ–­" | Q0æ¤ç‰©ç±»åˆ«è¿‡æ»¤ |
| TC04 | è¾¹ç•Œ | Q0.2æœªè¯†åˆ«èŠ±å± | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | æœªçŸ¥èŠ±å‰å›¾ç‰‡ | è¿”å›genus="Other" | Q0èŠ±å±è¯†åˆ« |
| TC05 | è¾¹ç•Œ | Q0.5å¥åº·æ ·æœ¬ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | å¥åº·ç«ç‘°å›¾ç‰‡ | è¿”å›"æœªå‘ç°å¼‚å¸¸" | Q0å¼‚å¸¸åˆ¤æ–­ |
| TC06 | åŠŸèƒ½ | Q1ç—‡çŠ¶ç±»å‹necrosis | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | åæ­»æ–‘ç‚¹å›¾ç‰‡ | symptom_type="necrosis_spot" | Q1åŠ¨æ€ç‰¹å¾æå– |
| TC07 | åŠŸèƒ½ | Q1ç—‡çŠ¶ç±»å‹powdery | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | ç™½ç²‰ç—…å›¾ç‰‡ | symptom_type="powdery_coating" | Q1åˆ†æ”¯é€»è¾‘ |
| TC08 | ç®—æ³• | é«˜ç½®ä¿¡åº¦è¯Šæ–­ | ç‰¹å¾å®Œå…¨åŒ¹é… | å…¸å‹é»‘æ–‘ç—…å›¾ç‰‡ | level="confirmed", scoreâ‰¥0.85 | ç½®ä¿¡åº¦åˆ†å±‚å†³ç­– |
| TC09 | ç®—æ³• | ä¸­ç½®ä¿¡åº¦è¯Šæ–­ | éƒ¨åˆ†ç‰¹å¾åŒ¹é… | æ¨¡ç³Šç—‡çŠ¶å›¾ç‰‡ | level="suspected", 0.6â‰¤score<0.85 | ç–‘ä¼¼è¯Šæ–­é€»è¾‘ |
| TC10 | ç®—æ³• | ä½ç½®ä¿¡åº¦VLMå…œåº• | çŸ¥è¯†åº“å¤–ç–¾ç—… | æœªçŸ¥ç–¾ç—…å›¾ç‰‡ | è°ƒç”¨VLMå¼€æ”¾è¯Šæ–­ï¼Œæ ‡è®°"VLMæ¨æµ‹" | VLMå…œåº•ç­–ç•¥ |
| TC11 | ç³»ç»Ÿ | çŸ¥è¯†åº“çƒ­æ›´æ–° | ç®¡ç†å‘˜æƒé™ | POST /admin/reload | æ–°ç‰ˆæœ¬ç«‹å³ç”Ÿæ•ˆ | çƒ­æ›´æ–°æœºåˆ¶ |
| TC12 | å®¹é”™ | VLMè¶…æ—¶é™çº§ | Qwenä¸å¯ç”¨ | è¯Šæ–­è¯·æ±‚ | è‡ªåŠ¨åˆ‡æ¢åˆ°ChatGPT | Fallbackæœºåˆ¶ |
| TC13 | ç®—æ³• | é¢œè‰²æ¨¡ç³ŠåŒ¹é… | é¢œè‰²è§‚å¯Ÿè¯¯å·® | observed="dark_brown", expected="black" | åŒ¹é…æˆåŠŸï¼ˆåŒè‰²ç³»ï¼‰ | COLOR_GROUPS |
| TC14 | ç®—æ³• | å°ºå¯¸æ¨¡ç³ŠåŒ¹é… | å°ºå¯¸è§‚å¯Ÿè¯¯å·® | observed="medium_small", expected="medium" | åŒ¹é…æˆåŠŸï¼ˆÂ±1çº§åˆ«ï¼‰ | SIZE_ORDER |
| TC15 | ç®—æ³• | Majorç‰¹å¾æƒé‡è®¡ç®— | ä¸»è¦ç‰¹å¾åŒ¹é… | symptom_typeåŒ¹é… | major_score += 0.5 | åŠ æƒè¯„åˆ†0.8 |
| TC16 | ç®—æ³• | Minorç‰¹å¾æƒé‡è®¡ç®— | æ¬¡è¦ç‰¹å¾åŒ¹é… | locationåŒ¹é… | minor_score += 0.1 | åŠ æƒè¯„åˆ†0.15 |
| TC17 | ç®—æ³• | Optionalç‰¹å¾æƒé‡ | å¯é€‰ç‰¹å¾åŒ¹é… | sizeåŒ¹é… | optional_score += 0.03 | åŠ æƒè¯„åˆ†0.05 |
| TC18 | åŠŸèƒ½ | ç®¡ç†åå°ç–¾ç—…ç¼–è¾‘ | ç®¡ç†å‘˜ç™»å½• | ä¿®æ”¹ç–¾ç—…JSON | ä¿å­˜æˆåŠŸï¼Œé‡è½½ç”Ÿæ•ˆ | çŸ¥è¯†åº“ç®¡ç† |
| TC19 | è¾¹ç•Œ | é”™è¯¯å›¾ç‰‡æ ¼å¼ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | BMPæ ¼å¼å›¾ç‰‡ | è¿”å›400é”™è¯¯ | æ ¼å¼éªŒè¯ |
| TC20 | å®¹é”™ | æ•°æ®åº“è¿æ¥å¤±è´¥ | PGæœåŠ¡åœæ­¢ | è¯Šæ–­è¯·æ±‚ | è¿”å›503æœåŠ¡ä¸å¯ç”¨ | æ•°æ®åº“å®¹é”™ |
| TC21 | å®‰å…¨ | API KeyéªŒè¯-æœ‰æ•ˆ | æœ‰æ•ˆKey | Headerå«X-API-Key | è¯·æ±‚æˆåŠŸ | è®¤è¯æœºåˆ¶ |
| TC22 | å®‰å…¨ | API KeyéªŒè¯-æ— æ•ˆ | æ— æ•ˆKey | é”™è¯¯çš„API Key | è¿”å›401æœªæˆæƒ | è®¤è¯æ‹’ç» |
| TC23 | å®‰å…¨ | API KeyéªŒè¯-ç¼ºå¤± | æ— Header | ç¼ºå°‘X-API-Key | è¿”å›401 | è®¤è¯æ£€æŸ¥ |
| TC24 | åŠŸèƒ½ | å›¾ç‰‡å­˜å‚¨åˆ†ç±» | è¯Šæ–­å®Œæˆ | ç«ç‘°å›¾ç‰‡ | å­˜å‚¨åˆ°unlabeled/rose/ç›®å½• | å­˜å‚¨ç­–ç•¥ |
| TC25 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰æ—¥æœŸ | æœ‰å†å²è®°å½• | start_date, end_date | è¿”å›æ—¥æœŸèŒƒå›´å†…è®°å½• | æŸ¥è¯¢åŠŸèƒ½ |
| TC26 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰æ¤ç‰© | æœ‰å†å²è®°å½• | plant_genus="Rosa" | è¿”å›ç«ç‘°ç›¸å…³è®°å½• | ç­›é€‰é€»è¾‘ |
| TC27 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰ç½®ä¿¡åº¦ | æœ‰å†å²è®°å½• | level="confirmed" | è¿”å›ç¡®è¯Šè®°å½• | ç½®ä¿¡åº¦ç­›é€‰ |
| TC28 | å¹¶å‘ | 10ä¸ªå¹¶å‘è¯Šæ–­ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | 10ä¸ªå¹¶å‘è¯·æ±‚ | å…¨éƒ¨æˆåŠŸï¼Œæ— å†²çª | å¹¶å‘å¤„ç† |
| TC29 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£complete | completeå›¾ç‰‡ | completeness="complete" | modifier=1.0 | å®Œæ•´æ€§ç³»æ•° |
| TC30 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£partial | éƒ¨åˆ†å›¾ç‰‡ | completeness="partial" | modifier=0.8 | éƒ¨åˆ†ä¿®æ­£ |
| TC31 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£close_up | ç‰¹å†™å›¾ç‰‡ | completeness="close_up" | modifier=0.6,è·³è¿‡åˆ†å¸ƒ | ç‰¹å†™å¤„ç† |
| TC32 | åŠŸèƒ½ | Q0æ–°å¢å­—æ®µè¾“å‡º | è¯Šæ–­å®Œæˆ | ä»»æ„å›¾ç‰‡ | feature_vectorå«content_typeç­‰ | ç‰¹å¾å‘é‡å®Œæ•´æ€§ |
| TC33 | æ€§èƒ½ | è¯Šæ–­å»¶è¿ŸP95 | ç³»ç»Ÿæ­£å¸¸ | 100æ¬¡è¯Šæ–­è¯·æ±‚ | P95å»¶è¿Ÿâ‰¤30ç§’ | æ€§èƒ½æŒ‡æ ‡ |
| TC34 | å®¹é”™ | VLMå…¨éƒ¨å¤±è´¥ | æ‰€æœ‰Providerä¸å¯ç”¨ | è¯Šæ–­è¯·æ±‚ | è¿”å›"VLMæœåŠ¡ä¸å¯ç”¨"é”™è¯¯ | æç«¯å®¹é”™ |
| TC35 | åŠŸèƒ½ | ç¼“å­˜å‘½ä¸­ | ç›¸åŒå›¾ç‰‡äºŒæ¬¡è¯Šæ–­ | é‡å¤çš„å›¾ç‰‡+é—®é¢˜ | ä»ç¼“å­˜è¿”å›ï¼Œ<1ç§’å“åº” | VLMç¼“å­˜æœºåˆ¶ |

---

## 14. éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ

### 15.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²

**ç¯å¢ƒå‡†å¤‡**ï¼š

```bash
# 1. å®‰è£…PostgreSQL 15
brew install postgresql@15  # macOS
sudo apt install postgresql-15  # Ubuntu

# 2. å®‰è£…Redis
brew install redis  # macOS
sudo apt install redis-server  # Ubuntu

# 3. åˆ›å»ºæ•°æ®åº“
createdb phytooracle_dev

# 4. åˆå§‹åŒ–è¡¨ç»“æ„
psql phytooracle_dev < backend/scripts/init_db.sql
```

**åç«¯å¯åŠ¨**ï¼š

```bash
cd backend

# å®‰è£…ä¾èµ–
poetry install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envï¼Œå¡«å†™æ•°æ®åº“è¿æ¥ã€VLM API Keyç­‰

# è¿è¡ŒæœåŠ¡
python -m apps.api.main
# æˆ–ä½¿ç”¨uvicornçƒ­é‡è½½
uvicorn apps.api.main:app --reload --host 0.0.0.0 --port 8000
```

**å‰ç«¯å¯åŠ¨**ï¼š

```bash
cd frontend

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
# è®¿é—® http://localhost:3000
```

**ç®¡ç†åå°**ï¼š

```bash
cd backend

# å¯åŠ¨Streamlit
streamlit run apps/admin/app.py --server.port 8501
# è®¿é—® http://localhost:8501
```

### 15.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**æœåŠ¡å™¨è¦æ±‚**ï¼š
- CPU: 4æ ¸+
- å†…å­˜: 8GB+
- ç¡¬ç›˜: 100GB+
- OS: Ubuntu 22.04 LTS

**éƒ¨ç½²æ­¥éª¤**ï¼š

```bash
# 1. å…‹éš†ä»£ç 
git clone https://github.com/yourorg/phytooracle.git
cd phytooracle

# 2. å®‰è£…ç³»ç»Ÿä¾èµ–
sudo apt update
sudo apt install -y python3.10 python3.10-venv postgresql-15 redis-server nginx

# 3. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.10 -m venv venv
source venv/bin/activate

# 4. å®‰è£…Pythonä¾èµ–
cd backend
pip install -r requirements.txt

# 5. é…ç½®æ•°æ®åº“
sudo -u postgres createuser phytooracle
sudo -u postgres createdb -O phytooracle phytooracle_prod
psql -U phytooracle phytooracle_prod < scripts/init_db.sql

# 6. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.production
# ç¼–è¾‘é…ç½®æ–‡ä»¶

# 7. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆä½¿ç”¨Supervisorç®¡ç†ï¼‰
sudo cp deploy/supervisor/phytooracle.conf /etc/supervisor/conf.d/
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start phytooracle:*

# 8. æ„å»ºå‰ç«¯
cd ../frontend
npm install
npm run build

# 9. é…ç½®Nginx
sudo cp deploy/nginx/phytooracle.conf /etc/nginx/sites-available/
sudo ln -s /etc/nginx/sites-available/phytooracle.conf /etc/nginx/sites-enabled/
sudo nginx -s reload
```

**Nginxé…ç½®ç¤ºä¾‹**ï¼š

```nginx
# /etc/nginx/sites-available/phytooracle.conf
upstream backend {
    server 127.0.0.1:8000;
    server 127.0.0.1:8001;
    server 127.0.0.1:8002;
    server 127.0.0.1:8003;
}

server {
    listen 80;
    server_name api.phytooracle.com;

    # APIè½¬å‘
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # è¶…æ—¶è®¾ç½®ï¼ˆVLMè°ƒç”¨å¯èƒ½è¾ƒæ…¢ï¼‰
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™æ€æ–‡ä»¶
    location / {
        root /var/www/phytooracle/frontend/out;
        try_files $uri $uri.html $uri/ =404;
    }

    # ç®¡ç†åå°
    location /admin/ {
        proxy_pass http://127.0.0.1:8501/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**Supervisoré…ç½®**ï¼š

```ini
# /etc/supervisor/conf.d/phytooracle.conf
[group:phytooracle]
programs=backend-8000,backend-8001,backend-8002,backend-8003

[program:backend-8000]
command=/home/phytooracle/venv/bin/uvicorn apps.api.main:app --host 127.0.0.1 --port 8000
directory=/home/phytooracle/backend
user=phytooracle
autostart=true
autorestart=true
stdout_logfile=/var/log/phytooracle/backend-8000.log
stderr_logfile=/var/log/phytooracle/backend-8000-error.log

# ç±»ä¼¼é…ç½®8001-8003ç«¯å£...
```

### 15.3 CI/CDæ–¹æ¡ˆï¼ˆMVPæ‰‹å·¥éƒ¨ç½²ï¼‰

MVPé˜¶æ®µé‡‡ç”¨æ‰‹å·¥éƒ¨ç½²ï¼Œæ­¥éª¤ï¼š

```bash
# 1. æœ¬åœ°æµ‹è¯•é€šè¿‡
pytest backend/tests/

# 2. æ¨é€ä»£ç 
git add .
git commit -m "feat: xxx"
git push origin main

# 3. æœåŠ¡å™¨æ‹‰å–æ›´æ–°
ssh phytooracle@server
cd /home/phytooracle
git pull origin main

# 4. æ›´æ–°ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰
source venv/bin/activate
pip install -r backend/requirements.txt

# 5. é‡å¯æœåŠ¡
sudo supervisorctl restart phytooracle:*

# 6. éªŒè¯æœåŠ¡
curl http://localhost:8000/health
```

**æœªæ¥CI/CDæ”¹è¿›ï¼ˆv1.3+ï¼‰**ï¼š
- ä½¿ç”¨GitHub Actionsè‡ªåŠ¨åŒ–æµ‹è¯•
- Dockerå®¹å™¨åŒ–éƒ¨ç½²
- è“ç»¿éƒ¨ç½²ç­–ç•¥
- è‡ªåŠ¨å›æ»šæœºåˆ¶

---

## 15. æœªæ¥æ‰©å±•ç‚¹æ¸…å•

### 15.1 åŠŸèƒ½æ‰©å±•ï¼ˆv1.2ï¼‰

| æ‰©å±•é¡¹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | ä»·å€¼ |
|--------|--------|----------|------|
| **å¤šç§Ÿæˆ·éš”ç¦»** | P1 | 80h | æ”¯æŒSaaSå¤šå®¢æˆ· |
| **Dockerå®¹å™¨åŒ–** | P1 | 40h | ç®€åŒ–éƒ¨ç½²è¿ç»´ |
| **Rate Limit** | P2 | 20h | é˜²æ­¢APIæ»¥ç”¨ |
| **å›¾ç‰‡å»é‡ç¼“å­˜** | P2 | 16h | èŠ‚çœVLMæˆæœ¬ |
| **æ‰¹é‡è¯Šæ–­API** | P2 | 24h | æå‡æ•ˆç‡ |
| **WebSocketè¿›åº¦æ¨é€** | P3 | 32h | æ”¹å–„ç”¨æˆ·ä½“éªŒ |

### 15.2 åŠŸèƒ½æ‰©å±•ï¼ˆv1.3+ï¼‰

| æ‰©å±•é¡¹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | ä»·å€¼ |
|--------|--------|----------|------|
| **æ”¯ä»˜ä¸é…é¢ç®¡ç†** | P1 | 120h | å•†ä¸šåŒ–èƒ½åŠ› |
| **CI/CDè‡ªåŠ¨åŒ–** | P1 | 40h | æå‡å‘å¸ƒæ•ˆç‡ |
| **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** | P2 | 60h | æ”¯æŒå¤§æ‰¹é‡å¤„ç† |
| **Treatment Ontology** | P2 | 80h | è¯Šæ–­-æ²»ç–—é—­ç¯ |
| **ç§»åŠ¨ç«¯SDK** | P3 | 160h | æ‰©å±•ä½¿ç”¨åœºæ™¯ |
| **å¤šè¯­è¨€æ”¯æŒ** | P3 | 80h | å›½é™…åŒ– |

### 15.3 æŠ€æœ¯å€ºåŠ¡æ¸…ç†

- å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–ç‡åˆ°90%+
- é‡æ„VLM Promptç®¡ç†
- ä¼˜åŒ–çŸ¥è¯†åº“åŠ è½½æ€§èƒ½
- ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰
- å®ç°æ—¥å¿—èšåˆåˆ†æ

### 15.4 çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’

**v1.2ç›®æ ‡**ï¼ˆåŸºäºæ•°æ®é›†ï¼‰ï¼š
- Hibiscusï¼ˆæœ¨æ§¿ï¼‰- 4ç§ç–¾ç—…
- Crape Jasmineï¼ˆç‹—ç‰™èŠ±ï¼‰- 3ç§ç–¾ç—…
- Night-flowering Jasmineï¼ˆå¤œæ¥é¦™ï¼‰- 3ç§ç–¾ç—…
- Dwarf White Bauhiniaï¼ˆç¾Šè¹„ç”²ï¼‰- 3ç§ç–¾ç—…

**v1.3ç›®æ ‡**ï¼ˆå¸‚åœºéœ€æ±‚ï¼‰ï¼š
- å…°èŠ±å±ï¼ˆOrchidaceaeï¼‰- é«˜ç«¯å¸‚åœº
- èŠèŠ±å±ï¼ˆChrysanthemumï¼‰- å¤§ä¼—å¸‚åœº
- ç™¾åˆå±ï¼ˆLiliumï¼‰- é²œåˆ‡èŠ±å¸‚åœº

---

## æ–‡æ¡£ä¿®è®¢è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| v1.1 | 2025-11-11 21:27:44 | é‡æ„ç¬¬5ç« ï¼šæ˜ç¡®åŒºåˆ†åº”ç”¨æœåŠ¡å±‚å’ŒåŸºç¡€è®¾æ–½æ¨¡å—å±‚ï¼Œè¡¥å……åˆ†å±‚æ¶æ„å›¾å’Œè°ƒç”¨å…³ç³»çŸ©é˜µï¼Œè¯¦ç»†å®šä¹‰æ¯ä¸ªæœåŠ¡/æ¨¡å—çš„èŒè´£ã€ä¾èµ–å…³ç³»å’Œå…³é”®æ¥å£ | ç³»ç»Ÿæ¶æ„å¸ˆ |
| v1.0 | 2025-11-11 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ14ç« èŠ‚è¯¦ç»†è®¾è®¡ | ç³»ç»Ÿæ¶æ„å¸ˆ |

---
