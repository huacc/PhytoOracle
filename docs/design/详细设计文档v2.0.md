# PhytoOracle MVP è¯¦ç»†è®¾è®¡æ–‡æ¡£ v2.0

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**åˆ›å»ºæ—¶é—´**: 2025-11-14
**åŸºäºç‰ˆæœ¬**: v1.0
**ç¼–å†™è€…**: ç³»ç»Ÿæ¶æ„å¸ˆ
**çŠ¶æ€**: è¯„å®¡ä¸­

---

## ğŸ“‹ v2.0 ç‰ˆæœ¬è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç‹¬ç«‹æ–‡æ¡£ï¼ŒåŸºäºv1.0æ‰©å±•è€Œæ¥ï¼Œä¸»è¦å˜æ›´å¦‚ä¸‹:

### ğŸ”„ æ ¸å¿ƒå˜æ›´
1. **åˆ é™¤å†…å®¹**: åˆ é™¤ç¬¬11ç« "å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡"ï¼ˆé¡¹ç›®éœ€æ±‚ä¸­ä¸éœ€è¦ï¼‰
2. **APIè®¾è®¡æ‰©å±•** (ç¬¬6ç« ): æ‰©å±•è¯Šæ–­APIè¿”å›æ ¼å¼ï¼Œæ–°å¢çŸ¥è¯†åº“ç®¡ç†APIï¼ˆ9ä¸ªæ¥å£ï¼‰ã€æœ¬ä½“ç®¡ç†APIï¼ˆ2ä¸ªæ¥å£ï¼‰ã€æ‰¹é‡è¯Šæ–­APIï¼ˆ3ä¸ªæ¥å£ï¼‰ã€å›¾ç‰‡ç®¡ç†APIï¼ˆ2ä¸ªæ¥å£ï¼‰
3. **ç›®å½•ç»“æ„æ›´æ–°** (ç¬¬4ç« ): æ–°å¢å‰ç«¯ç›®å½•ç»“æ„ï¼ˆReact/Vueå®Œæ•´é¡¹ç›®ç»“æ„ï¼‰
4. **å‰ç«¯æ¶æ„è®¾è®¡** (æ–°å¢ç¬¬15ç« ): React/VueæŠ€æœ¯é€‰å‹ã€é¡¹ç›®åˆå§‹åŒ–ã€4ä¸ªç•Œé¢è®¾è®¡
5. **å‰åç«¯è”è°ƒæŒ‡å—** (æ–°å¢ç¬¬16ç« ): CORSé…ç½®ã€APIæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹
6. **æ–‡æ¡£ä¿®è®¢è®°å½•** (æ–°å¢ç¬¬17ç« ): è¯¦ç»†çš„ç‰ˆæœ¬å†å²å’Œå˜æ›´è¯´æ˜
7. **ç« èŠ‚é‡æ–°ç¼–å·**: åˆ é™¤ç¬¬11ç« åï¼ŒåŸ12-15ç« é‡æ–°ç¼–å·ä¸º11-14ç« 

### ğŸ“ ç« èŠ‚ä¿®æ”¹æ ‡è®°
- âœ… **æ¥è‡ªv1.0**: å†…å®¹æ¥è‡ªv1.0ï¼Œä¿æŒä¸å˜æˆ–ç•¥æœ‰è°ƒæ•´
- ğŸ”„ **å·²ä¿®æ”¹**: å†…å®¹å·²æ›´æ–°æ‰©å±•
- âœ¨ **æ–°å¢**: v2.0æ–°å¢çš„å†…å®¹

### ğŸ“Š æ–‡æ¡£ç»Ÿè®¡
- **æ€»ç« èŠ‚æ•°**: 17ç« ï¼ˆv1.0ä¸º15ç« ï¼‰
- **æ€»è¡Œæ•°**: çº¦8100è¡Œï¼ˆv1.0çº¦3956è¡Œï¼‰
- **æ–°å¢å†…å®¹**: çº¦4144è¡Œï¼ˆå‰ç«¯æ¶æ„ã€è”è°ƒæŒ‡å—ã€ä¿®è®¢è®°å½•ã€15ä¸ªæ–°å¢APIï¼‰
- **APIæ¥å£æ•°**: 26ä¸ªï¼ˆv1.0ä¸º11ä¸ªï¼Œæ–°å¢15ä¸ªï¼‰

---

## ç›®å½•ç´¢å¼•

- [1. æ¶æ„æ€»è§ˆ](#1-æ¶æ„æ€»è§ˆ) âœ…
  - [1.1 ç³»ç»Ÿæ¶æ„å›¾](#11-ç³»ç»Ÿæ¶æ„å›¾)
  - [1.2 éƒ¨ç½²æ¶æ„å›¾](#12-éƒ¨ç½²æ¶æ„å›¾)
  - [1.3 æ ¸å¿ƒç±»å›¾](#13-æ ¸å¿ƒç±»å›¾)
- [2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜](#2-é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜) âœ…
  - [2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)](#21-å•ä¸€èŒè´£åŸåˆ™-srp)
  - [2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)](#22-ä¾èµ–å€’ç½®åŸåˆ™-dip)
  - [2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)](#23-æ¥å£éš”ç¦»åŸåˆ™-isp)
  - [2.4 å±‚æ¬¡éš”ç¦»](#24-å±‚æ¬¡éš”ç¦»)
  - [2.5 å¾ªç¯ä¾èµ–æ£€æµ‹](#25-å¾ªç¯ä¾èµ–æ£€æµ‹)
- [3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰](#3-åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ddd-é£æ ¼) âœ…
  - [3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚](#31-é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚)
  - [3.2 èšåˆæ ¹è®¾è®¡](#32-èšåˆæ ¹è®¾è®¡)
  - [3.3 å€¼å¯¹è±¡è®¾è®¡](#33-å€¼å¯¹è±¡è®¾è®¡)
  - [3.4 é¢†åŸŸæœåŠ¡](#34-é¢†åŸŸæœåŠ¡)
- [4. å®Œæ•´ç›®å½•ç»“æ„](#4-å®Œæ•´ç›®å½•ç»“æ„) ğŸ”„
- [5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡](#5-æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡) âœ…
  - [5.1 æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ](#51-æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ)
  - [5.2 åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰](#52-åº”ç”¨æœåŠ¡application-services)
  - [5.3 åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰](#53-åŸºç¡€è®¾æ–½æ¨¡å—infrastructure-modules)
  - [5.4 æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº](#54-æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº)
  - [5.5 å…³é”®è®¾è®¡åŸåˆ™](#55-å…³é”®è®¾è®¡åŸåˆ™)
  - [5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰](#56-æç¤ºè¯å·¥ç¨‹æ¡†æ¶æ ¸å¿ƒåŸºç¡€è®¾æ–½)
- [6. API è®¾è®¡ï¼ˆOpenAPI è§„èŒƒç‰‡æ®µï¼‰](#6-api-è®¾è®¡openapi-è§„èŒƒç‰‡æ®µ) ğŸ”„
- [7. æ•°æ®æ¨¡å‹ï¼ˆPydantic V2 å®Œæ•´ä»£ç ï¼‰](#7-æ•°æ®æ¨¡å‹pydantic-v2-å®Œæ•´ä»£ç ) âœ…
- [8. çŸ¥è¯†æœ¬ä½“è®¾è®¡ï¼ˆJSON Schema + ç¤ºä¾‹ï¼‰](#8-çŸ¥è¯†æœ¬ä½“è®¾è®¡json-schema--ç¤ºä¾‹) âœ…
  - [8.1 Disease Ontology Schema](#81-disease-ontology-schema)
  - [8.2 Disease Ontology ç¤ºä¾‹](#82-disease-ontology-ç¤ºä¾‹)
  - [8.3 Feature Ontology Schema](#83-feature-ontology-schema)
  - [8.4 Host-Disease Ontology Schema](#84-host-disease-ontology-schema)
- [9. æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆPostgreSQL DDLï¼‰](#9-æ•°æ®åº“è¡¨è®¾è®¡postgresql-ddl) âœ…
  - [9.1 è¡¨ç»“æ„æ€»è§ˆ](#91-è¡¨ç»“æ„æ€»è§ˆ)
  - [9.2 å®Œæ•´DDLè¯­å¥](#92-å®Œæ•´ddlè¯­å¥)
  - [9.3 åˆå§‹åŒ–æ•°æ®è„šæœ¬](#93-åˆå§‹åŒ–æ•°æ®è„šæœ¬)
  - [9.4 æ•°æ®åº“è®¿é—®å±‚æ¥å£ï¼ˆRepositoryæ¨¡å¼ï¼‰](#94-æ•°æ®åº“è®¿é—®å±‚æ¥å£repositoryæ¨¡å¼)
  - [9.5 æ•°æ®åº“è¿æ¥æ± ç®¡ç†](#95-æ•°æ®åº“è¿æ¥æ± ç®¡ç†)
- [10. ç¼“å­˜ä¸ Rate Limit ç­–ç•¥](#10-ç¼“å­˜ä¸-rate-limit-ç­–ç•¥) âœ…
  - [10.1 ç¼“å­˜ç­–ç•¥ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰](#101-ç¼“å­˜ç­–ç•¥mvpç®€åŒ–ç‰ˆ)
  - [10.2 Rate Limitç­–ç•¥ï¼ˆMVPä¸å®ç°ï¼‰](#102-rate-limitç­–ç•¥mvpä¸å®ç°)
- [11. æµ‹è¯•ç­–ç•¥](#11-æµ‹è¯•ç­–ç•¥) âœ…
  - [11.1 å•å…ƒæµ‹è¯•ç­–ç•¥](#111-å•å…ƒæµ‹è¯•ç­–ç•¥)
  - [11.2 é›†æˆæµ‹è¯•ç­–ç•¥](#112-é›†æˆæµ‹è¯•ç­–ç•¥)
  - [11.3 E2Eæµ‹è¯•ç­–ç•¥](#113-e2eæµ‹è¯•ç­–ç•¥)
- [12. æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼](#12-æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼) âœ…
- [13. éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ](#13-éƒ¨ç½²ä¸-cicd-æ–¹æ¡ˆ) âœ…
  - [13.1 å¼€å‘ç¯å¢ƒéƒ¨ç½²](#131-å¼€å‘ç¯å¢ƒéƒ¨ç½²)
  - [13.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#132-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
  - [13.3 CI/CDæ–¹æ¡ˆï¼ˆMVPæ‰‹å·¥éƒ¨ç½²ï¼‰](#133-cicdæ–¹æ¡ˆmvpæ‰‹å·¥éƒ¨ç½²)
- [14. æœªæ¥æ‰©å±•ç‚¹æ¸…å•](#14-æœªæ¥æ‰©å±•ç‚¹æ¸…å•) âœ…
  - [14.1 åŠŸèƒ½æ‰©å±•ï¼ˆv1.2ï¼‰](#141-åŠŸèƒ½æ‰©å±•v12)
  - [14.2 åŠŸèƒ½æ‰©å±•ï¼ˆv1.3+ï¼‰](#142-åŠŸèƒ½æ‰©å±•v13)
  - [14.3 æŠ€æœ¯å€ºåŠ¡æ¸…ç†](#143-æŠ€æœ¯å€ºåŠ¡æ¸…ç†)
  - [14.4 çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’](#144-çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’)
- [15. å‰ç«¯æ¶æ„è®¾è®¡](#15-å‰ç«¯æ¶æ„è®¾è®¡) âœ¨
- [16. å‰åç«¯è”è°ƒæŒ‡å—](#16-å‰åç«¯è”è°ƒæŒ‡å—) âœ¨
- [17. æ–‡æ¡£ä¿®è®¢è®°å½•](#17-æ–‡æ¡£ä¿®è®¢è®°å½•) âœ¨

---

## 1. æ¶æ„æ€»è§ˆ

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    %% å‰ç«¯å±‚
    subgraph Frontend["å‰ç«¯å±‚ (Frontend Layer)"]
        Web["Webè¯Šæ–­ç•Œé¢<br/>(Next.js 15)"]
        Admin["ç®¡ç†åå°<br/>(Streamlit)"]
    end

    %% APIç½‘å…³å±‚
    subgraph Gateway["APIå±‚ (API Gateway)"]
        API["FastAPI Server"]
        Auth["è®¤è¯ä¸­é—´ä»¶<br/>(API Key)"]
    end

    %% ä¸šåŠ¡é€»è¾‘å±‚
    subgraph Business["ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic)"]
        DiagService["è¯Šæ–­æœåŠ¡<br/>(Diagnosis Service)"]
        KnowledgeService["çŸ¥è¯†åº“æœåŠ¡<br/>(Knowledge Service)"]
        ImageService["å›¾ç‰‡æœåŠ¡<br/>(Image Service)"]
    end

    %% é¢†åŸŸæ¨¡å‹å±‚
    subgraph Domain["é¢†åŸŸæ¨¡å‹å±‚ (Domain Models)"]
        DM1["Disease Ontology"]
        DM2["Feature Ontology"]
        DM3["Plant Ontology"]
        DM4["Host-Disease Relations"]
    end

    %% åŸºç¡€è®¾æ–½å±‚
    subgraph Infra["åŸºç¡€è®¾æ–½å±‚ (Infrastructure)"]
        PromptFramework["æç¤ºè¯æ¡†æ¶<br/>(PROOF Framework)"]
        VLM["VLMå®¢æˆ·ç«¯<br/>(Instructor + Fallback)"]
        OntologyLoader["çŸ¥è¯†åº“åŠ è½½å™¨<br/>(JSON Loader)"]
        Matcher["æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        Scorer["åŠ æƒè¯„åˆ†å™¨"]
    end

    %% å¤–éƒ¨æœåŠ¡
    subgraph External["å¤–éƒ¨æœåŠ¡ (External Services)"]
        Qwen["Qwen VL Plus"]
        GPT["ChatGPT<br/>gpt-4o"]
        Grok["Grok Vision"]
        Claude["Claude Sonnet"]
    end

    %% æ•°æ®å­˜å‚¨
    subgraph Storage["æ•°æ®å­˜å‚¨ (Storage)"]
        PG[("PostgreSQL<br/>è¯Šæ–­è®°å½•")]
        Redis[("Redis<br/>ç¼“å­˜")]
        FS[("æ–‡ä»¶ç³»ç»Ÿ<br/>å›¾ç‰‡å­˜å‚¨")]
        Git[("Gitä»“åº“<br/>çŸ¥è¯†åº“JSON")]
    end

    %% è¿æ¥å…³ç³»
    Web --> API
    Admin --> API
    API --> Auth
    Auth --> DiagService
    Auth --> KnowledgeService
    Auth --> ImageService

    DiagService --> VLM
    DiagService --> Scorer
    DiagService --> Domain

    KnowledgeService --> OntologyLoader
    KnowledgeService --> Git

    ImageService --> FS

    VLM --> PromptFramework
    VLM --> Qwen
    VLM --> GPT
    VLM --> Grok
    VLM --> Claude

    Scorer --> Matcher
    OntologyLoader --> Git

    DiagService --> PG
    VLM --> Redis
    ImageService --> PG
```

### 1.2 éƒ¨ç½²æ¶æ„å›¾

```mermaid
graph LR
    subgraph Development["å¼€å‘ç¯å¢ƒ"]
        Dev1["åç«¯<br/>python main.py<br/>:8000"]
        Dev2["å‰ç«¯<br/>npm run dev<br/>:3000"]
        Dev3["ç®¡ç†åå°<br/>streamlit run<br/>:8501"]
        Dev4["PostgreSQL<br/>æœ¬åœ°å®‰è£…<br/>:5432"]
        Dev5["Redis<br/>æœ¬åœ°å®‰è£…<br/>:6379"]
    end

    subgraph Production["ç”Ÿäº§ç¯å¢ƒ(äº‘æœåŠ¡å™¨)"]
        Nginx["Nginx<br/>åå‘ä»£ç†<br/>:80/:443"]
        Uvicorn["Uvicorn<br/>å¤šè¿›ç¨‹<br/>:8000-8003"]
        Next["Next.js<br/>Production Build<br/>:3000"]
        StreamlitProd["Streamlit<br/>:8501"]
        PGProd["PostgreSQL<br/>:5432"]
        RedisProd["Redis<br/>:6379"]
    end

    subgraph Users["ç”¨æˆ·è®¿é—®"]
        U1["APIç”¨æˆ·"]
        U2["Webç”¨æˆ·"]
        U3["ç®¡ç†å‘˜"]
    end

    U1 -->|APIè¯·æ±‚| Nginx
    U2 -->|Webè®¿é—®| Nginx
    U3 -->|ç®¡ç†ç•Œé¢| Nginx

    Nginx -->|/api/*| Uvicorn
    Nginx -->|/*| Next
    Nginx -->|/admin/*| StreamlitProd

    Uvicorn --> PGProd
    Uvicorn --> RedisProd
```

### 1.3 æ ¸å¿ƒç±»å›¾

```mermaid
classDiagram
    %% æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
    class PROOFPrompt {
        +question_id: str
        +purpose: PromptPurpose
        +role: PromptRole
        +observation: PromptObservation
        +options: PromptOptions
        +format_spec: PromptFormat
        +version: str
        +render() str
        +to_dict() dict
    }

    class PromptPurpose {
        +task: str
        +context: str
        +why_important: str
    }

    class PromptRole {
        +role: str
        +expertise: List[str]
        +constraints: List[str]
    }

    class PromptObservation {
        +visual_method: str
        +visual_clues: Dict
        +focus_areas: List[str]
    }

    class PromptOptions {
        +choices: List[Choice]
        +allow_unknown: bool
        +allow_uncertain: bool
    }

    class PromptFormat {
        +response_schema: Type[BaseModel]
        +examples: List[Example]
        +constraints: List[str]
    }

    PROOFPrompt --> PromptPurpose
    PROOFPrompt --> PromptRole
    PROOFPrompt --> PromptObservation
    PROOFPrompt --> PromptOptions
    PROOFPrompt --> PromptFormat

    %% VLMæŠ½è±¡å±‚ + Instructoré›†æˆ
    class VLMProvider {
        <<interface>>
        +call(prompt: str, image: bytes) str
        +is_available() bool
        +get_quota() dict
    }

    class QwenProvider {
        +api_key: str
        +base_url: str
        +call(prompt: str, image: bytes) str
    }

    class ChatGPTProvider {
        +api_key: str
        +model: str
        +call(prompt: str, image: bytes) str
    }

    class VLMClient {
        -providers: List[VLMProvider]
        -cache: RedisCache
        +call_with_fallback(prompt: str, image: bytes, response_model: Type[BaseModel]) BaseModel
        +get_current_provider() str
    }

    class Instructor {
        <<library>>
        +from_openai() Client
        +from_anthropic() Client
        +auto_retry: bool
        +max_retries: int
    }

    VLMProvider <|-- QwenProvider
    VLMProvider <|-- ChatGPTProvider
    VLMClient --> VLMProvider
    VLMClient --> Instructor
    VLMClient --> PROOFPrompt

    %% è¯Šæ–­æœåŠ¡
    class DiagnosisService {
        -vlm_client: VLMClient
        -scorer: DiagnosisScorer
        -knowledge_base: KnowledgeBase
        +diagnose(image: bytes) DiagnosisResult
        -extract_features() FeatureVector
        -match_diseases() List[DiseaseMatch]
    }

    class DiagnosisScorer {
        -matcher: FuzzyMatcher
        +calculate_score(features: dict, disease: dict) float
        +apply_weights(scores: dict) float
    }

    class FuzzyMatcher {
        +COLOR_GROUPS: dict
        +SIZE_ORDER: list
        +match_color(observed: str, expected: str) bool
        +match_size(observed: str, expected: str) bool
    }

    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisScorer --> FuzzyMatcher

    %% é¢†åŸŸæ¨¡å‹
    class DiseaseOntology {
        +disease_id: str
        +disease_name: str
        +feature_vector: dict
        +feature_importance: dict
        +diagnosis_rules: dict
    }

    class FeatureVector {
        +content_type: str
        +plant_category: str
        +flower_genus: str
        +organ: str
        +completeness: str
        +has_abnormality: str
        +symptom_type: str
        +additional_features: dict
    }

    DiagnosisService --> DiseaseOntology
    DiagnosisService --> FeatureVector
```

---

## 2. é«˜å†…èšä½è€¦åˆè®¾è®¡åŸåˆ™è¯´æ˜

### 2.1 å•ä¸€èŒè´£åŸåˆ™ (SRP)

æ¯ä¸ªæ¨¡å—ä¸¥æ ¼éµå¾ªå•ä¸€èŒè´£ï¼š

| æ¨¡å— | èŒè´£ | ä¸è´Ÿè´£ |
|-----|------|--------|
| **PromptFramework** | æç¤ºè¯ç»“æ„åŒ–ç¼–å†™ä¸ç‰ˆæœ¬æ§åˆ¶ | VLMè°ƒç”¨ã€å“åº”éªŒè¯ |
| **DiagnosisService** | åè°ƒè¯Šæ–­æµç¨‹ | VLMè°ƒç”¨ç»†èŠ‚ã€è¯„åˆ†ç®—æ³• |
| **VLMClient** | VLMè°ƒç”¨ä¸é™çº§ã€Instructoré›†æˆ | ä¸šåŠ¡é€»è¾‘ã€Promptç”Ÿæˆ |
| **FuzzyMatcher** | æ¨¡ç³ŠåŒ¹é…é€»è¾‘ | æƒé‡è®¡ç®—ã€è¯Šæ–­å†³ç­– |
| **DiagnosisScorer** | åŠ æƒè¯„åˆ†è®¡ç®— | ç‰¹å¾æå–ã€VLMäº¤äº’ |
| **KnowledgeLoader** | JSONåŠ è½½ä¸ç¼“å­˜ | ä¸šåŠ¡éªŒè¯ã€è¯Šæ–­é€»è¾‘ |
| **ImageService** | å›¾ç‰‡å­˜å‚¨ä¸æ£€ç´¢ | è¯Šæ–­é€»è¾‘ã€VLMè°ƒç”¨ |

### 2.2 ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

é€šè¿‡ProtocolæŠ½è±¡å®ç°ä¾èµ–å€’ç½®ï¼š

```python
from typing import Protocol

# æŠ½è±¡æ¥å£å®šä¹‰
class VLMProtocol(Protocol):
    async def call(self, prompt: str, image: bytes) -> str: ...
    def is_available(self) -> bool: ...

class CacheProtocol(Protocol):
    async def get(self, key: str) -> Optional[str]: ...
    async def set(self, key: str, value: str, ttl: int) -> None: ...

class RepositoryProtocol(Protocol):
    async def save(self, entity: Any) -> str: ...
    async def find_by_id(self, id: str) -> Optional[Any]: ...

# ä¸šåŠ¡å±‚ä¾èµ–æŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç°
class DiagnosisService:
    def __init__(
        self,
        vlm: VLMProtocol,  # ä¾èµ–æŠ½è±¡
        cache: CacheProtocol,  # ä¾èµ–æŠ½è±¡
        repo: RepositoryProtocol  # ä¾èµ–æŠ½è±¡
    ):
        self.vlm = vlm
        self.cache = cache
        self.repo = repo
```

### 2.3 æ¥å£éš”ç¦»åŸåˆ™ (ISP)

ç»†ç²’åº¦æ¥å£è®¾è®¡ï¼Œé¿å…èƒ–æ¥å£ï¼š

```python
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šèƒ–æ¥å£
class KnowledgeService:
    def load_diseases(): ...
    def save_disease(): ...
    def delete_disease(): ...
    def load_plants(): ...
    def save_plant(): ...
    def validate_json(): ...
    def export_to_csv(): ...

# âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç»†ç²’åº¦æ¥å£
class DiseaseLoader(Protocol):
    def load_all() -> List[DiseaseOntology]: ...

class DiseaseEditor(Protocol):
    def save(disease: DiseaseOntology) -> None: ...
    def delete(disease_id: str) -> None: ...

class OntologyValidator(Protocol):
    def validate(json_data: dict) -> ValidationResult: ...
```

### 2.4 å±‚æ¬¡éš”ç¦»

ä¸¥æ ¼çš„å±‚æ¬¡ç»“æ„ï¼Œç¦æ­¢è·¨å±‚è°ƒç”¨ï¼š

```
è¡¨ç°å±‚ (Routers)
    â†“ [ä»…é€šè¿‡Schemaä¼ é€’æ•°æ®]
åº”ç”¨å±‚ (Services)
    â†“ [ä»…é€šè¿‡Domain Modeläº¤äº’]
é¢†åŸŸå±‚ (Domain)
    â†“ [ä»…é€šè¿‡Protocolè°ƒç”¨]
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
```

### 2.5 å¾ªç¯ä¾èµ–æ£€æµ‹

ä½¿ç”¨mypyä¸¥æ ¼æ¨¡å¼æ£€æµ‹å¾ªç¯ä¾èµ–ï¼š

```bash
# pyproject.tomlé…ç½®
[tool.mypy]
strict = true
disallow_any_unimported = true
no_implicit_reexport = true
warn_return_any = true

# è¿è¡Œæ£€æµ‹
mypy --strict backend/
```

---

## 3. åˆ†å±‚æ¶æ„ä¸æ¨¡å—åˆ’åˆ†ï¼ˆDDD é£æ ¼ï¼‰

### 3.1 é¢†åŸŸé©±åŠ¨è®¾è®¡åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¡¨ç°å±‚ (Presentation)            â”‚
â”‚   FastAPI Routers / Streamlit UI        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         åº”ç”¨å±‚ (Application)            â”‚
â”‚   DiagnosisService / KnowledgeService   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          é¢†åŸŸå±‚ (Domain)                â”‚
â”‚   å®ä½“ / å€¼å¯¹è±¡ / é¢†åŸŸæœåŠ¡ / èšåˆæ ¹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure)        â”‚
â”‚   VLM / Database / Cache / Storage      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 èšåˆæ ¹è®¾è®¡

**è¯Šæ–­èšåˆ (Diagnosis Aggregate)**ï¼š
```python
class DiagnosisAggregate:
    """è¯Šæ–­èšåˆæ ¹"""
    def __init__(self, diagnosis_id: str):
        self.diagnosis_id = diagnosis_id
        self.feature_vector: FeatureVector = None
        self.disease_matches: List[DiseaseMatch] = []
        self.final_diagnosis: DiagnosisResult = None
        self.images: List[ImageEntity] = []

    def add_image(self, image: ImageEntity) -> None:
        """æ·»åŠ è¯Šæ–­å›¾ç‰‡"""
        self.images.append(image)

    def extract_features(self, vlm_responses: dict) -> None:
        """æå–ç‰¹å¾å‘é‡"""
        self.feature_vector = FeatureVector.from_vlm_responses(vlm_responses)

    def match_diseases(self, candidates: List[DiseaseOntology]) -> None:
        """åŒ¹é…å€™é€‰ç–¾ç—…"""
        for disease in candidates:
            score = self._calculate_match_score(disease)
            self.disease_matches.append(DiseaseMatch(disease, score))

    def finalize_diagnosis(self) -> DiagnosisResult:
        """æœ€ç»ˆè¯Šæ–­å†³ç­–"""
        best_match = max(self.disease_matches, key=lambda x: x.score)
        confidence_level = self._determine_confidence_level(best_match.score)
        self.final_diagnosis = DiagnosisResult(
            disease=best_match.disease,
            confidence=best_match.score,
            level=confidence_level
        )
        return self.final_diagnosis
```

**çŸ¥è¯†åº“èšåˆ (KnowledgeBase Aggregate)**ï¼š
```python
class KnowledgeBaseAggregate:
    """çŸ¥è¯†åº“èšåˆæ ¹"""
    def __init__(self):
        self.diseases: Dict[str, DiseaseOntology] = {}
        self.plants: Dict[str, PlantOntology] = {}
        self.features: FeatureOntology = None
        self.host_disease_map: HostDiseaseMap = None
        self.version: str = None

    def load_from_json(self, base_path: str) -> None:
        """ä»JSONåŠ è½½çŸ¥è¯†åº“"""
        pass

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """æ ¹æ®èŠ±å‰å±è·å–å€™é€‰ç–¾ç—…"""
        disease_ids = self.host_disease_map.get_diseases_for_host(genus)
        return [self.diseases[id] for id in disease_ids if id in self.diseases]

    def reload(self) -> None:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“"""
        pass
```

### 3.3 å€¼å¯¹è±¡è®¾è®¡

```python
# å€¼å¯¹è±¡ï¼šä¸å¯å˜ï¼Œé€šè¿‡å€¼åˆ¤æ–­ç›¸ç­‰æ€§
@dataclass(frozen=True)
class FeatureVector:
    """ç‰¹å¾å‘é‡å€¼å¯¹è±¡"""
    content_type: str
    plant_category: str
    flower_genus: str
    organ: str
    completeness: str
    has_abnormality: str
    symptom_type: str
    color_center: Optional[str] = None
    location: Optional[str] = None
    size: Optional[str] = None
    distribution: Optional[str] = None

    def to_dict(self) -> dict:
        return asdict(self)

@dataclass(frozen=True)
class DiagnosisScore:
    """è¯Šæ–­åˆ†æ•°å€¼å¯¹è±¡ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å«åŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰"""
    total_score: float
    major_features_score: float
    minor_features_score: float
    optional_features_score: float
    major_matched: int  # æ–°å¢ï¼šä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
    major_total: int    # æ–°å¢ï¼šä¸»è¦ç‰¹å¾æ€»æ•°

    @property
    def confidence_level(self) -> str:
        """
        è¯Šæ–­ç­‰çº§åˆ¤å®šï¼ˆä¸¥æ ¼éµå¾ªåŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰

        è§„åˆ™ï¼ˆéœ€æ±‚æ–‡æ¡£v1.3å®šä¹‰ï¼‰ï¼š
        - confirmed: total_score â‰¥ 0.85 ä¸” major_matched â‰¥ 2/2
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶å¿…é¡»å…¨éƒ¨åŒ¹é…æ‰èƒ½ç¡®è¯Š
        - suspected: 0.60 â‰¤ total_score < 0.85 ä¸” major_matched â‰¥ 1/2
          åŒ»å­¦åŸç†ï¼šè‡³å°‘ä¸€ä¸ªä¸»è¦ç—‡çŠ¶åŒ¹é… + æ¬¡è¦ç—‡çŠ¶æ”¯æŒ
        - unlikely: total_score < 0.60 æˆ– major_matched = 0
          åŒ»å­¦åŸç†ï¼šä¸»è¦ç—‡çŠ¶ä¸åŒ¹é…åˆ™æ’é™¤è¯Šæ–­
        """
        if self.total_score >= 0.85 and self.major_matched >= 2:
            return "confirmed"
        elif self.total_score >= 0.60 and self.major_matched >= 1:
            return "suspected"
        else:
            return "unlikely"

    @property
    def is_diagnosable(self) -> bool:
        """
        æ˜¯å¦å¯è¯Šæ–­ï¼ˆæ’é™¤"å¥åº·"æˆ–"çŸ¥è¯†åº“å¤–ç–¾ç—…"ï¼‰

        è§„åˆ™ï¼š
        - total_score < 0.30: è®¤ä¸ºæ— ç—…æˆ–çŸ¥è¯†åº“å¤–ç–¾ç—…
        - ç”¨äºè§¦å‘VLMå…œåº•ç­–ç•¥æˆ–è¿”å›"æ— æ³•è¯Šæ–­"
        """
        return self.total_score >= 0.30
```

### 3.4 é¢†åŸŸæœåŠ¡

```python
class DomainDiagnosisService:
    """é¢†åŸŸå±‚è¯Šæ–­æœåŠ¡"""

    @staticmethod
    def calculate_weighted_score(
        feature_vector: FeatureVector,
        disease: DiseaseOntology
    ) -> DiagnosisScore:
        """è®¡ç®—åŠ æƒè¯Šæ–­åˆ†æ•°ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰"""
        major_score = 0.0
        minor_score = 0.0
        optional_score = 0.0
        major_matched = 0  # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°
        major_total = 2    # ä¸»è¦ç‰¹å¾æ€»æ•°ï¼ˆsymptom_type + color_centerï¼‰

        # Major Features (æƒé‡0.8)
        if feature_vector.symptom_type == disease.expected_symptom_type:
            major_score += 0.5
            major_matched += 1
        if feature_vector.color_center in disease.expected_colors:
            major_score += 0.3
            major_matched += 1

        # Minor Features (æƒé‡0.15)
        if feature_vector.location == disease.expected_location:
            minor_score += 0.1
        # ... å…¶ä»–æ¬¡è¦ç‰¹å¾

        # Optional Features (æƒé‡0.05)
        # ... å¯é€‰ç‰¹å¾è®¡ç®—

        total = major_score * 0.8 + minor_score * 0.15 + optional_score * 0.05

        return DiagnosisScore(
            total_score=total,
            major_features_score=major_score,
            minor_features_score=minor_score,
            optional_features_score=optional_score,
            major_matched=major_matched,  # æ–°å¢
            major_total=major_total        # æ–°å¢
        )
```

---

## 4. å®Œæ•´ç›®å½•ç»“æ„ ğŸ”„

### 4.1 åç«¯ç›®å½•ç»“æ„ âœ…

```
PhytoOracle/
â”œâ”€â”€ backend/                                 # åç«¯æœåŠ¡ï¼ˆFastAPIï¼‰
â”‚   â”œâ”€â”€ apps/
â”‚   â”‚   â”œâ”€â”€ api/                            # FastAPI ä¸»åº”ç”¨
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£ï¼Œé…ç½®CORSã€ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ deps.py                     # ä¾èµ–æ³¨å…¥ï¼šDBè¿æ¥æ± ã€Redisã€VLM Client
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/                    # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # POST /diagnose - è¯Šæ–­æ¥å£
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # GET /diseases, /plants - çŸ¥è¯†åº“æŸ¥è¯¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.py                # POST /reload - çŸ¥è¯†åº“é‡è½½
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # POST /login, /api-keys - è®¤è¯ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/                    # Pydanticè¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ diagnosis.py            # DiagnosisRequest/Response
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ knowledge.py            # DiseaseSchema, PlantSchema
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.py                 # LoginRequest, ApiKeyResponse
â”‚   â”‚   â”‚   â””â”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â””â”€â”€ auth.py                 # API KeyéªŒè¯ä¸­é—´ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ admin/                          # ç®¡ç†åå°ï¼ˆStreamlitï¼‰
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ app.py                      # Streamlitä¸»å…¥å£
â”‚   â”‚       â”œâ”€â”€ pages/                      # å¤šé¡µé¢åº”ç”¨
â”‚   â”‚       â”‚   â”œâ”€â”€ 1_ğŸŒ¸_ç–¾ç—…ç®¡ç†.py        # ç–¾ç—…CRUDç•Œé¢
â”‚   â”‚       â”‚   â”œâ”€â”€ 2_ğŸ”¬_è¯Šæ–­æµ‹è¯•.py        # ä¸Šä¼ å›¾ç‰‡æµ‹è¯•è¯Šæ–­
â”‚   â”‚       â”‚   â”œâ”€â”€ 3_ğŸ“Š_ç»Ÿè®¡åˆ†æ.py        # å‡†ç¡®ç‡ç»Ÿè®¡
â”‚   â”‚       â”‚   â””â”€â”€ 4_ğŸ”„_çŸ¥è¯†åº“ç‰ˆæœ¬.py      # ç‰ˆæœ¬ç®¡ç†ä¸å›æ»š
â”‚   â”‚       â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”‚           â””â”€â”€ auth.py                 # Streamlitè®¤è¯
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                               # æ ¸å¿ƒé…ç½®ä¸å·¥å…·
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                       # Settingsç±»ï¼Œä».envåŠ è½½é…ç½®
â”‚   â”‚   â”œâ”€â”€ security.py                     # API Keyç”Ÿæˆ(secrets)ã€å¯†ç å“ˆå¸Œ(bcrypt)
â”‚   â”‚   â”œâ”€â”€ exceptions.py                   # è‡ªå®šä¹‰å¼‚å¸¸ï¼šDiagnosisError, VLMError
â”‚   â”‚   â””â”€â”€ cache.py                        # Redisç¼“å­˜å°è£…ç±»
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/                             # DDDé¢†åŸŸæ¨¡å‹ï¼ˆPydantic V2ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis.py                    # DiagnosisAggregate, DiagnosisResult
â”‚   â”‚   â”œâ”€â”€ disease.py                      # DiseaseOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ feature.py                      # FeatureOntology, FeatureVector
â”‚   â”‚   â”œâ”€â”€ plant.py                        # PlantOntologyé¢†åŸŸæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ treatment.py                    # TreatmentOntologyï¼ˆv1.3é¢„ç•™ï¼‰
â”‚   â”‚   â””â”€â”€ value_objects.py                # å€¼å¯¹è±¡ï¼šScore, Confidence
â”‚   â”‚
â”‚   â”œâ”€â”€ infrastructure/                     # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py                     # VLMProtocolæŠ½è±¡æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ client.py                   # VLMClientå®ç°Fallbackæœºåˆ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/                  # å…·ä½“Providerå®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ qwen.py                 # QwenVLPlusProvider
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ chatgpt.py              # ChatGPTProvider (gpt-4o)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ grok.py                 # GrokVisionProvider
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ claude.py               # ClaudeProvider
â”‚   â”‚   â”‚   â”œâ”€â”€ prompts/                    # VLMæç¤ºè¯æ¨¡æ¿ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q0_screening.py         # Q0.0-Q0.5 è¿‡æ»¤é—®é¢˜æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 ç‰¹å¾æå–æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ fallback.py             # VLMå¼€æ”¾å¼è¯Šæ–­æ¨¡æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CHANGELOG.md            # æç¤ºè¯ç‰ˆæœ¬å˜æ›´è®°å½•
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ versions/               # å†å²ç‰ˆæœ¬å½’æ¡£ï¼ˆA/Bæµ‹è¯•ï¼‰
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ v1.0/
â”‚   â”‚   â”‚   â””â”€â”€ validators.py               # VLMå“åº”éªŒè¯å™¨ï¼ˆJSON Schemaï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ontology/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ loader.py                   # JSONKnowledgeLoader - åŠ è½½JSONçŸ¥è¯†åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ matcher.py                  # FuzzyMatcher - æ¨¡ç³ŠåŒ¹é…COLOR_GROUPS/SIZE_ORDER
â”‚   â”‚   â”‚   â””â”€â”€ scorer.py                   # DiagnosisScorer - åŠ æƒè¯„åˆ†0.8/0.15/0.05
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ database.py                 # create_pool() - asyncpgè¿æ¥æ± 
â”‚   â”‚   â”‚   â”œâ”€â”€ redis_client.py             # RedisCacheç±»å°è£…
â”‚   â”‚   â”‚   â””â”€â”€ repositories/               # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ diagnosis_repo.py       # è¯Šæ–­è®°å½•CRUD (asyncpg)
â”‚   â”‚   â”‚       â”œâ”€â”€ image_repo.py           # å›¾ç‰‡å…ƒæ•°æ®CRUD
â”‚   â”‚   â”‚       â””â”€â”€ apikey_repo.py          # API Keyç®¡ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ storage/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ local_storage.py            # LocalImageStorage - æŒ‰åˆ†ç±»å­˜å‚¨å›¾ç‰‡
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                           # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåº”ç”¨æœåŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ diagnosis_service.py            # æ ¸å¿ƒè¯Šæ–­æµç¨‹ç¼–æ’
â”‚   â”‚   â”œâ”€â”€ knowledge_service.py            # çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ image_service.py                # å›¾ç‰‡ä¿å­˜ã€åˆ†ç±»ã€å…ƒæ•°æ®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ tests/                              # æµ‹è¯•ç›®å½•
â”‚   â”‚   â”œâ”€â”€ conftest.py                     # Pytest fixtures
â”‚   â”‚   â”œâ”€â”€ unit/                           # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_matcher.py             # æµ‹è¯•COLOR_GROUPSæ¨¡ç³ŠåŒ¹é…
â”‚   â”‚   â”‚   â”œâ”€â”€ test_scorer.py              # æµ‹è¯•åŠ æƒè¯„åˆ†ç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ test_vlm_client.py          # æµ‹è¯•VLM Fallbackæœºåˆ¶
â”‚   â”‚   â”œâ”€â”€ integration/                    # é›†æˆæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_diagnosis_api.py       # æµ‹è¯•å®Œæ•´è¯Šæ–­APIæµç¨‹
â”‚   â”‚   â”‚   â””â”€â”€ test_knowledge_reload.py    # æµ‹è¯•çŸ¥è¯†åº“çƒ­æ›´æ–°
â”‚   â”‚   â””â”€â”€ e2e/                            # ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆPlaywrightï¼‰
â”‚   â”‚       â””â”€â”€ test_diagnosis_flow.py      # æµ‹è¯•Webç•Œé¢å®Œæ•´æµç¨‹
â”‚   â”‚
â”‚   â”œâ”€â”€ knowledge_base/                     # çŸ¥è¯†åº“JSONæ–‡ä»¶ï¼ˆGitç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ diseases/                       # ç–¾ç—…æœ¬ä½“JSON
â”‚   â”‚   â”‚   â”œâ”€â”€ rose_black_spot.json        # ç«ç‘°é»‘æ–‘ç—…
â”‚   â”‚   â”‚   â”œâ”€â”€ cherry_powdery_mildew.json  # æ¨±èŠ±ç™½ç²‰ç—…
â”‚   â”‚   â”‚   â””â”€â”€ ...                         # å…¶ä»–18-24ç§ç–¾ç—…
â”‚   â”‚   â”œâ”€â”€ features/                       # ç‰¹å¾æœ¬ä½“
â”‚   â”‚   â”‚   â””â”€â”€ feature_ontology.json       # ç‰¹å¾å®šä¹‰ä¸æ¨¡ç³ŠåŒ¹é…è§„åˆ™
â”‚   â”‚   â”œâ”€â”€ plants/                         # æ¤ç‰©æœ¬ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ rosa.json                   # ç«ç‘°å±
â”‚   â”‚   â”‚   â”œâ”€â”€ prunus.json                 # æ¨±èŠ±å±
â”‚   â”‚   â”‚   â”œâ”€â”€ tulipa.json                 # éƒé‡‘é¦™å±
â”‚   â”‚   â”‚   â”œâ”€â”€ dianthus.json               # åº·ä¹ƒé¦¨å±
â”‚   â”‚   â”‚   â””â”€â”€ paeonia.json                # ç‰¡ä¸¹å±
â”‚   â”‚   â”œâ”€â”€ host_disease/                   # å®¿ä¸»-ç–¾ç—…å…³ç³»
â”‚   â”‚   â”‚   â””â”€â”€ associations.json           # èŠ±å‰ä¸ç–¾ç—…æ˜ å°„å…³ç³»
â”‚   â”‚   â””â”€â”€ treatments/                     # æ²»ç–—æ–¹æ¡ˆï¼ˆv1.3+é¢„ç•™ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/                            # æœ¬åœ°æ–‡ä»¶å­˜å‚¨ç›®å½•
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”‚   â”œâ”€â”€ unlabeled/                  # æœªæ ‡æ³¨å›¾ç‰‡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rose/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ 2025-01/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cherry/
â”‚   â”‚   â”‚   â”œâ”€â”€ correct/                    # è¯Šæ–­æ­£ç¡®
â”‚   â”‚   â”‚   â””â”€â”€ incorrect/                  # è¯Šæ–­é”™è¯¯
â”‚   â”‚   â””â”€â”€ metadata/                       # å›¾ç‰‡å…ƒæ•°æ®JSONç¼“å­˜
â”‚   â”‚
â”‚   â”œâ”€â”€ scripts/                            # è¿ç»´è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ init_db.sql                     # åˆ›å»ºè¡¨ç»“æ„SQLè„šæœ¬
â”‚   â”‚   â”œâ”€â”€ seed_apikeys.py                 # ç”Ÿæˆæµ‹è¯•ç”¨API Key
â”‚   â”‚   â””â”€â”€ validate_ontology.py            # JSON Schemaæ ¡éªŒè„šæœ¬
â”‚   â”‚
â”‚   â”œâ”€â”€ pyproject.toml                      # Poetryä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ .env.example                        # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â”œâ”€â”€ .gitignore
â”‚   â””â”€â”€ README.md                           # åç«¯éƒ¨ç½²è¯´æ˜
```

### 4.2 å‰ç«¯ç›®å½•ç»“æ„ âœ¨

**ğŸ†• v2.0æ–°å¢**: React/Vueå‰ç«¯é¡¹ç›®ç›®å½•ç»“æ„

```
frontend/
â”œâ”€â”€ public/                     # é™æ€èµ„æº
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ images/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    # APIå®¢æˆ·ç«¯å±‚
â”‚   â”‚   â”œâ”€â”€ client.ts           # Axiosé…ç½®ï¼Œç»Ÿä¸€è¯·æ±‚/å“åº”æ‹¦æˆª
â”‚   â”‚   â”‚   # - é…ç½®baseURL: process.env.VITE_API_BASE_URL
â”‚   â”‚   â”‚   # - é…ç½®è¯·æ±‚æ‹¦æˆªå™¨ï¼ˆæ·»åŠ tokenï¼‰
â”‚   â”‚   â”‚   # - é…ç½®å“åº”æ‹¦æˆªå™¨ï¼ˆç»Ÿä¸€é”™è¯¯å¤„ç†ï¼‰
â”‚   â”‚   â”‚   # - é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆ10ç§’ï¼‰
â”‚   â”‚   â”œâ”€â”€ diagnosis.ts        # è¯Šæ–­APIå°è£…
â”‚   â”‚   â”‚   # - diagnoseSingle(image: File): Promise<DiagnosisResult>
â”‚   â”‚   â”‚   # - diagnoseBatch(images: File[]): Promise<BatchDiagnosisResult>
â”‚   â”‚   â”‚   # - getDiagnosisResult(id: string): Promise<DiagnosisResult>
â”‚   â”‚   â”œâ”€â”€ knowledge.ts        # çŸ¥è¯†åº“APIå°è£…
â”‚   â”‚   â”‚   # - getKnowledgeTree(): Promise<KnowledgeTree>
â”‚   â”‚   â”‚   # - getDiseaseDetail(diseaseId: string): Promise<DiseaseDetail>
â”‚   â”‚   â”‚   # - updateDisease(diseaseId: string, data: DiseaseUpdate): Promise<void>
â”‚   â”‚   â”‚   # - createDisease(data: DiseaseCreate): Promise<string>
â”‚   â”‚   â”‚   # - deleteDisease(diseaseId: string): Promise<void>
â”‚   â”‚   â””â”€â”€ ontology.ts         # æœ¬ä½“APIå°è£…
â”‚   â”‚       # - getOntologyList(): Promise<OntologyType[]>
â”‚   â”‚       # - getOntologySchema(type: string): Promise<OntologySchema>
â”‚   â”‚
â”‚   â”œâ”€â”€ assets/                 # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ icons/
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â”œâ”€â”€ global.css      # å…¨å±€æ ·å¼
â”‚   â”‚       â””â”€â”€ variables.css   # CSSå˜é‡
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # ç»„ä»¶å±‚
â”‚   â”‚   â”œâ”€â”€ common/             # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ Header/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # å¯¼èˆªæ ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ Loading/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # åŠ è½½ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ Toast/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æç¤ºç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useToast.ts # Toast Hook
â”‚   â”‚   â”‚   â””â”€â”€ Modal/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # å¯¹è¯æ¡†ç»„ä»¶
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ diagnosis/          # è¯Šæ–­ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ UploadArea/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ä¸Šä¼ åŒºåŸŸï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ImagePreview/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # å›¾ç‰‡é¢„è§ˆ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ DiagnosisResult/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # è¯Šæ–­ç»“æœå¡ç‰‡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ QADetails/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # VLMé—®ç­”å¯¹è¯¦æƒ…ï¼ˆå¯å±•å¼€ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ FeatureMatchDetails/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # ç‰¹å¾åŒ¹é…è¯¦æƒ…
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ batch/              # æ‰¹é‡è¯Šæ–­ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ BatchUpload/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æ‰¹é‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ResultList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ç»“æœåˆ—è¡¨ï¼ˆç¿»é¡µæ§åˆ¶ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ ResultCard/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # ç»“æœå¡ç‰‡ï¼ˆåŒå‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ DetailModal/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # è¯¦æƒ…æ¨¡æ€æ¡†
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ ontology/           # æœ¬ä½“ç®¡ç†ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ OntologyList/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æœ¬ä½“ç±»å‹åˆ—è¡¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â”œâ”€â”€ OntologyDetail/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx   # æœ¬ä½“è¯¦æƒ…å±•ç¤º
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”‚   â””â”€â”€ DimensionCard/
â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx   # ç»´åº¦å¡ç‰‡ï¼ˆå«æšä¸¾å€¼ï¼‰
â”‚   â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ knowledge/          # çŸ¥è¯†ç®¡ç†ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ KnowledgeTree/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # çŸ¥è¯†åº“ç›®å½•æ ‘ï¼ˆæŒ‰å®¿ä¸»å±åˆ†ç»„ï¼‰
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â”œâ”€â”€ DiseaseDetail/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # ç–¾ç—…è¯¦æƒ…å±•ç¤º
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â”œâ”€â”€ DimensionCard/
â”‚   â”‚       â”‚   â”œâ”€â”€ index.tsx   # ç»´åº¦å¡ç‰‡ï¼ˆå¸¦æœ¬ä½“æ ‡è¯†ï¼‰
â”‚   â”‚       â”‚   â””â”€â”€ style.css
â”‚   â”‚       â””â”€â”€ VLMDescriptionEditor/
â”‚   â”‚           â”œâ”€â”€ index.tsx   # VLMæè¿°ç¼–è¾‘å™¨
â”‚   â”‚           â””â”€â”€ style.css
â”‚   â”‚
â”‚   â”œâ”€â”€ pages/                  # é¡µé¢å±‚
â”‚   â”‚   â”œâ”€â”€ SingleDiagnosis/    # ç•Œé¢1ï¼šå•å›¾è¯Šæ–­
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx       # é¡µé¢ä¸»ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts        # è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”œâ”€â”€ BatchDiagnosis/     # ç•Œé¢2ï¼šæ‰¹é‡è¯Šæ–­
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â”œâ”€â”€ OntologyManagement/ # ç•Œé¢3ï¼šæœ¬ä½“ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks.ts
â”‚   â”‚   â”‚   â””â”€â”€ style.css
â”‚   â”‚   â””â”€â”€ KnowledgeManagement/# ç•Œé¢4ï¼šçŸ¥è¯†ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ index.tsx
â”‚   â”‚       â”œâ”€â”€ hooks.ts
â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”‚
â”‚   â”œâ”€â”€ store/                  # çŠ¶æ€ç®¡ç†å±‚ï¼ˆZustand/Piniaï¼‰
â”‚   â”‚   â”œâ”€â”€ diagnosisStore.ts   # è¯Šæ–­çŠ¶æ€
â”‚   â”‚   â”‚   # State: currentDiagnosis, batchDiagnoses, loading
â”‚   â”‚   â”‚   # Actions: setCurrentDiagnosis, addBatchDiagnosis, clearDiagnoses
â”‚   â”‚   â”œâ”€â”€ knowledgeStore.ts   # çŸ¥è¯†åº“çŠ¶æ€
â”‚   â”‚   â”‚   # State: knowledgeTree, currentDisease, editMode
â”‚   â”‚   â”‚   # Actions: setKnowledgeTree, updateDisease, toggleEditMode
â”‚   â”‚   â”œâ”€â”€ ontologyStore.ts    # æœ¬ä½“çŠ¶æ€
â”‚   â”‚   â”‚   # State: ontologyList, currentOntology
â”‚   â”‚   â”‚   # Actions: setOntologyList, selectOntology
â”‚   â”‚   â””â”€â”€ globalStore.ts      # å…¨å±€çŠ¶æ€
â”‚   â”‚       # State: user, loading, toast
â”‚   â”‚       # Actions: showToast, hideToast, setLoading
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                  # TypeScriptç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ diagnosis.ts        # è¯Šæ–­ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # DiagnosisResult, VLMQAResponse, FeatureMatch
â”‚   â”‚   â”œâ”€â”€ knowledge.ts        # çŸ¥è¯†åº“ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # KnowledgeTree, DiseaseDetail, DimensionInfo
â”‚   â”‚   â”œâ”€â”€ ontology.ts         # æœ¬ä½“ç›¸å…³ç±»å‹
â”‚   â”‚   â”‚   # OntologyType, OntologySchema, DimensionDefinition
â”‚   â”‚   â””â”€â”€ api.ts              # APIå“åº”ç±»å‹
â”‚   â”‚       # ApiResponse, ApiError, PaginatedResponse
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ formatters.ts       # æ ¼å¼åŒ–å·¥å…·
â”‚   â”‚   â”‚   # formatDate, formatPercentage, formatFileSize
â”‚   â”‚   â”œâ”€â”€ validators.ts       # éªŒè¯å·¥å…·
â”‚   â”‚   â”‚   # validateImageFile, validateDiseaseData
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts     # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   # handleApiError, showErrorToast
â”‚   â”‚   â””â”€â”€ constants.ts        # å¸¸é‡å®šä¹‰
â”‚   â”‚       # MAX_FILE_SIZE, ALLOWED_FILE_TYPES
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                  # å…¨å±€è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”œâ”€â”€ useApi.ts           # APIè°ƒç”¨Hook
â”‚   â”‚   â”œâ”€â”€ useUpload.ts        # æ–‡ä»¶ä¸Šä¼ Hook
â”‚   â”‚   â””â”€â”€ useModal.ts         # Modalæ§åˆ¶Hook
â”‚   â”‚
â”‚   â”œâ”€â”€ App.tsx                 # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ main.tsx                # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ routes.tsx              # è·¯ç”±é…ç½®
â”‚       # Route: /diagnosis/single â†’ SingleDiagnosis
â”‚       # Route: /diagnosis/batch â†’ BatchDiagnosis
â”‚       # Route: /ontology â†’ OntologyManagement
â”‚       # Route: /knowledge â†’ KnowledgeManagement
â”‚
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   # VITE_API_BASE_URL=http://localhost:8000/api/v1
â”‚   # VITE_MAX_FILE_SIZE=10485760
â”‚
â”œâ”€â”€ .eslintrc.js                # ESLinté…ç½®
â”œâ”€â”€ .prettierrc                 # Prettieré…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts              # Viteé…ç½®ï¼ˆå«ä»£ç†ï¼‰
â””â”€â”€ README.md
```

**ç›®å½•ç»“æ„è®¾è®¡è¯´æ˜**ï¼š
1. **åˆ†å±‚æ¸…æ™°**: apiå±‚ã€componentå±‚ã€pageå±‚ã€storeå±‚èŒè´£æ˜ç¡®
2. **ç»„ä»¶åŒ–**: æ¯ä¸ªç»„ä»¶ç‹¬ç«‹ç›®å½•ï¼ŒåŒ…å«tsx + style.css
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
4. **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨Zustandæˆ–Piniaè¿›è¡ŒçŠ¶æ€ç®¡ç†
5. **å·¥å…·å‡½æ•°**: ç»Ÿä¸€çš„å·¥å…·å‡½æ•°å’Œå¸¸é‡å®šä¹‰

---

## 5. æ ¸å¿ƒæœåŠ¡ä¸æ¨¡å—è¯¦ç»†è®¾è®¡ âœ…

> **âœ… æ¥è‡ªv1.0**: æœ¬ç« å†…å®¹æ¥è‡ªè¯¦ç»†è®¾è®¡æ–‡æ¡£v1.0ï¼Œä¿æŒä¸å˜ã€‚

> **è®¾è®¡è¯´æ˜**ï¼šæœ¬ç« æ˜ç¡®åŒºåˆ†**åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰**å’Œ**åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰**ï¼Œå¹¶é˜æ˜å½¼æ­¤çš„è°ƒç”¨å…³ç³»ã€‚ç²’åº¦å¯ç²—ä½†ä¸èƒ½ç¼ºã€‚

---

### 5.1 æœåŠ¡ä¸æ¨¡å—æ€»è§ˆ

#### 5.1.1 åˆ†å±‚æ¶æ„å›¾

```mermaid
graph TB
    subgraph API["APIå±‚ (FastAPI)"]
        DiagnosisRouter["DiagnosisRouter<br/>è¯Šæ–­è·¯ç”±"]
        KnowledgeRouter["KnowledgeRouter<br/>çŸ¥è¯†åº“è·¯ç”±"]
    end

    subgraph Services["åº”ç”¨æœåŠ¡å±‚ (Application Services)"]
        DiagnosisService["DiagnosisService<br/>è¯Šæ–­æœåŠ¡"]
        KnowledgeService["KnowledgeService<br/>çŸ¥è¯†åº“æœåŠ¡"]
        ImageService["ImageService<br/>å›¾ç‰‡æœåŠ¡"]
    end

    subgraph Infrastructure["åŸºç¡€è®¾æ–½å±‚ (Infrastructure Modules)"]
        VLMClient["VLMClient<br/>VLMå®¢æˆ·ç«¯"]
        KnowledgeLoader["KnowledgeLoader<br/>çŸ¥è¯†åº“åŠ è½½å™¨"]
        DiagnosisScorer["DiagnosisScorer<br/>åŠ æƒè¯Šæ–­è¯„åˆ†å™¨"]
        FuzzyMatcher["FuzzyMatcher<br/>æ¨¡ç³ŠåŒ¹é…å¼•æ“"]
        PROOFFramework["PROOF Framework<br/>æç¤ºè¯æ¡†æ¶"]
        LocalImageStorage["LocalImageStorage<br/>æœ¬åœ°å›¾ç‰‡å­˜å‚¨"]
    end

    subgraph Persistence["æŒä¹…åŒ–å±‚"]
        PostgreSQL["PostgreSQL<br/>æ•°æ®åº“"]
        Redis["Redis<br/>ç¼“å­˜"]
        FileSystem["FileSystem<br/>æ–‡ä»¶ç³»ç»Ÿ"]
    end

    %% APIè°ƒç”¨æœåŠ¡
    DiagnosisRouter --> DiagnosisService
    KnowledgeRouter --> KnowledgeService

    %% æœåŠ¡è°ƒç”¨æ¨¡å—
    DiagnosisService --> VLMClient
    DiagnosisService --> DiagnosisScorer
    DiagnosisService --> ImageService
    DiagnosisService --> KnowledgeService

    KnowledgeService --> KnowledgeLoader

    ImageService --> LocalImageStorage
    ImageService --> PostgreSQL

    %% æ¨¡å—é—´è°ƒç”¨
    VLMClient --> PROOFFramework
    VLMClient --> Redis
    DiagnosisScorer --> FuzzyMatcher
    KnowledgeLoader --> FileSystem
    LocalImageStorage --> FileSystem
```

#### 5.1.2 è°ƒç”¨å…³ç³»çŸ©é˜µ

| è°ƒç”¨è€… \ è¢«è°ƒç”¨è€… | DiagnosisService | VLMClient | DiagnosisScorer | KnowledgeLoader | FuzzyMatcher | PROOF Framework |
|-------------------|------------------|-----------|-----------------|-----------------|--------------|-----------------|
| **DiagnosisRouter** | âœ“ | - | - | - | - | - |
| **DiagnosisService** | - | âœ“ | âœ“ | - | - | - |
| **VLMClient** | - | - | - | - | - | âœ“ |
| **DiagnosisScorer** | - | - | - | - | âœ“ | - |

**è¯´æ˜**ï¼š
- âœ“ è¡¨ç¤ºè°ƒç”¨å…³ç³»
- åº”ç”¨æœåŠ¡å±‚ä¸èƒ½ç›´æ¥ä¾èµ–æŒä¹…åŒ–å±‚ï¼ˆå¿…é¡»é€šè¿‡Repositoryæ¨¡å¼ï¼‰
- åŸºç¡€è®¾æ–½æ¨¡å—ä¹‹é—´å¯ä»¥ç›¸äº’è°ƒç”¨ï¼ˆä½†è¦é¿å…å¾ªç¯ä¾èµ–ï¼‰

---

### 5.2 åº”ç”¨æœåŠ¡ï¼ˆApplication Servicesï¼‰

> **èŒè´£**ï¼šç¼–æ’ä¸šåŠ¡æµç¨‹ï¼Œè°ƒç”¨å¤šä¸ªåŸºç¡€è®¾æ–½æ¨¡å—ååŒå·¥ä½œï¼ŒåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œæµç¨‹æ§åˆ¶ã€‚

---

#### 5.2.1 DiagnosisServiceï¼ˆè¯Šæ–­æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/diagnosis_service.py`

**èŒè´£**ï¼š
- ç¼–æ’å®Œæ•´è¯Šæ–­æµç¨‹ï¼ˆQ0-Q6é—®è¯Šåºåˆ— + ä¸‰å±‚æ¸è¿›è¯Šæ–­ï¼‰
- åè°ƒVLMå®¢æˆ·ç«¯ã€çŸ¥è¯†åº“æœåŠ¡ã€è¯„åˆ†å™¨ã€å›¾ç‰‡æœåŠ¡
- å®ç°å…œåº•é€»è¾‘ï¼ˆçŸ¥è¯†åº“å¤–ç–¾ç—…ã€VLMå¤±è´¥ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `VLMClient`ï¼šè°ƒç”¨VLMè¿›è¡Œç‰¹å¾æå–
- `KnowledgeService`ï¼šè·å–å€™é€‰ç–¾ç—…åˆ—è¡¨
- `DiagnosisScorer`ï¼šè®¡ç®—è¯Šæ–­è¯„åˆ†
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡
- `DiagnosisRepository`ï¼šä¿å­˜è¯Šæ–­è®°å½•

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisRouter`ï¼ˆFastAPIè·¯ç”±ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisService:
    """æ ¸å¿ƒè¯Šæ–­æœåŠ¡ - ç¼–æ’è¯Šæ–­æµç¨‹"""

    def __init__(
        self,
        vlm_client: VLMClient,
        knowledge_service: KnowledgeService,
        scorer: DiagnosisScorer,
        diagnosis_repo: DiagnosisRepository,
        image_service: ImageService
    ):
        self.vlm_client = vlm_client
        self.knowledge_service = knowledge_service
        self.scorer = scorer
        self.diagnosis_repo = diagnosis_repo
        self.image_service = image_service

    async def diagnose(self, image_bytes: bytes, metadata: dict = None) -> DiagnosisResult:
        """
        æ‰§è¡Œå®Œæ•´è¯Šæ–­æµç¨‹

        æµç¨‹ï¼š
        1. ä¿å­˜å›¾ç‰‡
        2. Q0é€çº§è¿‡æ»¤ï¼ˆQ0.0-Q0.5ï¼‰
        3. Q1-Q6åŠ¨æ€ç‰¹å¾æå–
        4. æ„å»ºç‰¹å¾å‘é‡
        5. è·å–å€™é€‰ç–¾ç—…ï¼ˆåŸºäºç§å±ï¼‰
        6. ç–¾ç—…åŒ¹é…ä¸è¯„åˆ†
        7. ç½®ä¿¡åº¦åˆ†å±‚å†³ç­–ï¼ˆconfirmed/suspected/å…œåº•ï¼‰
        8. ä¿å­˜è¯Šæ–­è®°å½•
        """
        pass

    async def _execute_q0_sequence(self, image_bytes: bytes) -> dict:
        """æ‰§è¡ŒQ0é€çº§è¿‡æ»¤ï¼ˆè°ƒç”¨VLMClient 6æ¬¡ï¼‰"""
        pass

    async def _execute_q1_q6_sequence(self, image_bytes: bytes, symptom_type: str) -> dict:
        """æ‰§è¡ŒQ1-Q6åŠ¨æ€ç‰¹å¾æå–ï¼ˆæ ¹æ®symptom_typeåŠ¨æ€ç”Ÿæˆé—®é¢˜ï¼‰"""
        pass

    async def _vlm_open_ended_diagnosis(self, image_bytes: bytes) -> str:
        """VLMå¼€æ”¾å¼è¯Šæ–­ï¼ˆå…œåº•ç­–ç•¥ï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisRouter.diagnose()
  â†’ DiagnosisService.diagnose()
      â†’ ImageService.save_image()           # ä¿å­˜å›¾ç‰‡
      â†’ VLMClient.call_with_fallback()       # Q0.0å†…å®¹ç±»å‹è¯†åˆ«
      â†’ VLMClient.call_with_fallback()       # Q0.1æ¤ç‰©ç±»åˆ«è¯†åˆ«
      â†’ ...                                  # Q0.2-Q0.5
      â†’ VLMClient.call_with_fallback()       # Q1-Q6ç‰¹å¾æå–
      â†’ KnowledgeService.get_diseases_by_genus()  # è·å–å€™é€‰ç–¾ç—…
      â†’ DiagnosisScorer.calculate_score()    # è®¡ç®—è¯„åˆ†
      â†’ DiagnosisRepository.save()           # ä¿å­˜è¯Šæ–­è®°å½•
```

---

#### 5.2.2 KnowledgeServiceï¼ˆçŸ¥è¯†åº“æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/knowledge_service.py`

**èŒè´£**ï¼š
- çŸ¥è¯†åº“åŠ è½½ã€é‡è½½ã€æŸ¥è¯¢
- æä¾›ç–¾ç—…åˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰èŠ±å‰å±ç­›é€‰ï¼‰
- ç®¡ç†çŸ¥è¯†åº“ç‰ˆæœ¬

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `KnowledgeLoader`ï¼šåŠ è½½JSONçŸ¥è¯†åº“

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šæŸ¥è¯¢å€™é€‰ç–¾ç—…
- `KnowledgeRouter`ï¼šç®¡ç†åå°æŸ¥è¯¢ç–¾ç—…åˆ—è¡¨

**å…³é”®æ¥å£**ï¼š

```python
class KnowledgeService:
    """çŸ¥è¯†åº“æœåŠ¡"""

    def __init__(self, loader: KnowledgeLoader):
        self.loader = loader
        self.knowledge_base: Optional[KnowledgeBaseAggregate] = None

    async def initialize(self):
        """ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½çŸ¥è¯†åº“"""
        self.knowledge_base = await self.loader.load_all()

    async def reload(self):
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆç®¡ç†åå°è°ƒç”¨ï¼‰"""
        self.knowledge_base = await self.loader.reload()

    def get_diseases_by_genus(self, genus: str) -> List[DiseaseOntology]:
        """è·å–æŒ‡å®šèŠ±å‰å±çš„ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_all_diseases(self) -> List[DiseaseOntology]:
        """è·å–æ‰€æœ‰ç–¾ç—…åˆ—è¡¨"""
        pass

    def get_disease_by_id(self, disease_id: str) -> Optional[DiseaseOntology]:
        """æ ¹æ®IDè·å–ç–¾ç—…è¯¦æƒ…"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeRouter.reload()
  â†’ KnowledgeService.reload()
      â†’ KnowledgeLoader.reload()  # é‡æ–°åŠ è½½JSONæ–‡ä»¶
```

---

#### 5.2.3 ImageServiceï¼ˆå›¾ç‰‡æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/services/image_service.py`

**èŒè´£**ï¼š
- å›¾ç‰‡ä¿å­˜ï¼ˆæŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»ï¼‰
- å›¾ç‰‡å…ƒæ•°æ®ç®¡ç†
- å‡†ç¡®æ€§æ ‡æ³¨

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `LocalImageStorage`ï¼šæœ¬åœ°æ–‡ä»¶å­˜å‚¨
- `ImageRepository`ï¼šå›¾ç‰‡å…ƒæ•°æ®æŒä¹…åŒ–

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šä¿å­˜è¯Šæ–­å›¾ç‰‡
- `AdminRouter`ï¼šå‡†ç¡®æ€§æ ‡æ³¨

**å…³é”®æ¥å£**ï¼š

```python
class ImageService:
    """å›¾ç‰‡æœåŠ¡"""

    def __init__(
        self,
        storage: LocalImageStorage,
        image_repo: ImageRepository
    ):
        self.storage = storage
        self.image_repo = image_repo

    async def save_image(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        organ: str
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„ï¼šstorage/images/unlabeled/{genus}/{year-month}/{day}/{diagnosis_id}_{disease_id}.jpg
        """
        pass

    async def update_accuracy_label(
        self,
        image_id: str,
        label: str  # "correct" / "incorrect"
    ):
        """æ›´æ–°å‡†ç¡®æ€§æ ‡ç­¾ï¼ˆç§»åŠ¨æ–‡ä»¶åˆ°correct/incorrectæ–‡ä»¶å¤¹ï¼‰"""
        pass

    async def query_images(
        self,
        genus: Optional[str] = None,
        accuracy_label: Optional[str] = None,
        date_range: Optional[tuple] = None
    ) -> List[ImageMetadata]:
        """æŸ¥è¯¢å›¾ç‰‡ï¼ˆæŒ‰èŠ±å‰å±ã€å‡†ç¡®æ€§ã€æ—¥æœŸèŒƒå›´ï¼‰"""
        pass
```

---

### 5.3 åŸºç¡€è®¾æ–½æ¨¡å—ï¼ˆInfrastructure Modulesï¼‰

> **èŒè´£**ï¼šæä¾›æŠ€æœ¯èƒ½åŠ›ï¼ˆVLMè°ƒç”¨ã€æ•°æ®åº“è®¿é—®ã€ç®—æ³•å®ç°ï¼‰ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼Œå¯ç‹¬ç«‹æµ‹è¯•ã€‚

---

#### 5.3.1 VLMClientï¼ˆVLMå®¢æˆ·ç«¯ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/client.py`

**èŒè´£**ï¼š
- VLM APIè°ƒç”¨ï¼ˆåŒ…è£…å¤šä¸ªProviderï¼‰
- Fallbackæœºåˆ¶ï¼ˆQwen â†’ ChatGPT â†’ Grok â†’ Claudeï¼‰
- ç¼“å­˜æœºåˆ¶ï¼ˆRedisï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
- é›†æˆInstructorï¼ˆè‡ªåŠ¨éªŒè¯Pydanticæ¨¡å‹ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `PROOFFramework`ï¼šè·å–æ¸²æŸ“åçš„æç¤ºè¯
- `RedisCache`ï¼šç¼“å­˜VLMå“åº”
- `VLM Providers`ï¼šå…·ä½“Providerå®ç°ï¼ˆQwenProvider, ChatGPTProviderç­‰ï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šQ0-Q6é—®è¯Šè°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class VLMClient:
    """VLMå®¢æˆ·ç«¯ - å®ç°Fallbackæœºåˆ¶ + Instructoré›†æˆ"""

    def __init__(self, providers: List[VLMProvider], cache: RedisCache):
        self.providers = providers  # æŒ‰ä¼˜å…ˆçº§æ’åºï¼šQwen, ChatGPT, Grok, Claude
        self.cache = cache

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],  # Pydanticæ¨¡å‹ï¼Œå¦‚Q00Response
        question_id: str = None
    ) -> BaseModel:
        """
        å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯

        æµç¨‹ï¼š
        1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº†question_idï¼‰
        2. ä¾æ¬¡å°è¯•å„Providerï¼ˆInstructorè‡ªåŠ¨éªŒè¯ + é‡è¯•3æ¬¡ï¼‰
        3. ç¼“å­˜ç»“æœï¼ˆttl=7å¤©ï¼‰
        4. æ‰€æœ‰Providerå¤±è´¥ â†’ æŠ›å‡ºVLMError
        """
        pass

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®ï¼švlm:{image_hash}:{question_id}"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService._execute_q0_sequence()
  â†’ VLMClient.call_with_fallback(prompt=Q0_0_PROMPT, response_model=Q00Response)
      â†’ RedisCache.get()                    # å°è¯•ç¼“å­˜
      â†’ QwenVLProvider.call()               # è°ƒç”¨Qwen VL Plus
          â†’ Instructor.chat.completions.create()  # Instructorè‡ªåŠ¨éªŒè¯
      â†’ RedisCache.set()                    # ç¼“å­˜ç»“æœ
```

---

#### 5.3.2 FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/matcher.py`

**èŒè´£**ï¼š
- é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆCOLOR_GROUPSåŒè‰²ç³»åŒ¹é…ï¼‰
- å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆSIZE_ORDERå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰
- ä½ç½®æ¨¡ç³ŠåŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼åŒ¹é…ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisScorer`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class FuzzyMatcher:
    """æ¨¡ç³ŠåŒ¹é…å¼•æ“ - å¤„ç†VLMè§‚å¯Ÿè¯¯å·®"""

    COLOR_GROUPS = {
        "é»‘è¤è‰²ç³»": ["black", "dark_brown", "brown", "dark"],
        "é»„è‰²ç³»": ["yellow", "light_yellow", "yellowish_green", "pale_yellow"],
        "ç™½è‰²ç³»": ["white", "gray_white", "off_white", "cream"],
        # ...
    }

    SIZE_ORDER = ["pinpoint", "small", "medium_small", "medium", "large"]

    def match_color(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """é¢œè‰²æ¨¡ç³ŠåŒ¹é…ï¼ˆç²¾ç¡®åŒ¹é… + åŒè‰²ç³»åŒ¹é…ï¼‰"""
        pass

    def match_size(self, observed: str, expected: str) -> bool:
        """å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆå…è®¸Â±1çº§åˆ«è¯¯å·®ï¼‰"""
        pass

    def match_location(self, observed: str, expected: Union[str, List[str]]) -> bool:
        """ä½ç½®åŒ¹é…ï¼ˆæ”¯æŒå¤šå€¼ï¼‰"""
        pass
```

---

#### 5.3.3 DiagnosisScorerï¼ˆåŠ æƒè¯Šæ–­è¯„åˆ†å™¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/scorer.py`

**èŒè´£**ï¼š
- å®ç°åŠ æƒè¯Šæ–­è¯„åˆ†ç®—æ³•
- ä¸»è¦ç‰¹å¾æƒé‡0.8ï¼ˆsymptom_type: 0.5 + color_center: 0.3ï¼‰
- æ¬¡è¦ç‰¹å¾æƒé‡0.15ã€å¯é€‰ç‰¹å¾æƒé‡0.05
- å®Œæ•´æ€§ä¿®æ­£ç³»æ•°ï¼ˆcomplete: 1.0, partial: 0.8, close_up: 0.6ï¼‰
- è¯Šæ–­è§„åˆ™åˆ¤å®šï¼ˆconfirmed/suspected/unlikelyï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼š
- `FuzzyMatcher`ï¼šç‰¹å¾åŒ¹é…æ—¶è°ƒç”¨

**è¢«è°è°ƒç”¨**ï¼š
- `DiagnosisService`ï¼šç–¾ç—…åŒ¹é…ä¸è¯„åˆ†æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class DiagnosisScorer:
    """åŠ æƒè¯Šæ–­è¯„åˆ†å™¨ - æ ¸å¿ƒè¯Šæ–­ç®—æ³•"""

    def __init__(self, matcher: FuzzyMatcher):
        self.matcher = matcher

    def calculate_score(
        self,
        observed_features: dict,      # ç‰¹å¾å‘é‡ï¼ˆä»VLMæå–ï¼‰
        disease_definition: dict      # ç–¾ç—…å®šä¹‰ï¼ˆä»çŸ¥è¯†åº“ï¼‰
    ) -> DiagnosisScore:
        """
        è®¡ç®—è¯Šæ–­åˆ†æ•°

        æµç¨‹ï¼š
        1. è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†ï¼ˆè°ƒç”¨FuzzyMatcheråŒ¹é…ï¼‰
        2. è®¡ç®—æ¬¡è¦ç‰¹å¾å¾—åˆ†
        3. è®¡ç®—å¯é€‰ç‰¹å¾å¾—åˆ†
        4. åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
        5. ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰
        6. è¿”å›DiagnosisScoreå¯¹è±¡

        è¿”å›ï¼šDiagnosisScore(
            total_score,
            major_features_score,
            minor_features_score,
            optional_features_score,
            major_matched,   # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
            major_total      # ä¸»è¦ç‰¹å¾æ€»æ•°
        )
        """
        pass

    def _calculate_major_score(self, observed: dict, major_config: dict) -> float:
        """è®¡ç®—ä¸»è¦ç‰¹å¾å¾—åˆ†"""
        pass

    def _count_major_matched(self, observed: dict, major_config: dict) -> int:
        """ç»Ÿè®¡ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡ï¼ˆç”¨äºåŒ»å­¦è¯Šæ–­é€»è¾‘åˆ¤å®šï¼‰"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
DiagnosisService.diagnose()
  â†’ DiagnosisScorer.calculate_score(feature_vector, disease)
      â†’ _calculate_major_score()
          â†’ FuzzyMatcher.match_color()     # é¢œè‰²åŒ¹é…
          â†’ FuzzyMatcher.match_size()      # å°ºå¯¸åŒ¹é…
      â†’ _calculate_minor_score()
      â†’ _calculate_optional_score()
      â†’ åº”ç”¨å®Œæ•´æ€§ä¿®æ­£ç³»æ•°
      â†’ è¿”å›DiagnosisScore
```

---

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/ontology/loader.py`

**èŒè´£**ï¼š
- åŠ è½½JSONçŸ¥è¯†åº“æ–‡ä»¶ï¼ˆç–¾ç—…ã€æ¤ç‰©ã€ç‰¹å¾ã€å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼‰
- è§£æJSON â†’ Pydanticå¯¹è±¡ï¼ˆç±»å‹å®‰å…¨ï¼‰
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆreloadæ–¹æ³•ï¼‰
- è®°å½•çŸ¥è¯†åº“ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥è¯»å–æ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `KnowledgeService`ï¼šåˆå§‹åŒ–å’Œé‡è½½æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class JSONKnowledgeLoader:
    """JSONçŸ¥è¯†åº“åŠ è½½å™¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # knowledge_base/
        self._cache = {}

    async def load_all(self) -> KnowledgeBaseAggregate:
        """
        åŠ è½½å®Œæ•´çŸ¥è¯†åº“

        æµç¨‹ï¼š
        1. åŠ è½½ç–¾ç—…æœ¬ä½“ï¼ˆknowledge_base/diseases/*.jsonï¼‰
        2. åŠ è½½æ¤ç‰©æœ¬ä½“ï¼ˆknowledge_base/plants/*.jsonï¼‰
        3. åŠ è½½ç‰¹å¾æœ¬ä½“ï¼ˆknowledge_base/features/feature_ontology.jsonï¼‰
        4. åŠ è½½å®¿ä¸»-ç–¾ç—…å…³ç³»ï¼ˆknowledge_base/host_disease/associations.jsonï¼‰
        5. è®°å½•ç‰ˆæœ¬ï¼ˆGit commit hashï¼‰
        6. è¿”å›KnowledgeBaseAggregateå¯¹è±¡
        """
        pass

    async def reload(self) -> KnowledgeBaseAggregate:
        """çƒ­æ›´æ–°çŸ¥è¯†åº“ï¼ˆæ¸…é™¤ç¼“å­˜ + é‡æ–°åŠ è½½ï¼‰"""
        pass

    def _get_git_commit_hash(self) -> str:
        """è·å–å½“å‰Git commit hashä½œä¸ºç‰ˆæœ¬å·"""
        pass
```

**è°ƒç”¨æµç¨‹ç¤ºä¾‹**ï¼š
```
KnowledgeService.initialize()
  â†’ KnowledgeLoader.load_all()
      â†’ è¯»å–knowledge_base/diseases/*.json
      â†’ JSONè§£æä¸ºDiseaseOntologyå¯¹è±¡
      â†’ è¯»å–knowledge_base/plants/*.json
      â†’ JSONè§£æä¸ºPlantOntologyå¯¹è±¡
      â†’ è¿”å›KnowledgeBaseAggregate
```

---

#### 5.3.5 PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/llm/prompts/framework.py`

**èŒè´£**ï¼š
- æä¾›PROOFæ¡†æ¶ï¼ˆPurpose + Role + Observation + Options + Formatï¼‰
- ç»“æ„åŒ–æç¤ºè¯ç¼–å†™ï¼ˆç»Ÿä¸€5å¤§ç»„ä»¶ï¼‰
- æ”¯æŒå‚æ•°åŒ–å’ŒA/Bæµ‹è¯•
- å¯¼å‡ºJSONé…ç½®ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
- èå…¥æ–¹æ³•è®ºv5.0è§†è§‰åŒ–æ–¹æ³•

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— 

**è¢«è°è°ƒç”¨**ï¼š
- `VLMClient`ï¼šæ¸²æŸ“æç¤ºè¯æ—¶è°ƒç”¨
- æç¤ºè¯å®šä¹‰æ–‡ä»¶ï¼ˆ`q0_0_content.py`, `q0_1_category.py`ç­‰ï¼‰

**å…³é”®æ¥å£**ï¼š

```python
class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        """
        åˆå§‹åŒ–PROOFæç¤ºè¯

        å‚æ•°ï¼š
        - question_id: é—®é¢˜IDï¼ˆå¦‚"Q0.0"ï¼‰
        - purpose: æç¤ºè¯ç›®çš„ï¼ˆtask + context + why_importantï¼‰
        - role: æç¤ºè¯è§’è‰²ï¼ˆrole + expertise + constraintsï¼‰
        - observation: è§‚å¯ŸæŒ‡å¯¼ï¼ˆvisual_method + visual_clues + focus_areasï¼‰
        - options: æç¤ºè¯é€‰é¡¹ï¼ˆchoices + allow_unknownï¼‰
        - format_spec: è¾“å‡ºæ ¼å¼ï¼ˆresponse_schema + examplesï¼‰
        - version: æç¤ºè¯ç‰ˆæœ¬å·
        """
        pass

    def render(self) -> str:
        """
        æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²

        æµç¨‹ï¼š
        1. æ¸²æŸ“Roleéƒ¨åˆ†
        2. æ¸²æŸ“Purposeéƒ¨åˆ†
        3. æ¸²æŸ“Observationéƒ¨åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
        4. æ¸²æŸ“Optionséƒ¨åˆ†
        5. æ¸²æŸ“Formatéƒ¨åˆ†ï¼ˆFew-shotç¤ºä¾‹ + å“åº”æ ¼å¼ï¼‰
        6. æ¸²æŸ“Constraints
        7. è¿”å›å®Œæ•´æç¤ºè¯å­—ç¬¦ä¸²
        """
        pass

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        pass
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
# infrastructure/llm/prompts/q0_2_genus.py
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            # ...
        }
    ),
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            # ...
        ],
        allow_unknown=True
    ),
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[...]
    ),
    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()
```

---

#### 5.3.6 LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

**æ–‡ä»¶è·¯å¾„**ï¼š`backend/infrastructure/storage/local_storage.py`

**èŒè´£**ï¼š
- æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå›¾ç‰‡å­˜å‚¨
- æŒ‰å‡†ç¡®ç‡+èŠ±å‰å+æ—¥æœŸåˆ†ç±»å­˜å‚¨
- æ–‡ä»¶è·¯å¾„ç”Ÿæˆï¼ˆè§„èŒƒåŒ–ï¼‰
- æ–‡ä»¶ç§»åŠ¨ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰

**ä¾èµ–çš„æ¨¡å—/æœåŠ¡**ï¼šæ— ï¼ˆç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿï¼‰

**è¢«è°è°ƒç”¨**ï¼š
- `ImageService`ï¼šä¿å­˜å›¾ç‰‡å’Œç§»åŠ¨æ–‡ä»¶æ—¶è°ƒç”¨

**å…³é”®æ¥å£**ï¼š

```python
class LocalImageStorage:
    """æœ¬åœ°å›¾ç‰‡å­˜å‚¨"""

    def __init__(self, base_path: str):
        self.base_path = Path(base_path)  # storage/images/

    async def save(
        self,
        image_bytes: bytes,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str = "unlabeled"  # unlabeled / correct / incorrect
    ) -> str:
        """
        ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨

        è·¯å¾„è§„èŒƒï¼š
        storage/images/{accuracy_label}/{genus}/{year-month}/{day}/{diagnosis_id}.jpg

        ç¤ºä¾‹ï¼š
        storage/images/unlabeled/rosa/2025-11/10/diag_20251110_001.jpg
        """
        pass

    async def move(
        self,
        old_path: str,
        new_accuracy_label: str  # correct / incorrect
    ) -> str:
        """ç§»åŠ¨æ–‡ä»¶ï¼ˆå‡†ç¡®æ€§æ ‡æ³¨æ—¶ï¼‰"""
        pass

    def get_path(
        self,
        diagnosis_id: str,
        plant_genus: str,
        accuracy_label: str
    ) -> str:
        """ç”Ÿæˆæ–‡ä»¶è·¯å¾„"""
        pass
```

---

### 5.4 æœåŠ¡ä¸æ¨¡å—å®ç°é¡ºåº

æ ¹æ®ä¾èµ–å…³ç³»ï¼Œæ¨èä»¥ä¸‹å®ç°é¡ºåºï¼š

```
ç¬¬1å±‚ï¼ˆæ— ä¾èµ–ï¼‰ï¼š
  â”œâ”€ FuzzyMatcherï¼ˆæ¨¡ç³ŠåŒ¹é…å¼•æ“ï¼‰
  â”œâ”€ PROOF Frameworkï¼ˆæç¤ºè¯æ¡†æ¶ï¼‰
  â””â”€ LocalImageStorageï¼ˆæœ¬åœ°å›¾ç‰‡å­˜å‚¨ï¼‰

ç¬¬2å±‚ï¼ˆä¾èµ–ç¬¬1å±‚ï¼‰ï¼š
  â”œâ”€ VLMClientï¼ˆä¾èµ–PROOF Frameworkï¼‰
  â”œâ”€ DiagnosisScorerï¼ˆä¾èµ–FuzzyMatcherï¼‰
  â””â”€ KnowledgeLoaderï¼ˆæ— ä¾èµ–ï¼Œå¯å¹¶è¡Œå®ç°ï¼‰

ç¬¬3å±‚ï¼ˆä¾èµ–ç¬¬2å±‚ï¼‰ï¼š
  â”œâ”€ KnowledgeServiceï¼ˆä¾èµ–KnowledgeLoaderï¼‰
  â””â”€ ImageServiceï¼ˆä¾èµ–LocalImageStorage + ImageRepositoryï¼‰

ç¬¬4å±‚ï¼ˆä¾èµ–ç¬¬3å±‚ï¼‰ï¼š
  â””â”€ DiagnosisServiceï¼ˆä¾èµ–VLMClient + DiagnosisScorer + KnowledgeService + ImageServiceï¼‰
```

---

### 5.5 å…³é”®è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæœåŠ¡/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£
2. **ä¾èµ–å€’ç½®**ï¼šæœåŠ¡ä¾èµ–æŠ½è±¡æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
3. **æ¥å£éš”ç¦»**ï¼šæ¨¡å—åªæš´éœ²å¿…è¦çš„å…¬å…±æ¥å£
4. **é¿å…å¾ªç¯ä¾èµ–**ï¼šä¸¥æ ¼æŒ‰ç…§åˆ†å±‚è°ƒç”¨ï¼ˆAPI â†’ Services â†’ Infrastructure â†’ Persistenceï¼‰

---

### 5.6 æç¤ºè¯å·¥ç¨‹æ¡†æ¶ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰

> **âš ï¸ æ¶æ„åœ°ä½è­¦ç¤º**ï¼šæç¤ºè¯æ¡†æ¶æ˜¯ PhytoOracle çš„**æ ¸å¿ƒåŸºç¡€è®¾æ–½**ï¼Œç±»ä¼¼äºæ•°æ®åº“ Schema æˆ– API å¥‘çº¦ã€‚ä¸€æ—¦å®šå‹åï¼Œä»»ä½•æ”¹åŠ¨éƒ½ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿï¼ˆVLM Providerã€è¯Šæ–­æœåŠ¡ã€æµ‹è¯•ç”¨ä¾‹ç­‰ï¼‰ã€‚è¯·æ…é‡è®¾è®¡å¹¶å……åˆ†æµ‹è¯•ã€‚

---

#### 5.6.1 é¡¹ç›®æœ¬è´¨å®šä½

**PhytoOracle çš„æ ¸å¿ƒæœ¬è´¨**ï¼š

```
PhytoOracle = æç¤ºè¯å·¥ç¨‹ (Prompt Engineering) + è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹ (Diagnostic Q&A System)
```

**ä¸¤å¤§æ ¸å¿ƒç»„ä»¶**ï¼š

1. **æç¤ºè¯å·¥ç¨‹**ï¼ˆæœ¬èŠ‚å†…å®¹ï¼‰
   - ç»“æ„åŒ–æç¤ºè¯è®¾è®¡ï¼ˆPROOF Frameworkï¼‰
   - VLM å“åº”æ ¼å¼ä¿éšœï¼ˆInstructorï¼‰
   - è§†è§‰åŒ–æ–¹æ³•èå…¥ï¼ˆæ–¹æ³•è®º v5.0ï¼‰
   - ç‰ˆæœ¬ç®¡ç†ä¸ A/B æµ‹è¯•

2. **è¯Šæ–­é€»è¾‘é—®ç­”å·¥ç¨‹**ï¼ˆDiagnosisServiceï¼‰
   - Q0-Q6 é€çº§è¿‡æ»¤æµç¨‹
   - Layer1-Layer3 æ¸è¿›è¯Šæ–­
   - çŸ¥è¯†åº“åŒ¹é…ä¸è¯„åˆ†
   - å…œåº•é€»è¾‘è®¾è®¡

**å¯å¤ç”¨æ€§**ï¼š
- âœ… æœªæ¥ç±»ä¼¼é¡¹ç›®ï¼ˆå¦‚ä½œç‰©ç–¾ç—…è¯Šæ–­ã€åŠ¨ç‰©ç–¾ç—…è¯†åˆ«ï¼‰å¯ä»¥**ç›´æ¥å¤ç”¨**æç¤ºè¯æ¡†æ¶
- âœ… åªéœ€ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡é€»è¾‘ï¼ˆç–¾ç—…çŸ¥è¯†åº“ã€ç‰¹å¾å®šä¹‰ï¼‰
- âœ… æç¤ºè¯æ¡†æ¶ä¿æŒä¸å˜ï¼Œå¤§å¹…é™ä½å¼€å‘æˆæœ¬

---

#### 5.6.2 ä¸¤å±‚è§„èŒƒæ€§è®¾è®¡

**é—®é¢˜é™ˆè¿°**ï¼š
- **å±‚æ¬¡1**ï¼šå¦‚ä½•ç»“æ„åŒ–åœ°**ç¼–å†™**æç¤ºè¯ï¼Ÿï¼ˆç¼–å†™é˜¶æ®µè§„èŒƒæ€§ï¼‰
- **å±‚æ¬¡2**ï¼šå¦‚ä½•ç¡®ä¿ VLM **è¿”å›**çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼ï¼Ÿï¼ˆè¿è¡Œæ—¶è§„èŒƒæ€§ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

| å±‚æ¬¡ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | è´£ä»»æ¨¡å— |
|------|------|---------|---------|
| **å±‚æ¬¡1** | æç¤ºè¯ç¼–å†™ä¸è§„èŒƒï¼Œéš¾ä»¥ç»´æŠ¤å’Œ A/B æµ‹è¯• | PROOF Framework | `PromptFramework` |
| **å±‚æ¬¡2** | VLM è¾“å‡ºæ ¼å¼ä¸å¯æ§ï¼Œéœ€è¦é‡è¯•å’Œå¼‚å¸¸å¤„ç† | Instructor | `VLMClient` + `Instructor` |

---

#### 5.6.3 PROOF Frameworkï¼ˆæç¤ºè¯è§„èŒƒæ€§ï¼‰

**PROOF** = **P**urpose + **R**ole + **O**bservation + **O**ptions + **F**ormat

**è®¾è®¡ç›®æ ‡**ï¼š
1. æ‰€æœ‰æç¤ºè¯éµå¾ªç»Ÿä¸€çš„ 5 å¤§ç»„ä»¶ç»“æ„
2. æ”¯æŒå‚æ•°åŒ–ï¼Œä¾¿äº A/B æµ‹è¯•
3. å¯¼å‡º JSON é…ç½®ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶
4. èå…¥æ–¹æ³•è®º v5.0 çš„è§†è§‰åŒ–æ–¹æ³•

**æ¡†æ¶åŸºç±»å®šä¹‰**ï¼š

```python
# infrastructure/llm/prompts/framework.py
from typing import List, Optional, Type, Dict
from pydantic import BaseModel
from dataclasses import dataclass
from datetime import datetime

@dataclass
class PromptPurpose:
    """æç¤ºè¯ç›®çš„"""
    task: str                          # ä»»åŠ¡æè¿°ï¼ˆä¸€å¥è¯ï¼‰
    context: Optional[str] = None      # å‰ç½®æ¡ä»¶
    why_important: Optional[str] = None  # ä¸ºä»€ä¹ˆé‡è¦ï¼ˆå¯é€‰ï¼‰

@dataclass
class PromptRole:
    """æç¤ºè¯è§’è‰²"""
    role: str                     # è§’è‰²åç§°
    expertise: List[str]          # ä¸“ä¸šçŸ¥è¯†é¢†åŸŸ
    constraints: List[str] = None # è§’è‰²é™åˆ¶

@dataclass
class PromptObservation:
    """è§‚å¯ŸæŒ‡å¯¼"""
    visual_method: Optional[str] = None      # è§†è§‰åŒ–æ–¹æ³•åç§°ï¼ˆå¦‚"Egg Yolk Metaphor"ï¼‰
    visual_clues: Optional[Dict[str, str]] = None  # è§†è§‰çº¿ç´¢
    focus_areas: Optional[List[str]] = None  # é‡ç‚¹å…³æ³¨åŒºåŸŸ

@dataclass
class Choice:
    """é€‰é¡¹"""
    label: str           # é€‰é¡¹æ ‡ç­¾
    description: str     # é€‰é¡¹æè¿°

@dataclass
class PromptOptions:
    """æç¤ºè¯é€‰é¡¹"""
    choices: List[Choice]           # é€‰é¡¹åˆ—è¡¨
    allow_unknown: bool = True      # æ˜¯å¦å…è®¸"unknown"
    allow_uncertain: bool = False   # æ˜¯å¦å…è®¸"unclear"

@dataclass
class Example:
    """Few-shot ç¤ºä¾‹"""
    input: str                      # è¾“å…¥æè¿°
    output: BaseModel               # è¾“å‡ºï¼ˆPydantic å¯¹è±¡ï¼‰

@dataclass
class PromptFormat:
    """è¾“å‡ºæ ¼å¼"""
    response_schema: Type[BaseModel]  # Pydantic å“åº”æ¨¡å‹
    examples: Optional[List[Example]] = None  # Few-shot ç¤ºä¾‹
    constraints: List[str] = None     # è¾“å‡ºçº¦æŸ

class PROOFPrompt:
    """PROOF æ¡†æ¶æç¤ºè¯"""

    def __init__(
        self,
        question_id: str,
        purpose: PromptPurpose,
        role: PromptRole,
        observation: PromptObservation,
        options: PromptOptions,
        format_spec: PromptFormat,
        version: str = "v1.0"
    ):
        self.question_id = question_id
        self.purpose = purpose
        self.role = role
        self.observation = observation
        self.options = options
        self.format_spec = format_spec
        self.version = version
        self.last_modified = datetime.now().isoformat()

    def render(self) -> str:
        """æ¸²æŸ“æˆæœ€ç»ˆçš„æç¤ºè¯å­—ç¬¦ä¸²"""
        sections = []

        # 1. Role
        sections.append(f"You are a {self.role.role}.")
        if self.role.expertise:
            sections.append(f"Your expertise: {', '.join(self.role.expertise)}.")
        sections.append("")

        # 2. Purpose
        sections.append(f"TASK: {self.purpose.task}")
        if self.purpose.context:
            sections.append(f"CONTEXT: {self.purpose.context}")
        sections.append("")

        # 3. Observationï¼ˆå¦‚æœæœ‰ï¼‰
        if self.observation.visual_method:
            sections.append(f"VISUAL METHOD ({self.observation.visual_method}):")

        if self.observation.visual_clues:
            sections.append("VISUAL CLUES:")
            for key, value in self.observation.visual_clues.items():
                sections.append(f"- {key}: {value}")
            sections.append("")

        # 4. Options
        sections.append("CHOICES:")
        for choice in self.options.choices:
            sections.append(f"- {choice.label}: {choice.description}")

        if self.options.allow_unknown:
            sections.append("- unknown (å¦‚æœä¸åœ¨ä»¥ä¸Šåˆ—è¡¨ä¸­)")
        sections.append("")

        # 5. Formatï¼ˆFew-shot ç¤ºä¾‹ï¼‰
        if self.format_spec.examples:
            sections.append("FEW-SHOT EXAMPLE:")
            for example in self.format_spec.examples:
                sections.append(f"Input: {example.input}")
                sections.append(f"Output: {example.output.model_dump_json(indent=2)}")
            sections.append("")

        # 6. Formatï¼ˆå“åº”æ ¼å¼ï¼‰
        sections.append("RESPONSE FORMAT (JSON only):")
        sections.append("```json")
        sections.append(self._generate_example_json())
        sections.append("```")
        sections.append("")

        # 7. Constraints
        sections.append("IMPORTANT: Only return JSON, no additional text.")

        return "\n".join(sections)

    def _generate_example_json(self) -> str:
        """æ ¹æ® response_schema ç”Ÿæˆç¤ºä¾‹ JSON"""
        import json
        schema = self.format_spec.response_schema.model_json_schema()
        properties = schema.get("properties", {})
        example = {}

        for key, prop in properties.items():
            if prop.get("type") == "string":
                example[key] = "example_value"
            elif prop.get("type") == "number":
                example[key] = 0.85

        return json.dumps(example, indent=2, ensure_ascii=False)

    def to_dict(self) -> dict:
        """å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰"""
        return {
            "question_id": self.question_id,
            "version": self.version,
            "last_modified": self.last_modified,
            "purpose": {
                "task": self.purpose.task,
                "context": self.purpose.context
            },
            "role": {
                "role": self.role.role,
                "expertise": self.role.expertise
            },
            "observation": {
                "visual_method": self.observation.visual_method,
                "visual_clues": self.observation.visual_clues
            },
            "options": {
                "choices": [{"label": c.label, "description": c.description} for c in self.options.choices],
                "allow_unknown": self.options.allow_unknown
            }
        }
```

**ä½¿ç”¨ç¤ºä¾‹ï¼ˆQ0.2 èŠ±å‰ç§å±è¯†åˆ«ï¼‰**ï¼š

```python
# infrastructure/llm/prompts/q0_2_genus.py
from .framework import *
from ..response_schema import Q02Response

# å®šä¹‰æç¤ºè¯å‚æ•°
q0_2_prompt = PROOFPrompt(
    question_id="Q0.2",

    # P - Purpose
    purpose=PromptPurpose(
        task="Identify the genus (å±) of this flower",
        context="The image contains an ornamental flower (confirmed by Q0.1)"
    ),

    # R - Role
    role=PromptRole(
        role="plant disease diagnosis assistant",
        expertise=["plant taxonomy", "visual morphology analysis"]
    ),

    # O - Observation
    observation=PromptObservation(
        visual_method="Compound Feature Description (æ–¹æ³•è®ºv5.0)",
        visual_clues={
            "Rosa": "Compound leaves with 5-7 leaflets, thorny stems, layered petals",
            "Prunus": "Simple oval leaves with serrated edges, 5-petal flowers, smooth bark",
            "Tulipa": "Long narrow leaves, cup-shaped flowers, smooth stem",
            "Dianthus": "Narrow linear leaves, fringed petal edges, swollen stem nodes",
            "Paeonia": "Large compound leaves, large multi-layered flowers, thick stems"
        },
        focus_areas=["leaf shape", "stem texture", "petal arrangement"]
    ),

    # O - Options
    options=PromptOptions(
        choices=[
            Choice("Rosa", "ç«ç‘°/æœˆå­£å±"),
            Choice("Prunus", "æ¨±èŠ±/æ¨±æ¡ƒå±"),
            Choice("Tulipa", "éƒé‡‘é¦™å±"),
            Choice("Dianthus", "åº·ä¹ƒé¦¨å±"),
            Choice("Paeonia", "ç‰¡ä¸¹å±")
        ],
        allow_unknown=True
    ),

    # F - Format
    format_spec=PromptFormat(
        response_schema=Q02Response,
        examples=[
            Example(
                input="Image shows a flower with compound leaves (5 leaflets), thorns on stem, pink layered petals",
                output=Q02Response(
                    choice="Rosa",
                    confidence=0.92,
                    reasoning="Compound leaves with 5 leaflets and thorny stems areå…¸å‹ç‰¹å¾ of Rosa genus"
                )
            )
        ]
    ),

    version="v1.0"
)

# æ¸²æŸ“æˆå­—ç¬¦ä¸²
Q0_2_GENUS_PROMPT = q0_2_prompt.render()

# å¯¼å‡ºä¸ºå­—å…¸ï¼ˆç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼‰
Q0_2_GENUS_CONFIG = q0_2_prompt.to_dict()
```

---

#### 5.6.4 Instructor é›†æˆï¼ˆè¾“å‡ºè§„èŒƒæ€§ï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹© Instructor**ï¼š

| å¯¹æ¯”ç»´åº¦ | è‡ªç ” ResponseValidator | Instructor | é€‰æ‹©åŸå›  |
|---------|---------------------|-----------|---------|
| **è‡ªåŠ¨é‡è¯•** | âŒ éœ€è¦æ‰‹å·¥å®ç° | âœ… å†…ç½®ï¼ˆæœ€å¤š3æ¬¡ï¼‰ | å‡å°‘ä»£ç é‡ |
| **å¤š Provider æ”¯æŒ** | âŒ éœ€è¦æ¯ä¸ª Provider é€‚é… | âœ… æ”¯æŒ 15+ Provider | è¦†ç›– Qwen/ChatGPT/Claude |
| **ç»´æŠ¤æˆæœ¬** | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ | âœ… ç¤¾åŒºç»´æŠ¤ | é™ä½æŠ€æœ¯å€º |
| **ä¾èµ–å¤§å°** | âœ… 0 | âœ… 25KB | å‡ ä¹æ— å½±å“ |
| **å­¦ä¹ æˆæœ¬** | ğŸŸ¡ éœ€è¦ç†è§£è‡ªç ”ä»£ç  | âœ… æ–‡æ¡£æ¸…æ™° | é™ä½ä¸Šæ‰‹æˆæœ¬ |

**Instructor é›†æˆæ–¹æ¡ˆ**ï¼š

```python
# infrastructure/llm/client.py
import instructor
from openai import OpenAI
from anthropic import Anthropic
from typing import Type, List
from pydantic import BaseModel

class VLMClient:
    """VLMå®¢æˆ·ç«¯ - é›†æˆ Instructor å®ç°ç»“æ„åŒ–è¾“å‡º"""

    def __init__(self):
        # åŒ…è£…å„Providerï¼ˆä½¿ç”¨ Instructorï¼‰
        self.providers = [
            instructor.from_openai(OpenAI(base_url="https://dashscope.aliyuncs.com/compatible-mode/v1")),  # Qwen
            instructor.from_openai(OpenAI()),                                                              # ChatGPT
            instructor.from_anthropic(Anthropic())                                                         # Claude
        ]
        self.current_provider_index = 0

    async def call_with_fallback(
        self,
        prompt: str,
        image: bytes,
        response_model: Type[BaseModel],
        question_id: str = None
    ) -> BaseModel:
        """å¸¦é™çº§çš„VLMè°ƒç”¨ + è‡ªåŠ¨éªŒè¯"""

        # 1. å°è¯•ç¼“å­˜ï¼ˆå¦‚æœæä¾›äº† question_idï¼‰
        if question_id:
            cache_key = self._build_cache_key(image, question_id)
            cached = await self.cache.get(cache_key)
            if cached:
                return response_model.model_validate_json(cached)

        # 2. ä¾æ¬¡å°è¯•å„Provider
        last_error = None
        for provider in self.providers:
            try:
                # Instructor è‡ªåŠ¨éªŒè¯ + é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
                response = provider.chat.completions.create(
                    model="auto-detect",
                    response_model=response_model,  # è‡ªåŠ¨éªŒè¯ Pydantic æ¨¡å‹
                    messages=[
                        {"role": "system", "content": "You are a JSON API. Always respond with valid JSON."},
                        {"role": "user", "content": [
                            {"type": "image_url", "image_url": self._encode_image(image)},
                            {"type": "text", "text": prompt}
                        ]}
                    ],
                    max_retries=3  # Instructor è‡ªåŠ¨é‡è¯•
                )

                # ç¼“å­˜ç»“æœ
                if question_id:
                    await self.cache.set(cache_key, response.model_dump_json(), ttl=7*24*3600)

                return response  # å·²ç»æ˜¯ Pydantic å¯¹è±¡ï¼Œ100% ç¬¦åˆæ ¼å¼

            except Exception as e:
                logger.warning(f"Provider {provider} failed: {e}")
                last_error = str(e)
                continue

        # 3. æ‰€æœ‰Provideréƒ½å¤±è´¥
        raise VLMError(f"All VLM providers failed. Last error: {last_error}")

    def _build_cache_key(self, image: bytes, question_id: str) -> str:
        """æ„å»ºç¼“å­˜é”®"""
        import hashlib
        image_hash = hashlib.md5(image).hexdigest()
        return f"vlm:{image_hash}:{question_id}"

    def _encode_image(self, image: bytes) -> str:
        """å°†å›¾ç‰‡ç¼–ç ä¸º base64"""
        import base64
        return f"data:image/jpeg;base64,{base64.b64encode(image).decode()}"
```

**DiagnosisService ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# application/services/diagnosis_service.py
class DiagnosisService:
    def __init__(self, vlm_client: VLMClient, knowledge_base: KnowledgeBase):
        self.vlm_client = vlm_client
        self.knowledge_base = knowledge_base

    async def diagnose(self, image: bytes) -> DiagnosisResult:
        # Layer1: Q0.0 å†…å®¹ç±»å‹è¯†åˆ«
        q0_0_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_0_CONTENT_TYPE_PROMPT.render(),
            image=image,
            response_model=Q00Response,  # Instructor è‡ªåŠ¨éªŒè¯
            question_id="Q0.0"
        )

        if q0_0_response.choice != "plant":
            return self._reject_non_plant(q0_0_response)

        # Layer1: Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«
        q0_1_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_1_PLANT_CATEGORY_PROMPT.render(),
            image=image,
            response_model=Q01Response,
            question_id="Q0.1"
        )

        if q0_1_response.choice != "flower":
            return self._reject_non_flower(q0_1_response)

        # Layer1: Q0.2 èŠ±å‰ç§å±è¯†åˆ«
        q0_2_response = await self.vlm_client.call_with_fallback(
            prompt=Q0_2_GENUS_PROMPT.render(),
            image=image,
            response_model=Q02Response,
            question_id="Q0.2"
        )

        flower_genus = q0_2_response.choice
        if flower_genus == "unknown":
            return self._fallback_unknown_genus(q0_2_response)

        # ... Q0.3 - Q0.6 é€çº§è¿‡æ»¤
        # ... Layer2: çŸ¥è¯†åº“åŒ¹é…
        # ... Layer3: ç½®ä¿¡åº¦å†³ç­–
```

---

#### 5.6.5 VLM å“åº”æ ¼å¼åè®®ï¼ˆPydantic Modelsï¼‰

æ‰€æœ‰ VLM Provider å¿…é¡»è¿”å›ä¸¥æ ¼ç¬¦åˆæ­¤åè®®çš„ JSONï¼š

```python
# infrastructure/llm/response_schema.py
from typing import Literal, Optional, List
from pydantic import BaseModel, Field

class VLMResponse(BaseModel):
    """VLMå“åº”åŸºç±»"""
    choice: str = Field(..., description="é€‰æ‹©çš„é€‰é¡¹å€¼")
    confidence: float = Field(..., ge=0.0, le=1.0, description="VLMå¯¹æ­¤ç­”æ¡ˆçš„ç½®ä¿¡åº¦")
    reasoning: Optional[str] = Field(None, description="æ¨ç†è¿‡ç¨‹ï¼ˆå¯é€‰ï¼Œè°ƒè¯•ç”¨ï¼‰")

# Q0ç³»åˆ—å“åº”æ ¼å¼
class Q00Response(VLMResponse):
    """Q0.0 å†…å®¹ç±»å‹è¯†åˆ«"""
    choice: Literal["plant", "animal", "person", "object", "landscape", "other"]

class Q01Response(VLMResponse):
    """Q0.1 æ¤ç‰©ç±»åˆ«è¯†åˆ«"""
    choice: Literal["flower", "vegetable", "tree", "crop", "grass", "other"]

class Q02Response(VLMResponse):
    """Q0.2 èŠ±å‰ç§å±è¯†åˆ«"""
    choice: Literal["Rosa", "Prunus", "Tulipa", "Dianthus", "Paeonia", "unknown"]

class Q03Response(VLMResponse):
    """Q0.3 å™¨å®˜è¯†åˆ«"""
    choice: Literal["flower", "leaf"]

class Q04Response(VLMResponse):
    """Q0.4 å®Œæ•´æ€§æ£€æŸ¥"""
    choice: Literal["complete", "partial", "close_up"]

class Q05Response(VLMResponse):
    """Q0.5 å¼‚å¸¸åˆ¤æ–­"""
    choice: Literal["healthy", "abnormal"]

# Q1-Q6åŠ¨æ€ç‰¹å¾æå–
class FeatureResponse(VLMResponse):
    """Q1-Q6ç‰¹å¾æå–å“åº”ï¼ˆåŠ¨æ€ï¼‰"""
    choice: str  # æ ¹æ®symptom_typeåŠ¨æ€å˜åŒ–
    alternatives: Optional[List[str]] = Field(None, description="å…¶ä»–å¯èƒ½çš„é€‰é¡¹ï¼ˆä¸ç¡®å®šæ—¶ï¼‰")
```

---

#### 5.6.6 æç¤ºè¯ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**æ–‡ä»¶ç»„ç»‡**ï¼š
```
infrastructure/llm/prompts/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ framework.py            # PROOF Framework åŸºç±»
â”œâ”€â”€ q0_0_content.py         # Q0.0 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_1_category.py        # Q0.1 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_2_genus.py           # Q0.2 æç¤ºè¯å®šä¹‰ï¼ˆè§ä¸Šé¢ç¤ºä¾‹ï¼‰
â”œâ”€â”€ q0_3_organ.py           # Q0.3 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_4_completeness.py    # Q0.4 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q0_5_abnormality.py     # Q0.5 æç¤ºè¯å®šä¹‰
â”œâ”€â”€ q1_q6_features.py       # Q1-Q6 åŠ¨æ€æ¨¡æ¿
â”œâ”€â”€ configs/                # JSON é…ç½®æ–‡ä»¶ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
â”‚   â”œâ”€â”€ q0_2_genus_v1.0.json
â”‚   â”œâ”€â”€ q0_2_genus_v1.1.json
â”‚   â””â”€â”€ ...
â””â”€â”€ CHANGELOG.md            # æç¤ºè¯å˜æ›´æ—¥å¿—
```

**ç‰ˆæœ¬æ§åˆ¶è§„èŒƒ**ï¼š
1. æç¤ºè¯å‚æ•°ï¼ˆPROOFPrompt å¯¹è±¡ï¼‰çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶
2. æ¯æ¬¡ä¿®æ”¹æç¤ºè¯å¿…é¡»ï¼š
   - æ›´æ–° CHANGELOG.md
   - è¿è¡Œ A/B æµ‹è¯•éªŒè¯å‡†ç¡®ç‡
   - å‡†ç¡®ç‡ä¸‹é™ >5% åˆ™å›æ»š
3. æç¤ºè¯ç‰ˆæœ¬å·ä¸çŸ¥è¯†åº“ç‰ˆæœ¬å·ç‹¬ç«‹ç®¡ç†

**CHANGELOG.md ç¤ºä¾‹**ï¼š

```markdown
# Prompt Engineering CHANGELOG

## Q0.2 èŠ±å‰ç§å±è¯†åˆ«

### v1.1 (2025-11-15)
- **æ”¹åŠ¨**: æ›´æ–° Few-shot ç¤ºä¾‹ï¼ˆä» Rosa æ”¹ä¸º Prunusï¼‰
- **åŸå› **: æµ‹è¯•å‘ç° VLM å¯¹ Prunus çš„è¯†åˆ«å‡†ç¡®ç‡è¾ƒä½
- **A/B æµ‹è¯•ç»“æœ**: å‡†ç¡®ç‡ä» 82% æå‡åˆ° 88%
- **å®¡æ‰¹äºº**: @expert_botanist

### v1.0 (2025-11-11)
- åˆå§‹ç‰ˆæœ¬
- é‡‡ç”¨ Compound Feature Description è§†è§‰åŒ–æ–¹æ³•
```

**A/B æµ‹è¯•æµç¨‹**ï¼š

```python
# tests/prompt_ab_test.py
async def ab_test_prompt(
    test_images: List[bytes],
    variant_a: PROOFPrompt,
    variant_b: PROOFPrompt
) -> dict:
    """å¯¹æ¯”ä¸¤ä¸ªæç¤ºè¯å˜ä½“çš„å‡†ç¡®ç‡"""

    accuracy_a = await test_prompts(test_images, variant_a.render())
    accuracy_b = await test_prompts(test_images, variant_b.render())

    return {
        "variant_a": {
            "version": variant_a.version,
            "accuracy": accuracy_a
        },
        "variant_b": {
            "version": variant_b.version,
            "accuracy": accuracy_b
        },
        "improvement": accuracy_b - accuracy_a
    }
```

---

#### 5.6.7 å¯å¤ç”¨æ€§è®¾è®¡

**æœªæ¥æ‰©å±•åœºæ™¯**ï¼š

| æ–°é¡¹ç›® | éœ€è¦æ”¹åŠ¨ | ä¸éœ€è¦æ”¹åŠ¨ |
|--------|---------|----------|
| **ä½œç‰©ç–¾ç—…è¯Šæ–­** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.2 é€‰é¡¹ï¼ˆä½œç‰©ç§ç±»ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€ç‰ˆæœ¬ç®¡ç† |
| **åŠ¨ç‰©ç–¾ç—…è¯†åˆ«** | çŸ¥è¯†åº“ï¼ˆç–¾ç—…å®šä¹‰ï¼‰ã€Q0.0 é€‰é¡¹ï¼ˆåŠ¨ç‰©ç±»åˆ«ï¼‰ | PROOF Frameworkã€Instructor é›†æˆã€A/B æµ‹è¯•æµç¨‹ |
| **å·¥ä¸šç¼ºé™·æ£€æµ‹** | çŸ¥è¯†åº“ï¼ˆç¼ºé™·ç±»å‹ï¼‰ã€Q0 è¿‡æ»¤é€»è¾‘ï¼ˆäº§å“ç±»åˆ«ï¼‰ | PROOF Frameworkã€ç»“æ„åŒ–è¾“å‡ºæœºåˆ¶ |

**å¤ç”¨æµç¨‹**ï¼š

1. **ä¿ç•™æç¤ºè¯æ¡†æ¶**ï¼šPROOF Framework + Instructor
2. **ä¿®æ”¹ä¸Šå±‚ä¸šåŠ¡**ï¼š
   - ä¿®æ”¹ Q0.2 çš„ `choices`ï¼ˆé€‚é…æ–°çš„åˆ†ç±»ä½“ç³»ï¼‰
   - ä¿®æ”¹çŸ¥è¯†åº“ç»“æ„ï¼ˆDiseaseOntology â†’ DefectOntologyï¼‰
   - ä¿®æ”¹è¯Šæ–­è¯„åˆ†é€»è¾‘ï¼ˆDiagnosisScorerï¼‰
3. **å¤ç”¨åŸºç¡€è®¾æ–½**ï¼š
   - VLMClientï¼ˆFallback æœºåˆ¶ï¼‰
   - ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼ˆCHANGELOG.mdï¼‰
   - A/B æµ‹è¯•æµç¨‹

---

#### 5.6.8 å®æ–½è·¯çº¿å›¾

**Phase 1: PROOF Framework å®ç°ï¼ˆ1-2å¤©ï¼‰**

- [ ] å®ç° `framework.py` åŸºç±»ï¼ˆPROOFPromptã€PromptPurpose ç­‰ï¼‰
- [ ] è¿ç§» Q0.0 - Q0.5 åˆ° PROOF æ¡†æ¶
- [ ] å¯¼å‡º JSON é…ç½®åˆ° `configs/` ç›®å½•
- [ ] å»ºç«‹ CHANGELOG.md

**Phase 2: Instructor é›†æˆï¼ˆ1å¤©ï¼‰**

- [ ] å®‰è£… Instructorï¼š`pip install instructor`ï¼ˆä»… 25KBï¼‰
- [ ] åŒ…è£… VLMClient çš„å„ Providerï¼ˆQwen/ChatGPT/Claudeï¼‰
- [ ] ä¿®æ”¹ `call_with_fallback` æ–¹æ³•ï¼Œä¼ å…¥ `response_model`
- [ ] ç§»é™¤ç°æœ‰çš„ ResponseValidatorï¼ˆInstructor å·²æä¾›ï¼‰

**Phase 3: é›†æˆæµ‹è¯•ï¼ˆ0.5å¤©ï¼‰**

- [ ] ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆQ0-Q6 å®Œæ•´æµç¨‹ï¼‰
- [ ] å¯¹æ¯”è¿ç§»å‰åçš„å‡†ç¡®ç‡
- [ ] ç›‘æ§é‡è¯•æ¬¡æ•°å’Œå“åº”æ—¶é—´

---

#### 5.6.9 ä¾èµ–ç®¡ç†

**æ–°å¢ä¾èµ–**ï¼š

```toml
# pyproject.toml
[tool.poetry.dependencies]
instructor = "^1.7.0"  # å”¯ä¸€æ–°å¢ä¾èµ–ï¼ˆ25KBï¼Œæ— é¢å¤–ä¾èµ–ï¼‰

# å·²æœ‰ä¾èµ–
pydantic = "^2.0"
fastapi = "^0.100"
```

**ä¾èµ–å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | æ–°å¢ä¾èµ– | ä¾èµ–å¤§å° | ç»´æŠ¤æˆæœ¬ |
|------|---------|---------|---------|
| è‡ªç ” ResponseValidator | æ—  | 0 | ğŸ”´ éœ€è¦å›¢é˜Ÿç»´æŠ¤ |
| Instructor | instructor | 25KB | âœ… ç¤¾åŒºç»´æŠ¤ |
| Outlines | outlines + torch | ~2GB | ğŸ”´ å¼€æºæ¨¡å‹ä¸“ç”¨ |
| LangChain | langchain + 70+ ä¾èµ– | ~500MB | ğŸ”´ è¿‡åº¦è®¾è®¡ |

**ç»“è®º**ï¼šInstructor æ˜¯æœ€è½»é‡ä¸”æœ€ç¬¦åˆéœ€æ±‚çš„é€‰æ‹©ã€‚

---
---
## 6. API è®¾è®¡ï¼ˆOpenAPI è§„èŒƒç‰‡æ®µï¼‰ğŸ”„

> **ğŸ”„ å·²ä¿®æ”¹**: æœ¬ç« åœ¨v1.0åŸºç¡€ä¸Šæ‰©å±•äº†è¯Šæ–­APIè¿”å›æ ¼å¼ï¼Œæ–°å¢çŸ¥è¯†åº“ç®¡ç†APIæ‰©å±•ï¼ˆ9ä¸ªæ¥å£ï¼Œ6.4èŠ‚ï¼‰ã€æœ¬ä½“ç®¡ç†APIæ‰©å±•ï¼ˆ2ä¸ªæ¥å£ï¼Œ6.5èŠ‚ï¼‰ã€æ‰¹é‡è¯Šæ–­APIï¼ˆ3ä¸ªæ¥å£ï¼Œ6.6èŠ‚ï¼‰ã€å›¾ç‰‡ç®¡ç†APIï¼ˆ2ä¸ªæ¥å£ï¼Œ6.7èŠ‚ï¼‰ï¼Œå…±æ–°å¢16ä¸ªAPIæ¥å£ï¼ˆéƒ¨åˆ†ä¸6.3èŠ‚æœ‰åŠŸèƒ½é‡å ï¼‰ï¼Œä½¿APIæ€»æ•°è¾¾åˆ°26ä¸ªã€‚

### 6.1 APIè®¾è®¡æ¦‚è§ˆ

PhytoOracleæä¾›RESTful APIï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½åŸŸ:
- **è¯Šæ–­API** (`/api/v1/diagnose`): æ‰§è¡ŒèŠ±å‰ç–¾ç—…è¯Šæ–­ï¼ˆå•å›¾å’Œæ‰¹é‡ï¼‰
- **çŸ¥è¯†åº“ç®¡ç†API** (`/api/v1/knowledge/*`): CRUDæ“ä½œç–¾ç—…çŸ¥è¯†åº“ï¼Œæ”¯æŒå¿«ç…§ç®¡ç†å’Œæ•°æ®éªŒè¯
- **æœ¬ä½“ç®¡ç†API** (`/api/v1/ontology/*`): æŸ¥è¯¢ç‰¹å¾æœ¬ä½“å®šä¹‰
- **æ‰¹é‡è¯Šæ–­API** (`/api/v1/diagnose/batch/*`): æ‰¹é‡ä¸Šä¼ å›¾ç‰‡å¹¶æŸ¥è¯¢è¯Šæ–­è¿›åº¦
- **å›¾ç‰‡ç®¡ç†API** (`/api/v1/images/*`): å›¾ç‰‡åˆ—è¡¨æŸ¥è¯¢å’Œå‡†ç¡®æ€§æ ‡æ³¨
- **è®¤è¯API** (`/api/v1/auth/*`): ç”¨æˆ·ç™»å½•ä¸API Keyç®¡ç†
- **å†å²è®°å½•API** (`/api/v1/history`): æŸ¥è¯¢è¯Šæ–­å†å²

**APIæ€»æ•°ç»Ÿè®¡**:
- è¯Šæ–­API: 2ä¸ªï¼ˆå•å›¾è¯Šæ–­ã€å†å²æŸ¥è¯¢ï¼‰
- çŸ¥è¯†åº“ç®¡ç†API: 14ä¸ªï¼ˆ5ä¸ªåŸºç¡€CRUD + 9ä¸ªæ‰©å±•åŠŸèƒ½ï¼‰
- æœ¬ä½“ç®¡ç†API: 4ä¸ªï¼ˆ2ä¸ªåŸºç¡€ + 2ä¸ªæ‰©å±•ï¼‰
- æ‰¹é‡è¯Šæ–­API: 3ä¸ªï¼ˆæ‰¹é‡ä¸Šä¼ ã€æŸ¥è¯¢ç»“æœã€æŸ¥è¯¢è¿›åº¦ï¼‰
- å›¾ç‰‡ç®¡ç†API: 2ä¸ªï¼ˆåˆ—è¡¨æŸ¥è¯¢ã€å‡†ç¡®æ€§æ ‡æ³¨ï¼‰
- è®¤è¯API: 2ä¸ªï¼ˆç™»å½•ã€API Keyç”Ÿæˆï¼‰
- **æ€»è®¡**: 26ä¸ªAPIæ¥å£

### 6.2 è¯Šæ–­API (Diagnosis API)

#### 6.2.1 POST /api/v1/diagnose - æ‰§è¡Œç–¾ç—…è¯Šæ–­

**è¯·æ±‚**:
```yaml
post:
  summary: æ‰§è¡Œç–¾ç—…è¯Šæ–­
  operationId: diagnose
  tags: [Diagnosis]
  security:
    - ApiKeyAuth: []
  requestBody:
    content:
      multipart/form-data:
        schema:
          type: object
          required: [image]
          properties:
            image:
              type: string
              format: binary
              description: å›¾ç‰‡æ–‡ä»¶(JPG/PNG/HEIC)
            flower_genus:
              type: string
              description: èŠ±å‰ç§å±(å¯é€‰ï¼Œæé«˜å‡†ç¡®ç‡)
              enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
  responses:
    '200':
      description: è¯Šæ–­æˆåŠŸ
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/DiagnosisResponse'
```

**å“åº”æ ¼å¼ (æ‰©å±•ç‰ˆ)**:
```json
{
  "diagnosis_id": "diag_20250114_001",
  "timestamp": "2025-01-14T10:30:45Z",

  "diagnosis": {
    "disease_id": "cherry_powdery_mildew",
    "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
    "common_name_en": "Cherry Powdery Mildew",
    "pathogen": "Podosphaera clandestina",
    "level": "confirmed",  // confirmed | suspected | unlikely
    "confidence": 0.92
  },

  "feature_vector": {
    "content_type": "plant",
    "plant_category": "flower",
    "flower_genus": "Prunus",
    "organ": "leaf",
    "completeness": "complete",
    "has_abnormality": "abnormal",
    "symptom_type": "powdery_coating",
    "color_center": "white",
    "location": "leaf_surface_both",
    "size": "large",
    "distribution": "widespread"
  },

  "scores": {
    "total_score": 0.92,
    "major_features": {
      "symptom_type": 0.5,
      "color_center": 0.3
    },
    "minor_features": {
      "location": 0.1,
      "size": 0.05
    },
    "optional_features": {
      "distribution": 0.02
    },
    "completeness_modifier": 1.0,
    "major_matched": 2,
    "major_total": 2
  },

  "reasoning": [
    "Q0.0: å›¾ç‰‡å†…å®¹ç±»å‹è¯†åˆ« â†’ plant (ç½®ä¿¡åº¦: 0.98)",
    "Q0.1: æ¤ç‰©ç±»åˆ«è¯†åˆ« â†’ flower (ç½®ä¿¡åº¦: 0.95)",
    "Q0.2: èŠ±å‰ç§å±è¯†åˆ« â†’ Prunus (ç½®ä¿¡åº¦: 0.90)",
    "Q0.3: å™¨å®˜è¯†åˆ« â†’ leaf (ç½®ä¿¡åº¦: 0.92)",
    "Q0.4: å®Œæ•´æ€§æ£€æŸ¥ â†’ complete (ç½®ä¿¡åº¦: 0.88)",
    "Q0.5: å¼‚å¸¸åˆ¤æ–­ â†’ abnormal (ç½®ä¿¡åº¦: 0.95)",
    "Q1: ç—‡çŠ¶ç±»å‹è¯†åˆ« â†’ powdery_coating (ç½®ä¿¡åº¦: 0.93)",
    "Q2: ä¸­å¿ƒé¢œè‰²è¯†åˆ« â†’ white (ç½®ä¿¡åº¦: 0.90)",
    "Q3: ç—…ç—‡ä½ç½®è¯†åˆ« â†’ leaf_surface_both (ç½®ä¿¡åº¦: 0.85)",
    "Q4: å°ºå¯¸è¯†åˆ« â†’ large (ç½®ä¿¡åº¦: 0.80)",
    "Q5: åˆ†å¸ƒæ¨¡å¼è¯†åˆ« â†’ widespread (ç½®ä¿¡åº¦: 0.88)",
    "Layer2: çŸ¥è¯†åº“åŒ¹é… â†’ cherry_powdery_mildew (å¾—åˆ†: 0.92)",
    "Layer3: åŒ»å­¦è¯Šæ–­é€»è¾‘ â†’ confirmed (ä¸»è¦ç‰¹å¾åŒ¹é…: 2/2)"
  ],

  "candidates": [
    {
      "disease_id": "cherry_powdery_mildew",
      "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
      "score": 0.92,
      "level": "confirmed"
    },
    {
      "disease_id": "rose_powdery_mildew",
      "disease_name": "ç«ç‘°ç™½ç²‰ç—…",
      "score": 0.65,
      "level": "suspected"
    }
  ],

  "vlm_provider": "qwen-vl-plus",
  "execution_time_ms": 3245,

  "metadata": {
    "image_id": "img_20250114_001",
    "image_path": "storage/images/unlabeled/prunus/2025-01/14/diag_20250114_001.jpg",
    "knowledge_base_version": "commit_abc123"
  }
}
```

#### 6.2.2 GET /api/v1/history - æŸ¥è¯¢è¯Šæ–­å†å²

**è¯·æ±‚å‚æ•°**:
- `start_date` (å¯é€‰): å¼€å§‹æ—¥æœŸ (ISO 8601æ ¼å¼)
- `end_date` (å¯é€‰): ç»“æŸæ—¥æœŸ
- `plant_genus` (å¯é€‰): èŠ±å‰å±
- `confidence_level` (å¯é€‰): ç½®ä¿¡åº¦ç­‰çº§ (confirmed | suspected | unlikely)
- `page` (å¯é€‰, é»˜è®¤1): é¡µç 
- `page_size` (å¯é€‰, é»˜è®¤20): æ¯é¡µæ¡æ•°

**å“åº”**:
```json
{
  "total": 150,
  "page": 1,
  "page_size": 20,
  "results": [
    {
      "diagnosis_id": "diag_20250114_001",
      "timestamp": "2025-01-14T10:30:45Z",
      "flower_genus": "Prunus",
      "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
      "level": "confirmed",
      "confidence": 0.92
    }
  ]
}
```

---

### 6.3 çŸ¥è¯†åº“ç®¡ç†API (Knowledge Management API)

#### 6.3.1 GET /api/v1/knowledge/diseases - è·å–ç–¾ç—…åˆ—è¡¨

**è¯·æ±‚å‚æ•°**:
- `genus` (å¯é€‰): æŒ‰èŠ±å‰å±ç­›é€‰ (Rosa | Prunus | Tulipa | Dianthus | Paeonia)
- `page` (å¯é€‰, é»˜è®¤1): é¡µç 
- `page_size` (å¯é€‰, é»˜è®¤50): æ¯é¡µæ¡æ•°

**å“åº”**:
```json
{
  "total": 24,
  "page": 1,
  "page_size": 50,
  "results": [
    {
      "disease_id": "cherry_powdery_mildew",
      "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
      "common_name_en": "Cherry Powdery Mildew",
      "pathogen": "Podosphaera clandestina",
      "affected_plants": ["Prunus"],
      "symptom_count": 5,
      "last_updated": "2025-01-10T08:00:00Z"
    }
  ]
}
```

#### 6.3.2 GET /api/v1/knowledge/diseases/{disease_id} - è·å–ç–¾ç—…è¯¦æƒ…

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID

**å“åº”**:
```json
{
  "disease_id": "cherry_powdery_mildew",
  "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
  "common_name_en": "Cherry Powdery Mildew",
  "pathogen": "Podosphaera clandestina",
  "affected_plants": ["Prunus"],

  "feature_definition": {
    "symptom_type": {
      "dimension_id": "symptom_type",
      "expected_value": "powdery_coating",
      "importance_weight": 0.5,
      "is_major_feature": true
    },
    "color_center": {
      "dimension_id": "color_center",
      "expected_values": ["white", "gray_white"],
      "importance_weight": 0.3,
      "is_major_feature": true
    },
    "location": {
      "dimension_id": "location",
      "expected_values": ["leaf_surface_both", "leaf_surface_upper"],
      "importance_weight": 0.1,
      "is_major_feature": false
    }
  },

  "vlm_description": {
    "symptom_type": "ç™½è‰²ç²‰çŠ¶ç‰©è¦†ç›–å¶ç‰‡è¡¨é¢ï¼Œç±»ä¼¼æ’’äº†ä¸€å±‚é¢ç²‰",
    "color_center": "ç™½è‰²è‡³ç°ç™½è‰²",
    "location": "ä¸»è¦åœ¨å¶ç‰‡ä¸Šè¡¨é¢ï¼Œä¸¥é‡æ—¶åŒé¢éƒ½æœ‰",
    "progression": "ä»å¶ç‰‡åŸºéƒ¨å‘å¶å°–æ‰©æ•£"
  },

  "diagnosis_rules": {
    "confirmed_threshold": 0.85,
    "suspected_threshold": 0.60,
    "major_features_required": 2
  },

  "metadata": {
    "created_at": "2025-01-05T12:00:00Z",
    "updated_at": "2025-01-10T08:00:00Z",
    "version": "1.2",
    "author": "phytopathologist@example.com"
  }
}
```

#### 6.3.3 POST /api/v1/knowledge/diseases - åˆ›å»ºæ–°ç–¾ç—…

**è¯·æ±‚**:
```json
{
  "disease_id": "new_disease_id",
  "disease_name": "æ–°ç–¾ç—…åç§°",
  "common_name_en": "New Disease Name",
  "pathogen": "Pathogen Name",
  "affected_plants": ["Genus1", "Genus2"],

  "feature_definition": {
    "symptom_type": {
      "dimension_id": "symptom_type",
      "expected_value": "spot",
      "importance_weight": 0.5,
      "is_major_feature": true
    }
  },

  "vlm_description": {
    "symptom_type": "ç‰¹å¾æè¿°ï¼ˆç”¨äºVLMè¯†åˆ«ï¼‰"
  },

  "diagnosis_rules": {
    "confirmed_threshold": 0.85,
    "suspected_threshold": 0.60,
    "major_features_required": 2
  }
}
```

**å“åº”**:
```json
{
  "disease_id": "new_disease_id",
  "message": "ç–¾ç—…åˆ›å»ºæˆåŠŸ",
  "created_at": "2025-01-14T10:30:45Z"
}
```

#### 6.3.4 PUT /api/v1/knowledge/diseases/{disease_id} - æ›´æ–°ç–¾ç—…ä¿¡æ¯

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID

**è¯·æ±‚**: ä¸POSTç›¸åŒç»“æ„ï¼ˆæ‰€æœ‰å­—æ®µå‡å¯é€‰ï¼Œä»…æ›´æ–°æä¾›çš„å­—æ®µï¼‰

**å“åº”**:
```json
{
  "disease_id": "cherry_powdery_mildew",
  "message": "ç–¾ç—…æ›´æ–°æˆåŠŸ",
  "updated_at": "2025-01-14T10:30:45Z",
  "version": "1.3"
}
```

#### 6.3.5 DELETE /api/v1/knowledge/diseases/{disease_id} - åˆ é™¤ç–¾ç—…

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID

**å“åº”**:
```json
{
  "disease_id": "cherry_powdery_mildew",
  "message": "ç–¾ç—…åˆ é™¤æˆåŠŸ",
  "deleted_at": "2025-01-14T10:30:45Z"
}
```

---

### 6.4 çŸ¥è¯†åº“ç®¡ç†APIæ‰©å±• (Knowledge Management API - Extended)

> **âœ¨ v2.0æ–°å¢**: æœ¬èŠ‚æ–°å¢çŸ¥è¯†åº“æ ‘ã€å¿«ç…§ç®¡ç†ã€æ•°æ®éªŒè¯ç­‰9ä¸ªAPIæ¥å£ï¼Œæ”¯æŒç•Œé¢4çš„çŸ¥è¯†åº“ç®¡ç†åŠŸèƒ½ã€‚

#### 6.4.1 GET /api/v1/knowledge/tree - è·å–çŸ¥è¯†åº“æ ‘ç»“æ„

**è¯·æ±‚å‚æ•°**: æ— 

**å“åº”**:
```json
{
  "version": "1.0",
  "last_updated": "2025-01-14T10:30:45Z",
  "total_hosts": 5,
  "total_diseases": 24,
  "hosts": [
    {
      "genus": "Rosa",
      "name_zh": "è”·è–‡å±",
      "name_en": "Rose",
      "disease_count": 6,
      "diseases": [
        {
          "disease_id": "rose_black_spot",
          "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
          "common_name_en": "Rose Black Spot",
          "pathogen": "Diplocarpon rosae",
          "severity": "high",
          "last_updated": "2025-01-10T08:00:00Z"
        },
        {
          "disease_id": "rose_powdery_mildew",
          "disease_name": "ç«ç‘°ç™½ç²‰ç—…",
          "common_name_en": "Rose Powdery Mildew",
          "pathogen": "Podosphaera pannosa",
          "severity": "medium",
          "last_updated": "2025-01-10T08:00:00Z"
        }
      ]
    },
    {
      "genus": "Prunus",
      "name_zh": "æå±",
      "name_en": "Cherry",
      "disease_count": 5,
      "diseases": [
        {
          "disease_id": "cherry_powdery_mildew",
          "disease_name": "æ¨±èŠ±ç™½ç²‰ç—…",
          "common_name_en": "Cherry Powdery Mildew",
          "pathogen": "Podosphaera clandestina",
          "severity": "medium",
          "last_updated": "2025-01-10T08:00:00Z"
        }
      ]
    }
  ]
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "InternalServerError",
  "detail": "æ— æ³•åŠ è½½çŸ¥è¯†åº“æ–‡ä»¶",
  "timestamp": "2025-01-14T10:30:45Z",
  "trace_id": "trace_abc123"
}
```

#### 6.4.2 GET /api/v1/knowledge/disease/{disease_id} - è·å–å•ä¸ªç–¾ç—…è¯¦æƒ…

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID (ä¾‹å¦‚: rose_black_spot)

**å“åº”**: ä¸6.3.2ç›¸åŒï¼ŒåŒ…å«å®Œæ•´ç–¾ç—…æœ¬ä½“ä¿¡æ¯

#### 6.4.3 POST /api/v1/knowledge/disease - åˆ›å»ºæ–°ç–¾ç—…

**è¯·æ±‚**: ä¸6.3.3ç›¸åŒ

**å“åº”**:
```json
{
  "disease_id": "new_disease_id",
  "message": "ç–¾ç—…åˆ›å»ºæˆåŠŸ",
  "created_at": "2025-01-14T10:30:45Z",
  "validation_result": {
    "is_valid": true,
    "warnings": []
  }
}
```

#### 6.4.4 PUT /api/v1/knowledge/disease/{disease_id} - æ›´æ–°ç–¾ç—…ä¿¡æ¯

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID

**è¯·æ±‚**: ä¸6.3.4ç›¸åŒ

**å“åº”**:
```json
{
  "disease_id": "cherry_powdery_mildew",
  "message": "ç–¾ç—…æ›´æ–°æˆåŠŸ",
  "updated_at": "2025-01-14T10:30:45Z",
  "version": "1.3",
  "changes": {
    "modified_fields": ["feature_vector.color_center", "diagnosis_rules.confirmed_threshold"],
    "changelog": "æ›´æ–°é¢œè‰²ç‰¹å¾å’Œè¯Šæ–­é˜ˆå€¼"
  }
}
```

#### 6.4.5 DELETE /api/v1/knowledge/disease/{disease_id} - åˆ é™¤ç–¾ç—…

**è·¯å¾„å‚æ•°**:
- `disease_id`: ç–¾ç—…ID

**å“åº”**:
```json
{
  "disease_id": "cherry_powdery_mildew",
  "message": "ç–¾ç—…åˆ é™¤æˆåŠŸ",
  "deleted_at": "2025-01-14T10:30:45Z",
  "snapshot_created": true,
  "snapshot_id": "snap_20250114_001"
}
```

#### 6.4.6 POST /api/v1/knowledge/validate - éªŒè¯ç–¾ç—…æ•°æ®æ ¼å¼

**è¯·æ±‚**:
```json
{
  "disease_data": {
    "disease_id": "new_disease_id",
    "disease_name": "æ–°ç–¾ç—…åç§°",
    "common_name_en": "New Disease Name",
    "pathogen": "Pathogen Name",
    "affected_plants": ["Genus1", "Genus2"],
    "feature_definition": {
      "symptom_type": {
        "dimension_id": "symptom_type",
        "expected_value": "spot",
        "importance_weight": 0.5,
        "is_major_feature": true
      }
    }
  }
}
```

**å“åº”**:
```json
{
  "is_valid": true,
  "validation_errors": [],
  "validation_warnings": [
    {
      "field": "feature_definition.color_center",
      "message": "å»ºè®®æ·»åŠ é¢œè‰²ç‰¹å¾ä»¥æé«˜è¯Šæ–­å‡†ç¡®ç‡",
      "severity": "warning"
    }
  ],
  "schema_version": "4.1",
  "validated_at": "2025-01-14T10:30:45Z"
}
```

**éªŒè¯å¤±è´¥å“åº”**:
```json
{
  "is_valid": false,
  "validation_errors": [
    {
      "field": "disease_id",
      "message": "ç–¾ç—…IDå·²å­˜åœ¨",
      "severity": "error"
    },
    {
      "field": "feature_definition.symptom_type.importance_weight",
      "message": "æƒé‡å¿…é¡»åœ¨0-1ä¹‹é—´",
      "severity": "error"
    }
  ],
  "validation_warnings": [],
  "schema_version": "4.1",
  "validated_at": "2025-01-14T10:30:45Z"
}
```

#### 6.4.7 POST /api/v1/knowledge/snapshot - åˆ›å»ºçŸ¥è¯†åº“å¿«ç…§

**è¯·æ±‚**:
```json
{
  "version": "1.2.0",
  "description": "æ·»åŠ 5ç§æ–°ç–¾ç—…çš„å¿«ç…§",
  "created_by": "admin@example.com"
}
```

**å“åº”**:
```json
{
  "snapshot_id": "snap_20250114_001",
  "version": "1.2.0",
  "description": "æ·»åŠ 5ç§æ–°ç–¾ç—…çš„å¿«ç…§",
  "snapshot_path": "storage/snapshots/knowledge_base_20250114_103045.tar.gz",
  "file_size_bytes": 1048576,
  "disease_count": 24,
  "created_at": "2025-01-14T10:30:45Z",
  "created_by": "admin@example.com"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "SnapshotCreationError",
  "detail": "ç£ç›˜ç©ºé—´ä¸è¶³",
  "timestamp": "2025-01-14T10:30:45Z",
  "trace_id": "trace_abc123"
}
```

#### 6.4.8 GET /api/v1/knowledge/snapshots - æŸ¥è¯¢å¿«ç…§å†å²

**è¯·æ±‚å‚æ•°**:
- `page` (å¯é€‰, é»˜è®¤1): é¡µç 
- `page_size` (å¯é€‰, é»˜è®¤20): æ¯é¡µæ¡æ•°
- `start_date` (å¯é€‰): å¼€å§‹æ—¥æœŸ (ISO 8601æ ¼å¼)
- `end_date` (å¯é€‰): ç»“æŸæ—¥æœŸ

**å“åº”**:
```json
{
  "total": 15,
  "page": 1,
  "page_size": 20,
  "snapshots": [
    {
      "snapshot_id": "snap_20250114_001",
      "version": "1.2.0",
      "description": "æ·»åŠ 5ç§æ–°ç–¾ç—…çš„å¿«ç…§",
      "snapshot_path": "storage/snapshots/knowledge_base_20250114_103045.tar.gz",
      "file_size_bytes": 1048576,
      "disease_count": 24,
      "created_at": "2025-01-14T10:30:45Z",
      "created_by": "admin@example.com"
    },
    {
      "snapshot_id": "snap_20250110_001",
      "version": "1.1.0",
      "description": "åˆå§‹ç‰ˆæœ¬",
      "snapshot_path": "storage/snapshots/knowledge_base_20250110_080000.tar.gz",
      "file_size_bytes": 983040,
      "disease_count": 19,
      "created_at": "2025-01-10T08:00:00Z",
      "created_by": "system"
    }
  ]
}
```

#### 6.4.9 POST /api/v1/knowledge/restore/{snapshot_id} - æ¢å¤åˆ°æŒ‡å®šå¿«ç…§

**è·¯å¾„å‚æ•°**:
- `snapshot_id`: å¿«ç…§ID

**è¯·æ±‚**:
```json
{
  "confirm": true,
  "create_backup": true,
  "backup_description": "æ¢å¤å‰çš„è‡ªåŠ¨å¤‡ä»½"
}
```

**å“åº”**:
```json
{
  "message": "çŸ¥è¯†åº“å·²æˆåŠŸæ¢å¤åˆ°å¿«ç…§ç‰ˆæœ¬",
  "snapshot_id": "snap_20250110_001",
  "restored_version": "1.1.0",
  "disease_count": 19,
  "backup_created": true,
  "backup_snapshot_id": "snap_20250114_002",
  "restored_at": "2025-01-14T10:30:45Z",
  "restored_by": "admin@example.com"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "SnapshotNotFoundError",
  "detail": "å¿«ç…§IDä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤",
  "timestamp": "2025-01-14T10:30:45Z",
  "trace_id": "trace_abc123"
}
```

---

### 6.5 æœ¬ä½“ç®¡ç†APIæ‰©å±• (Ontology Management API - Extended)

> **âœ¨ v2.0æ–°å¢**: æœ¬èŠ‚æ–°å¢æœ¬ä½“åˆ—è¡¨æŸ¥è¯¢APIï¼Œä¸ç°æœ‰6.8èŠ‚çš„æœ¬ä½“APIé…åˆä½¿ç”¨ã€‚

#### 6.5.1 GET /api/v1/ontology/list - è·å–æœ¬ä½“ç±»å‹åˆ—è¡¨

**è¯·æ±‚å‚æ•°**: æ— 

**å“åº”**:
```json
{
  "total_types": 5,
  "ontology_types": [
    {
      "type_id": "symptom_type",
      "type_name": "ç—‡çŠ¶ç±»å‹æœ¬ä½“",
      "description": "å®šä¹‰èŠ±å‰ç–¾ç—…çš„ç—‡çŠ¶ç±»å‹åŠæšä¸¾å€¼",
      "dimension_count": 1,
      "enum_value_count": 8,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "color",
      "type_name": "é¢œè‰²æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶é¢œè‰²çš„æ ‡å‡†æšä¸¾å€¼åŠæ¨¡ç³ŠåŒ¹é…è§„åˆ™",
      "dimension_count": 2,
      "enum_value_count": 15,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "location",
      "type_name": "ä½ç½®æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶åœ¨æ¤ç‰©å™¨å®˜ä¸Šçš„ä½ç½®",
      "dimension_count": 1,
      "enum_value_count": 12,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "size",
      "type_name": "å°ºå¯¸æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶çš„ç›¸å¯¹å°ºå¯¸åŠæ¨¡ç³ŠåŒ¹é…é¡ºåº",
      "dimension_count": 1,
      "enum_value_count": 5,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "distribution",
      "type_name": "åˆ†å¸ƒæ¨¡å¼æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶çš„åˆ†å¸ƒæ¨¡å¼",
      "dimension_count": 1,
      "enum_value_count": 6,
      "last_updated": "2025-01-10T08:00:00Z"
    }
  ]
}
```

#### 6.5.2 GET /api/v1/ontology/{type} - è·å–æŒ‡å®šæœ¬ä½“è¯¦æƒ…

**è·¯å¾„å‚æ•°**:
- `type`: æœ¬ä½“ç±»å‹ID (symptom_type | color | location | size | distribution)

**å“åº”**: ä¸6.8.2ç›¸åŒï¼Œè¿”å›æœ¬ä½“è¯¦ç»†å®šä¹‰

**è¯´æ˜**: æ­¤æ¥å£ä¸6.8.2åŠŸèƒ½ç›¸åŒ,ä¸ºä¿æŒAPIå‘½åä¸€è‡´æ€§è€Œæä¾›,å»ºè®®ä½¿ç”¨6.8.2çš„å®Œæ•´è·¯å¾„`/api/v1/ontology/{type_id}`ã€‚

---

### 6.6 æ‰¹é‡è¯Šæ–­API (Batch Diagnosis API)

> **âœ¨ v2.0æ–°å¢**: æœ¬èŠ‚æ–°å¢æ‰¹é‡è¯Šæ–­APIï¼ˆ3ä¸ªæ¥å£ï¼‰ï¼Œæ”¯æŒç•Œé¢2çš„æ‰¹é‡è¯Šæ–­åŠŸèƒ½ï¼Œé‡‡ç”¨æ‰‹åŠ¨åˆ·æ–°æ–¹æ¡ˆï¼ˆæ— WebSocket/è‡ªåŠ¨è½®è¯¢ï¼‰ã€‚

#### 6.6.1 POST /api/v1/diagnose/batch - æ‰¹é‡ä¸Šä¼ å›¾ç‰‡å¹¶è¯Šæ–­

**è¯·æ±‚**:
```yaml
post:
  summary: æ‰¹é‡ä¸Šä¼ å›¾ç‰‡å¹¶æ‰§è¡Œè¯Šæ–­
  operationId: batchDiagnose
  tags: [Diagnosis]
  security:
    - ApiKeyAuth: []
  requestBody:
    content:
      multipart/form-data:
        schema:
          type: object
          required: [images]
          properties:
            images:
              type: array
              items:
                type: string
                format: binary
              description: å›¾ç‰‡æ–‡ä»¶æ•°ç»„(JPG/PNG/HEIC)ï¼Œæœ€å¤š100å¼ 
            flower_genus:
              type: string
              description: èŠ±å‰ç§å±(å¯é€‰ï¼Œåº”ç”¨äºæ‰€æœ‰å›¾ç‰‡)
              enum: [Rosa, Prunus, Tulipa, Dianthus, Paeonia]
```

**å“åº”**:
```json
{
  "batch_id": "batch_20250114_001",
  "total_images": 50,
  "status": "processing",
  "created_at": "2025-01-14T10:30:45Z",
  "estimated_completion_time": "2025-01-14T10:35:45Z",
  "message": "æ‰¹é‡è¯Šæ–­ä»»åŠ¡å·²åˆ›å»ºï¼Œè¯·ä½¿ç”¨batch_idæŸ¥è¯¢è¿›åº¦"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "ValidationError",
  "detail": "ä¸Šä¼ å›¾ç‰‡æ•°é‡è¶…è¿‡é™åˆ¶(æœ€å¤š100å¼ )",
  "timestamp": "2025-01-14T10:30:45Z",
  "trace_id": "trace_abc123"
}
```

#### 6.6.2 GET /api/v1/diagnose/batch/{batch_id} - æŸ¥è¯¢æ‰¹é‡è¯Šæ–­ç»“æœ

**è·¯å¾„å‚æ•°**:
- `batch_id`: æ‰¹é‡è¯Šæ–­ä»»åŠ¡ID

**å“åº”**:
```json
{
  "batch_id": "batch_20250114_001",
  "status": "completed",
  "total_images": 50,
  "completed_images": 50,
  "failed_images": 0,
  "created_at": "2025-01-14T10:30:45Z",
  "completed_at": "2025-01-14T10:35:12Z",
  "execution_time_ms": 267000,

  "results": [
    {
      "image_id": "img_20250114_001",
      "image_filename": "rose_leaf_001.jpg",
      "diagnosis_id": "diag_20250114_001",
      "disease_id": "rose_black_spot",
      "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
      "level": "confirmed",
      "confidence": 0.92,
      "vlm_provider": "qwen-vl-plus",
      "execution_time_ms": 3245
    },
    {
      "image_id": "img_20250114_002",
      "image_filename": "rose_leaf_002.jpg",
      "diagnosis_id": "diag_20250114_002",
      "disease_id": "rose_powdery_mildew",
      "disease_name": "ç«ç‘°ç™½ç²‰ç—…",
      "level": "suspected",
      "confidence": 0.75,
      "vlm_provider": "qwen-vl-plus",
      "execution_time_ms": 2987
    }
  ],

  "summary": {
    "confirmed_count": 35,
    "suspected_count": 12,
    "unlikely_count": 3,
    "error_count": 0,
    "average_confidence": 0.86,
    "average_execution_time_ms": 3120
  }
}
```

**å¤„ç†ä¸­å“åº”**:
```json
{
  "batch_id": "batch_20250114_001",
  "status": "processing",
  "total_images": 50,
  "completed_images": 23,
  "failed_images": 0,
  "created_at": "2025-01-14T10:30:45Z",
  "estimated_completion_time": "2025-01-14T10:35:45Z",
  "message": "æ‰¹é‡è¯Šæ–­è¿›è¡Œä¸­ï¼Œè¯·ç¨ååˆ·æ–°æŸ¥è¯¢"
}
```

#### 6.6.3 GET /api/v1/diagnose/batch/{batch_id}/progress - æŸ¥è¯¢æ‰¹é‡è¯Šæ–­è¿›åº¦

**è·¯å¾„å‚æ•°**:
- `batch_id`: æ‰¹é‡è¯Šæ–­ä»»åŠ¡ID

**å“åº”**:
```json
{
  "batch_id": "batch_20250114_001",
  "status": "processing",
  "total_images": 50,
  "completed_images": 23,
  "failed_images": 0,
  "progress_percentage": 46,
  "current_image": {
    "image_id": "img_20250114_024",
    "image_filename": "rose_leaf_024.jpg",
    "started_at": "2025-01-14T10:33:12Z"
  },
  "created_at": "2025-01-14T10:30:45Z",
  "estimated_completion_time": "2025-01-14T10:35:45Z",
  "average_time_per_image_ms": 3200
}
```

**å®Œæˆå“åº”**:
```json
{
  "batch_id": "batch_20250114_001",
  "status": "completed",
  "total_images": 50,
  "completed_images": 50,
  "failed_images": 0,
  "progress_percentage": 100,
  "created_at": "2025-01-14T10:30:45Z",
  "completed_at": "2025-01-14T10:35:12Z",
  "message": "æ‰¹é‡è¯Šæ–­å·²å®Œæˆï¼Œå¯æŸ¥è¯¢å®Œæ•´ç»“æœ"
}
```

---

### 6.7 å›¾ç‰‡ç®¡ç†API (Image Management API)

> **âœ¨ v2.0æ–°å¢**: æœ¬èŠ‚æ–°å¢å›¾ç‰‡ç®¡ç†APIï¼ˆ2ä¸ªæ¥å£ï¼‰ï¼Œæ”¯æŒç•Œé¢1å’Œç•Œé¢2çš„å›¾ç‰‡åˆ—è¡¨æŸ¥è¯¢å’Œå‡†ç¡®æ€§æ ‡æ³¨åŠŸèƒ½ã€‚

#### 6.7.1 GET /api/v1/images - æŸ¥è¯¢å›¾ç‰‡åˆ—è¡¨

**è¯·æ±‚å‚æ•°**:
- `start_date` (å¯é€‰): å¼€å§‹æ—¥æœŸ (ISO 8601æ ¼å¼)
- `end_date` (å¯é€‰): ç»“æŸæ—¥æœŸ
- `flower_genus` (å¯é€‰): èŠ±å‰ç§å±ç­›é€‰
- `has_diagnosis` (å¯é€‰): æ˜¯å¦å·²è¯Šæ–­ (true | false)
- `accuracy_status` (å¯é€‰): å‡†ç¡®æ€§æ ‡æ³¨çŠ¶æ€ (accurate | inaccurate | not_marked)
- `page` (å¯é€‰, é»˜è®¤1): é¡µç 
- `page_size` (å¯é€‰, é»˜è®¤50): æ¯é¡µæ¡æ•°

**å“åº”**:
```json
{
  "total": 250,
  "page": 1,
  "page_size": 50,
  "images": [
    {
      "image_id": "img_20250114_001",
      "image_filename": "rose_leaf_001.jpg",
      "image_path": "storage/images/unlabeled/rosa/2025-01/14/img_20250114_001.jpg",
      "uploaded_at": "2025-01-14T10:30:45Z",
      "file_size_bytes": 524288,
      "width": 1920,
      "height": 1080,
      "format": "jpg",

      "diagnosis": {
        "diagnosis_id": "diag_20250114_001",
        "disease_id": "rose_black_spot",
        "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
        "level": "confirmed",
        "confidence": 0.92,
        "diagnosed_at": "2025-01-14T10:30:50Z"
      },

      "accuracy_status": "accurate",
      "accuracy_marked_at": "2025-01-14T11:00:00Z",
      "accuracy_marked_by": "admin@example.com"
    },
    {
      "image_id": "img_20250114_002",
      "image_filename": "rose_leaf_002.jpg",
      "image_path": "storage/images/unlabeled/rosa/2025-01/14/img_20250114_002.jpg",
      "uploaded_at": "2025-01-14T10:31:00Z",
      "file_size_bytes": 612352,
      "width": 1920,
      "height": 1080,
      "format": "jpg",

      "diagnosis": null,

      "accuracy_status": "not_marked",
      "accuracy_marked_at": null,
      "accuracy_marked_by": null
    }
  ]
}
```

#### 6.7.2 PATCH /api/v1/images/{image_id}/accuracy - æ ‡æ³¨è¯Šæ–­å‡†ç¡®æ€§

**è·¯å¾„å‚æ•°**:
- `image_id`: å›¾ç‰‡ID

**è¯·æ±‚**:
```json
{
  "accuracy_status": "accurate",
  "comment": "è¯Šæ–­ç»“æœå‡†ç¡®ï¼Œç—‡çŠ¶ç‰¹å¾è¯†åˆ«æ­£ç¡®",
  "marked_by": "expert@example.com"
}
```

**accuracy_statusæšä¸¾å€¼**:
- `accurate`: è¯Šæ–­å‡†ç¡®
- `inaccurate`: è¯Šæ–­ä¸å‡†ç¡®

**å“åº”**:
```json
{
  "image_id": "img_20250114_001",
  "accuracy_status": "accurate",
  "comment": "è¯Šæ–­ç»“æœå‡†ç¡®ï¼Œç—‡çŠ¶ç‰¹å¾è¯†åˆ«æ­£ç¡®",
  "marked_at": "2025-01-14T11:00:00Z",
  "marked_by": "expert@example.com",
  "diagnosis_id": "diag_20250114_001",
  "message": "å‡†ç¡®æ€§æ ‡æ³¨å·²ä¿å­˜"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "ValidationError",
  "detail": "è¯¥å›¾ç‰‡å°šæœªè¿›è¡Œè¯Šæ–­ï¼Œæ— æ³•æ ‡æ³¨å‡†ç¡®æ€§",
  "timestamp": "2025-01-14T11:00:00Z",
  "trace_id": "trace_abc123"
}
```

---

### 6.8 æœ¬ä½“æŸ¥è¯¢API (Ontology Query API)

> **âœ… æ¥è‡ªv1.0**: æœ¬èŠ‚å†…å®¹æ¥è‡ªv1.0ï¼Œä¿æŒä¸å˜ã€‚

#### 6.8.1 GET /api/v1/ontology - è·å–æœ¬ä½“ç±»å‹åˆ—è¡¨

**å“åº”**:
```json
{
  "ontology_types": [
    {
      "type_id": "symptom_type",
      "type_name": "ç—‡çŠ¶ç±»å‹æœ¬ä½“",
      "description": "å®šä¹‰èŠ±å‰ç–¾ç—…çš„ç—‡çŠ¶ç±»å‹åŠæšä¸¾å€¼",
      "dimension_count": 1,
      "enum_value_count": 8,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "color",
      "type_name": "é¢œè‰²æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶é¢œè‰²çš„æ ‡å‡†æšä¸¾å€¼åŠæ¨¡ç³ŠåŒ¹é…è§„åˆ™",
      "dimension_count": 1,
      "enum_value_count": 15,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "location",
      "type_name": "ä½ç½®æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶åœ¨æ¤ç‰©å™¨å®˜ä¸Šçš„ä½ç½®",
      "dimension_count": 1,
      "enum_value_count": 12,
      "last_updated": "2025-01-10T08:00:00Z"
    },
    {
      "type_id": "size",
      "type_name": "å°ºå¯¸æœ¬ä½“",
      "description": "å®šä¹‰ç—‡çŠ¶çš„ç›¸å¯¹å°ºå¯¸åŠæ¨¡ç³ŠåŒ¹é…é¡ºåº",
      "dimension_count": 1,
      "enum_value_count": 5,
      "last_updated": "2025-01-10T08:00:00Z"
    }
  ]
}
```

#### 6.8.2 GET /api/v1/ontology/{type_id} - è·å–æœ¬ä½“è¯¦æƒ…

**è·¯å¾„å‚æ•°**:
- `type_id`: æœ¬ä½“ç±»å‹ID (symptom_type | color | location | size | distribution)

**å“åº”ç¤ºä¾‹ (symptom_type)**:
```json
{
  "type_id": "symptom_type",
  "type_name": "ç—‡çŠ¶ç±»å‹æœ¬ä½“",
  "description": "å®šä¹‰èŠ±å‰ç–¾ç—…çš„ç—‡çŠ¶ç±»å‹åŠæšä¸¾å€¼",

  "dimensions": [
    {
      "dimension_id": "symptom_type",
      "dimension_name": "ç—‡çŠ¶ç±»å‹",
      "description": "ç–¾ç—…çš„ä¸»è¦ç—‡çŠ¶è¡¨ç°å½¢å¼",
      "is_required": true,
      "enum_values": [
        {
          "value": "spot",
          "label_zh": "æ–‘ç‚¹",
          "label_en": "Spot",
          "description": "åœ†å½¢æˆ–ä¸è§„åˆ™å½¢çŠ¶çš„å±€éƒ¨å˜è‰²åŒºåŸŸ",
          "vlm_visual_clues": "åœ†å½¢æˆ–æ¤­åœ†å½¢çš„å±€éƒ¨å˜è‰²åŒºåŸŸï¼Œè¾¹ç•Œæ¸…æ™°",
          "visual_examples": ["é»‘æ–‘ç—…", "è¤æ–‘ç—…"],
          "count_in_knowledge_base": 12
        },
        {
          "value": "powdery_coating",
          "label_zh": "ç²‰çŠ¶ç‰©",
          "label_en": "Powdery Coating",
          "description": "ç™½è‰²ç²‰æœ«çŠ¶è¦†ç›–ç‰©",
          "vlm_visual_clues": "ç™½è‰²ç²‰æœ«çŠ¶ç‰©è´¨è¦†ç›–å¶ç‰‡è¡¨é¢ï¼Œç±»ä¼¼æ’’äº†é¢ç²‰",
          "visual_examples": ["ç™½ç²‰ç—…"],
          "count_in_knowledge_base": 5
        },
        {
          "value": "wilting",
          "label_zh": "èè”«",
          "label_en": "Wilting",
          "description": "æ¤ç‰©ç»„ç»‡å¤±æ°´ã€ä¸‹å‚",
          "vlm_visual_clues": "å¶ç‰‡æˆ–èŠ±æœµä¸‹å‚ã€å¤±å»æŒºç«‹å§¿æ€",
          "visual_examples": ["æ¯èç—…"],
          "count_in_knowledge_base": 4
        },
        {
          "value": "deformation",
          "label_zh": "ç•¸å½¢",
          "label_en": "Deformation",
          "description": "ç»„ç»‡å½¢æ€å¼‚å¸¸",
          "vlm_visual_clues": "å¶ç‰‡å·æ›²ã€çš±ç¼©æˆ–å½¢çŠ¶æ‰­æ›²",
          "visual_examples": ["ç—…æ¯’ç—…"],
          "count_in_knowledge_base": 3
        }
      ]
    }
  ],

  "fuzzy_matching_rules": null,

  "metadata": {
    "created_at": "2025-01-05T12:00:00Z",
    "updated_at": "2025-01-10T08:00:00Z",
    "version": "1.0"
  }
}
```

**å“åº”ç¤ºä¾‹ (color)**:
```json
{
  "type_id": "color",
  "type_name": "é¢œè‰²æœ¬ä½“",
  "description": "å®šä¹‰ç—‡çŠ¶é¢œè‰²çš„æ ‡å‡†æšä¸¾å€¼åŠæ¨¡ç³ŠåŒ¹é…è§„åˆ™",

  "dimensions": [
    {
      "dimension_id": "color_center",
      "dimension_name": "ä¸­å¿ƒé¢œè‰²",
      "description": "ç—‡çŠ¶ä¸­å¿ƒåŒºåŸŸçš„ä¸»è¦é¢œè‰²",
      "is_required": true,
      "enum_values": [
        {
          "value": "black",
          "label_zh": "é»‘è‰²",
          "label_en": "Black",
          "color_group": "é»‘è¤è‰²ç³»",
          "hex_code": "#000000"
        },
        {
          "value": "dark_brown",
          "label_zh": "æ·±è¤è‰²",
          "label_en": "Dark Brown",
          "color_group": "é»‘è¤è‰²ç³»",
          "hex_code": "#3E2723"
        },
        {
          "value": "white",
          "label_zh": "ç™½è‰²",
          "label_en": "White",
          "color_group": "ç™½è‰²ç³»",
          "hex_code": "#FFFFFF"
        },
        {
          "value": "gray_white",
          "label_zh": "ç°ç™½è‰²",
          "label_en": "Gray White",
          "color_group": "ç™½è‰²ç³»",
          "hex_code": "#F5F5F5"
        }
      ]
    }
  ],

  "fuzzy_matching_rules": {
    "color_groups": {
      "é»‘è¤è‰²ç³»": ["black", "dark_brown", "brown", "dark"],
      "ç™½è‰²ç³»": ["white", "gray_white", "off_white", "cream"],
      "é»„è‰²ç³»": ["yellow", "light_yellow", "yellowish_green", "pale_yellow"],
      "çº¢è‰²ç³»": ["red", "dark_red", "reddish_brown", "purple_red"]
    },
    "matching_strategy": "exact_match_first_then_color_group",
    "description": "ä¼˜å…ˆç²¾ç¡®åŒ¹é…ï¼Œè‹¥æ— åŒ¹é…åˆ™æ£€æŸ¥åŒè‰²ç³»"
  },

  "metadata": {
    "created_at": "2025-01-05T12:00:00Z",
    "updated_at": "2025-01-10T08:00:00Z",
    "version": "1.0"
  }
}
```

---

### 6.9 è®¤è¯API (Auth API)

> **âœ… æ¥è‡ªv1.0**: æœ¬èŠ‚å†…å®¹æ¥è‡ªv1.0ï¼Œä¿æŒä¸å˜ã€‚

#### 6.9.1 POST /api/v1/auth/login - ç®¡ç†å‘˜ç™»å½•

**è¯·æ±‚**:
```json
{
  "username": "admin",
  "password": "secure_password"
}
```

**å“åº”**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 3600
}
```

#### 6.9.2 POST /api/v1/auth/api-keys - ç”ŸæˆAPI Key

**è¯·æ±‚** (éœ€è¦Bearer Token):
```json
{
  "name": "Production Key",
  "expires_in_days": 365
}
```

**å“åº”**:
```json
{
  "api_key": "phyto_1234567890abcdef",
  "name": "Production Key",
  "created_at": "2025-01-14T10:30:45Z",
  "expires_at": "2026-01-14T10:30:45Z"
}
```

---

### 6.10 é€šç”¨Schemaå®šä¹‰

> **âœ… æ¥è‡ªv1.0**: æœ¬èŠ‚å†…å®¹æ¥è‡ªv1.0ï¼Œä¿æŒä¸å˜ã€‚

```yaml
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: é”™è¯¯ç±»å‹
        detail:
          type: string
          description: é”™è¯¯è¯¦æƒ…
        timestamp:
          type: string
          format: date-time
          description: é”™è¯¯å‘ç”Ÿæ—¶é—´
        trace_id:
          type: string
          description: è¿½è¸ªIDï¼ˆç”¨äºæ—¥å¿—æŸ¥è¯¢ï¼‰
      example:
        error: "ValidationError"
        detail: "å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒï¼Œä»…æ”¯æŒJPG/PNG/HEIC"
        timestamp: "2025-01-14T10:30:45Z"
        trace_id: "trace_abc123"
```

---
## 7. æ•°æ®æ¨¡å‹ï¼ˆPydantic V2 å®Œæ•´ä»£ç ï¼‰

```python
# domain/diagnosis.py
from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, List, Dict, Any
from datetime import datetime
from enum import Enum

class ContentType(str, Enum):
    """å›¾ç‰‡å†…å®¹ç±»å‹"""
    PLANT = "plant"
    ANIMAL = "animal"
    PERSON = "person"
    OBJECT = "object"
    LANDSCAPE = "landscape"
    OTHER = "other"

class PlantCategory(str, Enum):
    """æ¤ç‰©ç±»åˆ«"""
    FLOWER = "flower"
    VEGETABLE = "vegetable"
    TREE = "tree"
    CROP = "crop"
    GRASS = "grass"
    OTHER = "other"

class FlowerGenus(str, Enum):
    """èŠ±å‰ç§å±"""
    ROSA = "Rosa"
    PRUNUS = "Prunus"
    TULIPA = "Tulipa"
    DIANTHUS = "Dianthus"
    PAEONIA = "Paeonia"
    OTHER = "Other"

class OrganType(str, Enum):
    """å™¨å®˜ç±»å‹"""
    FLOWER = "flower"
    LEAF = "leaf"

class Completeness(str, Enum):
    """å®Œæ•´æ€§"""
    COMPLETE = "complete"
    PARTIAL = "partial"
    CLOSE_UP = "close_up"

class AbnormalityStatus(str, Enum):
    """å¼‚å¸¸çŠ¶æ€"""
    HEALTHY = "healthy"
    ABNORMAL = "abnormal"

class ConfidenceLevel(str, Enum):
    """ç½®ä¿¡åº¦çº§åˆ«ï¼ˆæ‰©å±•ç‰ˆï¼ŒåŒ…å«å…œåº•çŠ¶æ€ï¼‰"""
    CONFIRMED = "confirmed"          # ç¡®è¯Šï¼ˆscore â‰¥ 0.85 ä¸” major_matched â‰¥ 2ï¼‰
    SUSPECTED = "suspected"          # ç–‘ä¼¼ï¼ˆ0.60 â‰¤ score < 0.85 ä¸” major_matched â‰¥ 1ï¼‰
    UNLIKELY = "unlikely"            # ä¸å¤ªå¯èƒ½ï¼ˆscore < 0.60 æˆ– major_matched = 0ï¼‰
    UNKNOWN = "unknown"              # çŸ¥è¯†åº“æ— æ•°æ®ï¼ˆè¯¥èŠ±å‰æœªæ”¶å½•ï¼‰
    VLM_FALLBACK = "vlm_fallback"   # VLMå…œåº•è¯Šæ–­ï¼ˆçŸ¥è¯†åº“å¤–ç–¾ç—…ï¼‰
    SYSTEM_ERROR = "system_error"    # ç³»ç»Ÿé”™è¯¯ï¼ˆVLMå®Œå…¨å¤±è´¥ï¼‰

class FeatureVector(BaseModel):
    """ç‰¹å¾å‘é‡æ¨¡å‹"""
    model_config = ConfigDict(use_enum_values=True)

    # Q0ç‰¹å¾
    content_type: ContentType
    plant_category: PlantCategory
    flower_genus: FlowerGenus
    organ: OrganType
    completeness: Completeness
    has_abnormality: AbnormalityStatus

    # Q1-Q6ç‰¹å¾
    symptom_type: Optional[str] = None
    color_center: Optional[str] = None
    color_border: Optional[str] = None
    location: Optional[str] = None
    size: Optional[str] = None
    distribution: Optional[str] = None
    additional_features: Dict[str, Any] = Field(default_factory=dict)

class DiagnosisScore(BaseModel):
    """è¯Šæ–­åˆ†æ•°æ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼ŒåŒ…å«åŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰"""
    model_config = ConfigDict(frozen=True)

    total_score: float = Field(..., ge=0, le=1)
    major_features_score: float = Field(..., ge=0, le=1)
    minor_features_score: float = Field(..., ge=0, le=1)
    optional_features_score: float = Field(..., ge=0, le=1)

    # åŒ»å­¦è¯Šæ–­é€»è¾‘æ–°å¢å­—æ®µ
    major_matched: int = Field(..., ge=0)    # ä¸»è¦ç‰¹å¾åŒ¹é…æ•°é‡
    major_total: int = Field(..., ge=0)      # ä¸»è¦ç‰¹å¾æ€»æ•°ï¼ˆé€šå¸¸ä¸º2ï¼‰

    @property
    def confidence_level(self) -> ConfidenceLevel:
        """
        è¯Šæ–­ç­‰çº§åˆ¤å®šï¼ˆä¸¥æ ¼éµå¾ªåŒ»å­¦è¯Šæ–­é€»è¾‘ï¼‰

        è§„åˆ™ï¼ˆéœ€æ±‚æ–‡æ¡£v1.3å®šä¹‰ï¼‰ï¼š
        - confirmed: total_score â‰¥ 0.85 ä¸” major_matched â‰¥ 2/2
        - suspected: 0.60 â‰¤ total_score < 0.85 ä¸” major_matched â‰¥ 1/2
        - unlikely: total_score < 0.60 æˆ– major_matched = 0
        """
        if self.total_score >= 0.85 and self.major_matched >= 2:
            return ConfidenceLevel.CONFIRMED
        elif self.total_score >= 0.60 and self.major_matched >= 1:
            return ConfidenceLevel.SUSPECTED
        return ConfidenceLevel.UNLIKELY

class DiagnosisResult(BaseModel):
    """è¯Šæ–­ç»“æœæ¨¡å‹ï¼ˆæ‰©å±•ç‰ˆï¼Œæ”¯æŒå…œåº•é€»è¾‘ï¼‰"""
    diagnosis_id: str = Field(..., pattern=r"^diag_\d{8}_\d{3}$")
    timestamp: datetime

    # è¯Šæ–­ç»“æœ
    disease_id: Optional[str] = None
    disease_name: str
    common_name_en: Optional[str] = None
    pathogen: Optional[str] = None
    level: ConfidenceLevel
    confidence: float = Field(..., ge=0, le=1)

    # å…œåº•é€»è¾‘æ–°å¢å­—æ®µ
    message: Optional[str] = None            # å…œåº•åœºæ™¯çš„è¯´æ˜ä¿¡æ¯
    suggestion: Optional[str] = None         # ç»™ç”¨æˆ·çš„å»ºè®®
    vlm_suggestion: Optional[str] = None     # VLMå¼€æ”¾å¼è¯Šæ–­ç»“æœ

    # ç‰¹å¾å‘é‡ï¼ˆå…œåº•åœºæ™¯å¯èƒ½ä¸ºç©ºï¼‰
    feature_vector: Optional[FeatureVector] = None

    # è¯„åˆ†è¯¦æƒ…ï¼ˆå…œåº•åœºæ™¯å¯èƒ½ä¸ºç©ºï¼‰
    scores: Optional[DiagnosisScore] = None

    # æ¨ç†è¿‡ç¨‹
    reasoning: List[str] = Field(default_factory=list)
    matched_rule: Optional[str] = None

    # å€™é€‰ç–¾ç—…ï¼ˆç–‘ä¼¼è¯Šæ–­æ—¶ï¼‰
    candidates: Optional[List[Dict[str, Any]]] = None

    # æ‰§è¡Œä¿¡æ¯
    vlm_provider: str
    execution_time_ms: int

    # é”™è¯¯ä¿¡æ¯
    error: Optional[str] = None

# domain/disease.py
class DiseaseOntology(BaseModel):
    """ç–¾ç—…æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    version: str = "4.1"
    disease_id: str = Field(..., min_length=3, max_length=50)
    disease_name: str = Field(..., min_length=2, max_length=100)
    common_name_en: str
    pathogen: str

    # ç‰¹å¾å‘é‡
    feature_vector: Dict[str, Any]

    # ç‰¹å¾é‡è¦æ€§
    feature_importance: Dict[str, Dict] = Field(...)

    # è¯Šæ–­è§„åˆ™
    diagnosis_rules: Dict[str, List[Dict]] = Field(...)

    # è§†è§‰æè¿°
    visual_descriptions: Dict[str, str] = Field(default_factory=dict)

    # å®¿ä¸»æ¤ç‰©
    host_plants: List[str] = Field(default_factory=list)

    # å…¸å‹ç—‡çŠ¶æè¿°
    typical_symptoms: List[str] = Field(default_factory=list)

    def get_major_features(self) -> List[Dict]:
        """è·å–ä¸»è¦ç‰¹å¾"""
        return self.feature_importance.get("major_features", {}).get("features", [])

    def get_expected_values(self, dimension: str) -> List[str]:
        """è·å–æŸç»´åº¦çš„æœŸæœ›å€¼"""
        for feature_group in self.feature_importance.values():
            for feature in feature_group.get("features", []):
                if feature.get("dimension") == dimension:
                    return feature.get("expected_values", [])
        return []

# domain/plant.py
class PlantOntology(BaseModel):
    """æ¤ç‰©æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    # åˆ†ç±»å­¦ä¿¡æ¯
    kingdom: str = "Plantae"
    family: str
    genus: str
    species: List[str] = Field(default_factory=list)
    common_names: Dict[str, str] = Field(default_factory=dict)  # {"zh": "ç«ç‘°", "en": "Rose"}

    # å™¨å®˜è§£å‰–
    organ_anatomy: Dict[str, List[str]] = Field(default_factory=dict)

    # VLMè¯†åˆ«çº¿ç´¢
    visual_cues: Dict[str, str] = Field(default_factory=dict)

    # æ˜“æ„Ÿç–¾ç—…
    susceptible_diseases: List[str] = Field(default_factory=list)

# domain/feature.py
class FeatureOntology(BaseModel):
    """ç‰¹å¾æœ¬ä½“æ¨¡å‹"""
    model_config = ConfigDict(validate_assignment=True)

    version: str = "1.0"

    # ç‰¹å¾ç»´åº¦å®šä¹‰
    dimensions: Dict[str, Dict] = Field(...)

    # æ¨¡ç³ŠåŒ¹é…è§„åˆ™
    fuzzy_matching: Dict[str, Any] = Field(...)

    # ç—‡çŠ¶ç±»å‹å®šä¹‰
    symptom_types: List[Dict[str, str]] = Field(default_factory=list)

    # é¢œè‰²å®šä¹‰
    colors: Dict[str, List[str]] = Field(default_factory=dict)

    # å°ºå¯¸å®šä¹‰
    sizes: List[str] = Field(default_factory=list)

    # åˆ†å¸ƒæ¨¡å¼å®šä¹‰
    distribution_patterns: List[str] = Field(default_factory=list)

# domain/value_objects.py
from dataclasses import dataclass

@dataclass(frozen=True)
class ImageHash:
    """å›¾ç‰‡å“ˆå¸Œå€¼å¯¹è±¡"""
    md5: str
    sha256: Optional[str] = None

    @classmethod
    def from_bytes(cls, image_bytes: bytes) -> "ImageHash":
        import hashlib
        return cls(
            md5=hashlib.md5(image_bytes).hexdigest(),
            sha256=hashlib.sha256(image_bytes).hexdigest()
        )

@dataclass(frozen=True)
class DiagnosisId:
    """è¯Šæ–­IDå€¼å¯¹è±¡"""
    value: str

    def __post_init__(self):
        import re
        if not re.match(r"^diag_\d{8}_\d{3}$", self.value):
            raise ValueError(f"Invalid diagnosis ID format: {self.value}")

    @classmethod
    def generate(cls) -> "DiagnosisId":
        from datetime import datetime
        import random
        date_str = datetime.now().strftime("%Y%m%d")
        seq = random.randint(1, 999)
        return cls(f"diag_{date_str}_{seq:03d}")
```

---

## 8. çŸ¥è¯†æœ¬ä½“è®¾è®¡ï¼ˆJSON Schema + ç¤ºä¾‹ï¼‰

### 8.1 Disease Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Disease Ontology Schema",
  "type": "object",
  "required": [
    "version",
    "disease_id",
    "disease_name",
    "feature_vector",
    "feature_importance",
    "diagnosis_rules"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+$"
    },
    "disease_id": {
      "type": "string",
      "minLength": 3,
      "maxLength": 50
    },
    "disease_name": {
      "type": "string",
      "minLength": 2,
      "maxLength": 100
    },
    "common_name_en": {
      "type": "string"
    },
    "pathogen": {
      "type": "string"
    },
    "feature_vector": {
      "type": "object",
      "properties": {
        "symptom_type": {"type": "string"},
        "color_center": {"type": ["string", "array"]},
        "color_border": {"type": ["string", "array"]},
        "location": {"type": ["string", "array"]},
        "size": {"type": "string"},
        "distribution": {"type": "string"}
      }
    },
    "feature_importance": {
      "type": "object",
      "properties": {
        "major_features": {
          "type": "object",
          "properties": {
            "_weight": {"type": "number"},
            "features": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["dimension", "expected_values", "weight"],
                "properties": {
                  "dimension": {"type": "string"},
                  "expected_values": {
                    "type": "array",
                    "items": {"type": "string"}
                  },
                  "weight": {"type": "number"},
                  "description": {"type": "string"}
                }
              }
            }
          }
        },
        "minor_features": {
          "type": "object"
        },
        "optional_features": {
          "type": "object"
        }
      }
    },
    "diagnosis_rules": {
      "type": "object"
    },
    "visual_descriptions": {
      "type": "object"
    }
  }
}
```

### 8.2 Disease Ontology ç¤ºä¾‹

```json
{
  "version": "4.1",
  "disease_id": "rose_black_spot",
  "disease_name": "ç«ç‘°é»‘æ–‘ç—…",
  "common_name_en": "Rose Black Spot",
  "pathogen": "Diplocarpon rosae",

  "feature_vector": {
    "symptom_type": "necrosis_spot",
    "color_center": ["black", "dark_brown"],
    "color_border": ["yellow", "light_yellow"],
    "location": ["lamina", "petiole"],
    "size": "medium",
    "distribution": "random"
  },

  "feature_importance": {
    "major_features": {
      "_weight": 0.8,
      "features": [
        {
          "dimension": "symptom_type",
          "expected_values": ["necrosis_spot"],
          "weight": 0.5,
          "description": "åæ­»æ€§æ–‘ç‚¹æ˜¯é»‘æ–‘ç—…çš„å…³é”®ç‰¹å¾"
        },
        {
          "dimension": "color_center",
          "expected_values": ["black", "dark_brown", "brown"],
          "weight": 0.3,
          "description": "é»‘è‰²æˆ–æ·±è¤è‰²ä¸­å¿ƒæ˜¯å…¸å‹ç‰¹å¾"
        }
      ]
    },
    "minor_features": {
      "_weight": 0.15,
      "features": [
        {
          "dimension": "color_border",
          "expected_values": ["yellow", "light_yellow"],
          "weight": 0.1,
          "description": "é»„è‰²æ™•åœˆ"
        },
        {
          "dimension": "location",
          "expected_values": ["lamina", "petiole"],
          "weight": 0.05,
          "description": "ä¸»è¦å‘ç”Ÿåœ¨å¶ç‰‡å’Œå¶æŸ„"
        }
      ]
    },
    "optional_features": {
      "_weight": 0.05,
      "features": [
        {
          "dimension": "size",
          "expected_values": ["medium", "medium_small"],
          "weight": 0.03,
          "description": "æ–‘ç‚¹å¤§å°éšç—…ç¨‹å˜åŒ–"
        },
        {
          "dimension": "distribution",
          "expected_values": ["random", "scattered"],
          "weight": 0.02,
          "description": "éšæœºåˆ†å¸ƒ"
        }
      ]
    }
  },

  "diagnosis_rules": {
    "confirmed": {
      "criteria": [
        {
          "rule_id": "R1",
          "logic": "major_features >= 2/2 AND minor_features >= 1/2",
          "confidence": 0.95,
          "description": "ä¸»è¦ç‰¹å¾å…¨éƒ¨åŒ¹é…ä¸”è‡³å°‘ä¸€ä¸ªæ¬¡è¦ç‰¹å¾åŒ¹é…"
        }
      ]
    },
    "suspected": {
      "criteria": [
        {
          "rule_id": "R2",
          "logic": "major_features >= 1/2 AND minor_features >= 1/2",
          "confidence": 0.70,
          "description": "è‡³å°‘ä¸€ä¸ªä¸»è¦ç‰¹å¾å’Œä¸€ä¸ªæ¬¡è¦ç‰¹å¾åŒ¹é…"
        }
      ]
    }
  },

  "visual_descriptions": {
    "color_border": "è§‚å¯Ÿæ–‘ç‚¹è¾¹ç¼˜ï¼Œå¯»æ‰¾åƒç…è›‹è›‹ç™½ç¯ç»•è›‹é»„çš„é»„è‰²æ™•åœˆ",
    "symptom_appearance": "æ–‘ç‚¹çœ‹èµ·æ¥åƒè¢«é¦™çƒŸçƒ«è¿‡ç•™ä¸‹çš„ç„¦ç—•",
    "progression": "æ—©æœŸä¸ºå°é»‘ç‚¹ï¼ŒåæœŸæ‰©å¤§å¹¶èåˆï¼Œå¯å¯¼è‡´å¶ç‰‡è„±è½"
  }
}
```

### 8.3 Feature Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Feature Ontology Schema",
  "type": "object",
  "properties": {
    "version": {"type": "string"},
    "dimensions": {
      "type": "object",
      "properties": {
        "symptom_type": {
          "type": "object",
          "properties": {
            "values": {
              "type": "array",
              "items": {"type": "string"}
            },
            "descriptions": {
              "type": "object"
            }
          }
        },
        "color": {
          "type": "object",
          "properties": {
            "groups": {
              "type": "object",
              "additionalProperties": {
                "type": "array",
                "items": {"type": "string"}
              }
            }
          }
        },
        "size": {
          "type": "object",
          "properties": {
            "order": {
              "type": "array",
              "items": {"type": "string"}
            },
            "visual_references": {
              "type": "object"
            }
          }
        }
      }
    },
    "fuzzy_matching": {
      "type": "object"
    }
  }
}
```

### 8.4 Host-Disease Ontology Schema

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Host-Disease Associations Schema",
  "type": "object",
  "properties": {
    "version": {"type": "string"},
    "associations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["host_genus", "disease_id", "specificity"],
        "properties": {
          "host_genus": {"type": "string"},
          "disease_id": {"type": "string"},
          "specificity": {
            "type": "string",
            "enum": ["species", "genus", "family"]
          },
          "prevalence": {
            "type": "string",
            "enum": ["common", "occasional", "rare"]
          }
        }
      }
    }
  }
}
```

---

## 9. æ•°æ®åº“è¡¨è®¾è®¡ï¼ˆPostgreSQL DDLï¼‰ğŸ”„

> **ğŸ”„ å·²ä¿®æ”¹**: æœ¬ç« åœ¨v1.0åŸºç¡€ä¸Šæ–°å¢3å¼ æ‰©å±•è¡¨ï¼ˆknowledge_snapshotsã€ontology_changesã€batch_diagnosis_sessionsï¼‰ï¼Œæ€»è¡¨æ•°ä»5å¼ å¢åŠ åˆ°8å¼ ã€‚

### 9.1 è¡¨ç»“æ„æ€»è§ˆ

MVPç‰ˆæœ¬éœ€è¦8å¼ æ ¸å¿ƒè¡¨ï¼š

**åŸºç¡€è¡¨ï¼ˆ5å¼ ï¼‰**:
- `diagnoses`ï¼šè¯Šæ–­è®°å½•ï¼ˆå­˜å‚¨æ¯æ¬¡è¯Šæ–­çš„å®Œæ•´ä¿¡æ¯ï¼‰
- `images`ï¼šå›¾ç‰‡å…ƒæ•°æ®ï¼ˆå­˜å‚¨å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯å’Œå‡†ç¡®ç‡æ ‡ç­¾ï¼‰
- `api_keys`ï¼šAPIå¯†é’¥ï¼ˆå­˜å‚¨ç”¨æˆ·è®¤è¯å¯†é’¥ï¼‰
- `admin_users`ï¼šç®¡ç†å‘˜è´¦å·ï¼ˆå­˜å‚¨ç®¡ç†åå°ç™»å½•è´¦å·ï¼‰
- `knowledge_versions`ï¼šçŸ¥è¯†åº“ç‰ˆæœ¬ï¼ˆå­˜å‚¨çŸ¥è¯†åº“åŠ è½½å†å²ï¼‰

**æ‰©å±•è¡¨ï¼ˆ3å¼ ï¼‰** - âœ¨ v2.0æ–°å¢:
- `knowledge_snapshots`ï¼šçŸ¥è¯†åº“å¿«ç…§ç®¡ç†ï¼ˆæ”¯æŒç‰ˆæœ¬å›æ»šï¼‰
- `ontology_changes`ï¼šæœ¬ä½“å˜æ›´å†å²ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰
- `batch_diagnosis_sessions`ï¼šæ‰¹é‡è¯Šæ–­ä¼šè¯ï¼ˆæ‰¹é‡è¯Šæ–­è¿›åº¦ç®¡ç†ï¼‰

### 9.2 å®Œæ•´DDLè¯­å¥

```sql
-- 1. è¯Šæ–­è®°å½•è¡¨
CREATE TABLE diagnoses (
    diagnosis_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    image_path TEXT NOT NULL,

    -- ç‰¹å¾å‘é‡ï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«Q0-Q6æ‰€æœ‰é—®é¢˜çš„å›ç­”ï¼‰
    feature_vector JSONB NOT NULL,

    -- è¯Šæ–­ç»“æœï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«status/confirmed_disease/suspected_diseasesï¼‰
    diagnosis_result JSONB NOT NULL,

    -- è¯„åˆ†è¯¦æƒ…ï¼ˆJSONæ•°ç»„ï¼ŒåŒ…å«æ¯ä¸ªå€™é€‰ç–¾ç—…çš„å¾—åˆ†æ˜ç»†ï¼‰
    scores JSONB,

    -- æ¨ç†è¿‡ç¨‹ï¼ˆJSONå­˜å‚¨ï¼ŒåŒ…å«Q1-Q6çš„VLMåŸå§‹å›ç­”ï¼‰
    reasoning JSONB,

    -- VLMæä¾›å•†ï¼ˆè®°å½•ä½¿ç”¨çš„æ¨¡å‹ï¼‰
    vlm_provider VARCHAR(50) NOT NULL,

    -- æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    execution_time_ms INTEGER,

    -- ç´¢å¼•
    CONSTRAINT valid_diagnosis_result CHECK (
        diagnosis_result ? 'status' AND
        diagnosis_result->>'status' IN ('confirmed', 'suspected', 'uncertain', 'rejected')
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_diagnoses_timestamp ON diagnoses(timestamp DESC);
CREATE INDEX idx_diagnoses_vlm_provider ON diagnoses(vlm_provider);
CREATE INDEX idx_diagnoses_result_status ON diagnoses((diagnosis_result->>'status'));
CREATE INDEX idx_diagnoses_feature_vector_genus ON diagnoses((feature_vector->>'flower_genus'));

-- 2. å›¾ç‰‡å…ƒæ•°æ®è¡¨
CREATE TABLE images (
    image_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    diagnosis_id UUID REFERENCES diagnoses(diagnosis_id) ON DELETE CASCADE,

    -- æ–‡ä»¶å­˜å‚¨è·¯å¾„
    file_path TEXT NOT NULL UNIQUE,

    -- ä¸Šä¼ æ—¶é—´
    upload_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- æ¤ç‰©ç§å±ï¼ˆä»è¯Šæ–­ç»“æœä¸­æå–ï¼‰
    plant_genus VARCHAR(100),

    -- å™¨å®˜ç±»å‹ï¼ˆleaf/flowerï¼‰
    organ VARCHAR(20),

    -- å‡†ç¡®ç‡æ ‡ç­¾ï¼ˆunlabeled/correct/incorrectï¼‰
    accuracy_label VARCHAR(20) DEFAULT 'unlabeled',

    -- å¤‡æ³¨ï¼ˆäººå·¥æ ‡æ³¨ï¼‰
    notes TEXT,

    CONSTRAINT valid_organ CHECK (organ IN ('leaf', 'flower', 'unknown')),
    CONSTRAINT valid_accuracy_label CHECK (
        accuracy_label IN ('unlabeled', 'correct', 'incorrect')
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_images_diagnosis_id ON images(diagnosis_id);
CREATE INDEX idx_images_upload_time ON images(upload_time DESC);
CREATE INDEX idx_images_plant_genus ON images(plant_genus);
CREATE INDEX idx_images_accuracy_label ON images(accuracy_label);

-- 3. APIå¯†é’¥è¡¨
CREATE TABLE api_keys (
    key_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- API Keyï¼ˆSHA256å“ˆå¸Œå­˜å‚¨ï¼ŒåŸå§‹å¯†é’¥åªåœ¨ç”Ÿæˆæ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼‰
    api_key_hash VARCHAR(64) NOT NULL UNIQUE,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼‰
    expires_at TIMESTAMPTZ,

    -- æ˜¯å¦æ¿€æ´»
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- æè¿°ï¼ˆç”¨äºæ ‡è¯†ç”¨é€”ï¼‰
    description TEXT,

    -- æœ€åä½¿ç”¨æ—¶é—´
    last_used_at TIMESTAMPTZ
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_api_keys_hash ON api_keys(api_key_hash) WHERE is_active = TRUE;
CREATE INDEX idx_api_keys_expires_at ON api_keys(expires_at) WHERE expires_at IS NOT NULL;

-- 4. ç®¡ç†å‘˜è´¦å·è¡¨
CREATE TABLE admin_users (
    user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰
    username VARCHAR(50) NOT NULL UNIQUE,

    -- å¯†ç ï¼ˆbcryptå“ˆå¸Œå­˜å‚¨ï¼‰
    password_hash VARCHAR(255) NOT NULL,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- æœ€åç™»å½•æ—¶é—´
    last_login_at TIMESTAMPTZ,

    -- æ˜¯å¦æ¿€æ´»
    is_active BOOLEAN NOT NULL DEFAULT TRUE
);

-- 5. çŸ¥è¯†åº“ç‰ˆæœ¬è¡¨
CREATE TABLE knowledge_versions (
    version_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Git Commit Hashï¼ˆå¯¹åº”çŸ¥è¯†åº“JSONçš„ç‰ˆæœ¬ï¼‰
    commit_hash VARCHAR(40) NOT NULL,

    -- åŠ è½½æ—¶é—´
    loaded_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- ç–¾ç—…æ•°é‡ï¼ˆç”¨äºå¿«é€ŸéªŒè¯çŸ¥è¯†åº“å®Œæ•´æ€§ï¼‰
    disease_count INTEGER NOT NULL,

    -- ç‰ˆæœ¬æè¿°
    description TEXT,

    -- æ˜¯å¦ä¸ºå½“å‰æ¿€æ´»ç‰ˆæœ¬
    is_current BOOLEAN NOT NULL DEFAULT FALSE
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_knowledge_versions_loaded_at ON knowledge_versions(loaded_at DESC);
CREATE UNIQUE INDEX idx_knowledge_versions_current ON knowledge_versions(is_current) WHERE is_current = TRUE;

-- ============================================================
-- âœ¨ v2.0æ–°å¢æ‰©å±•è¡¨ (Extended Tables)
-- ============================================================

-- 6. çŸ¥è¯†åº“å¿«ç…§ç®¡ç†è¡¨
CREATE TABLE knowledge_snapshots (
    snapshot_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- å¿«ç…§ç‰ˆæœ¬å·
    version VARCHAR(50) NOT NULL,

    -- å¿«ç…§æè¿°
    description TEXT,

    -- å¿«ç…§æ–‡ä»¶å­˜å‚¨è·¯å¾„
    snapshot_path VARCHAR(500) NOT NULL,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- åˆ›å»ºè€…
    created_by VARCHAR(100),

    -- ç–¾ç—…æ•°é‡å¿«ç…§
    disease_count INTEGER NOT NULL,

    -- å¿«ç…§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    file_size_bytes BIGINT,

    -- å¿«ç…§å…ƒæ•°æ®ï¼ˆJSONå­˜å‚¨ï¼‰
    metadata JSONB
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_snapshots_created_at ON knowledge_snapshots(created_at DESC);
CREATE INDEX idx_snapshots_version ON knowledge_snapshots(version);

-- 7. æœ¬ä½“å˜æ›´å†å²è¡¨
CREATE TABLE ontology_changes (
    change_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- å˜æ›´ç±»å‹ï¼ˆcreate/update/deleteï¼‰
    change_type VARCHAR(50) NOT NULL,

    -- å®ä½“IDï¼ˆç–¾ç—…IDæˆ–æœ¬ä½“ç±»å‹IDï¼‰
    entity_id VARCHAR(100) NOT NULL,

    -- å®ä½“ç±»å‹ï¼ˆdisease/ontologyï¼‰
    entity_type VARCHAR(50) NOT NULL,

    -- å˜æ›´å‰çš„å€¼ï¼ˆJSONå­˜å‚¨ï¼‰
    old_value JSONB,

    -- å˜æ›´åçš„å€¼ï¼ˆJSONå­˜å‚¨ï¼‰
    new_value JSONB,

    -- å˜æ›´è€…
    changed_by VARCHAR(100),

    -- å˜æ›´æ—¶é—´
    changed_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- å˜æ›´åŸå› /å¤‡æ³¨
    change_reason TEXT,

    CONSTRAINT valid_change_type CHECK (
        change_type IN ('create', 'update', 'delete')
    ),
    CONSTRAINT valid_entity_type CHECK (
        entity_type IN ('disease', 'ontology', 'feature')
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_ontology_changes_entity ON ontology_changes(entity_id, changed_at DESC);
CREATE INDEX idx_ontology_changes_type ON ontology_changes(entity_type, change_type);
CREATE INDEX idx_ontology_changes_time ON ontology_changes(changed_at DESC);

-- 8. æ‰¹é‡è¯Šæ–­ä¼šè¯è¡¨
CREATE TABLE batch_diagnosis_sessions (
    batch_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- æ€»å›¾ç‰‡æ•°é‡
    total_images INT NOT NULL,

    -- å·²å®Œæˆå›¾ç‰‡æ•°é‡
    completed_images INT DEFAULT 0,

    -- å¤±è´¥å›¾ç‰‡æ•°é‡
    failed_images INT DEFAULT 0,

    -- çŠ¶æ€ï¼ˆprocessing/completed/failedï¼‰
    status VARCHAR(50) NOT NULL,

    -- åˆ›å»ºæ—¶é—´
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    -- å®Œæˆæ—¶é—´
    completed_at TIMESTAMP,

    -- èŠ±å‰ç§å±ï¼ˆå¯é€‰ï¼Œåº”ç”¨äºæ‰€æœ‰å›¾ç‰‡ï¼‰
    flower_genus VARCHAR(50),

    -- è¯Šæ–­ç»“æœç»Ÿè®¡ï¼ˆJSONå­˜å‚¨ï¼‰
    result_summary JSONB,

    -- é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥æ—¶è®°å½•ï¼‰
    error_message TEXT,

    CONSTRAINT valid_status CHECK (
        status IN ('pending', 'processing', 'completed', 'failed', 'cancelled')
    ),
    CONSTRAINT valid_image_counts CHECK (
        completed_images + failed_images <= total_images
    )
);

-- ç´¢å¼•è®¾è®¡
CREATE INDEX idx_batch_sessions_status ON batch_diagnosis_sessions(status, created_at DESC);
CREATE INDEX idx_batch_sessions_created_at ON batch_diagnosis_sessions(created_at DESC);
CREATE INDEX idx_batch_sessions_genus ON batch_diagnosis_sessions(flower_genus);
```

### 9.3 åˆå§‹åŒ–æ•°æ®è„šæœ¬

```sql
-- åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦å·ï¼ˆå¯†ç ï¼šadmin123ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
-- bcrypt hash for 'admin123'
INSERT INTO admin_users (username, password_hash, is_active)
VALUES (
    'admin',
    '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5ckM.Eq0J/7mO',
    TRUE
);

-- åˆ›å»ºåˆå§‹API Keyï¼ˆç¤ºä¾‹ï¼šphyto_dev_key_12345ï¼‰
-- SHA256 hash for 'phyto_dev_key_12345'
INSERT INTO api_keys (api_key_hash, description, is_active)
VALUES (
    'f8e3d6c7b2a1e4f5d8c9b0a7e6f5d4c3b2a1f0e9d8c7b6a5f4e3d2c1b0a9f8e7',
    'Development API Key',
    TRUE
);

-- è®°å½•åˆå§‹çŸ¥è¯†åº“ç‰ˆæœ¬
INSERT INTO knowledge_versions (commit_hash, disease_count, description, is_current)
VALUES (
    'initial',
    20,
    'Initial knowledge base with 5 flowers and 20 diseases',
    TRUE
);
```

### 9.4 æ•°æ®åº“è®¿é—®å±‚æ¥å£ï¼ˆRepositoryæ¨¡å¼ï¼‰

```python
# infrastructure/persistence/repositories/diagnosis_repo.py
from typing import Optional, List
from uuid import UUID
from datetime import datetime
import asyncpg

class DiagnosisRepository:
    """è¯Šæ–­è®°å½•æ•°æ®è®¿é—®å±‚"""

    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool

    async def save(
        self,
        image_path: str,
        feature_vector: dict,
        diagnosis_result: dict,
        scores: Optional[dict],
        reasoning: dict,
        vlm_provider: str,
        execution_time_ms: int
    ) -> UUID:
        """ä¿å­˜è¯Šæ–­è®°å½•"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                INSERT INTO diagnoses (
                    image_path, feature_vector, diagnosis_result,
                    scores, reasoning, vlm_provider, execution_time_ms
                )
                VALUES ($1, $2, $3, $4, $5, $6, $7)
                RETURNING diagnosis_id
                """,
                image_path,
                feature_vector,
                diagnosis_result,
                scores,
                reasoning,
                vlm_provider,
                execution_time_ms
            )
            return row['diagnosis_id']

    async def get_by_id(self, diagnosis_id: UUID) -> Optional[dict]:
        """æ ¹æ®IDæŸ¥è¯¢è¯Šæ–­è®°å½•"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                "SELECT * FROM diagnoses WHERE diagnosis_id = $1",
                diagnosis_id
            )
            return dict(row) if row else None

    async def list_by_date_range(
        self,
        start_date: datetime,
        end_date: datetime,
        limit: int = 100,
        offset: int = 0
    ) -> List[dict]:
        """æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢è¯Šæ–­å†å²"""
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(
                """
                SELECT * FROM diagnoses
                WHERE timestamp >= $1 AND timestamp < $2
                ORDER BY timestamp DESC
                LIMIT $3 OFFSET $4
                """,
                start_date, end_date, limit, offset
            )
            return [dict(row) for row in rows]

    async def list_by_genus(
        self,
        genus: str,
        limit: int = 100
    ) -> List[dict]:
        """æŒ‰æ¤ç‰©ç§å±æŸ¥è¯¢è¯Šæ–­å†å²"""
        async with self.pool.acquire() as conn:
            rows = await conn.fetch(
                """
                SELECT * FROM diagnoses
                WHERE feature_vector->>'flower_genus' = $1
                ORDER BY timestamp DESC
                LIMIT $2
                """,
                genus, limit
            )
            return [dict(row) for row in rows]

    async def get_accuracy_stats(self) -> dict:
        """ç»Ÿè®¡å‡†ç¡®ç‡ï¼ˆåŸºäºäººå·¥æ ‡æ³¨ï¼‰"""
        async with self.pool.acquire() as conn:
            stats = await conn.fetchrow(
                """
                SELECT
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'correct') as correct_count,
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'incorrect') as incorrect_count,
                    COUNT(*) FILTER (WHERE i.accuracy_label = 'unlabeled') as unlabeled_count,
                    COUNT(*) as total_count
                FROM diagnoses d
                LEFT JOIN images i ON d.diagnosis_id = i.diagnosis_id
                """
            )
            return dict(stats)

# infrastructure/persistence/repositories/apikey_repo.py
class ApiKeyRepository:
    """API Keyæ•°æ®è®¿é—®å±‚"""

    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool

    async def verify_key(self, api_key_hash: str) -> bool:
        """éªŒè¯API Keyæ˜¯å¦æœ‰æ•ˆ"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                SELECT key_id FROM api_keys
                WHERE api_key_hash = $1
                  AND is_active = TRUE
                  AND (expires_at IS NULL OR expires_at > NOW())
                """,
                api_key_hash
            )

            if row:
                # æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
                await conn.execute(
                    "UPDATE api_keys SET last_used_at = NOW() WHERE key_id = $1",
                    row['key_id']
                )
                return True
            return False

    async def create_key(
        self,
        api_key_hash: str,
        description: str,
        expires_at: Optional[datetime] = None
    ) -> UUID:
        """åˆ›å»ºæ–°çš„API Key"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                """
                INSERT INTO api_keys (api_key_hash, description, expires_at)
                VALUES ($1, $2, $3)
                RETURNING key_id
                """,
                api_key_hash, description, expires_at
            )
            return row['key_id']
```

### 9.5 æ•°æ®åº“è¿æ¥æ± ç®¡ç†

```python
# infrastructure/persistence/database.py
import asyncpg
from typing import Optional

class Database:
    """æ•°æ®åº“è¿æ¥æ± ç®¡ç†"""

    def __init__(self):
        self.pool: Optional[asyncpg.Pool] = None

    async def connect(
        self,
        host: str,
        port: int,
        user: str,
        password: str,
        database: str,
        min_size: int = 5,
        max_size: int = 20
    ):
        """åˆ›å»ºè¿æ¥æ± """
        self.pool = await asyncpg.create_pool(
            host=host,
            port=port,
            user=user,
            password=password,
            database=database,
            min_size=min_size,
            max_size=max_size,
            command_timeout=60
        )

    async def disconnect(self):
        """å…³é—­è¿æ¥æ± """
        if self.pool:
            await self.pool.close()

    async def execute_script(self, sql_file_path: str):
        """æ‰§è¡ŒSQLè„šæœ¬ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰"""
        with open(sql_file_path, 'r') as f:
            sql = f.read()

        async with self.pool.acquire() as conn:
            await conn.execute(sql)

# ä½¿ç”¨ç¤ºä¾‹ï¼ˆåœ¨FastAPIå¯åŠ¨æ—¶ï¼‰
db = Database()

@app.on_event("startup")
async def startup():
    await db.connect(
        host=settings.DB_HOST,
        port=settings.DB_PORT,
        user=settings.DB_USER,
        password=settings.DB_PASSWORD,
        database=settings.DB_NAME
    )

@app.on_event("shutdown")
async def shutdown():
    await db.disconnect()
```

---

## 10. ç¼“å­˜ä¸ Rate Limit ç­–ç•¥

### 12.1 ç¼“å­˜ç­–ç•¥ï¼ˆMVPç®€åŒ–ç‰ˆï¼‰

**ä»…å®ç°VLMå“åº”ç¼“å­˜**ï¼š

```python
# core/cache.py
class RedisCache:
    """Redisç¼“å­˜å°è£…"""

    def __init__(self, redis_url: str):
        self.redis = redis.from_url(redis_url)

    async def get_vlm_response(
        self,
        provider: str,
        image_hash: str,
        question_id: str
    ) -> Optional[str]:
        """è·å–VLMå“åº”ç¼“å­˜"""
        key = f"vlm:{provider}:{image_hash}:{question_id}"
        return await self.redis.get(key)

    async def set_vlm_response(
        self,
        provider: str,
        image_hash: str,
        question_id: str,
        response: str,
        ttl: int = 7 * 24 * 3600  # 7å¤©
    ) -> None:
        """ç¼“å­˜VLMå“åº”"""
        key = f"vlm:{provider}:{image_hash}:{question_id}"
        await self.redis.setex(key, ttl, response)

    async def invalidate_pattern(self, pattern: str) -> int:
        """æ‰¹é‡å¤±æ•ˆç¼“å­˜"""
        keys = await self.redis.keys(pattern)
        if keys:
            return await self.redis.delete(*keys)
        return 0
```

**ç¼“å­˜é”®è®¾è®¡**ï¼š

| ç¼“å­˜ç±»å‹ | é”®æ ¼å¼ | TTL | è¯´æ˜ |
|---------|--------|-----|------|
| VLMå“åº” | `vlm:{provider}:{image_hash}:{question_id}` | 7å¤© | ç¼“å­˜VLMé—®ç­”ç»“æœ |
| çŸ¥è¯†åº“ç‰ˆæœ¬ | `kb:version` | æ°¸ä¹… | å½“å‰çŸ¥è¯†åº“ç‰ˆæœ¬ |
| è¯Šæ–­ç»“æœ | `diag:{diagnosis_id}` | 30å¤© | ç¼“å­˜å®Œæ•´è¯Šæ–­ç»“æœ |

### 12.2 Rate Limitç­–ç•¥ï¼ˆMVPä¸å®ç°ï¼‰

MVPé˜¶æ®µä¿¡ä»»ç”¨æˆ·ï¼Œä¸å®ç°Rate Limitã€‚

æœªæ¥æ‰©å±•ï¼ˆv1.2+ï¼‰ï¼š
- åŸºäºAPI Keyçš„é™æµ
- ä½¿ç”¨æ»‘åŠ¨çª—å£ç®—æ³•
- æ¯ä¸ªKeyæ¯åˆ†é’Ÿ20æ¬¡è¯·æ±‚

---

## 11. æµ‹è¯•ç­–ç•¥

### 12.1 å•å…ƒæµ‹è¯•ç­–ç•¥

**æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡**ï¼šæ ¸å¿ƒæ¨¡å— â‰¥ 80%

**é‡ç‚¹æµ‹è¯•æ¨¡å—**ï¼š
- `FuzzyMatcher`: é¢œè‰²/å°ºå¯¸æ¨¡ç³ŠåŒ¹é…é€»è¾‘
- `DiagnosisScorer`: åŠ æƒè¯„åˆ†ç®—æ³•
- `VLMClient`: Fallbackæœºåˆ¶
- `FeatureVector`: æ•°æ®éªŒè¯

**æµ‹è¯•ç¤ºä¾‹**ï¼š

```python
# tests/unit/test_matcher.py
import pytest
from infrastructure.ontology.matcher import FuzzyMatcher

class TestFuzzyMatcher:
    @pytest.fixture
    def matcher(self):
        return FuzzyMatcher()

    def test_color_exact_match(self, matcher):
        """æµ‹è¯•é¢œè‰²ç²¾ç¡®åŒ¹é…"""
        assert matcher.match_color("black", "black") == True
        assert matcher.match_color("black", "white") == False

    def test_color_group_match(self, matcher):
        """æµ‹è¯•åŒè‰²ç³»åŒ¹é…"""
        assert matcher.match_color("black", "dark_brown") == True
        assert matcher.match_color("yellow", "light_yellow") == True
        assert matcher.match_color("black", "yellow") == False

    def test_size_fuzzy_match(self, matcher):
        """æµ‹è¯•å°ºå¯¸æ¨¡ç³ŠåŒ¹é…ï¼ˆÂ±1çº§åˆ«ï¼‰"""
        assert matcher.match_size("medium", "medium") == True
        assert matcher.match_size("medium", "medium_small") == True
        assert matcher.match_size("medium", "large") == True
        assert matcher.match_size("small", "large") == False
```

### 12.2 é›†æˆæµ‹è¯•ç­–ç•¥

**æµ‹è¯•åœºæ™¯**ï¼š
- å®Œæ•´è¯Šæ–­æµç¨‹ï¼ˆå›¾ç‰‡ä¸Šä¼ â†’ç‰¹å¾æå–â†’ç–¾ç—…åŒ¹é…â†’ç»“æœè¿”å›ï¼‰
- çŸ¥è¯†åº“çƒ­æ›´æ–°ï¼ˆä¿®æ”¹JSONâ†’è§¦å‘é‡è½½â†’éªŒè¯ç”Ÿæ•ˆï¼‰
- VLMé™çº§æµç¨‹ï¼ˆä¸»Providerå¤±è´¥â†’è‡ªåŠ¨åˆ‡æ¢â†’è¿”å›ç»“æœï¼‰

```python
# tests/integration/test_diagnosis_api.py
@pytest.mark.asyncio
async def test_complete_diagnosis_flow():
    """æµ‹è¯•å®Œæ•´è¯Šæ–­æµç¨‹"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # å‡†å¤‡æµ‹è¯•å›¾ç‰‡
        with open("tests/fixtures/rose_black_spot.jpg", "rb") as f:
            files = {"image": ("test.jpg", f, "image/jpeg")}

        # å‘é€è¯Šæ–­è¯·æ±‚
        response = await client.post(
            "/api/v1/diagnose",
            files=files,
            headers={"X-API-Key": "test_key"}
        )

        # éªŒè¯å“åº”
        assert response.status_code == 200
        data = response.json()
        assert data["diagnosis"]["disease_id"] == "rose_black_spot"
        assert data["diagnosis"]["level"] == "confirmed"
        assert data["diagnosis"]["confidence"] >= 0.85
```

### 12.3 E2Eæµ‹è¯•ç­–ç•¥

ä½¿ç”¨Playwrightæµ‹è¯•Webç•Œé¢ï¼š

```python
# tests/e2e/test_diagnosis_flow.py
from playwright.async_api import async_playwright

async def test_web_diagnosis_flow():
    """æµ‹è¯•Webè¯Šæ–­å®Œæ•´æµç¨‹"""
    async with async_playwright() as p:
        browser = await p.chromium.launch()
        page = await browser.new_page()

        # è®¿é—®è¯Šæ–­é¡µé¢
        await page.goto("http://localhost:3000/diagnose")

        # ä¸Šä¼ å›¾ç‰‡
        await page.set_input_files(
            'input[type="file"]',
            "tests/fixtures/rose_black_spot.jpg"
        )

        # ç‚¹å‡»è¯Šæ–­æŒ‰é’®
        await page.click('button:has-text("å¼€å§‹è¯Šæ–­")')

        # ç­‰å¾…ç»“æœ
        await page.wait_for_selector(".diagnosis-result", timeout=30000)

        # éªŒè¯ç»“æœæ˜¾ç¤º
        result_text = await page.text_content(".disease-name")
        assert "ç«ç‘°é»‘æ–‘ç—…" in result_text

        await browser.close()
```

---

## 12. æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼

| ID | ç±»å‹ | æè¿° | å‰ç½®æ¡ä»¶ | è¾“å…¥ | é¢„æœŸè¾“å‡º | è¦†ç›–ç‚¹ |
|----|------|------|----------|------|----------|--------|
| TC01 | åŠŸèƒ½ | æ­£å¸¸è¯Šæ–­æµç¨‹ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | ç«ç‘°é»‘æ–‘ç—…å›¾ç‰‡ | è¿”å›confirmedè¯Šæ–­ï¼Œconfidenceâ‰¥0.85 | å®Œæ•´è¯Šæ–­æµç¨‹ |
| TC02 | è¾¹ç•Œ | Q0.0éæ¤ç‰©å›¾ç‰‡ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | åŠ¨ç‰©å›¾ç‰‡ | è¿”å›"ä¸æ”¯æŒçš„å›¾ç‰‡ç±»å‹" | Q0å†…å®¹ç±»å‹è¿‡æ»¤ |
| TC03 | è¾¹ç•Œ | Q0.1éèŠ±å‰æ¤ç‰© | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | è”¬èœå›¾ç‰‡ | è¿”å›"ä»…æ”¯æŒèŠ±å‰ç–¾ç—…è¯Šæ–­" | Q0æ¤ç‰©ç±»åˆ«è¿‡æ»¤ |
| TC04 | è¾¹ç•Œ | Q0.2æœªè¯†åˆ«èŠ±å± | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | æœªçŸ¥èŠ±å‰å›¾ç‰‡ | è¿”å›genus="Other" | Q0èŠ±å±è¯†åˆ« |
| TC05 | è¾¹ç•Œ | Q0.5å¥åº·æ ·æœ¬ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | å¥åº·ç«ç‘°å›¾ç‰‡ | è¿”å›"æœªå‘ç°å¼‚å¸¸" | Q0å¼‚å¸¸åˆ¤æ–­ |
| TC06 | åŠŸèƒ½ | Q1ç—‡çŠ¶ç±»å‹necrosis | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | åæ­»æ–‘ç‚¹å›¾ç‰‡ | symptom_type="necrosis_spot" | Q1åŠ¨æ€ç‰¹å¾æå– |
| TC07 | åŠŸèƒ½ | Q1ç—‡çŠ¶ç±»å‹powdery | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | ç™½ç²‰ç—…å›¾ç‰‡ | symptom_type="powdery_coating" | Q1åˆ†æ”¯é€»è¾‘ |
| TC08 | ç®—æ³• | é«˜ç½®ä¿¡åº¦è¯Šæ–­ | ç‰¹å¾å®Œå…¨åŒ¹é… | å…¸å‹é»‘æ–‘ç—…å›¾ç‰‡ | level="confirmed", scoreâ‰¥0.85 | ç½®ä¿¡åº¦åˆ†å±‚å†³ç­– |
| TC09 | ç®—æ³• | ä¸­ç½®ä¿¡åº¦è¯Šæ–­ | éƒ¨åˆ†ç‰¹å¾åŒ¹é… | æ¨¡ç³Šç—‡çŠ¶å›¾ç‰‡ | level="suspected", 0.6â‰¤score<0.85 | ç–‘ä¼¼è¯Šæ–­é€»è¾‘ |
| TC10 | ç®—æ³• | ä½ç½®ä¿¡åº¦VLMå…œåº• | çŸ¥è¯†åº“å¤–ç–¾ç—… | æœªçŸ¥ç–¾ç—…å›¾ç‰‡ | è°ƒç”¨VLMå¼€æ”¾è¯Šæ–­ï¼Œæ ‡è®°"VLMæ¨æµ‹" | VLMå…œåº•ç­–ç•¥ |
| TC11 | ç³»ç»Ÿ | çŸ¥è¯†åº“çƒ­æ›´æ–° | ç®¡ç†å‘˜æƒé™ | POST /admin/reload | æ–°ç‰ˆæœ¬ç«‹å³ç”Ÿæ•ˆ | çƒ­æ›´æ–°æœºåˆ¶ |
| TC12 | å®¹é”™ | VLMè¶…æ—¶é™çº§ | Qwenä¸å¯ç”¨ | è¯Šæ–­è¯·æ±‚ | è‡ªåŠ¨åˆ‡æ¢åˆ°ChatGPT | Fallbackæœºåˆ¶ |
| TC13 | ç®—æ³• | é¢œè‰²æ¨¡ç³ŠåŒ¹é… | é¢œè‰²è§‚å¯Ÿè¯¯å·® | observed="dark_brown", expected="black" | åŒ¹é…æˆåŠŸï¼ˆåŒè‰²ç³»ï¼‰ | COLOR_GROUPS |
| TC14 | ç®—æ³• | å°ºå¯¸æ¨¡ç³ŠåŒ¹é… | å°ºå¯¸è§‚å¯Ÿè¯¯å·® | observed="medium_small", expected="medium" | åŒ¹é…æˆåŠŸï¼ˆÂ±1çº§åˆ«ï¼‰ | SIZE_ORDER |
| TC15 | ç®—æ³• | Majorç‰¹å¾æƒé‡è®¡ç®— | ä¸»è¦ç‰¹å¾åŒ¹é… | symptom_typeåŒ¹é… | major_score += 0.5 | åŠ æƒè¯„åˆ†0.8 |
| TC16 | ç®—æ³• | Minorç‰¹å¾æƒé‡è®¡ç®— | æ¬¡è¦ç‰¹å¾åŒ¹é… | locationåŒ¹é… | minor_score += 0.1 | åŠ æƒè¯„åˆ†0.15 |
| TC17 | ç®—æ³• | Optionalç‰¹å¾æƒé‡ | å¯é€‰ç‰¹å¾åŒ¹é… | sizeåŒ¹é… | optional_score += 0.03 | åŠ æƒè¯„åˆ†0.05 |
| TC18 | åŠŸèƒ½ | ç®¡ç†åå°ç–¾ç—…ç¼–è¾‘ | ç®¡ç†å‘˜ç™»å½• | ä¿®æ”¹ç–¾ç—…JSON | ä¿å­˜æˆåŠŸï¼Œé‡è½½ç”Ÿæ•ˆ | çŸ¥è¯†åº“ç®¡ç† |
| TC19 | è¾¹ç•Œ | é”™è¯¯å›¾ç‰‡æ ¼å¼ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | BMPæ ¼å¼å›¾ç‰‡ | è¿”å›400é”™è¯¯ | æ ¼å¼éªŒè¯ |
| TC20 | å®¹é”™ | æ•°æ®åº“è¿æ¥å¤±è´¥ | PGæœåŠ¡åœæ­¢ | è¯Šæ–­è¯·æ±‚ | è¿”å›503æœåŠ¡ä¸å¯ç”¨ | æ•°æ®åº“å®¹é”™ |
| TC21 | å®‰å…¨ | API KeyéªŒè¯-æœ‰æ•ˆ | æœ‰æ•ˆKey | Headerå«X-API-Key | è¯·æ±‚æˆåŠŸ | è®¤è¯æœºåˆ¶ |
| TC22 | å®‰å…¨ | API KeyéªŒè¯-æ— æ•ˆ | æ— æ•ˆKey | é”™è¯¯çš„API Key | è¿”å›401æœªæˆæƒ | è®¤è¯æ‹’ç» |
| TC23 | å®‰å…¨ | API KeyéªŒè¯-ç¼ºå¤± | æ— Header | ç¼ºå°‘X-API-Key | è¿”å›401 | è®¤è¯æ£€æŸ¥ |
| TC24 | åŠŸèƒ½ | å›¾ç‰‡å­˜å‚¨åˆ†ç±» | è¯Šæ–­å®Œæˆ | ç«ç‘°å›¾ç‰‡ | å­˜å‚¨åˆ°unlabeled/rose/ç›®å½• | å­˜å‚¨ç­–ç•¥ |
| TC25 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰æ—¥æœŸ | æœ‰å†å²è®°å½• | start_date, end_date | è¿”å›æ—¥æœŸèŒƒå›´å†…è®°å½• | æŸ¥è¯¢åŠŸèƒ½ |
| TC26 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰æ¤ç‰© | æœ‰å†å²è®°å½• | plant_genus="Rosa" | è¿”å›ç«ç‘°ç›¸å…³è®°å½• | ç­›é€‰é€»è¾‘ |
| TC27 | åŠŸèƒ½ | å†å²æŸ¥è¯¢-æŒ‰ç½®ä¿¡åº¦ | æœ‰å†å²è®°å½• | level="confirmed" | è¿”å›ç¡®è¯Šè®°å½• | ç½®ä¿¡åº¦ç­›é€‰ |
| TC28 | å¹¶å‘ | 10ä¸ªå¹¶å‘è¯Šæ–­ | ç³»ç»Ÿæ­£å¸¸è¿è¡Œ | 10ä¸ªå¹¶å‘è¯·æ±‚ | å…¨éƒ¨æˆåŠŸï¼Œæ— å†²çª | å¹¶å‘å¤„ç† |
| TC29 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£complete | completeå›¾ç‰‡ | completeness="complete" | modifier=1.0 | å®Œæ•´æ€§ç³»æ•° |
| TC30 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£partial | éƒ¨åˆ†å›¾ç‰‡ | completeness="partial" | modifier=0.8 | éƒ¨åˆ†ä¿®æ­£ |
| TC31 | ç®—æ³• | å®Œæ•´æ€§ä¿®æ­£close_up | ç‰¹å†™å›¾ç‰‡ | completeness="close_up" | modifier=0.6,è·³è¿‡åˆ†å¸ƒ | ç‰¹å†™å¤„ç† |
| TC32 | åŠŸèƒ½ | Q0æ–°å¢å­—æ®µè¾“å‡º | è¯Šæ–­å®Œæˆ | ä»»æ„å›¾ç‰‡ | feature_vectorå«content_typeç­‰ | ç‰¹å¾å‘é‡å®Œæ•´æ€§ |
| TC33 | æ€§èƒ½ | è¯Šæ–­å»¶è¿ŸP95 | ç³»ç»Ÿæ­£å¸¸ | 100æ¬¡è¯Šæ–­è¯·æ±‚ | P95å»¶è¿Ÿâ‰¤30ç§’ | æ€§èƒ½æŒ‡æ ‡ |
| TC34 | å®¹é”™ | VLMå…¨éƒ¨å¤±è´¥ | æ‰€æœ‰Providerä¸å¯ç”¨ | è¯Šæ–­è¯·æ±‚ | è¿”å›"VLMæœåŠ¡ä¸å¯ç”¨"é”™è¯¯ | æç«¯å®¹é”™ |
| TC35 | åŠŸèƒ½ | ç¼“å­˜å‘½ä¸­ | ç›¸åŒå›¾ç‰‡äºŒæ¬¡è¯Šæ–­ | é‡å¤çš„å›¾ç‰‡+é—®é¢˜ | ä»ç¼“å­˜è¿”å›ï¼Œ<1ç§’å“åº” | VLMç¼“å­˜æœºåˆ¶ |

---

## 13. éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ

## 14. æœªæ¥æ‰©å±•ç‚¹æ¸…å•

### 15.1 åŠŸèƒ½æ‰©å±•ï¼ˆv1.2ï¼‰

| æ‰©å±•é¡¹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | ä»·å€¼ |
|--------|--------|----------|------|
| **å¤šç§Ÿæˆ·éš”ç¦»** | P1 | 80h | æ”¯æŒSaaSå¤šå®¢æˆ· |
| **Dockerå®¹å™¨åŒ–** | P1 | 40h | ç®€åŒ–éƒ¨ç½²è¿ç»´ |
| **Rate Limit** | P2 | 20h | é˜²æ­¢APIæ»¥ç”¨ |
| **å›¾ç‰‡å»é‡ç¼“å­˜** | P2 | 16h | èŠ‚çœVLMæˆæœ¬ |
| **æ‰¹é‡è¯Šæ–­API** | P2 | 24h | æå‡æ•ˆç‡ |
| **WebSocketè¿›åº¦æ¨é€** | P3 | 32h | æ”¹å–„ç”¨æˆ·ä½“éªŒ |

### 15.2 åŠŸèƒ½æ‰©å±•ï¼ˆv1.3+ï¼‰

| æ‰©å±•é¡¹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ | ä»·å€¼ |
|--------|--------|----------|------|
| **æ”¯ä»˜ä¸é…é¢ç®¡ç†** | P1 | 120h | å•†ä¸šåŒ–èƒ½åŠ› |
| **CI/CDè‡ªåŠ¨åŒ–** | P1 | 40h | æå‡å‘å¸ƒæ•ˆç‡ |
| **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—** | P2 | 60h | æ”¯æŒå¤§æ‰¹é‡å¤„ç† |
| **Treatment Ontology** | P2 | 80h | è¯Šæ–­-æ²»ç–—é—­ç¯ |
| **ç§»åŠ¨ç«¯SDK** | P3 | 160h | æ‰©å±•ä½¿ç”¨åœºæ™¯ |
| **å¤šè¯­è¨€æ”¯æŒ** | P3 | 80h | å›½é™…åŒ– |

### 15.3 æŠ€æœ¯å€ºåŠ¡æ¸…ç†

- å®Œå–„å•å…ƒæµ‹è¯•è¦†ç›–ç‡åˆ°90%+
- é‡æ„VLM Promptç®¡ç†
- ä¼˜åŒ–çŸ¥è¯†åº“åŠ è½½æ€§èƒ½
- ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆAPMï¼‰
- å®ç°æ—¥å¿—èšåˆåˆ†æ

### 15.4 çŸ¥è¯†åº“æ‰©å±•è®¡åˆ’

**v1.2ç›®æ ‡**ï¼ˆåŸºäºæ•°æ®é›†ï¼‰ï¼š
- Hibiscusï¼ˆæœ¨æ§¿ï¼‰- 4ç§ç–¾ç—…
- Crape Jasmineï¼ˆç‹—ç‰™èŠ±ï¼‰- 3ç§ç–¾ç—…
- Night-flowering Jasmineï¼ˆå¤œæ¥é¦™ï¼‰- 3ç§ç–¾ç—…
- Dwarf White Bauhiniaï¼ˆç¾Šè¹„ç”²ï¼‰- 3ç§ç–¾ç—…

**v1.3ç›®æ ‡**ï¼ˆå¸‚åœºéœ€æ±‚ï¼‰ï¼š
- å…°èŠ±å±ï¼ˆOrchidaceaeï¼‰- é«˜ç«¯å¸‚åœº
- èŠèŠ±å±ï¼ˆChrysanthemumï¼‰- å¤§ä¼—å¸‚åœº
- ç™¾åˆå±ï¼ˆLiliumï¼‰- é²œåˆ‡èŠ±å¸‚åœº

---

## æ–‡æ¡£ä¿®è®¢è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| v1.1 | 2025-11-11 21:27:44 | é‡æ„ç¬¬5ç« ï¼šæ˜ç¡®åŒºåˆ†åº”ç”¨æœåŠ¡å±‚å’ŒåŸºç¡€è®¾æ–½æ¨¡å—å±‚ï¼Œè¡¥å……åˆ†å±‚æ¶æ„å›¾å’Œè°ƒç”¨å…³ç³»çŸ©é˜µï¼Œè¯¦ç»†å®šä¹‰æ¯ä¸ªæœåŠ¡/æ¨¡å—çš„èŒè´£ã€ä¾èµ–å…³ç³»å’Œå…³é”®æ¥å£ | ç³»ç»Ÿæ¶æ„å¸ˆ |
| v1.0 | 2025-11-11 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ14ç« èŠ‚è¯¦ç»†è®¾è®¡ | ç³»ç»Ÿæ¶æ„å¸ˆ |

---
## 15. å‰ç«¯æ¶æ„è®¾è®¡ âœ¨

> **âœ¨ æ–°å¢**: v2.0æ–°å¢ç« èŠ‚ï¼Œè¯¦ç»†å®šä¹‰å‰ç«¯æŠ€æœ¯æ ˆã€é¡¹ç›®ç»“æ„å’Œ4ä¸ªæ ¸å¿ƒç•Œé¢è®¾è®¡ã€‚

### 15.1 æŠ€æœ¯æ ˆé€‰å‹

#### 15.1.1 æ ¸å¿ƒæ¡†æ¶é€‰æ‹©

**é€‰é¡¹1: React + TypeScript**
- **ä¼˜åŠ¿**:
  - ç”Ÿæ€æˆç†Ÿï¼Œç»„ä»¶åº“ä¸°å¯Œ (Ant Design, Material-UI)
  - TypeScriptç±»å‹å®‰å…¨ï¼Œé™ä½è¿è¡Œæ—¶é”™è¯¯
  - Hooks APIç®€åŒ–çŠ¶æ€ç®¡ç†
  - å¤§é‡ä¼ä¸šçº§æ¡ˆä¾‹ï¼Œæ‹›è˜å®¹æ˜“
- **åŠ£åŠ¿**:
  - éœ€è¦é¢å¤–å¼•å…¥çŠ¶æ€ç®¡ç†åº“ (Zustand/Redux)
  - æ‰“åŒ…é…ç½®ç›¸å¯¹å¤æ‚
- **æ¨èåœºæ™¯**: å›¢é˜Ÿæœ‰Reactç»éªŒï¼Œéœ€è¦æ„å»ºå¤æ‚äº¤äº’ç•Œé¢

**é€‰é¡¹2: Vue 3 + TypeScript**
- **ä¼˜åŠ¿**:
  - å­¦ä¹ æ›²çº¿å¹³ç¼“ï¼Œä¸Šæ‰‹å¿«
  - å†…ç½®çŠ¶æ€ç®¡ç† (Pinia)ï¼Œæ— éœ€é¢å¤–å¼•å…¥
  - ç»„åˆå¼API (Composition API) é€»è¾‘å¤ç”¨æ€§å¼º
  - æ‰“åŒ…å·¥å…· (Vite) å¼€ç®±å³ç”¨
- **åŠ£åŠ¿**:
  - ä¼ä¸šçº§ç»„ä»¶åº“ç›¸å¯¹è¾ƒå°‘
  - TypeScriptæ”¯æŒä¸å¦‚Reactæˆç†Ÿ
- **æ¨èåœºæ™¯**: å°å‹å›¢é˜Ÿå¿«é€Ÿå¼€å‘ï¼Œè¿½æ±‚å¼€å‘æ•ˆç‡

**PhytoOracleæ¨è**: **React + TypeScript**
- ç†ç”±: é¡¹ç›®éœ€è¦å¤æ‚çš„çŠ¶æ€ç®¡ç†(è¯Šæ–­ç»“æœã€æ‰¹é‡ä¸Šä¼ )ï¼ŒReactç”Ÿæ€æ›´é€‚åˆ
- é…å¥—å·¥å…·: Vite + Ant Design + Zustand + React Router v6

#### 15.1.2 ä¾èµ–æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **React** | 18.x | æ ¸å¿ƒæ¡†æ¶ |
| **TypeScript** | 5.x | ç±»å‹ç³»ç»Ÿ |
| **Vite** | 5.x | æ„å»ºå·¥å…· |
| **Ant Design** | 5.x | UIç»„ä»¶åº“ |
| **Zustand** | 4.x | è½»é‡çŠ¶æ€ç®¡ç† |
| **React Router** | 6.x | è·¯ç”±ç®¡ç† |
| **Axios** | 1.x | HTTPå®¢æˆ·ç«¯ |
| **React Hook Form** | 7.x | è¡¨å•ç®¡ç† |
| **Zod** | 3.x | SchemaéªŒè¯ |
| **dayjs** | 1.x | æ—¥æœŸå¤„ç† |
| **recharts** | 2.x | æ•°æ®å¯è§†åŒ– |

---

### 15.2 é¡¹ç›®åˆå§‹åŒ–

#### 15.2.1 åˆ›å»ºé¡¹ç›®

```bash
# ä½¿ç”¨Viteåˆ›å»ºReact + TypeScripté¡¹ç›®
npm create vite@latest phytooracle-frontend -- --template react-ts
cd phytooracle-frontend

# å®‰è£…ä¾èµ–
npm install antd zustand react-router-dom axios react-hook-form zod dayjs recharts

# å®‰è£…å¼€å‘ä¾èµ–
npm install -D @types/node eslint prettier eslint-config-prettier
```

#### 15.2.2 é…ç½®æ–‡ä»¶

**vite.config.ts**:
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
    },
  },
})
```

**tsconfig.json** (å…³é”®é…ç½®):
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "strict": true,
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "esModuleInterop": true,
    "noEmit": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

**.env.example**:
```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_MAX_FILE_SIZE=10485760
VITE_ALLOWED_FILE_TYPES=image/jpeg,image/png,image/heic
```

---

### 15.3 æ ¸å¿ƒç•Œé¢è®¾è®¡

#### 15.3.1 ç•Œé¢1: å•å›¾è¯Šæ–­ (Single Diagnosis)

**è·¯ç”±**: `/diagnosis/single`

**åŠŸèƒ½éœ€æ±‚**:
1. **å›¾ç‰‡ä¸Šä¼ **:
   - æ”¯æŒæ‹–æ‹½ä¸Šä¼  (Drag & Drop)
   - æ”¯æŒç‚¹å‡»é€‰æ‹©æ–‡ä»¶
   - å®æ—¶å›¾ç‰‡é¢„è§ˆ
   - æ–‡ä»¶æ ¼å¼éªŒè¯ (JPG/PNG/HEIC)
   - æ–‡ä»¶å¤§å°éªŒè¯ (æœ€å¤§10MB)

2. **è¯Šæ–­è¿‡ç¨‹å±•ç¤º**:
   - æ˜¾ç¤º"è¯Šæ–­ä¸­"åŠ è½½åŠ¨ç”»
   - å±•ç¤ºVLMé—®ç­”å¯¹ (Q0.0-Q0.5, Q1-Q6)
   - å®æ—¶æ›´æ–°è¯Šæ–­è¿›åº¦ (å¯é€‰: ä½¿ç”¨WebSocket)

3. **ç»“æœå±•ç¤º**:
   - **æ ¸å¿ƒä¿¡æ¯å¡ç‰‡**:
     - ç–¾ç—…åç§° (ä¸­è‹±æ–‡)
     - ç—…åŸä½“åç§°
     - ç½®ä¿¡åº¦ç­‰çº§ (confirmed/suspected/unlikely)
     - ç½®ä¿¡åº¦åˆ†æ•° (0-1)
   - **ç‰¹å¾åŒ¹é…è¯¦æƒ…** (å¯æŠ˜å ):
     - ä¸»è¦ç‰¹å¾åŒ¹é…æƒ…å†µ (major_features)
     - æ¬¡è¦ç‰¹å¾åŒ¹é…æƒ…å†µ (minor_features)
     - å¯é€‰ç‰¹å¾åŒ¹é…æƒ…å†µ (optional_features)
     - æ¯ä¸ªç‰¹å¾çš„å¾—åˆ†ä¸æƒé‡
   - **VLMé—®ç­”å¯¹è¯¦æƒ…** (å¯æŠ˜å ):
     - Q0.0-Q0.5 è¿‡æ»¤é—®é¢˜çš„å›ç­”
     - Q1-Q6 ç‰¹å¾æå–é—®é¢˜çš„å›ç­”
     - æ¯ä¸ªé—®é¢˜çš„ç½®ä¿¡åº¦
   - **å€™é€‰ç–¾ç—…åˆ—è¡¨** (suspectedæƒ…å†µä¸‹æ˜¾ç¤º):
     - å…¶ä»–å¯èƒ½çš„ç–¾ç—…
     - æ¯ä¸ªå€™é€‰çš„åˆ†æ•°
   - **è¯Šæ–­æ¨ç†é“¾** (å¯æŠ˜å ):
     - å®Œæ•´çš„æ¨ç†æ­¥éª¤
     - Layer2çŸ¥è¯†åº“åŒ¹é…ç»“æœ
     - Layer3åŒ»å­¦è¯Šæ–­é€»è¾‘

4. **äº¤äº’åŠŸèƒ½**:
   - "é‡æ–°è¯Šæ–­"æŒ‰é’®
   - "å¯¼å‡ºç»“æœ"æŒ‰é’® (JSON/PDF)
   - "æ ‡è®°å‡†ç¡®æ€§"æŒ‰é’® (æ­£ç¡®/é”™è¯¯)

**ç»„ä»¶ç»“æ„**:
```
pages/SingleDiagnosis/
â”œâ”€â”€ index.tsx                 # ä¸»é¡µé¢ç»„ä»¶
â”œâ”€â”€ hooks.ts                  # è‡ªå®šä¹‰Hook: useDiagnosis, useImageUpload
â”œâ”€â”€ style.css
components/diagnosis/
â”œâ”€â”€ UploadArea/               # ä¸Šä¼ åŒºåŸŸç»„ä»¶
â”œâ”€â”€ ImagePreview/             # å›¾ç‰‡é¢„è§ˆç»„ä»¶
â”œâ”€â”€ DiagnosisResult/          # è¯Šæ–­ç»“æœå¡ç‰‡
â”œâ”€â”€ QADetails/                # VLMé—®ç­”å¯¹è¯¦æƒ… (å¯å±•å¼€)
â””â”€â”€ FeatureMatchDetails/      # ç‰¹å¾åŒ¹é…è¯¦æƒ…
```

**æ ¸å¿ƒä»£ç ç¤ºä¾‹ (é¡µé¢ä¸»ç»„ä»¶)**:
```typescript
// pages/SingleDiagnosis/index.tsx
import { useState } from 'react';
import { Card, Button, Spin, message } from 'antd';
import { UploadArea } from '@/components/diagnosis/UploadArea';
import { DiagnosisResult } from '@/components/diagnosis/DiagnosisResult';
import { diagnoseSingle } from '@/api/diagnosis';
import type { DiagnosisResult as DiagnosisResultType } from '@/types/diagnosis';

export const SingleDiagnosis = () => {
  const [image, setImage] = useState<File | null>(null);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<DiagnosisResultType | null>(null);

  const handleImageSelect = (file: File) => {
    setImage(file);
    setResult(null);
  };

  const handleDiagnose = async () => {
    if (!image) {
      message.error('è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
      return;
    }

    setLoading(true);
    try {
      const result = await diagnoseSingle(image);
      setResult(result);
      message.success('è¯Šæ–­å®Œæˆ');
    } catch (error) {
      message.error('è¯Šæ–­å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="single-diagnosis-page">
      <Card title="å•å›¾è¯Šæ–­">
        <UploadArea onImageSelect={handleImageSelect} />

        {image && !result && (
          <Button
            type="primary"
            onClick={handleDiagnose}
            loading={loading}
            size="large"
          >
            å¼€å§‹è¯Šæ–­
          </Button>
        )}

        {loading && (
          <div className="loading-container">
            <Spin size="large" tip="VLMæ­£åœ¨åˆ†æå›¾ç‰‡..." />
          </div>
        )}

        {result && <DiagnosisResult result={result} />}
      </Card>
    </div>
  );
};
```

---

#### 15.3.2 ç•Œé¢2: æ‰¹é‡è¯Šæ–­ (Batch Diagnosis)

**è·¯ç”±**: `/diagnosis/batch`

**åŠŸèƒ½éœ€æ±‚**:
1. **æ‰¹é‡ä¸Šä¼ **:
   - æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ (æœ€å¤š20ä¸ª)
   - æ˜¾ç¤ºä¸Šä¼ é˜Ÿåˆ—
   - å®æ—¶æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦

2. **æ‰¹é‡è¯Šæ–­æ‰§è¡Œ**:
   - å¹¶å‘è¯Šæ–­ (æœ€å¤š5ä¸ªå¹¶å‘è¯·æ±‚)
   - å®æ—¶æ›´æ–°æ¯ä¸ªå›¾ç‰‡çš„è¯Šæ–­çŠ¶æ€
   - çŠ¶æ€: pending / diagnosing / completed / failed

3. **ç»“æœå±•ç¤º**:
   - å®«æ ¼è§†å›¾ (Grid View):
     - æ¯ä¸ªå¡ç‰‡æ˜¾ç¤ºç¼©ç•¥å›¾ + ç–¾ç—…å + ç½®ä¿¡åº¦
     - é¢œè‰²ç¼–ç : confirmed(ç»¿è‰²) / suspected(é»„è‰²) / unlikely(çº¢è‰²)
   - åˆ—è¡¨è§†å›¾ (List View):
     - è¡¨æ ¼å½¢å¼å±•ç¤ºæ‰€æœ‰ç»“æœ
     - æ”¯æŒæŒ‰ç½®ä¿¡åº¦ã€ç–¾ç—…åæ’åº
   - ç¿»é¡µæ§åˆ¶ (æ¯é¡µ20æ¡)

4. **äº¤äº’åŠŸèƒ½**:
   - åŒå‡»å¡ç‰‡æŸ¥çœ‹è¯¦æƒ… (å¼¹å‡ºModal)
   - "å¯¼å‡ºæ‰€æœ‰ç»“æœ"æŒ‰é’® (CSV/Excel)
   - "é‡æ–°è¯Šæ–­å¤±è´¥é¡¹"æŒ‰é’®
   - æ‰¹é‡æ ‡è®°å‡†ç¡®æ€§

**ç»„ä»¶ç»“æ„**:
```
pages/BatchDiagnosis/
â”œâ”€â”€ index.tsx
â”œâ”€â”€ hooks.ts                  # useBatchDiagnosis
â”œâ”€â”€ style.css
components/batch/
â”œâ”€â”€ BatchUpload/              # æ‰¹é‡ä¸Šä¼ ç»„ä»¶
â”œâ”€â”€ ResultList/               # ç»“æœåˆ—è¡¨ (æ”¯æŒGrid/Liståˆ‡æ¢)
â”œâ”€â”€ ResultCard/               # ç»“æœå¡ç‰‡
â””â”€â”€ DetailModal/              # è¯¦æƒ…æ¨¡æ€æ¡†
```

**æ ¸å¿ƒé€»è¾‘ (æ‰¹é‡è¯Šæ–­Hook)**:
```typescript
// pages/BatchDiagnosis/hooks.ts
import { useState } from 'react';
import { diagnoseSingle } from '@/api/diagnosis';
import type { DiagnosisResult } from '@/types/diagnosis';

interface BatchDiagnosisItem {
  id: string;
  file: File;
  status: 'pending' | 'diagnosing' | 'completed' | 'failed';
  result?: DiagnosisResult;
  error?: string;
}

export const useBatchDiagnosis = () => {
  const [items, setItems] = useState<BatchDiagnosisItem[]>([]);

  const addFiles = (files: File[]) => {
    const newItems = files.map(file => ({
      id: `${Date.now()}_${file.name}`,
      file,
      status: 'pending' as const,
    }));
    setItems(prev => [...prev, ...newItems]);
  };

  const diagnoseAll = async () => {
    const CONCURRENT_LIMIT = 5;
    const pendingItems = items.filter(item => item.status === 'pending');

    // åˆ†æ‰¹å¹¶å‘è¯Šæ–­
    for (let i = 0; i < pendingItems.length; i += CONCURRENT_LIMIT) {
      const batch = pendingItems.slice(i, i + CONCURRENT_LIMIT);

      await Promise.all(
        batch.map(async (item) => {
          setItems(prev => prev.map(it =>
            it.id === item.id ? { ...it, status: 'diagnosing' } : it
          ));

          try {
            const result = await diagnoseSingle(item.file);
            setItems(prev => prev.map(it =>
              it.id === item.id ? { ...it, status: 'completed', result } : it
            ));
          } catch (error) {
            setItems(prev => prev.map(it =>
              it.id === item.id ? {
                ...it,
                status: 'failed',
                error: error.message
              } : it
            ));
          }
        })
      );
    }
  };

  return { items, addFiles, diagnoseAll };
};
```

---

#### 15.3.3 ç•Œé¢3: æœ¬ä½“ç®¡ç† (Ontology Management)

**è·¯ç”±**: `/ontology`

**åŠŸèƒ½éœ€æ±‚**:
1. **æœ¬ä½“ç±»å‹åˆ—è¡¨**:
   - å±•ç¤ºæ‰€æœ‰æœ¬ä½“ç±»å‹ (symptom_type, color, location, size, distribution)
   - æ¯ä¸ªç±»å‹æ˜¾ç¤º: åç§°ã€æè¿°ã€ç»´åº¦æ•°é‡ã€æšä¸¾å€¼æ•°é‡ã€æœ€åæ›´æ–°æ—¶é—´

2. **æœ¬ä½“è¯¦æƒ…æŸ¥çœ‹**:
   - é€‰æ‹©æœ¬ä½“ç±»å‹åï¼Œå±•ç¤ºè¯¦ç»†ä¿¡æ¯
   - ç»´åº¦å®šä¹‰: dimension_id, dimension_name, description
   - æšä¸¾å€¼åˆ—è¡¨:
     - value (å†…éƒ¨å€¼)
     - label_zh / label_en (æ˜¾ç¤ºåç§°)
     - description (æè¿°)
     - vlm_visual_clues (VLMè¯†åˆ«æç¤º)
     - count_in_knowledge_base (çŸ¥è¯†åº“ä½¿ç”¨æ¬¡æ•°)

3. **æ¨¡ç³ŠåŒ¹é…è§„åˆ™æŸ¥çœ‹** (ä»…colorå’Œsizeæœ¬ä½“):
   - color: æ˜¾ç¤ºCOLOR_GROUPSé¢œè‰²åˆ†ç»„
   - size: æ˜¾ç¤ºSIZE_ORDERå°ºå¯¸é¡ºåº

4. **äº¤äº’åŠŸèƒ½**:
   - æœç´¢æšä¸¾å€¼
   - æŒ‰ä½¿ç”¨æ¬¡æ•°æ’åº
   - "å¯¼å‡ºæœ¬ä½“"æŒ‰é’® (JSONæ ¼å¼)

**ç»„ä»¶ç»“æ„**:
```
pages/OntologyManagement/
â”œâ”€â”€ index.tsx
â”œâ”€â”€ hooks.ts                  # useOntology
â”œâ”€â”€ style.css
components/ontology/
â”œâ”€â”€ OntologyList/             # æœ¬ä½“ç±»å‹åˆ—è¡¨
â”œâ”€â”€ OntologyDetail/           # æœ¬ä½“è¯¦æƒ…å±•ç¤º
â””â”€â”€ DimensionCard/            # ç»´åº¦å¡ç‰‡ (å«æšä¸¾å€¼è¡¨æ ¼)
```

**UIç¤ºä¾‹ (æšä¸¾å€¼è¡¨æ ¼)**:
```typescript
// components/ontology/DimensionCard/index.tsx
import { Table, Tag } from 'antd';
import type { OntologyEnumValue } from '@/types/ontology';

interface DimensionCardProps {
  dimensionId: string;
  dimensionName: string;
  enumValues: OntologyEnumValue[];
}

export const DimensionCard = ({
  dimensionId,
  dimensionName,
  enumValues
}: DimensionCardProps) => {
  const columns = [
    {
      title: 'å†…éƒ¨å€¼',
      dataIndex: 'value',
      key: 'value',
      render: (value: string) => <Tag color="blue">{value}</Tag>,
    },
    {
      title: 'ä¸­æ–‡åç§°',
      dataIndex: 'label_zh',
      key: 'label_zh',
    },
    {
      title: 'è‹±æ–‡åç§°',
      dataIndex: 'label_en',
      key: 'label_en',
    },
    {
      title: 'VLMè¯†åˆ«æç¤º',
      dataIndex: 'vlm_visual_clues',
      key: 'vlm_visual_clues',
      ellipsis: true,
    },
    {
      title: 'ä½¿ç”¨æ¬¡æ•°',
      dataIndex: 'count_in_knowledge_base',
      key: 'count',
      sorter: (a, b) => a.count_in_knowledge_base - b.count_in_knowledge_base,
    },
  ];

  return (
    <Card title={dimensionName} className="dimension-card">
      <Table
        columns={columns}
        dataSource={enumValues}
        rowKey="value"
        pagination={{ pageSize: 10 }}
      />
    </Card>
  );
};
```

---

#### 15.3.4 ç•Œé¢4: çŸ¥è¯†ç®¡ç† (Knowledge Management)

**è·¯ç”±**: `/knowledge`

**åŠŸèƒ½éœ€æ±‚**:
1. **çŸ¥è¯†åº“ç›®å½•æ ‘**:
   - å·¦ä¾§æ ‘å½¢ç»“æ„:
     ```
     â”œâ”€â”€ Rosa (ç«ç‘°å±) - 8ç§ç–¾ç—…
     â”‚   â”œâ”€â”€ rose_black_spot (ç«ç‘°é»‘æ–‘ç—…)
     â”‚   â”œâ”€â”€ rose_powdery_mildew (ç«ç‘°ç™½ç²‰ç—…)
     â”‚   â””â”€â”€ ...
     â”œâ”€â”€ Prunus (æ¨±èŠ±å±) - 5ç§ç–¾ç—…
     â””â”€â”€ ...
     ```
   - æ”¯æŒæŒ‰å±æŠ˜å /å±•å¼€
   - æ˜¾ç¤ºæ¯ä¸ªå±çš„ç–¾ç—…æ•°é‡

2. **ç–¾ç—…è¯¦æƒ…å±•ç¤º** (å³ä¾§):
   - **åŸºæœ¬ä¿¡æ¯**:
     - disease_id, disease_name, common_name_en
     - pathogen (ç—…åŸä½“)
     - affected_plants (å®¿ä¸»å±åˆ—è¡¨)

   - **ç‰¹å¾å®šä¹‰** (Feature Definition):
     - æ¯ä¸ªç‰¹å¾ç»´åº¦æ˜¾ç¤ºä¸ºå¡ç‰‡:
       ```
       [symptom_type] ç—‡çŠ¶ç±»å‹ (ä¸»è¦ç‰¹å¾)
       æœŸæœ›å€¼: powdery_coating
       æƒé‡: 0.5
       æœ¬ä½“å¼•ç”¨: â†’ ontology/symptom_type
       ```
     - ç‚¹å‡»"æœ¬ä½“å¼•ç”¨"è·³è½¬åˆ°æœ¬ä½“ç®¡ç†ç•Œé¢

   - **VLMæè¿°** (VLM Description):
     - symptom_type: "ç™½è‰²ç²‰çŠ¶ç‰©è¦†ç›–å¶ç‰‡è¡¨é¢..."
     - color_center: "ç™½è‰²è‡³ç°ç™½è‰²"
     - location: "ä¸»è¦åœ¨å¶ç‰‡ä¸Šè¡¨é¢..."
     - æ”¯æŒåœ¨çº¿ç¼–è¾‘ (Markdownç¼–è¾‘å™¨)

   - **è¯Šæ–­è§„åˆ™** (Diagnosis Rules):
     - confirmed_threshold: 0.85
     - suspected_threshold: 0.60
     - major_features_required: 2
     - æ”¯æŒåœ¨çº¿è°ƒæ•´

3. **ç¼–è¾‘åŠŸèƒ½**:
   - "ç¼–è¾‘æ¨¡å¼"å¼€å…³
   - ä¿å­˜æŒ‰é’® (è°ƒç”¨PUT /api/v1/knowledge/diseases/{disease_id})
   - å–æ¶ˆæŒ‰é’® (æ¢å¤åŸå§‹æ•°æ®)

4. **äº¤äº’åŠŸèƒ½**:
   - æœç´¢ç–¾ç—…åç§°
   - "æ–°å¢ç–¾ç—…"æŒ‰é’®
   - "åˆ é™¤ç–¾ç—…"æŒ‰é’® (éœ€ç¡®è®¤)
   - "å¯¼å‡ºçŸ¥è¯†åº“"æŒ‰é’® (JSONæ ¼å¼)

**ç»„ä»¶ç»“æ„**:
```
pages/KnowledgeManagement/
â”œâ”€â”€ index.tsx
â”œâ”€â”€ hooks.ts                  # useKnowledge
â”œâ”€â”€ style.css
components/knowledge/
â”œâ”€â”€ KnowledgeTree/            # çŸ¥è¯†åº“ç›®å½•æ ‘
â”œâ”€â”€ DiseaseDetail/            # ç–¾ç—…è¯¦æƒ…å±•ç¤º
â”œâ”€â”€ DimensionCard/            # ç»´åº¦å¡ç‰‡ (å¸¦æœ¬ä½“æ ‡è¯†)
â””â”€â”€ VLMDescriptionEditor/     # VLMæè¿°ç¼–è¾‘å™¨ (Markdown)
```

**æ ¸å¿ƒä»£ç ç¤ºä¾‹ (ç»´åº¦å¡ç‰‡)**:
```typescript
// components/knowledge/DimensionCard/index.tsx
import { Card, Tag, Button } from 'antd';
import { LinkOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';

interface DimensionCardProps {
  dimensionId: string;
  dimensionName: string;
  expectedValue: string | string[];
  importanceWeight: number;
  isMajorFeature: boolean;
  ontologyTypeId: string;
}

export const DimensionCard = ({
  dimensionId,
  dimensionName,
  expectedValue,
  importanceWeight,
  isMajorFeature,
  ontologyTypeId,
}: DimensionCardProps) => {
  const navigate = useNavigate();

  const handleOntologyLinkClick = () => {
    navigate(`/ontology?type=${ontologyTypeId}`);
  };

  return (
    <Card
      size="small"
      title={
        <>
          [{dimensionId}] {dimensionName}
          {isMajorFeature && <Tag color="red" style={{ marginLeft: 8 }}>ä¸»è¦ç‰¹å¾</Tag>}
        </>
      }
      extra={
        <Button
          type="link"
          icon={<LinkOutlined />}
          onClick={handleOntologyLinkClick}
        >
          æŸ¥çœ‹æœ¬ä½“
        </Button>
      }
    >
      <p>
        <strong>æœŸæœ›å€¼:</strong> {' '}
        {Array.isArray(expectedValue)
          ? expectedValue.map(v => <Tag key={v}>{v}</Tag>)
          : <Tag>{expectedValue}</Tag>
        }
      </p>
      <p><strong>é‡è¦æ€§æƒé‡:</strong> {importanceWeight}</p>
    </Card>
  );
};
```

---

### 15.4 çŠ¶æ€ç®¡ç†è®¾è®¡ (Zustand)

#### 15.4.1 è¯Šæ–­çŠ¶æ€ (diagnosisStore.ts)

```typescript
// store/diagnosisStore.ts
import { create } from 'zustand';
import type { DiagnosisResult } from '@/types/diagnosis';

interface DiagnosisStore {
  // State
  currentDiagnosis: DiagnosisResult | null;
  batchDiagnoses: Map<string, DiagnosisResult>;
  loading: boolean;

  // Actions
  setCurrentDiagnosis: (result: DiagnosisResult | null) => void;
  addBatchDiagnosis: (id: string, result: DiagnosisResult) => void;
  clearBatchDiagnoses: () => void;
  setLoading: (loading: boolean) => void;
}

export const useDiagnosisStore = create<DiagnosisStore>((set) => ({
  currentDiagnosis: null,
  batchDiagnoses: new Map(),
  loading: false,

  setCurrentDiagnosis: (result) =>
    set({ currentDiagnosis: result }),

  addBatchDiagnosis: (id, result) =>
    set((state) => ({
      batchDiagnoses: new Map(state.batchDiagnoses).set(id, result),
    })),

  clearBatchDiagnoses: () =>
    set({ batchDiagnoses: new Map() }),

  setLoading: (loading) => set({ loading }),
}));
```

#### 15.4.2 çŸ¥è¯†åº“çŠ¶æ€ (knowledgeStore.ts)

```typescript
// store/knowledgeStore.ts
import { create } from 'zustand';
import type { KnowledgeTree, DiseaseDetail } from '@/types/knowledge';

interface KnowledgeStore {
  // State
  knowledgeTree: KnowledgeTree | null;
  currentDisease: DiseaseDetail | null;
  editMode: boolean;

  // Actions
  setKnowledgeTree: (tree: KnowledgeTree) => void;
  setCurrentDisease: (disease: DiseaseDetail | null) => void;
  toggleEditMode: () => void;
  updateDisease: (diseaseId: string, updates: Partial<DiseaseDetail>) => void;
}

export const useKnowledgeStore = create<KnowledgeStore>((set) => ({
  knowledgeTree: null,
  currentDisease: null,
  editMode: false,

  setKnowledgeTree: (tree) => set({ knowledgeTree: tree }),
  setCurrentDisease: (disease) => set({ currentDisease: disease }),
  toggleEditMode: () => set((state) => ({ editMode: !state.editMode })),

  updateDisease: (diseaseId, updates) =>
    set((state) => ({
      currentDisease: state.currentDisease?.disease_id === diseaseId
        ? { ...state.currentDisease, ...updates }
        : state.currentDisease,
    })),
}));
```

---

### 15.5 APIå®¢æˆ·ç«¯å°è£…

#### 15.5.1 Axiosé…ç½® (api/client.ts)

```typescript
// api/client.ts
import axios from 'axios';
import { message } from 'antd';

const client = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// è¯·æ±‚æ‹¦æˆªå™¨
client.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('api_key');
    if (token) {
      config.headers['X-API-Key'] = token;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// å“åº”æ‹¦æˆªå™¨
client.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.response?.status === 401) {
      message.error('è¯·å…ˆç™»å½•');
      // è·³è½¬åˆ°ç™»å½•é¡µ
      window.location.href = '/login';
    } else if (error.response?.status === 500) {
      message.error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    } else {
      message.error(error.response?.data?.detail || 'è¯·æ±‚å¤±è´¥');
    }
    return Promise.reject(error);
  }
);

export default client;
```

#### 15.5.2 è¯Šæ–­APIå°è£… (api/diagnosis.ts)

```typescript
// api/diagnosis.ts
import client from './client';
import type { DiagnosisResult } from '@/types/diagnosis';

export const diagnoseSingle = async (image: File): Promise<DiagnosisResult> => {
  const formData = new FormData();
  formData.append('image', image);

  return client.post('/diagnose', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
};

export const getDiagnosisHistory = async (params?: {
  start_date?: string;
  end_date?: string;
  plant_genus?: string;
  confidence_level?: string;
  page?: number;
  page_size?: number;
}): Promise<{ total: number; results: DiagnosisResult[] }> => {
  return client.get('/history', { params });
};
```

#### 15.5.3 çŸ¥è¯†åº“APIå°è£… (api/knowledge.ts)

```typescript
// api/knowledge.ts
import client from './client';
import type { KnowledgeTree, DiseaseDetail } from '@/types/knowledge';

export const getKnowledgeTree = async (): Promise<KnowledgeTree> => {
  return client.get('/knowledge/diseases');
};

export const getDiseaseDetail = async (diseaseId: string): Promise<DiseaseDetail> => {
  return client.get(`/knowledge/diseases/${diseaseId}`);
};

export const updateDisease = async (
  diseaseId: string,
  data: Partial<DiseaseDetail>
): Promise<void> => {
  return client.put(`/knowledge/diseases/${diseaseId}`, data);
};

export const createDisease = async (data: DiseaseDetail): Promise<{ disease_id: string }> => {
  return client.post('/knowledge/diseases', data);
};

export const deleteDisease = async (diseaseId: string): Promise<void> => {
  return client.delete(`/knowledge/diseases/${diseaseId}`);
};
```

---

### 15.6 ç±»å‹å®šä¹‰ (TypeScript)

#### 15.6.1 è¯Šæ–­ç±»å‹ (types/diagnosis.ts)

```typescript
// types/diagnosis.ts
export interface DiagnosisResult {
  diagnosis_id: string;
  timestamp: string;
  diagnosis: {
    disease_id: string;
    disease_name: string;
    common_name_en: string;
    pathogen: string;
    level: 'confirmed' | 'suspected' | 'unlikely';
    confidence: number;
  };
  feature_vector: FeatureVector;
  scores: {
    total_score: number;
    major_features: Record<string, number>;
    minor_features: Record<string, number>;
    optional_features: Record<string, number>;
    major_matched: number;
    major_total: number;
  };
  reasoning: string[];
  candidates: Array<{
    disease_id: string;
    disease_name: string;
    score: number;
    level: string;
  }>;
  vlm_provider: string;
  execution_time_ms: number;
}

export interface FeatureVector {
  content_type: string;
  plant_category: string;
  flower_genus: string;
  organ: string;
  completeness: string;
  has_abnormality: string;
  symptom_type: string;
  color_center?: string;
  location?: string;
  size?: string;
  distribution?: string;
}
```

#### 15.6.2 çŸ¥è¯†åº“ç±»å‹ (types/knowledge.ts)

```typescript
// types/knowledge.ts
export interface KnowledgeTree {
  total: number;
  results: Array<{
    disease_id: string;
    disease_name: string;
    affected_plants: string[];
  }>;
}

export interface DiseaseDetail {
  disease_id: string;
  disease_name: string;
  common_name_en: string;
  pathogen: string;
  affected_plants: string[];
  feature_definition: Record<string, FeatureDimension>;
  vlm_description: Record<string, string>;
  diagnosis_rules: {
    confirmed_threshold: number;
    suspected_threshold: number;
    major_features_required: number;
  };
}

export interface FeatureDimension {
  dimension_id: string;
  expected_value: string | string[];
  importance_weight: number;
  is_major_feature: boolean;
}
```

---

### 15.7 éƒ¨ç½²ä¸æ„å»º

#### 15.7.1 æ„å»ºå‘½ä»¤

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§æ„å»º
npm run build

# é¢„è§ˆç”Ÿäº§æ„å»º
npm run preview
```

#### 15.7.2 éƒ¨ç½²é…ç½® (Nginx)

```nginx
server {
    listen 80;
    server_name phytooracle.example.com;

    root /var/www/phytooracle-frontend/dist;
    index index.html;

    # SPAè·¯ç”±é…ç½®
    location / {
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## 16. å‰åç«¯è”è°ƒæŒ‡å— âœ¨

> **âœ¨ æ–°å¢**: v2.0æ–°å¢ç« èŠ‚ï¼Œè¯¦ç»†è¯´æ˜å‰åç«¯è”è°ƒæµç¨‹ã€CORSé…ç½®å’Œæµ‹è¯•æ–¹æ³•ã€‚

### 16.1 è”è°ƒç¯å¢ƒé…ç½®

#### 16.1.1 åç«¯CORSé…ç½®

**backend/apps/api/main.py**:
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(
    title="PhytoOracle API",
    version="1.0.0",
    docs_url="/api/docs",
    redoc_url="/api/redoc",
)

# CORSé…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:3000",         # å‰ç«¯å¼€å‘ç¯å¢ƒ
        "https://phytooracle.example.com",  # ç”Ÿäº§ç¯å¢ƒ
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
    expose_headers=["X-Request-ID", "X-Execution-Time"],
)
```

#### 16.1.2 å‰ç«¯ä»£ç†é…ç½® (å¼€å‘ç¯å¢ƒ)

**frontend/vite.config.ts**:
```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        // ä¸é‡å†™è·¯å¾„ï¼Œä¿æŒ /api/v1/... åŸæ ·
      },
    },
  },
});
```

#### 16.1.3 ç¯å¢ƒå˜é‡é…ç½®

**å‰ç«¯ (.env.development)**:
```env
VITE_API_BASE_URL=http://localhost:8000/api/v1
VITE_MAX_FILE_SIZE=10485760
```

**åç«¯ (.env)**:
```env
DATABASE_URL=postgresql://user:pass@localhost:5432/phytooracle
REDIS_URL=redis://localhost:6379/0
QWEN_API_KEY=sk-xxx
OPENAI_API_KEY=sk-xxx
ALLOWED_ORIGINS=http://localhost:3000,https://phytooracle.example.com
```

---

### 16.2 è”è°ƒæµ‹è¯•æµç¨‹

#### 16.2.1 å¯åŠ¨æœåŠ¡

```bash
# Terminal 1: å¯åŠ¨åç«¯
cd backend
poetry run uvicorn apps.api.main:app --reload --port 8000

# Terminal 2: å¯åŠ¨å‰ç«¯
cd frontend
npm run dev
```

#### 16.2.2 APIæµ‹è¯• (ä½¿ç”¨Postman/Insomnia)

**æµ‹è¯•1: è¯Šæ–­API**
```bash
curl -X POST http://localhost:8000/api/v1/diagnose \
  -H "X-API-Key: your_api_key" \
  -F "image=@/path/to/cherry.jpg"
```

**é¢„æœŸå“åº”**: 200 OK + å®Œæ•´çš„DiagnosisResponse JSON

**æµ‹è¯•2: çŸ¥è¯†åº“API**
```bash
curl http://localhost:8000/api/v1/knowledge/diseases?genus=Prunus
```

**é¢„æœŸå“åº”**: 200 OK + ç–¾ç—…åˆ—è¡¨JSON

#### 16.2.3 å‰ç«¯é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯1: å•å›¾è¯Šæ–­å®Œæ•´æµç¨‹**
1. è®¿é—® http://localhost:3000/diagnosis/single
2. ä¸Šä¼ å›¾ç‰‡ (cherry_powdery_mildew.jpg)
3. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"
4. éªŒè¯:
   - åŠ è½½åŠ¨ç”»æ˜¾ç¤º
   - 3-5ç§’åè¿”å›ç»“æœ
   - è¯Šæ–­ç»“æœå¡ç‰‡æ­£ç¡®æ˜¾ç¤º
   - ç‰¹å¾åŒ¹é…è¯¦æƒ…å¯æŠ˜å å±•å¼€
   - VLMé—®ç­”å¯¹è¯¦æƒ…æ­£ç¡®æ˜¾ç¤º

**æµ‹è¯•åœºæ™¯2: æ‰¹é‡è¯Šæ–­**
1. è®¿é—® http://localhost:3000/diagnosis/batch
2. ä¸Šä¼ 5å¼ å›¾ç‰‡
3. ç‚¹å‡»"å¼€å§‹æ‰¹é‡è¯Šæ–­"
4. éªŒè¯:
   - 5ä¸ªå¹¶å‘è¯·æ±‚ (é€šè¿‡Networké¢æ¿æŸ¥çœ‹)
   - å®æ—¶æ›´æ–°æ¯ä¸ªå¡ç‰‡çŠ¶æ€
   - æ‰€æœ‰å¡ç‰‡æœ€ç»ˆæ˜¾ç¤ºcompletedçŠ¶æ€

**æµ‹è¯•åœºæ™¯3: çŸ¥è¯†åº“ç®¡ç†**
1. è®¿é—® http://localhost:3000/knowledge
2. ç‚¹å‡»å·¦ä¾§æ ‘å½¢ç»“æ„ä¸­çš„"æ¨±èŠ±ç™½ç²‰ç—…"
3. éªŒè¯:
   - å³ä¾§æ­£ç¡®æ˜¾ç¤ºç–¾ç—…è¯¦æƒ…
   - ç‰¹å¾å®šä¹‰å¡ç‰‡æ­£ç¡®æ¸²æŸ“
   - ç‚¹å‡»"æŸ¥çœ‹æœ¬ä½“"è·³è½¬åˆ°æœ¬ä½“ç®¡ç†ç•Œé¢

---

### 16.3 ç«¯åˆ°ç«¯æµ‹è¯• (E2E Testing)

#### 16.3.1 ä½¿ç”¨Playwright

**å®‰è£…ä¾èµ–**:
```bash
cd frontend
npm install -D @playwright/test
npx playwright install
```

**æµ‹è¯•ç”¨ä¾‹ (tests/e2e/diagnosis.spec.ts)**:
```typescript
import { test, expect } from '@playwright/test';

test.describe('å•å›¾è¯Šæ–­æµç¨‹', () => {
  test('å®Œæ•´è¯Šæ–­æµç¨‹', async ({ page }) => {
    // 1. è®¿é—®è¯Šæ–­é¡µé¢
    await page.goto('http://localhost:3000/diagnosis/single');

    // 2. ä¸Šä¼ å›¾ç‰‡
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles('tests/fixtures/cherry_powdery_mildew.jpg');

    // 3. ç‚¹å‡»è¯Šæ–­æŒ‰é’®
    await page.click('button:has-text("å¼€å§‹è¯Šæ–­")');

    // 4. ç­‰å¾…ç»“æœåŠ è½½
    await page.waitForSelector('.diagnosis-result', { timeout: 30000 });

    // 5. éªŒè¯ç»“æœ
    const diseaseName = await page.locator('.disease-name').textContent();
    expect(diseaseName).toContain('æ¨±èŠ±ç™½ç²‰ç—…');

    const confidence = await page.locator('.confidence-score').textContent();
    expect(parseFloat(confidence!)).toBeGreaterThan(0.8);

    // 6. éªŒè¯VLMé—®ç­”å¯¹è¯¦æƒ…
    await page.click('button:has-text("æŸ¥çœ‹VLMé—®ç­”å¯¹")');
    const qaDetails = page.locator('.qa-details');
    await expect(qaDetails).toBeVisible();
  });

  test('æ‰¹é‡è¯Šæ–­æµç¨‹', async ({ page }) => {
    await page.goto('http://localhost:3000/diagnosis/batch');

    // ä¸Šä¼ 5å¼ å›¾ç‰‡
    const fileInput = page.locator('input[type="file"]');
    await fileInput.setInputFiles([
      'tests/fixtures/cherry_1.jpg',
      'tests/fixtures/cherry_2.jpg',
      'tests/fixtures/rose_1.jpg',
      'tests/fixtures/rose_2.jpg',
      'tests/fixtures/tulip_1.jpg',
    ]);

    // ç‚¹å‡»æ‰¹é‡è¯Šæ–­
    await page.click('button:has-text("å¼€å§‹æ‰¹é‡è¯Šæ–­")');

    // ç­‰å¾…æ‰€æœ‰ç»“æœå®Œæˆ
    await page.waitForSelector('.result-card.completed', { timeout: 60000 });

    // éªŒè¯5ä¸ªç»“æœéƒ½æˆåŠŸ
    const completedCards = await page.locator('.result-card.completed').count();
    expect(completedCards).toBe(5);
  });
});
```

**è¿è¡Œæµ‹è¯•**:
```bash
# ç¡®ä¿åç«¯å’Œå‰ç«¯éƒ½åœ¨è¿è¡Œ
npx playwright test
```

---

### 16.4 å¸¸è§é—®é¢˜ä¸æ’æŸ¥

#### 16.4.1 CORSé”™è¯¯

**é—®é¢˜**: æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º"CORS policy blocked"

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥åç«¯CORSé…ç½®ä¸­æ˜¯å¦åŒ…å«å‰ç«¯URL
2. ç¡®è®¤`allow_credentials=True`å·²è®¾ç½®
3. å‰ç«¯è¯·æ±‚æ˜¯å¦æºå¸¦äº†credentials (axiosé…ç½®`withCredentials: true`)

**è§£å†³æ–¹æ¡ˆ**:
```python
# backend/apps/api/main.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # æ·»åŠ å‰ç«¯URL
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 16.4.2 å›¾ç‰‡ä¸Šä¼ å¤±è´¥

**é—®é¢˜**: POST /diagnoseè¿”å›400æˆ–500é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å›¾ç‰‡å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶ (10MB)
2. æ£€æŸ¥å›¾ç‰‡æ ¼å¼æ˜¯å¦æ”¯æŒ (JPG/PNG/HEIC)
3. æŸ¥çœ‹åç«¯æ—¥å¿— (uvicornæ§åˆ¶å°)

**è§£å†³æ–¹æ¡ˆ**:
```python
# backend/apps/api/routers/diagnosis.py
@router.post("/diagnose")
async def diagnose(
    image: UploadFile = File(...),
):
    # éªŒè¯æ–‡ä»¶å¤§å°
    if image.size > 10 * 1024 * 1024:
        raise HTTPException(400, "å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB")

    # éªŒè¯æ–‡ä»¶æ ¼å¼
    if image.content_type not in ["image/jpeg", "image/png", "image/heic"]:
        raise HTTPException(400, "ä»…æ”¯æŒJPG/PNG/HEICæ ¼å¼")
```

#### 16.4.3 API KeyéªŒè¯å¤±è´¥

**é—®é¢˜**: æ‰€æœ‰è¯·æ±‚è¿”å›401 Unauthorized

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®è®¾ç½®`X-API-Key`è¯·æ±‚å¤´
2. æ£€æŸ¥localStorageä¸­æ˜¯å¦ä¿å­˜äº†API Key
3. éªŒè¯API Keyæ˜¯å¦è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// frontend/src/api/client.ts
client.interceptors.request.use((config) => {
  const apiKey = localStorage.getItem('api_key');
  if (apiKey) {
    config.headers['X-API-Key'] = apiKey;
  } else {
    console.warn('API Key not found in localStorage');
  }
  return config;
});
```

---

### 16.5 è”è°ƒæµ‹è¯•ç”¨ä¾‹æ¸…å• âœ¨

> **âœ¨ v2.0æ–°å¢**: 20+è”è°ƒæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–4ä¸ªç•Œé¢çš„æ ¸å¿ƒæµç¨‹å’Œå¼‚å¸¸åœºæ™¯ã€‚

#### 16.5.1 ç•Œé¢1ï¼šå•å›¾è¯Šæ–­æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•åœºæ™¯ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **TC-S01** | æ­£å¸¸å•å›¾è¯Šæ–­æµç¨‹ | åç«¯æœåŠ¡è¿è¡Œï¼ŒVLMæœåŠ¡æ­£å¸¸ | 1. ä¸Šä¼ æ¨±èŠ±ç™½ç²‰ç—…å›¾ç‰‡<br/>2. ç‚¹å‡»"å¼€å§‹è¯Šæ–­" | è¿”å›æ­£ç¡®ç–¾ç—…(æ¨±èŠ±ç™½ç²‰ç—…)ï¼Œç½®ä¿¡åº¦>0.8 | P0 |
| **TC-S02** | æŸ¥çœ‹VLMé—®ç­”å¯¹è¯¦æƒ… | è¯Šæ–­å®Œæˆ | 1. ç‚¹å‡»"æŸ¥çœ‹VLMé—®ç­”å¯¹"æŒ‰é’®<br/>2. å±•å¼€Q0-Q6è¯¦æƒ… | æ˜¾ç¤ºå®Œæ•´é—®ç­”å¯¹ï¼ŒåŒ…å«å›¾ç‰‡ã€é—®é¢˜ã€ç­”æ¡ˆ | P0 |
| **TC-S03** | æ ‡æ³¨è¯Šæ–­å‡†ç¡®æ€§ | è¯Šæ–­å®Œæˆ | 1. ç‚¹å‡»"å‡†ç¡®"æˆ–"ä¸å‡†ç¡®"æŒ‰é’®<br/>2. åˆ·æ–°é¡µé¢ | æ ‡æ³¨çŠ¶æ€ä¿å­˜ï¼Œè°ƒç”¨PATCH /api/v1/images/{id}/accuracy | P1 |
| **TC-S04** | ä¸Šä¼ ä¸æ”¯æŒæ ¼å¼å›¾ç‰‡ | - | ä¸Šä¼ .gifæ ¼å¼å›¾ç‰‡ | æ˜¾ç¤ºé”™è¯¯æç¤º"ä»…æ”¯æŒJPG/PNG/HEICæ ¼å¼" | P1 |
| **TC-S05** | ä¸Šä¼ è¶…å¤§å›¾ç‰‡ | - | ä¸Šä¼ 15MBå›¾ç‰‡ | æ˜¾ç¤ºé”™è¯¯æç¤º"å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB" | P1 |

#### 16.5.2 ç•Œé¢2ï¼šæ‰¹é‡è¯Šæ–­æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•åœºæ™¯ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **TC-B01** | æ‰¹é‡ä¸Šä¼ 5å¼ å›¾ç‰‡ | åç«¯æœåŠ¡è¿è¡Œ | 1. é€‰æ‹©5å¼ å›¾ç‰‡ä¸Šä¼ <br/>2. ç‚¹å‡»"å¼€å§‹æ‰¹é‡è¯Šæ–­" | è¿”å›batch_idï¼ŒçŠ¶æ€ä¸ºprocessing | P0 |
| **TC-B02** | æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹è¿›åº¦ | æ‰¹é‡è¯Šæ–­è¿›è¡Œä¸­ | 1. ç­‰å¾…3ç§’<br/>2. ç‚¹å‡»"åˆ·æ–°"æŒ‰é’® | æ˜¾ç¤ºæœ€æ–°è¿›åº¦(completed_count/total_count) | P0 |
| **TC-B03** | æ‰¹é‡è¯Šæ–­å…¨éƒ¨å®Œæˆ | æ‰¹é‡è¯Šæ–­è¿›è¡Œä¸­ | 1. å¤šæ¬¡åˆ·æ–°ç›´åˆ°status=completed | æ˜¾ç¤º5ä¸ªè¯Šæ–­ç»“æœï¼Œæ¯ä¸ªåŒ…å«ç–¾ç—…åå’Œç½®ä¿¡åº¦ | P0 |
| **TC-B04** | æ‰¹é‡è¯Šæ–­ç»“æœå¯¼å‡º | æ‰¹é‡è¯Šæ–­å®Œæˆ | ç‚¹å‡»"å¯¼å‡ºCSV"æŒ‰é’® | ä¸‹è½½CSVæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ç»“æœ | P2 |
| **TC-B05** | æ‰¹é‡ä¸Šä¼ ç©ºæ–‡ä»¶å¤¹ | - | ä¸é€‰æ‹©æ–‡ä»¶ï¼Œç›´æ¥ç‚¹å‡»ä¸Šä¼  | æ˜¾ç¤ºæç¤º"è¯·å…ˆé€‰æ‹©å›¾ç‰‡" | P1 |

#### 16.5.3 ç•Œé¢3ï¼šæœ¬ä½“ç®¡ç†æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•åœºæ™¯ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **TC-O01** | æŸ¥çœ‹æœ¬ä½“ç±»å‹åˆ—è¡¨ | æœ¬ä½“æ•°æ®å·²åŠ è½½ | è®¿é—®æœ¬ä½“ç®¡ç†é¡µé¢ | æ˜¾ç¤º5ç§æœ¬ä½“ç±»å‹(å®¿ä¸»ã€é¢œè‰²ã€å°ºå¯¸ã€ä½ç½®ã€çº¹ç†) | P0 |
| **TC-O02** | æŸ¥çœ‹é¢œè‰²æœ¬ä½“è¯¦æƒ… | - | ç‚¹å‡»"é¢œè‰²"å¡ç‰‡ | æ˜¾ç¤ºæ‰€æœ‰é¢œè‰²ç»´åº¦å€¼(å¦‚çº¢è‰²ã€é»„è‰²ã€æ£•è‰²ç­‰) | P0 |
| **TC-O03** | æŸ¥çœ‹å®¿ä¸»æœ¬ä½“è¯¦æƒ… | - | ç‚¹å‡»"å®¿ä¸»"å¡ç‰‡ | æ˜¾ç¤ºå®¿ä¸»å±åˆ—è¡¨(Rosaã€Prunusç­‰) | P0 |

#### 16.5.4 ç•Œé¢4ï¼šçŸ¥è¯†åº“ç®¡ç†æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•åœºæ™¯ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **TC-K01** | æŸ¥çœ‹çŸ¥è¯†åº“æ ‘ç»“æ„ | çŸ¥è¯†åº“æ•°æ®å·²åŠ è½½ | è®¿é—®çŸ¥è¯†åº“ç®¡ç†é¡µé¢ | å·¦ä¾§æ˜¾ç¤ºæ ‘ï¼šè”·è–‡å±â†’ç«ç‘°é»‘æ–‘ç—…/ç«ç‘°ç™½ç²‰ç—… | P0 |
| **TC-K02** | ç‚¹å‡»æ ‘èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ… | - | ç‚¹å‡»"ç«ç‘°é»‘æ–‘ç—…"èŠ‚ç‚¹ | å³ä¾§æ˜¾ç¤ºç–¾ç—…è¯¦æƒ…ï¼ŒåŒ…å«ç‰¹å¾å®šä¹‰å’Œå›¾ç‰‡ | P0 |
| **TC-K03** | æ–°å»ºç–¾ç—… | - | 1. ç‚¹å‡»"æ–°å»ºç–¾ç—…"<br/>2. å¡«å†™è¡¨å•<br/>3. ç‚¹å‡»"ä¿å­˜" | è°ƒç”¨POST /api/v1/knowledge/diseaseï¼Œæ ‘ä¸­æ–°å¢èŠ‚ç‚¹ | P1 |
| **TC-K04** | ç¼–è¾‘ç–¾ç—… | å·²é€‰æ‹©ç–¾ç—… | 1. ç‚¹å‡»"ç¼–è¾‘"<br/>2. ä¿®æ”¹æè¿°<br/>3. ä¿å­˜ | è°ƒç”¨PUTï¼Œè¯¦æƒ…æ›´æ–° | P1 |
| **TC-K05** | åˆ é™¤ç–¾ç—… | å·²é€‰æ‹©ç–¾ç—… | 1. ç‚¹å‡»"åˆ é™¤"<br/>2. ç¡®è®¤å¯¹è¯æ¡† | è°ƒç”¨DELETEï¼Œæ ‘ä¸­ç§»é™¤èŠ‚ç‚¹ | P2 |
| **TC-K06** | åˆ›å»ºç‰ˆæœ¬å¿«ç…§ | - | 1. ç‚¹å‡»"åˆ›å»ºå¿«ç…§"<br/>2. è¾“å…¥ç‰ˆæœ¬å·å’Œæè¿° | è°ƒç”¨POST /api/v1/knowledge/snapshotï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º | P2 |
| **TC-K07** | æŸ¥çœ‹å¿«ç…§å†å² | å·²æœ‰å¿«ç…§ | ç‚¹å‡»"å¿«ç…§å†å²"æŒ‰é’® | æ˜¾ç¤ºå¿«ç…§åˆ—è¡¨ï¼ŒåŒ…å«ç‰ˆæœ¬å·ã€åˆ›å»ºæ—¶é—´ | P2 |

#### 16.5.5 é”™è¯¯å¤„ç†æµ‹è¯•ç”¨ä¾‹

| ç”¨ä¾‹ID | æµ‹è¯•åœºæ™¯ | å‰ç½®æ¡ä»¶ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|--------|---------|---------|---------|---------|--------|
| **TC-E01** | åç«¯æœåŠ¡æœªå¯åŠ¨ | åœæ­¢åç«¯æœåŠ¡ | ä¸Šä¼ å›¾ç‰‡è¯Šæ–­ | æ˜¾ç¤º"æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•" | P0 |
| **TC-E02** | VLMæœåŠ¡è¶…æ—¶ | æ¨¡æ‹ŸVLMæœåŠ¡å»¶è¿Ÿ | ä¸Šä¼ å›¾ç‰‡è¯Šæ–­ | ç­‰å¾…è¶…æ—¶åæ˜¾ç¤º"è¯Šæ–­è¶…æ—¶ï¼Œè¯·é‡è¯•" | P1 |

---

### 16.6 E2Eæµ‹è¯•åœºæ™¯è¯¦ç»†å®šä¹‰ âœ¨

> **âœ¨ v2.0æ–°å¢**: 4ä¸ªç•Œé¢çš„å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•åœºæ™¯ï¼Œä¾›P7é˜¶æ®µæ‰§è¡Œã€‚

#### 16.6.1 ç•Œé¢1ï¼šå•å›¾è¯Šæ–­E2Eåœºæ™¯

**æµ‹è¯•åœºæ™¯**: ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ç³»ç»Ÿè¿›è¡Œå•å›¾è¯Šæ–­

**æµ‹è¯•æ­¥éª¤**:
```gherkin
Feature: å•å›¾è¯Šæ–­å®Œæ•´æµç¨‹

  Scenario: ç”¨æˆ·é¦–æ¬¡è¯Šæ–­æ¨±èŠ±ç™½ç²‰ç—…
    Given ç”¨æˆ·è®¿é—® http://localhost:3000/diagnosis/single
    When ç”¨æˆ·ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡"æŒ‰é’®
    And ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ "cherry_powdery_mildew.jpg"
    And ç”¨æˆ·çœ‹åˆ°å›¾ç‰‡é¢„è§ˆ
    And ç”¨æˆ·ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®
    Then ç³»ç»Ÿæ˜¾ç¤º"è¯Šæ–­ä¸­..."åŠ è½½çŠ¶æ€
    And ç­‰å¾…5-30ç§’åï¼Œç³»ç»Ÿæ˜¾ç¤ºè¯Šæ–­ç»“æœ
    And ç»“æœå¡ç‰‡æ˜¾ç¤ºç–¾ç—…åç§°"æ¨±èŠ±ç™½ç²‰ç—…"
    And ç»“æœå¡ç‰‡æ˜¾ç¤ºç½®ä¿¡åº¦ > 0.8
    And ç»“æœå¡ç‰‡æ˜¾ç¤ºç–¾ç—…æè¿°
    When ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹VLMé—®ç­”å¯¹"æŒ‰é’®
    Then å±•å¼€é¢æ¿æ˜¾ç¤ºQ0-Q6é—®ç­”å¯¹
    And æ¯ä¸ªé—®ç­”å¯¹åŒ…å«ï¼šé—®é¢˜ã€ç­”æ¡ˆã€å›¾ç‰‡
    When ç”¨æˆ·ç‚¹å‡»"å‡†ç¡®"æŒ‰é’®
    Then ç³»ç»Ÿè°ƒç”¨ PATCH /api/v1/images/{id}/accuracy
    And æ˜¾ç¤º"æ„Ÿè°¢æ‚¨çš„åé¦ˆ"æç¤º
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å›¾ç‰‡ä¸Šä¼ æˆåŠŸç‡ 100%
- [ ] è¯Šæ–­å“åº”æ—¶é—´ < 30ç§’
- [ ] VLMé—®ç­”å¯¹å®Œæ•´æ˜¾ç¤ºï¼ˆQ0-Q6ï¼‰
- [ ] å‡†ç¡®æ€§æ ‡æ³¨æˆåŠŸä¿å­˜

---

#### 16.6.2 ç•Œé¢2ï¼šæ‰¹é‡è¯Šæ–­E2Eåœºæ™¯

**æµ‹è¯•åœºæ™¯**: ç”¨æˆ·æ‰¹é‡è¯Šæ–­5å¼ ä¸åŒèŠ±å‰å›¾ç‰‡

**æµ‹è¯•æ­¥éª¤**:
```gherkin
Feature: æ‰¹é‡è¯Šæ–­å®Œæ•´æµç¨‹

  Scenario: æ‰¹é‡è¯Šæ–­5å¼ æ··åˆèŠ±å‰å›¾ç‰‡
    Given ç”¨æˆ·è®¿é—® http://localhost:3000/diagnosis/batch
    When ç”¨æˆ·ç‚¹å‡»"æ‰¹é‡ä¸Šä¼ "æŒ‰é’®
    And ç”¨æˆ·é€‰æ‹©5ä¸ªæ–‡ä»¶:
      | cherry_powdery_mildew.jpg |
      | rose_black_spot.jpg       |
      | rose_powdery_mildew.jpg   |
      | tulip_gray_mold.jpg       |
      | prunus_shot_hole.jpg      |
    Then ç•Œé¢æ˜¾ç¤º5ä¸ªå¾…è¯Šæ–­çš„å›¾ç‰‡ç¼©ç•¥å›¾
    When ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ‰¹é‡è¯Šæ–­"æŒ‰é’®
    Then ç³»ç»Ÿè°ƒç”¨ POST /api/v1/diagnose/batch
    And è¿”å› batch_id å’Œ status: "processing"
    And è¿›åº¦æ¡æ˜¾ç¤º "0/5"
    When ç”¨æˆ·ç­‰å¾…3ç§’åç‚¹å‡»"åˆ·æ–°"æŒ‰é’®
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/diagnose/batch/{batch_id}
    And è¿›åº¦æ¡æ›´æ–°ä¸º "2/5" æˆ–æ›´é«˜
    And å·²å®Œæˆçš„ç»“æœå¡ç‰‡æ˜¾ç¤ºç–¾ç—…åç§°
    When ç”¨æˆ·é‡å¤åˆ·æ–°ç›´åˆ° status: "completed"
    Then æ‰€æœ‰5ä¸ªç»“æœå¡ç‰‡éƒ½æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
    And æ¯ä¸ªç»“æœåŒ…å«ï¼šç–¾ç—…åã€ç½®ä¿¡åº¦ã€ç¼©ç•¥å›¾
    When ç”¨æˆ·ç‚¹å‡»"å¯¼å‡ºCSV"æŒ‰é’®
    Then ä¸‹è½½CSVæ–‡ä»¶åŒ…å«5è¡Œç»“æœæ•°æ®
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰¹é‡ä¸Šä¼ 5å¼ å›¾ç‰‡æˆåŠŸ
- [ ] æ‰‹åŠ¨åˆ·æ–°èƒ½æ­£ç¡®æ›´æ–°è¿›åº¦
- [ ] æ‰€æœ‰å›¾ç‰‡è¯Šæ–­å®Œæˆ
- [ ] CSVå¯¼å‡ºåŒ…å«å®Œæ•´æ•°æ®

---

#### 16.6.3 ç•Œé¢3ï¼šæœ¬ä½“ç®¡ç†E2Eåœºæ™¯

**æµ‹è¯•åœºæ™¯**: ç”¨æˆ·æµè§ˆæœ¬ä½“Schema

**æµ‹è¯•æ­¥éª¤**:
```gherkin
Feature: æœ¬ä½“ç®¡ç†æµè§ˆæµç¨‹

  Scenario: ç”¨æˆ·æŸ¥çœ‹æœ¬ä½“ç±»å‹å’Œè¯¦æƒ…
    Given ç”¨æˆ·è®¿é—® http://localhost:3000/ontology
    When é¡µé¢åŠ è½½å®Œæˆ
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/ontology/list
    And æ˜¾ç¤º5ä¸ªæœ¬ä½“ç±»å‹å¡ç‰‡:
      | å®¿ä¸»   | Host    |
      | é¢œè‰²   | Color   |
      | å°ºå¯¸   | Size    |
      | ä½ç½®   | Location|
      | çº¹ç†   | Texture |
    When ç”¨æˆ·ç‚¹å‡»"é¢œè‰²"å¡ç‰‡
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/ontology/color
    And å³ä¾§æ˜¾ç¤ºé¢œè‰²ç»´åº¦è¯¦æƒ…
    And åˆ—å‡ºæ‰€æœ‰é¢œè‰²å€¼ï¼šçº¢è‰²ã€é»„è‰²ã€æ£•è‰²ã€é»‘è‰²ã€ç™½è‰²ç­‰
    When ç”¨æˆ·ç‚¹å‡»"å®¿ä¸»"å¡ç‰‡
    Then å³ä¾§æ˜¾ç¤ºå®¿ä¸»å±åˆ—è¡¨
    And åŒ…å«ï¼šRosa(è”·è–‡å±)ã€Prunus(æå±)ç­‰
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æœ¬ä½“ç±»å‹åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º
- [ ] ç‚¹å‡»å¡ç‰‡èƒ½æ­£ç¡®åŠ è½½è¯¦æƒ…
- [ ] æœ¬ä½“Schemaæ•°æ®å®Œæ•´

---

#### 16.6.4 ç•Œé¢4ï¼šçŸ¥è¯†åº“ç®¡ç†E2Eåœºæ™¯

**æµ‹è¯•åœºæ™¯**: ç”¨æˆ·ç®¡ç†çŸ¥è¯†åº“ï¼ˆæŸ¥çœ‹ã€æ–°å»ºã€ç¼–è¾‘ã€å¿«ç…§ï¼‰

**æµ‹è¯•æ­¥éª¤**:
```gherkin
Feature: çŸ¥è¯†åº“ç®¡ç†å®Œæ•´æµç¨‹

  Scenario: ç”¨æˆ·ç®¡ç†çŸ¥è¯†åº“æ ‘ç»“æ„
    Given ç”¨æˆ·è®¿é—® http://localhost:3000/knowledge
    When é¡µé¢åŠ è½½å®Œæˆ
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/knowledge/tree
    And å·¦ä¾§æ ‘æ˜¾ç¤ºæŒ‰å®¿ä¸»å±åˆ†ç»„çš„ç–¾ç—…:
      | è”·è–‡å± (Rosa)    | ç«ç‘°é»‘æ–‘ç—…ã€ç«ç‘°ç™½ç²‰ç—… |
      | æå± (Prunus)    | æ¨±èŠ±ç™½ç²‰ç—…ã€æç¼©å¶ç—…   |
      | éƒé‡‘é¦™å± (Tulipa)| éƒé‡‘é¦™ç°éœ‰ç—…         |
    When ç”¨æˆ·ç‚¹å‡»"ç«ç‘°é»‘æ–‘ç—…"èŠ‚ç‚¹
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/knowledge/disease/rose_black_spot
    And å³ä¾§æ˜¾ç¤ºç–¾ç—…è¯¦æƒ…å¡ç‰‡
    And åŒ…å«ï¼šç–¾ç—…æè¿°ã€ç‰¹å¾å®šä¹‰(JSON Schema)ã€ç¤ºä¾‹å›¾ç‰‡

    # æ–°å»ºç–¾ç—…
    When ç”¨æˆ·ç‚¹å‡»"æ–°å»ºç–¾ç—…"æŒ‰é’®
    And ç”¨æˆ·å¡«å†™è¡¨å•:
      | å­—æ®µ       | å€¼                    |
      | disease_id | rose_rust             |
      | ä¸­æ–‡å     | ç«ç‘°é”ˆç—…               |
      | å®¿ä¸»å±     | Rosa                  |
      | æè¿°       | å¶ç‰‡ä¸Šå‡ºç°æ©™é»„è‰²æ–‘ç‚¹    |
    And ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
    Then ç³»ç»Ÿè°ƒç”¨ POST /api/v1/knowledge/disease
    And æ ‘ä¸­"è”·è–‡å±"èŠ‚ç‚¹ä¸‹æ–°å¢"ç«ç‘°é”ˆç—…"
    And æ˜¾ç¤ºæˆåŠŸæç¤º

    # ç¼–è¾‘ç–¾ç—…
    When ç”¨æˆ·é€‰ä¸­"ç«ç‘°é”ˆç—…"èŠ‚ç‚¹
    And ç”¨æˆ·ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
    And ç”¨æˆ·ä¿®æ”¹æè¿°ä¸º"å¶ç‰‡å’ŒèŒä¸Šå‡ºç°æ©™é»„è‰²é”ˆæ–‘"
    And ç”¨æˆ·ç‚¹å‡»"ä¿å­˜"
    Then ç³»ç»Ÿè°ƒç”¨ PUT /api/v1/knowledge/disease/rose_rust
    And è¯¦æƒ…é¡µæ›´æ–°æ˜¾ç¤ºæ–°æè¿°

    # åˆ›å»ºå¿«ç…§
    When ç”¨æˆ·ç‚¹å‡»"åˆ›å»ºå¿«ç…§"æŒ‰é’®
    And ç”¨æˆ·è¾“å…¥ç‰ˆæœ¬å·"v1.1"å’Œæè¿°"æ–°å¢ç«ç‘°é”ˆç—…"
    And ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"
    Then ç³»ç»Ÿè°ƒç”¨ POST /api/v1/knowledge/snapshot
    And æ˜¾ç¤º"å¿«ç…§åˆ›å»ºæˆåŠŸ"æç¤º

    # æŸ¥çœ‹å¿«ç…§å†å²
    When ç”¨æˆ·ç‚¹å‡»"å¿«ç…§å†å²"æŒ‰é’®
    Then ç³»ç»Ÿè°ƒç”¨ GET /api/v1/knowledge/snapshots
    And æ˜¾ç¤ºå¿«ç…§åˆ—è¡¨åŒ…å«v1.1ç‰ˆæœ¬
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] çŸ¥è¯†åº“æ ‘æ­£ç¡®åŠ è½½å¹¶æ˜¾ç¤º
- [ ] ç‚¹å‡»èŠ‚ç‚¹èƒ½æ­£ç¡®æ˜¾ç¤ºè¯¦æƒ…
- [ ] æ–°å»ºç–¾ç—…åŠŸèƒ½æ­£å¸¸
- [ ] ç¼–è¾‘ç–¾ç—…åŠŸèƒ½æ­£å¸¸
- [ ] å¿«ç…§åˆ›å»ºå’ŒæŸ¥çœ‹åŠŸèƒ½æ­£å¸¸

---

## 17. æ–‡æ¡£ä¿®è®¢è®°å½• âœ¨

> **âœ¨ æ–°å¢**: v2.0æ–°å¢ç« èŠ‚ï¼Œè®°å½•è¯¦ç»†è®¾è®¡æ–‡æ¡£çš„æ‰€æœ‰ç‰ˆæœ¬å˜æ›´ã€‚

### 17.1 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|-----|------|---------|------|
| **v2.0** | 2025-11-14 | ğŸ”„ **é‡å¤§æ›´æ–°**ï¼š<br/>1. åˆ é™¤ç¬¬11ç« "å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡"(é¡¹ç›®éœ€æ±‚ä¸­ä¸éœ€è¦)<br/>2. æ‰©å±•ç¬¬6ç« APIè®¾è®¡ï¼Œæ–°å¢çŸ¥è¯†åº“ç®¡ç†API(5ä¸ªæ¥å£)ã€æœ¬ä½“ç®¡ç†API(2ä¸ªæ¥å£)<br/>3. æ›´æ–°ç¬¬4ç« ç›®å½•ç»“æ„ï¼Œæ–°å¢å‰ç«¯å®Œæ•´ç›®å½•ç»“æ„<br/>4. æ–°å¢ç¬¬15ç« "å‰ç«¯æ¶æ„è®¾è®¡"(React/VueæŠ€æœ¯é€‰å‹ã€4ä¸ªç•Œé¢è®¾è®¡)<br/>5. æ–°å¢ç¬¬16ç« "å‰åç«¯è”è°ƒæŒ‡å—"(CORSé…ç½®ã€APIæµ‹è¯•ã€E2Eæµ‹è¯•)<br/>6. æ–°å¢ç¬¬17ç« "æ–‡æ¡£ä¿®è®¢è®°å½•"<br/>7. ç« èŠ‚é‡æ–°ç¼–å·ï¼šåŸ12-15ç« é‡æ–°ç¼–å·ä¸º11-14ç«  | ç³»ç»Ÿæ¶æ„å¸ˆ |
| **v1.1** | 2025-11-11 21:27:44 | é‡æ„ç¬¬5ç« ï¼šæ˜ç¡®åŒºåˆ†åº”ç”¨æœåŠ¡å±‚å’ŒåŸºç¡€è®¾æ–½æ¨¡å—å±‚ï¼Œè¡¥å……åˆ†å±‚æ¶æ„å›¾å’Œè°ƒç”¨å…³ç³»çŸ©é˜µï¼Œè¯¦ç»†å®šä¹‰æ¯ä¸ªæœåŠ¡/æ¨¡å—çš„èŒè´£ã€ä¾èµ–å…³ç³»å’Œå…³é”®æ¥å£ | ç³»ç»Ÿæ¶æ„å¸ˆ |
| **v1.0** | 2025-11-11 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆ15ç« èŠ‚è¯¦ç»†è®¾è®¡ï¼ˆæ¶æ„ã€è®¾è®¡åŸåˆ™ã€åˆ†å±‚æ¶æ„ã€ç›®å½•ç»“æ„ã€æ ¸å¿ƒæœåŠ¡ã€APIè®¾è®¡ã€æ•°æ®æ¨¡å‹ã€çŸ¥è¯†æœ¬ä½“ã€æ•°æ®åº“ã€ç¼“å­˜ã€å¤šç§Ÿæˆ·ã€æµ‹è¯•ç­–ç•¥ã€æµ‹è¯•ç”¨ä¾‹ã€éƒ¨ç½²æ–¹æ¡ˆã€æœªæ¥æ‰©å±•ï¼‰ | ç³»ç»Ÿæ¶æ„å¸ˆ |

---

### 17.2 v2.0 è¯¦ç»†å˜æ›´è¯´æ˜

#### 17.2.1 åˆ é™¤å†…å®¹

**åˆ é™¤ç« èŠ‚**: ç¬¬11ç« "å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡"
- **åˆ é™¤åŸå› **: é¡¹ç›®éœ€æ±‚æ–‡æ¡£ä¸­æœªæåŠå¤šç§Ÿæˆ·åŠŸèƒ½ï¼Œå½“å‰é˜¶æ®µæ— éœ€å®ç°
- **å½±å“èŒƒå›´**:
  - åˆ é™¤æ•°æ®åº“è¡¨: tenants, tenant_users, tenant_api_keys
  - åˆ é™¤ä¸­é—´ä»¶: TenantMiddleware
  - ç®€åŒ–API Keyç®¡ç†é€»è¾‘
- **åç»­è®¡åˆ’**: è‹¥æœªæ¥æœ‰å¤šç§Ÿæˆ·éœ€æ±‚ï¼Œå¯å‚è€ƒv1.0ç‰ˆæœ¬è®¾è®¡

#### 17.2.2 æ‰©å±•å†…å®¹

**ç¬¬6ç«  APIè®¾è®¡æ‰©å±•**:
- **æ–°å¢æ¥å£**:
  - GET /api/v1/knowledge/diseases - è·å–ç–¾ç—…åˆ—è¡¨
  - GET /api/v1/knowledge/diseases/{disease_id} - è·å–ç–¾ç—…è¯¦æƒ…
  - POST /api/v1/knowledge/diseases - åˆ›å»ºæ–°ç–¾ç—…
  - PUT /api/v1/knowledge/diseases/{disease_id} - æ›´æ–°ç–¾ç—…ä¿¡æ¯
  - DELETE /api/v1/knowledge/diseases/{disease_id} - åˆ é™¤ç–¾ç—…
  - GET /api/v1/ontology - è·å–æœ¬ä½“ç±»å‹åˆ—è¡¨
  - GET /api/v1/ontology/{type_id} - è·å–æœ¬ä½“è¯¦æƒ…
- **æ‰©å±•å†…å®¹**:
  - DiagnosisResponseå¢åŠ `reasoning`å­—æ®µ(VLMæ¨ç†é“¾)
  - DiagnosisResponseå¢åŠ `candidates`å­—æ®µ(å€™é€‰ç–¾ç—…åˆ—è¡¨)
  - æ–°å¢`metadata`å­—æ®µ(image_id, knowledge_base_version)

**ç¬¬4ç«  ç›®å½•ç»“æ„æ‰©å±•**:
- **æ–°å¢**: 4.2èŠ‚"å‰ç«¯ç›®å½•ç»“æ„"
- **å†…å®¹**: å®Œæ•´çš„React/Vueé¡¹ç›®ç›®å½•ç»“æ„(src/api, src/components, src/pages, src/store, src/typesç­‰)

#### 17.2.3 æ–°å¢ç« èŠ‚

**ç¬¬15ç«  å‰ç«¯æ¶æ„è®¾è®¡** (å…¨æ–°):
- 15.1 æŠ€æœ¯æ ˆé€‰å‹ (React vs Vueå¯¹æ¯”)
- 15.2 é¡¹ç›®åˆå§‹åŒ– (Viteé…ç½®ã€ä¾èµ–å®‰è£…)
- 15.3 æ ¸å¿ƒç•Œé¢è®¾è®¡:
  - 15.3.1 ç•Œé¢1: å•å›¾è¯Šæ–­ (ä¸Šä¼ ã€è¯Šæ–­ã€ç»“æœå±•ç¤º)
  - 15.3.2 ç•Œé¢2: æ‰¹é‡è¯Šæ–­ (æ‰¹é‡ä¸Šä¼ ã€å¹¶å‘è¯Šæ–­ã€å®«æ ¼/åˆ—è¡¨è§†å›¾)
  - 15.3.3 ç•Œé¢3: æœ¬ä½“ç®¡ç† (æœ¬ä½“ç±»å‹åˆ—è¡¨ã€æšä¸¾å€¼æŸ¥çœ‹ã€æ¨¡ç³ŠåŒ¹é…è§„åˆ™)
  - 15.3.4 ç•Œé¢4: çŸ¥è¯†ç®¡ç† (ç›®å½•æ ‘ã€ç–¾ç—…è¯¦æƒ…ã€åœ¨çº¿ç¼–è¾‘)
- 15.4 çŠ¶æ€ç®¡ç†è®¾è®¡ (Zustand)
- 15.5 APIå®¢æˆ·ç«¯å°è£… (Axios + æ‹¦æˆªå™¨)
- 15.6 TypeScriptç±»å‹å®šä¹‰
- 15.7 éƒ¨ç½²ä¸æ„å»º (Nginxé…ç½®)

**ç¬¬16ç«  å‰åç«¯è”è°ƒæŒ‡å—** (å…¨æ–°):
- 16.1 è”è°ƒç¯å¢ƒé…ç½® (CORSã€ä»£ç†ã€ç¯å¢ƒå˜é‡)
- 16.2 è”è°ƒæµ‹è¯•æµç¨‹ (APIæµ‹è¯•ã€å‰ç«¯é›†æˆæµ‹è¯•)
- 16.3 ç«¯åˆ°ç«¯æµ‹è¯• (Playwrightæµ‹è¯•ç”¨ä¾‹)
- 16.4 å¸¸è§é—®é¢˜ä¸æ’æŸ¥ (CORSé”™è¯¯ã€å›¾ç‰‡ä¸Šä¼ å¤±è´¥ã€API KeyéªŒè¯å¤±è´¥)

**ç¬¬17ç«  æ–‡æ¡£ä¿®è®¢è®°å½•** (å…¨æ–°):
- 17.1 ç‰ˆæœ¬å†å²è¡¨æ ¼
- 17.2 v2.0è¯¦ç»†å˜æ›´è¯´æ˜
- 17.3 å¾…åŠäº‹é¡¹ä¸æœªæ¥è§„åˆ’

#### 17.2.4 ç« èŠ‚é‡æ–°ç¼–å·

ç”±äºåˆ é™¤äº†ç¬¬11ç« "å¤šç§Ÿæˆ·ä¸æƒé™è®¾è®¡",åç»­ç« èŠ‚ç¼–å·è°ƒæ•´:

| v1.0ç« èŠ‚ | v2.0ç« èŠ‚ | æ ‡é¢˜ |
|----------|----------|------|
| ç¬¬12ç«  | ç¬¬11ç«  | æµ‹è¯•ç­–ç•¥ |
| ç¬¬13ç«  | ç¬¬12ç«  | æµ‹è¯•ç”¨ä¾‹è¡¨æ ¼ |
| ç¬¬14ç«  | ç¬¬13ç«  | éƒ¨ç½²ä¸ CI/CD æ–¹æ¡ˆ |
| ç¬¬15ç«  | ç¬¬14ç«  | æœªæ¥æ‰©å±•ç‚¹æ¸…å• |
| (æ–°å¢) | ç¬¬15ç«  | å‰ç«¯æ¶æ„è®¾è®¡ |
| (æ–°å¢) | ç¬¬16ç«  | å‰åç«¯è”è°ƒæŒ‡å— |
| (æ–°å¢) | ç¬¬17ç«  | æ–‡æ¡£ä¿®è®¢è®°å½• |

---

### 17.3 å¾…åŠäº‹é¡¹ä¸æœªæ¥è§„åˆ’

#### 17.3.1 å¾…è¡¥å……å†…å®¹ (v2.1è®¡åˆ’)

- [ ] è¡¥å……WebSocketå®æ—¶æ¨é€è®¾è®¡ (æ‰¹é‡è¯Šæ–­è¿›åº¦æ¨é€)
- [ ] è¡¥å……å›¾ç‰‡é¢„å¤„ç†é€»è¾‘è®¾è®¡ (HEICè½¬æ¢ã€å›¾ç‰‡å‹ç¼©)
- [ ] è¡¥å……APIé™æµç­–ç•¥è¯¦ç»†è®¾è®¡ (Token Bucketç®—æ³•)
- [ ] è¡¥å……æ—¥å¿—èšåˆæ–¹æ¡ˆ (ELK Stackæˆ–Loki)
- [ ] è¡¥å……æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ (Prometheus + Grafana)

#### 17.3.2 æœªæ¥ç‰ˆæœ¬è§„åˆ’

**v2.1 (é¢„è®¡2025-02)**:
- å®Œå–„å‰ç«¯å•å…ƒæµ‹è¯• (Jest + React Testing Library)
- è¡¥å……åç«¯é›†æˆæµ‹è¯•ç”¨ä¾‹
- æ·»åŠ APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆè„šæœ¬ (OpenAPI Generator)

**v2.2 (é¢„è®¡2025-03)**:
- è®¾è®¡æ‰¹é‡è¯Šæ–­ä¼˜åŒ–æ–¹æ¡ˆ (å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ— Celery)
- è®¾è®¡å›¾ç‰‡å»é‡ç¼“å­˜æ–¹æ¡ˆ (perceptual hash)
- è®¾è®¡A/Bæµ‹è¯•æ¡†æ¶ (Promptç‰ˆæœ¬å¯¹æ¯”)

**v3.0 (é¢„è®¡2025-Q2)**:
- è®¾è®¡Treatment Ontology (æ²»ç–—æ–¹æ¡ˆæœ¬ä½“)
- è®¾è®¡ç§»åŠ¨ç«¯SDK (React Native / Flutter)
- è®¾è®¡å¤šè¯­è¨€å›½é™…åŒ–æ–¹æ¡ˆ (i18n)

---

### 17.4 æ–‡æ¡£ç»´æŠ¤è§„èŒƒ

#### 17.4.1 ç‰ˆæœ¬å·è§„åˆ™

- **ä¸»ç‰ˆæœ¬å· (Major)**: æ¶æ„é‡å¤§å˜æ›´ã€åˆ é™¤æ ¸å¿ƒåŠŸèƒ½
- **æ¬¡ç‰ˆæœ¬å· (Minor)**: æ–°å¢ç« èŠ‚ã€æ–°å¢æ ¸å¿ƒåŠŸèƒ½è®¾è®¡
- **ä¿®è®¢å· (Patch)**: æ–‡å­—ä¿®æ­£ã€æ ¼å¼è°ƒæ•´ã€è¡¥å……ç»†èŠ‚

#### 17.4.2 ä¿®è®¢æµç¨‹

1. **ä¿®è®¢å‘èµ·**:
   - ç”±éœ€æ±‚å˜æ›´ã€æŠ€æœ¯è¯„å®¡ã€ä»£ç å®ç°åé¦ˆè§¦å‘
   - åœ¨æ–‡æ¡£ä¿®è®¢è®°å½•ä¸­åˆ›å»ºæ–°æ¡ç›®

2. **ä¿®è®¢å†…å®¹**:
   - æ ‡æ³¨ä¿®è®¢ç±»å‹: âœ…æ¥è‡ªv1.0 / ğŸ”„å·²ä¿®æ”¹ / âœ¨æ–°å¢
   - åœ¨ç« èŠ‚æ ‡é¢˜æ·»åŠ å¯¹åº”å›¾æ ‡
   - åœ¨ç« èŠ‚å¼€å¤´æ·»åŠ ä¿®è®¢è¯´æ˜

3. **ä¿®è®¢å®¡æ ¸**:
   - æŠ€æœ¯è´Ÿè´£äººå®¡æ ¸
   - äº§å“è´Ÿè´£äººç¡®è®¤éœ€æ±‚å¯¹é½
   - å¼€å‘å›¢é˜Ÿreview

4. **ä¿®è®¢å‘å¸ƒ**:
   - æ›´æ–°æ–‡æ¡£ä¿®è®¢è®°å½•è¡¨æ ¼
   - é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜
   - å½’æ¡£æ—§ç‰ˆæœ¬ (Git Tag)

---

### 17.5 æ–‡æ¡£åé¦ˆä¸æ”¹è¿›

å¦‚å‘ç°æ–‡æ¡£é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®,è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼åé¦ˆ:

1. **Git Issue**: åœ¨é¡¹ç›®ä»“åº“åˆ›å»ºIssue,æ ‡ç­¾ä¸º`documentation`
2. **é‚®ä»¶**: å‘é€è‡³ç³»ç»Ÿæ¶æ„å¸ˆé‚®ç®±
3. **å›¢é˜Ÿä¼šè®®**: åœ¨æŠ€æœ¯è¯„å®¡ä¼šè®®ä¸Šæå‡º

**å¸¸è§åé¦ˆç±»å‹**:
- è®¾è®¡ä¸åˆç† / é—æ¼å…³é”®é€»è¾‘
- ä¸å®é™…ä»£ç å®ç°ä¸ä¸€è‡´
- ç« èŠ‚ç»„ç»‡æ··ä¹± / éš¾ä»¥æŸ¥æ‰¾
- æœ¯è¯­å®šä¹‰ä¸æ¸…æ™°
- ç¤ºä¾‹ä»£ç æœ‰é”™è¯¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æœ€åæ›´æ–°**: 2025-11-14
**æ–‡æ¡£çŠ¶æ€**: å·²å‘å¸ƒ (Released)
**ä¸‹ä¸€ç‰ˆæœ¬è®¡åˆ’**: v2.1 (2025-02)

---
