# PhytoOracle 产品需求文档（PRD）

**版本**: v1.3
**创建时间**: 2025-11-10
**状态**: 已更新
**产品定位**: 基于本体建模的花卉疾病诊断系统

---

## 战略定位

**当前目标**：花卉疾病诊断（技术验证场景）

**核心技术路线**：
- **VLM**（Vision Language Model）：观察图片、提取症状特征
- **本体建模**（Ontology）：结构化花卉病理学知识
- **提示词工程**：基于本体生成VLM提示词，提升诊断准确率
- **LLM辅助编辑**：降低知识库扩展成本（v1.2+）

**技术价值**：
将专家知识（本体）转换为VLM可理解的视觉化提示词，实现零样本诊断

**MVP原则**：
- ✅ 功能简单：先验证技术可行性
- ✅ 架构可扩展：未来可复制到其他领域
- ✅ 聚焦花卉：边界清晰，易于验证

---

## 文档导航

1. [项目背景](#1-项目背景)
2. [产品定位](#2-产品定位)
3. [核心功能](#3-核心功能)
4. [技术边界](#4-技术边界)
5. [MVP范围](#5-mvp-v11-范围)
6. [验收标准](#6-验收标准)
7. [风险与依赖](#7-风险与依赖)

---

## 1. 项目背景

### 1.1 实验验证成果

PhytoOracle 基于 **FlowerSpecialist 方法论 v5.0** 的实验验证成果。

**实验数据**：

| 版本 | 花卉疾病 | VLM模型 | 关键指标 | 核心技术 |
|------|----------|---------|----------|----------|
| v10 | Rose Black Spot（玫瑰黑斑病） | Qwen VL Plus | color_border检测率 0%→100% | Zone对比法 + Egg Yolk隐喻 |
| v11 | Cherry Powdery Mildew（樱花白粉病） | Qwen VL Plus | 确诊率 70.8% (17/24) | 加权诊断引擎 + 特征重要性分级 |

**核心方法论**：
- 零训练诊断（Zero-Training Diagnosis）
- 医学式加权诊断（Weighted Diagnosis）
- 五知识库架构（Plant/Disease/Feature/Host-Disease/Treatment Ontology）
- 视觉化描述优化（5大方法 + 特征类型适配）

### 1.2 工程化目标

从**实验验证**到**生产级花卉诊断服务**的技术演进：

```
FlowerSpecialist (实验)          →    PhytoOracle (生产)
├─ MVP脚本 (v11/)                →    花卉诊断SaaS服务
├─ 单疾病测试                    →    多花卉品种诊断引擎
├─ JSON文件存储                  →    知识库管理系统 + LLM辅助编辑
├─ 硬编码VLM调用                 →    Provider抽象层 + Fallback
└─ 实验报告                      →    结构化诊断结果 + 历史追踪
```

**技术演进重点**：
- **从实验到产品**：代码工程化、API服务化、知识库管理系统
- **从单一到多元**：支持5种花卉、20-30种疾病（MVP v1.1）
- **从手工到智能**：LLM辅助知识库编辑，降低扩展成本

---

## 2. 产品定位

### 2.1 核心价值

**PhytoOracle 是什么？**

基于本体建模的花卉疾病诊断系统，提供：

- 🌸 **花卉专属**：聚焦观赏花卉，不做农作物
- 🎯 **高准确率**：加权诊断算法 + 本体提示词工程，实验验证70-100%确诊率
- ⚡ **零样本扩展**：新增疾病无需训练数据，编辑知识库即可
- 🔍 **可解释性**：基于本体推理，诊断过程透明
- 🧠 **知识驱动**：VLM视觉理解 + 本体知识 + LLM辅助编辑

**PhytoOracle 不是什么？**

- ❌ 通用植物诊断工具（不做农作物、蔬菜）
- ❌ 深度学习分类模型（不依赖大量标注数据）
- ❌ AI聊天机器人（专注结构化诊断）

### 2.2 技术架构

**核心技术组合**：

```
VLM 视觉理解 + 本体建模 + 提示词工程 + LLM辅助编辑
```

**关键技术点**：

1. **本体建模**：将花卉病理学知识结构化为五大本体
   - Disease Ontology（疾病本体）
   - Feature Ontology（特征本体）
   - Plant Ontology（植物本体）
   - Host-Disease Ontology（宿主-疾病关系）
   - Treatment Ontology（治疗本体）

2. **提示词工程**：基于本体生成VLM提示词
   - 病理术语"黄色晕圈" → VLM提示词"像煎蛋的蛋白环绕蛋黄"
   - 提升VLM对专业症状的理解能力

3. **LLM辅助编辑**（v1.2+）：
   - 专家用自然语言描述新疾病
   - LLM自动生成结构化本体知识
   - 降低知识库扩展门槛

4. **加权诊断引擎**：
   - 医学式诊断逻辑（主要症状 vs 次要症状）
   - 模糊匹配（允许VLM观察误差）
   - 置信度计算（confirmed ≥0.85）

### 2.3 目标用户

**MVP阶段**：
- 早期测试用户（花卉爱好者）
- 开发者/研究者（通过API集成）

**未来扩展**：
- 商业花卉种植基地
- 花店/花艺工作室
- 植物园/花卉展览馆

---

## 3. 核心功能

### 3.1 诊断服务 (F1)

#### 输入

**图片要求**：
- 格式：JPG/PNG/HEIC
- 分辨率：≥1024×1024（推荐）
- 内容：**花的叶子或花朵**（主要诊断部位）

**可选参数**：
- 花卉种属（提高准确率）
- 图片数量：支持1-N张图片（多张图片可提高诊断准确率）
- 拍摄环境（室内/室外）

#### 方法论核心技术（FlowerSpecialist v5.0）

**零训练诊断原理**：
- **知识驱动**：诊断逻辑基于结构化知识库，非深度学习模型
- **VLM视觉理解**：使用Vision Language Model提取视觉特征
- **医学式诊断**：借鉴人类病理专家思维（主要特征→次要特征→综合诊断）

**五大本体架构**（Separation of Concerns）：

```
1. Disease Ontology (疾病本体论)
   - 作用：存储疾病症状特征、诊断规则、特征重要性
   - 粒度：属级特异性（~70%）、科级特异性（~20%）、种级特异性（~10%）

2. Feature Ontology (特征本体论)
   - 作用：定义标准化术语 + VLM视觉化描述
   - 关键：将病理学术语转换为VLM可理解的图像学特征

3. Plant Ontology (植物本体论) [v1.2+]
   - 作用：植物分类学 + 器官解剖 + VLM识别线索
   - 应用：候选疾病早期剪枝（Rosa属→仅检索Rosa相关疾病）

4. Host-Disease Ontology (宿主-疾病关系) [v1.2+]
   - 作用：疾病-植物映射关系、宿主特异性、复合感染候选
   - 应用：动态缩小候选疾病范围（从N个→K个，K<<N）

5. Treatment Ontology (治疗本体论) [v1.3+]
   - 作用：有效成分 + 植物特异性参数 + 治疗方案
   - 应用：诊断-治疗闭环（架构预留）
```

**视觉描述优化5大方法**（解决VLM语言障碍）：

```
方法1: 日常物体类比（Visual Metaphor）
  - 黄色晕圈："像煎蛋的蛋白部分环绕着蛋黄"
  - 白粉覆盖："像叶片表面撒了面粉或糖粉"
  - 坏死斑点："像被香烟烫过留下的焦痕"

方法2: 空间定位精确化（Spatial Anchoring）
  - "边缘" → "紧邻深色斑点外围1-2mm区域"
  - "叶脉附近" → "叶脉两侧2mm范围内"

方法3: 3-Zone对比法（Comparative Reference）
  - Zone A（斑点中心）vs Zone B（边缘1-3mm）vs Zone C（正常组织）
  - 通过颜色梯度对比检测黄色晕圈

方法4: 视觉参照物法（Quantified Visual Metrics）
  - 尺寸："芝麻粒(1mm)→绿豆(3mm)→黄豆(5mm)→硬币(20mm)"
  - VLM从Level 0-4选择，允许±1级别模糊匹配

方法5: 分步观察指令（Step-by-Step Visual Protocol）
  - Locate（定位）→ Zoom（聚焦）→ Compare（对比）→ Confirm（确认）
```

**模糊匹配机制**（Fuzzy Matching）：

```python
# 颜色模糊匹配（COLOR_GROUPS）
COLOR_GROUPS = {
    "黑褐色系": ["black", "dark_brown", "brown"],
    "黄色系": ["yellow", "light_yellow", "yellowish_green"],
    "白色系": ["white", "gray_white", "off_white"]
}
# 匹配规则：VLM观察的颜色在同一色系内即为匹配

# 尺寸模糊匹配（SIZE_ORDER）
SIZE_ORDER = ["pinpoint", "small", "medium_small", "medium", "large"]
# 匹配规则：允许±1级别误差
# 示例：知识库=medium，VLM=medium_small → ✓ MATCH
```

**加权诊断引擎**（Weighted Diagnosis）：

```
特征重要性分级（Feature Importance）:
├─ 主要特征（Major Features）: 权重 0.8
│   ├─ symptom_type: 0.5  (病理类型是关键)
│   └─ color_center: 0.3  (中心颜色是典型特征)
│
├─ 次要特征（Minor Features）: 权重 0.15
│   ├─ location: 0.1      (解剖位置)
│   └─ additional_features: 0.05
│
└─ 可选特征（Optional Features）: 权重 0.05
    ├─ size: 0.03         (随病程变化)
    └─ distribution: 0.02 (辅助判断)

诊断规则（Diagnosis Rules）:
├─ confirmed (确诊): total_score ≥ 0.85
│   └─ 主要特征必须≥2/2 (医学诊断逻辑)
├─ suspected (疑似): 0.6 ≤ total_score < 0.85
│   └─ 主要特征至少1/2 + 次要特征支持
└─ unlikely (排除): total_score < 0.6

完整性修正（Completeness Modifier）:
├─ complete (完整器官): modifier = 1.0
├─ partial (部分): modifier = 0.8
└─ close_up (特写): modifier = 0.6, skip distribution
```

**三层渐进诊断流程**（Progressive Diagnosis）：

```
【Layer 1】VLM视觉特征提取
  ↓
  执行Q0-Q6问题序列
  ↓
  提取feature_vector
  ↓
【Layer 2】知识库匹配引擎
  ↓
  加权诊断（Weighted Diagnosis）
  ├─ 模糊匹配（COLOR_GROUPS, SIZE_ORDER）
  ├─ 特征评分（Major 0.8 + Minor 0.15 + Optional 0.05）
  └─ 计算total_score + diagnosis_level
  ↓
【Layer 3】置信度分层决策
  ↓
  ├─ High Confidence (score ≥ 0.85)
  │   └─ 直接返回诊断结果 (confirmed)
  │
  ├─ Medium Confidence (0.60 ≤ score < 0.85)
  │   └─ 返回疑似诊断 (suspected)
  │       ├─ 标记置信度级别为"suspected"
  │       ├─ 返回Top 2-3候选疾病及分数
  │       └─ 建议：上传更多角度图片以提高诊断准确性
  │
  └─ Low Confidence (score < 0.60)
      └─ VLM兜底策略或认怂
          ├─ 选项A: 调用VLM开放式诊断（标记为"VLM推测"）
          └─ 选项B: 返回"无法诊断"，建议补充症状或多角度图片
```

**置信度阈值说明**：
- **≥0.85（确诊）**: 主要特征完全匹配（≥2/2），可直接返回结果
- **0.60-0.85（疑似）**: 部分特征匹配，返回疑似诊断和候选列表
- **<0.60（排除）**: 特征匹配度低，可能是知识库外疾病或误拍

**Q0-Q6问题序列**（动态特征提取）：

```
【前提假设】收到一张完全不知道是什么的图片

Q0: 前置检查（Pre-check）- 逐级过滤
│
├─ Q0.0: 图片内容类型识别
│   ├─ 问题: "这张图片的主要内容是什么？"
│   ├─ 选项: [plant（植物）, animal（动物）, person（人）,
│   │         object（物体）, landscape（风景）, other（其他）]
│   └─ 如果 ≠ plant → 返回"不支持的图片类型"
│
├─ Q0.1: 植物类别识别
│   ├─ 问题: "这是什么类别的植物？"
│   ├─ 选项: [flower（观赏花卉）, vegetable（蔬菜）, tree（树木）,
│   │         crop（农作物）, grass（草坪/草本）, other（其他植物）]
│   └─ 如果 ≠ flower → 返回"当前仅支持花卉疾病诊断"
│
├─ Q0.2: 花卉种属识别（分级识别策略）
│   ├─ Level 2 (Genus): "这是什么属的花？"
│   ├─ 选项: [Rosa（玫瑰/月季）, Prunus（樱花/樱桃）,
│   │         Tulipa（郁金香）, Dianthus（康乃馨）, ...]
│   ├─ 提示: 从Plant Ontology提取visual_cues（叶形、花形、质地）
│   └─ 目的: 筛选候选疾病（从N个→K个，K<<N）
│       └─ 查询Host-Disease Ontology → 获取该属的疾病列表
│
├─ Q0.3: 器官识别
│   ├─ 问题: "这是花的哪个部位？"
│   └─ 选项: [flower（花朵）, leaf（叶子）]
│
├─ Q0.4: 完整性检查
│   ├─ 问题: "这个器官在图片中是完整的吗？"
│   ├─ 选项:
│   │   ├─ complete: 完整（整个叶片/花朵都在画面中，可看到完整轮廓）
│   │   ├─ partial: 部分（被裁剪或只拍了一部分，边缘被截断）
│   │   └─ close_up: 特写（聚焦某个局部区域，放大拍摄细节）
│   └─ 目的: 调整诊断策略（特写照片可能遗漏分布特征）
│
└─ Q0.5: 异常判断
    ├─ 问题: "是否有明显异常？"
    ├─ 选项: [healthy（健康）, abnormal（有异常）]
    └─ 分支:
        ├─ healthy → 返回"未发现异常"
        └─ abnormal → 进入Q1-Q6特征提取

─────────────────────────────────────────────────────────

Q1: 症状类型（Symptom Type）- 权重0.5
├─ 选项: [necrosis_spot, powdery_coating, chlorosis, rust_pustule...]
└─ 触发：动态生成后续问题（基于symptom_type）

Q2-Q6: 动态特征问题（根据Q1结果）
├─ 如symptom_type = "necrosis_spot":
│   ├─ Q2: color_center (中心颜色) - 权重0.3
│   ├─ Q3: color_border (边缘颜色/黄晕圈) - 权重0.3
│   ├─ Q4: location (解剖位置) - 权重0.1
│   ├─ Q5: size (尺寸，视觉参照物法)
│   └─ Q6: distribution (分布模式)
│
└─ 如symptom_type = "powdery_coating":
    ├─ Q2: coverage_color (覆盖物颜色)
    ├─ Q3: coverage_density (覆盖密度)
    └─ Q4: affected_surface (受影响表面)
```

#### 处理流程

```
用户上传图片（不知道是什么）
    ↓
【Q0: 逐级过滤】
├─ Q0.0: 内容类型识别 (plant/animal/person/object/landscape/other)
│   └─ 如果 ≠ plant → 返回错误
├─ Q0.1: 植物类别识别 (flower/vegetable/tree/crop/grass/other)
│   └─ 如果 ≠ flower → 返回"仅支持花卉诊断"
├─ Q0.2: 花卉种属识别 (Rosa/Prunus/Tulipa/...)
│   └─ 查询Host-Disease Ontology → 筛选候选疾病
├─ Q0.3: 器官识别 (flower/leaf)
├─ Q0.4: 完整性检查 (complete/partial/close_up)
└─ Q0.5: 异常判断 (healthy/abnormal)
    ├─ healthy → 返回"未发现异常"
    └─ abnormal → 继续
    ↓
【Q1-Q6: 特征提取】
├─ 主要特征 (权重0.8)
│   ├─ symptom_type (0.5)
│   └─ color_center (0.3)
├─ 次要特征 (权重0.15)
│   ├─ location (0.1)
│   └─ additional_features (0.05)
└─ 可选特征 (权重0.05)
    ├─ size (0.03)
    └─ distribution (0.02)
    ↓
【加权诊断引擎】
├─ 模糊匹配 (Fuzzy Matching)
│   ├─ 颜色模糊匹配 (COLOR_GROUPS)
│   └─ 尺寸模糊匹配 (SIZE_ORDER)
├─ 特征评分 (Weighted Scoring)
│   ├─ 主要特征得分
│   ├─ 次要特征得分
│   └─ 总分计算
└─ 诊断规则 (Diagnosis Rules)
    ├─ confirmed: ≥0.85 且主要特征≥2/2
    ├─ suspected: 0.6~0.85
    └─ unlikely: <0.6
    ↓
【输出诊断报告】
├─ 疾病名称
├─ 置信度 (confirmed/suspected)
├─ 匹配的关键特征
└─ 治疗建议 [v1.3+]
```

#### 输出结构

```json
{
  "diagnosis_id": "diag_20251110_001",
  "timestamp": "2025-11-10T12:34:56Z",

  "diagnosis": {
    "disease_id": "cherry_powdery_mildew",
    "disease_name": "樱桃白粉病",
    "common_name_en": "Cherry Powdery Mildew",
    "pathogen": "Podosphaera clandestina",
    "level": "confirmed",
    "confidence": 0.95
  },

  "feature_vector": {
    "content_type": "plant",
    "plant_category": "flower",
    "flower_genus": "Prunus",
    "organ": "leaf",
    "completeness": "complete",
    "has_abnormality": "abnormal",
    "symptom_type": "powdery_coating",
    "color_center": "white",
    "location": "lamina",
    "additional_leaf_curling": "upward",
    "size": "medium",
    "distribution_pattern": "confluent"
  },

  "scores": {
    "total_score": 0.98,
    "major_features": {
      "matched": 2,
      "total": 2,
      "score": 0.8
    },
    "minor_features": {
      "matched": 2,
      "total": 2,
      "score": 0.15
    },
    "optional_features": {
      "matched": 2,
      "total": 2,
      "score": 0.03
    }
  },

  "reasoning": [
    "[OK] symptom_type: powdery_coating (Expected: powdery_coating)",
    "[OK] color_center: white (Expected: white)",
    "[OK] location: lamina (Expected: lamina/shoot/fruit)",
    "[OK] additional_leaf_curling: upward (Expected: upward)"
  ],

  "matched_rule": "R1",

  "vlm_provider": "qwen",
  "execution_time_ms": 8500
}
```

#### 性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 诊断延迟 (P95) | ≤30秒 | 含VLM调用时间 |
| 并发QPS | ≥10 | 基于队列机制 |
| 确诊准确率 | ≥70% | 对标v11实验 |
| 服务可用性 | ≥99% | 排除VLM故障 |

---

### 3.2 知识库管理 (F2)

#### 知识库架构

基于**方法论v5.0五知识库架构**：

```
knowledge_base/
├─ diseases/                    # Disease Ontology
│   ├─ rose_black_spot_v4.1.json
│   ├─ cherry_powdery_mildew_v4.1.json
│   └─ [新增疾病...]
│
├─ features/                    # Feature Ontology
│   └─ feature_ontology_v4.1.json
│
├─ plants/                      # Plant Ontology (v1.2+)
│   ├─ rosa.json
│   └─ prunus.json
│
├─ host_disease/                # Host-Disease Relations (v1.2+)
│   └─ associations.json
│
└─ treatments/                  # Treatment Ontology (v1.3+)
    ├─ active_ingredients/
    ├─ plant_specific_params/
    └─ regimens/
```

#### 疾病知识库格式 (v4.1)

**核心字段**：

```json
{
  "version": "4.1",
  "disease_id": "cherry_powdery_mildew",
  "disease_name": "樱桃白粉病",
  "common_name_en": "Cherry Powdery Mildew",
  "pathogen": "Podosphaera clandestina",

  "feature_vector": { /* 标准特征向量 */ },

  "feature_importance": {
    "major_features": {
      "_weight": 0.8,
      "features": [
        {
          "dimension": "symptom_type",
          "expected_values": ["powdery_coating"],
          "weight": 0.5,
          "description": "白色粉状覆盖物是关键诊断特征"
        }
      ]
    },
    "minor_features": { /* 权重0.15 */ },
    "optional_features": { /* 权重0.05 */ }
  },

  "diagnosis_rules": {
    "confirmed": {
      "criteria": [
        {
          "rule_id": "R1",
          "logic": "major_features >= 2/2",
          "confidence": 0.95
        }
      ]
    },
    "suspected": { /* ... */ },
    "unlikely": { /* ... */ }
  },

  "visual_descriptions": { /* VLM提示词优化 */ }
}
```

#### 知识库扩展流程（低成本策略）

**设计目标**：
- 低成本添加新花卉/新疾病
- 保持知识库质量和一致性
- 避免破坏现有诊断逻辑

**新花卉添加流程**（v1.2+）：

```
步骤1: Plant Ontology构建
  ├─ 植物分类学信息（Genus/Family/Order）
  ├─ 器官解剖特征（leaf shape, flower structure）
  ├─ VLM识别线索（visual_cues）
  └─ 参考资料：植物志 + Wikipedia + 图片库

步骤2: Host-Disease Associations映射
  ├─ 查询该属常见疾病（植物病理学文献）
  ├─ 建立疾病-植物映射关系
  └─ 标记宿主特异性级别（species/genus/family）

步骤3: Disease Ontology构建（每个疾病）
  ├─ 使用方法论v5.0模板
  ├─ 特征向量（symptom_type, color, location等）
  ├─ 视觉描述优化（5大方法）
  └─ 参考：FlowerSpecialist实验流程

步骤4: 测试验证
  ├─ 单疾病测试（管理后台上传图片）
  ├─ 批量测试（测试集评估）
  ├─ 准确率≥65%才能上线
  └─ 调整视觉描述和特征权重

预估成本：
├─ Plant Ontology: 2-4小时/花卉
├─ Disease Ontology: 4-8小时/疾病（含文献调研）
├─ 视觉描述优化: 2-4小时/疾病（含测试迭代）
└─ 总计：每种新花卉（4-5种疾病）约 30-50小时
```

**新疾病添加流程**（现有花卉）：

```
步骤1: Disease Ontology JSON构建
  ├─ 使用现有疾病作为模板
  ├─ 文献调研（病原、症状、宿主范围）
  └─ 4-8小时

步骤2: 视觉描述优化
  ├─ 将病理学术语转换为VLM可理解的描述
  ├─ 应用5大方法（Visual Metaphor等）
  └─ 2-4小时

步骤3: Host-Disease更新
  └─ 更新associations.json

步骤4: 测试验证
  ├─ 上传真实病例图片测试
  ├─ 迭代优化特征权重
  └─ 2-4小时

预估成本：每个新疾病 8-16小时
```

**质量保障**：
- 所有新增疾病必须通过测试验证（≥65%准确率）
- 视觉描述优化必须遵循方法论5大方法
- 版本控制：每次更新记录changelog
- 回滚机制：出问题可快速回滚到历史版本

#### 管理后台功能

**疾病管理**：
- ✅ 疾病列表（CRUD）
- ✅ 特征向量可视化编辑
- ✅ 特征重要性配置
- ✅ 诊断规则配置
- ✅ 视觉化描述编辑

**知识库版本管理**：
- ✅ 版本历史记录
- ✅ 版本对比
- ✅ 回滚到历史版本
- ✅ 导出/导入（JSON格式）

**测试工具**：
- ✅ 单疾病测试（上传图片验证）
- ✅ 批量测试（测试集评估）
- ✅ 诊断准确率统计

---

### 3.3 VLM Provider抽象层 (F3)

#### 支持的VLM模型

| Provider | 模型 | 优先级 | 用途 | 成本 |
|----------|------|--------|------|------|
| **Qwen VL** | qwen-vl-plus | P0 | 主力VLM | 有免费额度 |
| **ChatGPT** | gpt-4o | P1 | 备用VLM | 付费 |
| **Grok** | grok-vision-2.0 | P2 | 备用VLM | 付费 |
| **Claude** | claude-sonnet-4.5 | P3 | 高精度场景 | 高成本 |

#### Fallback策略

```python
# 自动降级流程
try:
    result = qwen_provider.call(prompt, image)  # P0
except QwenError:
    try:
        result = chatgpt_provider.call(prompt, image)  # P1
    except ChatGPTError:
        try:
            result = grok_provider.call(prompt, image)  # P2
        except GrokError:
            try:
                result = claude_provider.call(prompt, image)  # P3
            except ClaudeError:
                raise DiagnosisError("All VLM providers failed")
```

#### Provider统一接口

```python
from abc import ABC, abstractmethod

class VLMProvider(ABC):
    """VLM Provider抽象基类"""

    @abstractmethod
    def call(self, prompt: str, image: bytes) -> str:
        """调用VLM API"""
        pass

    @abstractmethod
    def is_available(self) -> bool:
        """检查可用性"""
        pass

    @abstractmethod
    def get_quota(self) -> dict:
        """获取配额信息"""
        pass
```

---

### 3.4 图片存储 (F4)

#### 存储策略

**永久存储,按准确率+植物名分类**（优化方案：便于问题排查）

```
storage/
└─ images/
    ├─ correct/                    # 诊断正确的图片
    │   ├─ rose/
    │   │   ├─ 2025-11/
    │   │   │   ├─ 10/
    │   │   │   │   ├─ diag_20251110_001_rose_black_spot.jpg
    │   │   │   │   └─ metadata.json
    │   │   │   └─ 11/
    │   │   └─ 2025-12/
    │   └─ cherry/
    ├─ incorrect/                  # 诊断错误的图片
    │   ├─ rose/
    │   └─ cherry/
    └─ unlabeled/                  # 未标注的图片
        ├─ rose/
        └─ cherry/
```

**设计理由**:
- **准确率分类**: 快速定位误诊案例进行分析
- **植物名分类**: 针对性优化特定植物的诊断规则
- **日期分层**: 追踪时间趋势，分析季节性问题

**Metadata格式**：

```json
{
  "diagnosis_id": "diag_20251110_001",
  "image_path": "unlabeled/rose/2025-11/10/diag_20251110_001_rose_black_spot.jpg",
  "upload_time": "2025-11-10T12:34:56Z",
  "plant_info": {
    "plant_name": "rose",
    "plant_genus": "Rosa",
    "organ": "leaf"
  },
  "diagnosis_result": {
    "disease_id": "rose_black_spot",
    "disease_name": "玫瑰黑斑病",
    "level": "confirmed",
    "confidence": 0.95
  },
  "accuracy_label": null,  // 人工标注: "correct" / "incorrect" / null
  "move_to_folder": null,  // 标注后自动移动到对应文件夹
  "notes": ""              // 用于记录问题原因
}
```

#### 质量分析功能

**准确性标注**：
- ✅ 管理后台支持人工标注（正确/错误）
- ✅ 统计各疾病的准确率
- ✅ 导出误诊案例用于优化

**图片检索**：
- ✅ 按日期范围查询
- ✅ 按疾病类型筛选
- ✅ 按诊断等级筛选（confirmed/suspected/unlikely）
- ✅ 按准确性筛选（已标注正确/错误/未标注）

---

### 3.5 用户认证 (F5) [可选功能，可推迟实现]

**API Key认证**（用户决策：Q2选B）

#### 认证流程

```http
POST /api/v1/diagnose
Headers:
  X-API-Key: pk_live_1234567890abcdef
  Content-Type: multipart/form-data
```

#### API Key管理

**后台功能**：
- ✅ 生成API Key
- ✅ 设置权限（启用/禁用）
- ✅ 查看使用统计
- ✅ 删除Key

**说明**：
- MVP阶段可简化实现，先实现基础的Key验证即可
- 速率限制、付费分级等机制待后续版本完善

---

## 4. 技术边界

### 4.1 明确支持的场景

✅ **支持**：
- **1-N张图片诊断**（多张图片可提高准确率）
  - 单张：基础诊断
  - 多张：从不同角度拍摄同一病变，提供更全面的特征信息
  - 优势：多角度验证、提高诊断置信度
- **花朵或叶片诊断**（主要诊断部位）
- **所有花卉病原性疾病**（真菌/细菌/病毒/其他病原）
- **所有症状类型识别**（斑点/覆盖物/褪色/卷曲/萎蔫等）
- **多花卉品种知识库**（可无限扩展）

### 4.2 明确不支持的场景

❌ **不支持**：
- **实时视频流诊断**（VLM延迟高）
- **完全离线部署**（依赖云端VLM）
- **农作物疾病诊断**（不在花卉范畴）

**说明**：
- 方法论框架具有普适性，理论上支持所有植物异常诊断
- **PhytoOracle战略聚焦花卉**，不做农副产品
- 当前v1.1聚焦花卉病原性疾病（真菌/细菌/病毒）
- 未来可扩展到花卉害虫、营养缺乏等（保持花卉垂直领域）

---

## 5. MVP v1.1 范围

### 5.1 核心功能（必须实现）

**诊断服务**：
- [x] F1: 植物疾病诊断API
  - 器官识别 (Q0)
  - 特征提取 (Q1-Q6)
  - 加权诊断引擎
  - 结构化输出

**知识库**：
- [x] F2: 知识库管理后台（用户决策：Q4选B）
  - 疾病CRUD
  - 特征编辑器
  - 版本管理
  - 测试工具
  - **LLM辅助编辑**（v1.2+预留）

- [x] **初始知识库范围**（v1.1）

  **5种花卉（Genus级别）**：
  | 花卉属名 | 中文名 | 方法论支撑 | 疾病数量 |
  |---------|--------|-----------|---------|
  | **Rosa** | 玫瑰/月季 | ✅ v4.1 Black Spot | 5-6种 |
  | **Prunus** | 樱花/樱桃 | ✅ v4.1 Powdery Mildew | 4-5种 |
  | **Tulipa** | 郁金香 | 🔄 待构建 | 3-4种 |
  | **Dianthus** | 康乃馨 | 🔄 待构建 | 3-4种 |
  | **Paeonia** | 牡丹 | 🔄 待构建 | 3-4种 |

  **初始疾病列表（18-24种）**：

  *Rosa（玫瑰/月季）*：
  - Rose Black Spot（玫瑰黑斑病）✅ v4.1已验证
  - Rose Downy Mildew（玫瑰霜霉病）
  - Rose Powdery Mildew（玫瑰白粉病）
  - Rose Rust（玫瑰锈病）
  - Rose Botrytis Blight（灰霉病）
  - Rose Mosaic Virus（花叶病毒）

  *Prunus（樱花/樱桃）*：
  - Cherry Powdery Mildew（樱花白粉病）✅ v4.1已验证
  - Cherry Leaf Spot（樱花褐斑病）
  - Cherry Shot Hole（樱花穿孔病）
  - Cherry Rust（樱花锈病）

  *Tulipa（郁金香）*：
  - Tulip Fire（郁金香疫病）
  - Tulip Breaking Virus（碎色病毒）
  - Tulip Gray Bulb Rot（灰霉病）

  *Dianthus（康乃馨）*：
  - Carnation Fusarium Wilt（镰刀菌萎蔫）
  - Carnation Rust（康乃馨锈病）
  - Carnation Streak Virus（条纹病毒）

  *Paeonia（牡丹）*：
  - Peony Botrytis Blight（牡丹灰霉病）
  - Peony Measles（麻斑病）
  - Peony Leaf Blotch（叶斑病）

- [x] **v1.2扩展目标**（基于数据集 flower_data/train）
  - Hibiscus（木槿/扶桑）
  - Crape Jasmine（狗牙花）
  - Night-flowering Jasmine（夜来香）
  - Dwarf White Bauhinia（矮生白花羊蹄甲）

**VLM**：
- [x] F3: VLM Provider抽象层
  - Grok Provider (P0)
  - Qwen Provider (P1)
  - Fallback机制

**存储**：
- [x] F4: 图片永久存储
  - 按准确率+植物名+日期分类
  - Metadata管理
  - 准确性标注

**认证**：
- [ ] F5: API Key认证（可选，可推迟实现）
  - Key生成/管理
  - 基础验证机制

**部署**：
- [x] 云SaaS服务（用户决策：Q1选B）
  - 单服务器部署
  - 数据库（PostgreSQL + Redis）
  - 服务器本地存储

**验证界面**：
- [x] F6: 简单Web诊断界面（方便快速验证）
  - 功能：上传图片 → 显示诊断结果
  - 技术栈：简单HTML + JavaScript（或React单页）
  - 目的：快速验证诊断API功能，无需使用Postman
  - 包含：
    - 图片上传组件
    - 诊断结果展示（疾病名称、置信度、匹配特征）
    - 历史诊断记录（可选）

### 5.2 明确不做（Out of Scope）

**v1.1不做**：
- [ ] 移动端应用
- [ ] 治疗建议查询（架构预留）
- [ ] Plant Ontology集成
- [ ] UI/API多语言切换（知识库支持中英双语，但v1.1不做界面语言切换）
- [ ] Docker本地部署（仅云SaaS）

### 5.3 技术栈

**后端**：
- Python 3.10+
- FastAPI（异步框架）
- SQLAlchemy（ORM）
- Pydantic（数据校验 + 本体类封装）

**本体实现方式**（重要）：
- **存储格式**：JSON文件（易于编辑和版本控制）
  - `knowledge_base/diseases/*.json`（Disease Ontology）
  - `knowledge_base/features/*.json`（Feature Ontology）
  - `knowledge_base/plants/*.json`（Plant Ontology）
- **运行时封装**：Pydantic类（类型安全、数据验证）
  ```python
  from pydantic import BaseModel

  class DiseaseOntology(BaseModel):
      disease_id: str
      disease_name: str
      feature_vector: dict
      feature_importance: dict
      diagnosis_rules: dict
      visual_descriptions: dict
  ```
- **加载流程**：启动时加载JSON → 解析为Pydantic类 → 存入内存
- **优势**：JSON易编辑（人工/LLM），Pydantic保证运行时类型安全

**问答对固化方式**：
- **Q0-Q6问题序列**：代码内hardcode（逻辑固定，问诊逻辑树）
  - 定义在 `diagnosis_service.py` 的常量或配置文件中
  - Q0: 逐级过滤（内容类型→植物类别→花卉种属→器官→完整性→异常判断）
  - Q1-Q6: 动态特征提取（根据symptom_type动态生成后续问题）

**数据库**：
- PostgreSQL 14+（主数据库）
- Redis（缓存 + 队列）

**存储**：
- 服务器本地存储（图片存储）
- Git（知识库JSON版本控制）

**前端**（管理后台 + 验证界面）：
- React 18+
- Ant Design / Material-UI
- Monaco Editor（JSON编辑器）

**部署**：
- 云服务器（单服务器部署）
- Nginx（反向代理）
- Supervisor / PM2（进程管理）

---

## 6. 验收标准

### 6.1 功能验收

| 功能模块 | 验收标准 |
|---------|----------|
| **诊断服务** | 使用v11测试集（12张Cherry Powdery Mildew），确诊率≥65% |
| **知识库管理** | 通过管理后台成功添加/编辑/删除疾病，版本历史正确 |
| **VLM Provider** | Qwen调用成功率≥95%，Fallback机制在主Provider失败时生效 |
| **图片存储** | 图片按日期正确分类存储，Metadata完整，标注功能可用 |
| **Web验证界面** | 成功上传图片并显示诊断结果，confirmed/suspected/unlikely正确展示 |
| **API认证** | API Key认证通过，速率限制生效，未授权请求被拦截 |

### 6.2 性能验收

| 指标 | 目标 | 测试方法 |
|------|------|----------|
| 诊断延迟 (P95) | ≤30秒 | 压测100次请求 |
| 并发QPS | ≥10 | 并发10个请求同时处理 |
| 管理后台响应 | ≤2秒 | 各页面加载时间 |

### 6.3 质量验收

- 单元测试覆盖率 ≥80%（核心模块）
- 集成测试：端到端诊断流程通过
- 代码审查：通过Pylint/Flake8检查
- 文档完整：API文档（OpenAPI）+ 部署文档

---

## 7. 风险与依赖

### 7.1 核心业务风险

| 风险 | 影响等级 | 缓解措施 |
|------|---------|----------|
| **VLM成本超预算** | 高 | 1. 监控每日调用量和成本<br>2. 优化Prompt长度减少token消耗<br>3. 使用缓存机制避免重复调用<br>4. 设置成本告警阈值 |
| **VLM准确率波动** | 高 | 1. 持续跟踪诊断准确率<br>2. A/B测试不同VLM Provider<br>3. 优化视觉描述提示词<br>4. 建立误诊案例库分析改进 |
| **知识库不完整** | 中 | **应对方案（重要）**：<br><br>**场景1: 知识库内疾病但特征不全**<br>  → 标记为"疑似"，建议用户补充症状信息<br>  → 记录case用于知识库优化<br><br>**场景2: 知识库外疾病（未收录）**<br>  → **VLM兜底策略**：<br>  1. 当所有候选疾病score < 0.6时触发<br>  2. 调用VLM进行开放式诊断：<br>     "Based on the symptoms, what disease is this most likely?"<br>  3. 返回VLM诊断结果 + 置信度标记为"VLM推测"<br>  4. 提示："该疾病未在知识库中，以下是VLM初步分析"<br>  5. 记录case，人工审核后补充到知识库<br><br>**场景3: 完全陌生症状**<br>  → 返回"无法诊断"，提供症状描述<br>  → 建议用户联系专家或上传更多图片 |
| **Qwen API不稳定** | 中 | Fallback到ChatGPT/Grok/Claude |

### 7.2 技术风险（简化）

| 风险 | 缓解措施 |
|------|----------|
| 加权引擎Bug | 单元测试全覆盖，对照v11结果验证 |
| 并发性能瓶颈 | 异步架构，Redis队列 |

**说明**：MVP阶段重点关注业务核心风险，工程化风险（如多可用区、灾备等）待后续版本完善。

---

## 8. 项目决策记录

### 已确认的关键决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| **Q1: 部署方式** | B - 云SaaS服务 | 用户明确不需要本地Docker部署 |
| **Q2: API认证** | B - API Key | 简单有效，满足MVP需求 |
| **Q3: 图片存储** | C - 永久存储（按日期） | 用于判断准确性和模型优化 |
| **Q4: 知识库编辑** | B - 管理后台UI | 纯JSON编辑太费劲 |

### 待确认的决策

| 决策项 | 选项 | 待讨论 |
|--------|------|--------|
| 云服务商 | A-阿里云 / B-AWS / C-腾讯云 | 成本、稳定性、备案要求 |
| 前端框架 | A-React / B-Vue | 团队技能栈 |
| 数据库选型 | A-PostgreSQL / B-MySQL | PostgreSQL JSON支持更好 |
| 对象存储 | A-阿里云OSS / B-AWS S3 | 与云服务商一致 |

---

## 9. 下一步行动

### 立即行动

1. ✅ 需求文档评审通过
2. ⏸️ 确认待决策项（云服务商、前端框架等）
3. ⏸️ 设计系统架构图

### 后续行动

1. ⏸️ 编写技术设计文档（TDD）
2. ⏸️ 定义API接口规范（OpenAPI 3.0）
3. ⏸️ 设计数据库Schema
4. ⏸️ 设计管理后台原型图

---

## 附录

### A. 参考文献

- [方法论v5.0完整文档](../methodology/方法论v4.0完整文档.md)
- [FlowerSpecialist v11实验报告](../../NewBloomCheck/FlowerSpecialist/scripts/MVP/v11/Cherry_Powdery_Mildew_Evaluation_Report.md)
- [加权诊断引擎源码](../../NewBloomCheck/FlowerSpecialist/scripts/MVP/v11/weighted_diagnosis_engine.py)

### B. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| VLM | Vision Language Model | 视觉语言模型 |
| 本体论 | Ontology | 知识库的结构化表示 |
| 零样本 | Zero-shot | 无需训练数据的学习方式 |
| 加权诊断 | Weighted Diagnosis | 基于特征重要性的诊断算法 |
| PRD | Product Requirements Document | 产品需求文档 |

### C. 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-11-10 | 初始版本，明确MVP范围和四大决策 | Claude |
| v1.1 | 2025-11-10 | **核心更新**：<br>1. 增加简洁的战略定位说明（花卉验证场景、核心技术路线、MVP原则）<br>2. 明确聚焦花卉，不做农作物<br>3. 补充方法论核心技术细节到3.1诊断服务<br>4. VLM优先级调整为Qwen→ChatGPT→Grok→Claude<br>5. 图片存储优化为按准确率+花卉名+日期分类<br>6. 支持1-N张图片诊断<br>7. 存储改为服务器本地存储<br>8. F5认证标记为可选功能<br>9. 增加知识库外疾病VLM兜底策略<br>10. 初始知识库扩展为5种花卉、20-30种疾病 | Claude |
| v1.2 | 2025-11-10 | **Q0问诊序列重构**：<br>1. 增加Q0.0内容类型识别（是否是植物，支持plant/animal/person/object等）<br>2. 增加Q0.1植物类别识别（是否是花卉，支持flower/vegetable/tree等）<br>3. Q0.2改为花卉种属识别（Genus级别：Rosa/Prunus/Tulipa等）<br>4. Q0.3器官识别（flower/leaf，移除stem/root）<br>5. Q0.4完整性检查、Q0.5异常判断<br>6. 更新处理流程图（从"不知道是什么的图片"开始的逐级过滤）<br>7. 输出结构增加Q0新字段（content_type, plant_category, flower_genus等）<br>8. 图片输入要求明确为"花的叶子或花朵" | Claude |
| v1.3 | 2025-11-10 | **三层渐进诊断 + 知识库范围明确 + 实现细节完善**：<br>**【核心架构】**<br>1. 新增三层渐进诊断流程（Layer1 VLM提取 → Layer2 知识库匹配 → Layer3 置信度分层决策）<br>2. 置信度阈值明确：≥0.85确诊直接报告，0.60-0.85返回疑似诊断，<0.60兜底/认怂<br>3. 明确"三层渐进"就是问诊逻辑树：Q0逐级过滤→Q1-Q6动态特征提取→置信度决策<br><br>**【知识库范围】**<br>4. 明确5种花卉列表：Rosa/Prunus/Tulipa/Dianthus/Paeonia<br>5. 明确18-24种疾病列表（每种花卉3-6种疾病）<br>6. v1.2扩展目标：数据集花卉（Hibiscus/Crape Jasmine等4种）<br><br>**【知识库扩展】**<br>7. 新增知识库扩展流程（新花卉/新疾病添加步骤，预估成本30-50h/花卉）<br>8. 质量保障机制（≥65%准确率、版本控制、回滚机制）<br><br>**【技术实现】**<br>9. 本体实现方式：JSON存储 + Pydantic类封装（类型安全）<br>10. 问答对固化：Q0-Q6 hardcode为问诊逻辑树<br>11. 新增F6简单Web验证界面（上传图片+显示结果）<br>12. 验收标准更新：Web界面验收 | Claude |

---

**文档状态**: ✅ 待评审
**评审人**: [待填写]
**批准人**: [待填写]
**批准日期**: [待填写]
